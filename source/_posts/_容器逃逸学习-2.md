---
title: 容器逃逸学习 (2)
date: 2023-11-12 15:46:11
categories:
- 学习笔记
- 容器逃逸系列
---

在上一篇容器逃逸中，我们复现了docker的一个CVE，本文来简单介绍一下QEMU并复现有关QEMU逃逸的一个CVE漏洞。

# QEMU

## 一些基本原理

QEMU是一个完全开源的，能够通过纯软件模拟几乎所有硬件的虚拟化模拟器。为了更好地理解QEMU的设计思想，我们不妨从一个开发者的角度审视QEMU，试想如果我们需要开发QEMU，我们需要解决什么问题。

首先，既然是模拟器，那么最最重要的需求就是能够模拟多种架构的处理器，毕竟没有处理器连指令都执行不了。那么问题来了，如何在一个固定的主机架构上模拟出多个不同的CPU架构呢？这里可以参考LLVM的设计思想。LLVM Pass可以完成对LLVM代码的处理，而LLVM代码可以通过高级语言转化而来，如果我们需要对多种语言编写的程序进行插桩、混淆或其他操作，我们可以通过LLVM对不同高级语言的适配器将各类高级语言统一转化为LLVM代码，再在LLVM代码上进行操作，最后编译LLVM代码。这样就能够实现高级语言操作与编译器的解耦，我们的插桩等工作只需要一个LLVM Pass即可实现，而不需要处理各类不同架构的编译器。

对于QEMU而言，这个思路是相同的。QEMU需要模拟不同的CPU架构代码，它的处理方式是将这些不同架构的代码转化为一种中间代码，称为<font color=red>**TCG**</font>。然后将这个中间代码转义为主机的CPU架构代码，这样就能够实现多种架构的模拟。需要注意的是，QEMU对目标系统代码的处理是以基本块而不是指令为单位，其通过对一个基本块的代码进行统一处理，在一定程度上可以提升效率。至于TCG的具体实现方式，比如不同架构的寄存器数量不同等等，这不在本文的讨论范围之内，感兴趣的读者可自行搜索资料了解。在本文中，我们只需要知道QEMU能通过中间代码转化这种方式实现不同架构的模拟就行了。

OK，现在我们已经能够模拟不同架构的代码了，随后我们需要处理的问题是如何模拟一台真实物理主机的启动流程，包括开机自检、引导等等。这一步我们只需要按部就班地实现即可，对于QEMU而言，因为其操作的对象是img镜像文件，它可以将该文件映射到QEMU的进程空间之中，直接对img中的内容进行读写，以完成各类文件操作。而对于操作系统镜像而言，也是通过将其加载到进程空间内存中之后运行。考虑到操作系统必然需要一个磁盘设备与文件系统进行交互，QEMU虚拟机拥有虚拟化各类设备的能力，客户机系统以为其在与真实的设备交互，但实际上是在与QEMU虚拟出来的设备交互，这样QEMU通过对虚拟磁盘设备的接口重写，使客户机系统能够访问QEMU虚拟机内存空间中的文件系统磁盘镜像映射空间。

好，现在QEMU已经能够实现系统的正常运行以及各类设备的模拟了，所有这些都在QEMU的内存空间中完成。但总觉得还缺点什么，对于一个正在运行的QEMU虚拟机，如果命令行回显的内容不足，我们可能不能很好地掌握虚拟机的一些具体运行状态。所以QEMU实现了一个monitor，能够在虚拟机运行时通过这个monitor实现的命令行掌握虚拟机的运行状态，帮助我们进行手动或自动的管理。

现在，我们已经大致了解了QEMU虚拟机的工作原理，接下来介绍一下QEMU虚拟机启动时的一些常用参数。

## 常用参数

- -m：`-m [size=]megs[,slots=n,maxmem=size]`为虚拟机分配的内存大小，对于一个单纯的Linux系统而言，内存大小一般不需要很大。实际上除了设置内存大小外还能够设置内存插槽数量和最大内存占用大小，内存插槽数量决定了虚拟机的内存设备数量，而最大内存占用大小则一般小于分配的内存大小，防止虚拟机过度占用主机内存资源。一般情况下这两个选项通常不特殊指定。
- -kernel：Linux系统虚拟机常用选项，设置Linux系统镜像，一般使用的是bzImage，即压缩过的Linux镜像。
- -append：Linux系统虚拟机常用选项，用于向内核引导命令行传递额外参数，灵活引导客户机系统内核。如设置控制台输出的字符设备、根文件系统设备等。
- -initrd：Linux系统虚拟机常用选项，设置内存文件镜像，即RAM disk，将内存区域作为文件系统镜像使用。对于Linux系统而言，可通过busybox自动构建文件系统镜像。
- -cpu：QEMU模拟出来的用于运行系统的CPU，输入`qemu-system-xxx -cpu help`可查看需要模拟的架构下支持的所有CPU。选定CPU后还能指定CPU的一些选项，如在`qemu-system-x86_64`中可以选择添加`+smap,+smep`内存保护选项等。
- -nographic：设置模拟出来的系统没有图形界面。注意这里的图形界面并不一定是桌面系统，如果不加这个选项，命令执行后会弹出一个QEMU界面，在其中完成命令行操作或桌面系统操作等，添加这个选项后，模拟出来的系统将直接将串口输入输出重定向到当前终端界面。
- -monitor：设置monitor选项，将monitor控制台的输入输出重定向到一个设备。这个设备可以是网络设备，也可以是标准输入输出等。
- -device：定义虚拟机拥有的设备。

# CVE-2020-14364

打开浏览器，搜索“QEMU逃逸CVE”，出现最多的就是这个CVE编号，考虑到目前处于QEMU的初学阶段，我们就首先从这个CVE下手，亲自体验一下一次QEMU逃逸的流程。实际上即使从这个漏洞下手，学习还是步履维艰的，因为几乎所有博客都没有对这个漏洞对应的QEMU USB传输机制进行详细的分析，对于PoC也是直接给出，没有太多的解释。

由于QEMU完全开源，我们在分析漏洞时得以结合源码作为辅助。

## 漏洞描述

该漏洞发生于QEMU 5.2.0之前，对于USB数据包的异常处理可能导致QEMU进程崩溃或利用宿主机的QEMU进程权限执行任意代码。

## 漏洞分析



# References

[Linux云计算底层技术之一文读懂 Qemu 模拟器](https://zhuanlan.zhihu.com/p/72484589)
[CVE-2020-14364-Qemu逃逸漏洞分析及两种利用思路](https://xz.aliyun.com/t/8320)
[qemu pwn-基础知识](https://xz.aliyun.com/t/6562)