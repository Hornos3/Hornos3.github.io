<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hornos3.github.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="最近在D3CTF中发现了一道与PHP有关的Pwn题，当时由于事务繁忙没有及时学习，结果在不久之后的长城杯决赛中就遭到报应了，PHP pwn现场不会做。毕设做完之后，现在总算有时间拾起都有点陌生的CTF了。下面就来记录一下PHP pwn的学习过程。  A. PHP extensions for C 在查阅资料后可以发现，实际上PHP pwn考的还是用户态pwn。具体而言，赛题一般使用的都是使用C语言">
<meta property="og:type" content="article">
<meta property="og:title" content="PHP pwn 学习 (1)">
<meta property="og:url" content="http://hornos3.github.com/2024/06/19/PHP-pwn-%E5%AD%A6%E4%B9%A0-1/index.html">
<meta property="og:site_name" content="CoLin&#39;s BLOG">
<meta property="og:description" content="最近在D3CTF中发现了一道与PHP有关的Pwn题，当时由于事务繁忙没有及时学习，结果在不久之后的长城杯决赛中就遭到报应了，PHP pwn现场不会做。毕设做完之后，现在总算有时间拾起都有点陌生的CTF了。下面就来记录一下PHP pwn的学习过程。  A. PHP extensions for C 在查阅资料后可以发现，实际上PHP pwn考的还是用户态pwn。具体而言，赛题一般使用的都是使用C语言">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hornos3.github.com/2024/06/19/PHP-pwn-%E5%AD%A6%E4%B9%A0-1/1.png">
<meta property="article:published_time" content="2024-06-19T12:44:54.000Z">
<meta property="article:modified_time" content="2024-06-21T11:04:21.957Z">
<meta property="article:author" content="CoLin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hornos3.github.com/2024/06/19/PHP-pwn-%E5%AD%A6%E4%B9%A0-1/1.png">

<link rel="canonical" href="http://hornos3.github.com/2024/06/19/PHP-pwn-%E5%AD%A6%E4%B9%A0-1/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>PHP pwn 学习 (1) | CoLin's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CoLin's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2024/06/19/PHP-pwn-%E5%AD%A6%E4%B9%A0-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          PHP pwn 学习 (1)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2024-06-19 20:44:54" itemprop="dateCreated datePublished" datetime="2024-06-19T20:44:54+08:00">2024-06-19</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2024-06-21 19:04:21" itemprop="dateModified" datetime="2024-06-21T19:04:21+08:00">2024-06-21</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/PHP-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">PHP pwn 系列</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>19k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>17 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>最近在D3CTF中发现了一道与PHP有关的Pwn题，当时由于事务繁忙没有及时学习，结果在不久之后的长城杯决赛中就遭到报应了，PHP pwn现场不会做。毕设做完之后，现在总算有时间拾起都有点陌生的CTF了。下面就来记录一下PHP pwn的学习过程。</p>
<h1 id="a-php-extensions-for-c"><a class="markdownIt-Anchor" href="#a-php-extensions-for-c"></a> A. PHP extensions for C</h1>
<p>在查阅资料后可以发现，实际上PHP pwn考的还是用户态pwn。具体而言，赛题一般使用的都是使用C语言编写的PHP扩展库文件。</p>
<p>PHP是一门基于C语言编写的高级语言，历史悠久。它支持使用C语言编写可直接用于PHP文件的二进制.so库文件。具体操作如下：</p>
<h2 id="1-运行环境与工作目录初始化"><a class="markdownIt-Anchor" href="#1-运行环境与工作目录初始化"></a> 1. 运行环境与工作目录初始化</h2>
<p>为方便实验，这里可以基于PHP docker容器完成下面的操作。笔者使用的是php:8.1-apache，这个版本是php的较新版本，且内置apache服务器与PHP源码，可以开箱即用。</p>
<p>在容器的<code>/usr/src</code>目录中保存有php 8.1版本的源码压缩包，解压即可。</p>
<p>在源码目录的ext目录中有一个PHP脚本<code>ext_skel.php</code>，运行后可指定目录与脚本名，用于生成PHP扩展的基础文件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line">root@4bc0fa317dea:/usr/src/php-8.1.1/ext# ./ext_skel.php --help</span><br><span class="line">WHAT IT IS</span><br><span class="line"></span><br><span class="line">  It&#x27;s a tool for automatically creating the basic framework for a PHP extension.</span><br><span class="line"></span><br><span class="line">HOW TO USE IT</span><br><span class="line"></span><br><span class="line">  Very simple. First, change to the ext/ directory of the PHP sources. Then run</span><br><span class="line">  the following</span><br><span class="line"></span><br><span class="line">    php ext_skel.php --ext extension_name</span><br><span class="line"></span><br><span class="line">  and everything you need will be placed in directory ext/extension_name.</span><br><span class="line"></span><br><span class="line">  If you don&#x27;t need to test the existence of any external header files,</span><br><span class="line">  libraries or functions in them, the extension is ready to be compiled in PHP.</span><br><span class="line">  To compile the extension run the following:</span><br><span class="line"></span><br><span class="line">    cd extension_name</span><br><span class="line">    phpize</span><br><span class="line">    ./configure</span><br><span class="line">    make</span><br><span class="line"></span><br><span class="line">  Don&#x27;t forget to run tests once the compilation is done:</span><br><span class="line"></span><br><span class="line">    make test</span><br><span class="line"></span><br><span class="line">  Alternatively, to compile extension in the PHP:</span><br><span class="line"></span><br><span class="line">    cd /path/to/php-src</span><br><span class="line">    ./buildconf</span><br><span class="line">    ./configure --enable-extension_name</span><br><span class="line">    make</span><br><span class="line">    make test TESTS=ext/extension_name/tests</span><br><span class="line"></span><br><span class="line">  The definition of PHP_extension_NAME_VERSION will be present in the</span><br><span class="line">  php_extension_name.h and injected into the zend_extension_entry definition.</span><br><span class="line">  This is required by the PECL website for the version string conformity checks</span><br><span class="line">  against package.xml</span><br><span class="line"></span><br><span class="line">SOURCE AND HEADER FILE NAME</span><br><span class="line"></span><br><span class="line">  The ext_skel.php script generates &#x27;extension_name.c&#x27; and &#x27;php_extension_name.h&#x27;</span><br><span class="line">  as the main source and header files. Keep these names.</span><br><span class="line"></span><br><span class="line">  extension functions (User functions) must be named</span><br><span class="line"></span><br><span class="line">  extension_name_function()</span><br><span class="line"></span><br><span class="line">  When you need to expose extension functions to other extensions, expose</span><br><span class="line">  functions strictly needed by others. Exposed internal function must be named</span><br><span class="line"></span><br><span class="line">  php_extension_name_function()</span><br><span class="line"></span><br><span class="line">  See also CODING_STANDARDS.md.</span><br><span class="line"></span><br><span class="line">OPTIONS</span><br><span class="line"></span><br><span class="line">  php ext_skel.php --ext &lt;name&gt; [--experimental] [--author &lt;name&gt;]</span><br><span class="line">                   [--dir &lt;path&gt;] [--std] [--onlyunix]</span><br><span class="line">                   [--onlywindows] [--help]</span><br><span class="line"></span><br><span class="line">  --ext &lt;name&gt;          The name of the extension defined as &lt;name&gt;</span><br><span class="line">  --experimental        Passed if this extension is experimental, this creates</span><br><span class="line">                        the EXPERIMENTAL file in the root of the extension</span><br><span class="line">  --author &lt;name&gt;       Your name, this is used if --std is passed and for the</span><br><span class="line">                        CREDITS file</span><br><span class="line">  --dir &lt;path&gt;          Path to the directory for where extension should be</span><br><span class="line">                        created. Defaults to the directory of where this script</span><br><span class="line">                        lives</span><br><span class="line">  --std                 If passed, the standard header used in extensions that</span><br><span class="line">                        is included in the core, will be used</span><br><span class="line">  --onlyunix            Only generate configure scripts for Unix</span><br><span class="line">  --onlywindows         Only generate configure scripts for Windows</span><br><span class="line">  --help                This help</span><br></pre></td></tr></table></figure>
<p>基本只需要使用<code>--ext</code>与<code>--dir</code>选项即可。这里笔者将脚本目录设置为<code>/var/www/my_extension</code>。</p>
<p>执行命令后，在<code>/var/www/my_extension</code>中自动生成了一些文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">root@4bc0fa317dea:/var/www/my_extension/hello_phpext# ls -al</span><br><span class="line">total 40</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jun 19 12:39 .</span><br><span class="line">drwxr-xr-x 3 root root 4096 Jun 19 12:36 ..</span><br><span class="line">-rw-r--r-- 1 root root  500 Jun 19 12:32 .gitignore</span><br><span class="line">-rw-r--r-- 1 root root 3490 Jun 19 12:32 config.m4</span><br><span class="line">-rw-r--r-- 1 root root  253 Jun 19 12:32 config.w32</span><br><span class="line">-rw-r--r-- 1 root root 1971 Jun 19 12:32 hello_phpext.c</span><br><span class="line">-rw-r--r-- 1 root root  110 Jun 19 12:32 hello_phpext.stub.php</span><br><span class="line">-rw-r--r-- 1 root root  558 Jun 19 12:32 hello_phpext_arginfo.h</span><br><span class="line">-rw-r--r-- 1 root root  372 Jun 19 12:32 php_hello_phpext.h</span><br><span class="line">drwxr-xr-x 2 root root 4096 Jun 19 12:32 tests</span><br></pre></td></tr></table></figure>
<ul>
<li>config.m4：Unix下的Build Config配置文件，将通过它完成配置与安装。</li>
<li>hello_phpext.c：包含主要逻辑的C语言文件，我们扩展函数的保存位置。</li>
<li>php_hello_phpext.h：头文件，包含结构体定义等。</li>
</ul>
<h2 id="2-构建与加载"><a class="markdownIt-Anchor" href="#2-构建与加载"></a> 2. 构建与加载</h2>
<p>为方便后续对我们的扩展进行测试，首先需要搞清楚应该如何将扩展加载到PHP中。</p>
<p>使用下面的命令可以完成扩展加载：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">phpize</span><br><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install</span><br></pre></td></tr></table></figure>
<p>执行上述命令后，我们的PHP扩展库文件就被复制到了<code>/usr/local/lib/php/extensions/no-debug-non-zts-20210902</code>目录中。</p>
<p>随后，我们还需要修改<code>php.ini</code>文件。在8.1.1版本的PHP中，<code>/usr/local/etc/php</code>目录下有两个文件：<code>php.ini-development</code>与<code>php.ini-production</code>，前者一般用于开发调试而后者用于发布。这里使用前者，在代码中添加一行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">extension=hello_phpext.so</span><br></pre></td></tr></table></figure>
<p>随后将其复制一份保存为php.ini，重启apache2服务，即可将我们的扩展加载到PHP中。</p>
<h2 id="3-关键结构定义"><a class="markdownIt-Anchor" href="#3-关键结构定义"></a> 3. 关键结构定义</h2>
<p>上述初始化操作完成后，hello_phpext.c中预先定义了一些必要的结构以及两个示例函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* hello_phpext extension for PHP */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> HAVE_CONFIG_H</span></span><br><span class="line"><span class="meta"># <span class="keyword">include</span> <span class="string">&quot;config.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;php.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;ext/standard/info.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;php_hello_phpext.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;hello_phpext_arginfo.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* For compatibility with older PHP versions */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ZEND_PARSE_PARAMETERS_NONE</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_PARSE_PARAMETERS_NONE() \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_START(0, 0) \</span></span><br><span class="line"><span class="meta">	ZEND_PARSE_PARAMETERS_END()</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; void test1() */</span></span><br><span class="line">PHP_FUNCTION(test1)</span><br><span class="line">&#123;</span><br><span class="line">	ZEND_PARSE_PARAMETERS_NONE();</span><br><span class="line"></span><br><span class="line">	php_printf(<span class="string">&quot;The extension %s is loaded and working!\r\n&quot;</span>, <span class="string">&quot;hello_phpext&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; string test2( [ string $var ] ) */</span></span><br><span class="line">PHP_FUNCTION(test2)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">char</span> *var = <span class="string">&quot;World&quot;</span>;</span><br><span class="line">	<span class="type">size_t</span> var_len = <span class="keyword">sizeof</span>(<span class="string">&quot;World&quot;</span>) - <span class="number">1</span>;</span><br><span class="line">	zend_string *retval;</span><br><span class="line"></span><br><span class="line">	ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">		Z_PARAM_OPTIONAL</span><br><span class="line">		<span class="title function_">Z_PARAM_STRING</span><span class="params">(var, var_len)</span></span><br><span class="line">	<span class="title function_">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">	retval = strpprintf(<span class="number">0</span>, <span class="string">&quot;Hello %s&quot;</span>, var);</span><br><span class="line"></span><br><span class="line">	RETURN_STR(retval);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125;*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_RINIT_FUNCTION */</span></span><br><span class="line">PHP_RINIT_FUNCTION(hello_phpext)</span><br><span class="line">&#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(ZTS) &amp;&amp; defined(COMPILE_DL_HELLO_PHPEXT)</span></span><br><span class="line">	ZEND_TSRMLS_CACHE_UPDATE();</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> SUCCESS;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; PHP_MINFO_FUNCTION */</span></span><br><span class="line">PHP_MINFO_FUNCTION(hello_phpext)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;hello_phpext support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#123;&#123;&#123; hello_phpext_module_entry */</span></span><br><span class="line">zend_module_entry hello_phpext_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;hello_phpext&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	ext_functions,					<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(hello_phpext),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(hello_phpext),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLO_PHPEXT_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/* &#125;&#125;&#125; */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> COMPILE_DL_HELLO_PHPEXT</span></span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> ZTS</span></span><br><span class="line">ZEND_TSRMLS_CACHE_DEFINE()</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">ZEND_GET_MODULE(hello_phpext)</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>
<p>这里包含了大量PHP相关的宏定义，一眼看过去确实难以理解，下面将结合PHP源码进行分析。</p>
<h3 id="php_function"><a class="markdownIt-Anchor" href="#php_function"></a> <code>PHP_FUNCTION</code></h3>
<p>这是用于定义PHP库函数的宏定义，在8.1.1版本PHP源码中的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /Zend/zend_API.h, line 71</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_NAMED_FUNCTION(name)		void ZEND_FASTCALL name(INTERNAL_FUNCTION_PARAMETERS)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_FUNCTION(name)				ZEND_NAMED_FUNCTION(zif_##name)</span></span><br></pre></td></tr></table></figure>
<p>即上面的<code>PHP_FUNCTION(test1)</code>就相当于<code>void ZEND_FASTCALL test1(INTERNAL_FUNCTION_PARAMETERS)</code>。</p>
<h3 id="internal_function_parameters"><a class="markdownIt-Anchor" href="#internal_function_parameters"></a> <code>INTERNAL_FUNCTION_PARAMETERS</code></h3>
<p>上面的函数定义需要使用参数定义的相关宏定义<code>INTERNAL_FUNCTION_PARAMETERS</code>，它的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /Zend/zend.h, line 48</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTERNAL_FUNCTION_PARAMETERS zend_execute_data *execute_data, zval *return_value</span></span><br></pre></td></tr></table></figure>
<p>即所有的PHP库函数都会通过第一个参数<code>execute_data</code>传入所有C函数需要的参数，由第二个参数<code>return_value</code>获取返回值，库函数本身的返回值恒为void。</p>
<h3 id="zend_execute_data等"><a class="markdownIt-Anchor" href="#zend_execute_data等"></a> <code>zend_execute_data</code>等</h3>
<p>这是一个结构体，用于保存C库函数的相关参数的数据结构。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /Zend/zend_types.h, line 88</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_execute_data</span>    <span class="title">zend_execute_data</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// /Zend/zend_compile.h, line 522</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zend_execute_data</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> zend_op       *opline;           <span class="comment">/* executed opline                */</span></span><br><span class="line">	zend_execute_data   *call;             <span class="comment">/* current call                   */</span></span><br><span class="line">	zval                *return_value;</span><br><span class="line">	zend_function       *func;             <span class="comment">/* executed function              */</span></span><br><span class="line">	zval                 This;             <span class="comment">/* this + call_info + num_args    */</span></span><br><span class="line">	zend_execute_data   *prev_execute_data;</span><br><span class="line">	zend_array          *symbol_table;</span><br><span class="line">	<span class="type">void</span>               **run_time_cache;   <span class="comment">/* cache op_array-&gt;run_time_cache */</span></span><br><span class="line">	zend_array          *extra_named_params;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>这里引用了另外一些结构体，下面给出部分定义。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /Zend/zend_types.h, line 90</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span>     <span class="title">zval</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// /Zend/zend_types.h, line 288</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> _<span class="title">zend_value</span> &#123;</span></span><br><span class="line">	zend_long         lval;				<span class="comment">/* long value */</span></span><br><span class="line">	<span class="type">double</span>            dval;				<span class="comment">/* double value */</span></span><br><span class="line">	zend_refcounted  *counted;</span><br><span class="line">	zend_string      *str;</span><br><span class="line">	zend_array       *arr;</span><br><span class="line">	zend_object      *obj;</span><br><span class="line">	zend_resource    *res;</span><br><span class="line">	zend_reference   *ref;</span><br><span class="line">	zend_ast_ref     *ast;</span><br><span class="line">	zval             *zv;</span><br><span class="line">	<span class="type">void</span>             *ptr;</span><br><span class="line">	zend_class_entry *ce;</span><br><span class="line">	zend_function    *func;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span> w1;</span><br><span class="line">		<span class="type">uint32_t</span> w2;</span><br><span class="line">	&#125; ww;</span><br><span class="line">&#125; zend_value;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> _<span class="title">zval_struct</span> &#123;</span></span><br><span class="line">	zend_value        value;			<span class="comment">/* value */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span> type_info;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			ZEND_ENDIAN_LOHI_3(</span><br><span class="line">				zend_uchar    type,			<span class="comment">/* active type */</span></span><br><span class="line">				zend_uchar    type_flags,</span><br><span class="line">				<span class="keyword">union</span> &#123;</span><br><span class="line">					<span class="type">uint16_t</span>  extra;        <span class="comment">/* not further specified */</span></span><br><span class="line">				&#125; u)</span><br><span class="line">		&#125; v;</span><br><span class="line">	&#125; u1;</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">uint32_t</span>     next;                 <span class="comment">/* hash collision chain */</span></span><br><span class="line">		<span class="type">uint32_t</span>     cache_slot;           <span class="comment">/* cache slot (for RECV_INIT) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     opline_num;           <span class="comment">/* opline number (for FAST_CALL) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     lineno;               <span class="comment">/* line number (for ast nodes) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     num_args;             <span class="comment">/* arguments number for EX(This) */</span></span><br><span class="line">		<span class="type">uint32_t</span>     fe_pos;               <span class="comment">/* foreach position */</span></span><br><span class="line">		<span class="type">uint32_t</span>     fe_iter_idx;          <span class="comment">/* foreach iterator index */</span></span><br><span class="line">		<span class="type">uint32_t</span>     property_guard;       <span class="comment">/* single property guard */</span></span><br><span class="line">		<span class="type">uint32_t</span>     constant_flags;       <span class="comment">/* constant flags */</span></span><br><span class="line">		<span class="type">uint32_t</span>     extra;                <span class="comment">/* not further specified */</span></span><br><span class="line">	&#125; u2;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>可以看到，PHP使用<code>zend_value</code>定义PHP数据类型，包括整数、浮点数、数组、对象、函数、类等。</p>
<h3 id="zend_parse_parameters_start等"><a class="markdownIt-Anchor" href="#zend_parse_parameters_start等"></a> <code>ZEND_PARSE_PARAMETERS_START</code>等</h3>
<p>在C库函数中，有一个重要的流程——解析PHP参数。从上面的示例C文件中，可以看到这样一段：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ZEND_PARSE_PARAMETERS_START(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">	Z_PARAM_OPTIONAL</span><br><span class="line">	<span class="title function_">Z_PARAM_STRING</span><span class="params">(var, var_len)</span></span><br><span class="line"><span class="title function_">ZEND_PARSE_PARAMETERS_END</span><span class="params">()</span>;</span><br></pre></td></tr></table></figure>
<p>这些宏定义均在<code>/Zend/zend_API.h</code>中定义，将这些宏全部展开带入参数之后，就变成了下面这个样子（已删除无效控制流）：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ZEND_PARSE_PARAMETERS_START</span></span><br><span class="line"><span class="keyword">do</span> &#123; \</span><br><span class="line">		<span class="type">const</span> <span class="type">int</span> _flags = (<span class="number">0</span>); \</span><br><span class="line">		<span class="type">uint32_t</span> _min_num_args = (<span class="number">0</span>); \</span><br><span class="line">		<span class="type">uint32_t</span> _max_num_args = (<span class="type">uint32_t</span>) (<span class="number">1</span>); \</span><br><span class="line">		<span class="type">uint32_t</span> _num_args = (execute_data)-&gt;This.u2.num_args; \</span><br><span class="line">		<span class="type">uint32_t</span> _i = <span class="number">0</span>; \</span><br><span class="line">		zval *_real_arg, *_arg = <span class="literal">NULL</span>; \</span><br><span class="line">		zend_expected_type _expected_type = Z_EXPECTED_LONG; \</span><br><span class="line">		<span class="type">char</span> *_error = <span class="literal">NULL</span>; \</span><br><span class="line">		<span class="type">bool</span> _dummy = <span class="number">0</span>; \</span><br><span class="line">		<span class="type">bool</span> _optional = <span class="number">0</span>; \</span><br><span class="line">		<span class="type">int</span> _error_code = ZPP_ERROR_OK; \</span><br><span class="line">		((<span class="type">void</span>)_i); \</span><br><span class="line">		((<span class="type">void</span>)_real_arg); \</span><br><span class="line">		((<span class="type">void</span>)_arg); \</span><br><span class="line">		((<span class="type">void</span>)_expected_type); \</span><br><span class="line">		((<span class="type">void</span>)_error); \</span><br><span class="line">		((<span class="type">void</span>)_optional); \</span><br><span class="line">		((<span class="type">void</span>)_dummy); \</span><br><span class="line">		\</span><br><span class="line">		<span class="keyword">do</span> &#123; \</span><br><span class="line">			<span class="keyword">if</span> (UNEXPECTED(_num_args &lt; _min_num_args) || \</span><br><span class="line">			    UNEXPECTED(_num_args &gt; _max_num_args)) &#123; \</span><br><span class="line">				<span class="keyword">if</span> (!(_flags &amp; ZEND_PARSE_PARAMS_QUIET)) &#123; \</span><br><span class="line">					zend_wrong_parameters_count_error(_min_num_args, _max_num_args); \</span><br><span class="line">				&#125; \</span><br><span class="line">				_error_code = ZPP_ERROR_FAILURE; \</span><br><span class="line">				<span class="keyword">break</span>; \</span><br><span class="line">			&#125; \</span><br><span class="line">			_real_arg = ZEND_CALL_VAR_NUM(execute_data, <span class="number">-1</span>);</span><br><span class="line"><span class="comment">// Z_PARAM_OPTIONAL</span></span><br><span class="line">      _optional = <span class="number">1</span>;</span><br><span class="line"><span class="comment">// Z_PARAM_STRING</span></span><br><span class="line">      ++_i; \</span><br><span class="line">      ZEND_ASSERT(_i &lt;= _min_num_args || _optional==<span class="number">1</span>); \</span><br><span class="line">      ZEND_ASSERT(_i &gt;  _min_num_args || _optional==<span class="number">0</span>); \</span><br><span class="line">      <span class="keyword">if</span> (_optional) &#123; \</span><br><span class="line">        <span class="keyword">if</span> (UNEXPECTED(_i &gt;_num_args)) <span class="keyword">break</span>; \</span><br><span class="line">      &#125; \</span><br><span class="line">      _real_arg++; \</span><br><span class="line">      _arg = _real_arg; \</span><br><span class="line">      <span class="keyword">if</span> (UNEXPECTED(!zend_parse_arg_string(_arg, &amp;var, &amp;var_len, <span class="number">0</span>, _i))) &#123; \</span><br><span class="line">        _expected_type = <span class="number">0</span> ? Z_EXPECTED_STRING_OR_NULL : Z_EXPECTED_STRING; \</span><br><span class="line">        _error_code = ZPP_ERROR_WRONG_ARG; \</span><br><span class="line">        <span class="keyword">break</span>; \</span><br><span class="line">      &#125;</span><br><span class="line"><span class="comment">// ZEND_PARSE_PARAMETERS_END</span></span><br><span class="line">      ZEND_ASSERT(_i == _max_num_args || _max_num_args == (<span class="type">uint32_t</span>) <span class="number">-1</span>); \</span><br><span class="line">		&#125; <span class="keyword">while</span> (<span class="number">0</span>); \</span><br><span class="line">		<span class="keyword">if</span> (UNEXPECTED(_error_code != ZPP_ERROR_OK)) &#123; \</span><br><span class="line">			<span class="keyword">if</span> (!(_flags &amp; ZEND_PARSE_PARAMS_QUIET)) &#123; \</span><br><span class="line">				zend_wrong_parameter_error(_error_code, _i, _error, _expected_type, _arg); \</span><br><span class="line">			&#125; \</span><br><span class="line">			<span class="keyword">return</span>; \</span><br><span class="line">		&#125; \</span><br><span class="line">	&#125; <span class="keyword">while</span> (<span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>由于C语言没有类的概念，因此对于一些需要泛型的操作只有通过宏定义实现才能让代码更加简洁，也提升了代码审计的难度。这段代码有一个比较有趣的地方——大量使用了<code>do ... while(0)</code>的控制流结构，这看上去冗余，但实际上是为了隔离作用域，让宏定义中的临时变量具有临时作用域，使宏定义调用方对于临时变量不可见，避免调用方多次调用相同宏定义时出现变量重复定义的问题。</p>
<p>在上面的代码中，关键逻辑实际上就是一行，即调用<code>zend_parse_arg_string</code>函数进行参数解析。前后添加了一些安全检查，包括参数个数、解析是否成功等。下面简单分析一下<code>zend_parse_arg_string</code>的相关逻辑。</p>
<h3 id="zend_parse_arg_string"><a class="markdownIt-Anchor" href="#zend_parse_arg_string"></a> <code>zend_parse_arg_string</code></h3>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /Zend/zend_API.h, line 1984</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> zend_always_inline <span class="type">bool</span> <span class="title function_">zend_parse_arg_str</span><span class="params">(zval *arg, zend_string **dest, <span class="type">bool</span> check_null, <span class="type">uint32_t</span> arg_num)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (EXPECTED(Z_TYPE_P(arg) == IS_STRING)) &#123;</span><br><span class="line">		*dest = Z_STR_P(arg);</span><br><span class="line">	&#125; <span class="keyword">else</span> <span class="keyword">if</span> (check_null &amp;&amp; Z_TYPE_P(arg) == IS_NULL) &#123;</span><br><span class="line">		*dest = <span class="literal">NULL</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">return</span> zend_parse_arg_str_slow(arg, dest, arg_num);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> zend_always_inline <span class="type">bool</span> <span class="title function_">zend_parse_arg_string</span><span class="params">(zval *arg, <span class="type">char</span> **dest, <span class="type">size_t</span> *dest_len, <span class="type">bool</span> check_null, <span class="type">uint32_t</span> arg_num)</span></span><br><span class="line">&#123;</span><br><span class="line">	zend_string *str;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!zend_parse_arg_str(arg, &amp;str, check_null, arg_num)) &#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">if</span> (check_null &amp;&amp; UNEXPECTED(!str)) &#123;</span><br><span class="line">		*dest = <span class="literal">NULL</span>;</span><br><span class="line">		*dest_len = <span class="number">0</span>;</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		*dest = ZSTR_VAL(str);</span><br><span class="line">		*dest_len = ZSTR_LEN(str);</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以清晰地看到这里PHP源代码对传入的<code>zval</code>进行解析的过程。由于<code>zval</code>结构中的<code>zend_value</code>是一个联合类型，因此可以用于表示多种数据类型，相互转换也非常简单。</p>
<p>由此可知，<code>ZEND_PARSE_PARAMETERS_START</code>与<code>ZEND_PARSE_PARAMETERS_END</code>之间即为C库函数解析PHP参数的流程，在<code>ZEND_PARSE_PARAMETERS_START</code>中，需要指定要解析第几个参数，随后在内部可通过多次使用<code>Z_PARAM_xxx</code>进行参数解析。</p>
<h3 id="zend_module_entry"><a class="markdownIt-Anchor" href="#zend_module_entry"></a> <code>zend_module_entry</code></h3>
<p>这是一个在预先定义的C库文件中被使用的数据结构。从最上面的代码注释可以看到，这个数据类型定义了PHP模块的基本信息，包括扩展的名字、库函数的入口（定义的所有导出函数）、初始化函数、关闭函数、请求初始化函数、请求关闭函数、phpinfo钩子函数、版本等。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">PHP_MINFO_FUNCTION(hello_phpext)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;hello_phpext support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">zend_module_entry hello_phpext_module_entry = &#123;</span><br><span class="line">	STANDARD_MODULE_HEADER,</span><br><span class="line">	<span class="string">&quot;hello_phpext&quot;</span>,					<span class="comment">/* Extension name */</span></span><br><span class="line">	ext_functions,					<span class="comment">/* zend_function_entry */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MINIT - Module initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_MSHUTDOWN - Module shutdown */</span></span><br><span class="line">	PHP_RINIT(hello_phpext),			<span class="comment">/* PHP_RINIT - Request initialization */</span></span><br><span class="line">	<span class="literal">NULL</span>,							<span class="comment">/* PHP_RSHUTDOWN - Request shutdown */</span></span><br><span class="line">	PHP_MINFO(hello_phpext),			<span class="comment">/* PHP_MINFO - Module info */</span></span><br><span class="line">	PHP_HELLO_PHPEXT_VERSION,		<span class="comment">/* Version */</span></span><br><span class="line">	STANDARD_MODULE_PROPERTIES</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中，<code>PHP_MINFO</code>用于定义挂钩在phpinfo函数中的C库函数。它的作用是当PHP代码调用<code>phpinfo()</code>函数时显示PHP基本信息时，能够在其上附加显示本扩展的基本信息，包括扩展名、作者等。</p>
<ul>
<li><code>php_info_print_table_start</code>：开始显示phpinfo表格。</li>
<li><code>php_info_print_table_header</code>：输出表格头，第一个参数为需要添加的列数，后面的参数个数需要等于第一个参数的值，表示不同列的输出内容。</li>
<li><code>php_info_print_table_row</code>：输出表格内容，第一个参数为该行的列数，后面参数个数等于第一个参数的值，表示不同列的输出内容。</li>
<li><code>php_info_print_table_end</code>：结束输出phpinfo表格。</li>
</ul>
<p>对于下面的<code>PHP_MINFO_FUNCTION</code>定义，调用<code>phpinfo</code>后可看到下图表格的输出。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">PHP_MINFO_FUNCTION(hello_phpext)</span><br><span class="line">&#123;</span><br><span class="line">	php_info_print_table_start();</span><br><span class="line">	php_info_print_table_header(<span class="number">2</span>, <span class="string">&quot;hello_phpext support&quot;</span>, <span class="string">&quot;enabled&quot;</span>);</span><br><span class="line">	php_info_print_table_row(<span class="number">2</span>, <span class="string">&quot;author&quot;</span>, <span class="string">&quot;CoLin&quot;</span>);</span><br><span class="line">	php_info_print_table_end();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="1.png" alt="" /></p>
<h3 id="zend_function_entry等"><a class="markdownIt-Anchor" href="#zend_function_entry等"></a> <code>zend_function_entry</code>等</h3>
<p>这是用于表示C库的导出PHP函数的结构体，定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /Zend/zend_API.h</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_function_entry</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *fname;</span><br><span class="line">	zif_handler handler;</span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_internal_arg_info</span> *<span class="title">arg_info</span>;</span></span><br><span class="line">	<span class="type">uint32_t</span> num_args;</span><br><span class="line">	<span class="type">uint32_t</span> flags;</span><br><span class="line">&#125; zend_function_entry;</span><br></pre></td></tr></table></figure>
<p>在<code>hello_phpext_arginfo.h</code>中，有一个<code>static const zend_function_entry ext_functions[]</code>的数组结构，其中即保存了本扩展中导出的，可在PHP代码中直接调用的函数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> zend_function_entry ext_functions[] = &#123;</span><br><span class="line">	ZEND_FE(test1, arginfo_test1)</span><br><span class="line">	ZEND_FE(test2, arginfo_test2)</span><br><span class="line">	ZEND_FE_END</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其中的每一个导出函数都使用<code>ZEND_FE</code>宏定义包裹，第一个参数为函数名，第二个参数为函数的参数信息。</p>
<p>头文件中也对参数类型进行了定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ZEND_BEGIN_ARG_WITH_RETURN_TYPE_INFO_EX(arginfo_test1, <span class="number">0</span>, <span class="number">0</span>, IS_VOID, <span class="number">0</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br><span class="line"></span><br><span class="line">ZEND_BEGIN_ARG_WITH_RETURN_TYPE_INFO_EX(arginfo_test2, <span class="number">0</span>, <span class="number">0</span>, IS_STRING, <span class="number">0</span>)</span><br><span class="line">	ZEND_ARG_TYPE_INFO_WITH_DEFAULT_VALUE(<span class="number">0</span>, str, IS_STRING, <span class="number">0</span>, <span class="string">&quot;\&quot;\&quot;&quot;</span>)</span><br><span class="line">ZEND_END_ARG_INFO()</span><br></pre></td></tr></table></figure>
<p>下面给出这些宏的定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /Zend/zend_API.h, line 183</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_BEGIN_ARG_WITH_RETURN_TYPE_INFO_EX(name, return_reference, required_num_args, type, allow_null) \</span></span><br><span class="line"><span class="meta">	ZEND_BEGIN_ARG_WITH_RETURN_TYPE_INFO_EX2(name, return_reference, required_num_args, type, allow_null, 0)</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// /Zend/zend_API.h, line 179</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_BEGIN_ARG_WITH_RETURN_TYPE_INFO_EX2(name, return_reference, required_num_args, type, allow_null, is_tentative_return_type) \</span></span><br><span class="line"><span class="meta">	static const zend_internal_arg_info name[] = &#123; \</span></span><br><span class="line"><span class="meta">		&#123; (const char*)(zend_uintptr_t)(required_num_args), ZEND_TYPE_INIT_CODE(type, allow_null, _ZEND_ARG_INFO_FLAGS(return_reference, 0, is_tentative_return_type)), NULL &#125;,</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Zend/zend_API.h, line 197</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_END_ARG_INFO()		&#125;;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Zend/zend_compile.h, line 400</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* arg_info for internal functions */</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> _<span class="title">zend_internal_arg_info</span> &#123;</span></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *name;</span><br><span class="line">	zend_type type;</span><br><span class="line">	<span class="type">const</span> <span class="type">char</span> *default_value;</span><br><span class="line">&#125; zend_internal_arg_info;</span><br></pre></td></tr></table></figure>
<p>因此，<code>ZEND_BEGIN_ARG_WITH_RETURN_TYPE_INFO_EX(arginfo_test1, 0, 0, IS_VOID, 0)</code>展开就是：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> zend_internal_arg_info arginfo_test1[] = &#123; \</span><br><span class="line">		&#123; (<span class="type">const</span> <span class="type">char</span>*)(<span class="type">zend_uintptr_t</span>)(<span class="number">0</span>), ZEND_TYPE_INIT_CODE(IS_VOID, <span class="number">0</span>, _ZEND_ARG_INFO_FLAGS(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)), <span class="literal">NULL</span> &#125;,</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>其中括号未闭合，用于在下面继续定义其他参数。这个宏定义实际上是首先定义了返回值的类型，它的5个参数分别代表：</p>
<ul>
<li>1 - 函数名</li>
<li>2 - 返回值是否为引用值</li>
<li>3 - 必需的参数数量</li>
<li>4 - 返回值类型</li>
<li>5 - 返回值是否允许为空</li>
</ul>
<p>这里需要注意的是，参数3表示必需的参数数量，在PHP函数中还可以添加一些可选参数。即即使传入的必需参数数量为0，在<code>ZEND_BEGIN_ARG_WITH_RETURN_TYPE_INFO_EX</code>之后依然可以定义任意多的可选参数。即使PHP代码中没有传入这些可选参数，在库函数中只是会被当成默认值看待，而不会直接报错。</p>
<p>其中，对于<code>ZEND_TYPE_INIT_CODE</code>的定义如下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_TYPE_INIT_CODE(code, allow_null, extra_flags) \</span></span><br><span class="line"><span class="meta">	ZEND_TYPE_INIT_MASK(((code) == _IS_BOOL ? MAY_BE_BOOL : ((code) == IS_MIXED ? MAY_BE_ANY : (1 &lt;&lt; (code)))) \</span></span><br><span class="line"><span class="meta">		| ((allow_null) ? _ZEND_TYPE_NULLABLE_BIT : 0) | (extra_flags))</span></span><br></pre></td></tr></table></figure>
<p>它的3个参数分别代表数据类型、是否允许空、其他参数标志位。</p>
<p>在<code>ZEND_BEGIN_ARG_WITH_RETURN_TYPE_INFO_EX</code>之后，可以定义所有参数。定义使用下面的宏定义：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_ARG_TYPE_INFO(pass_by_ref, name, type_hint, allow_null) \</span></span><br><span class="line"><span class="meta">	&#123; #name, ZEND_TYPE_INIT_CODE(type_hint, allow_null, _ZEND_ARG_INFO_FLAGS(pass_by_ref, 0, 0)), NULL &#125;,</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ZEND_ARG_TYPE_INFO_WITH_DEFAULT_VALUE(pass_by_ref, name, type_hint, allow_null, default_value) \</span></span><br><span class="line"><span class="meta">	&#123; #name, ZEND_TYPE_INIT_CODE(type_hint, allow_null, _ZEND_ARG_INFO_FLAGS(pass_by_ref, 0, 0)), default_value &#125;,</span></span><br></pre></td></tr></table></figure>
<p><code>type_hint</code>即为参数的数据类型，<code>pass_by_ref</code>表示是否传入引用。</p>
<h3 id="php类相关"><a class="markdownIt-Anchor" href="#php类相关"></a> PHP类相关</h3>
<p>在C语言的PHP扩展中，可以完成对PHP类的定义，包括类属性、类方法的定义等。这里以PHP源码为例。</p>
<p>在<code>/ext/com_dotnet/com_persist_arginfo.h</code>中，C代码定义了一个<code>COMPersistHelper</code>类。要想让这个类在PHP代码中能够直接使用，需要一个类注册函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /ext/com_dotnet/com_persist_arginfo.h, line 56</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> zend_class_entry *<span class="title function_">register_class_COMPersistHelper</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	zend_class_entry ce, *class_entry;</span><br><span class="line"></span><br><span class="line">	INIT_CLASS_ENTRY(ce, <span class="string">&quot;COMPersistHelper&quot;</span>, class_COMPersistHelper_methods);</span><br><span class="line">	class_entry = zend_register_internal_class_ex(&amp;ce, <span class="literal">NULL</span>);</span><br><span class="line">	class_entry-&gt;ce_flags |= ZEND_ACC_FINAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> class_entry;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类注册代码具有固定的函数声明格式，其必为静态函数，返回值必为<code>zend_class_entry*</code>，函数名应被命名为<code>register_class_xxx</code>，无参。</p>
<p>在函数中，必需进行类的初始化，即调用<code>INIT_CLASS_ENTRY</code>宏，这个宏的第一个参数固定，第二个参数为类名，第三个参数为定义类中方法的数据结构：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /ext/com_dotnet/com_persist_arginfo.h, line 44</span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> zend_function_entry class_COMPersistHelper_methods[] = &#123;</span><br><span class="line">	ZEND_ME(COMPersistHelper, __construct, arginfo_class_COMPersistHelper___construct, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_ME(COMPersistHelper, GetCurFileName, arginfo_class_COMPersistHelper_GetCurFileName, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_ME(COMPersistHelper, SaveToFile, arginfo_class_COMPersistHelper_SaveToFile, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_ME(COMPersistHelper, LoadFromFile, arginfo_class_COMPersistHelper_LoadFromFile, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_ME(COMPersistHelper, GetMaxStreamSize, arginfo_class_COMPersistHelper_GetMaxStreamSize, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_ME(COMPersistHelper, InitNew, arginfo_class_COMPersistHelper_InitNew, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_ME(COMPersistHelper, LoadFromStream, arginfo_class_COMPersistHelper_LoadFromStream, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_ME(COMPersistHelper, SaveToStream, arginfo_class_COMPersistHelper_SaveToStream, ZEND_ACC_PUBLIC)</span><br><span class="line">	ZEND_FE_END</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>若需要定义类中的方法，只需要完成对这个数组的定义即可，数组应命名为<code>class_xxx_methods</code>，数组中需要使用<code>ZEND_ME</code>宏表示类方法项。这个宏各个参数的含义如下：</p>
<ul>
<li>1 - 类名，不加引号。</li>
<li>2 - 方法名，前加<code>__</code>的是内置函数，如构造函数、setter、getter等。</li>
<li>3 - 方法的参数定义，与函数参数定义方式相同。</li>
<li>4 - 类访问权限，如<code>ZEND_ACC_PUBLIC</code>指<code>public</code>访问权限等。</li>
</ul>
<p>如果需要定义类属性，则需在类注册函数中完成定义。下面是PHP类<code>DOMDocumentType</code>类的注册函数的一部分：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /ext/dom/php_dom_arginfo.h, line 905</span></span><br><span class="line"></span><br><span class="line">	zval property_name_default_value;</span><br><span class="line">	ZVAL_UNDEF(&amp;property_name_default_value);</span><br><span class="line">	zend_string *property_name_name = zend_string_init(<span class="string">&quot;name&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;name&quot;</span>) - <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	zend_declare_typed_property(class_entry, property_name_name, &amp;property_name_default_value, ZEND_ACC_PUBLIC, <span class="literal">NULL</span>, (zend_type) ZEND_TYPE_INIT_MASK(MAY_BE_STRING));</span><br><span class="line">	zend_string_release(property_name_name);</span><br></pre></td></tr></table></figure>
<p>在上面的代码中，为类<code>DOMDocumentType</code>定义了一个属性，名为<code>name</code>，这里是使用<code>zend_string_init</code>定义字符串，前两个参数分别为<code>char*</code>和长度，第3个长度指是否为永久字符串。随后，通过<code>zend_declare_typed_property</code>正式将属性添加到类中，参数列表如下：</p>
<ul>
<li>1 - 注册函数的参数</li>
<li>2 - 属性名</li>
<li>3 - 默认值</li>
<li>4 - 访问权限</li>
<li>5 - 文档字符串</li>
<li>6 - 属性类型</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// /ext/dom/php_dom_arginfo.h, line 911</span></span><br><span class="line"></span><br><span class="line">	zend_string *property_entities_class_DOMNamedNodeMap = zend_string_init(<span class="string">&quot;DOMNamedNodeMap&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;DOMNamedNodeMap&quot;</span>)<span class="number">-1</span>, <span class="number">1</span>);</span><br><span class="line">	zval property_entities_default_value;</span><br><span class="line">	ZVAL_UNDEF(&amp;property_entities_default_value);</span><br><span class="line">	zend_string *property_entities_name = zend_string_init(<span class="string">&quot;entities&quot;</span>, <span class="keyword">sizeof</span>(<span class="string">&quot;entities&quot;</span>) - <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">	zend_declare_typed_property(class_entry, property_entities_name, &amp;property_entities_default_value, ZEND_ACC_PUBLIC, <span class="literal">NULL</span>, (zend_type) ZEND_TYPE_INIT_CLASS(property_entities_class_DOMNamedNodeMap, <span class="number">0</span>, <span class="number">0</span>));</span><br><span class="line">	zend_string_release(property_entities_name);</span><br></pre></td></tr></table></figure>
<p>上面的代码定义了数据类型为类的类属性，这里是定义一个<code>DOMNamedNodeMap</code>类型的类属性，需要使用<code>ZEND_TYPE_INIT_CLASS</code>宏定义。最后的<code>zend_string_release</code>即释放字符串值。</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/04/03/buuctf-reverse-write-ups-2/" rel="prev" title="buuctf-reverse write-ups (2)">
      <i class="fa fa-chevron-left"></i> buuctf-reverse write-ups (2)
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/07/01/PHP-pwn-%E5%AD%A6%E4%B9%A0-2/" rel="next" title="PHP pwn 学习 (2)">
      PHP pwn 学习 (2) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#a-php-extensions-for-c"><span class="nav-number">1.</span> <span class="nav-text"> A. PHP extensions for C</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-%E8%BF%90%E8%A1%8C%E7%8E%AF%E5%A2%83%E4%B8%8E%E5%B7%A5%E4%BD%9C%E7%9B%AE%E5%BD%95%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.1.</span> <span class="nav-text"> 1. 运行环境与工作目录初始化</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-%E6%9E%84%E5%BB%BA%E4%B8%8E%E5%8A%A0%E8%BD%BD"><span class="nav-number">1.2.</span> <span class="nav-text"> 2. 构建与加载</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-%E5%85%B3%E9%94%AE%E7%BB%93%E6%9E%84%E5%AE%9A%E4%B9%89"><span class="nav-number">1.3.</span> <span class="nav-text"> 3. 关键结构定义</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#php_function"><span class="nav-number">1.3.1.</span> <span class="nav-text"> PHP_FUNCTION</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#internal_function_parameters"><span class="nav-number">1.3.2.</span> <span class="nav-text"> INTERNAL_FUNCTION_PARAMETERS</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zend_execute_data%E7%AD%89"><span class="nav-number">1.3.3.</span> <span class="nav-text"> zend_execute_data等</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zend_parse_parameters_start%E7%AD%89"><span class="nav-number">1.3.4.</span> <span class="nav-text"> ZEND_PARSE_PARAMETERS_START等</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zend_parse_arg_string"><span class="nav-number">1.3.5.</span> <span class="nav-text"> zend_parse_arg_string</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zend_module_entry"><span class="nav-number">1.3.6.</span> <span class="nav-text"> zend_module_entry</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#zend_function_entry%E7%AD%89"><span class="nav-number">1.3.7.</span> <span class="nav-text"> zend_function_entry等</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#php%E7%B1%BB%E7%9B%B8%E5%85%B3"><span class="nav-number">1.3.8.</span> <span class="nav-text"> PHP类相关</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CoLin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">159</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">26</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hornos3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hornos3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_54218833?spm=1000.2115.3001.5343" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_54218833?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="fa fa-crosshairs fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoLin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.5m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">22:07</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
